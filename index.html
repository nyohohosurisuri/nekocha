
<!DOCTYPE html>
<html lang="ja">
<head>
   <script type="module">
document.addEventListener('DOMContentLoaded', async () => {
  try {
    /* 笘・蛻晄悄蛹門・逅・・縺ｿ螳溯｡鯉ｼ医・繝ｭ繝ｳ繝励ヨ隱ｭ縺ｿ霎ｼ縺ｿ縺ｯ繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ驕ｸ謚樊凾縺ｫ陦後≧・・*/
    window.state        ??= {};   // state 縺後∪縺辟｡縺・ｴ蜷医↓蛯吶∴
    state.settings      ??= {};
    
    /* 笘・繧｢繝励Μ繧貞・譛溷喧 */
    if (typeof appLogic !== 'undefined') {
      appLogic.initializeApp();
    }
  } catch (e) {
    console.error(e);
    alert('繧｢繝励Μ縺ｮ蛻晄悄蛹悶↓螟ｱ謨励＠縺ｾ縺励◆');
    // 繧ｨ繝ｩ繝ｼ縺ｮ蝣ｴ蜷医〒繧ょ・譛溷喧縺ｯ螳溯｡・    if (typeof appLogic !== 'undefined') {
      appLogic.initializeApp();
    }
  }
});
</script>



    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NekoCha</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" id="theme-color-meta" content="#4a90e2">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f0f2f5;
            --bg-tertiary: #fdfdfd;
            --bg-tertiary-rgb: 253, 253, 253;
            --bg-input: #ffffff;
            --bg-user-message: #dcf8c6;
            --bg-model-message: #e5e5ea;
            --bg-system-message: #f0f8ff;
            --bg-error-message: #ffebee;
            --bg-button: #4a90e2;
            --bg-button-rgb: 74, 144, 226;
            --bg-button-hover: #357abd;
            --bg-button-disabled: #a0c3e8;
            --bg-button-action: #777777;
            --bg-button-action-hover: #555555;
            --bg-button-delete: #e53935;
            --bg-button-delete-hover: #c62828;
            --bg-button-retry: #43a047;
            --bg-button-retry-hover: #2e7d32;
            --bg-button-edit: #ff9800;
            --bg-button-edit-hover: #f57c00;
            --bg-button-copy: #e91e63;
            --bg-button-copy-hover: #c2185b;
            --bg-button-paste: #00bcd4;
            --bg-button-paste-hover: #0097a7;
            --bg-button-duplicate: #546e7a;
            --bg-button-duplicate-hover: #37474f;
            --bg-button-export: #1e88e5;
            --bg-button-export-hover: #1565c0;
            --bg-button-save: #30d158;
            --bg-button-save-hover: #24a345;
            --bg-button-cancel: #f44336;
            --bg-button-cancel-hover: #d32f2f;
            --bg-button-update: #1976d2;
            --bg-button-update-hover: #115293;
            --bg-header: #4a90e2;
            --overlay-base-rgb: 255, 255, 255;
            --chat-overlay-alpha: 0.65;
            --bg-cascade-button: var(--bg-button-action);
            --bg-cascade-button-hover: var(--bg-button-action-hover);
            --bg-cascade-delete-button: var(--bg-button-delete);
            --bg-cascade-delete-button-hover: var(--bg-button-delete-hover);
            --text-cascade-indicator: var(--text-secondary);
            --bg-button-header-delete: #e53935;
            --bg-button-header-delete-hover: #c62828;
            --bg-button-header-copy: #e91e63;
            --bg-button-header-copy-hover: #c2185b;
            --bg-code-copy-button: var(--bg-button-action);
            --bg-code-copy-button-hover: var(--bg-button-action-hover);
            --text-code-copy-button: var(--text-light);

            --text-primary: #333333;
            --text-secondary: #777777;
            --text-light: #ffffff;
            --text-disabled: #e0e0e0;
            --text-error: #c62828;
            --text-link: #4a90e2;
            --text-placeholder: #999999;
            --text-system: #555;
            --text-memo: #000000;
            --bg-memo: #ffffff;

            --border-primary: #cccccc;
            --border-secondary: #dddddd;
            --border-tertiary: #eeeeee;
            --border-danger: #ffcdd2;
            --border-system: #add8e6;

            --shadow-primary: rgba(0, 0, 0, 0.1);
            --shadow-secondary: rgba(0,0,0,0.1);

            --message-max-width: 85%;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --message-body-font-size: 14px;
            --code-block-font-size: 13px;
            --chat-background-image: none;

            --bg-dialog-file-item: var(--bg-tertiary);
            --border-dialog-file-item: var(--border-secondary);
            --text-dialog-file-name: var(--text-primary);
            --text-dialog-file-size: var(--text-secondary);
            --bg-dialog-button-select: var(--bg-button-action);
            --bg-dialog-button-select-hover: var(--bg-button-action-hover);
            --bg-dialog-button-confirm: var(--bg-button-save);
            --bg-dialog-button-confirm-hover: var(--bg-button-save-hover);
            --bg-dialog-button-cancel: var(--bg-button-cancel);
            --bg-dialog-button-cancel-hover: var(--bg-button-cancel-hover);

            --bg-attachment-details: rgba(0, 0, 0, 0.03);
            --border-attachment-details: var(--border-tertiary);
            --text-attachment-summary: var(--text-secondary);
            --text-attachment-filename: var(--text-primary);

            --badge-color: #ffcc00;
            --badge-size: 12px;

            --memo-height: 300px;
            --clipboard-stack-height: 300px;
            --message-icon-size: 28px;
            --message-icon-offset-y: -10px;
            --icon-name-font-size: 10px;
            --icon-name-offset-y: -10px;

            --bg-toggle-button: var(--bg-button-action);
            --bg-toggle-button-hover: var(--bg-button-action-hover);
            --text-toggle-button: var(--text-light);

            --message-bubble-opacity: 1;
            --header-footer-opacity: 1;

            --bg-button-gold: #FFD700;
            --bg-button-gold-hover: #FFC700;
            --text-button-gold: #ffffff;
            --bg-button-purple: #800080;
            --bg-button-purple-hover: #6A006A;
            --text-button-purple: #ffffff;

            --message-toggle-button-top-width: 6px;
            --message-toggle-button-top-height: 40px;
            --message-toggle-button-top-font-size: 12px;
            --message-toggle-button-top-opacity: 0.6;
            --message-toggle-button-top-text-collapse: "-";
            --message-toggle-button-top-text-expand: "笆｡";

            --message-toggle-button-bottom-font-size: 14px;
            --message-toggle-button-bottom-text-collapse: "髱櫁｡ｨ遉ｺ";
            --message-toggle-button-bottom-text-expand: "陦ｨ遉ｺ";

            --message-actions-base-rgb: 255, 255, 255;
            --message-actions-bg-opacity: 0.8;

            --user-name-bubble-bg: transparent;
            --ai-name-bubble-bg: transparent;
            --user-name-bubble-padding-y: 2px;
            --user-name-bubble-padding-x-ratio: 0.5;
            --user-name-bubble-border-radius: 5px;
            --ai-name-bubble-padding-y: 2px;
            --ai-name-bubble-padding-x-ratio: 0.5;
            --ai-name-bubble-border-radius: 5px;
            --default-user-name-bubble-custom-rgb: 255, 255, 255;
            --default-ai-name-bubble-custom-rgb: 255, 255, 255;

            --thought-summary-opacity: 0.85;
            --thought-summary-font-size: 12px;
        }

        body.dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #101010;
            --bg-tertiary: #252525;
            --bg-tertiary-rgb: 37, 37, 37;
            --bg-input: #303030;
            --bg-user-message: #056162;
            --bg-model-message: #3a3a3c;
            --bg-system-message: #2a3a4a;
            --bg-error-message: #5c1c1c;
            --bg-button: #007aff;
            --bg-button-rgb: 0, 122, 255;
            --bg-button-hover: #005ecb;
            --bg-button-disabled: #4a5a70;
            --bg-button-action: #666666;
            --bg-button-action-hover: #888888;
            --bg-button-delete: #ff3b30;
            --bg-button-delete-hover: #d12c23;
            --bg-button-retry: #34c759;
            --bg-button-retry-hover: #249a41;
            --bg-button-edit: #ff9500;
            --bg-button-edit-hover: #d17d00;
            --bg-button-copy: #f06292;
            --bg-button-copy-hover: #ec407a;
            --bg-button-paste: #4dd0e1;
            --bg-button-paste-hover: #26c6da;
            --bg-button-duplicate: #8e8e93;
            --bg-button-duplicate-hover: #6b6b70;
            --bg-button-export: #0a84ff;
            --bg-button-export-hover: #0069d1;
            --bg-button-save: #30d158;
            --bg-button-save-hover: #24a345;
            --bg-button-cancel: #ff453a;
            --bg-button-cancel-hover: #d1332b;
            --bg-button-update: #0a84ff;
            --bg-button-update-hover: #0069d1;
            --bg-header: #007aff;
            --overlay-base-rgb: 30, 30, 30;
            --bg-memo: #2c2c2e;
            --bg-cascade-button: var(--bg-button-action);
            --bg-cascade-button-hover: var(--bg-button-action-hover);
            --bg-cascade-delete-button: var(--bg-button-delete);
            --bg-cascade-delete-button-hover: var(--bg-button-delete-hover);
            --text-cascade-indicator: var(--text-secondary);
            --bg-button-header-delete: var(--bg-button-delete);
            --bg-button-header-delete-hover: var(--bg-button-delete-hover);
            --bg-button-header-copy: var(--bg-button-copy);
            --bg-button-header-copy-hover: var(--bg-button-copy-hover);
            --bg-code-copy-button: var(--bg-button-action);
            --bg-code-copy-button-hover: var(--bg-button-action-hover);
            --text-code-copy-button: var(--text-light);

            --text-primary: #e0e0e0;
            --text-secondary: #aaaaaa;
            --text-light: #ffffff;
            --text-disabled: #666666;
            --text-error: #ff8a80;
            --text-link: #00aaff;
            --text-placeholder: #777777;
            --text-system: #ccc;
            --text-memo: #e0e0e0;

            --border-primary: #444444;
            --border-secondary: #555555;
            --border-tertiary: #333333;
            --border-danger: #7a2e35;
            --border-system: #4682b4;

            --shadow-primary: rgba(255, 255, 255, 0.1);
            --shadow-secondary: rgba(0, 0, 0, 0.5);

            --bg-toggle-button: var(--bg-button-action);
            --bg-toggle-button-hover: var(--bg-button-action-hover);
            --text-toggle-button: var(--text-light);

            --bg-button-gold: #b8860b;
            --bg-button-gold-hover: #daa520;
            --text-button-gold: #ffffff;
            --bg-button-purple: #6a0dad;
            --bg-button-purple-hover: #8a2be2;
            --text-button-purple: #ffffff;

            --message-actions-base-rgb: 50, 50, 50;
            --default-user-name-bubble-custom-rgb: 50, 50, 50;
            --default-ai-name-bubble-custom-rgb: 50, 50, 50;
        }

        body.pastel-pink-mode {
            --bg-primary: #fff5f8;
            --bg-secondary: #ffe6ea;
            --bg-tertiary: #fff0f3;
            --bg-tertiary-rgb: 255, 240, 243;
            --bg-input: #ffffff;
            --bg-user-message: #ffddee;
            --bg-model-message: #f3e8ff;
            --bg-system-message: #ffeef2;
            --bg-error-message: #ffccd5;
            --bg-button: #ff8fab;
            --bg-button-rgb: 255, 143, 171;
            --bg-button-hover: #ff7096;
            --bg-button-disabled: #fcc2d7;
            --bg-button-action: #ffb3c1;
            --bg-button-action-hover: #ffa8b9;
            --bg-button-delete: #ff6b6b;
            --bg-button-delete-hover: #f06060;
            --bg-button-retry: #a0eade;
            --bg-button-retry-hover: #88d8c0;
            --bg-button-edit: #ffc974;
            --bg-button-edit-hover: #ffbd59;
            --bg-button-copy: #e5a9f0;
            --bg-button-copy-hover: #d998e3;
            --bg-button-paste: #b2e0ff;
            --bg-button-paste-hover: #a1d5f7;
            --bg-button-duplicate: #ffdaab;
            --bg-button-duplicate-hover: #ffce96;
            --bg-button-export: #c8a2c8;
            --bg-button-export-hover: #b991b9;
            --bg-button-save: #90ee90;
            --bg-button-save-hover: #78dd78;
            --bg-button-cancel: #ff9aa2;
            --bg-button-cancel-hover: #ff868e;
            --bg-button-update: #ff9a8b;
            --bg-button-update-hover: #ff8773;
            --bg-header: #ff8fab;
            --overlay-base-rgb: 255, 245, 248;
            --bg-memo: #fffafb;
            --bg-cascade-button: var(--bg-button-action);
            --bg-cascade-button-hover: var(--bg-button-action-hover);
            --bg-cascade-delete-button: var(--bg-button-delete);
            --bg-cascade-delete-button-hover: var(--bg-button-delete-hover);
            --text-cascade-indicator: var(--text-secondary);
            --bg-button-header-delete: var(--bg-button-delete);
            --bg-button-header-delete-hover: var(--bg-button-delete-hover);
            --bg-button-header-copy: var(--bg-button-copy);
            --bg-button-header-copy-hover: var(--bg-button-copy-hover);
            --bg-code-copy-button: var(--bg-button-action);
            --bg-code-copy-button-hover: var(--bg-button-action-hover);
            --text-code-copy-button: var(--text-light);

            --text-primary: #5c3c45;
            --text-secondary: #8c6b74;
            --text-light: #ffffff;
            --text-disabled: #d8b8c0;
            --text-error: #c5002f;
            --text-link: #ff69b4;
            --text-placeholder: #b28a94;
            --text-system: #7d5a65;
            --text-memo: #5c3c45;

            --border-primary: #ffc2d7;
            --border-secondary: #ffe0e7;
            --border-tertiary: #fff0f3;
            --border-danger: #ffb3c1;
            --border-system: #ffd1dc;

            --shadow-primary: rgba(200, 150, 160, 0.1);
            --shadow-secondary: rgba(200, 150, 160, 0.1);

            --bg-dialog-file-item: var(--bg-tertiary);
            --border-dialog-file-item: var(--border-secondary);
            --text-dialog-file-name: var(--text-primary);
            --text-dialog-file-size: var(--text-secondary);
            --bg-dialog-button-select: var(--bg-button-action);
            --bg-dialog-button-select-hover: var(--bg-button-action-hover);
            --bg-dialog-button-confirm: var(--bg-button-save);
            --bg-dialog-button-confirm-hover: var(--bg-button-save-hover);
            --bg-dialog-button-cancel: var(--bg-button-cancel);
            --bg-dialog-button-cancel-hover: var(--bg-button-cancel-hover);

            --bg-attachment-details: rgba(255, 230, 234, 0.5);
            --border-attachment-details: var(--border-tertiary);
            --text-attachment-summary: var(--text-secondary);
            --text-attachment-filename: var(--text-primary);

            --bg-toggle-button: var(--bg-button-action);
            --bg-toggle-button-hover: var(--bg-button-action-hover);
            --text-toggle-button: var(--text-light);

            --bg-button-gold: #ffdd77;
            --bg-button-gold-hover: #ffcc55;
            --text-button-gold: #816200;
            --bg-button-purple: #d9a7e0;
            --bg-button-purple-hover: #c790d0;
            --text-button-purple: #ffffff;

            --message-actions-base-rgb: 255, 230, 234;

            --default-user-name-bubble-custom-rgb: 255, 230, 234;
            --default-ai-name-bubble-custom-rgb: 255, 230, 234;
        }

        body.pastel-blue-mode {
            --bg-primary: #f0f8ff;
            --bg-secondary: #e0f0ff;
            --bg-tertiary: #eaf5ff;
            --bg-tertiary-rgb: 234, 245, 255;
            --bg-input: #ffffff;
            --bg-user-message: #cff1ef;
            --bg-model-message: #e0e8ff;
            --bg-system-message: #e6f2ff;
            --bg-error-message: #d1e9ff;
            --bg-button: #87cefa;
            --bg-button-rgb: 135, 206, 250;
            --bg-button-hover: #70b8e8;
            --bg-button-disabled: #b0dfff;
            --bg-button-action: #add8e6;
            --bg-button-action-hover: #9ccce0;
            --bg-button-delete: #ff7f7f;
            --bg-button-delete-hover: #ff6a6a;
            --bg-button-retry: #98fb98;
            --bg-button-retry-hover: #82f082;
            --bg-button-edit: #ffe082;
            --bg-button-edit-hover: #ffda6b;
            --bg-button-copy: #bca0dc;
            --bg-button-copy-hover: #ae8fcf;
            --bg-button-paste: #a0cfd8;
            --bg-button-paste-hover: #8ebfc9;
            --bg-button-duplicate: #c1e1c1;
            --bg-button-duplicate-hover: #add6ad;
            --bg-button-export: #b0c4de;
            --bg-button-export-hover: #a0b7d3;
            --bg-button-save: #90ee90;
            --bg-button-save-hover: #78dd78;
            --bg-button-cancel: #ff94a0;
            --bg-button-cancel-hover: #ff808c;
            --bg-button-update: #89cff0;
            --bg-button-update-hover: #70c0e0;
            --bg-header: #87cefa;
            --overlay-base-rgb: 240, 248, 255;
            --bg-memo: #f5faff;
            --bg-cascade-button: var(--bg-button-action);
            --bg-cascade-button-hover: var(--bg-button-action-hover);
            --bg-cascade-delete-button: var(--bg-button-delete);
            --bg-cascade-delete-button-hover: var(--bg-button-delete-hover);
            --text-cascade-indicator: var(--text-secondary);
            --bg-button-header-delete: var(--bg-button-delete);
            --bg-button-header-delete-hover: var(--bg-button-delete-hover);
            --bg-button-header-copy: var(--bg-button-copy);
            --bg-button-header-copy-hover: var(--bg-button-copy-hover);
            --bg-code-copy-button: var(--bg-button-action);
            --bg-code-copy-button-hover: var(--bg-button-action-hover);
            --text-code-copy-button: var(--text-light);

            --text-primary: #3a5679;
            --text-secondary: #6b87a9;
            --text-light: #ffffff;
            --text-disabled: #aec8e1;
            --text-error: #a52a2a;
            --text-link: #5f9ea0;
            --text-placeholder: #9ab0c9;
            --text-system: #5a7698;
            --text-memo: #3a5679;

            --border-primary: #b0dfff;
            --border-secondary: #d5eaff;
            --border-tertiary: #eaf5ff;
            --border-danger: #add8e6;
            --border-system: #c1d8e8;

            --shadow-primary: rgba(150, 180, 200, 0.1);
            --shadow-secondary: rgba(150, 180, 200, 0.1);

            --bg-dialog-file-item: var(--bg-tertiary);
            --border-dialog-file-item: var(--border-secondary);
            --text-dialog-file-name: var(--text-primary);
            --text-dialog-file-size: var(--text-secondary);
            --bg-dialog-button-select: var(--bg-button-action);
            --bg-dialog-button-select-hover: var(--bg-button-action-hover);
            --bg-dialog-button-confirm: var(--bg-button-save);
            --bg-dialog-button-confirm-hover: var(--bg-button-save-hover);
            --bg-dialog-button-cancel: var(--bg-button-cancel);
            --bg-dialog-button-cancel-hover: var(--bg-button-cancel-hover);

            --bg-attachment-details: rgba(224, 240, 255, 0.5);
            --border-attachment-details: var(--border-tertiary);
            --text-attachment-summary: var(--text-secondary);
            --text-attachment-filename: var(--text-primary);

            --bg-toggle-button: var(--bg-button-action);
            --bg-toggle-button-hover: var(--bg-button-action-hover);
            --text-toggle-button: var(--text-light);

            --bg-button-gold: #ffe48c;
            --bg-button-gold-hover: #ffda70;
            --text-button-gold: #7a6200;
            --bg-button-purple: #c1b2d7;
            --bg-button-purple-hover: #b0a0cb;
            --text-button-purple: #ffffff;

            --message-actions-base-rgb: 224, 240, 255;

            --default-user-name-bubble-custom-rgb: 224, 240, 255;
            --default-ai-name-bubble-custom-rgb: 224, 240, 255;
        }

        body.pastel-yellow-mode {
            --bg-primary: #fffefa;
            --bg-secondary: #fffacd;
            --bg-tertiary: #fff8dc;
            --bg-tertiary-rgb: 255, 248, 220;
            --bg-input: #ffffff;
            --bg-user-message: #fff5ba;
            --bg-model-message: #ffe4b5;
            --bg-system-message: #fffbea;
            --bg-error-message: #ffebcd;
            --bg-button: #ffd700;
            --bg-button-rgb: 255, 215, 0;
            --bg-button-hover: #ffc700;
            --bg-button-disabled: #fff0b3;
            --bg-button-action: #ffec8b;
            --bg-button-action-hover: #ffdf60;
            --bg-button-delete: #ffa07a;
            --bg-button-delete-hover: #ff8c69;
            --bg-button-retry: #b0e57c;
            --bg-button-retry-hover: #9acd32;
            --bg-button-edit: #ffa500;
            --bg-button-edit-hover: #ff8c00;
            --bg-button-copy: #ffb6c1;
            --bg-button-copy-hover: #ffaab5;
            --bg-button-paste: #add8e6;
            --bg-button-paste-hover: #9ccce0;
            --bg-button-duplicate: #f0e68c;
            --bg-button-duplicate-hover: #eadc67;
            --bg-button-export: #fff0b3;
            --bg-button-export-hover: #ffe78a;
            --bg-button-save: #98fb98;
            --bg-button-save-hover: #82f082;
            --bg-button-cancel: #ffdab9;
            --bg-button-cancel-hover: #ffceaa;
            --bg-button-update: #ffcc5c;
            --bg-button-update-hover: #ffbf40;
            --bg-header: #ffd700;
            --overlay-base-rgb: 255, 254, 250;
            --bg-memo: #fffef0;
            --bg-cascade-button: var(--bg-button-action);
            --bg-cascade-button-hover: var(--bg-button-action-hover);
            --bg-cascade-delete-button: var(--bg-button-delete);
            --bg-cascade-delete-button-hover: var(--bg-button-delete-hover);
            --text-cascade-indicator: var(--text-secondary);
            --bg-button-header-delete: var(--bg-button-delete);
            --bg-button-header-delete-hover: var(--bg-button-delete-hover);
            --bg-button-header-copy: var(--bg-button-copy);
            --bg-button-header-copy-hover: var(--bg-button-copy-hover);
            --bg-code-copy-button: var(--bg-button-action);
            --bg-code-copy-button-hover: var(--bg-button-action-hover);
            --text-code-copy-button: var(--text-light);

            --text-primary: #5d4037;
            --text-secondary: #8d6e63;
            --text-light: #424242;
            --text-disabled: #bcaaa4;
            --text-error: #b71c1c;
            --text-link: #ff8f00;
            --text-placeholder: #a1887f;
            --text-system: #795548;
            --text-memo: #5d4037;

            --border-primary: #fff0b3;
            --border-secondary: #fff5ba;
            --border-tertiary: #fffacd;
            --border-danger: #ffcc80;
            --border-system: #fff9c4;

            --shadow-primary: rgba(200, 180, 130, 0.1);
            --shadow-secondary: rgba(200, 180, 130, 0.1);

            --bg-toggle-button: var(--bg-button-action);
            --bg-toggle-button-hover: var(--bg-button-action-hover);
            --text-toggle-button: var(--text-light);

            --bg-button-gold: var(--bg-button);
            --bg-button-gold-hover: var(--bg-button-hover);
            --text-button-gold: var(--text-light);
            --bg-button-purple: #e6e6fa;
            --bg-button-purple-hover: #d8bfd8;
            --text-button-purple: #4b0082;

            --message-actions-base-rgb: 255, 250, 205;

            --default-user-name-bubble-custom-rgb: 255, 250, 205;
            --default-ai-name-bubble-custom-rgb: 255, 250, 205;
        }

        body.pastel-purple-mode {
            --bg-primary: #f3e5f5;
            --bg-secondary: #e1bee7;
            --bg-tertiary: #ede7f6;
            --bg-tertiary-rgb: 237, 231, 246;
            --bg-input: #ffffff;
            --bg-user-message: #d1c4e9;
            --bg-model-message: #c5cae9;
            --bg-system-message: #f3e8fd;
            --bg-error-message: #f8bbd0;
            --bg-button: #ab47bc;
            --bg-button-rgb: 171, 71, 188;
            --bg-button-hover: #9c27b0;
            --bg-button-disabled: #ce93d8;
            --bg-button-action: #ba68c8;
            --bg-button-action-hover: #a54eb4;
            --bg-button-delete: #ec407a;
            --bg-button-delete-hover: #d81b60;
            --bg-button-retry: #81c784;
            --bg-button-retry-hover: #66bb6a;
            --bg-button-edit: #ffb74d;
            --bg-button-edit-hover: #ffa726;
            --bg-button-copy: #7e57c2;
            --bg-button-copy-hover: #673ab7;
            --bg-button-paste: #64b5f6;
            --bg-button-paste-hover: #42a5f5;
            --bg-button-duplicate: #9575cd;
            --bg-button-duplicate-hover: #7e57c2;
            --bg-button-export: #b39ddb;
            --bg-button-export-hover: #9d80cf;
            --bg-button-save: #a5d6a7;
            --bg-button-save-hover: #81c784;
            --bg-button-cancel: #ef9a9a;
            --bg-button-cancel-hover: #e57373;
            --bg-button-update: #7986cb;
            --bg-button-update-hover: #5c6bc0;
            --bg-header: #ab47bc;
            --overlay-base-rgb: 243, 229, 245;
            --bg-memo: #fbfaff;
            --bg-cascade-button: var(--bg-button-action);
            --bg-cascade-button-hover: var(--bg-button-action-hover);
            --bg-cascade-delete-button: var(--bg-button-delete);
            --bg-cascade-delete-button-hover: var(--bg-button-delete-hover);
            --text-cascade-indicator: var(--text-secondary);
            --bg-button-header-delete: var(--bg-button-delete);
            --bg-button-header-delete-hover: var(--bg-button-delete-hover);
            --bg-button-header-copy: var(--bg-button-copy);
            --bg-button-header-copy-hover: var(--bg-button-copy-hover);
            --bg-code-copy-button: var(--bg-button-action);
            --bg-code-copy-button-hover: var(--bg-button-action-hover);
            --text-code-copy-button: var(--text-light);

            --text-primary: #4a148c;
            --text-secondary: #6a1b9a;
            --text-light: #ffffff;
            --text-disabled: #b39ddb;
            --text-error: #c2185b;
            --text-link: #7b1fa2;
            --text-placeholder: #9078a0;
            --text-system: #6a1b9a;
            --text-memo: #4a148c;

            --border-primary: #ce93d8;
            --border-secondary: #e1bee7;
            --border-tertiary: #f3e5f5;
            --border-danger: #f48fb1;
            --border-system: #d1c4e9;

            --shadow-primary: rgba(170, 150, 200, 0.1);
            --shadow-secondary: rgba(170, 150, 200, 0.1);

            --bg-toggle-button: var(--bg-button-action);
            --bg-toggle-button-hover: var(--bg-button-action-hover);
            --text-toggle-button: var(--text-light);

            --bg-button-gold: #ffee58;
            --bg-button-gold-hover: #fdd835;
            --text-button-gold: #424242;
            --bg-button-purple: var(--bg-button);
            --bg-button-purple-hover: var(--bg-button-hover);
            --text-button-purple: var(--text-light);

            --message-actions-base-rgb: 225, 190, 231;

            --default-user-name-bubble-custom-rgb: 225, 190, 231;
            --default-ai-name-bubble-custom-rgb: 225, 190, 231;
        }

        body.pastel-rainbow-mode {
            --bg-primary: #fdfdfd;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #fafafa;
            --bg-tertiary-rgb: 250, 250, 250;
            --bg-input: #ffffff;
            --bg-user-message: #e0fff0;
            --bg-model-message: #e0f0ff;
            --bg-system-message: #fff0f8;
            --bg-error-message: #fff8e0;
            --bg-button: #ff80c0;
            --bg-button-rgb: 255, 128, 192;
            --bg-button-hover: #ff60a0;
            --bg-button-disabled: #ffc0e0;
            --bg-button-action: #80d0ff;
            --bg-button-action-hover: #60b0e0;
            --bg-button-delete: #ff8080;
            --bg-button-delete-hover: #ff6060;
            --bg-button-retry: #80ff80;
            --bg-button-retry-hover: #60e060;
            --bg-button-edit: #ffc080;
            --bg-button-edit-hover: #ffa060;
            --bg-button-copy: #c080ff;
            --bg-button-copy-hover: #a060e0;
            --bg-button-paste: #ffff80;
            --bg-button-paste-hover: #e0e060;
            --bg-button-duplicate: #80ffff;
            --bg-button-duplicate-hover: #60e0e0;
            --bg-button-export: #ff80ff;
            --bg-button-export-hover: #e060e0;
            --bg-button-save: #c0ff80;
            --bg-button-save-hover: #a0e060;
            --bg-button-cancel: #ffc0c0;
            --bg-button-cancel-hover: #ffa0a0;
            --bg-button-update: #80c0ff;
            --bg-button-update-hover: #60a0e0;
            --bg-header: linear-gradient(to right, #ffadad, #ffd6a5, #fdffb6, #caffbf, #9bf6ff, #a0c4ff, #bdb2ff, #ffc6ff, #ffadad);
            --overlay-base-rgb: 253, 253, 253;
            --bg-memo: #f0fff0;
            --bg-code-copy-button: var(--bg-button-action);
            --bg-code-copy-button-hover: var(--bg-button-action-hover);
            --text-code-copy-button: var(--text-light);

            --text-primary: #333;
            --text-secondary: #555;
            --text-light: #fff;
            --text-disabled: #aaa;
            --text-error: #c00;
            --text-link: #007bff;
            --text-placeholder: #888;
            --text-system: #444;
            --text-memo: #333;

            --border-primary: #e0e0e0;
            --border-secondary: #f0f0f0;
            --border-tertiary: #fafafa;
            --border-danger: #ffdddd;
            --border-system: #e0e8f0;

            --bg-button-gold: #ffcc00;
            --text-button-gold: #333;
            --bg-button-purple: #cc99ff;
            --text-button-purple: #fff;

            --bg-cascade-button: var(--bg-button-action);
            --bg-cascade-button-hover: var(--bg-button-action-hover);
            --bg-cascade-delete-button: var(--bg-button-delete);
            --bg-cascade-delete-button-hover: var(--bg-button-delete-hover);
            --text-cascade-indicator: var(--text-secondary);
            --bg-button-header-delete: var(--bg-button-delete);
            --bg-button-header-delete-hover: var(--bg-button-delete-hover);
            --bg-button-header-copy: var(--bg-button-copy);
            --bg-button-header-copy-hover: var(--bg-button-copy-hover);

            --bg-dialog-file-item: var(--bg-tertiary);
            --border-dialog-file-item: var(--border-secondary);
            --text-dialog-file-name: var(--text-primary);
            --text-dialog-file-size: var(--text-secondary);
            --bg-dialog-button-select: var(--bg-button-action);
            --bg-dialog-button-select-hover: var(--bg-button-action-hover);
            --bg-dialog-button-confirm: var(--bg-button-save);
            --bg-dialog-button-confirm-hover: var(--bg-button-save-hover);
            --bg-dialog-button-cancel: var(--bg-button-cancel);
            --bg-dialog-button-cancel-hover: var(--bg-button-cancel-hover);

            --bg-attachment-details: rgba(240, 240, 240, 0.5);
            --border-attachment-details: var(--border-tertiary);
            --text-attachment-summary: var(--text-secondary);
            --text-attachment-filename: var(--text-primary);

            --bg-toggle-button: var(--bg-button-action);
            --bg-toggle-button-hover: var(--bg-button-action-hover);
            --text-toggle-button: var(--text-light);

            --message-actions-base-rgb: 245, 245, 245;

            --default-user-name-bubble-custom-rgb: 245, 245, 245;
            --default-ai-name-bubble-custom-rgb: 245, 245, 245;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            font-family: var(--font-family);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            overscroll-behavior-y: contain;
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow: hidden;
            touch-action: manipulation;
        }
        button {
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            font-size: 14px;
            background-color: var(--bg-button);
            color: var(--text-light);
            transition: background-color 0.2s ease, color 0.2s ease;
            line-height: 1.4;
        }
        button:hover:not(:disabled) {
            background-color: var(--bg-button-hover);
        }
        button:disabled {
            background-color: var(--bg-button-disabled);
            cursor: not-allowed;
            color: var(--text-disabled);
        }
        input[type="text"],
        input[type="password"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-primary);
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 10px;
            background-color: var(--bg-input);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
            color: var(--text-primary);
        }
        ::placeholder { color: var(--text-placeholder); opacity: 1; }
        :-ms-input-placeholder { color: var(--text-placeholder); }
        ::-ms-input-placeholder { color: var(--text-placeholder); }
        .hidden { display: none !important; }
        .layout-hidden { display: none !important; }

        .app-container {
            display: flex;
            position: relative;
            height: 100%;
            max-width: 800px;
            margin: 0 auto;
            background-color: var(--bg-primary);
            box-shadow: 0 0 10px var(--shadow-secondary);
            overflow: hidden;
            transition: background-color 0.3s ease;
        }

        .app-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background-color: rgba(var(--bg-header-rgb, 74, 144, 226), var(--header-footer-opacity, 1));
            color: var(--text-light);
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 10;
            transition: background-color 0.3s ease, padding 0.2s ease, gap 0.2s ease, min-height 0.2s ease;
            gap: 8px;
        }
        body.pastel-rainbow-mode .app-header {
            background: var(--bg-header);
        }

        .app-header h1 {
            font-size: 18px;
            font-weight: bold;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            text-align: left;
            margin: 0;
            margin-right: auto;
            flex-shrink: 1;
            min-width: 60px;
            transition: font-size 0.2s ease;
        }
        .header-button {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 20px;
            padding: 5px;
            line-height: 1;
            min-width: 30px;
            flex-shrink: 0;
            transition: padding 0.2s ease, font-size 0.2s ease, min-width 0.2s ease, height 0.2s ease;
        }
        #goto-settings-btn {
            order: 99;
            margin-left: 5px;
        }

        .app-header #toggle-clipboard-stack-btn,
        .app-header #toggle-memo-btn,
        .app-header .scroll-jump-button,
        .app-header #toggle-all-content-btn,
        .app-header .api-provider-toggle-btn {
            background-color: transparent !important;
            color: var(--text-light);
            box-shadow: none !important;
            border: 1px solid transparent;
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }
        .app-header #toggle-clipboard-stack-btn:hover,
        .app-header #toggle-memo-btn:hover,
        .app-header .scroll-jump-button:hover,
        .app-header #toggle-all-content-btn:hover,
        .app-header .api-provider-toggle-btn:hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
        }
        body.pastel-yellow-mode .app-header #toggle-clipboard-stack-btn,
        body.pastel-yellow-mode .app-header #toggle-memo-btn,
        body.pastel-yellow-mode .app-header .scroll-jump-button,
        body.pastel-yellow-mode .app-header #toggle-all-content-btn,
        body.pastel-yellow-mode .app-header .api-provider-toggle-btn {
            color: #424242;
        }
        body.pastel-yellow-mode .app-header #toggle-clipboard-stack-btn:hover,
        body.pastel-yellow-mode .app-header #toggle-memo-btn:hover,
        body.pastel-yellow-mode .app-header .scroll-jump-button:hover,
        body.pastel-yellow-mode .app-header #toggle-all-content-btn:hover,
        body.pastel-yellow-mode .app-header .api-provider-toggle-btn:hover {
            background-color: rgba(0, 0, 0, 0.05) !important;
            border-color: rgba(0, 0, 0, 0.1) !important;
        }
        body.dark-mode .app-header #toggle-clipboard-stack-btn:hover,
        body.dark-mode .app-header #toggle-memo-btn:hover,
        body.dark-mode .app-header .scroll-jump-button:hover,
        body.dark-mode .app-header #toggle-all-content-btn:hover,
        body.dark-mode .app-header .api-provider-toggle-btn:hover {
            background-color: rgba(255, 255, 255, 0.08) !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
        }

        #history-screen .app-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background-color: rgba(var(--bg-header-rgb, 74, 144, 226), var(--header-footer-opacity, 1));
            color: var(--text-light);
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 10;
            transition: background-color 0.3s ease, padding 0.2s ease, gap 0.2s ease, min-height 0.2s ease;
            gap: 10px;
            flex-direction: row-reverse;
            justify-content: flex-start;
        }
        body.pastel-rainbow-mode #history-screen .app-header {
            background: var(--bg-header);
        }

        #history-screen .app-header h1#history-title {
            font-size: 18px;
            font-weight: bold;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            text-align: right;
            margin: 0;
            margin-left: auto;
            order: 2;
            transition: font-size 0.2s ease;
        }
        #history-screen .app-header #back-to-chat-from-history {
            order: 1;
        }

        #history-screen .app-header #export-all-sessions-btn {
            order: 3;
            padding: 4px 8px;
        }
        #history-screen .app-header #import-all-sessions-btn {
            order: 4;
            padding: 4px 8px;
        }
        #history-screen .app-header #import-history-btn {
            order: 5;
            margin-right: 0;
            padding: 4px 8px;
        }

        .history-action-button.gold {
            background-color: var(--bg-button-gold);
            color: var(--text-button-gold);
        }
        .history-action-button.gold:hover:not(:disabled) {
            background-color: var(--bg-button-gold-hover);
        }
        .history-action-button.purple {
            background-color: var(--bg-button-purple);
            color: var(--text-button-purple);
        }
        .history-action-button.purple:hover:not(:disabled) {
            background-color: var(--bg-button-purple-hover);
        }
        body.dark-mode .history-action-button.gold {
            background-color: var(--bg-button-gold);
            color: var(--text-button-gold);
        }
        body.dark-mode .history-action-button.gold:hover:not(:disabled) {
            background-color: var(--bg-button-gold-hover);
        }
        body.dark-mode .history-action-button.purple {
            background-color: var(--bg-button-purple);
            color: var(--text-button-purple);
        }
        body.dark-mode .history-action-button.purple:hover:not(:disabled) {
            background-color: var(--bg-button-purple-hover);
        }
        body.pastel-pink-mode .history-action-button.gold,
        body.pastel-blue-mode .history-action-button.gold,
        body.pastel-yellow-mode .history-action-button.gold,
        body.pastel-purple-mode .history-action-button.gold,
        body.pastel-rainbow-mode .history-action-button.gold {
            background-color: var(--bg-button-gold);
            color: var(--text-button-gold);
        }
        body.pastel-pink-mode .history-action-button.gold:hover:not(:disabled),
        body.pastel-blue-mode .history-action-button.gold:hover:not(:disabled),
        body.pastel-yellow-mode .history-action-button.gold:hover:not(:disabled),
        body.pastel-purple-mode .history-action-button.gold:hover:not(:disabled),
        body.pastel-rainbow-mode .history-action-button.gold:hover:not(:disabled) {
            background-color: var(--bg-button-gold-hover);
        }
        body.pastel-pink-mode .history-action-button.purple,
        body.pastel-blue-mode .history-action-button.purple,
        body.pastel-yellow-mode .history-action-button.purple,
        body.pastel-purple-mode .history-action-button.purple,
        body.pastel-rainbow-mode .history-action-button.purple {
            background-color: var(--bg-button-purple);
            color: var(--text-button-purple);
        }
        body.pastel-pink-mode .history-action-button.purple:hover:not(:disabled),
        body.pastel-blue-mode .history-action-button.purple:hover:not(:disabled),
        body.pastel-yellow-mode .history-action-button.purple:hover:not(:disabled),
        body.pastel-purple-mode .history-action-button.purple:hover:not(:disabled),
        body.pastel-rainbow-mode .history-action-button.purple:hover:not(:disabled) {
            background-color: var(--bg-button-purple-hover);
        }

        .header-save-button {
            padding: 4px 12px;
            font-size: 13px;
            background-color: var(--bg-button-save);
            color: var(--text-light);
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease, padding 0.2s ease, font-size 0.2s ease, height 0.2s ease;
            flex-shrink: 0;
        }
        .header-save-button:hover:not(:disabled) {
            background-color: var(--bg-button-save-hover);
        }
        body.dark-mode .header-save-button {
             background-color: var(--bg-button-save);
        }
        body.dark-mode .header-save-button:hover:not(:disabled) {
             background-color: var(--bg-button-save-hover);
        }
        .header-notice {
            font-size: 11px;
            font-weight: normal;
            color: rgba(255, 255, 255, 0.8);
            text-align: right;
            white-space: nowrap;
            flex-shrink: 0;
        }
        body.dark-mode .header-notice {
            color: rgba(255, 255, 255, 0.7);
        }
        body.pastel-pink-mode .header-notice,
        body.pastel-blue-mode .header-notice,
        body.pastel-yellow-mode .header-notice,
        body.pastel-purple-mode .header-notice,
        body.pastel-rainbow-mode .header-notice {
            color: var(--text-light);
            opacity: 0.9;
        }
        body.pastel-yellow-mode .header-button,
        body.pastel-yellow-mode .header-notice {
            color: #424242;
        }
        body.pastel-yellow-mode .new-chat-button,
        body.pastel-yellow-mode .app-header .action-button-in-header,
        body.pastel-yellow-mode .header-save-button {
            color: #424242;
        }
        body.pastel-rainbow-mode .header-button,
        body.pastel-rainbow-mode .header-notice,
        body.pastel-rainbow-mode .new-chat-button,
        body.pastel-rainbow-mode .app-header .action-button-in-header,
        body.pastel-rainbow-mode .header-save-button {
            color: var(--text-light);
        }

        .new-chat-button {
            font-size: 14px;
            padding: 5px 10px;
            background-color: var(--bg-button-save);
            color: var(--text-light);
            flex-shrink: 0;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease, padding 0.2s ease, font-size 0.2s ease, height 0.2s ease;
        }
        .new-chat-button:hover {
            background-color: var(--bg-button-save-hover);
        }
        body.dark-mode .new-chat-button {
            background-color: var(--bg-button-save);
        }
        body.dark-mode .new-chat-button:hover {
            background-color: var(--bg-button-save-hover);
        }
        .app-header .action-button-in-header {
            padding: 5px 10px;
            font-size: 14px;
            color: var(--text-light);
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease, padding 0.2s ease, font-size 0.2s ease, height 0.2s ease;
            flex-shrink: 0;
        }
        .app-header #delete-session-btn {
            background-color: var(--bg-button-header-delete);
        }
        .app-header #delete-session-btn:hover:not(:disabled) {
            background-color: var(--bg-button-header-delete-hover);
        }
        .app-header #copy-session-btn {
            background-color: var(--bg-button-header-copy);
        }
        .app-header #copy-session-btn:hover:not(:disabled) {
            background-color: var(--bg-button-header-copy-hover);
        }

        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            position: relative;
            z-index: 1;
            touch-action: pan-y;
        }

        .home-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            justify-content: center;
            height: 100%;
            max-width: 300px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
        }

        .home-button {
            background: var(--bg-button);
            color: var(--text-light);
            border: none;
            padding: 20px 40px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.2s ease;
            position: relative;
            z-index: 11;
            pointer-events: auto;
        }

        .home-button:hover {
            background: var(--bg-button-hover);
        }

        .home-button:active {
            transform: scale(0.98);
        }

        .prompt-setup-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .setting-group {
            margin-bottom: 25px;
        }

        .setting-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .setting-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            background: var(--bg-input);
            color: var(--text-primary);
            font-size: 16px;
            transition: border-color 0.2s ease;
        }

        .setting-select:focus {
            outline: none;
            border-color: var(--bg-button);
        }
        .setting-input {
            padding: 10px;
            border: 1px solid var(--border-primary);
            border-radius: 5px;
            font-size: 14px;
            background-color: var(--bg-input);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        .setting-input:focus {
            outline: none;
            border-color: var(--bg-button);
        }

        .prompt-preview {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-secondary);
            border-radius: 6px;
            padding: 15px;
            min-height: 200px;
            width: 100%;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            white-space: pre-wrap;
            color: var(--text-secondary);
        }

        #prompt-setup-system-prompt {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            background: var(--bg-input);
            color: var(--text-primary);
            font-family: monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            transition: border-color 0.2s ease;
        }

        #prompt-setup-system-prompt:focus {
            outline: none;
            border-color: var(--bg-button);
        }

        #prompt-setup-system-prompt[readonly] {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-primary);
            z-index: 0;
            opacity: 0;
            visibility: hidden;
        }
        .screen.active {
            z-index: 1;
            opacity: 1;
            visibility: visible;
        }

        #chat-screen {
            position: relative;
            z-index: 0;
            background-image: var(--chat-background-image);
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            transition: background-image 0.3s ease;
        }

        #chat-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(var(--overlay-base-rgb), var(--chat-overlay-alpha));
            z-index: 0;
            transition: background-color 0.3s ease;
            pointer-events: none;
        }

        #chat-screen .main-content {
            z-index: 1;
            background-color: transparent;
            overflow-y: scroll;
            overflow-x: auto;
            touch-action: pan-x pan-y pinch-zoom;
            flex-grow: 1;
        }
        #chat-screen .app-header { z-index: 2; }
        #chat-screen .chat-input-area {
            z-index: 2;
            background-color: rgba(var(--bg-secondary-rgb, 240, 242, 245), var(--header-footer-opacity, 1));
        }
        #history-screen .main-content,
        #settings-screen .main-content {
            touch-action: pan-y;
        }

        #memo-area {
            position: relative;
            width: 100%;
            min-height: 80px;
            max-height: var(--memo-height);
            background-color: var(--bg-memo);
            border-bottom: 1px solid var(--border-secondary);
            padding: 10px 15px;
            z-index: 4;
            box-shadow: 0 1px 3px var(--shadow-primary);
            overflow: auto;
            display: flex;
            flex-direction: column;
            transition: max-height 0.3s ease-out, padding-top 0.3s ease-out, padding-bottom 0.3s ease-out, opacity 0.3s ease-out, border-width 0.3s ease-out;
            resize: vertical;
            margin-bottom: 0;
        }

        #memo-area.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            max-height: 0 !important;
            min-height: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            border-width: 0 !important;
            overflow: hidden;
        }

        .memo-actions-container {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            padding-bottom: 8px;
            flex-shrink: 0;
        }
        .memo-actions-container button {
            padding: 4px 10px;
            font-size: 12px;
        }
        .memo-actions-container .delete-memo-btn {
            background-color: var(--bg-button-delete);
        }
        .memo-actions-container .delete-memo-btn:hover {
            background-color: var(--bg-button-delete-hover);
        }
        .memo-actions-container .copy-memo-btn {
            background-color: var(--bg-button-copy);
        }
        .memo-actions-container .copy-memo-btn:hover {
            background-color: var(--bg-button-copy-hover);
        }
        .memo-actions-container .paste-memo-btn {
            background-color: var(--bg-button-paste);
        }
        .memo-actions-container .paste-memo-btn:hover {
            background-color: var(--bg-button-paste-hover);
        }

        #memo-editor {
            flex-grow: 1;
            width: 100%;
            border: none;
            resize: none;
            background-color: transparent;
            color: var(--text-memo);
            font-family: inherit;
            font-size: 14px;
            outline: none;
            padding: 0;
            margin: 0;
            min-height: 50px;
            display: block;
        }

        #clipboard-stack-area {
            position: relative;
            width: 100%;
            min-height: 80px;
            max-height: var(--clipboard-stack-height);
            background-color: var(--bg-memo);
            border-bottom: 1px solid var(--border-secondary);
            padding: 10px 15px;
            z-index: 5;
            box-shadow: 0 1px 3px var(--shadow-primary);
            overflow: auto;
            display: flex;
            flex-direction: column;
            transition: max-height 0.3s ease-out, padding-top 0.3s ease-out, padding-bottom 0.3s ease-out, opacity 0.3s ease-out, border-width 0.3s ease-out;
            resize: vertical;
            margin-bottom: 0;
        }

        #clipboard-stack-area.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            max-height: 0 !important;
            min-height: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            border-width: 0 !important;
            overflow: hidden;
        }

        .clipboard-stack-actions-container {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            padding-bottom: 8px;
            flex-shrink: 0;
        }
        .clipboard-stack-actions-container button {
            padding: 4px 10px;
            font-size: 12px;
        }
        .clipboard-stack-actions-container .delete-clipboard-stack-btn {
            background-color: var(--bg-button-delete);
        }
        .clipboard-stack-actions-container .delete-clipboard-stack-btn:hover {
            background-color: var(--bg-button-delete-hover);
        }
        .clipboard-stack-actions-container .copy-clipboard-stack-btn {
            background-color: var(--bg-button-copy);
        }
        .clipboard-stack-actions-container .copy-clipboard-stack-btn:hover {
            background-color: var(--bg-button-copy-hover);
        }
        .clipboard-stack-actions-container .paste-clipboard-stack-btn {
            background-color: var(--bg-button-paste);
        }
        .clipboard-stack-actions-container .paste-clipboard-stack-btn:hover {
            background-color: var(--bg-button-paste-hover);
        }

        #clipboard-stack-editor {
            flex-grow: 1;
            width: 100%;
            border: none;
            resize: none;
            background-color: transparent;
            color: var(--text-memo);
            font-family: inherit;
            font-size: 14px;
            outline: none;
            padding: 0;
            margin: 0;
            min-height: 50px;
            display: block;
        }

        .message-container {
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }
        .message {
            padding: 10px 15px;
            border-radius: 15px;
            max-width: var(--message-max-width);
            min-width: 30%;
            min-height: 40px;
            position: relative;
            word-wrap: break-word;
            margin-top: 35px;
            margin-bottom: 35px;
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease, opacity 0.3s ease;
            z-index: 1;
            box-shadow: 0 1px 2px var(--shadow-primary);
        }
        .message-icon {
            width: var(--message-icon-size);
            height: var(--message-icon-size);
            border-radius: 50%;
            object-fit: cover;
            position: absolute;
            top: calc( (var(--message-icon-size) / -2 + 2px) + var(--message-icon-offset-y, 0px) );
            border: 1px solid var(--border-secondary);
            background-color: var(--bg-tertiary);
            box-shadow: 0 1px 2px var(--shadow-primary);
            z-index: 2;
        }
        .message.user .message-icon {
            right: 5px;
        }
        .message.model .message-icon {
            left: 5px;
        }

        .message-icon-name {
            position: absolute;
            font-size: var(--icon-name-font-size, 10px);
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
            z-index: 2;
            top: calc(var(--message-icon-size) + var(--message-icon-offset-y, 0px) - (var(--message-icon-size) / 4) + var(--icon-name-offset-y, 0px) );
            padding: 0;
            background-color: transparent;
            border-radius: 0;
            line-height: 1.3;
        }
        .message.user .message-icon-name {
            left: auto;
            right: calc(var(--message-icon-size) + 8px);
            text-align: right;
        }
        .message.model .message-icon-name {
            left: calc(var(--message-icon-size) + 8px);
            right: auto;
            text-align: left;
        }

        .message.user .message-icon-name.has-bubble {
            background-color: var(--user-name-bubble-bg);
            padding-top: var(--user-name-bubble-padding-y);
            padding-bottom: var(--user-name-bubble-padding-y);
            padding-left: calc(var(--icon-name-font-size, 10px) * var(--user-name-bubble-padding-x-ratio));
            padding-right: calc(var(--icon-name-font-size, 10px) * var(--user-name-bubble-padding-x-ratio));
            border-radius: var(--user-name-bubble-border-radius);
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }

        .message.model .message-icon-name.has-bubble {
            background-color: var(--ai-name-bubble-bg);
            padding-top: var(--ai-name-bubble-padding-y);
            padding-bottom: var(--ai-name-bubble-padding-y);
            padding-left: calc(var(--icon-name-font-size, 10px) * var(--ai-name-bubble-padding-x-ratio));
            padding-right: calc(var(--icon-name-font-size, 10px) * var(--ai-name-bubble-padding-x-ratio));
            border-radius: var(--ai-name-bubble-border-radius);
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }

        .message.message-hidden-by-toggle {
            visibility: hidden;
            opacity: 0;
            max-height: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            margin-top: 0 !important;
            margin-bottom: 0 !important;
            border-width: 0 !important;
            overflow: hidden;
        }
        .message.message-hidden-by-toggle .message-actions,
        .message.message-hidden-by-toggle .message-cascade-controls,
        .message.message-hidden-by-toggle .message-toggle-button,
        .message.message-hidden-by-toggle .message-icon,
        .message.message-hidden-by-toggle .message-icon-name,
        .message.message-hidden-by-toggle .thought-summary-details {
            display: none !important;
        }
        .message.message-content-collapsed-fully .thought-summary-details {
            display: none !important;
        }

        .message:first-child {
            margin-top: 0;
        }
        .message pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: inherit;
            font-size: var(--message-body-font-size);
            margin: 0;
            color: inherit;
            transition: opacity 0.2s ease;
        }
        .message.user {
            background-color: rgba(var(--bg-user-message-rgb, 220, 248, 198), var(--message-bubble-opacity, 1));
            align-self: flex-end;
            border-bottom-right-radius: 5px;
            body:not(.dark-mode):not(.pastel-pink-mode):not(.pastel-blue-mode):not(.pastel-yellow-mode):not(.pastel-purple-mode):not(.pastel-rainbow-mode) & { color: #333; }
            body.dark-mode & { color: #e0e0e0; }
            body.pastel-pink-mode &, body.pastel-blue-mode &, body.pastel-yellow-mode &, body.pastel-purple-mode &, body.pastel-rainbow-mode & { color: var(--text-primary); }
        }
        .message.model {
            background-color: rgba(var(--bg-model-message-rgb, 229, 229, 234), var(--message-bubble-opacity, 1));
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            max-width: 90%;
        }
        .message.error {
            background-color: var(--bg-error-message);
            color: var(--text-error);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .message-content.collapsed {
            max-height: 50px;
            overflow: hidden;
            position: relative;
        }
        .message-content.collapsed::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 20px;
            pointer-events: none;
        }
        body:not(.dark-mode):not(.pastel-pink-mode):not(.pastel-blue-mode):not(.pastel-yellow-mode):not(.pastel-purple-mode):not(.pastel-rainbow-mode) .message.user .message-content.collapsed::after {
             background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, var(--bg-user-message) 100%);
        }
        body:not(.dark-mode):not(.pastel-pink-mode):not(.pastel-blue-mode):not(.pastel-yellow-mode):not(.pastel-purple-mode):not(.pastel-rainbow-mode) .message.model .message-content.collapsed::after {
             background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, var(--bg-model-message) 100%);
        }
        body.dark-mode .message.user .message-content.collapsed::after {
             background: linear-gradient(to bottom, rgba(var(--overlay-base-rgb),0) 0%, var(--bg-user-message) 100%);
        }
        body.dark-mode .message.model .message-content.collapsed::after {
             background: linear-gradient(to bottom, rgba(var(--overlay-base-rgb),0) 0%, var(--bg-model-message) 100%);
        }
        body.pastel-pink-mode .message.user .message-content.collapsed::after {
            background: linear-gradient(to bottom, rgba(var(--overlay-base-rgb),0) 0%, var(--bg-user-message) 100%);
        }
        body.pastel-pink-mode .message.model .message-content.collapsed::after {
            background: linear-gradient(to bottom, rgba(var(--overlay-base-rgb),0) 0%, var(--bg-model-message) 100%);
        }
        body.pastel-blue-mode .message.user .message-content.collapsed::after {
            background: linear-gradient(to bottom, rgba(var(--overlay-base-rgb),0) 0%, var(--bg-user-message) 100%);
        }
        body.pastel-blue-mode .message.model .message-content.collapsed::after {
            background: linear-gradient(to bottom, rgba(var(--overlay-base-rgb),0) 0%, var(--bg-model-message) 100%);
        }
        body.pastel-yellow-mode .message.user .message-content.collapsed::after {
            background: linear-gradient(to bottom, rgba(var(--overlay-base-rgb),0) 0%, var(--bg-user-message) 100%);
        }
        body.pastel-yellow-mode .message.model .message-content.collapsed::after {
            background: linear-gradient(to bottom, rgba(var(--overlay-base-rgb),0) 0%, var(--bg-model-message) 100%);
        }
        body.pastel-purple-mode .message.user .message-content.collapsed::after {
            background: linear-gradient(to bottom, rgba(var(--overlay-base-rgb),0) 0%, var(--bg-user-message) 100%);
        }
        body.pastel-purple-mode .message.model .message-content.collapsed::after {
            background: linear-gradient(to bottom, rgba(var(--overlay-base-rgb),0) 0%, var(--bg-model-message) 100%);
        }
        body.pastel-rainbow-mode .message.user .message-content.collapsed::after {
            background: linear-gradient(to bottom, rgba(var(--overlay-base-rgb),0) 0%, var(--bg-user-message) 100%);
        }
        body.pastel-rainbow-mode .message.model .message-content.collapsed::after {
            background: linear-gradient(to bottom, rgba(var(--overlay-base-rgb),0) 0%, var(--bg-model-message) 100%);
        }

        .message-toggle-button {
            position: absolute;
            background-color: var(--bg-toggle-button);
            color: var(--text-toggle-button);
            border: none;
            border-radius: 4px;
            padding: 16px 1px;
            line-height: 1;
            cursor: pointer;
            z-index: 3;
            opacity: 0.6;
            transition: opacity 0.2s ease, background-color 0.2s ease;
            pointer-events: auto;
            min-width: auto;
            white-space: nowrap;
        }
        .message-toggle-button:hover {
            background-color: var(--bg-toggle-button-hover);
        }
        .message:hover .message-toggle-button.top,
        .message.show-actions .message-toggle-button.top {
             opacity: calc(var(--message-toggle-button-top-opacity) + 0.1);
        }
        .message:hover .message-toggle-button.bottom,
        .message.show-actions .message-toggle-button.bottom {
            opacity: 1;
        }

        .message-toggle-button.top {
            top: 3px;
            right: 3px;
            left: auto;
            z-index: 3;
            font-size: var(--message-toggle-button-top-font-size);
            width: var(--message-toggle-button-top-width);
            height: var(--message-toggle-button-top-height);
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: var(--message-toggle-button-top-opacity);
        }

        .message-toggle-button.bottom {
            position: static;
            flex-shrink: 0;
            padding: 4px 10px;
            font-size: var(--message-toggle-button-bottom-font-size);
            line-height: 1.5;
        }

        .message-actions {
            position: absolute;
            bottom: -30px;
            display: none;
            flex-wrap: nowrap;
            gap: 5px;
            background-color: rgba(var(--message-actions-base-rgb), var(--message-actions-bg-opacity));
            padding: 1px 1px 1px 1px;
            border-radius: 5px;
            box-shadow: 0 1px 3px var(--shadow-primary);
            z-index: 2;
            transition: opacity 0.2s ease, background-color 0.3s ease;
        }

        .message.user .message-actions {
            right: 0;
            left: auto;
            justify-content: flex-end;
        }
        .message.model .message-actions {
            left: 0;
            right: auto;
            justify-content: flex-start;
        }
        .message-actions button {
            background-color: var(--bg-button-action);
            color: var(--text-light);
            padding: 4px 10px;
            font-size: 12px;
            border-radius: 4px;
            white-space: nowrap;
            line-height: 1.5;
        }
        body.pastel-yellow-mode .message-actions button,
        body.pastel-yellow-mode .message-cascade-controls button,
        body.pastel-yellow-mode .message-edit-actions button {
            color: var(--text-light);
        }

        .message-actions button:hover {
            background-color: var(--bg-button-action-hover);
        }
        .message-actions .js-edit-btn { background-color: var(--bg-button-edit); }
        .message-actions .js-edit-btn:hover { background-color: var(--bg-button-edit-hover); }
        .message-actions .js-delete-btn { background-color: var(--bg-button-delete); }
        .message-actions .js-delete-btn:hover { background-color: var(--bg-button-delete-hover); }
        .message-actions .js-retry-btn { background-color: var(--bg-button-retry); }
        .message-actions .js-retry-btn:hover { background-color: var(--bg-button-retry-hover); }
        .message-actions .js-copy-btn {
            background-color: var(--bg-button-copy);
        }
        .message-actions .js-copy-btn:hover {
            background-color: var(--bg-button-copy-hover);
        }

        .message-cascade-controls {
            position: absolute;
            top: -35px;
            left: 0;
            display: none;
            align-items: center;
            flex-wrap: nowrap;
            gap: 5px;
            background-color: rgba(var(--message-actions-base-rgb), var(--message-actions-bg-opacity));
            padding: 5px 8px 10px 8px;
            border-radius: 5px;
            box-shadow: 0 -1px 3px var(--shadow-primary);
            z-index: 2;
            transition: opacity 0.2s ease, background-color 0.3s ease;
        }
        .message.model:hover .message-cascade-controls,
        .message.model.show-actions .message-cascade-controls {
            display: flex;
        }
        .message-cascade-controls button {
            background-color: var(--bg-cascade-button);
            color: var(--text-light);
            padding: 4px 8px;
            font-size: 14px;
            border-radius: 4px;
            line-height: 1;
            min-width: 25px;
        }
        .message-cascade-controls button:hover:not(:disabled) {
            background-color: var(--bg-cascade-button-hover);
        }
        .message-cascade-controls button:disabled {
            background-color: var(--bg-button-disabled);
            cursor: not-allowed;
            opacity: 0.5;
        }
        .message-cascade-controls .cascade-indicator {
            font-size: 11px;
            color: var(--text-cascade-indicator);
            padding: 0 5px;
            white-space: nowrap;
            font-weight: 500;
        }
        .message-cascade-controls .cascade-delete-btn {
            background-color: var(--bg-cascade-delete-button);
            margin-left: 5px;
        }
        .message-cascade-controls .cascade-delete-btn:hover {
            background-color: var(--bg-cascade-delete-button-hover);
        }

        .message.editing pre {
            opacity: 0;
            height: 0;
            overflow: hidden;
            pointer-events: none;
        }
        .message.editing .message-actions,
        .message.editing .message-cascade-controls,
        .message.editing .message-toggle-button {
             opacity: 0;
             pointer-events: none;
             display: none !important;
        }
        .message-edit-area {
            margin-top: 5px;
        }
        .message-edit-area textarea {
            min-height: 60px;
            margin-bottom: 5px;
            width: 100%;
        }
        .message-edit-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 5px;
        }
        .message-edit-actions button {
            padding: 4px 10px;
            font-size: 12px;
        }
        .message-edit-actions .save-edit-btn { background-color: var(--bg-button-save); }
        .message-edit-actions .save-edit-btn:hover { background-color: var(--bg-button-save-hover); }
        .message-edit-actions .cancel-edit-btn { background-color: var(--bg-button-cancel); }
        .message-edit-actions .cancel-edit-btn:hover { background-color: var(--bg-button-cancel-hover); }

        .chat-input-area {
            display: flex;
            align-items: flex-end;
            padding: 10px 15px;
            border-top: 1px solid var(--border-primary);
            flex-shrink: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, border-color 0.3s ease, padding 0.2s ease, gap 0.2s ease;
            gap: 10px;
        }
        .footer-action-button {
            height: 40px;
            width: 40px;
            padding: 0;
            font-size: 20px;
            font-weight: bold;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--bg-button-action);
            color: var(--text-light);
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease, height 0.2s ease, width 0.2s ease, font-size 0.2s ease;
        }
        .footer-action-button:hover:not(:disabled) {
            background-color: var(--bg-button-action-hover);
        }
        body.pastel-yellow-mode .footer-action-button {
            color: #424242;
        }
        .chat-input-area button#attach-file-btn {
            position: relative;
        }
        .chat-input-area button#paste-to-input-btn {
            font-size: 16px;
        }

        .api-provider-toggle-btn {
            font-weight: 900;
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            font-size: 16px;
            min-width: 30px;
            padding: 5px;
            transition: font-size 0.2s ease, min-width 0.2s ease, height 0.2s ease;
        }
        .app-header .api-provider-toggle-btn {
            background-color: rgba(255, 255, 255, 0.2) !important;
        }
        .app-header .api-provider-toggle-btn:hover {
            background-color: rgba(255, 255, 255, 0.4) !important;
        }
        body.pastel-yellow-mode .app-header .api-provider-toggle-btn {
            color: #424242;
            background-color: rgba(0, 0, 0, 0.1) !important;
        }
        body.pastel-yellow-mode .app-header .api-provider-toggle-btn:hover {
            background-color: rgba(0, 0, 0, 0.2) !important;
        }

        .app-header .api-provider-toggle-btn.gemini { background-color: #ffffff !important; color: #8A75D2 !important; }
        .app-header .api-provider-toggle-btn.deepseek { background-color: #4D6BFF !important; color: #ffffff !important; }
        .app-header .api-provider-toggle-btn.claude { background-color: #D97757 !important; color: #EFEDE5 !important; }
        .app-header .api-provider-toggle-btn.openai { background-color: #10A37F !important; color: #ffffff !important; }
        .app-header .api-provider-toggle-btn.xai { background-color: #000000 !important; color: #ffffff !important; }
        .app-header .api-provider-toggle-btn.llmaggregator { background-color: #e53935 !important; color: #ffffff !important; }
        .app-header .api-provider-toggle-btn.dummy { background-color: #FFD700 !important; color: #ffffff !important; }
        .app-header .api-provider-toggle-btn.dummy:hover { background-color: #FFC700 !important; }
        body.dark-mode .app-header .api-provider-toggle-btn.gemini:hover {
            background-color: rgba(255, 255, 255, 0.9) !important;
            color: #8A75D2 !important;
        }
        body.dark-mode .app-header .api-provider-toggle-btn.deepseek:hover {
            background-color: rgba(77, 107, 255, 0.9) !important;
            color: #ffffff !important;
        }
        body.dark-mode .app-header .api-provider-toggle-btn.claude:hover {
            background-color: rgba(217, 119, 87, 0.9) !important;
            color: #EFEDE5 !important;
        }
        body.dark-mode .app-header .api-provider-toggle-btn.openai:hover {
            background-color: rgba(16, 163, 127, 0.9) !important;
            color: #ffffff !important;
        }
        body.dark-mode .app-header .api-provider-toggle-btn.xai:hover {
            background-color: rgba(0, 0, 0, 0.9) !important;
            color: #ffffff !important;
        }
        body.dark-mode .app-header .api-provider-toggle-btn.llmaggregator:hover {
            background-color: #c62828 !important;
        }
        .chat-input-area .api-provider-toggle-btn.gemini { background-color: #ffffff !important; color: #8A75D2 !important; }
        .chat-input-area .api-provider-toggle-btn.deepseek { background-color: #4D6BFF !important; color: #ffffff !important; }
        .chat-input-area .api-provider-toggle-btn.claude { background-color: #D97757 !important; color: #EFEDE5 !important; }
        .chat-input-area .api-provider-toggle-btn.openai { background-color: #10A37F !important; color: #ffffff !important; }
        .chat-input-area .api-provider-toggle-btn.xai { background-color: #000000 !important; color: #ffffff !important; }
        .chat-input-area .api-provider-toggle-btn.llmaggregator { background-color: #e53935 !important; color: #ffffff !important; }
        .chat-input-area .api-provider-toggle-btn.dummy { background-color: #FFD700 !important; color: #ffffff !important; }
       
        .attachment-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: var(--badge-size);
            height: var(--badge-size);
            background-color: var(--badge-color);
            border-radius: 50%;
            border: 1px solid var(--bg-primary);
            display: none;
            pointer-events: none;
        }
        .chat-input-area button#attach-file-btn.has-attachments .attachment-badge {
            display: block;
        }
        .chat-input-area textarea {
            flex-grow: 1;
            min-height: 40px;
            max-height: 120px;
            height: 40px;
            resize: none;
            margin-bottom: 0;
            padding: 8px 10px;
            overflow-y: auto;
            transition: min-height 0.2s ease, height 0.2s ease, padding 0.2s ease, font-size 0.2s ease;
        }
        .chat-input-area button#send-button {
            height: 40px;
            width: 40px;
            padding: 0;
            font-size: 18px;
            font-weight: bold;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s ease, height 0.2s ease, width 0.2s ease, font-size 0.2s ease;
        }
        .chat-input-area button#send-button.sending {
            background-color: #ffc107;
            color: #333;
        }
        .chat-input-area button#send-button.sending:hover {
            background-color: #ffa000;
        }
        body.dark-mode .chat-input-area button#send-button.sending {
            background-color: #ffd60a;
            color: #1a1a1a;
        }
        body.dark-mode .chat-input-area button#send-button.sending:hover {
            background-color: #ffca28;
        }
        body.pastel-pink-mode .chat-input-area button#send-button.sending,
        body.pastel-blue-mode .chat-input-area button#send-button.sending,
        body.pastel-yellow-mode .chat-input-area button#send-button.sending,
        body.pastel-purple-mode .chat-input-area button#send-button.sending,
        body.pastel-rainbow-mode .chat-input-area button#send-button.sending {
            background-color: #ffee88;
            color: #554400;
        }
        body.pastel-pink-mode .chat-input-area button#send-button.sending:hover,
        body.pastel-blue-mode .chat-input-area button#send-button.sending:hover,
        body.pastel-yellow-mode .chat-input-area button#send-button.sending:hover,
        body.pastel-purple-mode .chat-input-area button#send-button.sending:hover,
        body.pastel-rainbow-mode .chat-input-area button#send-button.sending:hover {
            background-color: #ffe766;
        }

        #loading-indicator {
            position: fixed;
            bottom: 65px;
            right: 20px;
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-style: normal;
            font-weight: 500;
            z-index: 3;
            box-shadow: 0 2px 5px var(--shadow-primary);
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            pointer-events: none;
        }
        #loading-indicator:not(.hidden) {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        body.dark-mode #loading-indicator {
            background-color: var(--bg-input);
            color: var(--text-secondary);
            box-shadow: 0 2px 6px var(--shadow-secondary);
        }

        #history-screen {
             background-color: var(--bg-primary);
        }
        #history-screen .main-content {
             background-color: transparent;
        }

        .history-list {
            list-style: none;
            padding: 0;
        }
        .history-item {
            padding: 12px;
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: var(--bg-primary);
            transition: background-color 0.2s ease, border-color 0.3s ease;
            cursor: pointer;
        }
        .history-item:hover {
            background-color: var(--bg-tertiary);
        }
        .history-item-details {
            overflow: hidden;
            min-width: 0;
            width: 100%;
            margin-bottom: 8px;
        }
        .history-item-title {
            font-size: 15px;
            font-weight: bold;
            margin-bottom: 0px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            display: block;
            color: var(--text-primary);
        }
        .history-item-character {
            font-size: 13px;
            font-weight: normal;
            margin-bottom: 0px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            display: block;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        .history-item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 0px;
        }
        .history-item-ai-icon {
            width: 40px !important;
            height: 40px !important;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            border: 1px solid var(--border-tertiary);
        }
        .history-item-bottom-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .history-item-dates {
            font-size: 9px;
            color: var(--text-secondary);
            flex-shrink: 0;
            line-height: 1.3;
            text-align: left;
        }
        .history-item-dates span {
            display: block;
            white-space: nowrap;
        }
        .history-item-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
            flex-wrap: nowrap;
            cursor: default;
        }
        .history-item-actions button {
             cursor: pointer;
        }
        .history-item-actions .js-edit-title-btn {
            background-color: var(--bg-button-edit);
            font-size: 16px;
            padding: 6px 8px;
        }
        .history-item-actions .js-edit-title-btn:hover { background-color: var(--bg-button-edit-hover); }
        .history-item-actions .js-delete-btn { background-color: var(--bg-button-delete); }
        .history-item-actions .js-delete-btn:hover { background-color: var(--bg-button-delete-hover); }
        .history-item-actions .js-duplicate-btn { background-color: var(--bg-button-duplicate); }
        .history-item-actions .js-duplicate-btn:hover { background-color: var(--bg-button-duplicate-hover); }
        .history-item-actions .js-export-btn { background-color: var(--bg-button-export); }
        .history-item-actions .js-export-btn:hover { background-color: var(--bg-button-export-hover); }
        .history-item-actions .js-link-session-btn,
        .history-item-actions .js-export-btn,
        .history-item-actions .js-duplicate-btn,
        .history-item-actions .js-delete-btn {
             padding: 6px 8px;
             font-size: 16px;
        }

        .js-history-item-template {
             display: none !important;
        }
        #no-history-message {
            text-align: center;
            color: var(--text-secondary);
            margin-top: 20px;
        }

        #settings-screen {
             background-color: var(--bg-primary);
        }
         #settings-screen .main-content {
             background-color: transparent;
        }

        .settings-group {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid var(--border-tertiary);
            border-radius: 8px;
            background-color: var(--bg-tertiary);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .settings-group h3 {
            margin-bottom: 15px;
            font-size: 16px;
            color: var(--text-link);
            border-bottom: 1px solid var(--border-tertiary);
            padding-bottom: 5px;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .settings-actions {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-tertiary);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .settings-actions.bottom {
            margin-bottom: 20px;
        }
        .settings-actions button {
            width: 100%;
        }
        .danger-zone {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid var(--border-danger);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .danger-zone button {
            width: 100%;
        }
        #update-app-btn {
            background-color: var(--bg-button-update);
        }
        #update-app-btn:hover {
            background-color: var(--bg-button-update-hover);
        }
        #clear-data-btn {
            background-color: var(--bg-button-delete);
        }
        #clear-data-btn:hover {
            background-color: var(--bg-button-delete-hover);
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            color: var(--text-primary);
        }
        .checkbox-label input[type="checkbox"] {
            width: auto;
            margin-bottom: 0;
            cursor: pointer;
        }
        .param-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .image-upload-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .settings-action-button {
            background-color: var(--bg-button-action);
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            font-size: 14px;
            color: var(--text-light);
            cursor: pointer;
        }
        .settings-action-button:hover {
            background-color: var(--bg-button-action-hover);
        }
        .settings-delete-button {
            background-color: var(--bg-button-delete);
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            font-size: 14px;
            color: var(--text-light);
            cursor: pointer;
            margin-left: auto;
        }
        .settings-delete-button:hover {
            background-color: var(--bg-button-delete-hover);
        }
        .background-thumbnail {
            max-width: 100px;
            max-height: 60px;
            border-radius: 4px;
            border: 1px solid var(--border-tertiary);
            object-fit: cover;
            vertical-align: middle;
        }
        .icon-thumbnail {
            max-width: 40px;
            max-height: 40px;
            border-radius: 50%;
            border: 1px solid var(--border-tertiary);
            object-fit: cover;
            vertical-align: middle;
            margin-left: 10px;
        }
        #gemini-additional-models,
        #deepseek-additional-models,
        #claude-additional-models,
        #openai-additional-models,
        #xai-additional-models,
        #llmaggregator-additional-models {
            height: 53px;
            max-height: 53px;
            resize: vertical;
        }

        @media (prefers-color-scheme: dark) {
          body:not(.light-mode-forced):not(.pastel-pink-mode):not(.pastel-blue-mode):not(.pastel-yellow-mode):not(.pastel-purple-mode):not(.pastel-rainbow-mode) {
            --bg-primary: #1a1a1a;
            --text-primary: #e0e0e0;
          }
        }

        .message-content {
            font-size: var(--message-body-font-size);
            line-height: 1.6;
            color: inherit;
            word-wrap: break-word;
            overflow-wrap: break-word;
            position: relative;
            z-index: 1;
        }
        .message-content > *:first-child { margin-top: 0; }
        .message-content > *:last-child { margin-bottom: 0; }
        .message-content h1, .message-content h2, .message-content h3, .message-content h4, .message-content h5, .message-content h6 {
            margin-top: 1.2em;
            margin-bottom: 0.6em;
            font-weight: bold;
            line-height: 1.3;
            color: inherit;
        }
        .message-content h1 { font-size: 1.8em; }
        .message-content h2 { font-size: 1.5em; }
        .message-content h3 { font-size: 1.3em; }
        .message-content h4 { font-size: 1.1em; }
        .message-content p {
            margin-bottom: 0.8em;
        }
        .message-content ul, .message-content ol {
            margin-bottom: 0.8em;
            padding-left: 2em;
        }
        .message-content li {
            margin-bottom: 0.3em;
        }
        .message-content li > ul, .message-content li > ol {
             margin-top: 0.3em;
             margin-bottom: 0.3em;
        }
        .message-content pre {
            background-color: var(--bg-secondary);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 1em 0;
            font-family: var(--font-family);
            font-size: var(--code-block-font-size);
            border: 1px solid var(--border-tertiary);
            color: var(--text-secondary);
            position: relative;
        }
        .message-content pre .code-copy-button {
            position: absolute;
            bottom: 5px;
            right: 5px;
            padding: 3px 8px;
            font-size: 10px;
            background-color: var(--bg-code-copy-button);
            color: var(--text-code-copy-button);
            border: none;
            border-radius: 3px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        .message-content pre:hover .code-copy-button {
            opacity: 1;
        }
        .message-content pre .code-copy-button:hover {
            background-color: var(--bg-code-copy-button-hover);
        }
        body.pastel-yellow-mode .message-content pre .code-copy-button {
            color: var(--text-light);
        }

        .message.user .message-content pre {
             background-color: transparent;
             padding: 0;
             margin: 0;
             border: none;
             border-radius: 0;
             color: inherit;
             font-family: inherit;
             font-size: var(--message-body-font-size);
             line-height: inherit;
             white-space: pre-wrap;
             word-wrap: break-word;
             overflow-x: visible;
             position: static;
        }
        .message.user .message-content pre .code-copy-button {
            display: none;
        }
        .message-content code:not(pre > code) {
            background-color: var(--bg-secondary);
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
            border: 1px solid var(--border-tertiary);
            color: var(--text-secondary);
        }
        .message-content blockquote {
            margin: 1em 0;
            padding-left: 1em;
            border-left: 4px solid var(--border-primary);
            color: var(--text-secondary);
        }
        .message-content blockquote > *:first-child { margin-top: 0; }
        .message-content blockquote > *:last-child { margin-bottom: 0; }
        .message-content a {
            color: var(--text-link);
            text-decoration: underline;
        }
        .message-content strong {
            font-weight: bold;
        }
        .message-content em {
            font-style: italic;
        }
        .message-content table {
            border-collapse: collapse;
            margin: 1em 0;
            width: auto;
            border: 1px solid var(--border-secondary);
        }
        .message-content th, .message-content td {
            border: 1px solid var(--border-secondary);
            padding: 6px 10px;
            text-align: left;
        }
        .message-content th {
            background-color: var(--bg-tertiary);
            font-weight: bold;
        }
        .message-content hr {
            border: none;
            border-top: 1px solid var(--border-secondary);
            margin: 1.5em 0;
        }

        .message-content img {
            display: block;
            max-width: 100%;
            height: auto;
            margin: 12px auto;
            border-radius: 8px;
            border: 1px solid var(--border-secondary);
            background-color: var(--bg-tertiary);
            box-shadow: 0 1px 3px var(--shadow-primary);
            cursor: pointer;
            transition: opacity 0.3s ease, transform 0.2s ease;
        }

        .message-content img:hover {
            opacity: 0.9;
            transform: scale(1.01);
        }

        .message:hover .message-actions,
        .message.show-actions .message-actions {
            display: flex;
        }
        .message.model:hover .message-cascade-controls,
        .message.model.show-actions .message-cascade-controls {
             display: flex;
        }
        .message:hover .message-toggle-button.top,
        .message.show-actions .message-toggle-button.top {
             opacity: calc(var(--message-toggle-button-top-opacity) + 0.1);
        }
        .message:hover .message-toggle-button.bottom,
        .message.show-actions .message-toggle-button.bottom {
             opacity: 1;
        }

        .message.editing.show-actions .message-actions,
        .message.editing.show-actions .message-cascade-controls,
        .message.editing.show-actions .message-toggle-button {
            display: none !important;
        }
        .message.retrying-hidden {
            display: none !important;
        }
        body.dark-mode .message-content pre {
            background-color: var(--bg-tertiary);
            border-color: var(--border-primary);
            color: var(--text-secondary);
        }
         body.dark-mode .message-content code:not(pre > code) {
            background-color: var(--bg-tertiary);
            border-color: var(--border-primary);
            color: var(--text-secondary);
        }
        body.dark-mode .message-content blockquote {
            border-left-color: var(--border-primary);
            color: var(--text-secondary);
        }
         body.dark-mode .message-content a {
            color: var(--text-link);
         }
        body.dark-mode .message-content table,
        body.dark-mode .message-content th,
        body.dark-mode .message-content td {
            border-color: var(--border-primary);
        }
        body.dark-mode .message-content th {
            background-color: var(--bg-secondary);
        }
        body.dark-mode .message-content hr {
            border-top-color: var(--border-primary);
        }
        body.pastel-pink-mode .message-content pre,
        body.pastel-blue-mode .message-content pre,
        body.pastel-yellow-mode .message-content pre,
        body.pastel-purple-mode .message-content pre,
        body.pastel-rainbow-mode .message-content pre {
            background-color: var(--bg-tertiary);
            border-color: var(--border-secondary);
            color: var(--text-secondary);
        }
        body.pastel-pink-mode .message-content code:not(pre > code),
        body.pastel-blue-mode .message-content code:not(pre > code),
        body.pastel-yellow-mode .message-content code:not(pre > code),
        body.pastel-purple-mode .message-content code:not(pre > code),
        body.pastel-rainbow-mode .message-content code:not(pre > code) {
            background-color: var(--bg-tertiary);
            border-color: var(--border-secondary);
            color: var(--text-secondary);
        }
        body.pastel-pink-mode .message-content blockquote,
        body.pastel-blue-mode .message-content blockquote,
        body.pastel-yellow-mode .message-content blockquote,
        body.pastel-purple-mode .message-content blockquote,
        body.pastel-rainbow-mode .message-content blockquote {
            border-left-color: var(--border-primary);
            color: var(--text-secondary);
        }
        body.pastel-pink-mode .message-content th,
        body.pastel-blue-mode .message-content th,
        body.pastel-yellow-mode .message-content th,
        body.pastel-purple-mode .message-content th,
        body.pastel-rainbow-mode .message-content th {
            background-color: var(--bg-secondary);
        }

        .message-actions .token-count-display {
            font-size: 0.7rem;
            color: var(--text-secondary);
            vertical-align: middle;
            line-height: 1.5;
            white-space: nowrap;
        }

        .custom-dialog {
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            padding: 25px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            box-shadow: 0 5px 20px var(--shadow-secondary);
            min-width: 280px;
            max-width: 500px;
            width: fit-content;
            box-sizing: border-box;
            margin-left: auto;
            margin-right: auto;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            position: relative;
            z-index: 100;
        }
        .custom-dialog::backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            transition: background-color 0.3s ease;
            z-index: 99;
        }

        body.dark-mode .custom-dialog::backdrop {
            background-color: rgba(30, 30, 30, 0.7);
        }
        body.pastel-pink-mode .custom-dialog::backdrop,
        body.pastel-blue-mode .custom-dialog::backdrop,
        body.pastel-yellow-mode .custom-dialog::backdrop,
        body.pastel-purple-mode .custom-dialog::backdrop,
        body.pastel-rainbow-mode .custom-dialog::backdrop {
            background-color: rgba(var(--overlay-base-rgb), 0.4);
        }

        .custom-dialog[open] {
            animation: dialog-fade-in 0.3s ease forwards;
        }
        @keyframes dialog-fade-in {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .custom-dialog .dialog-message {
            margin: 0 0 20px 0;
            font-size: 15px;
            line-height: 1.6;
            display: block;
            text-align: left;
        }
        .custom-dialog .dialog-input {
            width: 100%;
            padding: 8px 10px;
            margin-bottom: 20px;
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            font-size: 14px;
            background-color: var(--bg-input);
            color: var(--text-primary);
        }
        .custom-dialog .dialog-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }
        .custom-dialog button {
            padding: 8px 18px;
            font-weight: 500;
            min-width: 80px;
        }
        .custom-dialog .dialog-ok-btn {
            background-color: var(--bg-button);
            color: var(--text-light);
        }
        body.pastel-yellow-mode .custom-dialog .dialog-ok-btn,
        body.pastel-rainbow-mode .custom-dialog .dialog-ok-btn {
             color: var(--text-light);
        }
        .custom-dialog .dialog-ok-btn:hover:not(:disabled) {
            background-color: var(--bg-button-hover);
        }
         .custom-dialog .dialog-cancel-btn {
            background-color: var(--bg-button-action);
            color: var(--text-light);
        }
        body.pastel-yellow-mode .custom-dialog .dialog-cancel-btn,
        body.pastel-rainbow-mode .custom-dialog .dialog-cancel-btn {
             color: var(--text-light);
        }
        .custom-dialog .dialog-cancel-btn:hover:not(:disabled) {
            background-color: var(--bg-button-action-hover);
        }
        .thought-summary-details {
            margin-bottom: 10px;
            font-size: 13px;
            border: 1px solid var(--border-tertiary);
            border-radius: 5px;
            background-color: rgba(var(--bg-tertiary-rgb), var(--thought-summary-opacity));
            transition: background-color 0.3s ease, border-color 0.3s ease, opacity 0.3s ease;
        }
        .thought-summary-details summary {
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            list-style: none;
            padding: 6px 10px;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            align-items: center;
            gap: 5px;
            user-select: none;
        }
        .thought-summary-details summary::-webkit-details-marker { display: none; }
        .thought-summary-details summary::marker { display: none; }
        .thought-summary-details summary::before {
            content: '眺';
            font-size: 14px;
            display: inline-block;
        }
        .thought-summary-details[open] summary {
            border-bottom: 1px solid var(--border-tertiary);
        }
        .thought-summary-content {
            padding: 8px 10px;
            font-size: var(--thought-summary-font-size);
            line-height: 1.5;
            color: var(--text-primary);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .thought-summary-content > *:first-child { margin-top: 0; }
        .thought-summary-content > *:last-child { margin-bottom: 0; }
        .thought-summary-content ul,
        .thought-summary-content ol { margin-left: 1em;}
        body.dark-mode .thought-summary-details {
            border-color: var(--border-primary);
        }
        body.dark-mode .thought-summary-details summary {
            color: var(--text-secondary);
        }
        body.dark-mode .thought-summary-details[open] summary {
            border-bottom-color: var(--border-primary);
        }
        body.dark-mode .thought-summary-content {
            color: var(--text-primary);
        }
        .thought-summary-content pre {
            background-color: var(--bg-secondary);
            padding: 8px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 0.8em 0;
            font-family: var(--font-family);
            font-size: var(--thought-summary-font-size);
            border: 1px solid var(--border-tertiary);
            color: var(--text-secondary);
        }
        body.dark-mode .thought-summary-content pre {
            background-color: var(--bg-tertiary);
            border-color: var(--border-primary);
            color: var(--text-secondary);
        }
        .thought-summary-content code:not(pre > code) {
            background-color: var(--bg-secondary);
            padding: 0.1em 0.3em;
            border-radius: 3px;
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
            font-size: 0.85em;
            border: 1px solid var(--border-tertiary);
            color: var(--text-secondary);
        }
        body.dark-mode .thought-summary-content code:not(pre > code) {
            background-color: var(--bg-tertiary);
            border-color: var(--border-primary);
            color: var(--text-secondary);
        }
        .citation-details {
            margin-top: 10px;
            font-size: 12px;
            border-top: 1px dashed var(--border-secondary);
            padding-top: 8px;
        }
        .citation-details summary {
            cursor: pointer;
            font-weight: normal;
            color: var(--text-secondary);
            list-style: none;
            display: inline-block;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }
        .citation-details summary::-webkit-details-marker { display: none; }
        .citation-details summary::marker { display: none; }
        .citation-details summary:hover {
            text-decoration: underline;
        }
        .citation-list {
            list-style: none;
            padding-left: 0;
            margin-top: 8px;
            margin-bottom: 0;
        }
        .citation-list li {
            margin-bottom: 5px;
            overflow-wrap: break-word;
        }
        .citation-list li a {
            color: var(--text-link);
            text-decoration: none;
            display: block;
        }
        .citation-list li a:hover {
            text-decoration: underline;
        }
        body.dark-mode .citation-details {
            border-top-color: var(--border-primary);
        }
        body.dark-mode .citation-details summary {
            color: var(--text-secondary);
        }
        body.dark-mode .citation-list li a {
            color: var(--text-link);
        }
        body.dark-mode .message-content table,
        body.dark-mode .message-content th,
        body.dark-mode .message-content td {
            border-color: var(--border-primary);
        }
        body.dark-mode .message-content th {
            background-color: var(--bg-secondary);
        }
        body.dark-mode .message-content hr {
            border-top-color: var(--border-primary);
        }
        .attachment-details {
            margin-top: 10px;
            font-size: 12px;
            border: 1px solid var(--border-attachment-details);
            border-radius: 5px;
            background-color: var(--bg-attachment-details);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .attachment-details summary {
            cursor: pointer;
            font-weight: normal;
            color: var(--text-attachment-summary);
            list-style: none;
            padding: 5px 10px;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .attachment-details summary::-webkit-details-marker { display: none; }
        .attachment-details summary::marker { display: none; }
        .attachment-details summary::before {
            content: '梼';
            font-size: 14px;
            display: inline-block;
        }
        .attachment-details[open] summary {
            border-bottom: 1px solid var(--border-attachment-details);
        }
        .attachment-list {
            list-style: none;
            padding: 8px 10px 5px 10px;
            margin: 0;
        }
        .attachment-list li {
            margin-bottom: 4px;
            font-size: 10px;
            color: var(--text-attachment-filename);
            overflow-wrap: break-word;
            line-height: 1.4;
        }

        #fileUploadDialog {
            min-width: 320px;
            max-width: 600px;
            width: 90%;
        }
        .dialog-content {
            margin-bottom: 20px;
        }
        .file-upload-area {
            margin-bottom: 15px;
            text-align: center;
        }
        .file-upload-area .dialog-button {
            padding: 10px 20px;
            font-size: 14px;
        }
        .file-upload-area #select-files-btn {
            background-color: var(--bg-dialog-button-select);
        }
        .file-upload-area #select-files-btn:hover {
            background-color: var(--bg-dialog-button-select-hover);
        }
        #selected-files-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-secondary);
            border-radius: 5px;
            background-color: var(--bg-secondary);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .selected-file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-dialog-file-item);
            background-color: var(--bg-dialog-file-item);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .selected-file-item:last-child {
            border-bottom: none;
        }
        .selected-file-info {
            flex-grow: 1;
            overflow: hidden;
            margin-right: 10px;
        }
        .selected-file-name {
            display: block;
            font-size: 14px;
            color: var(--text-dialog-file-name);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .selected-file-size {
            display: block;
            font-size: 11px;
            color: var(--text-dialog-file-size);
        }
        .remove-file-btn {
            background-color: var(--bg-button-delete);
            color: var(--text-light);
            border: none;
            border-radius: 15%;
            width: 22px;
            height: 22px;
            min-width: 0 !important;
            font-size: 14px;
            line-height: 1;
            padding: 0;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        body.pastel-yellow-mode .remove-file-btn,
        body.pastel-rainbow-mode .remove-file-btn {
            color: var(--text-light);
        }
        .remove-file-btn:hover {
            background-color: var(--bg-button-delete-hover);
        }
        #file-upload-notice {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 10px;
            text-align: center;
        }
        #fileUploadDialog .dialog-actions {
            margin-top: 20px;
        }
        #fileUploadDialog .dialog-actions #confirm-attach-btn {
            background-color: var(--bg-dialog-button-confirm);
        }
        #fileUploadDialog .dialog-actions #confirm-attach-btn:hover:not(:disabled) {
            background-color: var(--bg-dialog-button-confirm-hover);
        }
        #fileUploadDialog .dialog-actions #cancel-attach-btn {
            background-color: var(--bg-dialog-button-cancel);
        }
        #fileUploadDialog .dialog-actions #cancel-attach-btn:hover:not(:disabled) {
            background-color: var(--bg-button-cancel-hover);
        }
        .orange-button {
            background-color: var(--bg-button-edit);
            color: var(--text-light);
        }
        .orange-button:hover:not(:disabled) {
            background-color: var(--bg-button-edit-hover);
        }
        body.dark-mode .orange-button {
            background-color: var(--bg-button-edit);
            color: var(--text-light);
        }
        body.dark-mode .orange-button:hover:not(:disabled) {
            background-color: var(--bg-button-edit-hover);
        }
        body.pastel-pink-mode .orange-button,
        body.pastel-blue-mode .orange-button,
        body.pastel-yellow-mode .orange-button,
        body.pastel-purple-mode .orange-button,
        body.pastel-rainbow-mode .orange-button {
            background-color: var(--bg-button-edit);
            color: var(--text-light);
        }
        body.pastel-pink-mode .orange-button:hover:not(:disabled),
        body.pastel-blue-mode .orange-button:hover:not(:disabled),
        body.pastel-yellow-mode .orange-button:hover:not(:disabled),
        body.pastel-purple-mode .orange-button:hover:not(:disabled),
        body.pastel-rainbow-mode .orange-button:hover:not(:disabled) {
            background-color: var(--bg-button-edit-hover);
        }
        body.pastel-yellow-mode .orange-button {
            color: #ffffff;
        }
        .danger-zone .orange-button {
            margin-top: 10px;
            width: 100%;
        }
        .interactive-title-content-style {
            margin-left: 3px;
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        .history-item-actions .js-link-session-btn {
        }
        .history-item-actions .js-link-session-btn:hover:not(:disabled) {
            background-color: var(--bg-button-action-hover) !important;
        }
        .history-item-actions .js-link-session-btn.linked-a {
            background-color: var(--bg-button-save) !important;
            color: var(--text-light) !important;
        }
        .history-item-actions .js-link-session-btn.linked-a:hover:not(:disabled) {
            background-color: var(--bg-button-save-hover) !important;
        }
        .history-item-actions .js-link-session-btn.linked-b {
            background-color: var(--bg-button-copy) !important;
            color: var(--text-light) !important;
        }
        .history-item-actions .js-link-session-btn.linked-b:hover:not(:disabled) {
            background-color: var(--bg-button-copy-hover) !important;
        }
        #ai-to-ai-chat-btn {
        }
        .set-thinking-budget-btn, .set-claude-param-btn {
            flex-grow: 1;
        }

        /* 繝倥ャ繝繝ｼ譛蟆丞喧 */
        .app-container.minimized-header .app-header,
        .app-container.minimized-header #history-screen .app-header {
            padding-top: 0;
            padding-bottom: 0;
            padding-left: 8px;
            padding-right: 8px;
            gap: 4px;
            min-height: 32px;
        }

        .app-container.minimized-header .app-header h1 {
            font-size: 15px;
        }

        .app-container.minimized-header .header-button,
        .app-container.minimized-header .new-chat-button,
        .app-container.minimized-header .app-header .action-button-in-header,
        .app-container.minimized-header .header-save-button {
            padding: 2px 6px;
            font-size: 13px;
            min-width: 28px;
            height: 28px;
        }

        .app-container.minimized-header .header-button {
            font-size: 16px;
            padding: 2px;
        }
        
        .app-container.minimized-header .api-provider-toggle-btn {
            font-size: 14px;
            min-width: 28px;
            height: 28px;
        }

        /* 繝輔ャ繧ｿ繝ｼ譛蟆丞喧 */
        .app-container.minimized-footer .chat-input-area {
            padding: 2px 8px;
            gap: 6px;
        }

        .app-container.minimized-footer .chat-input-area textarea {
            min-height: 32px;
            height: 32px;
            padding: 6px 8px;
            font-size: 13px;
        }

        .app-container.minimized-footer .chat-input-area .footer-action-button,
        .app-container.minimized-footer .chat-input-area button#send-button {
            height: 32px;
            width: 32px;
        }

        .app-container.minimized-footer .chat-input-area .footer-action-button {
             font-size: 16px;
        }
        .app-container.minimized-footer .chat-input-area button#paste-to-input-btn {
            font-size: 14px;
        }
        .app-container.minimized-footer .chat-input-area button#send-button {
            font-size: 16px;
        }

        .mermaid-container {
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .mermaid-diagram svg {
            max-width: 100% !important;
            height: auto !important;
        }

        .mermaid-toggle-button:hover {
            background-color: var(--bg-button-action-hover) !important;
        }

        .mermaid-copy-button:hover {
            background-color: var(--bg-button-copy-hover) !important;
        }
        body:not(.dark-mode):not(.pastel-pink-mode):not(.pastel-blue-mode):not(.pastel-yellow-mode):not(.pastel-purple-mode):not(.pastel-rainbow-mode) .mermaid-diagram {
            background-color: #ffffff !important;
        }

        body.dark-mode .mermaid-diagram {
            background-color: #2a2a2a !important;
        }

        body.dark-mode .mermaid-diagram svg {
            filter: none;
        }

        body.pastel-pink-mode .mermaid-diagram {
            background-color: #fff8fa !important;
        }

        body.pastel-blue-mode .mermaid-diagram {
            background-color: #f8fcff !important;
        }

        body.pastel-yellow-mode .mermaid-diagram {
            background-color: #fffef8 !important;
        }

        body.pastel-purple-mode .mermaid-diagram {
            background-color: #faf8ff !important;
        }

        body.pastel-rainbow-mode .mermaid-diagram {
            background-color: #fefefe !important;
        }

        body.dark-mode .mermaid-diagram svg .node rect,
        body.dark-mode .mermaid-diagram svg .node circle,
        body.dark-mode .mermaid-diagram svg .node ellipse,
        body.dark-mode .mermaid-diagram svg .node polygon {
            fill: #404040 !important;
            stroke: #666666 !important;
        }

        body.dark-mode .mermaid-diagram svg .node .label,
        body.dark-mode .mermaid-diagram svg text {
            fill: #e0e0e0 !important;
        }

        body.dark-mode .mermaid-diagram svg .edgePath .path {
            stroke: #888888 !important;
        }

        body.dark-mode .mermaid-diagram svg .arrowheadPath {
            fill: #888888 !important;
        }

        body.pastel-pink-mode .mermaid-diagram svg .node rect,
        body.pastel-pink-mode .mermaid-diagram svg .node circle,
        body.pastel-pink-mode .mermaid-diagram svg .node ellipse,
        body.pastel-pink-mode .mermaid-diagram svg .node polygon {
            fill: #ffe4f0 !important;
            stroke: #ff8fab !important;
        }

        body.pastel-blue-mode .mermaid-diagram svg .node rect,
        body.pastel-blue-mode .mermaid-diagram svg .node circle,
        body.pastel-blue-mode .mermaid-diagram svg .node ellipse,
        body.pastel-blue-mode .mermaid-diagram svg .node polygon {
            fill: #e8f4ff !important;
            stroke: #87cefa !important;
        }

        body.pastel-yellow-mode .mermaid-diagram svg .node rect,
        body.pastel-yellow-mode .mermaid-diagram svg .node circle,
        body.pastel-yellow-mode .mermaid-diagram svg .node ellipse,
        body.pastel-yellow-mode .mermaid-diagram svg .node polygon {
            fill: #fff8e1 !important;
            stroke: #ffd700 !important;
        }

        body.pastel-purple-mode .mermaid-diagram svg .node rect,
        body.pastel-purple-mode .mermaid-diagram svg .node circle,
        body.pastel-purple-mode .mermaid-diagram svg .node ellipse,
        body.pastel-purple-mode .mermaid-diagram svg .node polygon {
            fill: #f3e5f5 !important;
            stroke: #ab47bc !important;
        }

        body.pastel-rainbow-mode .mermaid-diagram svg .node rect,
        body.pastel-rainbow-mode .mermaid-diagram svg .node circle,
        body.pastel-rainbow-mode .mermaid-diagram svg .node ellipse,
        body.pastel-rainbow-mode .mermaid-diagram svg .node polygon {
            fill: #f0f8ff !important;
            stroke: #4a90e2 !important;
        }
        .attachment-actions {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: auto;
        }
        .attachment-actions button {
            padding: 2px 6px;
            font-size: 10px;
            border-radius: 3px;
            line-height: 1.2;
            min-width: 0;
        }
        .attachment-preview-btn {
            background-color: var(--bg-button-paste);
        }
        .attachment-preview-btn:hover {
            background-color: var(--bg-button-paste-hover);
        }
        .attachment-edit-btn {
            background-color: var(--bg-button-edit);
        }
        .attachment-edit-btn:hover {
            background-color: var(--bg-button-edit-hover);
        }
        .attachment-remove-btn {
            background-color: var(--bg-button-delete);
        }
        .attachment-remove-btn:hover {
            background-color: var(--bg-button-delete-hover);
        }
        .add-more-attachments-btn {
            display: block;
            width: calc(100% - 10px);
            margin: 8px 5px 0 5px;
            padding: 4px;
            font-size: 12px;
            background-color: var(--bg-button-save);
        }
        .add-more-attachments-btn:hover {
            background-color: var(--bg-button-save-hover);
        }
        .attachment-list-item-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .attachment-list-item-name {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 10px;
        }
        #imagePreviewDialog .dialog-content {
            padding: 0;
            margin: 0;
            max-height: 80vh;
            overflow: auto;
            text-align: center;
        }
        #imagePreviewDialog img {
            max-width: 100%;
            max-height: 75vh;
            display: block;
            margin: 0 auto;
        }
        #imagePreviewDialog .dialog-actions {
            margin-top: 15px;
        }
        .api-keys-list {
            margin-bottom: 15px;
        }
        .api-key-item {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 5px;
            padding: 5px;
            border: 1px solid var(--border-secondary);
            border-radius: 5px;
            background-color: var(--bg-tertiary);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .api-key-item:last-child {
        margin-bottom: 0;
        }
        .api-key-item.active {
            border-color: var(--bg-button);
            background-color: rgba(var(--bg-button-rgb, 74, 144, 226), 0.1);
        }
        .api-key-item-label {
            flex: 0 0 100px;
            font-size: 12px;
            font-weight: bold;
            color: var(--text-secondary);
            min-width: 0;
            padding: 6px 8px;
            border: 1px solid var(--border-primary);
            border-radius: 3px;
            background-color: var(--bg-input);
        }
        .api-key-item-input {
            flex: 1;
            min-width: 0;
            padding: 6px 8px;
            font-size: 13px;
            border: 1px solid var(--border-primary);
            border-radius: 3px;
            background-color: var(--bg-input);
            color: var(--text-primary);
            margin-bottom: 0;
        }
        .api-key-item-actions {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }
        .api-key-item-actions button {
            padding: 4px 8px;
            font-size: 11px;
            min-width: auto;
            line-height: 1.2;
        }
        .api-key-select-btn {
            background-color: var(--bg-button-save);
            color: var(--text-light);
        }
        .api-key-select-btn:hover {
            background-color: var(--bg-button-save-hover);
        }
        .api-key-select-btn.active {
            background-color: var(--bg-button);
            color: var(--text-light);
        }
        .api-key-select-btn.active:hover {
            background-color: var(--bg-button-hover);
        }
        .api-key-delete-btn {
            background-color: var(--bg-button-delete);
            color: var(--text-light);
        }
        .api-key-delete-btn:hover {
            background-color: var(--bg-button-delete-hover);
        }
        .add-api-key-btn {
            width: 100%;
            padding: 8px 12px;
            font-size: 13px;
            background-color: var(--bg-button-action);
            color: var(--text-light);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .add-api-key-btn:hover {
            background-color: var(--bg-button-action-hover);
        }
        .add-api-key-btn:disabled {
            background-color: var(--bg-button-disabled);
            cursor: not-allowed;
        }
        #settings-screen.auto-save-mode .app-header #settings-save-notice,
        #settings-screen.auto-save-mode .app-header .js-save-settings-btn {
            display: none !important;
        }
        
        /* 繝√Ε繝・ヨ險ｭ螳壹Δ繝ｼ繝繝ｫ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }
        
        .modal-content {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-secondary);
        }
        
        .modal-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 18px;
        }
        
        .modal-close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .modal-close-btn:hover {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .settings-section {
            margin-bottom: 20px;
        }
        
        .settings-section h4 {
            margin: 0 0 16px 0;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: bold;
        }
        
        .setting-item {
            margin-bottom: 16px;
        }
        
        .setting-item label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .setting-item input[type="text"],
        .setting-item textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            background-color: var(--bg-input);
            color: var(--text-primary);
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .setting-item textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .setting-item input[type="text"]:focus,
        .setting-item textarea:focus {
            outline: none;
            border-color: var(--bg-button);
            box-shadow: 0 0 0 2px rgba(var(--bg-button-rgb), 0.2);
        }
        
        .ai-icon-upload-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .ai-icon-upload-container input[type="file"] {
            flex: 1;
        }
        
        .ai-icon-preview {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid var(--border-primary);
        }
        
        .icon-remove-btn {
            padding: 6px 12px;
            background-color: var(--bg-button-delete);
            color: var(--text-light);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s ease;
        }
        
        .icon-remove-btn:hover {
            background-color: var(--bg-button-delete-hover);
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 20px;
            border-top: 1px solid var(--border-secondary);
        }
        
        .btn-primary {
            background-color: var(--bg-button);
            color: var(--text-light);
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s ease;
        }
        
        .btn-primary:hover {
            background-color: var(--bg-button-hover);
        }
        
        .btn-secondary {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s ease;
        }
        
        .btn-secondary:hover {
            background-color: var(--bg-tertiary);
        }
        
        /* 繝√Ε繝・ヨ險ｭ螳壹・繧ｿ繝ｳ縺ｮ繧ｹ繧ｿ繧､繝ｫ蠑ｷ蛹・*/
        #chat-settings-btn {
            position: relative;
            z-index: 10;
            pointer-events: auto !important;
            cursor: pointer !important;
        }
        
        #chat-settings-btn:hover {
            background-color: var(--bg-secondary);
        }
        
        /* 繝√Ε繝・ヨ險ｭ螳壹Δ繝ｼ繝繝ｫ縺ｮ繝輔ぃ繧､繝ｫ蜈･蜉帙せ繧ｿ繧､繝ｫ */
        .ai-icon-upload-container,
        .background-image-upload-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* 繝輔ぃ繧､繝ｫ蜈･蜉帙ヵ繧｣繝ｼ繝ｫ繝峨ｒ髱櫁｡ｨ遉ｺ縺ｫ */
        #chat-ai-icon,
        #chat-background-image {
            display: none;
        }
        
        /* 繝輔ぃ繧､繝ｫ驕ｸ謚槭・繧ｿ繝ｳ繧定ｿｽ蜉 */
        .file-select-btn {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s ease;
        }
        
        .file-select-btn:hover {
            background-color: var(--bg-tertiary);
        }
        
        /* 繝励Ξ繝薙Η繝ｼ逕ｻ蜒上・繧ｹ繧ｿ繧､繝ｫ */
        .ai-icon-preview {
            width: 32px;
            height: 32px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid var(--border-secondary);
        }
        
        .background-preview {
            width: 60px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid var(--border-secondary);
        }
        
        /* 蜑企勁繝懊ち繝ｳ縺ｮ繧ｹ繧ｿ繧､繝ｫ */
        .icon-remove-btn {
            background-color: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s ease;
        }
        
        .icon-remove-btn:hover {
            background-color: #cc0000;
        }
        
        /* 繝輔ぉ繝ｼ繝峨い繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ逕ｨ縺ｮ繧ｯ繝ｩ繧ｹ */
        .screen.fade-transition {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        
        .screen.fade-out {
            opacity: 0;
            visibility: hidden;
        }
        
        .screen.fade-in {
            opacity: 1;
            visibility: visible;
        }
    </style>
    <script src="marked.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
</head>
<body>
    <div class="app-container">

        <div id="home-screen" class="screen active">
            <header class="app-header">
                <h1>NekoCha</h1>
                <button id="home-goto-settings-btn" class="header-button" aria-label="險ｭ螳壹∈">笞・/button>
            </header>
            <main class="main-content">
                <div class="home-buttons-container">
                    <button id="start-chat-btn" class="home-button">莨夊ｩｱ繧貞ｧ九ａ繧・/button>
                    <button id="select-history-btn" class="home-button">螻･豁ｴ縺九ｉ驕ｸ謚・/button>
                </div>
            </main>
        </div>

        <div id="chat-screen" class="screen">
            <header class="app-header">
                <button id="goto-history-btn" class="header-button" aria-label="螻･豁ｴ荳隕ｧ縺ｸ">笘ｰ</button>
                <h1 id="chat-title">譁ｰ隕上メ繝｣繝・ヨ</h1>
                <button id="goto-home-btn" class="header-button" aria-label="繝帙・繝縺ｸ">匠</button>
                <button id="new-chat-btn" class="new-chat-button" title="譁ｰ隕上メ繝｣繝・ヨ繧帝幕蟋・>譁ｰ</button>
                <button id="delete-session-btn" class="action-button-in-header" title="迴ｾ蝨ｨ縺ｮ繝√Ε繝・ヨ繧貞炎髯､">蜑・/button>
                <button id="copy-session-btn" class="action-button-in-header" title="繝√Ε繝・ヨ蜈ｨ菴薙ｒ繧ｳ繝斐・">繧ｳ</button>
                <button id="header-api-provider-toggle-btn" class="header-button api-provider-toggle-btn" title="API繝励Ο繝舌う繝繝ｼ蛻・崛"></button>
                <button id="scroll-to-top-btn" class="header-button scroll-jump-button" aria-label="譛荳企Κ縺ｸ繧ｹ繧ｯ繝ｭ繝ｼ繝ｫ" title="譛荳企Κ縺ｸ">半</button>
                <button id="scroll-to-bottom-btn" class="header-button scroll-jump-button" aria-label="譛荳矩Κ縺ｸ繧ｹ繧ｯ繝ｭ繝ｼ繝ｫ" title="譛荳矩Κ縺ｸ">反</button>
                <button id="toggle-all-content-btn" class="header-button" aria-label="蜈ｨ繝｡繝・そ繝ｼ繧ｸ陦ｨ遉ｺ蛻・崛" title="蜈ｨ繝｡繝・そ繝ｼ繧ｸ縺ｮ陦ｨ遉ｺ/髱櫁｡ｨ遉ｺ繧貞・繧頑崛縺・>名・・/button>
                <button id="toggle-clipboard-stack-btn" class="header-button" aria-label="繧ｯ繝ｪ繝・・繝懊・繝峨せ繧ｿ繝・け繧帝幕髢・>嵐・・/button>
                <button id="toggle-memo-btn" class="header-button" aria-label="繝｡繝｢繧帝幕髢・>統</button>
                <button id="chat-settings-btn" class="header-button" aria-label="繝√Ε繝・ヨ險ｭ螳・ title="繝√Ε繝・ヨ險ｭ螳・>側</button>
                <button id="goto-settings-btn" class="header-button" aria-label="險ｭ螳壹∈">笞・/button>
            </header>

            <div id="memo-area" class="hidden">
                <div class="memo-actions-container">
                    <button id="delete-memo-btn" class="delete-memo-btn" title="繝｡繝｢縺ｮ蜀・ｮｹ繧貞・縺ｦ蜑企勁">蜈ｨ蜑企勁</button>
                    <button id="copy-memo-btn" class="copy-memo-btn" title="繝｡繝｢繧偵さ繝斐・">繧ｳ繝斐・</button>
                    <button id="paste-memo-btn" class="paste-memo-btn" title="繝｡繝｢縺ｫ雋ｼ繧贋ｻ倥￠">雋ｼ莉倥￠</button>
                </div>
                <textarea id="memo-editor" aria-label="繝｡繝｢蜈･蜉帙お繝ｪ繧｢" placeholder="縺薙％縺ｫ荳譎ら噪縺ｪ繝｡繝｢繧貞・蜉・..・井ｿ晏ｭ倥＆繧後∪縺帙ｓ・・></textarea>
            </div>

            <div id="clipboard-stack-area" class="hidden">
                <div class="clipboard-stack-actions-container">
                    <button id="delete-clipboard-stack-btn" class="delete-clipboard-stack-btn" title="繧ｹ繧ｿ繝・け縺ｮ蜀・ｮｹ繧貞・縺ｦ蜑企勁">蜈ｨ蜑企勁</button>
                    <button id="copy-clipboard-stack-btn" class="copy-clipboard-stack-btn" title="繧ｹ繧ｿ繝・け蜈ｨ菴薙ｒ繧ｳ繝斐・">蜈ｨ繧ｳ繝斐・</button>
                    <button id="paste-clipboard-stack-btn" class="paste-clipboard-stack-btn" title="繧ｹ繧ｿ繝・け縺ｫ雋ｼ繧贋ｻ倥￠">雋ｼ莉倥￠</button>
                </div>
                <textarea id="clipboard-stack-editor" aria-label="繧ｯ繝ｪ繝・・繝懊・繝峨せ繧ｿ繝・け蜈･蜉帙お繝ｪ繧｢" placeholder="縺薙％縺ｫ繧ｳ繝斐・縺輔ｌ縺溘Γ繝・そ繝ｼ繧ｸ縺瑚塘遨阪＆繧後∪縺・..・井ｿ晏ｭ倥＆繧後∪縺帙ｓ・・></textarea>
            </div>

            <main class="main-content">
                <div id="message-container" class="message-container">
                </div>
                <div id="loading-indicator" class="loading-indicator hidden" aria-live="polite">蠢懃ｭ比ｸｭ</div>
            </main>
            <footer class="chat-input-area">
                <button id="footer-api-provider-toggle-btn" class="footer-action-button api-provider-toggle-btn" title="API繝励Ο繝舌う繝繝ｼ蛻・崛"></button>
                <button id="roll-dice-btn" title="繝ｩ繝ｳ繝繝謨ｰ蛟､繧貞・蜉・ class="footer-action-button hidden">軸</button>
                <button id="ai-to-ai-chat-btn" title="AI髢謎ｼ夊ｩｱ繧ｹ繝・ャ繝怜ｮ溯｡・ class="footer-action-button hidden">則</button>
                <button id="paste-to-input-btn" title="蜈･蜉帶ｬ・↓雋ｼ繧贋ｻ倥￠" class="footer-action-button">雋ｼ</button>
                <textarea id="user-input" placeholder="繝｡繝・そ繝ｼ繧ｸ繧貞・蜉・.." rows="1" aria-label="繝｡繝・そ繝ｼ繧ｸ蜈･蜉・></textarea>
                <button id="attach-file-btn" title="繝輔ぃ繧､繝ｫ繧呈ｷｻ莉・ class="footer-action-button">+<span class="attachment-badge"></span></button>
                <button id="send-button" title="騾∽ｿ｡">騾・/button>
            </footer>
        </div>

        <div id="history-screen" class="screen">
            <header class="app-header">
                <button id="back-to-chat-from-history" class="header-button" aria-label="繝√Ε繝・ヨ縺ｸ謌ｻ繧・>・・/button>
                <h1 id="history-title">螻･豁ｴ荳隕ｧ</h1>

                <button id="export-all-sessions-btn" class="header-save-button history-action-button gold" title="蜈ｨ繧ｻ繝・す繝ｧ繝ｳ繧谷SON蠖｢蠑上〒蜃ｺ蜉・>蜈ｨ蜃ｺ蜉・/button>

                <button id="import-all-sessions-btn" class="header-save-button history-action-button purple" title="蜈ｨ繧ｻ繝・す繝ｧ繝ｳ繧谷SON蠖｢蠑上〒蜿冶ｾｼ">蜈ｨ蜿冶ｾｼ</button>
                <input type="file" id="import-all-sessions-input" accept=".json" class="hidden">

                <button id="import-history-btn" class="header-save-button" title="蜊倅ｸ螻･豁ｴ繧偵ユ繧ｭ繧ｹ繝亥ｽ｢蠑上〒繧､繝ｳ繝昴・繝・>繧､繝ｳ繝昴・繝・/button>
                <input type="file" id="import-history-input" accept=".txt" class="hidden">
            </header>
            <main class="main-content">
                <ul id="history-list" class="history-list">
                    <li class="js-history-item-template history-item">
                        <div class="history-item-details">
                            <div class="history-item-header">
                                <img class="history-item-ai-icon" src="" alt="AI Icon" style="display: none;">
                                <span class="history-item-title"></span>
                            </div>
                            <span class="history-item-character"></span>
                        </div>
                        <div class="history-item-bottom-row">
                            <div class="history-item-dates">
                                <span class="created-date"></span>
                                <span class="updated-date"></span>
                            </div>
                            <div class="history-item-actions">
                                <button class="js-link-session-btn" title="繧ｻ繝・す繝ｧ繝ｳ繧偵Μ繝ｳ繧ｯ/隗｣髯､" style="font-size: 16px; padding: 6px 8px; background-color: var(--bg-button-action);">迫</button>
                                <button class="js-edit-title-btn" title="繧ｿ繧､繝医Ν邱ｨ髮・>笨・/button>
                                <button class="js-export-btn" title="蜃ｺ蜉・>蜃ｺ蜉・/button>
                                <button class="js-duplicate-btn" title="隍・｣ｽ">隍・｣ｽ</button>
                                <button class="js-delete-btn" title="蜑企勁">蜑企勁</button>
                            </div>
                        </div>
                    </li>
                </ul>
                 <p id="no-history-message" class="hidden" style="text-align: center; color: var(--text-secondary); margin-top: 20px;">繝√Ε繝・ヨ螻･豁ｴ縺ｯ縺ゅｊ縺ｾ縺帙ｓ縲・/p>
            </main>
        </div>

        <div id="prompt-setup-screen" class="screen">
            <header class="app-header">
                <button id="back-to-home-from-prompt-setup" class="header-button" aria-label="繝帙・繝縺ｸ謌ｻ繧・>・・/button>
                <h1>繝√Ε繝・ヨ險ｭ螳・/h1>
                <button id="start-chat-with-prompt-btn" class="header-save-button" title="縺薙・繝励Ο繝ｳ繝励ヨ縺ｧ莨夊ｩｱ繧帝幕蟋・>髢句ｧ・/button>
            </header>
            <main class="main-content">
                <div class="prompt-setup-container">
                    <p style="color: var(--text-error); font-weight: bold; margin-bottom: 10px;">窶ｻ蛻晏屓蛻ｩ逕ｨ譎ゅ・縺ｾ縺哂PI險ｭ螳壹ｒ縺励※縺上□縺輔＞縲・/p>
                    
                    <!-- API險ｭ螳・-->
                    <details id="prompt-api-settings-group" class="setting-group">
                        <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">API險ｭ螳・/summary>
                        <div style="margin-top:15px;">
                            <div class="setting-group">
                                <label for="prompt-api-provider-select">菴ｿ逕ｨ縺吶ｋAPI繝励Ο繝舌う繝繝ｼ:</label>
                                <select id="prompt-api-provider-select" aria-label="API繝励Ο繝舌う繝繝ｼ驕ｸ謚・>
                                    <option value="gemini">Gemini (Google)窶ｻ謗ｨ螂ｨ</option>
                                    <option value="deepseek">DeepSeek</option>
                                    <option value="claude">Claude (Anthropic API)</option>
                                    <option value="openai">ChatGPT (OpenAI API)</option>
                                    <option value="xai">Grok (xAI API)</option>
                                    <option value="llmaggregator">LLM Aggregator</option>
                                    <option value="dummy">Dummy AI</option>
                                </select>
                                <p id="gemini-api-key-link" style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                                    Gemini API繧ｭ繝ｼ繧貞叙蠕暦ｼ・a href="https://ai.google.dev/gemini-api/docs/api-key" target="_blank" rel="noopener noreferrer" style="color: var(--text-link);">https://ai.google.dev/gemini-api/docs/api-key</a>
                                </p>
                            </div>
                            
                            <!-- Gemini API險ｭ螳・-->
                            <div id="prompt-gemini-settings" class="setting-group">
                                <label for="prompt-gemini-api-key">Gemini API繧ｭ繝ｼ:</label>
                                <input type="password" id="prompt-gemini-api-key" placeholder="API繧ｭ繝ｼ繧貞・蜉・ aria-label="Gemini API繧ｭ繝ｼ">
                                <label for="prompt-gemini-model-name" style="margin-top:10px;">繝｢繝・Ν蜷・</label>
                                <select id="prompt-gemini-model-name" aria-label="繝｢繝・Ν蜷・>
                                    <optgroup label="辟｡譁・>
                                        <option value="gemini-2.0-flash">gemini-2.0-flash</option>
                                        <option value="gemini-2.5-flash-preview-04-17">gemini-2.5-flash-preview-04-17</option>
                                        <option value="gemini-2.5-flash-preview-05-20">gemini-2.5-flash-preview-05-20</option>
                                        <option value="gemini-2.5-flash-lite-preview-06-17">gemini-2.5-flash-lite-preview-06-17</option>
                                        <option value="gemini-2.5-flash">gemini-2.5-flash</option>        
                                    </optgroup>
                                    <optgroup label="譛画侭">
                                        <option value="gemini-2.5-pro-preview-03-25">gemini-2.5-pro-preview-03-25</option>
                                        <option value="gemini-2.5-pro-preview-05-06">gemini-2.5-pro-preview-05-06</option>
                                        <option value="gemini-2.5-pro-preview-06-05">gemini-2.5-pro-preview-06-05</option>
                                        <option value="gemini-2.5-pro">gemini-2.5-pro</option>
                                    </optgroup>
                                    <optgroup label="繝ｦ繝ｼ繧ｶ繝ｼ謖・ｮ・ id="prompt-gemini-user-defined-models-group">
                                    </optgroup>
                                    <optgroup label="謠蝉ｾ帷ｵゆｺ・・菴ｿ逕ｨ荳榊庄・亥炎髯､蛟呵｣懶ｼ・>
                                        <option value="gemini-2.5-pro-exp-03-25">gemini-2.5-pro-exp-03-25</option>
                                    </optgroup>
                                </select>
                                <label for="prompt-gemini-additional-models" style="margin-top:10px;">霑ｽ蜉繝｢繝・Ν (繧ｫ繝ｳ繝槫玄蛻・ｊ):</label>
                                <textarea id="prompt-gemini-additional-models" placeholder="萓・ gemini-2.0-pro,gemini-2.0-flash-lite" aria-label="霑ｽ蜉繝｢繝・Ν"></textarea>
                            </div>
                            
                            <!-- DeepSeek API險ｭ螳・-->
                            <div id="prompt-deepseek-settings" class="setting-group hidden">
                                <label for="prompt-deepseek-api-key">DeepSeek API繧ｭ繝ｼ:</label>
                                <input type="password" id="prompt-deepseek-api-key" placeholder="DeepSeek API繧ｭ繝ｼ繧貞・蜉・ aria-label="DeepSeek API繧ｭ繝ｼ">
                                <label for="prompt-deepseek-model-name" style="margin-top:10px;">DeepSeek 繝｢繝・Ν蜷・</label>
                                <select id="prompt-deepseek-model-name" aria-label="DeepSeek 繝｢繝・Ν蜷・>
                                    <optgroup label="蝓ｺ譛ｬ繝｢繝・Ν (DeepSeek)">
                                        <option value="deepseek-chat">deepseek-chat</option>
                                        <option value="deepseek-coder">deepseek-coder</option>
                                        <option value="deepseek-reasoner">deepseek-reasoner</option>
                                    </optgroup>
                                     <optgroup label="繝ｦ繝ｼ繧ｶ繝ｼ謖・ｮ・(DeepSeek)" id="prompt-deepseek-user-defined-models-group">
                                    </optgroup>
                                </select>
                                <label for="prompt-deepseek-additional-models" style="margin-top:10px;">DeepSeek 霑ｽ蜉繝｢繝・Ν (繧ｫ繝ｳ繝槫玄蛻・ｊ):</label>
                                <textarea id="prompt-deepseek-additional-models" placeholder="萓・ custom-model-1,custom-model-2" aria-label="DeepSeek 霑ｽ蜉繝｢繝・Ν"></textarea>
                            </div>
                            
                            <!-- Claude API險ｭ螳・-->
                            <div id="prompt-claude-settings" class="setting-group hidden">
                                <label for="prompt-claude-api-key">Claude API繧ｭ繝ｼ:</label>
                                <input type="password" id="prompt-claude-api-key" placeholder="API繧ｭ繝ｼ繧貞・蜉・ aria-label="Claude API繧ｭ繝ｼ">
                                <label for="prompt-claude-model-name" style="margin-top:10px;">繝｢繝・Ν蜷・</label>
                                <select id="prompt-claude-model-name" aria-label="Claude繝｢繝・Ν蜷・>
                                    <optgroup label="Claude 4">
                                        <option value="claude-opus-4-20250514">Claude 4 Opus</option>
                                        <option value="claude-sonnet-4-20250514">Claude 4 Sonnet</option>
                                    </optgroup>
                                    <optgroup label="Claude 3.7 & 3.5">
                                        <option value="claude-3-7-sonnet-20250219">Claude 3.7 Sonnet</option>
                                        <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet v2</option>
                                        <option value="claude-3-5-sonnet-20240620">Claude 3.5 Sonnet v1</option>
                                        <option value="claude-3-5-haiku-20241022">Claude 3.5 Haiku</option>
                                    </optgroup>
                                    <optgroup label="Claude 3">
                                        <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                                        <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                                        <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                                    </optgroup>
                                    <optgroup label="譌ｧ繝｢繝・Ν (v2莉･蜑・">
                                        <option value="claude-2.1">Claude 2.1</option>
                                        <option value="claude-2.0">Claude 2.0</option>
                                    </optgroup>
                                    <optgroup label="繧ｨ繧､繝ｪ繧｢繧ｹ (譛譁ｰ迚医ｒ謖・☆)">
                                        <option value="claude-opus-4-0">claude-opus-4-0</option>
                                        <option value="claude-sonnet-4-0">claude-sonnet-4-0</option>
                                        <option value="claude-3-7-sonnet-latest">claude-3-7-sonnet-latest</option>
                                        <option value="claude-3-5-sonnet-latest">claude-3-5-sonnet-latest</option>
                                        <option value="claude-3-opus-latest">claude-3-opus-latest</option>
                                    </optgroup>
                                    <optgroup label="繝ｦ繝ｼ繧ｶ繝ｼ謖・ｮ・ id="prompt-claude-user-defined-models-group">
                                    </optgroup>
                                </select>
                                <label for="prompt-claude-additional-models" style="margin-top:10px;">霑ｽ蜉繝｢繝・Ν (繧ｫ繝ｳ繝槫玄蛻・ｊ):</label>
                                <textarea id="prompt-claude-additional-models" placeholder="萓・ my-custom-claude-model" aria-label="Claude 霑ｽ蜉繝｢繝・Ν"></textarea>
                            </div>
                            
                            <!-- OpenAI API險ｭ螳・-->
                            <div id="prompt-openai-settings" class="setting-group hidden">
                                <label for="prompt-openai-api-key">ChatGPT API繧ｭ繝ｼ:</label>
                                <input type="password" id="prompt-openai-api-key" placeholder="sk-..." aria-label="ChatGPT API繧ｭ繝ｼ">
                                <label for="prompt-openai-model-name" style="margin-top:10px;">繝｢繝・Ν蜷・</label>
                                <select id="prompt-openai-model-name" aria-label="OpenAI 繝｢繝・Ν蜷・>
                                    <optgroup label="GPT-4.1">
                                        <option value="gpt-4.1">gpt-4.1</option>
                                        <option value="gpt-4.1-mini">gpt-4.1-mini</option>
                                    </optgroup>
                                    <optgroup label="GPT-4o & Mini">
                                        <option value="gpt-4o">gpt-4o (2024-05-13)</option>
                                        <option value="gpt-4o-2024-08-06">gpt-4o-2024-08-06</option>
                                        <option value="gpt-4o-mini">gpt-4o-mini</option>
                                        <option value="gpt-4o-mini-2024-07-18">gpt-4o-mini-2024-07-18</option>
                                    </optgroup>
                                    <optgroup label="o1">
                                        <option value="o1">o1</option>
                                        <option value="o1-2024-12-17">o1-2024-12-17</option>
                                        <option value="o1-mini">o1-mini</option>
                                        <option value="o1-mini-2024-09-12">o1-mini-2024-09-12</option>
                                        <option value="o3-mini-2025-01-31">o3-mini-2025-01-31</option>
                                    </optgroup>
                                    <optgroup label="GPT-4 Turbo">
                                        <option value="gpt-4-turbo">gpt-4-turbo (2024-04-09)</option>
                                        <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                                    </optgroup>
                                    <optgroup label="Preview & 繧ｨ繧､繝ｪ繧｢繧ｹ (譛譁ｰ迚医ｒ謖・☆)">
                                        <option value="gpt-4.5-preview">gpt-4.5-preview</option>
                                        <option value="chatgpt-4o-latest">chatgpt-4o-latest</option>
                                        <option value="o1-preview">o1-preview</option>
                                    </optgroup>
                                    <optgroup label="繝ｦ繝ｼ繧ｶ繝ｼ謖・ｮ・ id="prompt-openai-user-defined-models-group">
                                    </optgroup>
                                </select>
                                <label for="prompt-openai-additional-models" style="margin-top:10px;">霑ｽ蜉繝｢繝・Ν (繧ｫ繝ｳ繝槫玄蛻・ｊ):</label>
                                <textarea id="prompt-openai-additional-models" placeholder="萓・ gpt-4,my-finetuned-model" aria-label="OpenAI 霑ｽ蜉繝｢繝・Ν"></textarea>
                            </div>
                            
                            <!-- xAI API險ｭ螳・-->
                            <div id="prompt-xai-settings" class="setting-group hidden">
                                <label for="prompt-xai-api-key">xAI API繧ｭ繝ｼ:</label>
                                <input type="password" id="prompt-xai-api-key" placeholder="xai-..." aria-label="xAI API繧ｭ繝ｼ">
                                <label for="prompt-xai-model-name" style="margin-top:10px;">繝｢繝・Ν蜷・</label>
                                <select id="prompt-xai-model-name" aria-label="xAI 繝｢繝・Ν蜷・>
                                    <optgroup label="Grok">
                                        <option value="grok-3-mini">grok-3-mini</option>
                                        <option value="grok-3-mini-fast">grok-3-mini-fast</option>
                                        <option value="grok-3">grok-3</option>
                                        <option value="grok-3-fast">grok-3-fast</option>
                                        <option value="grok-2-vision-1212">grok-2-vision-1212</option>
                                        <option value="grok-2-1212">grok-2-1212</option>
                                    </optgroup>
                                    <optgroup label="繝ｦ繝ｼ繧ｶ繝ｼ謖・ｮ・ id="prompt-xai-user-defined-models-group">
                                    </optgroup>
                                </select>
                                <label for="prompt-xai-additional-models" style="margin-top:10px;">霑ｽ蜉繝｢繝・Ν (繧ｫ繝ｳ繝槫玄蛻・ｊ):</label>
                                <textarea id="prompt-xai-additional-models" placeholder="萓・ custom-grok-model" aria-label="xAI 霑ｽ蜉繝｢繝・Ν"></textarea>
                            </div>
                            
                            <!-- LLM Aggregator API險ｭ螳・-->
                            <div id="prompt-llmaggregator-settings" class="setting-group hidden">
                                <label for="prompt-llmaggregator-api-backend">API 繝舌ャ繧ｯ繧ｨ繝ｳ繝・URL:</label>
                                <input type="text" id="prompt-llmaggregator-api-backend" placeholder="萓・ https://api.openrouter.ai/v1" aria-label="LLM Aggregator API 繝舌ャ繧ｯ繧ｨ繝ｳ繝・URL">
                                <label for="prompt-llmaggregator-api-key">API繧ｭ繝ｼ:</label>
                                <input type="password" id="prompt-llmaggregator-api-key" placeholder="API繧ｭ繝ｼ繧貞・蜉・ aria-label="LLM Aggregator API繧ｭ繝ｼ">
                                <label for="prompt-llmaggregator-model-name" style="margin-top:10px;">繝｢繝・Ν蜷・</label>
                                <select id="prompt-llmaggregator-model-name" aria-label="LLM Aggregator 繝｢繝・Ν蜷・>
                                    <optgroup label="繝・ヵ繧ｩ繝ｫ繝・>
                                        <option value="meta-llama/llama-4-maverick-17b-128e-instruct:free">meta-llama/llama-4-maverick-17b-128e-instruct:free</option>
                                        <option value="qwen/qwen2.5-vl-32b-instruct:free">qwen/qwen2.5-vl-32b-instruct:free</option>
                                        <option value="deepseek/deepseek-chat-v3-0324:free">deepseek/deepseek-chat-v3-0324:free</option>
                                    </optgroup>
                                    <optgroup label="繝ｦ繝ｼ繧ｶ繝ｼ謖・ｮ・ id="prompt-llmaggregator-user-defined-models-group">
                                    </optgroup>
                                </select>
                                <label for="prompt-llmaggregator-additional-models" style="margin-top:10px;">霑ｽ蜉繝｢繝・Ν (繧ｫ繝ｳ繝槫玄蛻・ｊ):</label>
                                <textarea id="prompt-llmaggregator-additional-models" placeholder="萓・ mistralai/Mixtral-8x7B-Instruct-v0.1,another/model" aria-label="LLM Aggregator 霑ｽ蜉繝｢繝・Ν"></textarea>
                            </div>
                        </div>
                    </details>
                    
                    <!-- 蝓ｺ譛ｬ險ｭ螳・-->
                    <details id="prompt-basic-settings-group" class="setting-group" open>
                        <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">蝓ｺ譛ｬ險ｭ螳・/summary>
                        <div style="margin-top:15px;">
                            <div class="setting-group">
                                <label for="character-select">繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ驕ｸ謚・</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <select id="character-select" class="setting-select" style="flex: 1;">
                                        <option value="">-- 繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ繧帝∈謚槭＠縺ｦ縺上□縺輔＞ --</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="setting-group">
                                <label for="prompt-ai-name-input">AI蜷・</label>
                                <input type="text" id="prompt-ai-name-input" class="setting-input" placeholder="AI蜷阪ｒ蜈･蜉・ maxlength="20" style="width: 200px;">
                                <label class="checkbox-label" style="margin-left: 10px;">
                                    <input type="checkbox" id="show-ai-name-checkbox" checked>
                                    AI蜷阪ｒ陦ｨ遉ｺ縺吶ｋ
                                </label>
                            </div>
                            
                            <div class="setting-group">
                                <label>AI繧｢繧､繧ｳ繝ｳ・・/label>
                                <div class="image-upload-controls" style="margin-top: 5px;">
                                    <input type="file" id="prompt-ai-icon-input" accept="image/jpeg, image/png, image/gif, image/webp" class="hidden">
                                    <button id="prompt-upload-ai-icon-btn" class="settings-action-button" type="button">AI繧｢繧､繧ｳ繝ｳ驕ｸ謚・..</button>
                                    <img id="prompt-ai-icon-thumbnail" src="" alt="AI繧｢繧､繧ｳ繝ｳ繝励Ξ繝薙Η繝ｼ" class="icon-thumbnail hidden">
                                    <button id="prompt-delete-ai-icon-btn" class="settings-delete-button hidden" type="button">蜑企勁</button>
                                </div>
                                <label class="checkbox-label" style="margin-top: 10px;">
                                    <input type="checkbox" id="show-ai-icon-checkbox" checked>
                                    AI繧｢繧､繧ｳ繝ｳ繧定｡ｨ遉ｺ縺吶ｋ
                                </label>
                            </div>
                            
                            <div class="setting-group">
                                <label>繝√Ε繝・ヨ逕ｻ髱｢縺ｮ閭梧勹逕ｻ蜒・</label>
                                <div class="image-upload-controls">
                                    <input type="file" id="prompt-background-image-input" accept="image/jpeg, image/png, image/gif, image/webp" class="hidden">
                                    <button id="prompt-upload-background-btn" class="settings-action-button" type="button">閭梧勹逕ｻ蜒城∈謚・..</button>
                                    <img id="prompt-background-thumbnail" src="" alt="閭梧勹逕ｻ蜒上・繝ｬ繝薙Η繝ｼ" class="background-thumbnail hidden">
                                    <button id="prompt-delete-background-btn" class="settings-delete-button hidden" type="button">蜑企勁</button>
                                </div>
                            </div>
                            
                            <div class="setting-group">
                                <label for="prompt-theme-select">繝√Ε繝・ヨ陦ｨ遉ｺ繝・・繝・</label>
                                <select id="prompt-theme-select" class="setting-select">
                                    <option value="">-- 繝・ヵ繧ｩ繝ｫ繝郁ｨｭ螳壹ｒ菴ｿ逕ｨ --</option>
                                    <option value="light">繝ｩ繧､繝医Δ繝ｼ繝・/option>
                                    <option value="dark">繝繝ｼ繧ｯ繝｢繝ｼ繝・/option>
                                    <option value="pastel-pink">繝代せ繝・Ν繝｢繝ｼ繝解洸ｷ</option>
                                    <option value="pastel-blue">繝代せ繝・Ν繝｢繝ｼ繝解洸ｵ</option>
                                    <option value="pastel-yellow">繝代せ繝・Ν繝｢繝ｼ繝解沺｡</option>
                                    <option value="pastel-purple">繝代せ繝・Ν繝｢繝ｼ繝解沺｣</option>
                                    <option value="pastel-rainbow">繝代せ繝・Ν繝｢繝ｼ繝解沍・/option>
                                </select>
                            </div>
                            
                            <div class="setting-group">
                                <label for="user-name-input">繝ｦ繝ｼ繧ｶ繝ｼ縺ｮ蜷榊燕(蜻ｼ縺ｳ蜷・:</label>
                                <input type="text" id="user-name-input" aria-label="繝ｦ繝ｼ繧ｶ繝ｼ縺ｮ蜷榊燕">
                            </div>
                            
                            <div class="setting-group">
                                <label for="user-relationship-select">繝ｦ繝ｼ繧ｶ繝ｼ縺ｨ縺ｮ髢｢菫・</label>
                                <select id="user-relationship-select" class="setting-select">
                                    <option value="none">縺ｪ縺・/option>
                                    <option value="first-meeting">蛻晏ｯｾ髱｢</option>
                                    <option value="friend">蜿矩＃</option>
                                    <option value="lover">諱倶ｺｺ</option>
                                </select>
                            </div>
                            
                            <div class="setting-group">
                                <label for="chat-mode-select">繝｢繝ｼ繝蛾∈謚・</label>
                                <select id="chat-mode-select" class="setting-select">
                                    <option value="conversation">莨夊ｩｱ繝｢繝ｼ繝・/option>
                                    <option value="novel">蟆剰ｪｬ繝｢繝ｼ繝・/option>
                                </select>
                            </div>
                        </div>
                    </details>
                    
                    <!-- 隧ｳ邏ｰ險ｭ螳・-->
                    <details id="prompt-advanced-settings-group" class="setting-group">
                        <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">隧ｳ邏ｰ險ｭ螳・/summary>
                        <div style="margin-top:15px;">
                            <div class="setting-group">
                                <label>繝槭・繧ｯ繝繧ｦ繝ｳ縺ｧ繝√Ε繝・ヨ蜀・↓逕ｻ蜒上ｒ陦ｨ遉ｺ:</label>
                                <p style="font-size: 12px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">迚ｹ螳壹・迥ｶ豕∽ｸ九〒縺ゅｉ縺九§繧∵欠螳壹＠縺溽判蜒上ｒ陦ｨ遉ｺ縺輔○縺ｾ縺吶・I縺檎判蜒上ｒ逕滓・縺吶ｋ縺ｮ縺ｧ縺ｯ縺ｪ縺上、I縺ｫ逕ｻ蜒酋RL繧堤匱險縺輔○縲ゞI蛛ｴ縺ｧ陦ｨ遉ｺ縺輔○縺ｾ縺吶・/p>
                                
                                <div style="margin-left: 20px;">
                                    <div style="margin-bottom: 10px;">
                                        <label for="emotion-url-normal" style="display: inline-block; width: 100px; font-size: 14px;">蟷ｳ蟶ｸ譎・</label>
                                        <input type="text" id="emotion-url-normal" class="setting-input" placeholder="逕ｻ蜒酋RL繧貞・蜉・ style="width: calc(100% - 110px);">
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <label for="emotion-url-happy" style="display: inline-block; width: 100px; font-size: 14px;">螫峨＠縺・→縺・</label>
                                        <input type="text" id="emotion-url-happy" class="setting-input" placeholder="逕ｻ蜒酋RL繧貞・蜉・ style="width: calc(100% - 110px);">
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <label for="emotion-url-fun" style="display: inline-block; width: 100px; font-size: 14px;">讌ｽ縺励＞縺ｨ縺・</label>
                                        <input type="text" id="emotion-url-fun" class="setting-input" placeholder="逕ｻ蜒酋RL繧貞・蜉・ style="width: calc(100% - 110px);">
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <label for="emotion-url-sad" style="display: inline-block; width: 100px; font-size: 14px;">謔ｲ縺励＞縺ｨ縺・</label>
                                        <input type="text" id="emotion-url-sad" class="setting-input" placeholder="逕ｻ蜒酋RL繧貞・蜉・ style="width: calc(100% - 110px);">
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <label for="emotion-url-angry" style="display: inline-block; width: 100px; font-size: 14px;">諤偵▲縺溘→縺・</label>
                                        <input type="text" id="emotion-url-angry" class="setting-input" placeholder="逕ｻ蜒酋RL繧貞・蜉・ style="width: calc(100% - 110px);">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </details>
                    
                    <div class="setting-group">
                        <label for="prompt-setup-system-prompt">繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ險ｭ螳壹・繝ｭ繝ｳ繝励ヨ:</label>
                        <textarea id="prompt-setup-system-prompt" placeholder="繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ繧帝∈謚槭☆繧九→閾ｪ蜍輔〒隱ｭ縺ｿ霎ｼ縺ｾ繧後∪縺・.." aria-label="繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ險ｭ螳壹・繝ｭ繝ｳ繝励ヨ" readonly></textarea>
                    </div>
                    
                    <div class="setting-group">
                        <label for="prompt-preview">險ｭ螳壹＆繧後ｋ繝励Ο繝ｳ繝励ヨ (繝励Ξ繝薙Η繝ｼ):</label>
                        <textarea id="prompt-preview" class="prompt-preview" placeholder="繝励Ο繝ｳ繝励ヨ縺後％縺薙↓陦ｨ遉ｺ縺輔ｌ縺ｾ縺・.." aria-label="險ｭ螳壹＆繧後ｋ繝励Ο繝ｳ繝励ヨ"></textarea>
                    </div>
                </div>
            </main>
        </div>

        <div id="settings-screen" class="screen">
            <header class="app-header">
                 <button id="back-to-chat-from-settings" class="header-button" aria-label="繝√Ε繝・ヨ縺ｸ謌ｻ繧・>・・/button>
                 <h1>險ｭ螳・/h1>
                 <span id="settings-save-notice" class="header-notice">窶ｻ蜿肴丐縺ｫ縺ｯ菫晏ｭ倥′蠢・ｦ・/span>
                 <button class="js-save-settings-btn header-save-button" title="險ｭ螳壹ｒ菫晏ｭ・>險ｭ螳壹ｒ菫晏ｭ・/button>
            </header>
            <main class="main-content">
                <details open class="settings-group" id="settings-group-api-provider">
                    <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">蝓ｺ遉手ｨｭ螳・/summary>
                    <div style="margin-top:10px;">
                        <label for="api-provider-select">菴ｿ逕ｨ縺吶ｋAPI繝励Ο繝舌う繝繝ｼ:</label>
                        <select id="api-provider-select" aria-label="API繝励Ο繝舌う繝繝ｼ驕ｸ謚・>
                            <option value="gemini">Gemini (Google)窶ｻ謗ｨ螂ｨ</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="claude">Claude (Anthropic API)</option>
                            <option value="openai">ChatGPT (OpenAI API)</option>
                            <option value="xai">Grok (xAI API)</option>
                            <option value="llmaggregator">LLM Aggregator</option>
                            <option value="dummy">Dummy AI</option>
                        </select>
                    </div>
                    <details id="settings-group-common-system-prompt" style="margin-top:10px;">
                        <summary style="font-size: 14px; color: var(--text-link); padding-bottom: 5px; margin-bottom: 10px; display: list-item; list-style: revert; cursor:pointer; font-weight: normal;">蜈ｱ騾壹す繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ險ｭ螳・/summary>
                        <div style="padding-top:10px; padding-left:15px;">
                            <label for="common-system-prompt-default">蜈ｱ騾壹す繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ (蜈ｨAPI蜈ｱ騾・:</label>
                            <textarea id="common-system-prompt-default" placeholder="萓・ 縺ゅ↑縺溘・蜆ｪ遘縺ｪ繧｢繧ｷ繧ｹ繧ｿ繝ｳ繝医〒縺吶ゅ％縺薙↓險ｭ螳壹＠縺溷・螳ｹ縺ｯ縲、PI縺斐→縺ｮ險ｭ螳壹ｈ繧雁━蜈医＆繧後∪縺吶・ aria-label="蜈ｱ騾壹す繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ (繝・ヵ繧ｩ繝ｫ繝・"></textarea>
                            <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                                <input type="checkbox" id="enable-common-system-prompt-default" checked>
                                縺薙・蜈ｱ騾壹す繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧呈怏蜉ｹ縺ｫ縺吶ｋ (API蛻･繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧医ｊ蜆ｪ蜈亥ｺｦ菴・
                            </label>
                        </div>
                    </details>
                    <details id="api-provider-cycle-settings-group" style="margin-top: 10px;">
                        <summary style="font-size: 14px; color: var(--text-link); padding-bottom: 5px; margin-bottom: 10px; display: list-item; list-style: revert; cursor:pointer; font-weight: normal;">菴ｿ逕ｨ縺吶ｋAPI繝励Ο繝舌う繝繝ｼ縺ｮ驕ｸ謚・/summary>
                        <div id="api-provider-cycle-settings" style="padding-left: 15px; margin-top: 10px;">
                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">菴ｿ逕ｨ縺吶ｋAPI繝励Ο繝舌う繝繝ｼ縺ｮ蛟呵｣懊♀繧医・API蛻・崛繝懊ち繝ｳ縺ｧ蟾｡蝗槭＆縺帙ｋAPI繝励Ο繝舌う繝繝ｼ繧帝∈謚・</p>
                            <label class="checkbox-label" style="font-size: 12px;">
                                <input type="checkbox" id="api-provider-cycle-gemini">
                                Gemini (Google)窶ｻ謗ｨ螂ｨ
                            </label>
                            <label class="checkbox-label" style="font-size: 12px;">
                                <input type="checkbox" id="api-provider-cycle-deepseek">
                                DeepSeek
                            </label>
                            <label class="checkbox-label" style="font-size: 12px;">
                                <input type="checkbox" id="api-provider-cycle-claude">
                                Claude (Anthropic API)
                            </label>
                            <label class="checkbox-label" style="font-size: 12px;">
                                <input type="checkbox" id="api-provider-cycle-openai">
                                OpenAI
                            </label>
                            <label class="checkbox-label" style="font-size: 12px;">
                                <input type="checkbox" id="api-provider-cycle-xai">
                                Grok (xAI API)
                            </label>
                            <label class="checkbox-label" style="font-size: 12px;">
                                <input type="checkbox" id="api-provider-cycle-llmaggregator">
                                LLM Aggregator
                            </label>
                            <label class="checkbox-label" style="font-size: 12px;">
                                <input type="checkbox" id="api-provider-cycle-dummy">
                                Dummy AI
                            </label>
                        </div>
                    </details>
                </details>

                <details id="gemini-settings-group" class="settings-group" open>
                    <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">Gemini API 險ｭ螳・/summary>
                    <div style="margin-top:15px;">
                        <label for="gemini-api-key">Gemini API繧ｭ繝ｼ:</label>
                        <input type="password" id="gemini-api-key" placeholder="API繧ｭ繝ｼ繧貞・蜉・ aria-label="Gemini API繧ｭ繝ｼ">
                        <details id="gemini-multi-api-keys-section" style="margin-top: 10px;">
                            <summary style="font-size: 14px; color: var(--text-link); padding-bottom: 5px; margin-bottom: 10px; display: list-item; list-style: revert; cursor: pointer; font-weight: normal;">隍・焚API繧ｭ繝ｼ邂｡逅・(Gemini)</summary>
                            <div style="padding-left: 15px; margin-top: 10px;">
                                <div id="gemini-api-keys-list" class="api-keys-list"></div>
                                <button type="button" id="add-gemini-api-key-btn" class="add-api-key-btn">譁ｰ縺励＞API繧ｭ繝ｼ繧定ｿｽ蜉</button>
                            </div>
                        </details>
                        <label for="gemini-model-name">繝｢繝・Ν蜷・</label>
                        <select id="gemini-model-name" aria-label="繝｢繝・Ν蜷・>
                            <optgroup label="辟｡譁・>
                                <option value="gemini-2.0-flash">gemini-2.0-flash</option>
                                <option value="gemini-2.5-flash-preview-04-17">gemini-2.5-flash-preview-04-17</option>
                                <option value="gemini-2.5-flash-preview-05-20">gemini-2.5-flash-preview-05-20</option>
                                <option value="gemini-2.5-flash-lite-preview-06-17">gemini-2.5-flash-lite-preview-06-17</option>
                                <option value="gemini-2.5-flash">gemini-2.5-flash</option>        
                            </optgroup>
                            <optgroup label="譛画侭">
                                <option value="gemini-2.5-pro-preview-03-25">gemini-2.5-pro-preview-03-25</option>
                                <option value="gemini-2.5-pro-preview-05-06">gemini-2.5-pro-preview-05-06</option>
                                <option value="gemini-2.5-pro-preview-06-05">gemini-2.5-pro-preview-06-05</option>
                                <option value="gemini-2.5-pro">gemini-2.5-pro</option>
                            </optgroup>
                            <optgroup label="繝ｦ繝ｼ繧ｶ繝ｼ謖・ｮ・ id="gemini-user-defined-models-group">
                            </optgroup>
                            <optgroup label="謠蝉ｾ帷ｵゆｺ・・菴ｿ逕ｨ荳榊庄・亥炎髯､蛟呵｣懶ｼ・>
                                <option value="gemini-2.5-pro-exp-03-25">gemini-2.5-pro-exp-03-25</option>
                            </optgroup>
                        </select>
                        <label for="gemini-additional-models" style="margin-top:10px;">霑ｽ蜉繝｢繝・Ν (繧ｫ繝ｳ繝槫玄蛻・ｊ):</label>
                        <textarea id="gemini-additional-models" placeholder="萓・ gemini-2.0-pro,gemini-2.0-flash-lite" aria-label="霑ｽ蜉繝｢繝・Ν"></textarea>
                    </div>
                </details>

                <details id="deepseek-settings-group" class="settings-group hidden" open>
                    <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">DeepSeek API 險ｭ螳・/summary>
                    <div style="margin-top:15px;">
                        <label for="deepseek-api-key">DeepSeek API繧ｭ繝ｼ:</label>
                        <input type="password" id="deepseek-api-key" placeholder="DeepSeek API繧ｭ繝ｼ繧貞・蜉・ aria-label="DeepSeek API繧ｭ繝ｼ">
                        <details id="deepseek-multi-api-keys-section" style="margin-top: 10px;">
                            <summary style="font-size: 14px; color: var(--text-link); padding-bottom: 5px; margin-bottom: 10px; display: list-item; list-style: revert; cursor: pointer; font-weight: normal;">隍・焚API繧ｭ繝ｼ邂｡逅・(DeepSeek)</summary>
                            <div style="padding-left: 15px; margin-top: 10px;">
                                <div id="deepseek-api-keys-list" class="api-keys-list"></div>
                                <button type="button" id="add-deepseek-api-key-btn" class="add-api-key-btn">譁ｰ縺励＞API繧ｭ繝ｼ繧定ｿｽ蜉</button>
                            </div>
                        </details>
                        <label for="deepseek-model-name">DeepSeek 繝｢繝・Ν蜷・</label>
                        <select id="deepseek-model-name" aria-label="DeepSeek 繝｢繝・Ν蜷・>
                            <optgroup label="蝓ｺ譛ｬ繝｢繝・Ν (DeepSeek)">
                                <option value="deepseek-chat">deepseek-chat</option>
                                <option value="deepseek-coder">deepseek-coder</option>
                                <option value="deepseek-reasoner">deepseek-reasoner</option>
                            </optgroup>
                             <optgroup label="繝ｦ繝ｼ繧ｶ繝ｼ謖・ｮ・(DeepSeek)" id="deepseek-user-defined-models-group">
                            </optgroup>
                        </select>
                        <label for="deepseek-additional-models" style="margin-top:10px;">DeepSeek 霑ｽ蜉繝｢繝・Ν (繧ｫ繝ｳ繝槫玄蛻・ｊ):</label>
                        <textarea id="deepseek-additional-models" placeholder="萓・ custom-model-1,custom-model-2" aria-label="DeepSeek 霑ｽ蜉繝｢繝・Ν"></textarea>
                        <label for="deepseek-api-endpoint" style="margin-top:10px;">DeepSeek API繧ｨ繝ｳ繝峨・繧､繝ｳ繝・(繧ｪ繝励す繝ｧ繝ｳ):</label>
                        <input type="text" id="deepseek-api-endpoint" placeholder="萓・ https://api.deepseek.com" aria-label="DeepSeek API繧ｨ繝ｳ繝峨・繧､繝ｳ繝・>
                         <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                           窶ｻ 遨ｺ谺・・蝣ｴ蜷医・繝・ヵ繧ｩ繝ｫ繝・(https://api.deepseek.com) 繧剃ｽｿ逕ｨ縺励√ヱ繧ｹ縺ｯ `/chat/completions` 縺ｧ縺吶・蠖｢蠑冗噪縺ｪ螳溯｣・〒縺ゅｊ縲√ョ繝舌ャ繧ｰ縺輔ｌ縺ｦ縺翫ｊ縺ｾ縺帙ｓ縲・                         </p>
                    </div>
                </details>

                <details id="claude-settings-group" class="settings-group hidden" open>
                    <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">Claude API 險ｭ螳・/summary>
                    <div style="margin-top:15px;">
                        <label for="claude-api-key">Claude API繧ｭ繝ｼ:</label>
                        <input type="password" id="claude-api-key" placeholder="API繧ｭ繝ｼ繧貞・蜉・ aria-label="Claude API繧ｭ繝ｼ">
                        <details id="claude-multi-api-keys-section" style="margin-top: 10px;">
                            <summary style="font-size: 14px; color: var(--text-link); padding-bottom: 5px; margin-bottom: 10px; display: list-item; list-style: revert; cursor: pointer; font-weight: normal;">隍・焚API繧ｭ繝ｼ邂｡逅・(Claude)</summary>
                            <div style="padding-left: 15px; margin-top: 10px;">
                                <div id="claude-api-keys-list" class="api-keys-list"></div>
                                <button type="button" id="add-claude-api-key-btn" class="add-api-key-btn">譁ｰ縺励＞API繧ｭ繝ｼ繧定ｿｽ蜉</button>
                            </div>
                        </details>
                        <label for="claude-model-name">繝｢繝・Ν蜷・</label>
                        <select id="claude-model-name" aria-label="Claude繝｢繝・Ν蜷・>
                            <optgroup label="Claude 4">
                                <option value="claude-opus-4-20250514">Claude 4 Opus</option>
                                <option value="claude-sonnet-4-20250514">Claude 4 Sonnet</option>
                            </optgroup>
                            <optgroup label="Claude 3.7 & 3.5">
                                <option value="claude-3-7-sonnet-20250219">Claude 3.7 Sonnet</option>
                                <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet v2</option>
                                <option value="claude-3-5-sonnet-20240620">Claude 3.5 Sonnet v1</option>
                                <option value="claude-3-5-haiku-20241022">Claude 3.5 Haiku</option>
                            </optgroup>
                            <optgroup label="Claude 3">
                                <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                                <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                                <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                            </optgroup>
                            <optgroup label="譌ｧ繝｢繝・Ν (v2莉･蜑・">
                                <option value="claude-2.1">Claude 2.1</option>
                                <option value="claude-2.0">Claude 2.0</option>
                            </optgroup>
                            <optgroup label="繧ｨ繧､繝ｪ繧｢繧ｹ (譛譁ｰ迚医ｒ謖・☆)">
                                <option value="claude-opus-4-0">claude-opus-4-0</option>
                                <option value="claude-sonnet-4-0">claude-sonnet-4-0</option>
                                <option value="claude-3-7-sonnet-latest">claude-3-7-sonnet-latest</option>
                                <option value="claude-3-5-sonnet-latest">claude-3-5-sonnet-latest</option>
                                <option value="claude-3-opus-latest">claude-3-opus-latest</option>
                            </optgroup>
                            <optgroup label="繝ｦ繝ｼ繧ｶ繝ｼ謖・ｮ・ id="claude-user-defined-models-group">
                            </optgroup>
                        </select>
                        <label for="claude-additional-models" style="margin-top:10px;">霑ｽ蜉繝｢繝・Ν (繧ｫ繝ｳ繝槫玄蛻・ｊ):</label>
                        <textarea id="claude-additional-models" placeholder="萓・ my-custom-claude-model" aria-label="Claude 霑ｽ蜉繝｢繝・Ν"></textarea>
                    </div>
                </details>

                <details id="openai-settings-group" class="settings-group hidden" open>
                    <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">ChatGPT API 險ｭ螳・/summary>
                    <div style="margin-top:15px;">
                        <label for="openai-api-key">ChatGPT API繧ｭ繝ｼ:</label>
                        <input type="password" id="openai-api-key" placeholder="sk-..." aria-label="ChatGPT API繧ｭ繝ｼ">
                        <details id="openai-multi-api-keys-section" class="hidden" style="margin-top: 10px;">
                            <summary style="font-size: 14px; color: var(--text-link); padding-bottom: 5px; margin-bottom: 10px; display: list-item; list-style: revert; cursor: pointer; font-weight: normal;">隍・焚API繧ｭ繝ｼ邂｡逅・(OpenAI)</summary>
                            <div style="padding-left: 15px; margin-top: 10px;">
                                <div id="openai-api-keys-list" class="api-keys-list"></div>
                                <button type="button" id="add-openai-api-key-btn" class="add-api-key-btn">譁ｰ縺励＞API繧ｭ繝ｼ繧定ｿｽ蜉</button>
                            </div>
                        </details>
                        <label for="openai-model-name">繝｢繝・Ν蜷・</label>
                        <select id="openai-model-name" aria-label="OpenAI 繝｢繝・Ν蜷・>
                            <optgroup label="GPT-4.1">
                                <option value="gpt-4.1">gpt-4.1</option>
                                <option value="gpt-4.1-mini">gpt-4.1-mini</option>
                            <optgroup label="GPT-4o & Mini">
                                <option value="gpt-4o">gpt-4o (2024-05-13)</option>
                                <option value="gpt-4o-2024-08-06">gpt-4o-2024-08-06</option>
                                <option value="gpt-4o-mini">gpt-4o-mini</option>
                                <option value="gpt-4o-mini-2024-07-18">gpt-4o-mini-2024-07-18</option>
                            </optgroup>
                            <optgroup label="o1">
                                <option value="o1">o1</option>
                                <option value="o1-2024-12-17">o1-2024-12-17</option>
                                <option value="o1-mini">o1-mini</option>
                                <option value="o1-mini-2024-09-12">o1-mini-2024-09-12</option>
                                <option value="o3-mini-2025-01-31">o3-mini-2025-01-31</option>
                            </optgroup>
                            <optgroup label="GPT-4 Turbo">
                                <option value="gpt-4-turbo">gpt-4-turbo (2024-04-09)</option>
                                <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                            </optgroup>
                            <optgroup label="Preview & 繧ｨ繧､繝ｪ繧｢繧ｹ (譛譁ｰ迚医ｒ謖・☆)">
                                <option value="gpt-4.5-preview">gpt-4.5-preview</option>
                                <option value="chatgpt-4o-latest">chatgpt-4o-latest</option>
                                <option value="o1-preview">o1-preview</option>
                            </optgroup>
                        </select>
                        <label for="openai-additional-models" style="margin-top:10px;">霑ｽ蜉繝｢繝・Ν (繧ｫ繝ｳ繝槫玄蛻・ｊ):</label>
                        <textarea id="openai-additional-models" placeholder="萓・ gpt-4,my-finetuned-model" aria-label="OpenAI 霑ｽ蜉繝｢繝・Ν"></textarea>
                    </div>
                </details>

                <details id="xai-settings-group" class="settings-group hidden" open>
                    <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">Grok (xAI API) 險ｭ螳・/summary>
                    <div style="margin-top:15px;">
                        <label for="xai-api-key">xAI API繧ｭ繝ｼ:</label>
                        <input type="password" id="xai-api-key" placeholder="xai-..." aria-label="xAI API繧ｭ繝ｼ">
                        <details id="xai-multi-api-keys-section" class="hidden" style="margin-top: 10px;">
                            <summary style="font-size: 14px; color: var(--text-link); padding-bottom: 5px; margin-bottom: 10px; display: list-item; list-style: revert; cursor: pointer; font-weight: normal;">隍・焚API繧ｭ繝ｼ邂｡逅・(xAI)</summary>
                            <div style="padding-left: 15px; margin-top: 10px;">
                                <div id="xai-api-keys-list" class="api-keys-list"></div>
                                <button type="button" id="add-xai-api-key-btn" class="add-api-key-btn">譁ｰ縺励＞API繧ｭ繝ｼ繧定ｿｽ蜉</button>
                            </div>
                        </details>
                        <label for="xai-model-name">繝｢繝・Ν蜷・</label>
                        <select id="xai-model-name" aria-label="xAI 繝｢繝・Ν蜷・>
                            <optgroup label="Grok">
                                <option value="grok-3-mini">grok-3-mini</option>
                                <option value="grok-3-mini-fast">grok-3-mini-fast</option>
                                <option value="grok-3">grok-3</option>
                                <option value="grok-3-fast">grok-3-fast</option>
                                <option value="grok-2-vision-1212">grok-2-vision-1212</option>
                                <option value="grok-2-1212">grok-2-1212</option>
                            </optgroup>
                            <optgroup label="繝ｦ繝ｼ繧ｶ繝ｼ謖・ｮ・ id="xai-user-defined-models-group">
                            </optgroup>
                        </select>
                        <label for="xai-additional-models" style="margin-top:10px;">霑ｽ蜉繝｢繝・Ν (繧ｫ繝ｳ繝槫玄蛻・ｊ):</label>
                        <textarea id="xai-additional-models" placeholder="萓・ custom-grok-model" aria-label="xAI 霑ｽ蜉繝｢繝・Ν"></textarea>
                    </div>
                </details>

                <details id="llmaggregator-settings-group" class="settings-group hidden" open>
                    <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">LLM Aggregator 險ｭ螳・/summary>
                    <div style="margin-top:15px;">
                        <label for="llmaggregator-api-backend">API 繝舌ャ繧ｯ繧ｨ繝ｳ繝・URL:</label>
                        <input type="text" id="llmaggregator-api-backend" placeholder="萓・ https://api.openrouter.ai/v1" aria-label="LLM Aggregator API 繝舌ャ繧ｯ繧ｨ繝ｳ繝・URL">
                        <div id="llmaggregator-url-error" style="color: red; font-size: 11px; margin-top: -5px; height: 14px;"></div>
                        <label for="llmaggregator-api-key">API繧ｭ繝ｼ:</label>
                        <input type="password" id="llmaggregator-api-key" placeholder="API繧ｭ繝ｼ繧貞・蜉・ aria-label="LLM Aggregator API繧ｭ繝ｼ">
                        <details id="llmaggregator-multi-api-keys-section" class="hidden" style="margin-top: 10px;">
                            <summary style="font-size: 14px; color: var(--text-link); padding-bottom: 5px; margin-bottom: 10px; display: list-item; list-style: revert; cursor: pointer; font-weight: normal;">隍・焚API繧ｭ繝ｼ邂｡逅・(LLM Aggregator)</summary>
                            <div style="padding-left: 15px; margin-top: 10px;">
                                <div id="llmaggregator-api-keys-list" class="api-keys-list"></div>
                                <button type="button" id="add-llmaggregator-api-key-btn" class="add-api-key-btn">譁ｰ縺励＞API繧ｭ繝ｼ繧定ｿｽ蜉</button>
                            </div>
                        </details>
                        <label for="llmaggregator-model-name">繝｢繝・Ν蜷・</label>
                        <select id="llmaggregator-model-name" aria-label="LLM Aggregator 繝｢繝・Ν蜷・>
                            <optgroup label="繝・ヵ繧ｩ繝ｫ繝・>
                                <option value="meta-llama/llama-4-maverick-17b-128e-instruct:free">meta-llama/llama-4-maverick-17b-128e-instruct:free</option>
                                <option value="qwen/qwen2.5-vl-32b-instruct:free">qwen/qwen2.5-vl-32b-instruct:free</option>
                                <option value="deepseek/deepseek-chat-v3-0324:free">deepseek/deepseek-chat-v3-0324:free</option>
                            </optgroup>
                            <optgroup label="繝ｦ繝ｼ繧ｶ繝ｼ謖・ｮ・ id="llmaggregator-user-defined-models-group">
                            </optgroup>
                        </select>
                        <label for="llmaggregator-additional-models" style="margin-top:10px;">霑ｽ蜉繝｢繝・Ν (繧ｫ繝ｳ繝槫玄蛻・ｊ):</label>
                        <textarea id="llmaggregator-additional-models" placeholder="萓・ mistralai/Mixtral-8x7B-Instruct-v0.1,another/model" aria-label="LLM Aggregator 霑ｽ蜉繝｢繝・Ν"></textarea>
                        </p>
                    </div>
                </details>
                
                <details id="dummy-settings-group" class="settings-group hidden" open>
                    <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">Dummy AI 險ｭ螳・/summary>
                    <div style="margin-top:15px;">
                        <p style="font-size: 12px; color: var(--text-secondary);">縺薙・繝励Ο繝舌う繝繝ｼ縺ｯ繧ｻ繝・す繝ｧ繝ｳ邱ｨ謌千畑縺ｮ繝繝溘・縺ｧ縺吶・/p>
                        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">API繧ｭ繝ｼ縺ｯ荳崎ｦ√〒縲√ヰ繝・け繧ｨ繝ｳ繝峨∈縺ｮ謗･邯壹ｂ陦後＞縺ｾ縺帙ｓ縲ゅΘ繝ｼ繧ｶ繝ｼ縺後Γ繝・そ繝ｼ繧ｸ繧帝∽ｿ｡縺吶ｋ縺ｨ縲∝ｸｸ縺ｫ遨ｺ縺ｮ蠢懃ｭ斐ｒ霑斐＠縺ｾ縺吶・/p>
                        <label class="checkbox-label" style="margin-top: 15px;">
                            <input type="checkbox" id="dummy-error-debug-mode">
                            繧ｨ繝ｩ繝ｼ繝ｭ繧ｰ繧貞ｿ懃ｭ斐☆繧・(繝・ヰ繝・げ繝｢繝ｼ繝・
                        </label>
                        <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                            窶ｻ 繝√ぉ繝・け譎ゅ√％繧後∪縺ｧ縺ｫ逋ｺ逕溘＠縺櫟avaScript繧ｨ繝ｩ繝ｼ縺ｮ繝ｭ繧ｰ繧貞ｿ懃ｭ斐＠縺ｾ縺吶・                        </p>
                        <hr style="margin: 15px 0;">
                        <label for="dummy-dummy-model">繝繝溘・ Model 繝励Ο繝ｳ繝励ヨ:</label>
                        <textarea id="dummy-dummy-model" placeholder="縺薙・蜀・ｮｹ縺ｯ縲．ummy AI縺ｮ蠢懃ｭ斐・蜈磯ｭ縺ｫ莉倅ｸ弱＆繧後∪縺吶・ aria-label="Dummy AI 繝繝溘・ Model 繝励Ο繝ｳ繝励ヨ"></textarea>
                        <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                            <input type="checkbox" id="dummy-enable-dummy-model">
                            縺薙・繝繝溘・Model繝励Ο繝ｳ繝励ヨ繧呈怏蜉ｹ縺ｫ縺吶ｋ
                        </label>
                    </div>
                </details>

                <details id="gemini-params-group" class="settings-group" open>
                    <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">繝代Λ繝｡繝ｼ繧ｿ (Gemini)</summary>
                    <div style="margin-top:15px;">
                        <label for="gemini-system-prompt-default">蝗ｺ譛峨す繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ (Gemini):</label>
                        <textarea id="gemini-system-prompt-default" placeholder="萓・ 縺ゅ↑縺溘・隕ｪ蛻・↑繧｢繧ｷ繧ｹ繧ｿ繝ｳ繝医〒縺吶よ眠隕上メ繝｣繝・ヨ菴懈・譎ゅ↓驕ｩ逕ｨ縺輔ｌ縺ｾ縺吶・ aria-label="Gemini 蝗ｺ譛峨す繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ"></textarea>
                        <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                            <input type="checkbox" id="gemini-enable-system-prompt-default">
                            縺薙・繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧呈怏蜉ｹ縺ｫ縺吶ｋ (蜈ｱ騾壹す繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧医ｊ蜆ｪ蜈亥ｺｦ鬮・
                        </label>

                        <div class="param-grid">
                            <div>
                                <label for="gemini-max-tokens">Max Tokens:</label>
                                <input type="number" id="gemini-max-tokens" step="1" min="1" placeholder="萓・1024" aria-label="Gemini Max Tokens">
                            </div>
                            <div>
                                <label for="gemini-temperature">Temperature:</label>
                                <input type="number" id="gemini-temperature" step="0.1" min="0" max="2" placeholder="萓・0.9(0.0-2.0)" aria-label="Gemini Temperature">
                            </div>
                            <div>
                                <label for="gemini-top-k">Top K:</label>
                                <input type="number" id="gemini-top-k" step="1" min="1" placeholder="萓・40(1-40)" aria-label="Gemini Top K">
                            </div>
                            <div>
                                <label for="gemini-top-p">Top P:</label>
                                <input type="number" id="gemini-top-p" step="0.01" min="0" max="1" placeholder="萓・0.95(0.0 - 1.0)" aria-label="Gemini Top P">
                            </div>
                        </div>

                        <details id="settings-group-gemini-other-params">
                            <summary style="cursor: pointer; font-weight: normal; font-size: 14px; color: var(--text-link); margin-bottom: 10px; list-style: revert;">縺昴・莉悶ヱ繝ｩ繝｡繝ｼ繧ｿ (Gemini)</summary>
                            <div class="param-grid">
                                 <div>
                                    <label for="gemini-presence-penalty">Presence Penalty:</label>
                                    <input type="number" id="gemini-presence-penalty" step="0.1" min="-2.0" max="1.9" placeholder="萓・0.0 (-2.0・・.0譛ｪ貅)" aria-label="Gemini Presence Penalty">
                                 </div>
                                 <div>
                                    <label for="gemini-frequency-penalty">Frequency Penalty:</label>
                                    <input type="number" id="gemini-frequency-penalty" step="0.1" min="-2.0" max="1.9" placeholder="萓・0.0 (-2.0・・.0譛ｪ貅)" aria-label="Gemini Frequency Penalty">
                                </div>
                            </div>
                            <p style="font-size: 11px; color: var(--text-secondary); margin-top: 8px;">
                                窶ｻ Presence/Frequency Penalty縺ｯ荳驛ｨ繝｢繝・Ν縺ｧ縺ｯ髱槫ｯｾ蠢懊、PI繧ｨ繝ｩ繝ｼ縺ｨ縺ｪ繧句ｴ蜷医≠繧・                            </p>
                            <p style="height:16px;"></p>
                            <div class="param-grid">
                                <div>
                                    <label for="gemini-thinking-budget">Thinking Budget:</label>
                                    <input type="number" id="gemini-thinking-budget" step="1" min="0" placeholder="萓・ 5000 (0・・4576・・2768謨ｴ謨ｰ)" aria-label="Gemini Thinking Budget">
                                    <div style="display: flex; gap: 8px; margin-top: 5px; margin-bottom: 10px;">
                                        <button type="button" class="set-thinking-budget-btn" data-value="null" style="padding: 4px 8px; font-size: 12px; background-color: var(--bg-button-action); color: var(--text-light); border-radius:3px; flex-grow:1;">辟｡</button>
                                        <button type="button" class="set-thinking-budget-btn" data-value="0" style="padding: 4px 8px; font-size: 12px; background-color: var(--bg-button-action); color: var(--text-light); border-radius:3px; flex-grow:1;">0</button>
                                        <button type="button" class="set-thinking-budget-btn" data-value="24576" style="padding: 4px 8px; font-size: 12px; background-color: var(--bg-button-action); color: var(--text-light); border-radius:3px; flex-grow:1;">24576</button>
                                        <button type="button" class="set-thinking-budget-btn" data-value="32768" style="padding: 4px 8px; font-size: 12px; background-color: var(--bg-button-action); color: var(--text-light); border-radius:3px; flex-grow:1;">32768</button>
                                    </div>
                                </div>
                            </div>
                            <p style="font-size: 11px; color: var(--text-secondary); margin-top: 8px;">
                                窶ｻ Thinking Budget縺ｯ譁ｰ縺励＞Gemini繝｢繝・Ν縺ｮ縺ｿ蟇ｾ蠢懊・譏守､ｺ縺ｧthinking繧丹FF縲・br>
                                窶ｻ 1・・024謖・ｮ壽凾縺ｯ蝗ｺ螳壹〒1024縺ｫ縺ｪ繧・                            </p>
                            <div id="gemini-thoughts-param">
                               <label class="checkbox-label" style="margin-top: 15px;">
                                   <input type="checkbox" id="gemini-include-thoughts-toggle">
                                   Include Thoughts
                               </label>
                               <label class="checkbox-label" style="margin-top: -5px;">
                                   <input type="checkbox" id="gemini-expand-thoughts-by-default-toggle">
                                   眺諤晁・・繝ｭ繧ｻ繧ｹ繧帝幕縺・◆迥ｶ諷九↓縺吶ｋ
                               </label>
                               <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                                   窶ｻ 繝√ぉ繝・け譎ゅ√Δ繝・Ν縺ｮ諤晁・・繝ｭ繧ｻ繧ｹ縺ｮ隕∫ｴ・′霑斐ｋ縲・br>
                                   窶ｻ thinkingConfig縺梧怏蜉ｹ縺ｪGemini繝｢繝・Ν縺ｧ縺ｮ縺ｿ讖溯・縲・                               </p>
                           </div>
                        </details>
                    </div>
                </details>

                <details id="deepseek-params-group" class="settings-group hidden" open>
                    <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">繝代Λ繝｡繝ｼ繧ｿ (DeepSeek)</summary>
                    <div style="margin-top:15px;">
                        <label for="deepseek-system-prompt-default">蝗ｺ譛峨す繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ (DeepSeek):</label>
                        <textarea id="deepseek-system-prompt-default" placeholder="萓・ 縺ゅ↑縺溘・隕ｪ蛻・↑DeepSeek繧｢繧ｷ繧ｹ繧ｿ繝ｳ繝医〒縺吶・ aria-label="DeepSeek 蝗ｺ譛峨す繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ"></textarea>
                        <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                            <input type="checkbox" id="deepseek-enable-system-prompt-default">
                            縺薙・繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧呈怏蜉ｹ縺ｫ縺吶ｋ (蜈ｱ騾壹す繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧医ｊ蜆ｪ蜈亥ｺｦ鬮・
                        </label>

                        <div class="param-grid">
                            <div>
                                <label for="deepseek-max-tokens">Max Tokens:</label>
                                <input type="number" id="deepseek-max-tokens" step="1" min="1" placeholder="萓・1024" aria-label="DeepSeek Max Tokens">
                            </div>
                            <div>
                                <label for="deepseek-temperature">Temperature:</label>
                                <input type="number" id="deepseek-temperature" step="0.1" min="0" max="2" placeholder="萓・0.9(0.0-2.0)" aria-label="DeepSeek Temperature">
                            </div>
                            <div>
                                <label for="deepseek-top-p">Top P:</label>
                                <input type="number" id="deepseek-top-p" step="0.01" min="0" max="1" placeholder="萓・0.95(0.0 - 1.0)" aria-label="DeepSeek Top P">
                            </div>
                        </div>
                         <details id="settings-group-deepseek-other-params">
                            <summary style="cursor: pointer; font-weight: normal; font-size: 14px; color: var(--text-link); margin-bottom: 10px; list-style: revert;">縺昴・莉悶ヱ繝ｩ繝｡繝ｼ繧ｿ (DeepSeek)</summary>
                            <div class="param-grid">
                                 <div>
                                    <label for="deepseek-presence-penalty">Presence Penalty:</label>
                                    <input type="number" id="deepseek-presence-penalty" step="0.1" min="-2.0" max="2.0" placeholder="萓・0.0 (-2.0・・.0)" aria-label="DeepSeek Presence Penalty">
                                 </div>
                                 <div>
                                    <label for="deepseek-frequency-penalty">Frequency Penalty:</label>
                                    <input type="number" id="deepseek-frequency-penalty" step="0.1" min="-2.0" max="2.0" placeholder="萓・0.0 (-2.0・・.0)" aria-label="DeepSeek Frequency Penalty">
                                </div>
                            </div>
                             <div id="deepseek-thoughts-param">
                               <h3 style="margin-top:15px; margin-bottom:10px; font-size:14px; border:0; padding:0;">諤晁・・繝ｭ繧ｻ繧ｹ</h3>
                               <label class="checkbox-label">
                                   <input type="checkbox" id="deepseek-include-thoughts-toggle">
                                   Include Thoughts
                               </label>
                               <label class="checkbox-label">
                                   <input type="checkbox" id="deepseek-expand-thoughts-by-default-toggle">
                                   眺諤晁・・繝ｭ繧ｻ繧ｹ繧帝幕縺・◆迥ｶ諷九↓縺吶ｋ
                               </label>
                               <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                                   窶ｻ deepseek-reasoner 繝｢繝・Ν遲峨〒蛻ｩ逕ｨ蜿ｯ閭ｽ縲・br>
                               </p>
                           </div>
                        </details>
                    </div>
                </details>

                <details id="claude-params-group" class="settings-group hidden" open>
                    <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">繝代Λ繝｡繝ｼ繧ｿ (Claude)</summary>
                    <div style="margin-top:15px;">
                        <label for="claude-system-prompt-default">蝗ｺ譛峨す繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ (Claude):</label>
                        <textarea id="claude-system-prompt-default" placeholder="萓・ 縺ゅ↑縺溘・Claude繧｢繧ｷ繧ｹ繧ｿ繝ｳ繝医〒縺吶・ aria-label="Claude 蝗ｺ譛峨す繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ"></textarea>
                        <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                            <input type="checkbox" id="claude-enable-system-prompt-default">
                            縺薙・繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧呈怏蜉ｹ縺ｫ縺吶ｋ (蜈ｱ騾壹す繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧医ｊ蜆ｪ蜈亥ｺｦ鬮・
                        </label>

                        <div class="param-grid">
                            <div>
                                <label for="claude-max-tokens">Max Tokens:</label>
                                <input type="number" id="claude-max-tokens" step="1" min="1" placeholder="萓・4096" aria-label="Claude Max Tokens">
                                <div style="display: flex; gap: 8px; margin-top: 5px; margin-bottom: 10px;">
                                    <button type="button" class="set-claude-param-btn" data-target="claude-max-tokens" data-value="null" style="padding: 4px 8px; font-size: 12px; background-color: var(--bg-button-action); color: var(--text-light); border-radius:3px;">辟｡</button>
                                    <button type="button" class="set-claude-param-btn" data-target="claude-max-tokens" data-value="32000" style="padding: 4px 8px; font-size: 12px; background-color: var(--bg-button-action); color: var(--text-light); border-radius:3px;">32000</button>
                                </div>
                            </div>
                            <div>
                                <label for="claude-temperature">Temperature:</label>
                                <input type="number" id="claude-temperature" step="0.01" min="0" max="1" placeholder="萓・0.7 (0.0-1.0)" aria-label="Claude Temperature">
                                <div style="display: flex; gap: 8px; margin-top: 5px; margin-bottom: 10px;">
                                    <button type="button" class="set-claude-param-btn" data-target="claude-temperature" data-value="null" style="padding: 4px 8px; font-size: 12px; background-color: var(--bg-button-action); color: var(--text-light); border-radius:3px;">辟｡</button>
                                    <button type="button" class="set-claude-param-btn" data-target="claude-temperature" data-value="0" style="padding: 4px 8px; font-size: 12px; background-color: var(--bg-button-action); color: var(--text-light); border-radius:3px;">0</button>
                                    <button type="button" class="set-claude-param-btn" data-target="claude-temperature" data-value="1.0" style="padding: 4px 8px; font-size: 12px; background-color: var(--bg-button-action); color: var(--text-light); border-radius:3px;">1.0</button>
                                </div>
                            </div>
                            <div>
                                <label for="claude-top-k">Top K:</label>
                                <input type="number" id="claude-top-k" step="1" min="1" placeholder="萓・5" aria-label="Claude Top K">
                            </div>
                            <div>
                                <label for="claude-top-p">Top P:</label>
                                <input type="number" id="claude-top-p" step="0.01" min="0" max="1" placeholder="萓・1.0 (0.0 - 1.0)" aria-label="Claude Top P">
                            </div>
                        </div>

                        <div id="claude-thoughts-param" style="margin-top: 15px;">
                           <h3 style="margin-top:15px; margin-bottom:10px; font-size:14px; border:0; padding:0;">諤晁・・繝ｭ繧ｻ繧ｹ (Extended Thinking)</h3>
                           <label class="checkbox-label">
                               <input type="checkbox" id="claude-include-thoughts-toggle">
                               Include Thoughts
                           </label>
                           <label class="checkbox-label">
                               <input type="checkbox" id="claude-expand-thoughts-by-default-toggle">
                               眺諤晁・・繝ｭ繧ｻ繧ｹ繧帝幕縺・◆迥ｶ諷九↓縺吶ｋ
                           </label>
                           <label for="claude-thinking-budget">Thinking Budget (繝医・繧ｯ繝ｳ謨ｰ):</label>
                           <input type="number" id="claude-thinking-budget" step="1" min="1024" placeholder="萓・ 2000 (1024莉･荳・">
                           <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                               窶ｻ 荳驛ｨ縺ｮ繝｢繝・Ν縺ｧ縺ｮ縺ｿ蛻ｩ逕ｨ蜿ｯ閭ｽ縲ゅメ繧ｧ繝・け譎ゅ√Δ繝・Ν縺ｯ蜀・Κ諤晁・ｒ逕滓・縺励∪縺吶ゅム繝溘・Model繝励Ο繝ｳ繝励ヨ縺ｨ縺ｯ菴ｵ逕ｨ荳榊庄縲よ晁・・signature繧定ｦ∵ｱゅ＆繧後∵晁・・繝ｭ繧ｻ繧ｹ繧貞⊃陬・☆繧九％縺ｨ縺御ｸ榊庄閭ｽ縺ｪ縺溘ａ縲・                           </p>
                        </div>

                    </div>
                </details>
                
                <details id="openai-params-group" class="settings-group hidden" open>
                    <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">繝代Λ繝｡繝ｼ繧ｿ (ChatGPT)</summary>
                    <div style="margin-top:15px;">
                        <label for="openai-system-prompt-default">蝗ｺ譛峨す繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ (ChatGPT):</label>
                        <textarea id="openai-system-prompt-default" placeholder="萓・ You are a helpful assistant." aria-label="OpenAI 蝗ｺ譛峨す繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ"></textarea>
                        <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                            <input type="checkbox" id="openai-enable-system-prompt-default">
                            縺薙・繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧呈怏蜉ｹ縺ｫ縺吶ｋ (蜈ｱ騾壹す繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧医ｊ蜆ｪ蜈亥ｺｦ鬮・
                        </label>
                        <div class="param-grid">
                            <div>
                                <label for="openai-max-tokens">Max Tokens:</label>
                                <input type="number" id="openai-max-tokens" step="1" min="1" placeholder="萓・4096" aria-label="OpenAI Max Tokens">
                            </div>
                            <div>
                                <label for="openai-temperature">Temperature:</label>
                                <input type="number" id="openai-temperature" step="0.1" min="0" max="2" placeholder="萓・1.0(0.0-2.0)" aria-label="OpenAI Temperature">
                            </div>
                            <div>
                                <label for="openai-top-p">Top P:</label>
                                <input type="number" id="openai-top-p" step="0.01" min="0" max="1" placeholder="萓・1.0(0.0 - 1.0)" aria-label="OpenAI Top P">
                            </div>
                        </div>
                        <details id="settings-group-openai-other-params">
                            <summary style="cursor: pointer; font-weight: normal; font-size: 14px; color: var(--text-link); margin-bottom: 10px; list-style: revert;">縺昴・莉悶ヱ繝ｩ繝｡繝ｼ繧ｿ (ChatGPT)</summary>
                            <div class="param-grid">
                                <div>
                                    <label for="openai-presence-penalty">Presence Penalty:</label>
                                    <input type="number" id="openai-presence-penalty" step="0.1" min="-2.0" max="2.0" placeholder="萓・0.0 (-2.0・・.0)" aria-label="OpenAI Presence Penalty">
                                </div>
                                <div>
                                    <label for="openai-frequency-penalty">Frequency Penalty:</label>
                                    <input type="number" id="openai-frequency-penalty" step="0.1" min="-2.0" max="2.0" placeholder="萓・0.0 (-2.0・・.0)" aria-label="OpenAI Frequency Penalty">
                                </div>
                            </div>
                        </details>
                    </div>
                </details>

                <details id="xai-params-group" class="settings-group hidden" open>
                    <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">繝代Λ繝｡繝ｼ繧ｿ (xAI)</summary>
                    <div style="margin-top:15px;">
                        <label for="xai-system-prompt-default">蝗ｺ譛峨す繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ (xAI):</label>
                        <textarea id="xai-system-prompt-default" placeholder="萓・ 縺ゅ↑縺溘・隕ｪ蛻・↑Grok繧｢繧ｷ繧ｹ繧ｿ繝ｳ繝医〒縺吶・ aria-label="xAI 蝗ｺ譛峨す繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ"></textarea>
                        <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                            <input type="checkbox" id="xai-enable-system-prompt-default">
                            縺薙・繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧呈怏蜉ｹ縺ｫ縺吶ｋ (蜈ｱ騾壹す繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧医ｊ蜆ｪ蜈亥ｺｦ鬮・
                        </label>
                        <div class="param-grid">
                            <div>
                                <label for="xai-max-tokens">Max Tokens:</label>
                                <input type="number" id="xai-max-tokens" step="1" min="1" placeholder="萓・4096" aria-label="xAI Max Tokens">
                            </div>
                            <div>
                                <label for="xai-temperature">Temperature:</label>
                                <input type="number" id="xai-temperature" step="0.1" min="0" max="2" placeholder="萓・1.0(0.0-2.0)" aria-label="xAI Temperature">
                            </div>
                            <div>
                                <label for="xai-top-p">Top P:</label>
                                <input type="number" id="xai-top-p" step="0.01" min="0" max="1" placeholder="萓・1.0(0.0 - 1.0)" aria-label="xAI Top P">
                            </div>
                        </div>
                        <details id="settings-group-xai-other-params">
                            <summary style="cursor: pointer; font-weight: normal; font-size: 14px; color: var(--text-link); margin-bottom: 10px; list-style: revert;">縺昴・莉悶ヱ繝ｩ繝｡繝ｼ繧ｿ (xAI)</summary>
                            <div class="param-grid">
                                <div>
                                    <label for="xai-presence-penalty">Presence Penalty:</label>
                                    <input type="number" id="xai-presence-penalty" step="0.1" min="-2.0" max="2.0" placeholder="萓・0.0 (-2.0・・.0)" aria-label="xAI Presence Penalty">
                                </div>
                                <div>
                                    <label for="xai-frequency-penalty">Frequency Penalty:</label>
                                    <input type="number" id="xai-frequency-penalty" step="0.1" min="-2.0" max="2.0" placeholder="萓・0.0 (-2.0・・.0)" aria-label="xAI Frequency Penalty">
                                </div>
                            </div>
                        </details>
                    </div>
                </details>

                <details id="llmaggregator-params-group" class="settings-group hidden" open>
                    <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">繝代Λ繝｡繝ｼ繧ｿ (LLM Aggregator)</summary>
                    <div style="margin-top:15px;">
                        <label for="llmaggregator-system-prompt-default">蝗ｺ譛峨す繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ (LLM Aggregator):</label>
                        <textarea id="llmaggregator-system-prompt-default" placeholder="萓・ You are a helpful assistant." aria-label="LLM Aggregator 蝗ｺ譛峨す繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ"></textarea>
                        <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                            <input type="checkbox" id="llmaggregator-enable-system-prompt-default">
                            縺薙・繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧呈怏蜉ｹ縺ｫ縺吶ｋ (蜈ｱ騾壹す繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧医ｊ蜆ｪ蜈亥ｺｦ鬮・
                        </label>
                        <div class="param-grid">
                            <div>
                                <label for="llmaggregator-max-tokens">Max Tokens:</label>
                                <input type="number" id="llmaggregator-max-tokens" step="1" min="1" placeholder="萓・4096" aria-label="LLM Aggregator Max Tokens">
                            </div>
                            <div>
                                <label for="llmaggregator-temperature">Temperature:</label>
                                <input type="number" id="llmaggregator-temperature" step="0.1" min="0" max="2" placeholder="萓・1.0(0.0-2.0)" aria-label="LLM Aggregator Temperature">
                            </div>
                            <div>
                                <label for="llmaggregator-top-p">Top P:</label>
                                <input type="number" id="llmaggregator-top-p" step="0.01" min="0" max="1" placeholder="萓・1.0(0.0 - 1.0)" aria-label="LLM Aggregator Top P">
                            </div>
                            <div>
                                <label for="llmaggregator-top-k">Top K:</label>
                                <input type="number" id="llmaggregator-top-k" step="1" min="1" placeholder="萓・40" aria-label="LLM Aggregator Top K">
                            </div>
                        </div>
                        <details id="settings-group-llmaggregator-other-params">
                            <summary style="cursor: pointer; font-weight: normal; font-size: 14px; color: var(--text-link); margin-bottom: 10px; list-style: revert;">縺昴・莉悶ヱ繝ｩ繝｡繝ｼ繧ｿ (LLM Aggregator)</summary>
                            <div class="param-grid">
                                <div>
                                    <label for="llmaggregator-presence-penalty">Presence Penalty:</label>
                                    <input type="number" id="llmaggregator-presence-penalty" step="0.1" min="-2.0" max="2.0" placeholder="萓・0.0 (-2.0・・.0)" aria-label="LLM Aggregator Presence Penalty">
                                </div>
                                <div>
                                    <label for="llmaggregator-frequency-penalty">Frequency Penalty:</label>
                                    <input type="number" id="llmaggregator-frequency-penalty" step="0.1" min="-2.0" max="2.0" placeholder="萓・0.0 (-2.0・・.0)" aria-label="LLM Aggregator Frequency Penalty">
                                </div>
                            </div>
                            <div id="llmaggregator-thoughts-param">
                               <h3 style="margin-top:15px; margin-bottom:10px; font-size:14px; border:0; padding:0;">諤晁・・繝ｭ繧ｻ繧ｹ</h3>
                               <label class="checkbox-label">
                                   <input type="checkbox" id="llmaggregator-include-thoughts-toggle">
                                   Include Thoughts
                               </label>
                               <label class="checkbox-label">
                                   <input type="checkbox" id="llmaggregator-expand-thoughts-by-default-toggle">
                                   眺諤晁・・繝ｭ繧ｻ繧ｹ繧帝幕縺・◆迥ｶ諷九↓縺吶ｋ
                               </label>
                           </div>
                        </details>
                    </div>
                </details>

                <details id="gemini-advanced-group" class="settings-group" open>
                   <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">繧｢繝峨ヰ繝ｳ繧ｹ繝・(Gemini)</summary>
                   <div style="margin-top:15px;">
                       <label for="gemini-dummy-user">繝繝溘・ User 繝励Ο繝ｳ繝励ヨ (騾∽ｿ｡譎ゅ・縺ｿ霑ｽ蜉):</label>
                       <textarea id="gemini-dummy-user" placeholder="API騾∽ｿ｡逶ｴ蜑阪↓ user 繝ｭ繝ｼ繝ｫ縺ｨ縺励※螻･豁ｴ譛ｫ蟆ｾ縺ｫ霑ｽ蜉縺輔ｌ縺ｾ縺・ aria-label="Gemini 繝繝溘・ User 繝励Ο繝ｳ繝励ヨ"></textarea>
                       <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                           <input type="checkbox" id="gemini-enable-dummy-user">
                           縺薙・繝繝溘・User繝励Ο繝ｳ繝励ヨ繧呈怏蜉ｹ縺ｫ縺吶ｋ
                       </label>

                       <label for="gemini-dummy-model">繝繝溘・ Model 繝励Ο繝ｳ繝励ヨ (騾∽ｿ｡譎ゅ・縺ｿ霑ｽ蜉):</label>
                       <textarea id="gemini-dummy-model" placeholder="API騾∽ｿ｡逶ｴ蜑阪↓ model 繝ｭ繝ｼ繝ｫ縺ｨ縺励※螻･豁ｴ譛譛ｫ蟆ｾ縺ｫ霑ｽ蜉縺輔ｌ縺ｾ縺・ aria-label="Gemini 繝繝溘・ Model 繝励Ο繝ｳ繝励ヨ"></textarea>
                       <label class="checkbox-label" style="margin-top: -5px;">
                           <input type="checkbox" id="gemini-enable-dummy-model">
                           縺薙・繝繝溘・Model繝励Ο繝ｳ繝励ヨ繧呈怏蜉ｹ縺ｫ縺吶ｋ
                       </label>
                       <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                           <input type="checkbox" id="gemini-concat-dummy-model">
                           繝繝溘・繝｢繝・Ν縺ｨ蝗樒ｭ斐ｒ騾｣邨・                       </label>
                       <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                           窶ｻ繝√ぉ繝・け譎ゅ√Δ繝・Ν蠢懃ｭ斐・蜈磯ｭ縺ｫ荳願ｨ倥ム繝溘・Model縺ｮ蜀・ｮｹ繧剃ｻ倅ｸ弱・                       </p>
                       <hr style="margin: 15px 0;">
                       <label class="checkbox-label">
                           <input type="checkbox" id="gemini-streaming-output">
                           繧ｹ繝医Μ繝ｼ繝溘Φ繧ｰ蜃ｺ蜉帙ｒ菴ｿ逕ｨ縺吶ｋ
                       </label>
                       <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">窶ｻGemini縺ｮ縲後ぎ繝ｼ繝峨′蝗ｺ縺上↑繧九榊ｴ蜷医′縺ゅｊ縺ｾ縺・/p>
                       <label for="gemini-streaming-speed">譁・ｭ鈴√ｊ騾溷ｺｦ (繝溘Μ遘・譁・ｭ・:</label>
                       <input type="number" id="gemini-streaming-speed" min="0" step="1" placeholder="萓・ 30 (0縺ｧ辟｡蜉ｹ)" aria-label="Gemini 譁・ｭ鈴√ｊ騾溷ｺｦ">
                       <div id="gemini-pseudo-streaming-param">
                           <label class="checkbox-label" style="margin-top: 10px;">
                               <input type="checkbox" id="gemini-pseudo-streaming">
                               逍台ｼｼ繧ｹ繝医Μ繝ｼ繝溘Φ繧ｰ繧剃ｽｿ逕ｨ (繧ｹ繝医Μ繝ｼ繝溘Φ繧ｰON譎ゅ・縺ｿ譛牙柑)
                           </label>
                           <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                               窶ｻ螳滄圀縺ｫ縺ｯ荳諡ｬ逕滓・繧貞他縺ｳ縲∝ｿ懃ｭ斐・繧ｹ繝医Μ繝ｼ繝溘Φ繧ｰ蜀咲函繧定｡後≧縲・br>
                               譎ｮ騾壹・繧ｹ繝医Μ繝ｼ繝溘Φ繧ｰ繧医ｊ逕滓・蠕・■譎る俣縺ｯ髟ｷ縺上↑繧九・                           </p>
                       </div>
                    </div>
                </details>

                <details id="deepseek-advanced-group" class="settings-group hidden" open>
                   <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">繧｢繝峨ヰ繝ｳ繧ｹ繝・(DeepSeek)</summary>
                   <div style="margin-top:15px;">
                       <label for="deepseek-dummy-user">繝繝溘・ User 繝励Ο繝ｳ繝励ヨ (騾∽ｿ｡譎ゅ・縺ｿ霑ｽ蜉):</label>
                       <textarea id="deepseek-dummy-user" placeholder="API騾∽ｿ｡逶ｴ蜑阪↓ user 繝ｭ繝ｼ繝ｫ縺ｨ縺励※螻･豁ｴ譛ｫ蟆ｾ縺ｫ霑ｽ蜉縺輔ｌ縺ｾ縺・ aria-label="DeepSeek 繝繝溘・ User 繝励Ο繝ｳ繝励ヨ"></textarea>
                       <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                           <input type="checkbox" id="deepseek-enable-dummy-user">
                           縺薙・繝繝溘・User繝励Ο繝ｳ繝励ヨ繧呈怏蜉ｹ縺ｫ縺吶ｋ
                       </label>

                       <label for="deepseek-dummy-model">繝繝溘・ Model 繝励Ο繝ｳ繝励ヨ (騾∽ｿ｡譎ゅ・縺ｿ霑ｽ蜉):</label>
                       <textarea id="deepseek-dummy-model" placeholder="API騾∽ｿ｡逶ｴ蜑阪↓ model 繝ｭ繝ｼ繝ｫ縺ｨ縺励※螻･豁ｴ譛譛ｫ蟆ｾ縺ｫ霑ｽ蜉縺輔ｌ縺ｾ縺・ aria-label="DeepSeek 繝繝溘・ Model 繝励Ο繝ｳ繝励ヨ"></textarea>
                       <label class="checkbox-label" style="margin-top: -5px;">
                           <input type="checkbox" id="deepseek-enable-dummy-model">
                           縺薙・繝繝溘・Model繝励Ο繝ｳ繝励ヨ繧呈怏蜉ｹ縺ｫ縺吶ｋ
                       </label>
                       <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                           <input type="checkbox" id="deepseek-concat-dummy-model">
                           繝繝溘・繝｢繝・Ν縺ｨ蝗樒ｭ斐ｒ騾｣邨・                       </label>
                       <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                           窶ｻ繝√ぉ繝・け譎ゅ√Δ繝・Ν蠢懃ｭ斐・蜈磯ｭ縺ｫ荳願ｨ倥ム繝溘・Model縺ｮ蜀・ｮｹ繧剃ｻ倅ｸ弱・                       </p>
                       <hr style="margin: 15px 0;">
                       <label class="checkbox-label">
                           <input type="checkbox" id="deepseek-streaming-output">
                           繧ｹ繝医Μ繝ｼ繝溘Φ繧ｰ蜃ｺ蜉帙ｒ菴ｿ逕ｨ縺吶ｋ
                       </label>
                       <label for="deepseek-streaming-speed">譁・ｭ鈴√ｊ騾溷ｺｦ (繝溘Μ遘・譁・ｭ・:</label>

                       <input type="number" id="deepseek-streaming-speed" min="0" step="1" placeholder="萓・ 30 (0縺ｧ辟｡蜉ｹ)" aria-label="DeepSeek 譁・ｭ鈴√ｊ騾溷ｺｦ">
                    </div>
                </details>

                <details id="claude-advanced-group" class="settings-group hidden" open>
                   <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">繧｢繝峨ヰ繝ｳ繧ｹ繝・(Claude)</summary>
                   <div style="margin-top:15px;">
                       <label for="claude-dummy-user">繝繝溘・ User 繝励Ο繝ｳ繝励ヨ (騾∽ｿ｡譎ゅ・縺ｿ霑ｽ蜉):</label>
                       <textarea id="claude-dummy-user" placeholder="API騾∽ｿ｡逶ｴ蜑阪↓ user 繝ｭ繝ｼ繝ｫ縺ｨ縺励※螻･豁ｴ譛ｫ蟆ｾ縺ｫ霑ｽ蜉縺輔ｌ縺ｾ縺・ aria-label="Claude 繝繝溘・ User 繝励Ο繝ｳ繝励ヨ"></textarea>
                       <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                           <input type="checkbox" id="claude-enable-dummy-user">
                           縺薙・繝繝溘・User繝励Ο繝ｳ繝励ヨ繧呈怏蜉ｹ縺ｫ縺吶ｋ
                       </label>

                       <label for="claude-dummy-model">繝繝溘・ Model 繝励Ο繝ｳ繝励ヨ (騾∽ｿ｡譎ゅ・縺ｿ霑ｽ蜉):</label>
                       <textarea id="claude-dummy-model" placeholder="API騾∽ｿ｡逶ｴ蜑阪↓ model 繝ｭ繝ｼ繝ｫ縺ｨ縺励※螻･豁ｴ譛譛ｫ蟆ｾ縺ｫ霑ｽ蜉縺輔ｌ縺ｾ縺・ aria-label="Claude 繝繝溘・ Model 繝励Ο繝ｳ繝励ヨ"></textarea>
                       <label class="checkbox-label" style="margin-top: -5px;">
                           <input type="checkbox" id="claude-enable-dummy-model">
                           縺薙・繝繝溘・Model繝励Ο繝ｳ繝励ヨ繧呈怏蜉ｹ縺ｫ縺吶ｋ
</label>
                       <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                           <input type="checkbox" id="claude-concat-dummy-model">
                           繝繝溘・繝｢繝・Ν縺ｨ蝗樒ｭ斐ｒ騾｣邨・                       </label>
                       <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                           窶ｻ繝√ぉ繝・け譎ゅ√Δ繝・Ν蠢懃ｭ斐・蜈磯ｭ縺ｫ荳願ｨ倥ム繝溘・Model縺ｮ蜀・ｮｹ繧剃ｻ倅ｸ弱・                       </p>
                       <hr style="margin: 15px 0;">
                       <label class="checkbox-label">
                           <input type="checkbox" id="claude-streaming-output">
                           繧ｹ繝医Μ繝ｼ繝溘Φ繧ｰ蜃ｺ蜉帙ｒ菴ｿ逕ｨ縺吶ｋ
                       </label>
                       <label for="claude-streaming-speed">譁・ｭ鈴√ｊ騾溷ｺｦ (繝溘Μ遘・譁・ｭ・:</label>

                       <input type="number" id="claude-streaming-speed" min="0" step="1" placeholder="萓・ 30 (0縺ｧ辟｡蜉ｹ)" aria-label="Claude 譁・ｭ鈴√ｊ騾溷ｺｦ">
                    </div>
                </details>

                <details id="openai-advanced-group" class="settings-group hidden" open>
                   <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">繧｢繝峨ヰ繝ｳ繧ｹ繝・(ChatGPT)</summary>
                   <div style="margin-top:15px;">
                       <label for="openai-dummy-user">繝繝溘・ User 繝励Ο繝ｳ繝励ヨ (騾∽ｿ｡譎ゅ・縺ｿ霑ｽ蜉):</label>
                       <textarea id="openai-dummy-user" placeholder="API騾∽ｿ｡逶ｴ蜑阪↓ user 繝ｭ繝ｼ繝ｫ縺ｨ縺励※螻･豁ｴ譛ｫ蟆ｾ縺ｫ霑ｽ蜉縺輔ｌ縺ｾ縺・ aria-label="OpenAI 繝繝溘・ User 繝励Ο繝ｳ繝励ヨ"></textarea>
                       <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                           <input type="checkbox" id="openai-enable-dummy-user">
                           縺薙・繝繝溘・User繝励Ο繝ｳ繝励ヨ繧呈怏蜉ｹ縺ｫ縺吶ｋ
                       </label>

                       <label for="openai-dummy-model">繝繝溘・ Model 繝励Ο繝ｳ繝励ヨ (騾∽ｿ｡譎ゅ・縺ｿ霑ｽ蜉):</label>
                       <textarea id="openai-dummy-model" placeholder="API騾∽ｿ｡逶ｴ蜑阪↓ model 繝ｭ繝ｼ繝ｫ縺ｨ縺励※螻･豁ｴ譛譛ｫ蟆ｾ縺ｫ霑ｽ蜉縺輔ｌ縺ｾ縺・ aria-label="OpenAI 繝繝溘・ Model 繝励Ο繝ｳ繝励ヨ"></textarea>
                       <label class="checkbox-label" style="margin-top: -5px;">
                           <input type="checkbox" id="openai-enable-dummy-model">
                           縺薙・繝繝溘・Model繝励Ο繝ｳ繝励ヨ繧呈怏蜉ｹ縺ｫ縺吶ｋ
                       </label>
                       <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                           <input type="checkbox" id="openai-concat-dummy-model">
                           繝繝溘・繝｢繝・Ν縺ｨ蝗樒ｭ斐ｒ騾｣邨・                       </label>
                       <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                           窶ｻ繝√ぉ繝・け譎ゅ√Δ繝・Ν蠢懃ｭ斐・蜈磯ｭ縺ｫ荳願ｨ倥ム繝溘・Model縺ｮ蜀・ｮｹ繧剃ｻ倅ｸ弱・                       </p>
                       <hr style="margin: 15px 0;">
                       <label class="checkbox-label">
                           <input type="checkbox" id="openai-streaming-output">
                           繧ｹ繝医Μ繝ｼ繝溘Φ繧ｰ蜃ｺ蜉帙ｒ菴ｿ逕ｨ縺吶ｋ
                       </label>
                       <label for="openai-streaming-speed">譁・ｭ鈴√ｊ騾溷ｺｦ (繝溘Μ遘・譁・ｭ・:</label>
                       <input type="number" id="openai-streaming-speed" min="0" step="1" placeholder="萓・ 30 (0縺ｧ辟｡蜉ｹ)" aria-label="OpenAI 譁・ｭ鈴√ｊ騾溷ｺｦ">
                    </div>
                </details>
                
                <details id="xai-advanced-group" class="settings-group hidden" open>
                   <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">繧｢繝峨ヰ繝ｳ繧ｹ繝・(xAI)</summary>
                   <div style="margin-top:15px;">
                       <label for="xai-dummy-user">繝繝溘・ User 繝励Ο繝ｳ繝励ヨ (騾∽ｿ｡譎ゅ・縺ｿ霑ｽ蜉):</label>
                       <textarea id="xai-dummy-user" placeholder="API騾∽ｿ｡逶ｴ蜑阪↓ user 繝ｭ繝ｼ繝ｫ縺ｨ縺励※螻･豁ｴ譛ｫ蟆ｾ縺ｫ霑ｽ蜉縺輔ｌ縺ｾ縺・ aria-label="xAI 繝繝溘・ User 繝励Ο繝ｳ繝励ヨ"></textarea>
                       <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                           <input type="checkbox" id="xai-enable-dummy-user">
                           縺薙・繝繝溘・User繝励Ο繝ｳ繝励ヨ繧呈怏蜉ｹ縺ｫ縺吶ｋ
                       </label>

                       <label for="xai-dummy-model">繝繝溘・ Model 繝励Ο繝ｳ繝励ヨ (騾∽ｿ｡譎ゅ・縺ｿ霑ｽ蜉):</label>
                       <textarea id="xai-dummy-model" placeholder="API騾∽ｿ｡逶ｴ蜑阪↓ model 繝ｭ繝ｼ繝ｫ縺ｨ縺励※螻･豁ｴ譛譛ｫ蟆ｾ縺ｫ霑ｽ蜉縺輔ｌ縺ｾ縺・ aria-label="xAI 繝繝溘・ Model 繝励Ο繝ｳ繝励ヨ"></textarea>
                       <label class="checkbox-label" style="margin-top: -5px;">
                           <input type="checkbox" id="xai-enable-dummy-model">
                           縺薙・繝繝溘・Model繝励Ο繝ｳ繝励ヨ繧呈怏蜉ｹ縺ｫ縺吶ｋ
                       </label>
                       <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                           <input type="checkbox" id="xai-concat-dummy-model">
                           繝繝溘・繝｢繝・Ν縺ｨ蝗樒ｭ斐ｒ騾｣邨・                       </label>
                       <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                           窶ｻ繝√ぉ繝・け譎ゅ√Δ繝・Ν蠢懃ｭ斐・蜈磯ｭ縺ｫ荳願ｨ倥ム繝溘・Model縺ｮ蜀・ｮｹ繧剃ｻ倅ｸ弱・                       </p>
                       <hr style="margin: 15px 0;">
                       <div id="xai-thoughts-param" style="margin-top: 15px;">
                          <h3 style="margin-top:15px; margin-bottom:10px; font-size:14px; border:0; padding:0;">諤晁・・繝ｭ繧ｻ繧ｹ (Reasoning)</h3>
                          <label class="checkbox-label">
                              <input type="checkbox" id="xai-include-thoughts-toggle">
                              Include Thoughts
                          </label>
                          <label class="checkbox-label">
                              <input type="checkbox" id="xai-expand-thoughts-by-default-toggle">
                              眺諤晁・・繝ｭ繧ｻ繧ｹ繧帝幕縺・◆迥ｶ諷九↓縺吶ｋ
                          </label>
                          <label for="xai-reasoning-effort">Reasoning Effort:</label>
                          <select id="xai-reasoning-effort">
                              <option value="low">low</option>
                              <option value="high">high</option>
                          </select>
                          <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                              窶ｻ grok-3-mini, grok-3-mini-fast 縺ｮ縺ｿ蟇ｾ蠢懊・                          </p>
                       </div>
                       <hr style="margin: 15px 0;">
                       <label class="checkbox-label" style="margin-top: 15px;">
                           <input type="checkbox" id="xai-vision-enable">
                           Vision (逕ｻ蜒丞・蜉・ 繧呈怏蜉ｹ縺ｫ縺吶ｋ
                       </label>
                       <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                           窶ｻgrok-2-vision-1212 縺ｪ縺ｩ逕ｻ蜒丞・蜉帛ｯｾ蠢懊Δ繝・Ν繧帝∈謚槭＠縺ｦ縺上□縺輔＞縲・                       </p>
                       <label class="checkbox-label">
                           <input type="checkbox" id="xai-streaming-output">
                           繧ｹ繝医Μ繝ｼ繝溘Φ繧ｰ蜃ｺ蜉帙ｒ菴ｿ逕ｨ縺吶ｋ
                       </label>
                       <label for="xai-streaming-speed">譁・ｭ鈴√ｊ騾溷ｺｦ (繝溘Μ遘・譁・ｭ・:</label>
                       <input type="number" id="xai-streaming-speed" min="0" step="1" placeholder="萓・ 30 (0縺ｧ辟｡蜉ｹ)" aria-label="xAI 譁・ｭ鈴√ｊ騾溷ｺｦ">
                    </div>
                </details>

                <details id="llmaggregator-advanced-group" class="settings-group hidden" open>
                   <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">繧｢繝峨ヰ繝ｳ繧ｹ繝・(LLM Aggregator)</summary>
                   <div style="margin-top:15px;">
                       <label for="llmaggregator-dummy-user">繝繝溘・ User 繝励Ο繝ｳ繝励ヨ (騾∽ｿ｡譎ゅ・縺ｿ霑ｽ蜉):</label>
                       <textarea id="llmaggregator-dummy-user" placeholder="API騾∽ｿ｡逶ｴ蜑阪↓ user 繝ｭ繝ｼ繝ｫ縺ｨ縺励※螻･豁ｴ譛ｫ蟆ｾ縺ｫ霑ｽ蜉縺輔ｌ縺ｾ縺・ aria-label="LLM Aggregator 繝繝溘・ User 繝励Ο繝ｳ繝励ヨ"></textarea>
                       <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                           <input type="checkbox" id="llmaggregator-enable-dummy-user">
                           縺薙・繝繝溘・User繝励Ο繝ｳ繝励ヨ繧呈怏蜉ｹ縺ｫ縺吶ｋ
                       </label>

                       <label for="llmaggregator-dummy-model">繝繝溘・ Model 繝励Ο繝ｳ繝励ヨ (騾∽ｿ｡譎ゅ・縺ｿ霑ｽ蜉):</label>
                       <textarea id="llmaggregator-dummy-model" placeholder="API騾∽ｿ｡逶ｴ蜑阪↓ model 繝ｭ繝ｼ繝ｫ縺ｨ縺励※螻･豁ｴ譛譛ｫ蟆ｾ縺ｫ霑ｽ蜉縺輔ｌ縺ｾ縺・ aria-label="LLM Aggregator 繝繝溘・ Model 繝励Ο繝ｳ繝励ヨ"></textarea>
                       <label class="checkbox-label" style="margin-top: -5px;">
                           <input type="checkbox" id="llmaggregator-enable-dummy-model">
                           縺薙・繝繝溘・Model繝励Ο繝ｳ繝励ヨ繧呈怏蜉ｹ縺ｫ縺吶ｋ
                       </label>
                       <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                           <input type="checkbox" id="llmaggregator-concat-dummy-model">
                           繝繝溘・繝｢繝・Ν縺ｨ蝗樒ｭ斐ｒ騾｣邨・                       </label>
                       <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                           窶ｻ繝√ぉ繝・け譎ゅ√Δ繝・Ν蠢懃ｭ斐・蜈磯ｭ縺ｫ荳願ｨ倥ム繝溘・Model縺ｮ蜀・ｮｹ繧剃ｻ倅ｸ弱・                       </p>
                       <hr style="margin: 15px 0;">
                       <label class="checkbox-label">
                           <input type="checkbox" id="llmaggregator-streaming-output">
                           繧ｹ繝医Μ繝ｼ繝溘Φ繧ｰ蜃ｺ蜉帙ｒ菴ｿ逕ｨ縺吶ｋ
                       </label>
                       <label for="llmaggregator-streaming-speed">譁・ｭ鈴√ｊ騾溷ｺｦ (繝溘Μ遘・譁・ｭ・:</label>
                       <input type="number" id="llmaggregator-streaming-speed" min="0" step="1" placeholder="萓・ 30 (0縺ｧ辟｡蜉ｹ)" aria-label="LLM Aggregator 譁・ｭ鈴√ｊ騾溷ｺｦ">
                    </div>
                </details>

                <div id="gemini-grounding-param" class="settings-group">
                    <h3>讀懃ｴ｢ (Gemini)</h3>
                    <label class="checkbox-label">
                        <input type="checkbox" id="gemini-enable-grounding-toggle">
                        繝阪ャ繝医°繧画ュ蝣ｱ繧貞叙蠕励＆縺帙ｋ (Google Search)
                    </label>
                    <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                        窶ｻ 繝√ぉ繝・け譎ゅ√Δ繝・Ν縺ｯ蝗樒ｭ皮函謌舌・縺溘ａ縺ｫWeb讀懃ｴ｢繧定｡後≧縲・br>
                        窶ｻ Gemini 2.0莉･髯阪〒縺ｮ縺ｿ蟇ｾ蠢・1.5莉･蜑阪・莠呈鋤縺ｪ縺励ゅお繝ｩ繝ｼ縺ｫ縺ｪ繧・<br>
                        窶ｻ 謗ｨ隲悶Δ繝・Ν縺ｯ謗ｨ隲門・縺ｧ讀懃ｴ｢縺吶ｋ蝣ｴ蜷医′縺ゅｊ縲∝ｼ慕畑繝・・繧ｿ縺悟ｸｰ繧峨↑縺・ｴ蜷医′縺ゅｋ縲・                    </p>
                </div>
                <div class="settings-group" id="settings-group-image">
                    <h3>繧､繝｡繝ｼ繧ｸ逕ｻ蜒・/h3>
                    <label>繝√Ε繝・ヨ逕ｻ髱｢縺ｮ閭梧勹逕ｻ蜒・</label>
                    <div class="image-upload-controls">
                        <input type="file" id="background-image-input" accept="image/jpeg, image/png, image/gif, image/webp" class="hidden">
                        <button id="upload-background-btn" class="settings-action-button" type="button">逕ｻ蜒上ｒ驕ｸ謚・..</button>
                        <img id="background-thumbnail" src="" alt="閭梧勹逕ｻ蜒上・繝ｬ繝薙Η繝ｼ" class="background-thumbnail hidden">
                        <button id="delete-background-btn" class="settings-delete-button hidden" type="button">逕ｻ蜒上ｒ蜑企勁</button>
                    </div>
                     <p style="font-size: 11px; color: var(--text-secondary); margin-top: 8px;">
                       窶ｻ 逕ｻ蜒上・繝悶Λ繧ｦ繧ｶ蜀・・繝・・繧ｿ繝吶・繧ｹ縺ｫ菫晏ｭ倥＆繧後∪縺吶Ｈif繧ょ庄<br>
                       窶ｻ 蜿ｯ隱ｭ諤ｧ縺ｮ縺溘ａ逕ｻ蜒上・荳翫↓蜊企乗・縺ｮ繝ｬ繧､繝､繝ｼ繧定｡ｨ遉ｺ縲・                     </p>
                </div>

                <details class="settings-group" id="settings-group-icons">
                    <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">繝√Ε繝・ヨ繧｢繧､繧ｳ繝ｳ險ｭ螳・/summary>
                    <div style="margin-top:15px;">
                        <label class="checkbox-label">
                            <input type="checkbox" id="show-user-icon-toggle">
                            繝ｦ繝ｼ繧ｶ繝ｼ繧｢繧､繧ｳ繝ｳ繧定｡ｨ遉ｺ縺吶ｋ
                        </label>
                        <div class="image-upload-controls" style="margin-bottom: 5px;">
                            <input type="file" id="user-icon-input" accept="image/jpeg, image/png, image/gif, image/webp" class="hidden">
                            <button id="upload-user-icon-btn" class="settings-action-button" type="button">繝ｦ繝ｼ繧ｶ繝ｼ繧｢繧､繧ｳ繝ｳ驕ｸ謚・..</button>
                            <img id="user-icon-thumbnail" src="" alt="繝ｦ繝ｼ繧ｶ繝ｼ繧｢繧､繧ｳ繝ｳ繝励Ξ繝薙Η繝ｼ" class="icon-thumbnail hidden">
                            <button id="delete-user-icon-btn" class="settings-delete-button hidden" type="button">蜑企勁</button>
                        </div>
                        <label class="checkbox-label" style="margin-top: 5px;">
                            <input type="checkbox" id="show-user-name-toggle">
                            繝ｦ繝ｼ繧ｶ繝ｼ蜷阪ｒ陦ｨ遉ｺ縺吶ｋ
                        </label>

                        <label class="checkbox-label" style="margin-top: 20px;">
                            <input type="checkbox" id="show-ai-icon-toggle" checked>
                            AI繧｢繧､繧ｳ繝ｳ繧定｡ｨ遉ｺ縺吶ｋ
                        </label>
                        <div class="image-upload-controls" style="margin-bottom: 5px;">
                            <input type="file" id="ai-icon-input" accept="image/jpeg, image/png, image/gif, image/webp" class="hidden">
                            <button id="upload-ai-icon-btn" class="settings-action-button" type="button">AI繧｢繧､繧ｳ繝ｳ驕ｸ謚・..</button>
                            <img id="ai-icon-thumbnail" src="" alt="AI繧｢繧､繧ｳ繝ｳ繝励Ξ繝薙Η繝ｼ" class="icon-thumbnail hidden">
                            <button id="delete-ai-icon-btn" class="settings-delete-button hidden" type="button">蜑企勁</button>
                        </div>
                        <label class="checkbox-label" style="margin-top: 5px;">
                            <input type="checkbox" id="show-ai-name-toggle" checked>
                            AI蜷阪ｒ陦ｨ遉ｺ縺吶ｋ
                        </label>
                        <label for="ai-name-input">陦ｨ遉ｺ縺吶ｋAI蜷・</label>
                        <input type="text" id="ai-name-input" placeholder="萓・ Gemini" aria-label="陦ｨ遉ｺ縺吶ｋAI蜷・>

                        <details id="settings-group-icon-details">
                            <summary style="cursor: pointer; font-weight: normal; font-size: 14px; color: var(--text-link); list-style: revert;">繧｢繧､繧ｳ繝ｳ陦ｨ遉ｺ隱ｿ謨ｴ</summary>
                            <div style="padding-left: 15px; margin-top: 10px;">
                                <div style="margin-top: 10px;">
                                    <label for="icon-name-font-size">繧｢繧､繧ｳ繝ｳ荳九・蜷榊燕縺ｮ譁・ｭ励し繧､繧ｺ (px):</label>
                                    <input type="number" id="icon-name-font-size" min="1" max="46" step="1" placeholder="萓・ 10" aria-label="繧｢繧､繧ｳ繝ｳ荳九・蜷榊燕縺ｮ譁・ｭ励し繧､繧ｺ・井ｸ企剞縺ゅｊ・・>
                                </div>
                                <div style="margin-top: 10px;">
                                    <label for="icon-name-offset-y">蜷榊燕縺ｮ蝙ら峩繧ｪ繝輔そ繝・ヨ (px, 荳翫′豁｣):</label>
                                    <input type="number" id="icon-name-offset-y" step="1" placeholder="萓・ 10" aria-label="蜷榊燕縺ｮ蝙ら峩繧ｪ繝輔そ繝・ヨ・井ｸ企剞縺ゅｊ・・>
                                </div>
                                <div style="margin-top: 20px;">
                                    <label for="message-icon-size">繧｢繧､繧ｳ繝ｳ陦ｨ遉ｺ繧ｵ繧､繧ｺ (px):</label>
                                    <input type="number" id="message-icon-size" min="1" max="300" step="1" placeholder="萓・ 28" aria-label="繧｢繧､繧ｳ繝ｳ陦ｨ遉ｺ繧ｵ繧､繧ｺ・井ｸ企剞縺ゅｊ・・>
                                </div>
                                <div style="margin-top: 15px;">
                                    <label for="message-icon-offset-y">繧｢繧､繧ｳ繝ｳ蝙ら峩繧ｪ繝輔そ繝・ヨ (px, 荳翫′豁｣):</label>
                                    <input type="number" id="message-icon-offset-y" step="1" placeholder="萓・ 0 (荳贋ｸ九↓隱ｿ謨ｴ)" aria-label="繧｢繧､繧ｳ繝ｳ蝙ら峩繧ｪ繝輔そ繝・ヨ・井ｸ企剞縺ゅｊ・・>
                                </div>
                                <hr style="margin: 20px 0;">
                                <h4>繝ｦ繝ｼ繧ｶ繝ｼ蜷阪・閭梧勹繝舌ヶ繝ｫ</h4>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="user-name-bubble-toggle">
                                    繝舌ヶ繝ｫ繧定｡ｨ遉ｺ縺吶ｋ
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="user-name-bubble-use-theme-color-toggle">
                                    繝・・繝槭・繝｡繝・そ繝ｼ繧ｸ濶ｲ縺ｫ蜷医ｏ縺帙ｋ
                                </label>
                                <div id="user-name-bubble-custom-color-settings">
                                    <label for="user-name-bubble-color">閭梧勹濶ｲ (荳願ｨ楼FF譎・:</label>
                                    <input type="text" id="user-name-bubble-color" placeholder="#FFFFFF">
                                </div>
                                <label for="user-name-bubble-opacity">騾城℃蠎ｦ (0.0-1.0):</label>
                                <input type="number" id="user-name-bubble-opacity" min="0" max="1" step="0.1" placeholder="0.8">

                                <h4 style="margin-top: 15px;">AI蜷阪・閭梧勹繝舌ヶ繝ｫ</h4>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="ai-name-bubble-toggle">
                                    繝舌ヶ繝ｫ繧定｡ｨ遉ｺ縺吶ｋ
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="ai-name-bubble-use-theme-color-toggle">
                                    繝・・繝槭・繝｡繝・そ繝ｼ繧ｸ濶ｲ縺ｫ蜷医ｏ縺帙ｋ
                                </label>
                                <div id="ai-name-bubble-custom-color-settings">
                                    <label for="ai-name-bubble-color">閭梧勹濶ｲ (荳願ｨ楼FF譎・:</label>
                                    <input type="text" id="ai-name-bubble-color" placeholder="#FFFFFF">
                                </div>
                                <label for="ai-name-bubble-opacity">騾城℃蠎ｦ (0.0-1.0):</label>
                                <input type="number" id="ai-name-bubble-opacity" min="0" max="1" step="0.1" placeholder="0.8">
                            </div>
                         </details>
                         <p style="font-size: 11px; color: var(--text-secondary); margin-top: 15px;">
                           窶ｻ 繧｢繧､繧ｳ繝ｳ逕ｻ蜒上・繝悶Λ繧ｦ繧ｶ蜀・・繝・・繧ｿ繝吶・繧ｹ縺ｫ菫晏ｭ倥＆繧後∪縺吶・br>
                           窶ｻ 陦ｨ遉ｺ譎ゅ・蜀・ｽ｢縺ｫ蛻・ｊ蜿悶ｉ繧後∪縺吶Ｈif繧ょ庄縲√ョ繝輔か繝ｫ繝医し繧､繧ｺ: 28px縲・                         </p>
                    </div>
                </details>

                <div class="settings-group" id="settings-group-other">
                   <details open id="settings-group-other-details">
                        <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">縺昴・莉冶ｨｭ螳・/summary>
                        <div style="margin-top:10px;">
                           <p style="height:10px"></p>
                           <label for="theme-select">繝・ヵ繧ｩ繝ｫ繝郁｡ｨ遉ｺ繝・・繝・</label>
                           <select id="theme-select" aria-label="繝・ヵ繧ｩ繝ｫ繝郁｡ｨ遉ｺ繝・・繝・>
                               <option value="light">繝ｩ繧､繝医Δ繝ｼ繝・/option>
                               <option value="dark">繝繝ｼ繧ｯ繝｢繝ｼ繝・/option>
                               <option value="pastel-pink">繝代せ繝・Ν繝｢繝ｼ繝解洸ｷ</option>
                               <option value="pastel-blue">繝代せ繝・Ν繝｢繝ｼ繝解洸ｵ</option>
                               <option value="pastel-yellow">繝代せ繝・Ν繝｢繝ｼ繝解沺｡</option>
                               <option value="pastel-purple">繝代せ繝・Ν繝｢繝ｼ繝解沺｣</option>
                               <option value="pastel-rainbow">繝代せ繝・Ν繝｢繝ｼ繝解沍・/option>
                           </select>
                           <p style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">窶ｻ繝帙・繝逕ｻ髱｢縲∝ｱ･豁ｴ逕ｻ髱｢縲∬ｨｭ螳夂判髱｢縺ｫ驕ｩ逕ｨ縺輔ｌ縺ｾ縺吶ゅメ繝｣繝・ヨ逕ｻ髱｢縺ｮ繝・・繝槭・蛟句挨縺ｫ險ｭ螳壹〒縺阪∪縺吶・/p>
                           <p style="height:10px"></p>
                            <details id="settings-group-behavior-adjustment" open="">
                                <summary style="font-size: 14px; color: var(--text-link); padding-bottom: 5px; margin-bottom: 10px; display: list-item; list-style: revert; cursor:pointer; font-weight: normal;">繧｢繝励Μ縺ｮ謖吝虚繧定ｪｿ謨ｴ</summary>
                               <div style="padding-left: 15px; margin-top: 10px;">
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="enter-to-send">
                                       Enter繧ｭ繝ｼ縺ｧ騾∽ｿ｡縺吶ｋ
                                   </label>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="auto-scroll-on-new-message">
                                       繝｡繝・そ繝ｼ繧ｸ騾∝女菫｡譎ゅ↓閾ｪ蜍輔せ繧ｯ繝ｭ繝ｼ繝ｫ縺吶ｋ
                                   </label>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="auto-scroll-on-thought">
                                       諤晁・・繝ｭ繧ｻ繧ｹ蜿嶺ｿ｡譎ゅ↓閾ｪ蜍輔せ繧ｯ繝ｭ繝ｼ繝ｫ縺吶ｋ
                                   </label>
                                   <p style="height:10px"></p>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="swipe-navigation-toggle">
                                       繝√Ε繝・ヨ逕ｻ髱｢縺九ｉ蟾ｦ蜿ｳ繧ｹ繝ｯ繧､繝励〒逕ｻ髱｢遘ｻ蜍・                                   </label>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="prevent-zoom-toggle">
                                       繧ｺ繝ｼ繝繧堤ｦ∵ｭ｢縺吶ｋ (繝・く繧ｹ繝亥・蜉帶凾縺ｮ閾ｪ蜍輔ぜ繝ｼ繝髦ｲ豁｢)
                                   </label>
                                   <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                                       窶ｻ 繧ｹ繝槭・遲峨〒繝・く繧ｹ繝亥・蜉帶凾縺ｫ諢丞峙縺帙★繧ｺ繝ｼ繝縺吶ｋ縺ｮ繧帝亟縺弱∪縺吶・                                   </p>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="disable-retry-confirmation-toggle">
                                       繝ｪ繝医Λ繧､譎ゅ・遒ｺ隱阪ム繧､繧｢繝ｭ繧ｰ繧堤┌蜉ｹ縺ｫ縺吶ｋ
                                   </label>
                                   <p style="height:10px"></p>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="disable-delete-message-confirmation-toggle">
                                       繝｡繝・そ繝ｼ繧ｸ蜑企勁譎ゅ・遒ｺ隱阪ム繧､繧｢繝ｭ繧ｰ繧堤┌蜉ｹ縺ｫ縺吶ｋ
                                   </label>
                                   <p style="height:10px"></p>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="disable-attachment-confirmation-toggle">
                                       豺ｻ莉倥ヵ繧｡繧､繝ｫ蜑企勁譎ゅ・遒ｺ隱阪ム繧､繧｢繝ｭ繧ｰ繧堤┌蜉ｹ縺ｫ縺吶ｋ
                                   </label>
                                   <p style="height:10px"></p>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="add-prefix-on-import-toggle">
                                       螻･豁ｴ繧､繝ｳ繝昴・繝域凾縺ｫ繧ｿ繧､繝医Ν縺ｸ謗･鬆ｭ霎槭・蜿冶ｾｼ)縲阪ｒ莉倅ｸ弱☆繧・                                   </label>
                                   <p style="height:10px"></p>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="show-multi-api-keys-toggle">
                                       隍・焚API繧ｭ繝ｼ邂｡逅・ｩ溯・繧定｡ｨ遉ｺ縺吶ｋ
                                   </label>
                                   <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                                       窶ｻ 隍・焚縺ｮAPI繧ｭ繝ｼ繧剃ｽｿ縺・・縺代◆縺・ｴ蜷医↓菴ｿ逕ｨ縲・                                   </p>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="minimize-header-toggle">
                                       繝倥ャ繝繝ｼ縺ｮ邵ｦ蟷・ｒ譛蟆丞喧縺吶ｋ
                                   </label>
                                   <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                                       窶ｻ 繝倥ャ繝繝ｼ縺ｮ邵ｦ蟷・ｒ蛻・ｊ隧ｰ繧√∬｡ｨ遉ｺ鬆伜沺繧呈怙螟ｧ蛹悶＠縺ｾ縺吶ら判髱｢縺悟ｰ丞梛縺ｪ縺・＠讓ｪ髟ｷ縺ｮ遶ｯ譛ｫ逕ｨ
                                   </p>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="minimize-footer-toggle">
                                       繝輔ャ繧ｿ繝ｼ縺ｮ邵ｦ蟷・ｒ譛蟆丞喧縺吶ｋ
                                   </label>
                                   <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 15px;">
                                       窶ｻ 繝輔ャ繧ｿ繝ｼ縺ｮ邵ｦ蟷・ｒ蛻・ｊ隧ｰ繧√∬｡ｨ遉ｺ鬆伜沺繧呈怙螟ｧ蛹悶＠縺ｾ縺吶ら判髱｢縺悟ｰ丞梛縺ｪ縺・＠讓ｪ髟ｷ縺ｮ遶ｯ譛ｫ逕ｨ
                                   </p>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="show-session-linking-settings-toggle">
                                       AI髢謎ｼ夊ｩｱ繝｢繝ｼ繝会ｼ医そ繝・す繝ｧ繝ｳ髢薙Μ繝ｳ繧ｯ・芽ｨｭ螳壹ｒ陦ｨ遉ｺ縺吶ｋ
                                   </label>
                                   <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 15px;">
                                       窶ｻ 螻･豁ｴ逕ｻ髱｢縺九ｉ2縺､縺ｮ繝√Ε繝・ヨ繧帝｣謳ｺ縺輔○縲、I蜷悟｣ｫ繧剃ｼ夊ｩｱ縺輔○繧九％縺ｨ縺後〒縺阪∪縺吶・                                   </p>
                                   <p style="height:10px"></p>
                                    <label for="history-sort-order">螻･豁ｴ縺ｮ繧ｽ繝ｼ繝磯・</label>
                                    <select id="history-sort-order" aria-label="螻･豁ｴ縺ｮ繧ｽ繝ｼ繝磯・>
                                       <option value="updatedAt">譖ｴ譁ｰ譌･譎・(譁ｰ縺励＞鬆・</option>
                                       <option value="createdAt">菴懈・譌･譎・(譁ｰ縺励＞鬆・</option>
                                    </select>
                                </div>
                           </details>

                           <details id="settings-group-header-footer-buttons">
                                <summary style="font-size: 14px; color: var(--text-link); padding-bottom: 5px; margin-bottom: 10px; display: list-item; list-style: revert; cursor:pointer; font-weight: normal;">繝懊ち繝ｳ鬘槭・陦ｨ遉ｺ/髱櫁｡ｨ遉ｺ蛻・崛</summary>
                                <div style="padding-left: 15px; margin-top: 10px;">
                                   <label class="checkbox-label">
                                        <input type="checkbox" id="show-bulk-history-actions-toggle">
                                        螻･豁ｴ逕ｻ髱｢縺ｫ縲悟・蜃ｺ蜉帙阪悟・蜿冶ｾｼ縲阪・繧ｿ繝ｳ繧定｡ｨ遉ｺ縺吶ｋ
                                   </label>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="show-chat-title-toggle">
                                       繝倥ャ繝繝ｼ縺ｫ繝√Ε繝・ヨ繧ｿ繧､繝医Ν繧定｡ｨ遉ｺ縺吶ｋ
                                   </label>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="show-new-chat-button-toggle">
                                       繝倥ャ繝繝ｼ縺ｫ縲梧眠隕上阪・繧ｿ繝ｳ繧定｡ｨ遉ｺ縺吶ｋ・医梧眠縲阪・繧ｿ繝ｳ・・                                   </label>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="show-delete-session-button-toggle">
                                       繝倥ャ繝繝ｼ縺ｫ縲悟・蜑企勁縲阪・繧ｿ繝ｳ繧定｡ｨ遉ｺ縺吶ｋ・医悟炎縲阪・繧ｿ繝ｳ・・                                   </label>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="show-copy-session-button-toggle">
                                       繝倥ャ繝繝ｼ縺ｫ縲悟・繧ｳ繝斐・縲阪・繧ｿ繝ｳ繧定｡ｨ遉ｺ縺吶ｋ・医後さ縲阪・繧ｿ繝ｳ・・                                   </label>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="show-scroll-to-top-button-toggle">
                                       繝倥ャ繝繝ｼ縺ｫ縲梧怙荳企Κ縺ｸ(半)縲阪・繧ｿ繝ｳ繧定｡ｨ遉ｺ縺吶ｋ
                                   </label>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="show-scroll-to-bottom-button-toggle">
                                       繝倥ャ繝繝ｼ縺ｫ縲梧怙荳矩Κ縺ｸ(反)縲阪・繧ｿ繝ｳ繧定｡ｨ遉ｺ縺吶ｋ
                                   </label>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="show-toggle-all-content-button-toggle">
                                       繝倥ャ繝繝ｼ縺ｫ縲悟・陦ｨ遉ｺ/髱櫁｡ｨ遉ｺ(名・・縲阪・繧ｿ繝ｳ繧定｡ｨ遉ｺ縺吶ｋ
                                   </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="show-memo-button-toggle">
                                        繝倥ャ繝繝ｼ縺ｫ繝｡繝｢繝懊ち繝ｳ(統)繧定｡ｨ遉ｺ縺吶ｋ
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="show-clipboard-stack-button-toggle">
                                        繝倥ャ繝繝ｼ縺ｫ繧ｯ繝ｪ繝・・繝懊・繝峨せ繧ｿ繝・け繝懊ち繝ｳ(嵐・・繧定｡ｨ遉ｺ縺吶ｋ
                                    </label>
                                    <div id="memo-stack-height-settings">
                                        <div>
                                            <label for="memo-height">繝｡繝｢繝ｻ繧ｹ繧ｿ繝・け縺ｮ邵ｦ縺ｮ蟷・(萓・ 200px, 30vh):</label>
                                            <input type="text" id="memo-height" placeholder="萓・ 200px, 30vh" aria-label="繝｡繝｢繝ｻ繧ｹ繧ｿ繝・け縺ｮ邵ｦ縺ｮ蟷・>
                                        </div>
                                        <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom:10px;">
                                            窶ｻ 蜷・お繝ｪ繧｢縺ｯ邵ｦ譁ｹ蜷代↓繝ｪ繧ｵ繧､繧ｺ蜿ｯ閭ｽ縺ｧ縺吶・                                        </p>
                                    </div>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="show-paste-button-in-footer-toggle">
                                       繝輔ャ繧ｿ繝ｼ縺ｫ縲瑚ｲｼ莉倥￠縲阪・繧ｿ繝ｳ繧定｡ｨ遉ｺ縺吶ｋ
                                   </label>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="show-dice-button-toggle">
                                       繝輔ャ繧ｿ繝ｼ縺ｫ繝繧､繧ｹ繝懊ち繝ｳ(軸)繧定｡ｨ遉ｺ縺吶ｋ
                                   </label>
                                    <div id="dice-value-settings" class="hidden" style="margin-top:5px;">
                                        <div class="param-grid">
                                            <div>
                                                <label for="dice-min-value">繝繧､繧ｹ譛蟆丞､:</label>
                                                <input type="number" id="dice-min-value" min="0" step="1" placeholder="萓・ 1">
                                            </div>
                                            <div>
                                                <label for="dice-max-value">繝繧､繧ｹ譛螟ｧ蛟､:</label>
                                                <input type="number" id="dice-max-value" min="0" step="1" placeholder="萓・ 100">
                                            </div>
                                        </div>
                                    </div>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="show-api-provider-toggle-header">
                                       繝倥ャ繝繝ｼ縺ｫAPI蛻・崛繝懊ち繝ｳ繧定｡ｨ遉ｺ縺吶ｋ
                                   </label>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="show-api-provider-toggle-footer">
                                       繝輔ャ繧ｿ繝ｼ縺ｫAPI蛻・崛繝懊ち繝ｳ繧定｡ｨ遉ｺ縺吶ｋ
                                   </label>
                                    <label class="checkbox-label" style="margin-top: 15px;">
                                        <input type="checkbox" id="show-paste-button-in-edit-toggle">
                                        繝｡繝・そ繝ｼ繧ｸ邱ｨ髮・ヤ繝ｼ繝ｫ繝舌・縺ｫ縲瑚ｲｼ莉倥￠縲阪・繧ｿ繝ｳ繧定｡ｨ遉ｺ縺吶ｋ
                                    </label>
                                    <label class="checkbox-label" style="margin-top: 15px;">
                                       <input type="checkbox" id="show-top-collapse-button-toggle">
                                       繝｡繝・そ繝ｼ繧ｸ蜿ｳ荳翫↓謚倥ｊ縺溘◆縺ｿ繝懊ち繝ｳ繧定｡ｨ遉ｺ縺吶ｋ
                                   </label>
                                    <label class="checkbox-label">
                                       <input type="checkbox" id="show-bottom-collapse-button-toggle">
                                       繝｡繝・そ繝ｼ繧ｸ繝・・繝ｫ繝舌・縺ｫ謚倥ｊ縺溘◆縺ｿ繝懊ち繝ｳ繧定｡ｨ遉ｺ縺吶ｋ
                                   </label>
                                   <details id="settings-group-collapse-button-details">
                                        <summary style="cursor: pointer; font-weight: normal; font-size: 14px; color: var(--text-link); list-style: revert;">謚倥ｊ縺溘◆縺ｿ繝懊ち繝ｳ隧ｳ邏ｰ險ｭ螳・/summary>
                                        <div style="padding-left: 15px; margin-top: 10px;">
                                            <label class="checkbox-label" style="margin-top: 10px; margin-bottom: 15px;">
                                                <input type="checkbox" id="persist-message-collapse-state">
                                                繝｡繝・そ繝ｼ繧ｸ縺ｮ謚倥ｊ逡ｳ縺ｿ迥ｶ諷九ｒ險俶・縺吶ｋ
                                            </label>
                                            <hr style="margin-bottom: 15px;">
                                            <label for="toggle-button-top-width">蜿ｳ荳翫・繧ｿ繝ｳ 讓ｪ蟷・(px):</label>
                                            <input type="number" id="toggle-button-top-width" min="1" max="100" step="1" placeholder="萓・ 6">
                                            <label for="toggle-button-top-height">蜿ｳ荳翫・繧ｿ繝ｳ 邵ｦ蟷・(px):</label>
                                            <input type="number" id="toggle-button-top-height" min="1" max="100" step="1" placeholder="萓・ 40">
                                            <label for="toggle-button-top-font-size">蜿ｳ荳翫・繧ｿ繝ｳ 繝輔か繝ｳ繝医し繧､繧ｺ (px):</label>
                                            <input type="number" id="toggle-button-top-font-size" min="1" max="50" step="1" placeholder="萓・ 12">
                                            <label for="toggle-button-top-text-collapse">蜿ｳ荳翫・繧ｿ繝ｳ 謚倥ｊ縺溘◆縺ｿ譎ゅユ繧ｭ繧ｹ繝・</label>
                                            <input type="text" id="toggle-button-top-text-collapse" placeholder="萓・ -">
                                            <label for="toggle-button-top-text-expand">蜿ｳ荳翫・繧ｿ繝ｳ 螻暮幕譎ゅユ繧ｭ繧ｹ繝・</label>
                                            <input type="text" id="toggle-button-top-text-expand" placeholder="萓・ 笆｡">

                                            <hr style="margin: 15px 0;">

                                            <label for="toggle-button-bottom-font-size">荳矩Κ繝懊ち繝ｳ 繝輔か繝ｳ繝医し繧､繧ｺ (px):</label>
                                            <input type="number" id="toggle-button-bottom-font-size" min="1" max="34" step="1" placeholder="萓・ 14">
                                            <label for="toggle-button-bottom-text-collapse">荳矩Κ繝懊ち繝ｳ 謚倥ｊ縺溘◆縺ｿ譎ゅユ繧ｭ繧ｹ繝・</label>
                                            <input type="text" id="toggle-button-bottom-text-collapse" placeholder="萓・ 髱櫁｡ｨ遉ｺ">
                                            <label for="toggle-button-bottom-text-expand">荳矩Κ繝懊ち繝ｳ 螻暮幕譎ゅユ繧ｭ繧ｹ繝・</label>
                                            <input type="text" id="toggle-button-bottom-text-expand" placeholder="萓・ 陦ｨ遉ｺ">
                                        </div>
                                   </details>
                                </div>
                           </details>

                           <details id="settings-group-font">
                                <summary style="font-size: 14px; color: var(--text-link); padding-bottom: 5px; margin-bottom: 10px; display: list-item; list-style: revert; cursor:pointer; font-weight: normal;">繝輔か繝ｳ繝郁ｨｭ螳・/summary>
                                <div style="padding-left: 15px; margin-top: 10px;">
                                   <label for="font-family-input">繧｢繝励Μ縺ｮ繝輔か繝ｳ繝・</label>
                                   <input type="text" id="font-family-input" placeholder="萓・ 'Meiryo', sans-serif" aria-label="繧｢繝励Μ蜈ｨ菴薙・繝輔か繝ｳ繝・>
                                   <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 5px;">
                                       窶ｻ 遶ｯ譛ｫ縺ｾ縺溘・PC縺ｫ繧､繝ｳ繧ｹ繝医・繝ｫ縺輔ｌ縺ｦ縺・ｋ繝輔か繝ｳ繝亥錐繧呈欠螳壹・                                   </p>
                                   <label for="message-body-font-size-input">繝｡繝・そ繝ｼ繧ｸ譛ｬ譁・・繝輔か繝ｳ繝医し繧､繧ｺ (px):</label>
                                   <input type="number" id="message-body-font-size-input" min="1" max="100" step="1" placeholder="萓・ 14 (繝・ヵ繧ｩ繝ｫ繝・" aria-label="繝｡繝・そ繝ｼ繧ｸ譛ｬ譁・・繝輔か繝ｳ繝医し繧､繧ｺ">
                                    <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                                        窶ｻ 遨ｺ谺・〒繝・ヵ繧ｩ繝ｫ繝・14px)縲・・・00px縺ｮ遽・峇縺ｧ謖・ｮ壼庄縲・                                    </p>
                                   <label for="code-block-font-size-input">繧ｳ繝ｼ繝峨ヶ繝ｭ繝・け縺ｮ繝輔か繝ｳ繝医し繧､繧ｺ (px):</label>
                                   <input type="number" id="code-block-font-size-input" min="1" max="100" step="1" placeholder="萓・ 13 (繝・ヵ繧ｩ繝ｫ繝・" aria-label="繧ｳ繝ｼ繝峨ヶ繝ｭ繝・け縺ｮ繝輔か繝ｳ繝医し繧､繧ｺ">
                                   <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                                       窶ｻ 遨ｺ谺・〒繝・ヵ繧ｩ繝ｫ繝・13px)縲・・・00px縺ｮ遽・峇縺ｧ謖・ｮ壼庄縲・                                   </p>
                                   <label for="thought-summary-font-size">諤晁・・繝ｭ繧ｻ繧ｹ 繝輔か繝ｳ繝医し繧､繧ｺ (px):</label>
                                   <input type="number" id="thought-summary-font-size" min="1" max="100" step="1" placeholder="萓・ 13 (繝・ヵ繧ｩ繝ｫ繝・" aria-label="諤晁・・繝ｭ繧ｻ繧ｹ 繝輔か繝ｳ繝医し繧､繧ｺ">
                                   <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                                       窶ｻ 遨ｺ谺・〒繝・ヵ繧ｩ繝ｫ繝・13px)縲・・・00px縺ｮ遽・峇縺ｧ謖・ｮ壼庄縲・                                   </p>
                                </div>
                           </details>
                           <details id="settings-group-opacity">
                                <summary style="font-size: 14px; color: var(--text-link); padding-bottom: 5px; margin-bottom: 10px; display: list-item; list-style: revert; cursor:pointer; font-weight: normal;">蜷・ｨｮ騾乗・蠎ｦ險ｭ螳・/summary>
                                <div style="padding-left: 15px; margin-top: 10px;">
                                    <label for="message-bubble-opacity">繝｡繝・そ繝ｼ繧ｸ繝舌ヶ繝ｫ縺ｮ騾乗・蠎ｦ (0.0-1.0):</label>
                                    <input type="number" id="message-bubble-opacity" min="0" max="1" step="0.05" placeholder="萓・ 0.8" aria-label="繝｡繝・そ繝ｼ繧ｸ繝舌ヶ繝ｫ縺ｮ騾乗・蠎ｦ">
                                    <label for="message-actions-background-opacity">繝｡繝・そ繝ｼ繧ｸ繝・・繝ｫ繝舌・縺ｮ騾乗・蠎ｦ・磯勁繝懊ち繝ｳ・・(0.0-1.0):</label>
                                    <input type="number" id="message-actions-background-opacity" min="0" max="1" step="0.05" placeholder="萓・ 0.8" aria-label="繝｡繝・そ繝ｼ繧ｸ繝・・繝ｫ繝舌・縺ｮ騾乗・蠎ｦ・磯勁繝懊ち繝ｳ・・>
                                    <label for="chat-overlay-opacity">繝√Ε繝・ヨ閭梧勹繧ｪ繝ｼ繝舌・繝ｬ繧､縺ｮ騾乗・蠎ｦ (0.0-1.0):</label>
                                    <input type="number" id="chat-overlay-opacity" min="0" max="1" step="0.05" placeholder="萓・ 0.6" aria-label="繝√Ε繝・ヨ閭梧勹繧ｪ繝ｼ繝舌・繝ｬ繧､縺ｮ騾乗・蠎ｦ">
                                    <label for="header-footer-opacity">繝倥ャ繝繝ｼ/繝輔ャ繧ｿ繝ｼ縺ｮ騾乗・蠎ｦ (0.0-1.0):</label>
                                    <input type="number" id="header-footer-opacity" min="0" max="1" step="0.05" placeholder="萓・ 0.9" aria-label="繝倥ャ繝繝ｼ/繝輔ャ繧ｿ繝ｼ縺ｮ騾乗・蠎ｦ">
                                    <label for="toggle-button-top-opacity">蜿ｳ荳頑釜繧翫◆縺溘∩繝懊ち繝ｳ縺ｮ騾乗・蠎ｦ (0.0-1.0):</label>
                                    <input type="number" id="toggle-button-top-opacity" min="0" max="1" step="0.05" placeholder="萓・ 0.6" aria-label="蜿ｳ荳頑釜繧翫◆縺溘∩繝懊ち繝ｳ縺ｮ騾乗・蠎ｦ">
                                    <label for="thought-summary-opacity" style="margin-top:10px;">諤晁・・繝ｭ繧ｻ繧ｹ閭梧勹縺ｮ騾乗・蠎ｦ (0.0-1.0):</label>
                                    <input type="number" id="thought-summary-opacity" min="0" max="1" step="0.05" placeholder="萓・ 0.85" aria-label="諤晁・・繝ｭ繧ｻ繧ｹ閭梧勹縺ｮ騾乗・蠎ｦ">
                                    <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px;">
                                      窶ｻ 0.0縺ｧ螳悟・騾乗・縲・.0縺ｧ荳埼乗・縲・                                    </p>
                                </div>
                           </details>
                        </div>
                   </details>
                </div>
                 <details class="settings-group" id="settings-group-session-linking">
                    <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">AI髢謎ｼ夊ｩｱ繝｢繝ｼ繝会ｼ医そ繝・す繝ｧ繝ｳ髢薙Μ繝ｳ繧ｯ・・/summary>
                    <div style="margin-top:10px;">
                        <label class="checkbox-label">
                            <input type="checkbox" id="enable-session-linking">
                            繧ｻ繝・す繝ｧ繝ｳ髢薙Μ繝ｳ繧ｯ讖溯・繧呈怏蜉ｹ縺ｫ縺吶ｋ
                        </label>
                        <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                            窶ｻ 譛牙柑縺ｫ縺吶ｋ縺ｨ縲∝ｱ･豁ｴ逕ｻ髱｢縺ｧ2縺､縺ｮ繧ｻ繝・す繝ｧ繝ｳ繧偵Μ繝ｳ繧ｯ縺励、I蜷悟｣ｫ縺ｮ莨夊ｩｱ繧偵せ繝・ャ繝怜ｮ溯｡後〒縺阪∪縺吶ゑｼ芋汨･繝懊ち繝ｳ繧堤畑縺・◆蜈･蜃ｺ蜉帙・縺ｿ縲ゑｼ・br>
                            窶ｻ Max Tokens縺瑚ｶｳ繧翫↑縺・→螟ｱ謨励＠縺ｾ縺吶・                        </p>
                               <p style="height:10px"></p>
                               <label class="checkbox-label">
                                   <input type="checkbox" id="disable-load-chat-confirmation-while-sending-toggle">
                                   繝｡繝・そ繝ｼ繧ｸ騾∽ｿ｡荳ｭ縺ｫ蛻･繝√Ε繝・ヨ繧定ｪｭ縺ｿ霎ｼ繧髫帙・遒ｺ隱阪ム繧､繧｢繝ｭ繧ｰ繧定｡ｨ遉ｺ縺励↑縺・(髱樊耳螂ｨ)
                               </label>
                    </div>
                </details>

                <div class="danger-zone">

                     <p style="text-align: center; color: var(--text-secondary); font-size: 12px; margin-bottom: 10px;">
                         繝舌・繧ｸ繝ｧ繝ｳ: <span id="app-version"></span>
                     </p>
                     <button id="update-app-btn">繧｢繝励Μ繧呈峩譁ｰ (繧ｭ繝｣繝・す繝･繧ｯ繝ｪ繧｢)</button>
                     <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px; text-align:center;">
                         窶ｻ 繧ｵ繝ｼ繝舌・蛛ｴ縺ｮhtml繝輔ぃ繧､繝ｫ縺ｪ縺ｩ縺ｯ繝悶Λ繧ｦ繧ｶ縺ｫ繧ｭ繝｣繝・す繝･縺輔ｌ繧九◆繧√・BR>
                         縺薙・繝懊ち繝ｳ縺ｧ譏守､ｺ逧・↓繧ｵ繝ｼ繝舌・縺九ｉ蜀榊叙蠕励＠縺ｪ縺・剞繧頑峩譁ｰ縺輔ｌ縺ｪ縺・・                     </p>
                     <details id="settings-group-danger-zone-details">
                         <summary style="cursor: pointer; font-weight: normal; font-size: 14px; color: var(--text-link); margin-bottom: 10px; display: block; text-align: center;">窶ｻ蜿悶ｊ謇ｱ縺・ｳｨ諢城・岼窶ｻ</summary>
                         <label class="checkbox-label" style="margin-top: 10px; margin-bottom: 5px;">
                             <input type="checkbox" id="disable-save-settings-confirmation-toggle">
                             縲瑚ｨｭ螳壹ｒ菫晏ｭ倥＠縺ｾ縺励◆縲埼夂衍繧堤┌蜉ｹ縺ｫ縺吶ｋ
                         </label>
                         <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 15px;">
                             窶ｻ 險ｭ螳壻ｿ晏ｭ俶凾縺ｮ遒ｺ隱阪ム繧､繧｢繝ｭ繧ｰ繧定｡ｨ遉ｺ縺励∪縺帙ｓ縲・                         </p>
                         <label class="checkbox-label" style="margin-top: 10px; margin-bottom: 5px;">
                             <input type="checkbox" id="auto-save-settings-toggle">
                             險ｭ螳壹ｒ蜊ｳ譎ょ渚譏縺吶ｋ
                         </label>
                         <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 15px;">
                             窶ｻ 縲瑚ｨｭ螳壹ｒ菫晏ｭ倥阪・繧ｿ繝ｳ繧呈款縺輔★縺ｨ繧ゅ∬ｨｭ螳壹・螟画峩縺檎峩縺｡縺ｫ驕ｩ逕ｨ縺輔ｌ縺ｾ縺吶・                         </p>
                         <hr style="margin: 15px 0;">
                         <button id="force-recovery-btn" class="orange-button">売 蠑ｷ蛻ｶ蠕ｩ譌ｧ (繧ｭ繝｣繝・す繝･繧ｯ繝ｪ繧｢&繝ｪ繝ｭ繝ｼ繝・</button>
                         <p style="font-size: 11px; color: var(--text-secondary); margin-top:5px; margin-bottom: 10px;">
                             窶ｻ 繧｢繝励Μ縺御ｸ榊ｮ牙ｮ壹↑蝣ｴ蜷医↓菴ｿ逕ｨ縲ょ・繧ｭ繝｣繝・す繝･繧偵け繝ｪ繧｢縺励※蠑ｷ蛻ｶ逧・↓蜀崎ｵｷ蜍輔＠縺ｾ縺吶ゅ後い繝励Μ繧呈峩譁ｰ縲阪・蜃ｦ逅・↓蜉縺医※縲√ヶ繝ｩ繧ｦ繧ｶ縺御ｿ晄戟縺励※縺・ｋ縺薙・縲隈eminiPWA縲阪い繝励Μ縺ｫ髢｢騾｣縺吶ｋ莉悶・遞ｮ鬘槭・繧ｭ繝｣繝・す繝･繧ょ庄閭ｽ縺ｪ髯舌ｊ蜑企勁縺励∪縺吶・br>
                             窶ｻ 繝ｦ繝ｼ繧ｶ繝ｼ繝・・繧ｿ・医メ繝｣繝・ヨ螻･豁ｴ繝ｻ險ｭ螳夲ｼ峨・菫晄戟縺輔ｌ縺ｾ縺吶・                         </p>
                         <button id="clear-history-btn" class="orange-button">蜈ｨ螻･豁ｴ蜑企勁</button>
                         <p style="font-size: 11px; color: var(--text-secondary); margin-top:5px; margin-bottom: 10px;">
                             窶ｻ 繝悶Λ繧ｦ繧ｶ縺ｫ菫晏ｭ倥＆繧後※縺・ｋ繝√Ε繝・ヨ螻･豁ｴ繧貞・縺ｦ蜑企勁縺励∪縺吶りｨｭ螳壹・菫晄戟縺輔ｌ縺ｾ縺吶・BR>
                         </p>
                         <button id="clear-data-btn">笞笞笞蜈ｨ繝・・繧ｿ繧ｯ繝ｪ繧｢ (螻･豁ｴ縺ｨ險ｭ螳・笞笞笞</button>
                         <p style="font-size: 11px; color: var(--text-secondary); margin-top:5px; margin-bottom: 10px;">
                             窶ｻ 繝悶Λ繧ｦ繧ｶ縺ｫ菫晏ｭ倥＆繧後※縺・ｋ險ｭ螳壹ｄ螻･豁ｴ繧貞・縺ｦ蜑企勁縲・BR>
                             ・・ｼ・俣驕輔∴縺ｦ謚ｼ縺昴≧縺ｨ縺励※縺・↑縺・°豕ｨ諢擾ｼ・ｼ・                         </p>
                     </details>
                </div>
            </main>
        </div>
    </div>

    <dialog id="alertDialog" class="custom-dialog">
        <p class="dialog-message"></p>
        <div class="dialog-actions">
            <button value="ok" class="dialog-ok-btn">OK</button>
        </div>
    </dialog>

    <dialog id="confirmDialog" class="custom-dialog">
        <p class="dialog-message"></p>
        <div class="dialog-actions">
            <button value="cancel" class="dialog-cancel-btn">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
            <button value="ok" class="dialog-ok-btn">OK</button>
        </div>
    </dialog>

    <dialog id="promptDialog" class="custom-dialog">
        <label class="dialog-message" for="promptInput"></label>
        <input type="text" id="promptInput" class="dialog-input">
        <div class="dialog-actions">
            <button value="cancel" class="dialog-cancel-btn">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
            <button value="ok" class="dialog-ok-btn">OK</button>
        </div>
    </dialog>

    <dialog id="fileUploadDialog" class="custom-dialog">
        <div class="dialog-content">
            <div class="file-upload-area">
                <input type="file" id="file-input" multiple accept="image/*,text/*,application/pdf,video/*,audio/*,.txt,.md,.csv,.json,.html,.css,.js,.py" class="hidden">
                <button id="select-files-btn" class="dialog-button">繝輔ぃ繧､繝ｫ繧帝∈謚・/button>
            </div>
            <ul id="selected-files-list">
            </ul>
            <p id="file-upload-notice">逕ｻ蜒上√ユ繧ｭ繧ｹ繝医￣DF縲∝虚逕ｻ縲・浹螢ｰ縺ｪ縺ｩ繧呈ｷｻ莉伜庄閭ｽ</p>
        </div>
        <div class="dialog-actions">
            <button id="cancel-attach-btn" value="cancel" class="dialog-cancel-btn">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
            <button id="confirm-attach-btn" value="ok" class="dialog-ok-btn" disabled>豺ｻ莉倥＠縺ｦ髢峨§繧・/button>
        </div>
    </dialog>
    <dialog id="imagePreviewDialog" class="custom-dialog">
        <div class="dialog-content">
            <img src="" alt="逕ｻ蜒上・繝ｬ繝薙Η繝ｼ">
        </div>
        <div class="dialog-actions">
            <button value="ok" class="dialog-ok-btn">髢峨§繧・/button>
        </div>
    </dialog>

    <script>
        const DB_NAME = 'GeminiPWA_DB';
        const DB_VERSION = 8;
        const SETTINGS_STORE = 'settings';
        const CHATS_STORE = 'chats';
        const CHAT_UPDATEDAT_INDEX = 'updatedAtIndex';
        const CHAT_CREATEDAT_INDEX = 'createdAtIndex';
        const DEFAULT_MODEL = 'gemini-2.5-flash-preview-05-20';
        const DEFAULT_DEEPSEEK_MODEL = 'deepseek-reasoner';
        const DEFAULT_CLAUDE_MODEL = 'claude-3-7-sonnet-20250219';
        const DEFAULT_OPENAI_MODEL = 'gpt-3.5-turbo';
        const DEFAULT_XAI_MODEL = 'grok-3-mini';
        const DEFAULT_LLMAGGREGATOR_MODEL = 'meta-llama/llama-4-maverick-17b-128e-instruct:free';
        const DEFAULT_STREAMING_SPEED = 12;
        const DEFAULT_TEMPERATURE = 0.5;
        const DEFAULT_MAX_TOKENS = 4000;
        const DEFAULT_TOP_K = 40;
        const DEFAULT_TOP_P = 0.95;
        const DEFAULT_CLAUDE_TEMPERATURE = 0.7;
        const DEFAULT_CLAUDE_MAX_TOKENS = 4096;
        const DEFAULT_CLAUDE_TOP_P = 1.0;
        const DEFAULT_FONT_FAMILY = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif';
        const DEFAULT_MESSAGE_BODY_FONT_SIZE = 14;
        const DEFAULT_CODE_BLOCK_FONT_SIZE = 13;
        const DEFAULT_MEMO_HEIGHT = '300px';
        const DEFAULT_CLIPBOARD_STACK_HEIGHT = '300px';
        const DEFAULT_MESSAGE_ICON_SIZE = 50;
        const DEFAULT_MESSAGE_ICON_OFFSET_Y = -30;
        const DEFAULT_USER_NAME = "";
        const DEFAULT_AI_NAME = "AI";
        const DEFAULT_ICON_NAME_FONT_SIZE = 15;
        const DEFAULT_ICON_NAME_OFFSET_Y = -30;
        const DEFAULT_USER_NAME_BUBBLE_COLOR = '#FFFFFF';
        const DEFAULT_USER_NAME_BUBBLE_OPACITY = 0.8;
        const DEFAULT_AI_NAME_BUBBLE_COLOR = '#FFFFFF';
        const DEFAULT_AI_NAME_BUBBLE_OPACITY = 0.8;
        const CHAT_TITLE_LENGTH = 15;
        const TEXTAREA_MAX_HEIGHT = 120;
        const GEMINI_API_BASE_URL = 'https://generativelanguage.googleapis.com/v1beta/models/';
        const DEEPSEEK_API_DEFAULT_BASE_URL = 'https://api.deepseek.com';
        const CLAUDE_API_BASE_URL = 'https://api.anthropic.com/v1/messages';
        const OPENAI_API_BASE_URL = 'https://api.openai.com/v1/chat/completions';
        const XAI_API_BASE_URL = 'https://api.x.ai/v1/chat/completions';
        const DUPLICATE_SUFFIX = ' (繧ｳ繝斐・)';
        const IMPORT_PREFIX = '(蜿冶ｾｼ) ';

        const LIGHT_THEME_COLOR = '#4a90e2';
        const DARK_THEME_COLOR = '#007aff';
        const PASTEL_PINK_THEME_COLOR = '#ff8fab';
        const PASTEL_BLUE_THEME_COLOR = '#87cefa';
        const PASTEL_YELLOW_THEME_COLOR = '#ffd700';
        const PASTEL_PURPLE_THEME_COLOR = '#ab47bc';
        const PASTEL_RAINBOW_THEME_COLOR = '#ffadad';

        const DARK_MODE_USER_MESSAGE_COLOR = '#056162';
        const DARK_MODE_MODEL_MESSAGE_COLOR = '#3a3a3c';
        const DARK_MODE_SECONDARY_COLOR = '#101010';
        const DARK_MODE_PRIMARY_COLOR = '#1a1a1a';

        const PASTEL_PINK_USER_MESSAGE_COLOR = '#ffddee';
        const PASTEL_PINK_MODEL_MESSAGE_COLOR = '#f3e8ff';
        const PASTEL_PINK_SECONDARY_COLOR = '#ffe6ea';
        const PASTEL_PINK_HEADER_COLOR = '#ff8fab';
        const PASTEL_PINK_PRIMARY_COLOR = '#fff5f8';

        const PASTEL_BLUE_USER_MESSAGE_COLOR = '#cff1ef';
        const PASTEL_BLUE_MODEL_MESSAGE_COLOR = '#e0e8ff';
        const PASTEL_BLUE_SECONDARY_COLOR = '#e0f0ff';
        const PASTEL_BLUE_HEADER_COLOR = '#87cefa';
        const PASTEL_BLUE_PRIMARY_COLOR = '#f0f8ff';

        const PASTEL_YELLOW_USER_MESSAGE_COLOR = '#fff5ba';
        const PASTEL_YELLOW_MODEL_MESSAGE_COLOR = '#ffe4b5';
        const PASTEL_YELLOW_SECONDARY_COLOR = '#fffacd';
        const PASTEL_YELLOW_HEADER_COLOR = '#ffd700';
        const PASTEL_YELLOW_PRIMARY_COLOR = '#fffefa';

        const PASTEL_PURPLE_USER_MESSAGE_COLOR = '#d1c4e9';
        const PASTEL_PURPLE_MODEL_MESSAGE_COLOR = '#c5cae9';
        const PASTEL_PURPLE_SECONDARY_COLOR = '#e1bee7';
        const PASTEL_PURPLE_HEADER_COLOR = '#ab47bc';
        const PASTEL_PURPLE_PRIMARY_COLOR = '#f3e5f5';

        const PASTEL_RAINBOW_USER_MESSAGE_COLOR = '#e0fff0';
        const PASTEL_RAINBOW_MODEL_MESSAGE_COLOR = '#e0f0ff';
        const PASTEL_RAINBOW_SECONDARY_COLOR = '#f0f0f0';
        const PASTEL_RAINBOW_HEADER_COLOR = '#ffadad';
        const PASTEL_RAINBOW_PRIMARY_COLOR = '#fdfdfd';

        const LIGHT_MODE_USER_MESSAGE_COLOR = '#dcf8c6';
        const LIGHT_MODE_MODEL_MESSAGE_COLOR = '#e5e5ea';
        const LIGHT_MODE_SECONDARY_COLOR = '#f0f2f5';
        const LIGHT_MODE_HEADER_COLOR = '#4a90e2';
        const LIGHT_MODE_PRIMARY_COLOR = '#ffffff';

        const APP_VERSION = "0.26ti";
        const SWIPE_THRESHOLD = 50;
        const ZOOM_THRESHOLD = 1.01;
        const MAX_FILE_SIZE = 10 * 1024 * 1024;
        const MAX_TOTAL_ATTACHMENT_SIZE = 50 * 1024 * 1024;
        const COLLAPSED_HEIGHT = 50;
        const DEFAULT_MESSAGE_BUBBLE_OPACITY = 0.9;
        const DEFAULT_MESSAGE_ACTIONS_BACKGROUND_OPACITY = 0.9;
        const DEFAULT_HEADER_FOOTER_OPACITY = 0.35;
        const DEFAULT_CHAT_OVERLAY_OPACITY = 0.7;

        const DEFAULT_TOGGLE_BUTTON_TOP_WIDTH = 6;
        const DEFAULT_TOGGLE_BUTTON_TOP_HEIGHT = 40;
        const DEFAULT_TOGGLE_BUTTON_TOP_FONT_SIZE = 12;
        const DEFAULT_TOGGLE_BUTTON_TOP_OPACITY = 0.6;
        const DEFAULT_TOGGLE_BUTTON_TOP_TEXT_COLLAPSE = "-";
        const DEFAULT_TOGGLE_BUTTON_TOP_TEXT_EXPAND = "笳ｻ・・;
        const DEFAULT_TOGGLE_BUTTON_BOTTOM_FONT_SIZE = 14;
        const DEFAULT_TOGGLE_BUTTON_BOTTOM_TEXT_COLLAPSE = "_";
        const DEFAULT_TOGGLE_BUTTON_BOTTOM_TEXT_EXPAND = "笆｡";
        const DEFAULT_AUTO_SCROLL_ON_NEW_MESSAGE = true;
        const DEFAULT_PERSIST_MESSAGE_COLLAPSE_STATE = true;
        const DEFAULT_DICE_MIN_VALUE = 1;
        const DEFAULT_DICE_MAX_VALUE = 100;
        const DEFAULT_THOUGHT_SUMMARY_OPACITY = 0.65;
        const DEFAULT_THOUGHT_SUMMARY_FONT_SIZE = 13;
        
        const ALLOWED_LLMAGGREGATOR_DOMAINS = [
            'openrouter.ai',
            'vercel.com',
            'endpoints.anyscale.com',
            'together.ai',
            'console.groq.com',
            'fireworks.ai',
            'huggingface.co',
            'deepinfra.com'
        ];

        const extensionToMimeTypeMap = {
            'pdf': 'application/pdf', 'js': 'text/javascript', 'py': 'text/x-python',
            'txt': 'text/plain', 'html': 'text/html', 'htm': 'text/html', 'css': 'text/css',
            'md': 'text/md', 'csv': 'text/csv', 'xml': 'text/xml', 'rtf': 'text/rtf',
            'png': 'image/png', 'jpg': 'image/jpeg', 'jpeg': 'image/jpeg', 'webp': 'image/webp',
            'heic': 'image/heic', 'heif': 'image/heif',
            'mp4': 'video/mp4', 'mpeg': 'video/mpeg', 'mov': 'video/mov', 'avi': 'video/avi',
            'flv': 'video/x-flv', 'mpg': 'video/mpg', 'webm': 'video/webm', 'wmv': 'video/wmv',
            '3gp': 'video/3gpp', '3gpp': 'video/3gpp',
            'wav': 'audio/wav', 'mp3': 'audio/mp3', 'aiff': 'audio/aiff', 'aac': 'audio/aac',
            'ogg': 'audio/ogg', 'flac': 'audio/flac',
        };

        const elements = {
            appContainer: document.querySelector('.app-container'),
            homeScreen: document.getElementById('home-screen'),
            chatScreen: document.getElementById('chat-screen'),
            historyScreen: document.getElementById('history-screen'),
            promptSetupScreen: document.getElementById('prompt-setup-screen'),
            settingsScreen: document.getElementById('settings-screen'),
            chatTitle: document.getElementById('chat-title'),
            messageContainer: document.getElementById('message-container'),
            userInput: document.getElementById('user-input'),
            sendButton: document.getElementById('send-button'),
            loadingIndicator: document.getElementById('loading-indicator'),
            historyList: document.getElementById('history-list'),
            historyTitle: document.getElementById('history-title'),
            noHistoryMessage: document.getElementById('no-history-message'),
            historyItemTemplate: document.querySelector('.js-history-item-template'),
            themeColorMeta: document.getElementById('theme-color-meta'),
            apiProviderSelect: document.getElementById('api-provider-select'),
            commonSystemPromptDefaultTextarea: document.getElementById('common-system-prompt-default'),
            enableCommonSystemPromptDefaultCheckbox: document.getElementById('enable-common-system-prompt-default'),
            geminiSettingsGroup: document.getElementById('gemini-settings-group'),
            geminiApiKeyInput: document.getElementById('gemini-api-key'),
            geminiModelNameSelect: document.getElementById('gemini-model-name'),
            geminiUserDefinedModelsGroup: document.getElementById('gemini-user-defined-models-group'),
            geminiAdditionalModelsTextarea: document.getElementById('gemini-additional-models'),
            deepSeekSettingsGroup: document.getElementById('deepseek-settings-group'),
            deepSeekApiKeyInput: document.getElementById('deepseek-api-key'),
            deepSeekModelNameSelect: document.getElementById('deepseek-model-name'),
            deepSeekUserDefinedModelsGroup: document.getElementById('deepseek-user-defined-models-group'),
            deepSeekAdditionalModelsTextarea: document.getElementById('deepseek-additional-models'),
            deepSeekApiEndpointInput: document.getElementById('deepseek-api-endpoint'),
            claudeSettingsGroup: document.getElementById('claude-settings-group'),
            claudeApiKeyInput: document.getElementById('claude-api-key'),
            claudeModelNameSelect: document.getElementById('claude-model-name'),
            claudeUserDefinedModelsGroup: document.getElementById('claude-user-defined-models-group'),
            claudeAdditionalModelsTextarea: document.getElementById('claude-additional-models'),
            openaiSettingsGroup: document.getElementById('openai-settings-group'),
            openaiApiKeyInput: document.getElementById('openai-api-key'),
            openaiModelNameSelect: document.getElementById('openai-model-name'),
            openaiAdditionalModelsTextarea: document.getElementById('openai-additional-models'),
            xaiSettingsGroup: document.getElementById('xai-settings-group'),
            xaiApiKeyInput: document.getElementById('xai-api-key'),
            xaiModelNameSelect: document.getElementById('xai-model-name'),
            xaiUserDefinedModelsGroup: document.getElementById('xai-user-defined-models-group'),
            xaiAdditionalModelsTextarea: document.getElementById('xai-additional-models'),
            llmAggregatorSettingsGroup: document.getElementById('llmaggregator-settings-group'),
            llmAggregatorApiBackendInput: document.getElementById('llmaggregator-api-backend'),
            llmAggregatorUrlError: document.getElementById('llmaggregator-url-error'),
            llmAggregatorApiKeyInput: document.getElementById('llmaggregator-api-key'),
            llmAggregatorModelNameSelect: document.getElementById('llmaggregator-model-name'),
            llmAggregatorUserDefinedModelsGroup: document.getElementById('llmaggregator-user-defined-models-group'),
            llmAggregatorAdditionalModelsTextarea: document.getElementById('llmaggregator-additional-models'),
            
            geminiParamsGroup: document.getElementById('gemini-params-group'),
            deepseekParamsGroup: document.getElementById('deepseek-params-group'),
            claudeParamsGroup: document.getElementById('claude-params-group'),
            openaiParamsGroup: document.getElementById('openai-params-group'),
            xaiParamsGroup: document.getElementById('xai-params-group'),
            llmAggregatorParamsGroup: document.getElementById('llmaggregator-params-group'),

            geminiAdvancedGroup: document.getElementById('gemini-advanced-group'),
            deepseekAdvancedGroup: document.getElementById('deepseek-advanced-group'),
            claudeAdvancedGroup: document.getElementById('claude-advanced-group'),
            openaiAdvancedGroup: document.getElementById('openai-advanced-group'),
            xaiAdvancedGroup: document.getElementById('xai-advanced-group'),
            llmAggregatorAdvancedGroup: document.getElementById('llmaggregator-advanced-group'),
            dummySettingsGroup: document.getElementById('dummy-settings-group'),

            geminiSystemPromptDefaultTextarea: document.getElementById('gemini-system-prompt-default'),
            geminiEnableSystemPromptDefaultCheckbox: document.getElementById('gemini-enable-system-prompt-default'),
            geminiTemperatureInput: document.getElementById('gemini-temperature'),
            geminiMaxTokensInput: document.getElementById('gemini-max-tokens'),
            geminiTopKInput: document.getElementById('gemini-top-k'),
            geminiTopPInput: document.getElementById('gemini-top-p'),
            geminiPresencePenaltyInput: document.getElementById('gemini-presence-penalty'),
            geminiFrequencyPenaltyInput: document.getElementById('gemini-frequency-penalty'),
            geminiThinkingBudgetInput: document.getElementById('gemini-thinking-budget'),
            geminiIncludeThoughtsToggle: document.getElementById('gemini-include-thoughts-toggle'),
            geminiExpandThoughtsByDefaultToggle: document.getElementById('gemini-expand-thoughts-by-default-toggle'),
            geminiStreamingOutputCheckbox: document.getElementById('gemini-streaming-output'),
            geminiStreamingSpeedInput: document.getElementById('gemini-streaming-speed'),
            geminiDummyUserInput: document.getElementById('gemini-dummy-user'),
            geminiEnableDummyUserCheckbox: document.getElementById('gemini-enable-dummy-user'),
            geminiDummyModelInput: document.getElementById('gemini-dummy-model'),
            geminiEnableDummyModelCheckbox: document.getElementById('gemini-enable-dummy-model'),
            geminiConcatDummyModelCheckbox: document.getElementById('gemini-concat-dummy-model'),
            geminiPseudoStreamingCheckbox: document.getElementById('gemini-pseudo-streaming'),
            geminiEnableGroundingToggle: document.getElementById('gemini-enable-grounding-toggle'),

            deepSeekSystemPromptDefaultTextarea: document.getElementById('deepseek-system-prompt-default'),
            deepSeekEnableSystemPromptDefaultCheckbox: document.getElementById('deepseek-enable-system-prompt-default'),
            deepSeekMaxTokensInput: document.getElementById('deepseek-max-tokens'),
            deepSeekTemperatureInput: document.getElementById('deepseek-temperature'),
            deepSeekTopPInput: document.getElementById('deepseek-top-p'),
            deepSeekPresencePenaltyInput: document.getElementById('deepseek-presence-penalty'),
            deepSeekFrequencyPenaltyInput: document.getElementById('deepseek-frequency-penalty'),
            deepSeekIncludeThoughtsToggle: document.getElementById('deepseek-include-thoughts-toggle'),
            deepSeekExpandThoughtsByDefaultToggle: document.getElementById('deepseek-expand-thoughts-by-default-toggle'),
            deepSeekStreamingOutputCheckbox: document.getElementById('deepseek-streaming-output'),
            deepSeekStreamingSpeedInput: document.getElementById('deepseek-streaming-speed'),
            deepSeekDummyUserInput: document.getElementById('deepseek-dummy-user'),
            deepSeekEnableDummyUserCheckbox: document.getElementById('deepseek-enable-dummy-user'),
            deepSeekDummyModelInput: document.getElementById('deepseek-dummy-model'),
            deepSeekEnableDummyModelCheckbox: document.getElementById('deepseek-enable-dummy-model'),
            deepSeekConcatDummyModelCheckbox: document.getElementById('deepseek-concat-dummy-model'),

            claudeSystemPromptDefaultTextarea: document.getElementById('claude-system-prompt-default'),
            claudeEnableSystemPromptDefaultCheckbox: document.getElementById('claude-enable-system-prompt-default'),
            claudeMaxTokensInput: document.getElementById('claude-max-tokens'),
            claudeTemperatureInput: document.getElementById('claude-temperature'),
            claudeTopKInput: document.getElementById('claude-top-k'),
            claudeTopPInput: document.getElementById('claude-top-p'),
            claudeStreamingOutputCheckbox: document.getElementById('claude-streaming-output'),
            claudeStreamingSpeedInput: document.getElementById('claude-streaming-speed'),
            claudeDummyUserInput: document.getElementById('claude-dummy-user'),
            claudeEnableDummyUserCheckbox: document.getElementById('claude-enable-dummy-user'),
            claudeDummyModelInput: document.getElementById('claude-dummy-model'),
            claudeEnableDummyModelCheckbox: document.getElementById('claude-enable-dummy-model'),
            claudeConcatDummyModelCheckbox: document.getElementById('claude-concat-dummy-model'),
            claudeIncludeThoughtsToggle: document.getElementById('claude-include-thoughts-toggle'),
            claudeExpandThoughtsByDefaultToggle: document.getElementById('claude-expand-thoughts-by-default-toggle'),
            claudeThinkingBudgetInput: document.getElementById('claude-thinking-budget'),

            openaiSystemPromptDefaultTextarea: document.getElementById('openai-system-prompt-default'),
            openaiEnableSystemPromptDefaultCheckbox: document.getElementById('openai-enable-system-prompt-default'),
            openaiMaxTokensInput: document.getElementById('openai-max-tokens'),
            openaiTemperatureInput: document.getElementById('openai-temperature'),
            openaiTopPInput: document.getElementById('openai-top-p'),
            openaiPresencePenaltyInput: document.getElementById('openai-presence-penalty'),
            openaiFrequencyPenaltyInput: document.getElementById('openai-frequency-penalty'),
            openaiStreamingOutputCheckbox: document.getElementById('openai-streaming-output'),
            openaiStreamingSpeedInput: document.getElementById('openai-streaming-speed'),
            openaiDummyUserInput: document.getElementById('openai-dummy-user'),
            openaiEnableDummyUserCheckbox: document.getElementById('openai-enable-dummy-user'),
            openaiDummyModelInput: document.getElementById('openai-dummy-model'),
            openaiEnableDummyModelCheckbox: document.getElementById('openai-enable-dummy-model'),
            openaiConcatDummyModelCheckbox: document.getElementById('openai-concat-dummy-model'),
            
            xaiSystemPromptDefaultTextarea: document.getElementById('xai-system-prompt-default'),
            xaiEnableSystemPromptDefaultCheckbox: document.getElementById('xai-enable-system-prompt-default'),
            xaiMaxTokensInput: document.getElementById('xai-max-tokens'),
            xaiTemperatureInput: document.getElementById('xai-temperature'),
            xaiTopPInput: document.getElementById('xai-top-p'),
            xaiPresencePenaltyInput: document.getElementById('xai-presence-penalty'),
            xaiFrequencyPenaltyInput: document.getElementById('xai-frequency-penalty'),
            xaiStreamingOutputCheckbox: document.getElementById('xai-streaming-output'),
            xaiStreamingSpeedInput: document.getElementById('xai-streaming-speed'),
            xaiDummyUserInput: document.getElementById('xai-dummy-user'),
            xaiEnableDummyUserCheckbox: document.getElementById('xai-enable-dummy-user'),
            xaiDummyModelInput: document.getElementById('xai-dummy-model'),
            xaiEnableDummyModelCheckbox: document.getElementById('xai-enable-dummy-model'),
            xaiConcatDummyModelCheckbox: document.getElementById('xai-concat-dummy-model'),
            xaiVisionEnableCheckbox: document.getElementById('xai-vision-enable'),
            xaiIncludeThoughtsToggle: document.getElementById('xai-include-thoughts-toggle'),
            xaiExpandThoughtsByDefaultToggle: document.getElementById('xai-expand-thoughts-by-default-toggle'),
            xaiReasoningEffortSelect: document.getElementById('xai-reasoning-effort'),
            
            llmAggregatorSystemPromptDefaultTextarea: document.getElementById('llmaggregator-system-prompt-default'),
            llmAggregatorEnableSystemPromptDefaultCheckbox: document.getElementById('llmaggregator-enable-system-prompt-default'),
            llmAggregatorMaxTokensInput: document.getElementById('llmaggregator-max-tokens'),
            llmAggregatorTemperatureInput: document.getElementById('llmaggregator-temperature'),
            llmAggregatorTopPInput: document.getElementById('llmaggregator-top-p'),
            llmAggregatorTopKInput: document.getElementById('llmaggregator-top-k'),
            llmAggregatorPresencePenaltyInput: document.getElementById('llmaggregator-presence-penalty'),
            llmAggregatorFrequencyPenaltyInput: document.getElementById('llmaggregator-frequency-penalty'),
            llmAggregatorIncludeThoughtsToggle: document.getElementById('llmaggregator-include-thoughts-toggle'),
            llmAggregatorExpandThoughtsByDefaultToggle: document.getElementById('llmaggregator-expand-thoughts-by-default-toggle'),
            llmAggregatorStreamingOutputCheckbox: document.getElementById('llmaggregator-streaming-output'),
            llmAggregatorStreamingSpeedInput: document.getElementById('llmaggregator-streaming-speed'),
            llmAggregatorDummyUserInput: document.getElementById('llmaggregator-dummy-user'),
            llmAggregatorEnableDummyUserCheckbox: document.getElementById('llmaggregator-enable-dummy-user'),
            llmAggregatorDummyModelInput: document.getElementById('llmaggregator-dummy-model'),
            llmAggregatorEnableDummyModelCheckbox: document.getElementById('llmaggregator-enable-dummy-model'),
            llmAggregatorConcatDummyModelCheckbox: document.getElementById('llmaggregator-concat-dummy-model'),

            setThinkingBudgetBtns: document.querySelectorAll('.set-thinking-budget-btn'),
            setClaudeParamBtns: document.querySelectorAll('.set-claude-param-btn'),
            enterToSendCheckbox: document.getElementById('enter-to-send'),
            autoScrollOnNewMessageCheckbox: document.getElementById('auto-scroll-on-new-message'),
            autoScrollOnThoughtCheckbox: document.getElementById('auto-scroll-on-thought'),
            historySortOrderSelect: document.getElementById('history-sort-order'),
            themeSelect: document.getElementById('theme-select'),
            fontFamilyInput: document.getElementById('font-family-input'),
            messageBodyFontSizeInput: document.getElementById('message-body-font-size-input'),
            codeBlockFontSizeInput: document.getElementById('code-block-font-size-input'),
            thoughtSummaryFontSizeInput: document.getElementById('thought-summary-font-size'),
            enableSessionLinkingCheckbox: document.getElementById('enable-session-linking'),
            swipeNavigationToggle: document.getElementById('swipe-navigation-toggle'),
            preventZoomToggle: document.getElementById('prevent-zoom-toggle'),
            minimizeHeaderToggle: document.getElementById('minimize-header-toggle'),
            minimizeFooterToggle: document.getElementById('minimize-footer-toggle'),
            showSessionLinkingSettingsToggle: document.getElementById('show-session-linking-settings-toggle'),
            sessionLinkingSettingsGroup: document.getElementById('settings-group-session-linking'),
            showChatTitleToggle: document.getElementById('show-chat-title-toggle'),
            showNewChatButtonToggle: document.getElementById('show-new-chat-button-toggle'),
            showDeleteSessionButtonToggle: document.getElementById('show-delete-session-button-toggle'),
            showCopySessionButtonToggle: document.getElementById('show-copy-session-button-toggle'),
            showScrollToTopButtonToggle: document.getElementById('show-scroll-to-top-button-toggle'),
            showScrollToBottomButtonToggle: document.getElementById('show-scroll-to-bottom-button-toggle'),
            showToggleAllContentButtonToggle: document.getElementById('show-toggle-all-content-button-toggle'),
            showBulkHistoryActionsToggle: document.getElementById('show-bulk-history-actions-toggle'),
            showPasteButtonInFooterToggle: document.getElementById('show-paste-button-in-footer-toggle'),
            showPasteButtonInEditToggle: document.getElementById('show-paste-button-in-edit-toggle'),
            showDiceButtonToggle: document.getElementById('show-dice-button-toggle'),
            diceMinValueInput: document.getElementById('dice-min-value'),
            diceMaxValueInput: document.getElementById('dice-max-value'),
            messageBubbleOpacityInput: document.getElementById('message-bubble-opacity'),
            chatOverlayOpacityInput: document.getElementById('chat-overlay-opacity'),
            headerFooterOpacityInput: document.getElementById('header-footer-opacity'),
            messageActionsBackgroundOpacityInput: document.getElementById('message-actions-background-opacity'),
            thoughtSummaryOpacityInput: document.getElementById('thought-summary-opacity'),
            appVersionSpan: document.getElementById('app-version'),
            backgroundImageInput: document.getElementById('background-image-input'),
            uploadBackgroundBtn: document.getElementById('upload-background-btn'),
            backgroundThumbnail: document.getElementById('background-thumbnail'),
            deleteBackgroundBtn: document.getElementById('delete-background-btn'),
            gotoHistoryBtn: document.getElementById('goto-history-btn'),
            gotoSettingsBtn: document.getElementById('goto-settings-btn'),
            homeGotoSettingsBtn: document.getElementById('home-goto-settings-btn'),
            gotoHomeBtn: document.getElementById('goto-home-btn'),
            startChatBtn: document.getElementById('start-chat-btn'),
            selectHistoryBtn: document.getElementById('select-history-btn'),
            characterSelect: document.getElementById('character-select'),
            promptApiProviderSelect: document.getElementById('prompt-api-provider-select'),
            promptGeminiSettings: document.getElementById('prompt-gemini-settings'),
            promptGeminiApiKeyInput: document.getElementById('prompt-gemini-api-key'),
            promptDeepseekSettings: document.getElementById('prompt-deepseek-settings'),
            promptDeepseekApiKeyInput: document.getElementById('prompt-deepseek-api-key'),
            promptClaudeSettings: document.getElementById('prompt-claude-settings'),
            promptClaudeApiKeyInput: document.getElementById('prompt-claude-api-key'),
            promptOpenaiSettings: document.getElementById('prompt-openai-settings'),
            promptOpenaiApiKeyInput: document.getElementById('prompt-openai-api-key'),
            promptXaiSettings: document.getElementById('prompt-xai-settings'),
            promptXaiApiKeyInput: document.getElementById('prompt-xai-api-key'),
            promptLlmaggregatorSettings: document.getElementById('prompt-llmaggregator-settings'),
            promptLlmaggregatorApiBackendInput: document.getElementById('prompt-llmaggregator-api-backend'),
            promptLlmaggregatorApiKeyInput: document.getElementById('prompt-llmaggregator-api-key'),
            promptGeminiModelNameSelect: document.getElementById('prompt-gemini-model-name'),
            promptDeepseekModelNameSelect: document.getElementById('prompt-deepseek-model-name'),
            promptClaudeModelNameSelect: document.getElementById('prompt-claude-model-name'),
            promptOpenaiModelNameSelect: document.getElementById('prompt-openai-model-name'),
            promptXaiModelNameSelect: document.getElementById('prompt-xai-model-name'),
            promptLlmaggregatorModelNameSelect: document.getElementById('prompt-llmaggregator-model-name'),
            promptGeminiAdditionalModelsTextarea: document.getElementById('prompt-gemini-additional-models'),
            promptDeepseekAdditionalModelsTextarea: document.getElementById('prompt-deepseek-additional-models'),
            promptClaudeAdditionalModelsTextarea: document.getElementById('prompt-claude-additional-models'),
            promptOpenaiAdditionalModelsTextarea: document.getElementById('prompt-openai-additional-models'),
            promptXaiAdditionalModelsTextarea: document.getElementById('prompt-xai-additional-models'),
            promptLlmaggregatorAdditionalModelsTextarea: document.getElementById('prompt-llmaggregator-additional-models'),
            promptAiIconInput: document.getElementById('prompt-ai-icon-input'),
            promptUploadAiIconBtn: document.getElementById('prompt-upload-ai-icon-btn'),
            promptAiIconThumbnail: document.getElementById('prompt-ai-icon-thumbnail'),
            promptDeleteAiIconBtn: document.getElementById('prompt-delete-ai-icon-btn'),
            promptBackgroundImageInput: document.getElementById('prompt-background-image-input'),
            promptUploadBackgroundBtn: document.getElementById('prompt-upload-background-btn'),
            promptBackgroundThumbnail: document.getElementById('prompt-background-thumbnail'),
            promptDeleteBackgroundBtn: document.getElementById('prompt-delete-background-btn'),
            promptThemeSelect: document.getElementById('prompt-theme-select'),
            promptAiNameInput: document.getElementById('prompt-ai-name-input'),
            showAiIconCheckbox: document.getElementById('show-ai-icon-checkbox'),
            showAiNameCheckbox: document.getElementById('show-ai-name-checkbox'),
            userRelationshipSelect: document.getElementById('user-relationship-select'),
            chatModeSelect: document.getElementById('chat-mode-select'),
            emotionUrlNormal: document.getElementById('emotion-url-normal'),
            emotionUrlHappy: document.getElementById('emotion-url-happy'),
            emotionUrlFun: document.getElementById('emotion-url-fun'),
            emotionUrlSad: document.getElementById('emotion-url-sad'),
            emotionUrlAngry: document.getElementById('emotion-url-angry'),
            promptSetupSystemPrompt: document.getElementById('prompt-setup-system-prompt'),
            promptPreview: document.getElementById('prompt-preview'),
            backToHomeFromPromptSetupBtn: document.getElementById('back-to-home-from-prompt-setup'),
            startChatWithPromptBtn: document.getElementById('start-chat-with-prompt-btn'),
            backToChatFromHistoryBtn: document.getElementById('back-to-chat-from-history'),
            backToChatFromSettingsBtn: document.getElementById('back-to-chat-from-settings'),
            newChatBtn: document.getElementById('new-chat-btn'),
            deleteSessionBtn: document.getElementById('delete-session-btn'),
            copySessionBtn: document.getElementById('copy-session-btn'),
            scrollToTopBtn: document.getElementById('scroll-to-top-btn'),
            scrollToBottomBtn: document.getElementById('scroll-to-bottom-btn'),
            toggleAllContentBtn: document.getElementById('toggle-all-content-btn'),
            saveSettingsBtns: document.querySelectorAll('.js-save-settings-btn'),
            updateAppBtn: document.getElementById('update-app-btn'),
            clearDataBtn: document.getElementById('clear-data-btn'),
            clearHistoryBtn: document.getElementById('clear-history-btn'),
            importHistoryBtn: document.getElementById('import-history-btn'),
            importHistoryInput: document.getElementById('import-history-input'),
            exportAllSessionsBtn: document.getElementById('export-all-sessions-btn'),
            importAllSessionsBtn: document.getElementById('import-all-sessions-btn'),
            importAllSessionsInput: document.getElementById('import-all-sessions-input'),
            alertDialog: document.getElementById('alertDialog'),
            alertMessage: document.getElementById('alertDialog').querySelector('.dialog-message'),
            alertOkBtn: document.getElementById('alertDialog').querySelector('.dialog-ok-btn'),
            confirmDialog: document.getElementById('confirmDialog'),
            confirmMessage: document.getElementById('confirmDialog').querySelector('.dialog-message'),
            confirmOkBtn: document.getElementById('confirmDialog').querySelector('.dialog-ok-btn'),
            confirmCancelBtn: document.getElementById('confirmDialog').querySelector('.dialog-cancel-btn'),
            promptDialog: document.getElementById('promptDialog'),
            promptMessage: document.getElementById('promptDialog').querySelector('.dialog-message'),
            promptInput: document.getElementById('promptDialog').querySelector('.dialog-input'),
            promptOkBtn: document.getElementById('promptDialog').querySelector('.dialog-ok-btn'),
            promptCancelBtn: document.getElementById('promptDialog').querySelector('.dialog-cancel-btn'),
            rollDiceBtn: document.getElementById('roll-dice-btn'),
            attachFileBtn: document.getElementById('attach-file-btn'),
            aiToAiChatBtn: document.getElementById('ai-to-ai-chat-btn'),
            pasteToInputBtn: document.getElementById('paste-to-input-btn'),
            fileUploadDialog: document.getElementById('fileUploadDialog'),
            fileInput: document.getElementById('file-input'),
            selectFilesBtn: document.getElementById('select-files-btn'),
            selectedFilesList: document.getElementById('selected-files-list'),
            confirmAttachBtn: document.getElementById('confirm-attach-btn'),
            cancelAttachBtn: document.getElementById('cancel-attach-btn'),
            toggleMemoBtn: document.getElementById('toggle-memo-btn'),
            memoArea: document.getElementById('memo-area'),
            memoEditor: document.getElementById('memo-editor'),
            copyMemoBtn: document.getElementById('copy-memo-btn'),
            pasteMemoBtn: document.getElementById('paste-memo-btn'),
            deleteMemoBtn: document.getElementById('delete-memo-btn'),
            showMemoButtonToggle: document.getElementById('show-memo-button-toggle'),
            memoStackHeightSettings: document.getElementById('memo-stack-height-settings'),
            memoHeightInput: document.getElementById('memo-height'),
            disableRetryConfirmationToggle: document.getElementById('disable-retry-confirmation-toggle'),
            disableLoadChatConfirmationWhileSendingToggle: document.getElementById('disable-load-chat-confirmation-while-sending-toggle'),
            disableDeleteMessageConfirmationToggle: document.getElementById('disable-delete-message-confirmation-toggle'),
            disableAttachmentConfirmationToggle: document.getElementById('disable-attachment-confirmation-toggle'),
            addPrefixOnImportToggle: document.getElementById('add-prefix-on-import-toggle'),
            showMultiApiKeysToggle: document.getElementById('show-multi-api-keys-toggle'),
            showTopCollapseButtonToggle: document.getElementById('show-top-collapse-button-toggle'),
            showBottomCollapseButtonToggle: document.getElementById('show-bottom-collapse-button-toggle'),
            persistMessageCollapseStateCheckbox: document.getElementById('persist-message-collapse-state'),
            toggleClipboardStackBtn: document.getElementById('toggle-clipboard-stack-btn'),
            clipboardStackArea: document.getElementById('clipboard-stack-area'),
            clipboardStackEditor: document.getElementById('clipboard-stack-editor'),
            deleteClipboardStackBtn: document.getElementById('delete-clipboard-stack-btn'),
            copyClipboardStackBtn: document.getElementById('copy-clipboard-stack-btn'),
            pasteClipboardStackBtn: document.getElementById('paste-clipboard-stack-btn'),
            showClipboardStackButtonToggle: document.getElementById('show-clipboard-stack-button-toggle'),
            showUserIconToggle: document.getElementById('show-user-icon-toggle'),
            userIconInput: document.getElementById('user-icon-input'),
            uploadUserIconBtn: document.getElementById('upload-user-icon-btn'),
            userIconThumbnail: document.getElementById('user-icon-thumbnail'),
            deleteUserIconBtn: document.getElementById('delete-user-icon-btn'),
            showUserNameToggle: document.getElementById('show-user-name-toggle'),
            userNameInput: document.getElementById('user-name-input'),
            showAiIconToggle: document.getElementById('show-ai-icon-toggle'),
            aiIconInput: document.getElementById('ai-icon-input'),
            uploadAiIconBtn: document.getElementById('upload-ai-icon-btn'),
            aiIconThumbnail: document.getElementById('ai-icon-thumbnail'),
            deleteAiIconBtn: document.getElementById('delete-ai-icon-btn'),
            showAiNameToggle: document.getElementById('show-ai-name-toggle'),
            aiNameInput: document.getElementById('ai-name-input'),
            iconNameFontSizeInput: document.getElementById('icon-name-font-size'),
            iconNameOffsetYInput: document.getElementById('icon-name-offset-y'),
            messageIconSizeInput: document.getElementById('message-icon-size'),
            messageIconOffsetYInput: document.getElementById('message-icon-offset-y'),
            userNameBubbleToggle: document.getElementById('user-name-bubble-toggle'),
            userNameBubbleUseThemeColorToggle: document.getElementById('user-name-bubble-use-theme-color-toggle'),
            userNameBubbleColorInput: document.getElementById('user-name-bubble-color'),
            userNameBubbleOpacityInput: document.getElementById('user-name-bubble-opacity'),
            aiNameBubbleToggle: document.getElementById('ai-name-bubble-toggle'),
            aiNameBubbleUseThemeColorToggle: document.getElementById('ai-name-bubble-use-theme-color-toggle'),
            aiNameBubbleColorInput: document.getElementById('ai-name-bubble-color'),
            aiNameBubbleOpacityInput: document.getElementById('ai-name-bubble-opacity'),
            toggleButtonTopWidthInput: document.getElementById('toggle-button-top-width'),
            toggleButtonTopHeightInput: document.getElementById('toggle-button-top-height'),
            toggleButtonTopFontSizeInput: document.getElementById('toggle-button-top-font-size'),
            toggleButtonTopTextCollapseInput: document.getElementById('toggle-button-top-text-collapse'),
            toggleButtonTopTextExpandInput: document.getElementById('toggle-button-top-text-expand'),
            toggleButtonBottomFontSizeInput: document.getElementById('toggle-button-bottom-font-size'),
            toggleButtonBottomTextCollapseInput: document.getElementById('toggle-button-bottom-text-collapse'),
            toggleButtonBottomTextExpandInput: document.getElementById('toggle-button-bottom-text-expand'),
            toggleButtonTopOpacityInput: document.getElementById('toggle-button-top-opacity'),
            geminiGroundingParam: document.getElementById('gemini-grounding-param'),
            geminiThoughtsParam: document.getElementById('gemini-thoughts-param'),
            geminiPseudoStreamingParam: document.getElementById('gemini-pseudo-streaming-param'),
            deepSeekThoughtsParam: document.getElementById('deepseek-thoughts-param'),
            claudeThoughtsParam: document.getElementById('claude-thoughts-param'),
            xaiThoughtsParam: document.getElementById('xai-thoughts-param'),
            llmAggregatorThoughtsParam: document.getElementById('llmaggregator-thoughts-param'),
            disableSaveSettingsConfirmationToggle: document.getElementById('disable-save-settings-confirmation-toggle'),
            autoSaveSettingsToggle: document.getElementById('auto-save-settings-toggle'),
            headerApiProviderToggleBtn: document.getElementById('header-api-provider-toggle-btn'),
            footerApiProviderToggleBtn: document.getElementById('footer-api-provider-toggle-btn'),
            showApiProviderToggleHeaderCheckbox: document.getElementById('show-api-provider-toggle-header'),
            showApiProviderToggleFooterCheckbox: document.getElementById('show-api-provider-toggle-footer'),
            apiProviderCycleGeminiCheckbox: document.getElementById('api-provider-cycle-gemini'),
            apiProviderCycleDeepSeekCheckbox: document.getElementById('api-provider-cycle-deepseek'),
            apiProviderCycleClaudeCheckbox: document.getElementById('api-provider-cycle-claude'),
            apiProviderCycleOpenAICheckbox: document.getElementById('api-provider-cycle-openai'),
            apiProviderCycleXaiCheckbox: document.getElementById('api-provider-cycle-xai'),
            apiProviderCycleLlmAggregatorCheckbox: document.getElementById('api-provider-cycle-llmaggregator'),
            apiProviderCycleDummyCheckbox: document.getElementById('api-provider-cycle-dummy'),
            imagePreviewDialog: document.getElementById('imagePreviewDialog'),
            dummyErrorDebugModeCheckbox: document.getElementById('dummy-error-debug-mode'),
            dummyDummyModelInput: document.getElementById('dummy-dummy-model'),
            dummyEnableDummyModelCheckbox: document.getElementById('dummy-enable-dummy-model'),
            geminiApiKeysList: document.getElementById('gemini-api-keys-list'),
            addGeminiApiKeyBtn: document.getElementById('add-gemini-api-key-btn'),
            deepseekApiKeysList: document.getElementById('deepseek-api-keys-list'),
            addDeepseekApiKeyBtn: document.getElementById('add-deepseek-api-key-btn'),
            claudeApiKeysList: document.getElementById('claude-api-keys-list'),
            addClaudeApiKeyBtn: document.getElementById('add-claude-api-key-btn'),
            openaiApiKeysList: document.getElementById('openai-api-keys-list'),
            addOpenaiApiKeyBtn: document.getElementById('add-openai-api-key-btn'),
            xaiApiKeysList: document.getElementById('xai-api-keys-list'),
            addXaiApiKeyBtn: document.getElementById('add-xai-api-key-btn'),
            llmaggregatorApiKeysList: document.getElementById('llmaggregator-api-keys-list'),
            addLlmaggregatorApiKeyBtn: document.getElementById('add-llmaggregator-api-key-btn'),
            
            // 繝√Ε繝・ヨ險ｭ螳壹Δ繝ｼ繝繝ｫ
            chatSettingsModal: document.getElementById('chat-settings-modal'),
            chatSettingsBtn: document.getElementById('chat-settings-btn'),
            chatAiNameInput: document.getElementById('chat-ai-name'),
            chatAiIconInput: document.getElementById('chat-ai-icon'),
            chatAiIconPreview: document.getElementById('chat-ai-icon-preview'),
            chatAiIconRemove: document.getElementById('chat-ai-icon-remove'),
            chatBackgroundImageInput: document.getElementById('chat-background-image'),
            chatBackgroundPreview: document.getElementById('chat-background-preview'),
            chatBackgroundRemove: document.getElementById('chat-background-remove'),
            chatThemeSelect: document.getElementById('chat-theme-select'),
            chatSystemPromptTextarea: document.getElementById('chat-system-prompt'),
            chatSettingsSaveBtn: document.getElementById('chat-settings-save'),
            chatSettingsCancelBtn: document.getElementById('chat-settings-cancel'),
        };

        const state = {
            db: null,
            currentChatId: null,
            currentMessages: [],
            // AI蜷阪・繧｢繧､繧ｳ繝ｳ繝ｻ閭梧勹逕ｻ蜒上・譏守､ｺ逧・､画峩繝輔Λ繧ｰ
            assetDirty: {
                aiIcon: false,
                bgImage: false,
                aiName: false
            },
            // 繝√Ε繝・ヨ縺斐→縺ｮ繧｢繧ｻ繝・ヨ諠・ｱ繧剃ｿ晄戟
            chatAssets: new Map(),
            settings: {
                apiKey: '',
                modelName: DEFAULT_MODEL,
                additionalModels: '',
                commonSystemPrompt: '',
                enableCommonSystemPromptDefault: false,
                geminiSystemPrompt: '',
                geminiEnableSystemPromptDefault: true,
                geminiTemperature: null,
                geminiMaxTokens: null,
                geminiTopK: null,
                geminiTopP: null,
                geminiPresencePenalty: null,
                geminiFrequencyPenalty: null,
                geminiThinkingBudget: null,
                geminiIncludeThoughts: false,
                geminiExpandThoughtsByDefault: false,
                geminiStreamingOutput: true,
                geminiStreamingSpeed: DEFAULT_STREAMING_SPEED,
                geminiDummyUser: '',
                geminiEnableDummyUser: true,
                geminiDummyModel: '',
                geminiEnableDummyModel: true,
                geminiConcatDummyModel: false,
                geminiPseudoStreaming: false,
                geminiEnableGrounding: false,
                deepSeekApiKey: '',
                deepSeekModelName: DEFAULT_DEEPSEEK_MODEL,
                deepSeekAdditionalModels: '',
                deepSeekApiEndpoint: '',
                deepSeekSystemPrompt: '',
                deepSeekEnableSystemPromptDefault: true,
                deepSeekTemperature: null,
                deepSeekMaxTokens: null,
                deepSeekTopP: null,
                deepSeekPresencePenalty: null,
                deepSeekFrequencyPenalty: null,
                deepSeekIncludeDeepSeekThoughts: false,
                deepSeekExpandThoughtsByDefault: false,
                deepSeekStreamingOutput: true,
                deepSeekStreamingSpeed: DEFAULT_STREAMING_SPEED,
                deepSeekDummyUser: '',
                deepSeekEnableDummyUser: true,
                deepSeekDummyModel: '',
                deepSeekEnableDummyModel: true,
                deepSeekConcatDummyModel: false,
                claudeApiKey: '',
                claudeModelName: DEFAULT_CLAUDE_MODEL,
                claudeAdditionalModels: '',
                claudeSystemPrompt: '',
                claudeEnableSystemPromptDefault: true,
                claudeTemperature: null,
                claudeMaxTokens: null,
                claudeTopK: null,
                claudeTopP: null,
                claudeStreamingOutput: true,
                claudeStreamingSpeed: DEFAULT_STREAMING_SPEED,
                claudeDummyUser: '',
                claudeEnableDummyUser: false,
                claudeDummyModel: '',
                claudeEnableDummyModel: false,
                claudeConcatDummyModel: false,
                claudeIncludeThoughts: false,
                claudeExpandThoughtsByDefault: false,
                claudeThinkingBudget: null,
                openaiApiKey: '',
                openaiModelName: DEFAULT_OPENAI_MODEL,
                openaiAdditionalModels: '',
                openaiSystemPrompt: '',
                openaiEnableSystemPromptDefault: true,
                openaiTemperature: null,
                openaiMaxTokens: null,
                openaiTopP: null,
                openaiPresencePenalty: null,
                openaiFrequencyPenalty: null,
                openaiStreamingOutput: true,
                openaiStreamingSpeed: DEFAULT_STREAMING_SPEED,
                openaiDummyUser: '',
                openaiEnableDummyUser: true,
                openaiDummyModel: '',
                openaiEnableDummyModel: true,
                openaiConcatDummyModel: false,
                xaiApiKey: '',
                xaiModelName: DEFAULT_XAI_MODEL,
                xaiAdditionalModels: '',
                xaiSystemPrompt: '',
                xaiEnableSystemPromptDefault: true,
                xaiTemperature: null,
                xaiMaxTokens: null,
                xaiTopP: null,
                xaiPresencePenalty: null,
                xaiFrequencyPenalty: null,
                xaiStreamingOutput: true,
                xaiStreamingSpeed: DEFAULT_STREAMING_SPEED,
                xaiDummyUser: '',
                xaiEnableDummyUser: true,
                xaiDummyModel: '',
                xaiEnableDummyModel: true,
                xaiVisionEnable: false,
                xaiConcatDummyModel: false,
                xaiIncludeThoughts: false,
                xaiExpandThoughtsByDefault: false,
                xaiReasoningEffort: 'low',
                llmAggregatorApiBackend: '',
                llmAggregatorApiKey: '',
                llmAggregatorModelName: DEFAULT_LLMAGGREGATOR_MODEL,
                llmAggregatorAdditionalModels: '',
                llmAggregatorSystemPrompt: '',
                llmAggregatorEnableSystemPromptDefault: true,
                llmAggregatorTemperature: null,
                llmAggregatorMaxTokens: null,
                llmAggregatorTopP: null,
                llmAggregatorTopK: null,
                llmAggregatorPresencePenalty: null,
                llmAggregatorFrequencyPenalty: null,
                llmAggregatorIncludeThoughts: false,
                llmAggregatorExpandThoughtsByDefault: false,
                llmAggregatorStreamingOutput: true,
                llmAggregatorStreamingSpeed: DEFAULT_STREAMING_SPEED,
                llmAggregatorDummyUser: '',
                llmAggregatorEnableDummyUser: true,
                llmAggregatorDummyModel: '',
                llmAggregatorEnableDummyModel: true,
                llmAggregatorConcatDummyModel: false,
                enterToSend: false,
                autoScrollOnNewMessage: DEFAULT_AUTO_SCROLL_ON_NEW_MESSAGE,
                autoScrollOnThought: false,
                historySortOrder: 'updatedAt',
                theme: 'light',
                backgroundImageBlob: null,
                fontFamily: '',
                messageBodyFontSize: DEFAULT_MESSAGE_BODY_FONT_SIZE,
                codeBlockFontSize: DEFAULT_CODE_BLOCK_FONT_SIZE,
                thoughtSummaryFontSize: DEFAULT_THOUGHT_SUMMARY_FONT_SIZE,
                enableSessionLinking: false,
                enableSwipeNavigation: false,
                preventZoom: true,
                minimizeHeader: true,
                minimizeFooter: false,
                showSessionLinkingSettings: false,
                showChatTitle: true,
                showNewChatButton: true,
                showDeleteSessionButton: false,
                showCopySessionButton: false,
                showScrollToTopButton: true,
                showScrollToBottomButton: true,
                showToggleAllContentButton: false,
                showBulkHistoryActions: true,
                showPasteButtonInFooter: false,
                showPasteButtonInEdit: false,
                showDiceButton: false,
                diceMinValue: DEFAULT_DICE_MIN_VALUE,
                diceMaxValue: DEFAULT_DICE_MAX_VALUE,
                showMemoButton: false,
                memoHeight: DEFAULT_MEMO_HEIGHT,
                showClipboardStackButton: false,
                clipboardStackHeight: DEFAULT_CLIPBOARD_STACK_HEIGHT,
                showUserIcon: false,
                userIconBlob: null,
                showUserName: false,
                userName: DEFAULT_USER_NAME,
                chatMode: 'conversation',
                showAiIcon: true,
                aiIconBlob: null,
                showAiName: true,
                aiName: DEFAULT_AI_NAME,
                iconNameFontSize: DEFAULT_ICON_NAME_FONT_SIZE,
                iconNameOffsetY: DEFAULT_ICON_NAME_OFFSET_Y,
                messageIconSize: DEFAULT_MESSAGE_ICON_SIZE,
                messageIconOffsetY: DEFAULT_MESSAGE_ICON_OFFSET_Y,
                showUserNameBubble: false,
                userNameBubbleUseThemeColor: false,
                userNameBubbleColor: DEFAULT_USER_NAME_BUBBLE_COLOR,
                userNameBubbleOpacity: DEFAULT_USER_NAME_BUBBLE_OPACITY,
                showAiNameBubble: false,
                aiNameBubbleUseThemeColor: false,
                aiNameBubbleColor: DEFAULT_AI_NAME_BUBBLE_COLOR,
                aiNameBubbleOpacity: DEFAULT_AI_NAME_BUBBLE_OPACITY,
                disableRetryConfirmation: false,
                disableLoadChatConfirmationWhileSending: false,
                disableDeleteMessageConfirmation: false,
                disableAttachmentConfirmation: false,
                addPrefixOnImport: true,
                showMultiApiKeys: false,
                disableSaveSettingsConfirmation: false,
                autoSaveSettings: false,
                showTopCollapseButton: true,
                showBottomCollapseButton: true,
                persistMessageCollapseState: DEFAULT_PERSIST_MESSAGE_COLLAPSE_STATE,
                messageBubbleOpacity: DEFAULT_MESSAGE_BUBBLE_OPACITY,
                chatOverlayOpacity: DEFAULT_CHAT_OVERLAY_OPACITY,
                headerFooterOpacity: DEFAULT_HEADER_FOOTER_OPACITY,
                messageActionsBackgroundOpacity: DEFAULT_MESSAGE_ACTIONS_BACKGROUND_OPACITY,
                toggleButtonTopWidth: DEFAULT_TOGGLE_BUTTON_TOP_WIDTH,
                toggleButtonTopHeight: DEFAULT_TOGGLE_BUTTON_TOP_HEIGHT,
                toggleButtonTopFontSize: DEFAULT_TOGGLE_BUTTON_TOP_FONT_SIZE,
                toggleButtonTopOpacity: DEFAULT_TOGGLE_BUTTON_TOP_OPACITY,
                toggleButtonTopTextCollapse: DEFAULT_TOGGLE_BUTTON_TOP_TEXT_COLLAPSE,
                toggleButtonTopTextExpand: DEFAULT_TOGGLE_BUTTON_TOP_TEXT_EXPAND,
                toggleButtonBottomFontSize: DEFAULT_TOGGLE_BUTTON_BOTTOM_FONT_SIZE,
                toggleButtonBottomTextCollapse: DEFAULT_TOGGLE_BUTTON_BOTTOM_TEXT_COLLAPSE,
                toggleButtonBottomTextExpand: DEFAULT_TOGGLE_BUTTON_BOTTOM_TEXT_EXPAND,
                apiProvider: 'gemini',
                thoughtSummaryOpacity: DEFAULT_THOUGHT_SUMMARY_OPACITY,
                settingsUIDetailsOpenStates: {},
                showApiProviderToggleHeader: false,
                showApiProviderToggleFooter: true,
                apiProviderCycle: {
                    gemini: true,
                    deepseek: true,
                    claude: true,
                    openai: true,
                    xai: true,
                    llmaggregator: true,
                    dummy: true,
                },
                dummyErrorDebugMode: false,
                dummyDummyModel: '',
                dummyEnableDummyModel: false,
                geminiApiKeys: [],
                geminiActiveApiKeyIndex: -1,
                deepseekApiKeys: [],
                deepseekActiveApiKeyIndex: -1,
                claudeApiKeys: [],
                claudeActiveApiKeyIndex: -1,
                openaiApiKeys: [],
                openaiActiveApiKeyIndex: -1,
                xaiApiKeys: [],
                xaiActiveApiKeyIndex: -1,
                llmaggregatorApiKeys: [],
                llmaggregatorActiveApiKeyIndex: -1,
            },
            backgroundImageUrl: null,
            userIconUrl: null,
            aiIconUrl: null,
            isSending: false,
            abortController: null,
            partialStreamContent: '',
            partialThoughtStreamContent: '',
            editingMessageIndex: null,
            touchStartX: 0,
            touchStartY: 0,
            touchEndX: 0,
            touchEndY: 0,
            isSwiping: false,
            isZoomed: false,
            currentScreen: 'home',
            selectedFilesForUpload: [],
            pendingAttachments: [],
            isMemoVisible: false,
            isClipboardStackVisible: false,
            clipboardStackContent: "",
            areAllMessagesHidden: false,
            messageCollapsedStates: new Map(),
            thoughtSummaryOpenStates: new Map(),
            linkedSessionIds: [],
            isAiToAiChatProcessing: false,
            // 繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ繝ｪ繧ｹ繝医・繧ｭ繝｣繝・す繝･
            characterListCache: {
                list: [],
                timestamp: null,
                cacheTimeout: 60 * 1000 // 1蛻・俣縺ｮ繧ｭ繝｣繝・す繝･
            },
            // 迴ｾ蝨ｨ縺ｮ繝√Ε繝・ヨ縺ｮ繝・・繝・            currentChatTheme: null,
            // 繝励Ο繝ｳ繝励ヨ險ｭ螳夂判髱｢縺ｧ縺ｮ荳譎ら噪縺ｪ繝・・繝・            promptTempTheme: null,
        };

        const sanitizeText = (text, maxLength = 255) => {
            if (typeof text !== 'string') return '';
            return text.replace(/[<>'"&]/g, '').substring(0, maxLength);
        }
        
        function isAllowedAggregatorDomain(urlStr) {
            if (!urlStr) return true;
            try {
                const url = new URL(urlStr.trim());
                const host = url.hostname.toLowerCase();
                return ALLOWED_LLMAGGREGATOR_DOMAINS.some(allowed => {
                    return host === allowed || host.endsWith(`.${allowed}`);
                });
            } catch {
                return false;
            }
        }

        function updateMessageMaxWidthVar() {
            const container = elements.messageContainer;
            if (!container) return;
            let maxWidthPx = container.clientWidth * 0.8;
            document.documentElement.style.setProperty('--message-max-width', `${maxWidthPx}px`);
        }

        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(updateMessageMaxWidthVar, 150);
        });

        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js')
                        .then(registration => {
                            navigator.serviceWorker.addEventListener('message', event => {
                                if (event.data && event.data.action === 'reloadPage') {
                                    alert('繧｢繝励Μ縺梧峩譁ｰ縺輔ｌ縺ｾ縺励◆縲ゅ・繝ｼ繧ｸ繧偵Μ繝ｭ繝ｼ繝峨＠縺ｾ縺吶・);
                                    window.location.reload();
                                }
                            });
                        })
                        .catch(err => {});
                });
            }
        }

        // iOS ArrayBuffer螟画鋤逕ｨ縺ｮ繝ｦ繝ｼ繝・ぅ繝ｪ繝・ぅ髢｢謨ｰ
        const convertArrayBufferToBlob = (data) => {
            if (!data) return null;
            if (data instanceof Blob) return data;
            if (data instanceof ArrayBuffer) {
                return new Blob([data], { type: 'image/jpeg' });
            }
            if (data && data.arrayBuffer && data.type) {
                return new Blob([data.arrayBuffer], { type: data.type });
            }
            if (data && data.constructor === Uint8Array || Array.isArray(data)) {
                return new Blob([new Uint8Array(data)], { type: 'image/jpeg' });
            }
            return null;
        };

        const dbUtils = {
            openDB() {
                return new Promise((resolve, reject) => {
                    if (state.db) {
                        resolve(state.db);
                        return;
                    }
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onerror = (event) => reject(`IndexedDB繧ｨ繝ｩ繝ｼ: ${event.target.error}`);
                    request.onsuccess = (event) => {
                        state.db = event.target.result;
                        state.db.onerror = (event) => { };
                        resolve(state.db);
                    };
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        const transaction = event.target.transaction;
                        if (!db.objectStoreNames.contains(SETTINGS_STORE)) {
                            db.createObjectStore(SETTINGS_STORE, { keyPath: 'key' });
                        }
                        let chatStore;
                        if (!db.objectStoreNames.contains(CHATS_STORE)) {
                            chatStore = db.createObjectStore(CHATS_STORE, { keyPath: 'id', autoIncrement: true });
                        } else {
                             if (transaction) {
                                try { chatStore = transaction.objectStore(CHATS_STORE); } catch (e) { return; }
                            }
                        }
                        if (chatStore && !chatStore.indexNames.contains(CHAT_UPDATEDAT_INDEX)) {
                            chatStore.createIndex(CHAT_UPDATEDAT_INDEX, 'updatedAt', { unique: false });
                        }
                        if (chatStore && !chatStore.indexNames.contains(CHAT_CREATEDAT_INDEX)) {
                            chatStore.createIndex(CHAT_CREATEDAT_INDEX, 'createdAt', { unique: false });
                        }
                    };
                });
            },
            _getStore(storeName, mode = 'readonly') {
                if (!state.db) throw new Error("繝・・繧ｿ繝吶・繧ｹ縺碁幕縺九ｌ縺ｦ縺・∪縺帙ｓ");
                const transaction = state.db.transaction([storeName], mode);
                return transaction.objectStore(storeName);
            },
            async saveSetting(key, value) {
                await this.openDB();
                return new Promise((resolve, reject) => {
                     try {
                        const store = this._getStore(SETTINGS_STORE, 'readwrite');
                        const request = store.put({ key, value });
                        request.onsuccess = () => resolve();
                        request.onerror = (event) => reject(`險ｭ螳・${key} 縺ｮ菫晏ｭ倥お繝ｩ繝ｼ: ${event.target.error}`);
                    } catch (error) {
                        reject(`險ｭ螳・${key} 菫晏ｭ倥・縺溘ａ縺ｮ繧ｹ繝医い繧｢繧ｯ繧ｻ繧ｹ繧ｨ繝ｩ繝ｼ: ${error}`);
                    }
                });
            },
            async loadSettings() {
                await this.openDB();
                return new Promise((resolve, reject) => {
                    const store = this._getStore(SETTINGS_STORE);
                    const request = store.getAll();
                    request.onsuccess = (event) => {
                        const settingsArray = event.target.result;
                        const loadedSettings = {};
                        settingsArray.forEach(item => {
                            loadedSettings[item.key] = item.value;
                        });
                        const defaultSettings = { ...state.settings };
                        state.settings = { ...defaultSettings };

                        if (loadedSettings.hasOwnProperty('darkMode') && !loadedSettings.hasOwnProperty('theme')) {
                            state.settings.theme = loadedSettings.darkMode === true ? 'dark' : 'light';
                        }

                        const oldGlobalParams = ['temperature', 'maxTokens', 'topP', 'presencePenalty', 'frequencyPenalty', 'systemPrompt', 'enableSystemPromptDefault'];
                        const oldGlobalAdvanced = ['streamingOutput', 'streamingSpeed', 'dummyUser', 'enableDummyUser', 'dummyModel', 'enableDummyModel', 'concatDummyModel'];
                        const providerPrefixes = ['gemini', 'deepSeek', 'claude', 'openai', 'xai', 'llmaggregator'];

                        oldGlobalParams.forEach(param => {
                            if (loadedSettings.hasOwnProperty(param)) {
                                providerPrefixes.forEach(prefix => {
                                    const newKey = prefix + param.charAt(0).toUpperCase() + param.slice(1);
                                    if (state.settings.hasOwnProperty(newKey) && !loadedSettings.hasOwnProperty(newKey)) {
                                        state.settings[newKey] = loadedSettings[param];
                                    }
                                });
                            }
                        });
                         oldGlobalAdvanced.forEach(advParam => {
                            if (loadedSettings.hasOwnProperty(advParam)) {
                                providerPrefixes.forEach(prefix => {
                                    const newKey = prefix + advParam.charAt(0).toUpperCase() + advParam.slice(1);
                                    if (state.settings.hasOwnProperty(newKey) && !loadedSettings.hasOwnProperty(newKey)) {
                                        state.settings[newKey] = loadedSettings[advParam];
                                    }
                                });
                            }
                        });
                        if (loadedSettings.hasOwnProperty('includeThoughts') && !loadedSettings.hasOwnProperty('geminiIncludeThoughts') && state.settings.hasOwnProperty('geminiIncludeThoughts')) {
                            state.settings.geminiIncludeThoughts = loadedSettings.includeThoughts;
                        }
                        if (loadedSettings.hasOwnProperty('expandThoughtsByDefault') && !loadedSettings.hasOwnProperty('geminiExpandThoughtsByDefault') && state.settings.hasOwnProperty('geminiExpandThoughtsByDefault')) {
                            state.settings.geminiExpandThoughtsByDefault = loadedSettings.expandThoughtsByDefault;
                        }
                        if (loadedSettings.hasOwnProperty('pseudoStreaming') && !loadedSettings.hasOwnProperty('geminiPseudoStreaming') && state.settings.hasOwnProperty('geminiPseudoStreaming')) {
                            state.settings.geminiPseudoStreaming = loadedSettings.pseudoStreaming;
                        }
                        if (loadedSettings.hasOwnProperty('enableGrounding') && !loadedSettings.hasOwnProperty('geminiEnableGrounding') && state.settings.hasOwnProperty('geminiEnableGrounding')) {
                            state.settings.geminiEnableGrounding = loadedSettings.enableGrounding;
                        }
                        if (loadedSettings.hasOwnProperty('includeDeepSeekThoughts') && !loadedSettings.hasOwnProperty('deepSeekIncludeDeepSeekThoughts') && state.settings.hasOwnProperty('deepSeekIncludeDeepSeekThoughts')) {
                            state.settings.deepSeekIncludeDeepSeekThoughts = loadedSettings.includeDeepSeekThoughts;
                        }
                        if (loadedSettings.hasOwnProperty('expandDeepSeekThoughtsByDefault') && !loadedSettings.hasOwnProperty('deepSeekExpandThoughtsByDefault') && state.settings.hasOwnProperty('deepSeekExpandThoughtsByDefault')) {
                            state.settings.deepSeekExpandThoughtsByDefault = loadedSettings.expandDeepSeekThoughtsByDefault;
                        }

                        for (const key in loadedSettings) {
                             if (key === 'darkMode') continue;
                             if (key === 'memoWidth') continue;
                             if (key === 'showCollapseButtons') continue;

                             if (key in defaultSettings) {
                                const loadedValue = loadedSettings[key];
                                const defaultValue = defaultSettings[key];

                                if (key === 'backgroundImageBlob' || key === 'userIconBlob' || key === 'aiIconBlob') {
                                    if (loadedValue instanceof Blob) {
                                         state.settings[key] = loadedValue;
                                    } else if (loadedValue && loadedValue.arrayBuffer && loadedValue.type) {
                                         // iOS迺ｰ蠅・〒ArrayBuffer縺ｨ縺励※菫晏ｭ倥＆繧後◆繝・・繧ｿ繧貞ｾｩ蜈・                                         state.settings[key] = { arrayBuffer: loadedValue.arrayBuffer, type: loadedValue.type };
                                    } else {
                                         state.settings[key] = null;
                                    }
                                } else if (key === 'theme') {
                                    if (['light', 'dark', 'pastel-pink', 'pastel-blue', 'pastel-yellow', 'pastel-purple', 'pastel-rainbow'].includes(loadedValue)) {
                                        state.settings[key] = loadedValue;
                                    } else {
                                        state.settings[key] = defaultValue;
                                    }
                                } else if (key === 'apiProvider') {
                                    if (['gemini', 'deepseek', 'claude', 'openai', 'xai', 'llmaggregator', 'dummy'].includes(loadedValue)) {
                                        state.settings.apiProvider = loadedValue;
                                    } else {
                                        state.settings.apiProvider = defaultValue;
                                    }
                                } else if (typeof defaultValue === 'boolean') {
                                     state.settings[key] = loadedValue === true;
                                } else if (key === 'toggleButtonTopFontSize' || key === 'toggleButtonBottomFontSize' || key === 'toggleButtonTopWidth' || key === 'toggleButtonTopHeight') {
                                    let num = parseInt(loadedValue, 10);
                                    if (isNaN(num)) {
                                        state.settings[key] = defaultValue;
                                    } else {
                                        if (key === 'toggleButtonTopFontSize' && (num < 1 || num > 50)) num = defaultValue;
                                        if (key === 'toggleButtonBottomFontSize' && (num < 1 || num > 34)) num = defaultValue;
                                        if ((key === 'toggleButtonTopWidth' || key === 'toggleButtonTopHeight') && (num < 1 || num > 100)) num = defaultValue;
                                        state.settings[key] = num;
                                    }
                                } else if (key === 'toggleButtonTopTextCollapse' || key === 'toggleButtonTopTextExpand' ||
                                           key === 'toggleButtonBottomTextCollapse' || key === 'toggleButtonBottomTextExpand') {
                                    state.settings[key] = typeof loadedValue === 'string' && loadedValue.trim() !== '' ? loadedValue : defaultValue;
                                } else if (key === 'apiProviderCycle' && typeof loadedValue === 'object' && loadedValue !== null) {
                                    state.settings.apiProviderCycle.gemini = loadedValue.gemini === true;
                                    state.settings.apiProviderCycle.deepseek = loadedValue.deepseek === true;
                                    state.settings.apiProviderCycle.claude = loadedValue.claude === true;
                                    state.settings.apiProviderCycle.openai = loadedValue.openai === true;
                                    state.settings.apiProviderCycle.xai = loadedValue.xai === true;
                                    state.settings.apiProviderCycle.llmaggregator = loadedValue.llmaggregator === true;
                                } else if (typeof defaultValue === 'number' || defaultValue === null) {
                                     let num;
                                     if (key.toLowerCase().includes('temperature') || key.toLowerCase().includes('topp') || key.toLowerCase().includes('penalty') ||
                                         key.toLowerCase().includes('opacity') || key.toLowerCase().includes('fontsize') || key.toLowerCase().includes('offsety') ||
                                         key.toLowerCase().includes('iconsize')) {
                                         num = parseFloat(loadedValue);
                                     } else {
                                         num = parseInt(loadedValue, 10);
                                     }
                                     if (isNaN(num)) {
                                         if ((key.toLowerCase().includes('temperature') || key.toLowerCase().includes('maxtokens') || key.toLowerCase().includes('topk') || key.toLowerCase().includes('topp') ||
                                             key.toLowerCase().includes('penalty') || key.toLowerCase().includes('budget') ||
                                             key.toLowerCase().includes('opacity') || key.toLowerCase().includes('fontsize') || key.toLowerCase().includes('iconsize') ||
                                             key === 'diceMinValue' || key === 'diceMaxValue'
                                             ) && (loadedValue === null || loadedValue === '')) {
                                              state.settings[key] = null;
                                         } else {
                                              state.settings[key] = defaultValue;
                                         }
                                     } else {
                                          if (key.toLowerCase().includes('temperature') && (num < 0 || num > 2)) num = defaultValue;
                                          if (key.toLowerCase().includes('maxtokens') && num < 1) num = defaultValue;
                                          if (key.toLowerCase().includes('topk') && num < 1) num = defaultValue;
                                          if (key.toLowerCase().includes('topp') && (num < 0 || num > 1)) num = defaultValue;
                                          if (key.toLowerCase().includes('streamingspeed') && num < 0) num = defaultValue;
                                          if (key.toLowerCase().includes('penalty') && (num < -2.0 || num >= 2.0)) num = defaultValue;
                                          if (key.toLowerCase().includes('budget') && (num < 0 || !Number.isInteger(num))) num = defaultValue;
                                          if (key.toLowerCase().includes('opacity') && (num < 0 || num > 1)) num = defaultValue;
                                          if (key === 'messageIconSize' && (num < 1 || num > 300)) num = defaultValue;
                                          if (key === 'messageIconOffsetY' && (num < -200 || num > 200)) num = defaultValue;
                                          if (key === 'iconNameFontSize' && (num < 1 || num > 46)) num = defaultValue;
                                          if (key === 'iconNameOffsetY' && (num < -200 || num > 200)) num = defaultValue;
                                          if ((key === 'messageBodyFontSize' || key === 'codeBlockFontSize' || key === 'thoughtSummaryFontSize') && (num < 1 || num > 100)) num = defaultValue;
                                          if (key === 'diceMinValue' && num < 0) num = defaultValue;
                                          if (key === 'diceMaxValue' && num < 0) num = defaultValue;
                                          state.settings[key] = num;
                                     }
                                } else if (typeof defaultValue === 'string') {
                                     state.settings[key] = typeof loadedValue === 'string' ? loadedValue : defaultValue;
                                } else {
                                    state.settings[key] = loadedValue;
                                }
                            }
                        }
                        if (state.settings.diceMinValue !== null && state.settings.diceMaxValue !== null && state.settings.diceMinValue > state.settings.diceMaxValue) {
                            state.settings.diceMaxValue = state.settings.diceMinValue;
                        }
                        if (!['light', 'dark', 'pastel-pink', 'pastel-blue', 'pastel-yellow', 'pastel-purple', 'pastel-rainbow'].includes(state.settings.theme)) {
                            state.settings.theme = window.matchMedia?.('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                        }
                        if (state.settings.thoughtSummaryOpacity === undefined || state.settings.thoughtSummaryOpacity === null || isNaN(parseFloat(state.settings.thoughtSummaryOpacity))) {
                            state.settings.thoughtSummaryOpacity = DEFAULT_THOUGHT_SUMMARY_OPACITY;
                        }
                        if (typeof loadedSettings.settingsUIDetailsOpenStates === 'object' && loadedSettings.settingsUIDetailsOpenStates !== null) {
                            state.settings.settingsUIDetailsOpenStates = loadedSettings.settingsUIDetailsOpenStates;
                        } else {
                            state.settings.settingsUIDetailsOpenStates = {
                                'gemini-settings-group': true,
                                'gemini-params-group': true,
                                'gemini-advanced-group': true,
                                'deepseek-settings-group': true,
                                'deepseek-params-group': true,
                                'deepseek-advanced-group': true,
                                'claude-settings-group': true,
                                'claude-params-group': true,
                                'claude-advanced-group': true,
                                'openai-settings-group': true,
                                'openai-params-group': true,
                                'openai-advanced-group': true,
                                'xai-settings-group': true,
                                'xai-params-group': true,
                                'xai-advanced-group': true,
                                'llmaggregator-settings-group': true,
                                'llmaggregator-params-group': true,
                                'llmaggregator-advanced-group': true,
                            };
                        }
                        resolve(state.settings);
                    };
                    request.onerror = (event) => reject(`險ｭ螳夊ｪｭ縺ｿ霎ｼ縺ｿ繧ｨ繝ｩ繝ｼ: ${event.target.error}`);
                });
            },
            async saveChat(optionalTitle = null) {
                console.log('saveChat called:', { 
                    currentChatId: state.currentChatId, 
                    messageCount: state.currentMessages?.length || 0,
                    hasPendingAssets: state.chatAssets.has("pending"),
                    optionalTitle
                });
                
                await this.openDB();
                if ((!state.currentMessages || state.currentMessages.length === 0)) {
                    return Promise.resolve(state.currentChatId);
                }
                
                // Safari Blob 繧ｨ繝ｩ繝ｼ蟇ｾ遲・ 菫晏ｭ伜燕縺ｫ迥ｶ諷九ｒ菫晁ｭｷ
                const preservedState = {
                    aiName: state.settings.aiName,
                    aiIconBlob: state.settings.aiIconBlob,
                    backgroundImageBlob: state.settings.backgroundImageBlob,
                    aiIconUrl: state.aiIconUrl,
                    backgroundImageUrl: state.backgroundImageUrl,
                    chatSystemPrompt: state.chatSystemPrompt
                };
                
                return new Promise((resolve, reject) => {
                    const store = this._getStore(CHATS_STORE, 'readwrite');
                    const now = Date.now();
                    const messagesToSave = state.currentMessages.map(msg => ({
                        role: msg.role, content: msg.content, timestamp: msg.timestamp,
                        thoughtSummary: msg.thoughtSummary || null,
                        deepSeekThoughtSummary: msg.deepSeekThoughtSummary || null,
                        xaiThoughtSummary: msg.xaiThoughtSummary || null,
                        generatedByApiProvider: msg.generatedByApiProvider || null,
                        ...(msg.finishReason && { finishReason: msg.finishReason }),
                        ...(msg.safetyRatings && { safetyRatings: msg.safetyRatings }),
                        ...(msg.error && { error: msg.error }),
                        ...(msg.isCascaded !== undefined && { isCascaded: msg.isCascaded }),
                        ...(msg.isSelected !== undefined && { isSelected: msg.isSelected }),
                        ...(msg.siblingGroupId !== undefined && { siblingGroupId: msg.siblingGroupId }),
                        ...(msg.groundingMetadata && { groundingMetadata: msg.groundingMetadata }),
                        ...(msg.attachments && msg.attachments.length > 0 && { attachments: msg.attachments }),
                        ...(msg.usageMetadata && { usageMetadata: msg.usageMetadata }),
                        ...(msg.thoughtSummaryOpen !== undefined && { thoughtSummaryOpen: msg.thoughtSummaryOpen }),
                    }));
                    const hasPendingAssetsForSave = state.chatAssets.has("pending");
                    
                    const determineTitleAndSave = (existingChatData = null) => {
                        
                        let title;
                        if (optionalTitle !== null) {
                            title = optionalTitle;
                        } else if (existingChatData && existingChatData.title) {
                            title = existingChatData.title;
                        } else {
                            const firstUserMessage = state.currentMessages.find(m => m.role === 'user');
                            title = firstUserMessage ? firstUserMessage.content.substring(0, 50) : "辟｡鬘後・繝√Ε繝・ヨ";
                        }
                        // pending繧｢繧ｻ繝・ヨ縺後≠繧句ｴ蜷医・譁ｰ隕上メ繝｣繝・ヨ縺ｨ縺励※謇ｱ縺・                        const chatIdForOperation = (existingChatData && !hasPendingAssetsForSave) ? existingChatData.id : 
                                                  (hasPendingAssetsForSave ? null : state.currentChatId);
                        // 繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ蜷阪ｒ蜿門ｾ暦ｼ医Γ繝・そ繝ｼ繧ｸ縺九ｉ縺ｾ縺溘・pending縺九ｉ・・                        let characterName = null;
                        if (existingChatData && existingChatData.characterName) {
                            characterName = existingChatData.characterName;
                        } else {
                            // 繝｡繝・そ繝ｼ繧ｸ縺九ｉ繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ諠・ｱ繧貞叙蠕・                            const characterMessage = state.currentMessages.find(m => m.role === 'character');
                            if (characterMessage) {
                                characterName = characterMessage.content;
                            } else if (state.pendingCharacterName) {
                                characterName = state.pendingCharacterName;
                            }
                        }
                        
                        // 譌｢蟄伜､
                        const prev = existingChatData || {};
                        
                        // chatAssets縺九ｉ菫晏ｭ俶ｸ医∩縺ｮ繧｢繧ｻ繝・ヨ諠・ｱ繧貞叙蠕・                        const savedAssets = state.chatAssets.get(chatIdForOperation);
                        if (savedAssets) {
                            // chatAssets縺ｮ諠・ｱ繧貞━蜈・                            if (!prev.aiIconBlob && savedAssets.aiIconBlob) {
                                prev.aiIconBlob = savedAssets.aiIconBlob;
                            }
                            if (!prev.backgroundImageBlob && savedAssets.backgroundImageBlob) {
                                prev.backgroundImageBlob = savedAssets.backgroundImageBlob;
                            }
                            if (!prev.aiName && savedAssets.aiName) {
                                prev.aiName = savedAssets.aiName;
                            }
                        }
                        

                        // IndexedDB縺御ｽｿ逕ｨ縺ｧ縺阪↑縺・ｴ蜷医・繧｢繧ｻ繝・ヨ螟画峩繧堤┌蜉ｹ蛹・                        const isIdbUsable = state.env?.idbUsable !== false;
                        // pending繧｢繧ｻ繝・ヨ縺後≠繧句ｴ蜷医・譁ｰ隕上メ繝｣繝・ヨ縺ｨ縺励※謇ｱ縺・                        const isExistingChat = !!existingChatData && !hasPendingAssetsForSave;
                        
                        // 驥崎ｦ・ 蜷・メ繝｣繝・ヨ縺ｯ迢ｬ閾ｪ縺ｮ繧｢繧ｻ繝・ヨ繧呈戟縺､
                        let nextAiName, nextAiIconBlob, nextBgBlob;
                        
                        // 迴ｾ蝨ｨ縺ｮ繝√Ε繝・ヨ縺ｮchatAssets諠・ｱ繧貞叙蠕・                        // 譁ｰ隕上メ繝｣繝・ヨ縺ｮ蝣ｴ蜷医・"pending"縺九ｉ蜿門ｾ・                        const currentChatAssets = state.chatAssets.get(chatIdForOperation) || 
                            (!chatIdForOperation ? state.chatAssets.get("pending") : null);
                        
                        
                        // 譁ｰ隕上メ繝｣繝・ヨ縺ｧ"pending"縺後↑縺・ｴ蜷医∫樟蝨ｨ縺ｮUI縺ｮ蛟､縺九ｉ蜿門ｾ・                        let updatedCurrentChatAssets = currentChatAssets;
                        if (!isExistingChat && !currentChatAssets && !state.currentChatId) {
                            const pendingFromUI = {
                                aiName: state.settings.aiName || 'AI',
                                aiIconBlob: state.settings.aiIconBlob || null,
                                backgroundImageBlob: state.settings.backgroundImageBlob || null
                            };
                            if (pendingFromUI.aiIconBlob || pendingFromUI.backgroundImageBlob || pendingFromUI.aiName !== 'AI') {
                                state.chatAssets.set("pending", pendingFromUI);
                                updatedCurrentChatAssets = pendingFromUI;
                            }
                        }
                        
                        
                        if (isExistingChat) {
                            // 譌｢蟄倥メ繝｣繝・ヨ: chatAssets縺ｮ蛟､繧貞━蜈医√↑縺代ｌ縺ｰ菫晏ｭ俶ｸ医∩縺ｮ蛟､繧剃ｽｿ逕ｨ
                            // 縺溘□縺励｝ending繧｢繧ｻ繝・ヨ縺後≠繧句ｴ蜷医・譁ｰ隕上→縺励※謇ｱ縺・                            const pendingExists = !!state.chatAssets.get("pending");
                            if (pendingExists && updatedCurrentChatAssets) {
                                // pending繧｢繧ｻ繝・ヨ縺後≠繧句ｴ蜷医・縲√◎繧後ｒ蜆ｪ蜈・                                nextAiName = updatedCurrentChatAssets.aiName || prev.aiName || 'AI';
                                nextAiIconBlob = updatedCurrentChatAssets.aiIconBlob || prev.aiIconBlob;
                                nextBgBlob = updatedCurrentChatAssets.backgroundImageBlob || prev.backgroundImageBlob;
                            } else if (updatedCurrentChatAssets) {
                                nextAiName = updatedCurrentChatAssets.aiName || prev.aiName || 'AI';
                                nextAiIconBlob = updatedCurrentChatAssets.aiIconBlob !== undefined ? 
                                    updatedCurrentChatAssets.aiIconBlob : prev.aiIconBlob;
                                nextBgBlob = updatedCurrentChatAssets.backgroundImageBlob !== undefined ? 
                                    updatedCurrentChatAssets.backgroundImageBlob : prev.backgroundImageBlob;
                            } else {
                                nextAiName = prev.aiName || 'AI';
                                nextAiIconBlob = prev.aiIconBlob;
                                nextBgBlob = prev.backgroundImageBlob;
                            }
                            
                            // chatAssets縺ｫ譛譁ｰ縺ｮ諠・ｱ縺悟性縺ｾ繧後※縺・ｋ縺溘ａ縲‥irty繝輔Λ繧ｰ縺ｮ繝√ぉ繝・け縺ｯ荳崎ｦ・                        } else {
                            // 譁ｰ隕上メ繝｣繝・ヨ: chatAssets縺九ｉ蜿門ｾ励√↑縺代ｌ縺ｰstate.settings縺九ｉ蜿門ｾ・                            if (updatedCurrentChatAssets) {
                                nextAiName = updatedCurrentChatAssets.aiName || state.settings.aiName || 'AI';
                                // iOS蠖｢蠑上・蝣ｴ蜷医・豁｣縺励￥蜃ｦ逅・                                if (updatedCurrentChatAssets.aiIconBlob && updatedCurrentChatAssets.aiIconBlob.arrayBuffer) {
                                    nextAiIconBlob = updatedCurrentChatAssets.aiIconBlob;  // { arrayBuffer, type }蠖｢蠑上ｒ縺昴・縺ｾ縺ｾ菴ｿ逕ｨ
                                } else {
                                    nextAiIconBlob = updatedCurrentChatAssets.aiIconBlob || state.settings.aiIconBlob || null;
                                }
                                if (updatedCurrentChatAssets.backgroundImageBlob && updatedCurrentChatAssets.backgroundImageBlob.arrayBuffer) {
                                    nextBgBlob = updatedCurrentChatAssets.backgroundImageBlob;  // { arrayBuffer, type }蠖｢蠑上ｒ縺昴・縺ｾ縺ｾ菴ｿ逕ｨ
                                } else {
                                    nextBgBlob = updatedCurrentChatAssets.backgroundImageBlob || state.settings.backgroundImageBlob || null;
                                }
                            } else {
                                // pending縺後↑縺・ｴ蜷医・state.settings縺九ｉ蜿門ｾ・                                nextAiName = state.settings.aiName || 'AI';
                                nextAiIconBlob = state.settings.aiIconBlob || null;
                                nextBgBlob = state.settings.backgroundImageBlob || null;
                            }
                        }
                        // iOS迺ｰ蠅・ｒ讀懷・
                        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                        let finalAiIconBlob = nextAiIconBlob;
                        let finalBgBlob = nextBgBlob;
                        
                        // iOS迺ｰ蠅・〒縺ｮBlob讀懆ｨｼ
                        if (isIOS) {
                            
                            // iOS迺ｰ蠅・〒縺ｯ縲・撼繧｢繧ｯ繝・ぅ繝悶↑繝√Ε繝・ヨ縺ｮBlob縺ｯ譌｢蟄伜､繧剃ｿ晄戟
                            if (isExistingChat && chatIdForOperation !== state.currentChatId) {
                                finalAiIconBlob = prev.aiIconBlob || null;
                                finalBgBlob = prev.backgroundImageBlob || null;
                            } else {
                                // 譁ｰ隕上メ繝｣繝・ヨ縺ｾ縺溘・繧｢繧ｯ繝・ぅ繝悶↑繝√Ε繝・ヨ縺ｮ蝣ｴ蜷医・縲］ext縺ｮ蛟､繧剃ｽｿ逕ｨ
                                finalAiIconBlob = nextAiIconBlob;
                                finalBgBlob = nextBgBlob;
                            }
                            
                            // ArrayBuffer蠖｢蠑上・繝・・繧ｿ縺ｯ縺昴・縺ｾ縺ｾ菫晏ｭ・                            // (縺吶〒縺ｫArrayBuffer蠖｢蠑上↓縺ｪ縺｣縺ｦ縺・ｋ縺ｮ縺ｧ螟画鋤荳崎ｦ・
                        }
                        
                        const chatData = {
                                messages: messagesToSave,
                                updatedAt: now,
                                createdAt: existingChatData ? existingChatData.createdAt : now,
                                title: title,
                                characterName: characterName,
                                aiName: nextAiName,
                                aiIconBlob: finalAiIconBlob,
                                backgroundImageBlob: finalBgBlob,
                                chatSystemPrompt: state.chatSystemPrompt || null,
                                theme: state.currentChatTheme || state.settings.theme || 'light',
                            };
                            
                            
                            if (state.settings.persistMessageCollapseState) {
                                chatData.collapsedStates = Object.fromEntries(state.messageCollapsedStates);
                            } else if (existingChatData && existingChatData.collapsedStates) {
                                 chatData.collapsedStates = undefined;
                            }

                            if (chatIdForOperation) {
                                chatData.id = chatIdForOperation;
                            }
                            const request = store.put(chatData);
                            request.onsuccess = (event) => {
                            const savedId = event.target.result;
                            const savedChatId = chatIdForOperation || savedId;
                            
                            console.log('saveChat result:', { 
                                savedId, 
                                savedChatId,
                                isNewChat: !existingChatData, 
                                hadPendingAssets: hasPendingAssetsForSave,
                                chatIdForOperation
                            });
                            
                            // 譌｢蟄倥メ繝｣繝・ヨ縺ｮ蝣ｴ蜷医・縺ｿ縲∽ｿ晏ｭ倥＠縺溘メ繝｣繝・ヨ縺ｮ繧｢繧ｻ繝・ヨ諠・ｱ繧団hatAssets縺ｫ險倬鹸
                            // 譁ｰ隕上メ繝｣繝・ヨ縺ｮ蝣ｴ蜷医・蠕後〒蜃ｦ逅・☆繧・                            if (existingChatData) {
                                state.chatAssets.set(savedChatId, {
                                    aiName: chatData.aiName,
                                    aiIconBlob: chatData.aiIconBlob,
                                    backgroundImageBlob: chatData.backgroundImageBlob
                                });
                            }
                            // 驥崎ｦ・ 菫晏ｭ倥＠縺溘メ繝｣繝・ヨ縺檎樟蝨ｨ繧｢繧ｯ繝・ぅ繝悶↑繝√Ε繝・ヨ縺ｨ螳悟・縺ｫ荳閾ｴ縺吶ｋ蝣ｴ蜷医・縺ｿ繧ｯ繝ｪ繧｢
                            // 縺九▽縲∵眠隕丈ｽ懈・譎ゑｼ・existingChatData・峨∪縺溘・譏守､ｺ逧・↑螟画峩譎ゅ・縺ｿ繧ｯ繝ｪ繧｢
                            if (state.currentChatId === savedChatId && (!existingChatData || 
                                state.assetDirty.aiIcon || state.assetDirty.bgImage || state.assetDirty.aiName)) {
                                state.assetDirty = { aiIcon: false, bgImage: false, aiName: false };
                            }
                            
                            // pending繧｢繧ｻ繝・ヨ縺後≠繧句ｴ蜷医√∪縺溘・譁ｰ隕上メ繝｣繝・ヨ縺ｮ蝣ｴ蜷・                            if (!state.currentChatId && savedId) {
                                state.currentChatId = savedId;
                                
                                // 譁ｰ隕上メ繝｣繝・ヨ縺ｮ蝣ｴ蜷医…hatAssets縺ｫ逋ｻ骭ｲ
                                if (!state.chatAssets.has(savedId)) {
                                    // "pending"縺九ｉ繧ｳ繝斐・縺ｾ縺溘・譁ｰ隕丈ｽ懈・
                                    const pendingAssets = state.chatAssets.get("pending");
                                    if (pendingAssets) {
                                        // pendingAssets縺後≠繧句ｴ蜷医・縲…hatData縺ｫ菫晏ｭ倥＆繧後◆蛟､繧貞━蜈育噪縺ｫ菴ｿ逕ｨ
                                        state.chatAssets.set(savedId, {
                                            aiName: chatData.aiName || pendingAssets.aiName || 'AI',
                                            aiIconBlob: chatData.aiIconBlob || pendingAssets.aiIconBlob || null,
                                            backgroundImageBlob: chatData.backgroundImageBlob || pendingAssets.backgroundImageBlob || null,
                                            aiIconUrl: state.aiIconUrl || pendingAssets.aiIconUrl || null,
                                            backgroundImageUrl: state.backgroundImageUrl || pendingAssets.backgroundImageUrl || null
                                        });
                                        // "pending"繧貞炎髯､
                                        state.chatAssets.delete("pending");
                                    } else {
                                        // pendingAssets縺後↑縺・ｴ蜷医・縲…hatData縺九ｉ逶ｴ謗･險ｭ螳・                                        state.chatAssets.set(savedId, {
                                            aiName: chatData.aiName || 'AI',
                                            aiIconBlob: chatData.aiIconBlob || null,
                                            backgroundImageBlob: chatData.backgroundImageBlob || null,
                                            aiIconUrl: state.aiIconUrl || null,
                                            backgroundImageUrl: state.backgroundImageUrl || null
                                        });
                                    }
                                }
                            }
                            // 譌｢蟄倥メ繝｣繝・ヨ縺ｮ譖ｴ譁ｰ縺ｧ繧Ｑending繧｢繧ｻ繝・ヨ縺後≠繧後・蜑企勁
                            else if (hasPendingAssetsForSave && state.currentChatId === savedId) {
                                const pendingAssets = state.chatAssets.get("pending");
                                if (pendingAssets) {
                                    // 譌｢蟄倥・chatAssets繧呈峩譁ｰ
                                    const existingAssets = state.chatAssets.get(savedId) || {};
                                    state.chatAssets.set(savedId, {
                                        aiName: chatData.aiName || pendingAssets.aiName || existingAssets.aiName || 'AI',
                                        aiIconBlob: chatData.aiIconBlob || pendingAssets.aiIconBlob || existingAssets.aiIconBlob || null,
                                        backgroundImageBlob: chatData.backgroundImageBlob || pendingAssets.backgroundImageBlob || existingAssets.backgroundImageBlob || null,
                                        aiIconUrl: state.aiIconUrl || pendingAssets.aiIconUrl || existingAssets.aiIconUrl || null,
                                        backgroundImageUrl: state.backgroundImageUrl || pendingAssets.backgroundImageUrl || existingAssets.backgroundImageUrl || null
                                    });
                                    // "pending"繧貞炎髯､
                                    state.chatAssets.delete("pending");
                                }
                            }
                            if ((state.currentChatId || savedId) === savedChatId) {
                                uiUtils.updateChatTitle(chatData.title);
                            }
                            // 譁ｰ縺励＞繝√Ε繝・ヨ縺御ｽ懈・縺輔ｌ縺溘ｉpendingCharacterName繧偵け繝ｪ繧｢
                            if (!existingChatData && state.pendingCharacterName) {
                                // 繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ諠・ｱ縺御ｿ晏ｭ倥＆繧後◆縺ｮ縺ｧ縲｝ending繧偵け繝ｪ繧｢
                                setTimeout(() => {
                                    state.pendingCharacterName = null;
                                }, 100);
                            }
                            resolve(state.currentChatId || savedId);
                        };
                        request.onerror = (event) => {
                            // Safari Blob 繧ｨ繝ｩ繝ｼ蟇ｾ遲・ 繧ｨ繝ｩ繝ｼ譎ゅ↓迥ｶ諷九ｒ蠕ｩ蜈・                            state.settings.aiName = preservedState.aiName;
                            state.settings.aiIconBlob = preservedState.aiIconBlob;
                            state.settings.backgroundImageBlob = preservedState.backgroundImageBlob;
                            state.aiIconUrl = preservedState.aiIconUrl;
                            state.backgroundImageUrl = preservedState.backgroundImageUrl;
                            state.chatSystemPrompt = preservedState.chatSystemPrompt;
                            reject(`繝√Ε繝・ヨ菫晏ｭ湾ut繧ｨ繝ｩ繝ｼ: ${event.target.error.name} - ${event.target.error.message}`);
                        };
                    };
                    // pending繧｢繧ｻ繝・ヨ縺後≠繧句ｴ蜷医・蠢・★譁ｰ隕上メ繝｣繝・ヨ縺ｨ縺励※謇ｱ縺・                    
                    if (hasPendingAssetsForSave && !state.currentChatId) {
                        // 譁ｰ隕上メ繝｣繝・ヨ縺ｨ縺励※蜃ｦ逅・ｼ・urrentChatId縺ｯ螟画峩縺励↑縺・ｼ・                        determineTitleAndSave(null);
                    } else if (state.currentChatId) {
                        const getRequest = store.get(state.currentChatId);
                        getRequest.onsuccess = (event) => {
                            const existingChat = event.target.result;
                            if (!existingChat) {
                                state.currentChatId = null;
                                determineTitleAndSave(null);
                            } else {
                                determineTitleAndSave(existingChat);
                            }
                        };
                        getRequest.onerror = (event) => {
                            state.currentChatId = null;
                            determineTitleAndSave(null);
                        };
                    } else {
                        determineTitleAndSave(null);
                    }
                    store.transaction.onerror = (event) => {
                        // Safari Blob 繧ｨ繝ｩ繝ｼ蟇ｾ遲・ 繝医Λ繝ｳ繧ｶ繧ｯ繧ｷ繝ｧ繝ｳ繧ｨ繝ｩ繝ｼ譎ゅｂ迥ｶ諷九ｒ蠕ｩ蜈・                        state.settings.aiName = preservedState.aiName;
                        state.settings.aiIconBlob = preservedState.aiIconBlob;
                        state.settings.backgroundImageBlob = preservedState.backgroundImageBlob;
                        state.aiIconUrl = preservedState.aiIconUrl;
                        state.backgroundImageUrl = preservedState.backgroundImageUrl;
                        state.chatSystemPrompt = preservedState.chatSystemPrompt;
                        reject(`繝√Ε繝・ヨ菫晏ｭ倥ヨ繝ｩ繝ｳ繧ｶ繧ｯ繧ｷ繝ｧ繝ｳ螟ｱ謨・ ${event.target.error.name} - ${event.target.error.message}`);
                    };
                });
            },
            async updateChatTitleDb(id, newTitle) {
                await this.openDB();
                return new Promise((resolve, reject) => {
                    const store = this._getStore(CHATS_STORE, 'readwrite');
                    const getRequest = store.get(id);
                    getRequest.onsuccess = (event) => {
                        const chatData = event.target.result;
                        if (chatData) {
                            chatData.title = newTitle;
                            chatData.updatedAt = Date.now();
                            const putRequest = store.put(chatData);
                            putRequest.onsuccess = () => resolve();
                            putRequest.onerror = (event) => reject(`繧ｿ繧､繝医Ν譖ｴ譁ｰ繧ｨ繝ｩ繝ｼ: ${event.target.error}`);
                        } else {
                            reject(`繝√Ε繝・ヨ縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ: ${id}`);
                        }
                    };
                    getRequest.onerror = (event) => reject(`繧ｿ繧､繝医Ν譖ｴ譁ｰ逕ｨ繝√Ε繝・ヨ蜿門ｾ励お繝ｩ繝ｼ: ${event.target.error}`);
                    store.transaction.onerror = (event) => reject(`繧ｿ繧､繝医Ν譖ｴ譁ｰ繝医Λ繝ｳ繧ｶ繧ｯ繧ｷ繝ｧ繝ｳ螟ｱ謨・ ${event.target.error}`);
                });
            },
            async getChat(id) {
                await this.openDB();
                return new Promise((resolve, reject) => {
                    const store = this._getStore(CHATS_STORE);
                    const request = store.get(id);
                    request.onsuccess = (event) => resolve(event.target.result);
                    request.onerror = (event) => reject(`繝√Ε繝・ヨ ${id} 蜿門ｾ励お繝ｩ繝ｼ: ${event.target.error}`);
                });
            },
            async getAllChats(sortBy = 'updatedAt') {
                await this.openDB();
                return new Promise((resolve, reject) => {
                    const store = this._getStore(CHATS_STORE);
                    const indexName = sortBy === 'createdAt' ? CHAT_CREATEDAT_INDEX : CHAT_UPDATEDAT_INDEX;
                    if (!store.indexNames.contains(indexName)) {
                         const getAllRequest = store.getAll();
                         getAllRequest.onsuccess = (event) => resolve(event.target.result.reverse());
                         getAllRequest.onerror = (event) => reject(`蜈ｨ繝√Ε繝・ヨ蜿門ｾ励お繝ｩ繝ｼ(繝輔か繝ｼ繝ｫ繝舌ャ繧ｯ): ${event.target.error}`);
                         return;
                    }
                    const index = store.index(indexName);
                    const request = index.openCursor(null, 'prev');
                    const chats = [];
                    request.onsuccess = (event) => {
                        const cursor = event.target.result;
                        if (cursor) {
                            chats.push(cursor.value);
                            cursor.continue();
                        } else {
                            resolve(chats);
                        }
                    };
                    request.onerror = (event) => reject(`蜈ｨ繝√Ε繝・ヨ蜿門ｾ励お繝ｩ繝ｼ (${sortBy}鬆・: ${event.target.error}`);
                });
            },
            async deleteChat(id) {
                await this.openDB();
                return new Promise((resolve, reject) => {
                    const store = this._getStore(CHATS_STORE, 'readwrite');
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(`繝√Ε繝・ヨ ${id} 蜑企勁繧ｨ繝ｩ繝ｼ: ${event.target.error}`);
                });
            },
            async clearAllData() {
                await this.openDB();
                return new Promise((resolve, reject) => {
                    const transaction = state.db.transaction([SETTINGS_STORE, CHATS_STORE], 'readwrite');
                    let storesCleared = 0;
                    const totalStores = 2;

                    const onComplete = () => {
                        if (++storesCleared === totalStores) {
                            resolve();
                        }
                    };
                    const onError = (storeName, event) => reject(`${storeName} 繧ｯ繝ｪ繧｢繧ｨ繝ｩ繝ｼ: ${event.target.error}`);

                    const settingsStore = transaction.objectStore(SETTINGS_STORE);
                    const chatsStore = transaction.objectStore(CHATS_STORE);

                    const clearSettingsReq = settingsStore.clear();
                    const clearChatsReq = chatsStore.clear();

                    clearSettingsReq.onsuccess = onComplete;
                    clearSettingsReq.onerror = (e) => onError(SETTINGS_STORE, e);
                    clearChatsReq.onsuccess = onComplete;
                    clearChatsReq.onerror = (e) => onError(CHATS_STORE, e);
                    transaction.onerror = (event) => reject(`繝・・繧ｿ繧ｯ繝ｪ繧｢繝医Λ繝ｳ繧ｶ繧ｯ繧ｷ繝ｧ繝ｳ螟ｱ謨・ ${event.target.error}`);
                });
            },
            async clearAllChatsStore() {
                await this.openDB();
                return new Promise((resolve, reject) => {
                    const transaction = state.db.transaction([CHATS_STORE], 'readwrite');
                    const chatsStore = transaction.objectStore(CHATS_STORE);
                    const clearChatsReq = chatsStore.clear();

                    clearChatsReq.onsuccess = () => resolve();
                    clearChatsReq.onerror = (e) => reject(`CHATS_STORE 繧ｯ繝ｪ繧｢繧ｨ繝ｩ繝ｼ: ${e.target.error}`);
                    transaction.onerror = (event) => reject(`繝√Ε繝・ヨ螻･豁ｴ繧ｯ繝ｪ繧｢繝医Λ繝ｳ繧ｶ繧ｯ繧ｷ繝ｧ繝ｳ螟ｱ謨・ ${event.target.error}`);
                });
            }
        };

        const uiUtils = {
            // iOS Safari蛻､螳夐未謨ｰ
            isIOSSafari() {
                const ua = navigator.userAgent;
                const isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
                const isSafari = /Safari/.test(ua) && !/Chrome/.test(ua) && !/CriOS/.test(ua);
                return isIOS && isSafari;
            },
            _sanitizeAndParseMarkdown(content) {
                if (typeof DOMPurify === 'undefined') {
                    const div = document.createElement('div');
                    div.textContent = content || '';
                    return div.innerHTML;
                }
                const rawHtml = marked.parse(content || '');
                const cleanHtml = DOMPurify.sanitize(rawHtml, {
                    ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'blockquote', 'pre', 'code', 'a', 'table', 'thead', 'tbody', 'tr', 'th', 'td', 'hr', 'img'],
                    ALLOWED_ATTR: ['href', 'title', 'target', 'rel', 'src', 'alt']
                });
                return cleanHtml;
            },
            renderChatMessages(maintainScroll = false) {
                const mainContent = elements.chatScreen.querySelector('.main-content');
                const oldScrollTop = maintainScroll ? mainContent.scrollTop : null;
                const oldScrollHeight = maintainScroll ? mainContent.scrollHeight : null;

                if (state.editingMessageIndex !== null) {
                    const messageElement = elements.messageContainer.querySelector(`.message[data-index="${state.editingMessageIndex}"]`);
                    if(messageElement) appLogic.cancelEditMessage(state.editingMessageIndex, messageElement);
                    else state.editingMessageIndex = null;
                }

                elements.messageContainer.innerHTML = '';
                let currentSiblingGroupId = null;
                let siblingsInGroup = [];
                let siblingIndex = 0;

                for (let i = 0; i < state.currentMessages.length; i++) {
                    const msg = state.currentMessages[i];
                    if (msg.role === 'model' && msg.isCascaded && msg.siblingGroupId) {
                        if (msg.siblingGroupId !== currentSiblingGroupId) {
                            currentSiblingGroupId = msg.siblingGroupId;
                            siblingsInGroup = state.currentMessages.filter(m => m.role === 'model' && m.isCascaded && m.siblingGroupId === currentSiblingGroupId);
                            siblingIndex = 0;
                        }
                        const currentIndexInGroup = siblingsInGroup.findIndex(m => m === msg);
                        if (currentIndexInGroup !== -1) {
                            siblingIndex = currentIndexInGroup + 1;
                        }

                        if (msg.isSelected) {
                            this.appendMessage(msg.role, msg.content, i, false, {
                                currentIndex: siblingIndex,
                                total: siblingsInGroup.length,
                                siblingGroupId: currentSiblingGroupId
                            }, msg.attachments);
                        }
                    } else {
                        currentSiblingGroupId = null;
                        siblingsInGroup = [];
                        this.appendMessage(msg.role, msg.content, i, false, null, msg.attachments);
                    }
                }
                if (maintainScroll && oldScrollTop !== null) {
                    requestAnimationFrame(() => {
                        const newScrollHeight = mainContent.scrollHeight;
                        mainContent.scrollTop = oldScrollTop + (newScrollHeight - oldScrollHeight);
                    });
                }
            },
            appendMessage(role, content, index, isStreamingPlaceholder = false, cascadeInfo = null, attachments = null) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', role);
                messageDiv.dataset.index = index;

                if (role === 'user') {
                    if (state.settings.showUserIcon && state.userIconUrl) {
                        const iconImg = document.createElement('img');
                        iconImg.src = state.userIconUrl;
                        iconImg.alt = "User Icon";
                        iconImg.classList.add('message-icon');
                        messageDiv.appendChild(iconImg);
                    }
                    if (state.settings.showUserName && state.settings.userName) {
                        const nameSpan = document.createElement('span');
                        nameSpan.classList.add('message-icon-name');
                        if (state.settings.showUserNameBubble) {
                            nameSpan.classList.add('has-bubble');
                        }
                        nameSpan.textContent = state.settings.userName;
                        messageDiv.appendChild(nameSpan);
                    }
                } else if (role === 'model') {
                    // 迴ｾ蝨ｨ縺ｮ繝√Ε繝・ヨ縺ｮ繧｢繧ｻ繝・ヨ諠・ｱ繧貞叙蠕・                    // 譁ｰ隕上メ繝｣繝・ヨ縺ｮ蝣ｴ蜷医・"pending"縺九ｉ蜿門ｾ・                    const currentChatAssets = state.currentChatId ? 
                        state.chatAssets.get(state.currentChatId) : 
                        state.chatAssets.get("pending");
                    const iconUrl = currentChatAssets?.aiIconUrl || state.aiIconUrl;
                    const aiName = currentChatAssets?.aiName || state.settings.aiName || 'AI';
                    
                    if (state.settings.showAiIcon && iconUrl) {
                        const iconImg = document.createElement('img');
                        iconImg.src = iconUrl;
                        iconImg.alt = "AI Icon";
                        iconImg.classList.add('message-icon');
                        messageDiv.appendChild(iconImg);
                    }
                    if (state.settings.showAiName) {
                        const nameSpan = document.createElement('span');
                        nameSpan.classList.add('message-icon-name');
                        if (state.settings.showAiNameBubble) {
                            nameSpan.classList.add('has-bubble');
                        }
                        nameSpan.textContent = aiName;
                        messageDiv.appendChild(nameSpan);
                    }
                }

                const messageData = state.currentMessages[index];
                const messageApiProvider = messageData?.generatedByApiProvider || state.settings.apiProvider;
                const includeThoughtsForProvider = (messageApiProvider === 'gemini' && state.settings.geminiIncludeThoughts) ||
                                                 (messageApiProvider === 'deepseek' && state.settings.deepSeekIncludeDeepSeekThoughts) ||
                                                 (messageApiProvider === 'claude' && state.settings.claudeIncludeThoughts) ||
                                                 (messageApiProvider === 'xai' && state.settings.xaiIncludeThoughts) ||
                                                 (messageApiProvider === 'llmaggregator' && state.settings.llmAggregatorIncludeThoughts);

                let initialThoughtOpenState = false;
                if (isStreamingPlaceholder) {
                    initialThoughtOpenState = state.currentMessages[index]?.thoughtSummaryOpen || false;
                } else if (messageData && messageData.thoughtSummaryOpen !== undefined) {
                    initialThoughtOpenState = messageData.thoughtSummaryOpen;
                } else if (includeThoughtsForProvider) {
                     initialThoughtOpenState = (messageApiProvider === 'gemini' && state.settings.geminiExpandThoughtsByDefault) ||
                                               (messageApiProvider === 'deepseek' && state.settings.deepSeekExpandThoughtsByDefault) ||
                                               (messageApiProvider === 'claude' && state.settings.claudeExpandThoughtsByDefault) ||
                                               (messageApiProvider === 'xai' && state.settings.xaiExpandThoughtsByDefault) ||
                                               (messageApiProvider === 'llmaggregator' && state.settings.llmAggregatorExpandThoughtsByDefault);
                }

                if (role === 'model' && includeThoughtsForProvider && (messageData?.thoughtSummary || messageData?.deepSeekThoughtSummary || messageData?.xaiThoughtSummary || isStreamingPlaceholder)) {
                    const thoughtDetails = document.createElement('details');
                    thoughtDetails.classList.add('thought-summary-details');
                    thoughtDetails.dataset.messageIndex = index;
                    thoughtDetails.open = initialThoughtOpenState;

                    thoughtDetails.addEventListener('toggle', (event) => {
                         const msgIndex = parseInt(thoughtDetails.dataset.messageIndex, 10);
                         if (state.currentMessages[msgIndex]) {
                            state.currentMessages[msgIndex].thoughtSummaryOpen = event.target.open;
                             if(!state.isSending && !state.isAiToAiChatProcessing && !isStreamingPlaceholder) {
                                dbUtils.saveChat();
                             }
                        }
                    });

                    const thoughtSummaryElem = document.createElement('summary');
                    thoughtSummaryElem.textContent = '諤晁・・繝ｭ繧ｻ繧ｹ';
                    thoughtDetails.appendChild(thoughtSummaryElem);

                    const thoughtContentDiv = document.createElement('div');
                    thoughtContentDiv.classList.add('thought-summary-content');

                    if (isStreamingPlaceholder) {
                        thoughtContentDiv.id = `streaming-thought-summary-${index}`;
                        const pre = document.createElement('pre');
                        pre.style.whiteSpace = 'pre-wrap';
                        pre.style.wordBreak = 'break-all';
                        thoughtContentDiv.appendChild(pre);
                    } else if (messageData?.thoughtSummary || messageData?.xaiThoughtSummary) {
                        const pre = document.createElement('pre');
                        pre.textContent = messageData.thoughtSummary || messageData.xaiThoughtSummary || '';
                        pre.style.whiteSpace = 'pre-wrap';
                        pre.style.wordBreak = 'break-all';
                        thoughtContentDiv.appendChild(pre);
                    } else if (messageData?.deepSeekThoughtSummary) {
                        const pre = document.createElement('pre');
                        pre.textContent = messageData.deepSeekThoughtSummary || '';
                        thoughtContentDiv.appendChild(pre);
                    }
                    thoughtDetails.appendChild(thoughtContentDiv);
                    messageDiv.appendChild(thoughtDetails);
                }

                if (state.areAllMessagesHidden && (role === 'user' || role === 'model') && !isStreamingPlaceholder) {
                    messageDiv.classList.add('message-hidden-by-toggle');
                }

                const isCurrentlyCollapsed = state.messageCollapsedStates.get(index) || false;

                if (isCurrentlyCollapsed) {
                     messageDiv.classList.add('message-content-collapsed-fully');
                }

                if (role !== 'error' && state.settings.showTopCollapseButton) {
                    const toggleButtonTop = document.createElement('button');
                    toggleButtonTop.classList.add('message-toggle-button', 'top');
                    toggleButtonTop.dataset.index = index;
                    toggleButtonTop.dataset.action = 'toggle-collapse';
                    toggleButtonTop.textContent = isCurrentlyCollapsed ? state.settings.toggleButtonTopTextExpand : state.settings.toggleButtonTopTextCollapse;
                    const topTitle = isCurrentlyCollapsed ? '繝｡繝・そ繝ｼ繧ｸ繧貞ｱ暮幕' : '繝｡繝・そ繝ｼ繧ｸ繧呈釜繧翫◆縺溘・';
                    toggleButtonTop.title = topTitle;
                    toggleButtonTop.setAttribute('aria-label', topTitle);
                    messageDiv.appendChild(toggleButtonTop);
                }

                const contentDiv = document.createElement('div');
                contentDiv.classList.add('message-content');
                if (isStreamingPlaceholder) {
                    contentDiv.id = `streaming-content-${index}`;
                }

                if (isCurrentlyCollapsed) {
                    contentDiv.classList.add('collapsed');
                    const toggleButtonTopElement = messageDiv.querySelector('.message-toggle-button.top');
                    if (toggleButtonTopElement) {
                        toggleButtonTopElement.textContent = state.settings.toggleButtonTopTextExpand;
                        toggleButtonTopElement.title = '繝｡繝・そ繝ｼ繧ｸ繧貞ｱ暮幕';
                        toggleButtonTopElement.setAttribute('aria-label', '繝｡繝・そ繝ｼ繧ｸ繧貞ｱ暮幕');
                    }
                }

                if (role === 'user' && attachments && attachments.length > 0) {
                    const details = document.createElement('details');
                    details.classList.add('attachment-details');
                    const summary = document.createElement('summary');
                    summary.textContent = `豺ｻ莉倥ヵ繧｡繧､繝ｫ (${attachments.length}莉ｶ)`;
                    details.appendChild(summary);

                    const list = document.createElement('ul');
                    list.classList.add('attachment-list');

                    attachments.forEach((att, attachmentIndex) => {
                        const listItem = document.createElement('li');
                        listItem.dataset.attachmentIndex = attachmentIndex;
                        const itemContainer = document.createElement('div');
                        itemContainer.classList.add('attachment-list-item-container');

                        const nameSpan = document.createElement('span');
                        nameSpan.classList.add('attachment-list-item-name');
                        nameSpan.textContent = sanitizeText(att.name);
                        nameSpan.title = `${sanitizeText(att.name)} (${sanitizeText(att.mimeType)})`;

                        const actionsDiv = document.createElement('div');
                        actionsDiv.classList.add('attachment-actions');

                        if (att.mimeType.startsWith('image/')) {
                            const previewBtn = document.createElement('button');
                            previewBtn.textContent = '陦ｨ遉ｺ';
                            previewBtn.classList.add('attachment-preview-btn');
                            previewBtn.onclick = (e) => {
                                e.preventDefault();
                                appLogic.previewAttachment(index, attachmentIndex);
                            };
                            actionsDiv.appendChild(previewBtn);
                        }

                        const editBtn = document.createElement('button');
                        editBtn.textContent = '邱ｨ髮・;
                        editBtn.classList.add('attachment-edit-btn');
                        editBtn.onclick = (e) => {
                            e.preventDefault();
                            appLogic.editAttachment(index, attachmentIndex);
                        };

                        const removeBtn = document.createElement('button');
                        removeBtn.textContent = '蜑企勁';
                        removeBtn.classList.add('attachment-remove-btn');
                        removeBtn.onclick = (e) => {
                            e.preventDefault();
                            appLogic.removeAttachment(index, attachmentIndex, listItem);
                        };
                        
                        actionsDiv.appendChild(editBtn);
                        actionsDiv.appendChild(removeBtn);
                        itemContainer.appendChild(nameSpan);
                        itemContainer.appendChild(actionsDiv);
                        listItem.appendChild(itemContainer);
                        list.appendChild(listItem);
                    });

                    details.appendChild(list);
                    
                    const addMoreBtn = document.createElement('button');
                    addMoreBtn.textContent = '繝輔ぃ繧､繝ｫ繧定ｿｽ蜉';
                    addMoreBtn.classList.add('add-more-attachments-btn');
                    addMoreBtn.onclick = (e) => {
                        e.preventDefault();
                        appLogic.addMoreAttachments(index, list);
                    };
                    details.appendChild(addMoreBtn);

                    contentDiv.appendChild(details);

                    if (content && content.trim() !== '') {
                        const pre = document.createElement('pre');
                        pre.textContent = content;
                        pre.style.marginTop = '8px';
                        contentDiv.appendChild(pre);
                    }
                } else {
                    try {
                        if (role === 'model' && !isStreamingPlaceholder && typeof marked !== 'undefined') {
                            const safeHtml = this._sanitizeAndParseMarkdown(content || '');
                            contentDiv.innerHTML = safeHtml;
                            this.processInteractivePlaceholders(contentDiv);
                            this.processInteractiveTitles(contentDiv);
                            this.addCopyButtonsToCodeBlocks(contentDiv, false);
                            this.addImageClickListeners(contentDiv);
                        } else if (role === 'user') {
                            const pre = document.createElement('pre'); pre.textContent = content; contentDiv.appendChild(pre);
                        } else if (role === 'error') {
                             const p = document.createElement('p'); p.textContent = content; contentDiv.appendChild(p);
                        } else if (isStreamingPlaceholder) {
                            contentDiv.innerHTML = '';
                        } else {
                            const pre = document.createElement('pre'); pre.textContent = content; contentDiv.innerHTML = ''; contentDiv.appendChild(pre);
                        }
                    } catch (e) {
                         const pre = document.createElement('pre'); pre.textContent = content; contentDiv.innerHTML = ''; contentDiv.appendChild(pre);
                    }
                }
                messageDiv.appendChild(contentDiv);

                const citationDetailsDiv = document.createElement('div');
                citationDetailsDiv.classList.add('citation-details-container');
                if (isStreamingPlaceholder) {
                    citationDetailsDiv.id = `streaming-citations-${index}`;
                }
                messageDiv.appendChild(citationDetailsDiv);
                this.renderCitations(messageData, citationDetailsDiv);

                const editArea = document.createElement('div');
                editArea.classList.add('message-edit-area', 'hidden');
                messageDiv.appendChild(editArea);

                if (role === 'model' && cascadeInfo && cascadeInfo.total > 1) {
                    const cascadeControlsDiv = document.createElement('div');
                    cascadeControlsDiv.classList.add('message-cascade-controls');

                    const prevButton = document.createElement('button');
                    prevButton.textContent = '・・;
                    prevButton.title = '蜑阪・蠢懃ｭ・;
                    prevButton.classList.add('cascade-prev-btn');
                    prevButton.disabled = cascadeInfo.currentIndex <= 1;
                    prevButton.onclick = () => appLogic.navigateCascade(index, 'prev');
                    cascadeControlsDiv.appendChild(prevButton);

                    const indicatorSpan = document.createElement('span');
                    indicatorSpan.classList.add('cascade-indicator');
                    indicatorSpan.textContent = `${cascadeInfo.currentIndex}/${cascadeInfo.total}`;
                    cascadeControlsDiv.appendChild(indicatorSpan);

                    const nextButton = document.createElement('button');
                    nextButton.textContent = '・・;
                    nextButton.title = '谺｡縺ｮ蠢懃ｭ・;
                    nextButton.classList.add('cascade-next-btn');
                    nextButton.disabled = cascadeInfo.currentIndex >= cascadeInfo.total;
                    nextButton.onclick = () => appLogic.navigateCascade(index, 'next');
                    cascadeControlsDiv.appendChild(nextButton);

                    const deleteCascadeButton = document.createElement('button');
                    deleteCascadeButton.textContent = '笨・;
                    deleteCascadeButton.title = '縺薙・蠢懃ｭ斐ｒ蜑企勁';
                    deleteCascadeButton.classList.add('cascade-delete-btn');
                    deleteCascadeButton.onclick = () => appLogic.confirmDeleteCascadeResponse(index);
                    cascadeControlsDiv.appendChild(deleteCascadeButton);

                    messageDiv.appendChild(cascadeControlsDiv);
                }

                if (role !== 'error') {
                    const actionsDiv = document.createElement('div');
                    actionsDiv.classList.add('message-actions');

                    if (state.settings.showBottomCollapseButton) {
                        const toggleButtonBottom = document.createElement('button');
                        toggleButtonBottom.classList.add('message-toggle-button', 'bottom');
                        toggleButtonBottom.dataset.index = index;
                        toggleButtonBottom.dataset.action = 'toggle-collapse';
                        toggleButtonBottom.textContent = isCurrentlyCollapsed ? state.settings.toggleButtonBottomTextExpand : state.settings.toggleButtonBottomTextCollapse;
                        const bottomTitle = isCurrentlyCollapsed ? '繝｡繝・そ繝ｼ繧ｸ繧貞ｱ暮幕' : '繝｡繝・そ繝ｼ繧ｸ繧呈釜繧翫◆縺溘・';
                        toggleButtonBottom.title = bottomTitle;
                        toggleButtonBottom.setAttribute('aria-label', bottomTitle);
                        if (actionsDiv.firstChild) {
                            actionsDiv.insertBefore(toggleButtonBottom, actionsDiv.firstChild);
                        } else {
                            actionsDiv.appendChild(toggleButtonBottom);
                        }
                    }

                    const editButton = document.createElement('button');
                    editButton.textContent = '邱ｨ髮・; editButton.title = '繝｡繝・そ繝ｼ繧ｸ繧堤ｷｨ髮・; editButton.classList.add('js-edit-btn');
                    editButton.onclick = () => appLogic.startEditMessage(index, messageDiv);
                    actionsDiv.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = '蜑企勁'; deleteButton.title = '縺薙・莨夊ｩｱ繧ｿ繝ｼ繝ｳ繧貞炎髯､'; deleteButton.classList.add('js-delete-btn');
                    deleteButton.onclick = () => appLogic.deleteMessage(index);
                    actionsDiv.appendChild(deleteButton);

                    const copyButton = document.createElement('button');
                    copyButton.textContent = '繧ｳ繝斐・';
                    copyButton.title = '繝・く繧ｹ繝医ｒ繧ｳ繝斐・';
                    copyButton.classList.add('js-copy-btn');
                    copyButton.onclick = (event) => {
                        event.stopPropagation();
                        appLogic.copyMessageText(index, copyButton);
                    };
                    actionsDiv.appendChild(copyButton);

                    if (role === 'user' || role === 'model') {
                        const retryButton = document.createElement('button');
                        retryButton.textContent = '繝ｪ繝医Λ繧､';
                        retryButton.title = '縺薙・繝｡繝・そ繝ｼ繧ｸ縺九ｉ蜀咲函謌・;
                        retryButton.classList.add('js-retry-btn');
                        retryButton.onclick = () => {
                            const userIndexForRetry = (role === 'model' && index > 0) ? appLogic.findPreviousUserIndex(index) : index;
                            if(userIndexForRetry !== -1) appLogic.retryFromMessage(userIndexForRetry);
                        };
                        actionsDiv.appendChild(retryButton);
                    }

                    if (role === 'model' && messageData?.usageMetadata &&
                        typeof messageData.usageMetadata.candidatesTokenCount === 'number' &&
                        typeof messageData.usageMetadata.totalTokenCount === 'number')
                    {
                        const usage = messageData.usageMetadata;
                        const tokenSpan = document.createElement('span');
                        tokenSpan.classList.add('token-count-display');

                        let finalTotalTokenCount = usage.totalTokenCount;
                        if (typeof messageData.usageMetadata.thoughtsTokenCount === 'number' && messageApiProvider === 'gemini') {
                            finalTotalTokenCount -= messageData.usageMetadata.thoughtsTokenCount;
                        }

                        const formattedCandidates = usage.candidatesTokenCount.toLocaleString('en-US');
                        const formattedTotal = finalTotalTokenCount.toLocaleString('en-US');

                        tokenSpan.textContent = `${formattedCandidates} / ${formattedTotal}`;
                        tokenSpan.title = `Candidate Tokens / Total Tokens`;
                        actionsDiv.appendChild(tokenSpan);
                    }
                    messageDiv.appendChild(actionsDiv);
                }

                if (isStreamingPlaceholder) {
                    messageDiv.id = `streaming-message-${index}`;
                }
                elements.messageContainer.appendChild(messageDiv);
            },
            updateMemoStackHeightSettingsVisibility() {
                const showMemoBtn = elements.showMemoButtonToggle.checked;
                const showClipboardStackBtn = elements.showClipboardStackButtonToggle.checked;
                const shouldShow = showMemoBtn || showClipboardStackBtn;
                elements.memoStackHeightSettings.classList.toggle('hidden', !shouldShow);
            },
            renderCitations(messageData, containerDiv) {
                if (!containerDiv) return;
                containerDiv.innerHTML = '';

                const messageApiProvider = messageData?.generatedByApiProvider || state.settings.apiProvider;
                if (messageApiProvider === 'gemini' && messageData && messageData.groundingMetadata &&
                    ((messageData.groundingMetadata.groundingChunks && messageData.groundingMetadata.groundingChunks.length > 0) ||
                     (messageData.groundingMetadata.webSearchQueries && messageData.groundingMetadata.webSearchQueries.length > 0)))
                {
                    const details = document.createElement('details');
                    details.classList.add('citation-details');
                    const summary = document.createElement('summary');
                    summary.textContent = '蠑慕畑蜈・讀懃ｴ｢繧ｯ繧ｨ繝ｪ';
                    details.appendChild(summary);
                    let detailsHasContent = false;

                    if (messageData.groundingMetadata.groundingChunks && messageData.groundingMetadata.groundingChunks.length > 0) {
                        const citationList = document.createElement('ul');
                        citationList.classList.add('citation-list');
                        const citationMap = new Map();
                        let displayIndexCounter = 1;

                        if (messageData.groundingMetadata.groundingSupports) {
                            messageData.groundingMetadata.groundingSupports.forEach(support => {
                                if (support.groundingChunkIndices) {
                                    support.groundingChunkIndices.forEach(chunkIndex => {
                                        if (!citationMap.has(chunkIndex) && chunkIndex >= 0 && chunkIndex < messageData.groundingMetadata.groundingChunks.length) {
                                            const chunk = messageData.groundingMetadata.groundingChunks[chunkIndex];
                                            if (chunk?.web?.uri) {
                                                citationMap.set(chunkIndex, {
                                                    uri: chunk.web.uri,
                                                    title: chunk.web.title || '繧ｿ繧､繝医Ν荳肴・',
                                                    displayIndex: displayIndexCounter++
                                                });
                                            }
                                        }
                                    });
                                }
                            });
                        }
                        const sortedCitations = Array.from(citationMap.entries()).sort(([, a], [, b]) => a.displayIndex - b.displayIndex);
                        sortedCitations.forEach(([chunkIndex, citationInfo]) => {
                            const listItem = document.createElement('li');
                            const link = document.createElement('a');
                            link.href = citationInfo.uri;
                            link.textContent = `[${citationInfo.displayIndex}] ${citationInfo.title}`;
                            link.title = citationInfo.title;
                            link.target = '_blank';
                            link.rel = 'noopener noreferrer';
                            listItem.appendChild(link);
                            citationList.appendChild(listItem);
                        });
                        if (sortedCitations.length === 0) {
                             messageData.groundingMetadata.groundingChunks.forEach((chunk, idx) => {
                                 if (chunk?.web?.uri) {
                                     const listItem = document.createElement('li');
                                     const link = document.createElement('a');
                                     link.href = chunk.web.uri;
                                     link.textContent = chunk.web.title || `繧ｽ繝ｼ繧ｹ ${idx + 1}`;
                                     link.title = chunk.web.title || '繧ｿ繧､繝医Ν荳肴・';
                                     link.target = '_blank';
                                     link.rel = 'noopener noreferrer';
                                     listItem.appendChild(link);
                                     citationList.appendChild(listItem);
                                 }
                             });
                        }
                        if (citationList.hasChildNodes()) {
                            details.appendChild(citationList);
                            detailsHasContent = true;
                        }
                    }

                    if (messageData.groundingMetadata.webSearchQueries && messageData.groundingMetadata.webSearchQueries.length > 0) {
                        if (detailsHasContent) {
                            const separator = document.createElement('hr');
                            separator.style.marginTop = '10px';
                            separator.style.marginBottom = '8px';
                            separator.style.border = 'none';
                            separator.style.borderTop = '1px dashed var(--border-tertiary)';
                            details.appendChild(separator);
                        }
                        const queryHeader = document.createElement('div');
                        queryHeader.textContent = '讀懃ｴ｢縺ｫ菴ｿ逕ｨ縺輔ｌ縺溘け繧ｨ繝ｪ:';
                        queryHeader.style.fontWeight = '500';
                        queryHeader.style.marginTop = detailsHasContent ? '0' : '8px';
                        queryHeader.style.marginBottom = '4px';
                        queryHeader.style.fontSize = '11px';
                        queryHeader.style.color = 'var(--text-secondary)';
                        details.appendChild(queryHeader);

                        const queryList = document.createElement('ul');
                        queryList.classList.add('search-query-list');
                        queryList.style.listStyle = 'none';
                        queryList.style.paddingLeft = '0';
                        queryList.style.margin = '0';
                        queryList.style.fontSize = '11px';
                        queryList.style.color = 'var(--text-secondary)';
                        messageData.groundingMetadata.webSearchQueries.forEach(query => {
                            const queryItem = document.createElement('li');
                            queryItem.textContent = `窶｢ ${query}`;
                            queryItem.style.marginBottom = '3px';
                            queryList.appendChild(queryItem);
                        });
                        details.appendChild(queryList);
                        detailsHasContent = true;
                    }
                    if (detailsHasContent) {
                        containerDiv.appendChild(details);
                    }
                }
            },
            addCopyButtonsToCodeBlocks(contentDiv, isStreamingContext = false) {
                const codeBlocks = contentDiv.querySelectorAll('pre');
                codeBlocks.forEach(preElement => {
                    if (this.isMermaidCode(preElement) && !isStreamingContext) {
                        const codeElement = preElement.querySelector('code');
                        const mermaidCode = codeElement ? codeElement.innerText : preElement.innerText;
                        this.processMermaidBlock(preElement, mermaidCode);
                        return;
                    }

                    const codeElement = preElement.querySelector('code');
                    const textToCopy = codeElement ? codeElement.innerText : preElement.innerText;

                    if (textToCopy && textToCopy.trim() !== '') {
                        const copyButton = document.createElement('button');
                        copyButton.textContent = '繧ｳ繝斐・';
                        copyButton.classList.add('code-copy-button');
                        copyButton.title = '繧ｳ繝ｼ繝峨ｒ繧ｳ繝斐・';
                        copyButton.onclick = (event) => {
                            event.stopPropagation();
                            navigator.clipboard.writeText(textToCopy).then(() => {
                                const originalText = copyButton.textContent;
                                copyButton.textContent = '繧ｳ繝斐・螳御ｺ・';
                                copyButton.disabled = true;
                                setTimeout(() => {
                                    copyButton.textContent = originalText;
                                    copyButton.disabled = false;
                                }, 1500);
                        }).catch(err => {
                                const originalText = copyButton.textContent;
                                copyButton.textContent = '螟ｱ謨・;
                                copyButton.disabled = true;
                                setTimeout(() => {
                                    copyButton.textContent = originalText;
                                    copyButton.disabled = false;
                                }, 2000);
                            });
                        };
                        preElement.appendChild(copyButton);
                    }
                });
            },
            isMermaidCode(preElement) {
                const codeElement = preElement.querySelector('code');
                if (codeElement && (
                    codeElement.classList.contains('language-mermaid') ||
                    codeElement.classList.contains('mermaid')
                )) {
                    return true;
                }

                const content = preElement.textContent.trim();
                const mermaidKeywords = [
                    'graph', 'flowchart', 'sequenceDiagram', 'classDiagram',
                    'stateDiagram', 'journey', 'gantt', 'pie', 'gitgraph',
                    'erDiagram', 'mindmap', 'timeline', 'sankey'
                ];
                
                return mermaidKeywords.some(keyword => content.includes(keyword));
            },
            async processMermaidBlock(preElement, mermaidCode) {
                if (typeof mermaid === 'undefined') {
                    return;
                }

                const getCurrentMermaidTheme = () => {
                    const bodyClasses = document.body.classList;
                    if (bodyClasses.contains('dark-mode')) {
                        return 'dark';
                    } else if (bodyClasses.contains('pastel-pink-mode')) {
                        return 'base';
                    } else if (bodyClasses.contains('pastel-blue-mode')) {
                        return 'base';
                    } else if (bodyClasses.contains('pastel-yellow-mode')) {
                        return 'base';
                    } else if (bodyClasses.contains('pastel-purple-mode')) {
                        return 'base';
                    } else if (bodyClasses.contains('pastel-rainbow-mode')) {
                        return 'base';
                    } else {
                        return 'default';
                    }
                };

                const currentTheme = getCurrentMermaidTheme();
                mermaid.initialize({
                    startOnLoad: false,
                    theme: currentTheme,
                    securityLevel: 'loose',
                    fontFamily: 'var(--font-family)',
                    flowchart: { useMaxWidth: true, htmlLabels: true },
                    sequence: { useMaxWidth: true },
                    gantt: { useMaxWidth: true },
                    journey: { useMaxWidth: true },
                    pie: { useMaxWidth: true },
                    themeVariables: {
                        primaryColor: currentTheme === 'dark' ? '#404040' : '#ffffff',
                        primaryTextColor: currentTheme === 'dark' ? '#e0e0e0' : '#333333',
                        primaryBorderColor: currentTheme === 'dark' ? '#666666' : '#cccccc',
                        lineColor: currentTheme === 'dark' ? '#888888' : '#666666',
                        secondaryColor: currentTheme === 'dark' ? '#303030' : '#f8f9fa',
                        tertiaryColor: currentTheme === 'dark' ? '#2a2a2a' : '#ffffff'
                    }
                });
                
                const container = document.createElement('div');
                container.classList.add('mermaid-container');
                container.style.cssText = `
                    position: relative;
                    background-color: var(--bg-tertiary);
                    border: 1px solid var(--border-secondary);
                    border-radius: 8px;
                    padding: 15px;
                    margin: 10px 0;
                    overflow: auto;
                `;
                const diagramDiv = document.createElement('div');
                diagramDiv.classList.add('mermaid-diagram');
                diagramDiv.style.cssText = `
                    text-align: center;
                    min-height: 100px;
                    border-radius: 5px;
                    padding: 10px;
                    margin-bottom: 10px;
                    transition: background-color 0.3s ease;
                `;
                const codeDiv = document.createElement('div');
                codeDiv.classList.add('mermaid-code');
                codeDiv.style.cssText = `
                    display: none;
                    background-color: var(--bg-secondary);
                    border-radius: 5px;
                    padding: 10px;
                    font-family: monospace;
                    font-size: 13px;
                    white-space: pre-wrap;
                    word-break: break-all;
                    margin-bottom: 10px;
                    color: var(--text-secondary);
                `;
                codeDiv.textContent = mermaidCode;
                const buttonContainer = document.createElement('div');
                buttonContainer.style.cssText = `
                    display: flex;
                    gap: 8px;
                    justify-content: flex-end;
                    flex-wrap: wrap;
                `;
                const toggleButton = document.createElement('button');
                toggleButton.textContent = '繧ｳ繝ｼ繝芽｡ｨ遉ｺ';
                toggleButton.classList.add('mermaid-toggle-button');
                toggleButton.style.cssText = `
                    padding: 4px 10px;
                    font-size: 12px;
                    background-color: var(--bg-button-action);
                    color: var(--text-light);
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                `;
                const copyButton = document.createElement('button');
                copyButton.textContent = '繧ｳ繝斐・';
                copyButton.classList.add('mermaid-copy-button');
                copyButton.style.cssText = `
                    padding: 4px 10px;
                    font-size: 12px;
                    background-color: var(--bg-button-copy);
                    color: var(--text-light);
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                `;
                const errorDiv = document.createElement('div');
                errorDiv.classList.add('mermaid-error');
                errorDiv.style.cssText = `
                    display: none;
                    background-color: var(--bg-error-message);
                    color: var(--text-error);
                    padding: 10px;
                    border-radius: 5px;
                    margin-bottom: 10px;
                    font-size: 13px;
                `;

                toggleButton.onclick = () => {
                    const isCodeVisible = codeDiv.style.display !== 'none';
                    if (isCodeVisible) {
                        codeDiv.style.display = 'none';
                        diagramDiv.style.display = 'block';
                        toggleButton.textContent = '繧ｳ繝ｼ繝芽｡ｨ遉ｺ';
                    } else {
                        codeDiv.style.display = 'block';
                        diagramDiv.style.display = 'none';
                        toggleButton.textContent = '蝗ｳ陦ｨ陦ｨ遉ｺ';
                    }
                };

                copyButton.onclick = async () => {
                    try {
                        await navigator.clipboard.writeText(mermaidCode);
                        const originalText = copyButton.textContent;
                        copyButton.textContent = '繧ｳ繝斐・螳御ｺ・';
                        copyButton.disabled = true;
                        setTimeout(() => {
                            copyButton.textContent = originalText;
                            copyButton.disabled = false;
                        }, 1500);
                    } catch (err) {
                        const originalText = copyButton.textContent;
                        copyButton.textContent = '螟ｱ謨・;
                        copyButton.disabled = true;
                        setTimeout(() => {
                            copyButton.textContent = originalText;
                            copyButton.disabled = false;
                        }, 2000);
                    }
                };

                buttonContainer.appendChild(toggleButton);
                buttonContainer.appendChild(copyButton);
                container.appendChild(errorDiv);
                container.appendChild(diagramDiv);
                container.appendChild(codeDiv);
                container.appendChild(buttonContainer);
                try {
                    const uniqueId = `mermaid-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    diagramDiv.id = uniqueId;
                    
                    const { svg } = await mermaid.render(uniqueId + '-svg', mermaidCode);
                    diagramDiv.innerHTML = svg;
                    
                    const svgElement = diagramDiv.querySelector('svg');
                    if (svgElement) {
                        svgElement.style.maxWidth = '100%';
                        svgElement.style.height = 'auto';
                    }
                    
                    errorDiv.style.display = 'none';
                } catch (error) {
                    errorDiv.textContent = `蝗ｳ陦ｨ縺ｮ謠冗判縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ${error.message}`;
                    errorDiv.style.display = 'block';
                    diagramDiv.style.display = 'none';
                    
                    codeDiv.style.display = 'block';
                    toggleButton.textContent = '蝗ｳ陦ｨ陦ｨ遉ｺ';
                }

                preElement.parentNode.replaceChild(container, preElement);
            },
            async updateStreamingMessage(index, newCharOrChunk, isThoughtSummary = false) {
                const messageDiv = document.getElementById(`streaming-message-${index}`);
                if (!messageDiv || typeof marked === 'undefined') return;

                let targetContentDiv;
                let accumulatedContentForDisplay;

                const selectedApiProvider = state.settings.apiProvider;
                const streamSpeed = selectedApiProvider === 'gemini' ? state.settings.geminiStreamingSpeed : 
                                  selectedApiProvider === 'deepseek' ? state.settings.deepSeekStreamingSpeed :
                                  selectedApiProvider === 'claude' ? state.settings.claudeStreamingSpeed :
                                  selectedApiProvider === 'xai' ? state.settings.xaiStreamingSpeed :
                                  selectedApiProvider === 'llmaggregator' ? state.settings.llmAggregatorStreamingSpeed :
                                  state.settings.openaiStreamingSpeed;

                if (isThoughtSummary) {
                    if ((selectedApiProvider === 'gemini' && state.settings.geminiIncludeThoughts) ||
                        (selectedApiProvider === 'deepseek' && state.settings.deepSeekIncludeDeepSeekThoughts) ||
                        (selectedApiProvider === 'claude' && state.settings.claudeIncludeThoughts) ||
                        (selectedApiProvider === 'xai' && state.settings.xaiIncludeThoughts) ||
                        (selectedApiProvider === 'llmaggregator' && state.settings.llmAggregatorIncludeThoughts)) {
                        targetContentDiv = messageDiv.querySelector(`#streaming-thought-summary-${index}`);
                        accumulatedContentForDisplay = state.partialThoughtStreamContent;
                    } else {
                        return;
                    }
                } else {
                    targetContentDiv = messageDiv.querySelector(`#streaming-content-${index}`);
                    accumulatedContentForDisplay = state.partialStreamContent;
                }

                if (targetContentDiv) {
                    if (isThoughtSummary) {
                        const pre = targetContentDiv.querySelector('pre');
                        if (pre) {
                            pre.textContent = accumulatedContentForDisplay;
                        }
                    } else {
                        const renderCurrentState = (contentToRender) => {
                            try {
                                const safeHtml = this._sanitizeAndParseMarkdown(contentToRender || '');
                                targetContentDiv.innerHTML = safeHtml;
                                this.processInteractivePlaceholders(targetContentDiv);
                                this.processInteractiveTitles(targetContentDiv);
                                this.addCopyButtonsToCodeBlocks(targetContentDiv, true);
                                this.addImageClickListeners(targetContentDiv);
                            } catch (e) {
                                targetContentDiv.textContent = contentToRender;
                            }
                        };
                        renderCurrentState(accumulatedContentForDisplay);
                    }
                }
                if (!isThoughtSummary && state.currentMessages[index]?.groundingMetadata && selectedApiProvider === 'gemini') {
                    const citationContainer = messageDiv.querySelector(`#streaming-citations-${index}`);
                    if (citationContainer) {
                        this.renderCitations(state.currentMessages[index], citationContainer);
                    }
                }

                const autoScrollEnabledForThisContentType = isThoughtSummary
                    ? state.settings.autoScrollOnThought
                    : state.settings.autoScrollOnNewMessage;

                if (autoScrollEnabledForThisContentType) {
                    this.scrollToBottom();
                }
            },
            finalizeStreamingMessage(index) {
                const messageDiv = document.getElementById(`streaming-message-${index}`);
                if (messageDiv) {
                    const finalMessageData = state.currentMessages[index];
                    if (!finalMessageData) return;
                    const messageApiProvider = finalMessageData.generatedByApiProvider || state.settings.apiProvider;

                    if (finalMessageData.thoughtSummary || finalMessageData.deepSeekThoughtSummary || finalMessageData.xaiThoughtSummary) {
                        const thoughtContentDiv = messageDiv.querySelector(`#streaming-thought-summary-${index}`);
                        if (thoughtContentDiv) {
                            const summaryContent = finalMessageData.thoughtSummary || finalMessageData.deepSeekThoughtSummary || finalMessageData.xaiThoughtSummary;
                            thoughtContentDiv.innerHTML = '';
                            const pre = document.createElement('pre');
                            pre.textContent = summaryContent || '';
                            pre.style.whiteSpace = 'pre-wrap';
                            pre.style.wordBreak = 'break-all';
                            thoughtContentDiv.appendChild(pre);
                            thoughtContentDiv.removeAttribute('id');
                        }
                    }

                    const thoughtDetailsElement = messageDiv.querySelector('.thought-summary-details');
                    if (thoughtDetailsElement && finalMessageData.thoughtSummaryOpen !== undefined) {
                        if (thoughtDetailsElement.open !== finalMessageData.thoughtSummaryOpen) {
                             thoughtDetailsElement.open = finalMessageData.thoughtSummaryOpen;
                        }
                    }

                    const contentDiv = messageDiv.querySelector(`#streaming-content-${index}`);
                    const finalRawContent = finalMessageData.content || '';
                    if (contentDiv && typeof marked !== 'undefined') {
                         try {
                             const safeHtml = this._sanitizeAndParseMarkdown(finalRawContent);
                             contentDiv.innerHTML = safeHtml;
                             this.processInteractivePlaceholders(contentDiv);
                             this.processInteractiveTitles(contentDiv);
                             this.addCopyButtonsToCodeBlocks(contentDiv, false);
                             this.addImageClickListeners(contentDiv);
                         } catch (e) {
                             contentDiv.textContent = finalRawContent;
                         }
                    } else if (contentDiv) {
                        contentDiv.textContent = finalRawContent;
                    }
                    if(contentDiv) contentDiv.removeAttribute('id');

                    const citationContainer = messageDiv.querySelector(`#streaming-citations-${index}`);
                    if (citationContainer) {
                        this.renderCitations(finalMessageData, citationContainer);
                        citationContainer.removeAttribute('id');
                    }

                    messageDiv.removeAttribute('id');

                    const msgData = state.currentMessages[index];
                    if (msgData && msgData.role === 'model' && msgData.isCascaded) {
                        const siblings = appLogic.getCascadedSiblings(index);
                        if (siblings.length > 1) {
                            this.renderChatMessages();
                        }
                    }
                }
                if (state.settings.autoScrollOnNewMessage) {
                    this.scrollToBottom();
                }
            },
            displayError(message, isApiError = false) {
                const errorIndex = state.currentMessages.length;
                this.appendMessage('error', `繧ｨ繝ｩ繝ｼ: ${message}`, errorIndex);
                elements.loadingIndicator.classList.add('hidden');
                this.setSendingState(false);
                this.scrollToBottom();
            },
            scrollToBottom() {
                requestAnimationFrame(() => {
                    const mainContent = elements.chatScreen.querySelector('.main-content');
                    if (mainContent) {
                        mainContent.scrollTop = mainContent.scrollHeight;
                    }
                });
            },
            updateChatTitle(definitiveTitle = null) {
                let titleText = '譁ｰ隕上メ繝｣繝・ヨ';
                let baseTitle = '';
                let isNewChat = !state.currentChatId;

                if (state.currentChatId) {
                    isNewChat = false;
                    if (definitiveTitle !== null) {
                        baseTitle = definitiveTitle;
                    } else {
                        const firstUserMessage = state.currentMessages.find(m => m.role === 'user');
                        if (firstUserMessage) {
                            baseTitle = firstUserMessage.content;
                        } else if (state.currentMessages.length > 0) {
                            baseTitle = "繝√Ε繝・ヨ螻･豁ｴ";
                        }
                    }

                    if(baseTitle) {
                        const displayBase = baseTitle.startsWith(IMPORT_PREFIX) ? baseTitle.substring(IMPORT_PREFIX.length) : baseTitle;
                        const truncated = displayBase.substring(0, CHAT_TITLE_LENGTH);
                        titleText = truncated + (displayBase.length > CHAT_TITLE_LENGTH ? '...' : '');
                        if (baseTitle.startsWith(IMPORT_PREFIX)) {
                            titleText = IMPORT_PREFIX + titleText;
                        }
                    } else if(state.currentMessages.length > 0) {
                        titleText = '繝√Ε繝・ヨ螻･豁ｴ';
                    }
                    if (titleText === '譁ｰ隕上メ繝｣繝・ヨ' && state.currentMessages.length > 0) {
                        titleText = '繝√Ε繝・ヨ螻･豁ｴ';
                    }
                }

                const displayTitle = isNewChat ? titleText : `: ${titleText}`;
                elements.chatTitle.textContent = displayTitle;
                document.title = `NekoCha - ${titleText}`;
            },
            formatDate(timestamp) {
                if (!timestamp) return '';
                try {
                    return new Intl.DateTimeFormat('ja-JP', { year: '2-digit', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }).format(new Date(timestamp));
                } catch (e) {
                    const d = new Date(timestamp);
                    return `${String(d.getFullYear()).slice(-2)}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
                }
            },
            async renderHistoryList() {
                try {
                    const chats = await dbUtils.getAllChats(state.settings.historySortOrder);
                    elements.historyList.querySelectorAll('.history-item:not(.js-history-item-template)').forEach(item => item.remove());
                    this.updateHistoryHeaderButtonVisibility();
                    const sessionLinkingEnabled = state.settings.enableSessionLinking;

                    if (chats && chats.length > 0) {
                        elements.noHistoryMessage.classList.add('hidden');
                        const sortOrderText = state.settings.historySortOrder === 'createdAt' ? '菴懈・鬆・ : '譖ｴ譁ｰ鬆・;
                        elements.historyTitle.textContent = `螻･豁ｴ荳隕ｧ (${sortOrderText})`;

                        chats.forEach(chat => {
                            // 繝√Ε繝・ヨ繧｢繧ｻ繝・ヨ繧団hatAssets繝槭ャ繝励↓菫晏ｭ假ｼ亥ｱ･豁ｴ逕ｻ髱｢縺ｧ繧｢繧､繧ｳ繝ｳ繧定｡ｨ遉ｺ縺吶ｋ縺溘ａ・・                            // 蟶ｸ縺ｫ險ｭ螳夲ｼ亥ｭ伜惠縺励↑縺・ｴ蜷医ｂ・・                            state.chatAssets.set(chat.id, {
                                aiName: chat.aiName || 'AI',
                                aiIconBlob: chat.aiIconBlob || null,
                                backgroundImageBlob: chat.backgroundImageBlob || null
                            });
                            
                            const li = elements.historyItemTemplate.cloneNode(true);
                            li.classList.remove('js-history-item-template');
                            li.dataset.chatId = chat.id;

                            const titleText = chat.title || `螻･豁ｴ ${chat.id}`;
                            const titleEl = li.querySelector('.history-item-title');
                            titleEl.textContent = titleText;
                            
                            // 繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ蜷阪∪縺溘・AI蜷阪ｒ陦ｨ遉ｺ
                            const characterEl = li.querySelector('.history-item-character');
                            if (chat.characterName) {
                                characterEl.textContent = `離・・${chat.characterName}`;
                                characterEl.style.display = 'block';
                            } else if (chat.aiName && chat.aiName !== 'AI') {
                                characterEl.textContent = chat.aiName;
                                characterEl.style.display = 'block';
                            } else {
                                characterEl.style.display = 'none';
                            }
                            
                            // AI繧｢繧､繧ｳ繝ｳ繧定｡ｨ遉ｺ
                            const aiIconEl = li.querySelector('.history-item-ai-icon');
                            // showAiIcon縺ｮ繝・ヵ繧ｩ繝ｫ繝亥､繧稚rue縺ｫ險ｭ螳・                            const showAiIcon = state.settings.showAiIcon !== false;
                            
                            // chatAssets縺九ｉ菫晏ｭ俶ｸ医∩縺ｮ繧｢繧､繧ｳ繝ｳ繧貞━蜈育噪縺ｫ菴ｿ逕ｨ
                            const savedAssets = state.chatAssets.get(chat.id);
                            const iconBlob = savedAssets?.aiIconBlob || chat.aiIconBlob;
                            
                            if (iconBlob && iconBlob !== 'None' && showAiIcon) {
                                try {
                                    const aiIconBlob = convertArrayBufferToBlob(iconBlob);
                                    
                                    if (aiIconBlob) {
                                        try {
                                            const aiIconUrl = URL.createObjectURL(aiIconBlob);
                                            aiIconEl.src = aiIconUrl;
                                            aiIconEl.style.display = 'inline-block';
                                            
                                            // 繝｡繝｢繝ｪ繝ｪ繝ｼ繧ｯ繧帝亟縺舌◆繧√∫判蜒剰ｪｭ縺ｿ霎ｼ縺ｿ蠕後↓URL繧定ｧ｣謾ｾ
                                            // iOS Safari縺ｧ縺ｯ隗｣謾ｾ繧帝≦繧峨○繧・                                            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                                            aiIconEl.onload = () => {
                                                if (!isIOS) {
                                                    setTimeout(() => URL.revokeObjectURL(aiIconUrl), 1000);
                                                }
                                            };
                                            
                                            // iOS Safari蟇ｾ遲厄ｼ壹お繝ｩ繝ｼ譎ゅ・蜃ｦ逅・                                            aiIconEl.onerror = () => {
                                                    aiIconEl.style.display = 'none';
                                            };
                                        } catch (e) {
                                            aiIconEl.style.display = 'none';
                                        }
                                    } else {
                                        aiIconEl.style.display = 'none';
                                    }
                                } catch (error) {
                                    console.error('Error displaying AI icon:', error);
                                    aiIconEl.style.display = 'none';
                                }
                            } else {
                                aiIconEl.style.display = 'none';
                            }
                            
                            titleEl.title = titleText;

                            li.querySelector('.created-date').textContent = `菴懈・: ${this.formatDate(chat.createdAt)}`;
                            li.querySelector('.updated-date').textContent = `譖ｴ譁ｰ: ${this.formatDate(chat.updatedAt)}`;

                            li.onclick = (event) => {
                                if (!event.target.closest('.history-item-actions button')) {
                                    appLogic.loadChat(chat.id);
                                    this.showScreen('chat');
                                }
                            };
                            li.querySelector('.js-edit-title-btn').onclick = (e) => { e.stopPropagation(); appLogic.editHistoryTitle(chat.id, titleEl); };
                            li.querySelector('.js-export-btn').onclick = (e) => { e.stopPropagation(); appLogic.exportChat(chat.id, titleText); };
                            li.querySelector('.js-duplicate-btn').onclick = (e) => { e.stopPropagation(); appLogic.duplicateChat(chat.id); };
                            li.querySelector('.js-delete-btn').onclick = (e) => { e.stopPropagation(); appLogic.confirmDeleteChat(chat.id, titleText); };

                            const linkButton = li.querySelector('.js-link-session-btn');
                            if (linkButton) {
                                if (sessionLinkingEnabled) {
                                    linkButton.classList.remove('hidden');
                                    linkButton.classList.remove('linked-a', 'linked-b');
                                    if (state.linkedSessionIds.includes(chat.id)) {
                                        if (state.linkedSessionIds[0] === chat.id) {
                                            linkButton.classList.add('linked-a');
                                        } else if (state.linkedSessionIds[1] === chat.id) {
                                            linkButton.classList.add('linked-b');
                                        }
                                    }
                                    linkButton.onclick = (e) => { e.stopPropagation(); appLogic.toggleSessionLink(chat.id); };
                                } else {
                                    linkButton.classList.add('hidden');
                                }
                            }

                            elements.historyList.appendChild(li);
                        });
                    } else {
                        elements.noHistoryMessage.classList.remove('hidden');
                        elements.historyTitle.textContent = '螻･豁ｴ荳隕ｧ';
                    }
                } catch (error) {
                    elements.noHistoryMessage.textContent = "螻･豁ｴ縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ荳ｭ縺ｫ繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆縲・;
                    elements.noHistoryMessage.classList.remove('hidden');
                    elements.historyTitle.textContent = '螻･豁ｴ荳隕ｧ';
                }
            },
            revokeExistingObjectUrl() {
                if (state.backgroundImageUrl) {
                    try { URL.revokeObjectURL(state.backgroundImageUrl); } catch (e) { }
                    state.backgroundImageUrl = null;
                }
            },
            revokeExistingIconUrls() {
                if (state.userIconUrl) {
                    try { URL.revokeObjectURL(state.userIconUrl); } catch (e) { }
                    state.userIconUrl = null;
                }
                if (state.aiIconUrl) {
                    try { URL.revokeObjectURL(state.aiIconUrl); } catch (e) { }
                    state.aiIconUrl = null;
                }
            },
            updateBackgroundSettingsUI() {
                if (!elements.backgroundThumbnail || !elements.deleteBackgroundBtn) return;
                if (state.backgroundImageUrl) {
                    elements.backgroundThumbnail.src = state.backgroundImageUrl;
                    elements.backgroundThumbnail.classList.remove('hidden');
                    elements.deleteBackgroundBtn.classList.remove('hidden');
                } else {
                    elements.backgroundThumbnail.src = '';
                    elements.backgroundThumbnail.classList.add('hidden');
                    elements.deleteBackgroundBtn.classList.add('hidden');
                }
            },
            updateIconSettingsUI() {
                if (state.userIconUrl) {
                    elements.userIconThumbnail.src = state.userIconUrl;
                    elements.userIconThumbnail.classList.remove('hidden');
                    elements.deleteUserIconBtn.classList.remove('hidden');
                } else {
                    elements.userIconThumbnail.src = '';
                    elements.userIconThumbnail.classList.add('hidden');
                    elements.deleteUserIconBtn.classList.add('hidden');
                }

                if (state.aiIconUrl && elements.aiIconThumbnail) {
                    elements.aiIconThumbnail.src = state.aiIconUrl;
                    elements.aiIconThumbnail.style.display = ''; // 陦ｨ遉ｺ繧貞ｾｩ蜈・                    elements.aiIconThumbnail.classList.remove('hidden');
                    if (elements.deleteAiIconBtn) {
                        elements.deleteAiIconBtn.classList.remove('hidden');
                    }
                } else if (elements.aiIconThumbnail) {
                    // src繧堤ｩｺ縺ｫ縺吶ｋ莉｣繧上ｊ縺ｫ髱櫁｡ｨ遉ｺ縺ｫ縺吶ｋ・医鯉ｼ溘崎｡ｨ遉ｺ繧帝亟縺撰ｼ・                    elements.aiIconThumbnail.style.display = 'none';
                    elements.aiIconThumbnail.classList.add('hidden');
                    if (elements.deleteAiIconBtn) {
                        elements.deleteAiIconBtn.classList.add('hidden');
                    }
                }
            },
            applySidePanelSettingsToUI() {
                if (elements.toggleMemoBtn) {
                    elements.toggleMemoBtn.classList.toggle('hidden', !state.settings.showMemoButton);
                }
                document.documentElement.style.setProperty('--memo-height', state.settings.memoHeight || DEFAULT_MEMO_HEIGHT);

                if (elements.toggleClipboardStackBtn) {
                    elements.toggleClipboardStackBtn.classList.toggle('hidden', !state.settings.showClipboardStackButton);
                }
                document.documentElement.style.setProperty('--clipboard-stack-height', state.settings.clipboardStackHeight || DEFAULT_CLIPBOARD_STACK_HEIGHT);
                document.documentElement.style.setProperty('--message-icon-size', `${state.settings.messageIconSize || DEFAULT_MESSAGE_ICON_SIZE}px`);
                document.documentElement.style.setProperty('--message-icon-offset-y', `${state.settings.messageIconOffsetY || DEFAULT_MESSAGE_ICON_OFFSET_Y}px`);
                document.documentElement.style.setProperty('--icon-name-font-size', `${state.settings.iconNameFontSize || DEFAULT_ICON_NAME_FONT_SIZE}px`);
                document.documentElement.style.setProperty('--icon-name-offset-y', `${state.settings.iconNameOffsetY || DEFAULT_ICON_NAME_OFFSET_Y}px`);

                let userBubbleFinalBg;
                const userBubbleOpacity = state.settings.userNameBubbleOpacity ?? DEFAULT_USER_NAME_BUBBLE_OPACITY;

                if (state.settings.showUserNameBubble) {
                    let userRgb;
                    if (state.settings.userNameBubbleUseThemeColor) {
                        const themeUserMsgRgbString = getComputedStyle(document.body).getPropertyValue('--current-theme-user-message-rgb').trim();
                        const parts = themeUserMsgRgbString.split(',').map(s => parseInt(s.trim(), 10));
                        userRgb = (parts.length === 3 && !parts.some(isNaN)) ? {r: parts[0], g: parts[1], b: parts[2]} : this.hexToRgb(DEFAULT_USER_NAME_BUBBLE_COLOR) || {r:255,g:255,b:255};
                    } else {
                        const customUserBubbleColor = state.settings.userNameBubbleColor;
                        if (customUserBubbleColor && /^#([0-9A-Fa-f]{3}){1,2}$/.test(customUserBubbleColor)) {
                            userRgb = this.hexToRgb(customUserBubbleColor);
                        } else {
                            const defaultRgbString = getComputedStyle(document.body).getPropertyValue('--default-user-name-bubble-custom-rgb').trim();
                            const parts = defaultRgbString.split(',').map(s => parseInt(s.trim(), 10));
                            userRgb = (parts.length === 3 && !parts.some(isNaN)) ? {r: parts[0], g: parts[1], b: parts[2]} : {r:255,g:255,b:255};
                        }
                    }
                    userBubbleFinalBg = `rgba(${userRgb.r}, ${userRgb.g}, ${userRgb.b}, ${userBubbleOpacity})`;
                } else {
                     userBubbleFinalBg = 'transparent';
                }
                document.documentElement.style.setProperty('--user-name-bubble-bg', userBubbleFinalBg);

                let aiBubbleFinalBg;
                const aiBubbleOpacity = state.settings.aiNameBubbleOpacity ?? DEFAULT_AI_NAME_BUBBLE_OPACITY;

                if (state.settings.showAiNameBubble) {
                    let aiRgb;
                    if (state.settings.aiNameBubbleUseThemeColor) {
                        const themeAiMsgRgbString = getComputedStyle(document.body).getPropertyValue('--current-theme-model-message-rgb').trim();
                        const parts = themeAiMsgRgbString.split(',').map(s => parseInt(s.trim(), 10));
                        aiRgb = (parts.length === 3 && !parts.some(isNaN)) ? {r: parts[0], g: parts[1], b: parts[2]} : this.hexToRgb(DEFAULT_AI_NAME_BUBBLE_COLOR) || {r:255,g:255,b:255};
                    } else {
                        const customAiBubbleColor = state.settings.aiNameBubbleColor;
                        if (customAiBubbleColor && /^#([0-9A-Fa-f]{3}){1,2}$/.test(customAiBubbleColor)) {
                            aiRgb = this.hexToRgb(customAiBubbleColor);
                        } else {
                            const defaultRgbString = getComputedStyle(document.body).getPropertyValue('--default-ai-name-bubble-custom-rgb').trim();
                            const parts = defaultRgbString.split(',').map(s => parseInt(s.trim(), 10));
                            aiRgb = (parts.length === 3 && !parts.some(isNaN)) ? {r: parts[0], g: parts[1], b: parts[2]} : {r:255,g:255,b:255};
                        }
                    }
                    aiBubbleFinalBg = `rgba(${aiRgb.r}, ${aiRgb.g}, ${aiRgb.b}, ${aiBubbleOpacity})`;
                } else {
                     aiBubbleFinalBg = 'transparent';
                }
                document.documentElement.style.setProperty('--ai-name-bubble-bg', aiBubbleFinalBg);

                if(elements.userNameBubbleToggle && elements.userNameBubbleUseThemeColorToggle && document.getElementById('user-name-bubble-custom-color-settings')) {
                    const customColorDiv = document.getElementById('user-name-bubble-custom-color-settings');
                    const colorInput = customColorDiv.querySelector('#user-name-bubble-color');
                    const colorLabel = customColorDiv.querySelector('label[for="user-name-bubble-color"]');
                    const shouldShowCustomColor = state.settings.showUserNameBubble && !state.settings.userNameBubbleUseThemeColor;
                    if (colorInput) colorInput.style.display = shouldShowCustomColor ? 'block' : 'none';
                    if (colorLabel) colorLabel.style.display = shouldShowCustomColor ? 'block' : 'none';

                    const opacityInput = elements.userNameBubbleOpacityInput;
                    const opacityLabel = document.querySelector('label[for="user-name-bubble-opacity"]');
                    if (opacityInput) opacityInput.style.display = state.settings.showUserNameBubble ? 'block' : 'none';
                    if (opacityLabel) opacityLabel.style.display = state.settings.showUserNameBubble ? 'block' : 'none';
                }
                if(elements.aiNameBubbleToggle && elements.aiNameBubbleUseThemeColorToggle && document.getElementById('ai-name-bubble-custom-color-settings')) {
                    const customColorDiv = document.getElementById('ai-name-bubble-custom-color-settings');
                    const colorInput = customColorDiv.querySelector('#ai-name-bubble-color');
                    const colorLabel = customColorDiv.querySelector('label[for="ai-name-bubble-color"]');
                    const shouldShowCustomColor = state.settings.showAiNameBubble && !state.settings.aiNameBubbleUseThemeColor;
                    if (colorInput) colorInput.style.display = shouldShowCustomColor ? 'block' : 'none';
                    if (colorLabel) colorLabel.style.display = shouldShowCustomColor ? 'block' : 'none';

                    const opacityInput = elements.aiNameBubbleOpacityInput;
                    const opacityLabel = document.querySelector('label[for="ai-name-bubble-opacity"]');
                    if (opacityInput) opacityInput.style.display = state.settings.showAiNameBubble ? 'block' : 'none';
                    if (opacityLabel) opacityLabel.style.display = state.settings.showAiNameBubble ? 'block' : 'none';
                }
            },
            applyOpacitySettings(overrideTheme = null) {
                document.documentElement.style.setProperty('--message-bubble-opacity', state.settings.messageBubbleOpacity);
                document.documentElement.style.setProperty('--header-footer-opacity', state.settings.headerFooterOpacity);
                document.documentElement.style.setProperty('--chat-overlay-alpha', state.settings.chatOverlayOpacity);
                document.documentElement.style.setProperty('--message-actions-bg-opacity', state.settings.messageActionsBackgroundOpacity);
                document.documentElement.style.setProperty('--thought-summary-opacity', state.settings.thoughtSummaryOpacity);

                let headerColor, secondaryColor, userMessageColor, modelMessageColor, overlayBaseColor, tertiaryColorRgbStr;

                const theme = overrideTheme || state.settings.theme;
                switch (theme) {
                    case 'dark':
                        headerColor = DARK_THEME_COLOR;
                        secondaryColor = DARK_MODE_SECONDARY_COLOR;
                        userMessageColor = DARK_MODE_USER_MESSAGE_COLOR;
                        modelMessageColor = DARK_MODE_MODEL_MESSAGE_COLOR;
                        overlayBaseColor = DARK_MODE_PRIMARY_COLOR;
                        tertiaryColorRgbStr = getComputedStyle(document.body).getPropertyValue('--bg-tertiary-rgb').trim();
                        break;
                    case 'pastel-pink':
                        headerColor = PASTEL_PINK_HEADER_COLOR;
                        secondaryColor = PASTEL_PINK_SECONDARY_COLOR;
                        userMessageColor = PASTEL_PINK_USER_MESSAGE_COLOR;
                        modelMessageColor = PASTEL_PINK_MODEL_MESSAGE_COLOR;
                        overlayBaseColor = PASTEL_PINK_PRIMARY_COLOR;
                        tertiaryColorRgbStr = getComputedStyle(document.body).getPropertyValue('--bg-tertiary-rgb').trim();
                        break;
                    case 'pastel-blue':
                        headerColor = PASTEL_BLUE_HEADER_COLOR;
                        secondaryColor = PASTEL_BLUE_SECONDARY_COLOR;
                        userMessageColor = PASTEL_BLUE_USER_MESSAGE_COLOR;
                        modelMessageColor = PASTEL_BLUE_MODEL_MESSAGE_COLOR;
                        overlayBaseColor = PASTEL_BLUE_PRIMARY_COLOR;
                        tertiaryColorRgbStr = getComputedStyle(document.body).getPropertyValue('--bg-tertiary-rgb').trim();
                        break;
                    case 'pastel-yellow':
                        headerColor = PASTEL_YELLOW_HEADER_COLOR;
                        secondaryColor = PASTEL_YELLOW_SECONDARY_COLOR;
                        userMessageColor = PASTEL_YELLOW_USER_MESSAGE_COLOR;
                        modelMessageColor = PASTEL_YELLOW_MODEL_MESSAGE_COLOR;
                        overlayBaseColor = PASTEL_YELLOW_PRIMARY_COLOR;
                        tertiaryColorRgbStr = getComputedStyle(document.body).getPropertyValue('--bg-tertiary-rgb').trim();
                        break;
                    case 'pastel-purple':
                        headerColor = PASTEL_PURPLE_HEADER_COLOR;
                        secondaryColor = PASTEL_PURPLE_SECONDARY_COLOR;
                        userMessageColor = PASTEL_PURPLE_USER_MESSAGE_COLOR;
                        modelMessageColor = PASTEL_PURPLE_MODEL_MESSAGE_COLOR;
                        overlayBaseColor = PASTEL_PURPLE_PRIMARY_COLOR;
                        tertiaryColorRgbStr = getComputedStyle(document.body).getPropertyValue('--bg-tertiary-rgb').trim();
                        break;
                    case 'pastel-rainbow':
                        headerColor = PASTEL_RAINBOW_HEADER_COLOR;
                        secondaryColor = PASTEL_RAINBOW_SECONDARY_COLOR;
                        userMessageColor = PASTEL_RAINBOW_USER_MESSAGE_COLOR;
                        modelMessageColor = PASTEL_RAINBOW_MODEL_MESSAGE_COLOR;
                        overlayBaseColor = PASTEL_RAINBOW_PRIMARY_COLOR;
                        tertiaryColorRgbStr = getComputedStyle(document.body).getPropertyValue('--bg-tertiary-rgb').trim();
                        break;
                    case 'light':
                    default:
                        headerColor = LIGHT_THEME_COLOR;
                        secondaryColor = LIGHT_MODE_SECONDARY_COLOR;
                        userMessageColor = LIGHT_MODE_USER_MESSAGE_COLOR;
                        modelMessageColor = LIGHT_MODE_MODEL_MESSAGE_COLOR;
                        overlayBaseColor = LIGHT_MODE_PRIMARY_COLOR;
                        tertiaryColorRgbStr = getComputedStyle(document.body).getPropertyValue('--bg-tertiary-rgb').trim();
                        break;
                }

                if (theme !== 'pastel-rainbow') {
                    const headerRgb = this.hexToRgb(headerColor) || this.parseRgbCss(headerColor);
                    if (headerRgb) {
                        document.documentElement.style.setProperty('--bg-header-rgb', `${headerRgb.r}, ${headerRgb.g}, ${headerRgb.b}`);
                    }
                }

                const secondaryBgRgb = this.hexToRgb(secondaryColor) || this.parseRgbCss(secondaryColor);
                 if (secondaryBgRgb) {
                    document.documentElement.style.setProperty('--bg-secondary-rgb', `${secondaryBgRgb.r}, ${secondaryBgRgb.g}, ${secondaryBgRgb.b}`);
                }
                const userMessageBgRgb = this.hexToRgb(userMessageColor) || this.parseRgbCss(userMessageColor);
                if (userMessageBgRgb) {
                    document.documentElement.style.setProperty('--bg-user-message-rgb', `${userMessageBgRgb.r}, ${userMessageBgRgb.g}, ${userMessageBgRgb.b}`);
                }
                const modelMessageBgRgb = this.hexToRgb(modelMessageColor) || this.parseRgbCss(modelMessageColor);
                if (modelMessageBgRgb) {
                    document.documentElement.style.setProperty('--bg-model-message-rgb', `${modelMessageBgRgb.r}, ${modelMessageBgRgb.g}, ${modelMessageBgRgb.b}`);
                }
                const overlayBaseRgbVal = this.hexToRgb(overlayBaseColor) || this.parseRgbCss(overlayBaseColor);
                if (overlayBaseRgbVal) {
                    document.documentElement.style.setProperty('--overlay-base-rgb', `${overlayBaseRgbVal.r}, ${overlayBaseRgbVal.g}, ${overlayBaseRgbVal.b}`);
                }
                if (tertiaryColorRgbStr) {
                    document.documentElement.style.setProperty('--bg-tertiary-rgb', tertiaryColorRgbStr);
                }
            },
            hexToRgb(hex) {
                if (typeof hex !== 'string') return null;
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            },
            parseRgbCss(rgbString) {
                if (typeof rgbString !== 'string') return null;
                const match = rgbString.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
                if (match) {
                    return { r: parseInt(match[1]), g: parseInt(match[2]), b: parseInt(match[3]) };
                }
                return null;
            },
            applyZoomPreventionSetting() {
                let viewportMeta = document.querySelector('meta[name="viewport"]');
                if (!viewportMeta) {
                    viewportMeta = document.createElement('meta');
                    viewportMeta.name = 'viewport';
                    document.head.appendChild(viewportMeta);
                }

                let content = "width=device-width, initial-scale=1.0";
                if (state.settings.preventZoom) {
                    content += ", maximum-scale=1.0, user-scalable=no";
                }
                viewportMeta.content = content;
            },
            applyTheme(overrideTheme = null) {
                const theme = overrideTheme || state.settings.theme;
                document.body.classList.remove('dark-mode', 'light-mode-forced', 'pastel-pink-mode', 'pastel-blue-mode', 'pastel-yellow-mode', 'pastel-purple-mode', 'pastel-rainbow-mode');
                let themeColorMetaValue;
                let currentThemeUserMessageBgRgb = this.hexToRgb(LIGHT_MODE_USER_MESSAGE_COLOR) || {r:220,g:248,b:198};
                let currentThemeModelMessageBgRgb = this.hexToRgb(LIGHT_MODE_MODEL_MESSAGE_COLOR) || {r:229,g:229,b:234};

                switch (theme) {
                    case 'dark':
                        document.body.classList.add('dark-mode');
                        themeColorMetaValue = DARK_THEME_COLOR;
                        currentThemeUserMessageBgRgb = this.hexToRgb(DARK_MODE_USER_MESSAGE_COLOR) || {r:5,g:97,b:98};
                        currentThemeModelMessageBgRgb = this.hexToRgb(DARK_MODE_MODEL_MESSAGE_COLOR) || {r:58,g:58,b:60};
                        break;
                    case 'pastel-pink':
                        document.body.classList.add('pastel-pink-mode');
                        themeColorMetaValue = PASTEL_PINK_THEME_COLOR;
                        currentThemeUserMessageBgRgb = this.hexToRgb(PASTEL_PINK_USER_MESSAGE_COLOR) || {r:255,g:221,b:238};
                        currentThemeModelMessageBgRgb = this.hexToRgb(PASTEL_PINK_MODEL_MESSAGE_COLOR) || {r:243,g:232,b:255};
                        break;
                    case 'pastel-blue':
                        document.body.classList.add('pastel-blue-mode');
                        themeColorMetaValue = PASTEL_BLUE_THEME_COLOR;
                        currentThemeUserMessageBgRgb = this.hexToRgb(PASTEL_BLUE_USER_MESSAGE_COLOR) || {r:207,g:241,b:239};
                        currentThemeModelMessageBgRgb = this.hexToRgb(PASTEL_BLUE_MODEL_MESSAGE_COLOR) || {r:224,g:232,b:255};
                        break;
                    case 'pastel-yellow':
                        document.body.classList.add('pastel-yellow-mode');
                        themeColorMetaValue = PASTEL_YELLOW_THEME_COLOR;
                        currentThemeUserMessageBgRgb = this.hexToRgb(PASTEL_YELLOW_USER_MESSAGE_COLOR) || {r:255,g:245,b:186};
                        currentThemeModelMessageBgRgb = this.hexToRgb(PASTEL_YELLOW_MODEL_MESSAGE_COLOR) || {r:255,g:228,b:181};
                        break;
                    case 'pastel-purple':
                        document.body.classList.add('pastel-purple-mode');
                        themeColorMetaValue = PASTEL_PURPLE_THEME_COLOR;
                        currentThemeUserMessageBgRgb = this.hexToRgb(PASTEL_PURPLE_USER_MESSAGE_COLOR) || {r:209,g:196,b:233};
                        currentThemeModelMessageBgRgb = this.hexToRgb(PASTEL_PURPLE_MODEL_MESSAGE_COLOR) || {r:197,g:202,b:233};
                        break;
                    case 'pastel-rainbow':
                        document.body.classList.add('pastel-rainbow-mode');
                        themeColorMetaValue = PASTEL_RAINBOW_HEADER_COLOR;
                        currentThemeUserMessageBgRgb = this.hexToRgb(PASTEL_RAINBOW_USER_MESSAGE_COLOR) || {r:224,g:255,b:240};
                        currentThemeModelMessageBgRgb = this.hexToRgb(PASTEL_RAINBOW_MODEL_MESSAGE_COLOR) || {r:224,g:240,b:255};
                        break;
                    case 'light':
                    default:
                        document.body.classList.add('light-mode-forced');
                        themeColorMetaValue = LIGHT_THEME_COLOR;
                        break;
                }
                if (elements.themeColorMeta) {
                    elements.themeColorMeta.content = themeColorMetaValue;
                }

                document.documentElement.style.setProperty('--current-theme-user-message-rgb', `${currentThemeUserMessageBgRgb.r}, ${currentThemeUserMessageBgRgb.g}, ${currentThemeUserMessageBgRgb.b}`);
                document.documentElement.style.setProperty('--current-theme-model-message-rgb', `${currentThemeModelMessageBgRgb.r}, ${currentThemeModelMessageBgRgb.g}, ${currentThemeModelMessageBgRgb.b}`);

                this.applyOpacitySettings(overrideTheme);
                this.applyZoomPreventionSetting();
                // 繝倥ャ繝繝ｼ繧ｻ繝ｪ繝輔・蜷ｹ縺榊・縺励・濶ｲ繧よ峩譁ｰ
                this.updateIconSettingsUI();
            },
            applySettingsToUI() {
                this.toggleApiSettingsVisibility(state.settings.apiProvider);
                elements.apiProviderSelect.value = state.settings.apiProvider;
                elements.commonSystemPromptDefaultTextarea.value = state.settings.commonSystemPrompt || '';
                elements.enableCommonSystemPromptDefaultCheckbox.checked = state.settings.enableCommonSystemPromptDefault;

                elements.geminiApiKeyInput.value = state.settings.apiKey || '';
                elements.geminiModelNameSelect.value = state.settings.modelName || DEFAULT_MODEL;
                elements.geminiAdditionalModelsTextarea.value = state.settings.additionalModels || '';
                elements.deepSeekApiKeyInput.value = state.settings.deepSeekApiKey || '';
                elements.deepSeekModelNameSelect.value = state.settings.deepSeekModelName || DEFAULT_DEEPSEEK_MODEL;
                elements.deepSeekAdditionalModelsTextarea.value = state.settings.deepSeekAdditionalModels || '';
                elements.deepSeekApiEndpointInput.value = state.settings.deepSeekApiEndpoint || '';
                elements.claudeApiKeyInput.value = state.settings.claudeApiKey || '';
                elements.claudeModelNameSelect.value = state.settings.claudeModelName || DEFAULT_CLAUDE_MODEL;
                elements.claudeAdditionalModelsTextarea.value = state.settings.claudeAdditionalModels || '';
                elements.openaiApiKeyInput.value = state.settings.openaiApiKey || '';
                elements.openaiModelNameSelect.value = state.settings.openaiModelName || DEFAULT_OPENAI_MODEL;
                elements.openaiAdditionalModelsTextarea.value = state.settings.openaiAdditionalModels || '';
                elements.xaiApiKeyInput.value = state.settings.xaiApiKey || '';
                elements.xaiModelNameSelect.value = state.settings.xaiModelName || DEFAULT_XAI_MODEL;
                elements.xaiAdditionalModelsTextarea.value = state.settings.xaiAdditionalModels || '';
                elements.llmAggregatorApiBackendInput.value = state.settings.llmAggregatorApiBackend || '';
                elements.llmAggregatorApiKeyInput.value = state.settings.llmAggregatorApiKey || '';
                elements.llmAggregatorModelNameSelect.value = state.settings.llmAggregatorModelName || DEFAULT_LLMAGGREGATOR_MODEL;
                elements.llmAggregatorAdditionalModelsTextarea.value = state.settings.llmAggregatorAdditionalModels || '';
                
                multiApiKeyUtils.renderAllApiKeyLists();
                multiApiKeyUtils.updateMainApiKeyInput('gemini');
                multiApiKeyUtils.updateMainApiKeyInput('deepseek');
                multiApiKeyUtils.updateMainApiKeyInput('claude');
                multiApiKeyUtils.updateMainApiKeyInput('openai');
                multiApiKeyUtils.updateMainApiKeyInput('xai');
                multiApiKeyUtils.updateMainApiKeyInput('llmaggregator');

                elements.geminiSystemPromptDefaultTextarea.value = state.settings.geminiSystemPrompt || '';
                elements.geminiEnableSystemPromptDefaultCheckbox.checked = state.settings.geminiEnableSystemPromptDefault;
                elements.geminiTemperatureInput.value = state.settings.geminiTemperature === null ? '' : state.settings.geminiTemperature;
                elements.geminiMaxTokensInput.value = state.settings.geminiMaxTokens === null ? '' : state.settings.geminiMaxTokens;
                elements.geminiTopKInput.value = state.settings.geminiTopK === null ? '' : state.settings.geminiTopK;
                elements.geminiTopPInput.value = state.settings.geminiTopP === null ? '' : state.settings.geminiTopP;
                elements.geminiPresencePenaltyInput.value = state.settings.geminiPresencePenalty === null ? '' : state.settings.geminiPresencePenalty;
                elements.geminiFrequencyPenaltyInput.value = state.settings.geminiFrequencyPenalty === null ? '' : state.settings.geminiFrequencyPenalty;
                elements.geminiThinkingBudgetInput.value = state.settings.geminiThinkingBudget === null ? '' : state.settings.geminiThinkingBudget;
                elements.geminiIncludeThoughtsToggle.checked = state.settings.geminiIncludeThoughts;
                elements.geminiExpandThoughtsByDefaultToggle.checked = state.settings.geminiExpandThoughtsByDefault;
                elements.geminiStreamingOutputCheckbox.checked = state.settings.geminiStreamingOutput;
                elements.geminiStreamingSpeedInput.value = state.settings.geminiStreamingSpeed ?? DEFAULT_STREAMING_SPEED;
                elements.geminiDummyUserInput.value = state.settings.geminiDummyUser || '';
                elements.geminiEnableDummyUserCheckbox.checked = state.settings.geminiEnableDummyUser;
                elements.geminiDummyModelInput.value = state.settings.geminiDummyModel || '';
                elements.geminiEnableDummyModelCheckbox.checked = state.settings.geminiEnableDummyModel;
                elements.geminiConcatDummyModelCheckbox.checked = state.settings.geminiConcatDummyModel;
                elements.geminiPseudoStreamingCheckbox.checked = state.settings.geminiPseudoStreaming;
                elements.geminiEnableGroundingToggle.checked = state.settings.geminiEnableGrounding;

                elements.deepSeekSystemPromptDefaultTextarea.value = state.settings.deepSeekSystemPrompt || '';
                elements.deepSeekEnableSystemPromptDefaultCheckbox.checked = state.settings.deepSeekEnableSystemPromptDefault;
                elements.deepSeekTemperatureInput.value = state.settings.deepSeekTemperature === null ? '' : state.settings.deepSeekTemperature;
                elements.deepSeekMaxTokensInput.value = state.settings.deepSeekMaxTokens === null ? '' : state.settings.deepSeekMaxTokens;
                elements.deepSeekTopPInput.value = state.settings.deepSeekTopP === null ? '' : state.settings.deepSeekTopP;
                elements.deepSeekPresencePenaltyInput.value = state.settings.deepSeekPresencePenalty === null ? '' : state.settings.deepSeekPresencePenalty;
                elements.deepSeekFrequencyPenaltyInput.value = state.settings.deepSeekFrequencyPenalty === null ? '' : state.settings.deepSeekFrequencyPenalty;
                elements.deepSeekIncludeThoughtsToggle.checked = state.settings.deepSeekIncludeDeepSeekThoughts;
                elements.deepSeekExpandThoughtsByDefaultToggle.checked = state.settings.deepSeekExpandThoughtsByDefault;
                elements.deepSeekStreamingOutputCheckbox.checked = state.settings.deepSeekStreamingOutput;
                elements.deepSeekStreamingSpeedInput.value = state.settings.deepSeekStreamingSpeed ?? DEFAULT_STREAMING_SPEED;
                elements.deepSeekDummyUserInput.value = state.settings.deepSeekDummyUser || '';
                elements.deepSeekEnableDummyUserCheckbox.checked = state.settings.deepSeekEnableDummyUser;
                elements.deepSeekDummyModelInput.value = state.settings.deepSeekDummyModel || '';
                elements.deepSeekEnableDummyModelCheckbox.checked = state.settings.deepSeekEnableDummyModel;
                elements.deepSeekConcatDummyModelCheckbox.checked = state.settings.deepSeekConcatDummyModel;

                elements.claudeSystemPromptDefaultTextarea.value = state.settings.claudeSystemPrompt || '';
                elements.claudeEnableSystemPromptDefaultCheckbox.checked = state.settings.claudeEnableSystemPromptDefault;
                elements.claudeTemperatureInput.value = state.settings.claudeTemperature === null ? '' : state.settings.claudeTemperature;
                elements.claudeMaxTokensInput.value = state.settings.claudeMaxTokens === null ? '' : state.settings.claudeMaxTokens;
                elements.claudeTopKInput.value = state.settings.claudeTopK === null ? '' : state.settings.claudeTopK;
                elements.claudeTopPInput.value = state.settings.claudeTopP === null ? '' : state.settings.claudeTopP;
                elements.claudeStreamingOutputCheckbox.checked = state.settings.claudeStreamingOutput;
                elements.claudeStreamingSpeedInput.value = state.settings.claudeStreamingSpeed ?? DEFAULT_STREAMING_SPEED;
                elements.claudeDummyUserInput.value = state.settings.claudeDummyUser || '';
                elements.claudeEnableDummyUserCheckbox.checked = state.settings.claudeEnableDummyUser;
                elements.claudeDummyModelInput.value = state.settings.claudeDummyModel || '';
                elements.claudeEnableDummyModelCheckbox.checked = state.settings.claudeEnableDummyModel;
                elements.claudeConcatDummyModelCheckbox.checked = state.settings.claudeConcatDummyModel;
                elements.claudeIncludeThoughtsToggle.checked = state.settings.claudeIncludeThoughts;
                elements.claudeExpandThoughtsByDefaultToggle.checked = state.settings.claudeExpandThoughtsByDefault;
                elements.claudeThinkingBudgetInput.value = state.settings.claudeThinkingBudget === null ? '' : state.settings.claudeThinkingBudget;

                elements.openaiSystemPromptDefaultTextarea.value = state.settings.openaiSystemPrompt || '';
                elements.openaiEnableSystemPromptDefaultCheckbox.checked = state.settings.openaiEnableSystemPromptDefault;
                elements.openaiTemperatureInput.value = state.settings.openaiTemperature === null ? '' : state.settings.openaiTemperature;
                elements.openaiMaxTokensInput.value = state.settings.openaiMaxTokens === null ? '' : state.settings.openaiMaxTokens;
                elements.openaiTopPInput.value = state.settings.openaiTopP === null ? '' : state.settings.openaiTopP;
                elements.openaiPresencePenaltyInput.value = state.settings.openaiPresencePenalty === null ? '' : state.settings.openaiPresencePenalty;
                elements.openaiFrequencyPenaltyInput.value = state.settings.openaiFrequencyPenalty === null ? '' : state.settings.openaiFrequencyPenalty;
                elements.openaiStreamingOutputCheckbox.checked = state.settings.openaiStreamingOutput;
                elements.openaiStreamingSpeedInput.value = state.settings.openaiStreamingSpeed ?? DEFAULT_STREAMING_SPEED;
                elements.openaiDummyUserInput.value = state.settings.openaiDummyUser || '';
                elements.openaiEnableDummyUserCheckbox.checked = state.settings.openaiEnableDummyUser;
                elements.openaiDummyModelInput.value = state.settings.openaiDummyModel || '';
                elements.openaiEnableDummyModelCheckbox.checked = state.settings.openaiEnableDummyModel;
                elements.openaiConcatDummyModelCheckbox.checked = state.settings.openaiConcatDummyModel;
                
                elements.xaiSystemPromptDefaultTextarea.value = state.settings.xaiSystemPrompt || '';
                elements.xaiEnableSystemPromptDefaultCheckbox.checked = state.settings.xaiEnableSystemPromptDefault;
                elements.xaiTemperatureInput.value = state.settings.xaiTemperature === null ? '' : state.settings.xaiTemperature;
                elements.xaiMaxTokensInput.value = state.settings.xaiMaxTokens === null ? '' : state.settings.xaiMaxTokens;
                elements.xaiTopPInput.value = state.settings.xaiTopP === null ? '' : state.settings.xaiTopP;
                elements.xaiPresencePenaltyInput.value = state.settings.xaiPresencePenalty === null ? '' : state.settings.xaiPresencePenalty;
                elements.xaiFrequencyPenaltyInput.value = state.settings.xaiFrequencyPenalty === null ? '' : state.settings.xaiFrequencyPenalty;
                elements.xaiStreamingOutputCheckbox.checked = state.settings.xaiStreamingOutput;
                elements.xaiStreamingSpeedInput.value = state.settings.xaiStreamingSpeed ?? DEFAULT_STREAMING_SPEED;
                elements.xaiDummyUserInput.value = state.settings.xaiDummyUser || '';
                elements.xaiEnableDummyUserCheckbox.checked = state.settings.xaiEnableDummyUser;
                elements.xaiDummyModelInput.value = state.settings.xaiDummyModel || '';
                elements.xaiEnableDummyModelCheckbox.checked = state.settings.xaiEnableDummyModel;
                elements.xaiConcatDummyModelCheckbox.checked = state.settings.xaiConcatDummyModel;
                elements.xaiVisionEnableCheckbox.checked = state.settings.xaiVisionEnable;
                elements.xaiIncludeThoughtsToggle.checked = state.settings.xaiIncludeThoughts;
                elements.xaiExpandThoughtsByDefaultToggle.checked = state.settings.xaiExpandThoughtsByDefault;
                elements.xaiReasoningEffortSelect.value = state.settings.xaiReasoningEffort;
                
                elements.llmAggregatorSystemPromptDefaultTextarea.value = state.settings.llmAggregatorSystemPrompt || '';
                elements.llmAggregatorEnableSystemPromptDefaultCheckbox.checked = state.settings.llmAggregatorEnableSystemPromptDefault;
                elements.llmAggregatorTemperatureInput.value = state.settings.llmAggregatorTemperature === null ? '' : state.settings.llmAggregatorTemperature;
                elements.llmAggregatorMaxTokensInput.value = state.settings.llmAggregatorMaxTokens === null ? '' : state.settings.llmAggregatorMaxTokens;
                elements.llmAggregatorTopPInput.value = state.settings.llmAggregatorTopP === null ? '' : state.settings.llmAggregatorTopP;
                elements.llmAggregatorTopKInput.value = state.settings.llmAggregatorTopK === null ? '' : state.settings.llmAggregatorTopK;
                elements.llmAggregatorPresencePenaltyInput.value = state.settings.llmAggregatorPresencePenalty === null ? '' : state.settings.llmAggregatorPresencePenalty;
                elements.llmAggregatorFrequencyPenaltyInput.value = state.settings.llmAggregatorFrequencyPenalty === null ? '' : state.settings.llmAggregatorFrequencyPenalty;
                elements.llmAggregatorIncludeThoughtsToggle.checked = state.settings.llmAggregatorIncludeThoughts;
                elements.llmAggregatorExpandThoughtsByDefaultToggle.checked = state.settings.llmAggregatorExpandThoughtsByDefault;
                elements.llmAggregatorStreamingOutputCheckbox.checked = state.settings.llmAggregatorStreamingOutput;
                elements.llmAggregatorStreamingSpeedInput.value = state.settings.llmAggregatorStreamingSpeed ?? DEFAULT_STREAMING_SPEED;
                elements.llmAggregatorDummyUserInput.value = state.settings.llmAggregatorDummyUser || '';
                elements.llmAggregatorEnableDummyUserCheckbox.checked = state.settings.llmAggregatorEnableDummyUser;
                elements.llmAggregatorDummyModelInput.value = state.settings.llmAggregatorDummyModel || '';
                elements.llmAggregatorEnableDummyModelCheckbox.checked = state.settings.llmAggregatorEnableDummyModel;
                elements.llmAggregatorConcatDummyModelCheckbox.checked = state.settings.llmAggregatorConcatDummyModel;

                 elements.enterToSendCheckbox.checked = state.settings.enterToSend;
                 elements.autoScrollOnNewMessageCheckbox.checked = state.settings.autoScrollOnNewMessage;
                 elements.autoScrollOnThoughtCheckbox.checked = state.settings.autoScrollOnThought;
                 elements.historySortOrderSelect.value = state.settings.historySortOrder || 'updatedAt';
                 if (elements.themeSelect) elements.themeSelect.value = state.settings.theme || 'light';
                 elements.enableSessionLinkingCheckbox.checked = state.settings.enableSessionLinking;
                 elements.fontFamilyInput.value = state.settings.fontFamily || '';
                 elements.messageBodyFontSizeInput.value = state.settings.messageBodyFontSize ?? '';
                 elements.codeBlockFontSizeInput.value = state.settings.codeBlockFontSize ?? '';
                 elements.thoughtSummaryFontSizeInput.value = state.settings.thoughtSummaryFontSize ?? '';
                 elements.swipeNavigationToggle.checked = state.settings.enableSwipeNavigation;
                 elements.preventZoomToggle.checked = state.settings.preventZoom;
                 // 蠕梧婿莠呈鋤諤ｧ縺ｮ縺溘ａ縲∝商縺・ｨｭ螳壹°繧牙､繧堤ｶ呎価
                 if (state.settings.minimizeHeaderFooter !== undefined && state.settings.minimizeHeader === undefined) {
                     state.settings.minimizeHeader = state.settings.minimizeHeaderFooter;
                     state.settings.minimizeFooter = state.settings.minimizeHeaderFooter;
                 }
                 elements.minimizeHeaderToggle.checked = state.settings.minimizeHeader ?? true;
                 elements.minimizeFooterToggle.checked = state.settings.minimizeFooter ?? false;
                 elements.showSessionLinkingSettingsToggle.checked = state.settings.showSessionLinkingSettings;
                 if (elements.sessionLinkingSettingsGroup) {
                     elements.sessionLinkingSettingsGroup.classList.toggle('hidden', !state.settings.showSessionLinkingSettings);
                 }
                 elements.showChatTitleToggle.checked = state.settings.showChatTitle;
                 elements.showNewChatButtonToggle.checked = state.settings.showNewChatButton;
                 elements.showDeleteSessionButtonToggle.checked = state.settings.showDeleteSessionButton;
                 elements.showCopySessionButtonToggle.checked = state.settings.showCopySessionButton;
                 elements.showScrollToTopButtonToggle.checked = state.settings.showScrollToTopButton;
                 elements.showScrollToBottomButtonToggle.checked = state.settings.showScrollToBottomButton;
                 elements.showToggleAllContentButtonToggle.checked = state.settings.showToggleAllContentButton;
                 elements.showBulkHistoryActionsToggle.checked = state.settings.showBulkHistoryActions;
                 elements.showPasteButtonInFooterToggle.checked = state.settings.showPasteButtonInFooter;
                 elements.showPasteButtonInEditToggle.checked = state.settings.showPasteButtonInEdit;
                 elements.showDiceButtonToggle.checked = state.settings.showDiceButton;
                 document.getElementById('dice-value-settings').classList.toggle('hidden', !state.settings.showDiceButton);
                 elements.diceMinValueInput.value = state.settings.diceMinValue ?? '';
                 elements.diceMaxValueInput.value = state.settings.diceMaxValue ?? '';
                 elements.messageBubbleOpacityInput.value = state.settings.messageBubbleOpacity ?? DEFAULT_MESSAGE_BUBBLE_OPACITY;
                 elements.chatOverlayOpacityInput.value = state.settings.chatOverlayOpacity ?? DEFAULT_CHAT_OVERLAY_OPACITY;
                 elements.headerFooterOpacityInput.value = state.settings.headerFooterOpacity ?? DEFAULT_HEADER_FOOTER_OPACITY;
                 elements.messageActionsBackgroundOpacityInput.value = state.settings.messageActionsBackgroundOpacity ?? DEFAULT_MESSAGE_ACTIONS_BACKGROUND_OPACITY;
                 elements.thoughtSummaryOpacityInput.value = state.settings.thoughtSummaryOpacity ?? DEFAULT_THOUGHT_SUMMARY_OPACITY;
                 elements.showApiProviderToggleHeaderCheckbox.checked = state.settings.showApiProviderToggleHeader;
                 elements.showApiProviderToggleFooterCheckbox.checked = state.settings.showApiProviderToggleFooter;
                 elements.apiProviderCycleGeminiCheckbox.checked = state.settings.apiProviderCycle.gemini;
                 elements.apiProviderCycleDeepSeekCheckbox.checked = state.settings.apiProviderCycle.deepseek;
                 elements.apiProviderCycleClaudeCheckbox.checked = state.settings.apiProviderCycle.claude;
                 elements.apiProviderCycleOpenAICheckbox.checked = state.settings.apiProviderCycle.openai;
                 elements.apiProviderCycleXaiCheckbox.checked = state.settings.apiProviderCycle.xai;
                 elements.apiProviderCycleLlmAggregatorCheckbox.checked = state.settings.apiProviderCycle.llmaggregator;
                 elements.apiProviderCycleDummyCheckbox.checked = state.settings.apiProviderCycle.dummy;
                 elements.dummyDummyModelInput.value = state.settings.dummyDummyModel || '';
                 elements.dummyEnableDummyModelCheckbox.checked = state.settings.dummyEnableDummyModel;

                elements.showMemoButtonToggle.checked = state.settings.showMemoButton;
                elements.memoHeightInput.value = state.settings.memoHeight || '';
                elements.showClipboardStackButtonToggle.checked = state.settings.showClipboardStackButton;
                elements.showUserIconToggle.checked = state.settings.showUserIcon;
                elements.showUserNameToggle.checked = state.settings.showUserName;
                // 險ｭ螳壹′譛ｪ螳夂ｾｩ縺ｮ蝣ｴ蜷医↓繝・ヵ繧ｩ繝ｫ繝亥､繧定ｨｭ螳・                if (state.settings.showAiIcon === undefined) {
                    state.settings.showAiIcon = true;
                }
                if (state.settings.showAiName === undefined) {
                    state.settings.showAiName = true;
                }
                
                elements.showAiIconToggle.checked = state.settings.showAiIcon;
                elements.showAiNameToggle.checked = state.settings.showAiName;
                elements.aiNameInput.value = state.settings.aiName || '';
                elements.iconNameFontSizeInput.value = state.settings.iconNameFontSize ?? DEFAULT_ICON_NAME_FONT_SIZE;
                elements.iconNameOffsetYInput.value = state.settings.iconNameOffsetY !== null ? (state.settings.iconNameOffsetY * -1) : (DEFAULT_ICON_NAME_OFFSET_Y * -1);
                elements.messageIconSizeInput.value = state.settings.messageIconSize ?? DEFAULT_MESSAGE_ICON_SIZE;
                elements.messageIconOffsetYInput.value = state.settings.messageIconOffsetY !== null ? (state.settings.messageIconOffsetY * -1) : (DEFAULT_MESSAGE_ICON_OFFSET_Y * -1);

                elements.userNameBubbleToggle.checked = state.settings.showUserNameBubble;
                elements.userNameBubbleUseThemeColorToggle.checked = state.settings.userNameBubbleUseThemeColor;
                elements.userNameBubbleColorInput.value = state.settings.userNameBubbleColor || DEFAULT_USER_NAME_BUBBLE_COLOR;
                elements.userNameBubbleOpacityInput.value = state.settings.userNameBubbleOpacity ?? DEFAULT_USER_NAME_BUBBLE_OPACITY;
                elements.aiNameBubbleToggle.checked = state.settings.showAiNameBubble;
                elements.aiNameBubbleUseThemeColorToggle.checked = state.settings.aiNameBubbleUseThemeColor;
                elements.aiNameBubbleColorInput.value = state.settings.aiNameBubbleColor || DEFAULT_AI_NAME_BUBBLE_COLOR;
                elements.aiNameBubbleOpacityInput.value = state.settings.aiNameBubbleOpacity ?? DEFAULT_AI_NAME_BUBBLE_OPACITY;

                elements.disableRetryConfirmationToggle.checked = state.settings.disableRetryConfirmation;
                elements.disableLoadChatConfirmationWhileSendingToggle.checked = state.settings.disableLoadChatConfirmationWhileSending;
                elements.disableDeleteMessageConfirmationToggle.checked = state.settings.disableDeleteMessageConfirmation;
                elements.disableAttachmentConfirmationToggle.checked = state.settings.disableAttachmentConfirmation;
                elements.addPrefixOnImportToggle.checked = state.settings.addPrefixOnImport;
                elements.showMultiApiKeysToggle.checked = state.settings.showMultiApiKeys;
                elements.disableSaveSettingsConfirmationToggle.checked = state.settings.disableSaveSettingsConfirmation;
                elements.autoSaveSettingsToggle.checked = state.settings.autoSaveSettings;
                elements.showTopCollapseButtonToggle.checked = state.settings.showTopCollapseButton;
                elements.showBottomCollapseButtonToggle.checked = state.settings.showBottomCollapseButton;
                elements.persistMessageCollapseStateCheckbox.checked = state.settings.persistMessageCollapseState;

                elements.toggleButtonTopWidthInput.value = state.settings.toggleButtonTopWidth ?? DEFAULT_TOGGLE_BUTTON_TOP_WIDTH;
                elements.toggleButtonTopHeightInput.value = state.settings.toggleButtonTopHeight ?? DEFAULT_TOGGLE_BUTTON_TOP_HEIGHT;
                elements.toggleButtonTopFontSizeInput.value = state.settings.toggleButtonTopFontSize ?? DEFAULT_TOGGLE_BUTTON_TOP_FONT_SIZE;
                elements.toggleButtonTopOpacityInput.value = state.settings.toggleButtonTopOpacity ?? DEFAULT_TOGGLE_BUTTON_TOP_OPACITY;
                elements.toggleButtonTopTextCollapseInput.value = state.settings.toggleButtonTopTextCollapse || DEFAULT_TOGGLE_BUTTON_TOP_TEXT_COLLAPSE;
                elements.toggleButtonTopTextExpandInput.value = state.settings.toggleButtonTopTextExpand || DEFAULT_TOGGLE_BUTTON_TOP_TEXT_EXPAND;
                elements.toggleButtonBottomFontSizeInput.value = state.settings.toggleButtonBottomFontSize ?? DEFAULT_TOGGLE_BUTTON_BOTTOM_FONT_SIZE;
                elements.toggleButtonBottomTextCollapseInput.value = state.settings.toggleButtonBottomTextCollapse || DEFAULT_TOGGLE_BUTTON_BOTTOM_TEXT_COLLAPSE;
                elements.toggleButtonBottomTextExpandInput.value = state.settings.toggleButtonBottomTextExpand || DEFAULT_TOGGLE_BUTTON_BOTTOM_TEXT_EXPAND;
                elements.thoughtSummaryOpacityInput.value = state.settings.thoughtSummaryOpacity ?? DEFAULT_THOUGHT_SUMMARY_OPACITY;
                elements.dummyErrorDebugModeCheckbox.checked = state.settings.dummyErrorDebugMode;

                document.documentElement.style.setProperty('--message-body-font-size', `${state.settings.messageBodyFontSize || DEFAULT_MESSAGE_BODY_FONT_SIZE}px`);
                document.documentElement.style.setProperty('--code-block-font-size', `${state.settings.codeBlockFontSize || DEFAULT_CODE_BLOCK_FONT_SIZE}px`);
                document.documentElement.style.setProperty('--thought-summary-font-size', `${state.settings.thoughtSummaryFontSize || DEFAULT_THOUGHT_SUMMARY_FONT_SIZE}px`);
                document.documentElement.style.setProperty('--message-toggle-button-top-width', `${state.settings.toggleButtonTopWidth || DEFAULT_TOGGLE_BUTTON_TOP_WIDTH}px`);
                document.documentElement.style.setProperty('--message-toggle-button-top-height', `${state.settings.toggleButtonTopHeight || DEFAULT_TOGGLE_BUTTON_TOP_HEIGHT}px`);
                document.documentElement.style.setProperty('--message-toggle-button-top-font-size', `${state.settings.toggleButtonTopFontSize || DEFAULT_TOGGLE_BUTTON_TOP_FONT_SIZE}px`);
                document.documentElement.style.setProperty('--message-toggle-button-top-opacity', state.settings.toggleButtonTopOpacity);
                document.documentElement.style.setProperty('--message-toggle-button-bottom-font-size', `${state.settings.toggleButtonBottomFontSize || DEFAULT_TOGGLE_BUTTON_BOTTOM_FONT_SIZE}px`);
                document.documentElement.style.setProperty('--thought-summary-opacity', state.settings.thoughtSummaryOpacity || DEFAULT_THOUGHT_SUMMARY_OPACITY);

                this.applySettingsUIDetailsOpenStates();
                this.updateChatScreenElementVisibility();
                this.updateHistoryHeaderButtonVisibility();
                this.updateUserModelOptions();
                this.updateDeepSeekUserModelOptions();
                this.updateClaudeUserModelOptions();
                this.updateOpenAIUserModelOptions();
                this.updateXaiUserModelOptions();
                this.updateLlmAggregatorUserModelOptions();
                this.updateBackgroundSettingsUI();
                // 繝励Ο繝ｳ繝励ヨ險ｭ螳夂判髱｢縺ｮ蝣ｴ蜷医・荳譎ゅユ繝ｼ繝槭ｒ驕ｩ逕ｨ縲√◎繧御ｻ･螟悶・騾壼ｸｸ縺ｮ繝・・繝樣←逕ｨ
                if (state.currentScreen === 'prompt-setup' && state.promptTempTheme) {
                    this.applyTheme(state.promptTempTheme);
                } else if (state.currentChatTheme) {
                    this.applyTheme(state.currentChatTheme);
                } else {
                    this.applyTheme();
                }
                this.applyFontFamily();
                this.applySidePanelSettingsToUI();
                this.updateSessionLinkingUI();
                this.updateApiProviderSelectOptions();
                this.applyMinimizeUI();
                this.toggleMultiApiKeysVisibility(state.settings.showMultiApiKeys);
                elements.settingsScreen.classList.toggle('auto-save-mode', state.settings.autoSaveSettings);
                this.updateMemoStackHeightSettingsVisibility();
            },
            applyMinimizeUI() {
                // 蠕梧婿莠呈鋤諤ｧ繝√ぉ繝・け
                if (state.settings.minimizeHeaderFooter !== undefined && state.settings.minimizeHeader === undefined) {
                    state.settings.minimizeHeader = state.settings.minimizeHeaderFooter;
                    state.settings.minimizeFooter = state.settings.minimizeHeaderFooter;
                    delete state.settings.minimizeHeaderFooter;
                }
                elements.appContainer.classList.toggle('minimized-header', state.settings.minimizeHeader ?? true);
                elements.appContainer.classList.toggle('minimized-footer', state.settings.minimizeFooter ?? false);
            },
            applySettingsUIDetailsOpenStates() {
                const detailsElements = document.querySelectorAll('#settings-screen details[id]');
                detailsElements.forEach(detailsEl => {
                    if (state.settings.settingsUIDetailsOpenStates[detailsEl.id] === true) {
                        detailsEl.open = true;
                    } else if (state.settings.settingsUIDetailsOpenStates[detailsEl.id] === false) {
                        detailsEl.open = false;
                    }
                });
            },
            toggleApiSettingsVisibility(provider) {
                const showGemini = provider === 'gemini';
                const showDeepSeek = provider === 'deepseek';
                const showClaude = provider === 'claude';
                const showOpenAI = provider === 'openai';
                const showXai = provider === 'xai';
                const showLlmAggregator = provider === 'llmaggregator';
                const showDummy = provider === 'dummy';

                elements.geminiSettingsGroup.classList.toggle('hidden', !showGemini);
                elements.geminiParamsGroup.classList.toggle('hidden', !showGemini);
                elements.geminiAdvancedGroup.classList.toggle('hidden', !showGemini);
                elements.geminiGroundingParam.classList.toggle('hidden', !showGemini);

                elements.deepSeekSettingsGroup.classList.toggle('hidden', !showDeepSeek);
                elements.deepseekParamsGroup.classList.toggle('hidden', !showDeepSeek);
                elements.deepseekAdvancedGroup.classList.toggle('hidden', !showDeepSeek);

                elements.claudeSettingsGroup.classList.toggle('hidden', !showClaude);
                elements.claudeParamsGroup.classList.toggle('hidden', !showClaude);
                elements.claudeAdvancedGroup.classList.toggle('hidden', !showClaude);
                
                elements.openaiSettingsGroup.classList.toggle('hidden', !showOpenAI);
                elements.openaiParamsGroup.classList.toggle('hidden', !showOpenAI);
                elements.openaiAdvancedGroup.classList.toggle('hidden', !showOpenAI);
                
                elements.xaiSettingsGroup.classList.toggle('hidden', !showXai);
                elements.xaiParamsGroup.classList.toggle('hidden', !showXai);
                elements.xaiAdvancedGroup.classList.toggle('hidden', !showXai);

                elements.llmAggregatorSettingsGroup.classList.toggle('hidden', !showLlmAggregator);
                elements.llmAggregatorParamsGroup.classList.toggle('hidden', !showLlmAggregator);
                elements.llmAggregatorAdvancedGroup.classList.toggle('hidden', !showLlmAggregator);

                elements.dummySettingsGroup.classList.toggle('hidden', !showDummy);

                const paramGroups = [
                    elements.geminiParamsGroup, elements.deepseekParamsGroup, elements.claudeParamsGroup,
                    elements.openaiParamsGroup, elements.xaiParamsGroup, elements.llmAggregatorParamsGroup,
                    elements.geminiAdvancedGroup, elements.deepseekAdvancedGroup, elements.claudeAdvancedGroup,
                    elements.openaiAdvancedGroup, elements.xaiAdvancedGroup, elements.llmAggregatorAdvancedGroup,
                    elements.geminiGroundingParam
                ];

                if (showDummy) {
                    paramGroups.forEach(group => group.classList.add('hidden'));
                }
            },
            updateChatScreenElementVisibility() {
                const header = elements.chatScreen.querySelector('.app-header');
                const allButtons = Array.from(header.querySelectorAll('button'));
                allButtons.forEach(btn => btn.classList.remove('layout-hidden'));
            
                const updateVisibility = () => {
                    const toggleableButtons = [
                        { id: '#show-chat-title-toggle', element: elements.chatTitle },
                        { id: '#show-new-chat-button-toggle', element: elements.newChatBtn },
                        { id: '#show-delete-session-button-toggle', element: elements.deleteSessionBtn },
                        { id: '#show-copy-session-button-toggle', element: elements.copySessionBtn },
                        { id: '#show-api-provider-toggle-header', element: elements.headerApiProviderToggleBtn },
                        { id: '#show-scroll-to-top-button-toggle', element: elements.scrollToTopBtn },
                        { id: '#show-scroll-to-bottom-button-toggle', element: elements.scrollToBottomBtn },
                        { id: '#show-toggle-all-content-button-toggle', element: elements.toggleAllContentBtn },
                        { id: '#show-memo-button-toggle', element: elements.toggleMemoBtn },
                        { id: '#show-clipboard-stack-button-toggle', element: elements.toggleClipboardStackBtn },
                    ];

                    toggleableButtons.forEach(item => {
                        const checkbox = document.querySelector(item.id);
                        if (item.element) {
                            item.element.classList.toggle('hidden', !checkbox.checked);
                        }
                    });

                    if (elements.pasteToInputBtn) {
                        elements.pasteToInputBtn.classList.toggle('hidden', !state.settings.showPasteButtonInFooter);
                    }
                    if (elements.rollDiceBtn) {
                        elements.rollDiceBtn.classList.toggle('hidden', !state.settings.showDiceButton);
                    }
                    if (elements.aiToAiChatBtn) {
                        const showAiToAiBtn = state.settings.enableSessionLinking &&
                                            state.linkedSessionIds.length === 2 &&
                                            state.currentChatId && state.linkedSessionIds.includes(state.currentChatId);
                        elements.aiToAiChatBtn.classList.toggle('hidden', !showAiToAiBtn);
                    }
                    
                    if (elements.footerApiProviderToggleBtn) {
                        elements.footerApiProviderToggleBtn.classList.toggle('hidden', !state.settings.showApiProviderToggleFooter);
                    }

                    this.adjustHeaderLayout();
                    this.updateProviderToggleButtons();
                };
            
                requestAnimationFrame(updateVisibility);
            },
            adjustHeaderLayout() {
                const header = elements.chatScreen.querySelector('.app-header');
                if (!header) return;
            
                const allButtons = Array.from(header.querySelectorAll('button:not(#goto-history-btn):not(#goto-settings-btn):not(#chat-settings-btn)'));
                allButtons.forEach(btn => btn.classList.remove('layout-hidden'));
            
                requestAnimationFrame(() => {
                    let containerWidth = header.offsetWidth;
                    let settingsBtnRect = elements.gotoSettingsBtn.getBoundingClientRect();
                    let headerRect = header.getBoundingClientRect();
                    let isOverflowing = settingsBtnRect.right > headerRect.right - 5;
            
                    const buttonPriority = [
                        '#toggle-clipboard-stack-btn', '#toggle-memo-btn', '#scroll-to-top-btn',
                        '#scroll-to-bottom-btn', '#toggle-all-content-btn', '#header-api-provider-toggle-btn',
                        '#copy-session-btn', '#delete-session-btn', '#new-chat-btn', '#chat-settings-btn'
                    ];

                    if (isOverflowing) {
                        for (const selector of buttonPriority) {
                            const btn = header.querySelector(selector);
                            if (btn && !btn.classList.contains('hidden') && !btn.classList.contains('layout-hidden')) {
                                btn.classList.add('layout-hidden');
                                settingsBtnRect = elements.gotoSettingsBtn.getBoundingClientRect();
                                isOverflowing = settingsBtnRect.right > headerRect.right - 5;
                                if (!isOverflowing) break;
                            }
                        }
                    }
                });
            },
            updateProviderToggleButtons() {
                const providerMap = {
                    gemini: { text: 'GE', title: 'Gemini', className: 'gemini' },
                    deepseek: { text: 'DS', title: 'DeepSeek', className: 'deepseek' },
                    claude: { text: 'AN', title: 'Anthropic', className: 'claude' },
                    openai: { text: 'OP', title: 'OpenAI', className: 'openai' },
                    xai: { text: 'XA', title: 'xAI', className: 'xai' },
                    llmaggregator: { text: 'LA', title: 'LLM Aggregator', className: 'llmaggregator' },
                    dummy: { text: 'DU', title: 'Dummy AI', className: 'dummy' },
                };
                const currentProviderInfo = providerMap[state.settings.apiProvider] || { text: '??', title: 'Unknown', className: '' };
                
                [elements.headerApiProviderToggleBtn, elements.footerApiProviderToggleBtn].forEach(button => {
                    if (button) {
                        button.textContent = currentProviderInfo.text;
                        button.title = `API: ${currentProviderInfo.title}`;
                        button.classList.remove('gemini', 'deepseek', 'claude', 'openai', 'xai', 'llmaggregator', 'dummy');
                        if (currentProviderInfo.className) {
                            button.classList.add(currentProviderInfo.className);
                        }
                    }
                });
            },
            updateHistoryHeaderButtonVisibility() {
                const showBulkActions = state.settings.showBulkHistoryActions;
                if (elements.exportAllSessionsBtn) {
                    elements.exportAllSessionsBtn.classList.toggle('hidden', !showBulkActions);
                }
                if (elements.importAllSessionsBtn) {
                    elements.importAllSessionsBtn.classList.toggle('hidden', !showBulkActions);
                }
            },
            updateUserModelOptions() {
                const group = elements.geminiUserDefinedModelsGroup;
                group.innerHTML = '';
                const models = (state.settings.additionalModels || '')
                    .split(',')
                    .map(m => m.trim())
                    .filter(m => m !== '');

                if (models.length > 0) {
                    group.disabled = false;
                    models.forEach(modelId => {
                        const option = document.createElement('option');
                        option.value = modelId;
                        option.textContent = modelId;
                        group.appendChild(option);
                    });
                    if (models.includes(state.settings.modelName)) {
                        elements.geminiModelNameSelect.value = state.settings.modelName;
                    }
                } else {
                    group.disabled = true;
                }
            },
            updateDeepSeekUserModelOptions() {
                const select = elements.deepSeekModelNameSelect;
                const userDefinedOptgroup = select.querySelector('optgroup[label="繝ｦ繝ｼ繧ｶ繝ｼ謖・ｮ・(DeepSeek)"]');
                if (userDefinedOptgroup) {
                    userDefinedOptgroup.remove();
                }

                const baseModelsOptgroup = select.querySelector('optgroup[label="蝓ｺ譛ｬ繝｢繝・Ν (DeepSeek)"]') || select;
                baseModelsOptgroup.innerHTML = '';
                const defaultDeepSeekModels = ['deepseek-chat', 'deepseek-coder', 'deepseek-reasoner'];
                defaultDeepSeekModels.forEach(modelId => {
                    const option = document.createElement('option');
                    option.value = modelId;
                    option.textContent = modelId;
                    baseModelsOptgroup.appendChild(option);
                });

                const additionalModels = (state.settings.deepSeekAdditionalModels || '')
                    .split(',')
                    .map(m => m.trim())
                    .filter(m => m !== '');

                if (additionalModels.length > 0) {
                    let optgroup = document.createElement('optgroup');
                    optgroup.label = '繝ｦ繝ｼ繧ｶ繝ｼ謖・ｮ・(DeepSeek)';
                    optgroup.id = 'deepseek-user-defined-models-group';
                    additionalModels.forEach(modelId => {
                        const option = document.createElement('option');
                        option.value = modelId;
                        option.textContent = modelId;
                        optgroup.appendChild(option);
                    });
                    select.appendChild(optgroup);
                }

                if (state.settings.deepSeekModelName && Array.from(select.options).some(opt => opt.value === state.settings.deepSeekModelName)) {
                    select.value = state.settings.deepSeekModelName;
                } else if (select.options.length > 0) {
                    select.value = defaultDeepSeekModels[0];
                    state.settings.deepSeekModelName = select.value;
                }
            },
            updateClaudeUserModelOptions() {
                const group = elements.claudeUserDefinedModelsGroup;
                group.innerHTML = '';
                const models = (state.settings.claudeAdditionalModels || '')
                    .split(',')
                    .map(m => m.trim())
                    .filter(m => m !== '');

                if (models.length > 0) {
                    group.disabled = false;
                    models.forEach(modelId => {
                        const option = document.createElement('option');
                        option.value = modelId;
                        option.textContent = modelId;
                        group.appendChild(option);
                    });
                    if (models.includes(state.settings.claudeModelName)) {
                        elements.claudeModelNameSelect.value = state.settings.claudeModelName;
                    }
                } else {
                    group.disabled = true;
                }
            },
            updateOpenAIUserModelOptions() {
                const select = elements.openaiModelNameSelect;
                select.querySelectorAll('optgroup[label="繝ｦ繝ｼ繧ｶ繝ｼ謖・ｮ・]').forEach(el => el.remove());
                const models = (state.settings.openaiAdditionalModels || '')
                    .split(',')
                    .map(m => m.trim())
                    .filter(m => m !== '');

                if (models.length > 0) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = '繝ｦ繝ｼ繧ｶ繝ｼ謖・ｮ・;
                    models.forEach(modelId => {
                        const option = document.createElement('option');
                        option.value = modelId;
                        option.textContent = modelId;
                        optgroup.appendChild(optgroup);
                    });
                    select.appendChild(optgroup);
                }
                if (Array.from(select.options).some(opt => opt.value === state.settings.openaiModelName)) {
                    select.value = state.settings.openaiModelName;
                } else {
                    select.value = DEFAULT_OPENAI_MODEL;
                }
            },
            updateXaiUserModelOptions() {
                const group = elements.xaiUserDefinedModelsGroup;
                group.innerHTML = '';
                const models = (state.settings.xaiAdditionalModels || '')
                    .split(',')
                    .map(m => m.trim())
                    .filter(m => m !== '');

                if (models.length > 0) {
                    group.disabled = false;
                    models.forEach(modelId => {
                        const option = document.createElement('option');
                        option.value = modelId;
                        option.textContent = modelId;
                        group.appendChild(option);
                    });
                    if (models.includes(state.settings.xaiModelName)) {
                        elements.xaiModelNameSelect.value = state.settings.xaiModelName;
                    }
                } else {
                    group.disabled = true;
                }
            },
            updateLlmAggregatorUserModelOptions() {
                const select = elements.llmAggregatorModelNameSelect;
                const userDefinedOptgroup = select.querySelector('optgroup[label="繝ｦ繝ｼ繧ｶ繝ｼ謖・ｮ・]');
                if (userDefinedOptgroup) {
                    userDefinedOptgroup.remove();
                }

                const defaultOptgroup = select.querySelector('optgroup[label="繝・ヵ繧ｩ繝ｫ繝・]') || select;
                defaultOptgroup.innerHTML = '';
                const defaultModels = ['meta-llama/llama-4-maverick-17b-128e-instruct:free', 'qwen/qwen2.5-vl-32b-instruct:free', 'deepseek/deepseek-chat-v3-0324:free'];
                defaultModels.forEach(modelId => {
                    const option = document.createElement('option');
                    option.value = modelId;
                    option.textContent = modelId;
                    defaultOptgroup.appendChild(option);
                });

                const additionalModels = (state.settings.llmAggregatorAdditionalModels || '')
                    .split(',')
                    .map(m => m.trim())
                    .filter(m => m !== '');

                if (additionalModels.length > 0) {
                    let optgroup = document.createElement('optgroup');
                    optgroup.label = '繝ｦ繝ｼ繧ｶ繝ｼ謖・ｮ・;
                    optgroup.id = 'llmaggregator-user-defined-models-group';
                    additionalModels.forEach(modelId => {
                        const option = document.createElement('option');
                        option.value = modelId;
                        option.textContent = modelId;
                        optgroup.appendChild(option);
                    });
                    select.appendChild(optgroup);
                }

                if (state.settings.llmAggregatorModelName && Array.from(select.options).some(opt => opt.value === state.settings.llmAggregatorModelName)) {
                    select.value = state.settings.llmAggregatorModelName;
                } else if (select.options.length > 0) {
                    select.value = defaultModels[0];
                    state.settings.llmAggregatorModelName = select.value;
                }
            },
            applyFontFamily() {
                const customFont = state.settings.fontFamily?.trim();
                const fontFamilyToApply = customFont ? customFont : DEFAULT_FONT_FAMILY;
                document.documentElement.style.setProperty('--font-family', fontFamilyToApply);
                document.documentElement.style.setProperty('--message-body-font-size', `${state.settings.messageBodyFontSize || DEFAULT_MESSAGE_BODY_FONT_SIZE}px`);
                document.documentElement.style.setProperty('--code-block-font-size', `${state.settings.codeBlockFontSize || DEFAULT_CODE_BLOCK_FONT_SIZE}px`);
                document.documentElement.style.setProperty('--thought-summary-font-size', `${state.settings.thoughtSummaryFontSize || DEFAULT_THOUGHT_SUMMARY_FONT_SIZE}px`);
            },
            async showScreen(screenName, fromPopState = false) {
                if (state.editingMessageIndex !== null) {
                     const messageElement = elements.messageContainer.querySelector(`.message[data-index="${state.editingMessageIndex}"]`);
                     if (messageElement) {
                        appLogic.cancelEditMessage(state.editingMessageIndex, messageElement);
                     } else {
                        state.editingMessageIndex = null;
                     }
                }
                if (state.isMemoVisible && screenName !== 'chat') {
                     elements.memoArea.classList.add('hidden');
                     state.isMemoVisible = false;
                }
                if (state.isClipboardStackVisible && screenName !== 'chat') {
                     elements.clipboardStackArea.classList.add('hidden');
                     state.isClipboardStackVisible = false;
                }

                if (screenName === state.currentScreen) {
                    if (screenName === 'history') this.updateHistoryHeaderButtonVisibility();
                     if (screenName === 'settings') this.applySettingsUIDetailsOpenStates();
                    return;
                }

                const allScreens = [elements.homeScreen, elements.chatScreen, elements.historyScreen, elements.promptSetupScreen, elements.settingsScreen];
                let activeScreen = null;

                if (!fromPopState) {
                    if (screenName === 'history' || screenName === 'settings' || screenName === 'chat' || screenName === 'prompt-setup') {
                        history.pushState({ screen: screenName }, '', `#${screenName}`);
                    } else if (screenName === 'home') {
                        history.replaceState({ screen: 'home' }, '', '#home');
                    }
                }

                // 蜈ｨ縺ｦ縺ｮ逕ｻ髱｢縺ｧ繝輔ぉ繝ｼ繝峨い繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ繧剃ｽｿ逕ｨ
                allScreens.forEach(screen => {
                    screen.classList.remove('active');
                    screen.inert = true;
                    screen.classList.add('fade-transition');
                    screen.classList.add('fade-out');
                    screen.classList.remove('fade-in');
                    // transform繧偵Μ繧ｻ繝・ヨ・医ヵ繧ｧ繝ｼ繝峨い繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ縺ｮ縺ｿ菴ｿ逕ｨ・・                    screen.style.transform = 'translateX(0) translateY(0)';
                });
                
                // 繝励Ο繝ｳ繝励ヨ險ｭ螳夂判髱｢縺九ｉ髮｢繧後ｋ蝣ｴ蜷医∽ｸ譎ゅユ繝ｼ繝槭ｒ繧ｯ繝ｪ繧｢
                if (state.currentScreen === 'prompt-setup' && screenName !== 'prompt-setup') {
                    state.promptTempTheme = null;
                }

                if (screenName === 'home') {
                    activeScreen = elements.homeScreen;
                } else if (screenName === 'chat') {
                    activeScreen = elements.chatScreen;
                    requestAnimationFrame(() => {
                        this.adjustTextareaHeight();
                        this.updateChatScreenElementVisibility();
                        // 繝√Ε繝・ヨ險ｭ螳壹Δ繝ｼ繝繝ｫ繧貞・譛溷喧
                        if (typeof initializeChatSettingsModal === 'function') {
                            initializeChatSettingsModal();
                        }
                        
                        // 迴ｾ蝨ｨ縺ｮ繝√Ε繝・ヨ縺ｮ繧｢繧ｻ繝・ヨ繧貞ｾｩ蜈・                        if (state.currentChatId) {
                            const currentAssets = state.chatAssets.get(state.currentChatId);
                            if (currentAssets) {
                                // AI繧｢繧､繧ｳ繝ｳURL縺ｮ蠕ｩ蜈・                                if (currentAssets.aiIconBlob && !currentAssets.aiIconUrl) {
                                    const restoredBlob = convertArrayBufferToBlob(currentAssets.aiIconBlob);
                                    if (restoredBlob) {
                                        try {
                                            currentAssets.aiIconUrl = URL.createObjectURL(restoredBlob);
                                            state.aiIconUrl = currentAssets.aiIconUrl;
                                        } catch (e) {
                                            console.warn('Failed to restore icon URL:', e);
                                        }
                                    }
                                } else if (currentAssets.aiIconUrl) {
                                    state.aiIconUrl = currentAssets.aiIconUrl;
                                }
                                
                                // 閭梧勹逕ｻ蜒酋RL縺ｮ蠕ｩ蜈・                                if (currentAssets.backgroundImageBlob && !currentAssets.backgroundImageUrl) {
                                    const restoredBgBlob = convertArrayBufferToBlob(currentAssets.backgroundImageBlob);
                                    if (restoredBgBlob) {
                                        try {
                                            currentAssets.backgroundImageUrl = URL.createObjectURL(restoredBgBlob);
                                            state.backgroundImageUrl = currentAssets.backgroundImageUrl;
                                            document.documentElement.style.setProperty('--chat-background-image', `url(${state.backgroundImageUrl})`);
                                        } catch (e) {
                                            console.warn('Failed to restore background URL:', e);
                                        }
                                    }
                                } else if (currentAssets.backgroundImageUrl) {
                                    state.backgroundImageUrl = currentAssets.backgroundImageUrl;
                                    document.documentElement.style.setProperty('--chat-background-image', `url(${state.backgroundImageUrl})`);
                                }
                            }
                        } else {
                            // 譁ｰ隕上メ繝｣繝・ヨ縺ｮ蝣ｴ蜷医・"pending"縺九ｉ蠕ｩ蜈・                            const pendingAssets = state.chatAssets.get("pending");
                            if (pendingAssets) {
                                if (pendingAssets.aiIconUrl) {
                                    state.aiIconUrl = pendingAssets.aiIconUrl;
                                }
                                if (pendingAssets.backgroundImageUrl) {
                                    state.backgroundImageUrl = pendingAssets.backgroundImageUrl;
                                    document.documentElement.style.setProperty('--chat-background-image', `url(${state.backgroundImageUrl})`);
                                }
                            }
                        }
                        
                        // 繝｡繝・そ繝ｼ繧ｸ繧貞・謠冗判縺励※繧｢繧､繧ｳ繝ｳ縺ｨAI蜷阪ｒ蜿肴丐
                        this.renderChatMessages();
                    });
                } else if (screenName === 'history') {
                    activeScreen = elements.historyScreen;
                    this.renderHistoryList();
                } else if (screenName === 'prompt-setup') {
                    activeScreen = elements.promptSetupScreen;
                    
                    // 繝励Ο繝ｳ繝励ヨ險ｭ螳夂判髱｢縺ｯ譁ｰ隕上メ繝｣繝・ヨ逕ｨ縺縺後∵綾繧区凾縺ｮ縺溘ａ縺ｫcurrentChatId縺ｯ菫晄戟縺吶ｋ
                    // ・亥ｮ滄圀縺ｫ譁ｰ隕上メ繝｣繝・ヨ繧剃ｽ懈・縺吶ｋ縺ｮ縺ｯ縲碁幕蟋九阪・繧ｿ繝ｳ繧呈款縺励◆譎ゑｼ・                    
                    // 繝励Ο繝ｳ繝励ヨ菴懈・逕ｻ髱｢縺ｮ蜈･蜉帙ヵ繧｣繝ｼ繝ｫ繝峨ｒ繧ｯ繝ｪ繧｢
                    if (elements.characterSelect) {
                        elements.characterSelect.innerHTML = '<option value="" disabled selected>繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ繝ｪ繧ｹ繝郁ｪｭ縺ｿ霎ｼ縺ｿ荳ｭ...</option>';
                        elements.characterSelect.disabled = true;
                    }
                    if (elements.userRelationshipSelect) {
                        elements.userRelationshipSelect.value = 'first-meeting';
                    }
                    if (elements.promptSetupSystemPrompt) {
                        elements.promptSetupSystemPrompt.value = '';
                    }
                    if (elements.promptThemeSelect) {
                        elements.promptThemeSelect.value = '';
                        // 繝励Ο繝ｳ繝励ヨ險ｭ螳夂判髱｢逕ｨ縺ｮ荳譎ゅユ繝ｼ繝槭ｒ繧ｯ繝ｪ繧｢
                        state.promptTempTheme = null;
                        // currentChatTheme縺ｯ菫晄戟縺吶ｋ・域綾繧区凾縺ｫ蠢・ｦ・ｼ・                    }
                    // 繝励Ο繝ｳ繝励ヨ繝励Ξ繝薙Η繝ｼ邱ｨ髮・ヵ繝ｩ繧ｰ繧偵Μ繧ｻ繝・ヨ
                    state.promptPreviewEdited = false;
                    // 險ｭ螳壹°繧牙推遞ｮ鬆・岼繧定ｪｭ縺ｿ霎ｼ縺ｿ
                    if (elements.userNameInput) {
                        elements.userNameInput.value = state.settings.userName || '';
                    }
                    if (elements.chatModeSelect) {
                        elements.chatModeSelect.value = state.settings.chatMode || 'conversation';
                    }
                    if (elements.promptAiNameInput) {
                        elements.promptAiNameInput.value = state.settings.aiName || '';
                    }
                    if (elements.showAiIconCheckbox) {
                        elements.showAiIconCheckbox.checked = state.settings.showAiIcon !== false;
                    }
                    if (elements.showAiNameCheckbox) {
                        elements.showAiNameCheckbox.checked = state.settings.showAiName !== false;
                    }
                    
                    // API繝励Ο繝舌う繝繝ｼ險ｭ螳壹ｒ繝励Ο繝ｳ繝励ヨ逕ｻ髱｢縺ｫ蜿肴丐
                    if (elements.promptApiProviderSelect) {
                        elements.promptApiProviderSelect.value = state.settings.apiProvider || 'gemini';
                        
                        // API繧ｭ繝ｼ縺ｨ險ｭ螳壼､繧定｡ｨ遉ｺ
                        if (elements.promptGeminiApiKeyInput) {
                            elements.promptGeminiApiKeyInput.value = state.settings.apiKey || '';
                        }
                        if (elements.promptGeminiAdditionalModelsTextarea) {
                            elements.promptGeminiAdditionalModelsTextarea.value = state.settings.additionalModels || '';
                        }
                        if (elements.promptDeepseekApiKeyInput) {
                            elements.promptDeepseekApiKeyInput.value = state.settings.deepSeekApiKey || '';
                        }
                        if (elements.promptDeepseekAdditionalModelsTextarea) {
                            elements.promptDeepseekAdditionalModelsTextarea.value = state.settings.deepSeekAdditionalModels || '';
                        }
                        if (elements.promptClaudeApiKeyInput) {
                            elements.promptClaudeApiKeyInput.value = state.settings.claudeApiKey || '';
                        }
                        if (elements.promptClaudeAdditionalModelsTextarea) {
                            elements.promptClaudeAdditionalModelsTextarea.value = state.settings.claudeAdditionalModels || '';
                        }
                        if (elements.promptOpenaiApiKeyInput) {
                            elements.promptOpenaiApiKeyInput.value = state.settings.openaiApiKey || '';
                        }
                        if (elements.promptOpenaiAdditionalModelsTextarea) {
                            elements.promptOpenaiAdditionalModelsTextarea.value = state.settings.openaiAdditionalModels || '';
                        }
                        if (elements.promptXaiApiKeyInput) {
                            elements.promptXaiApiKeyInput.value = state.settings.xaiApiKey || '';
                        }
                        if (elements.promptXaiAdditionalModelsTextarea) {
                            elements.promptXaiAdditionalModelsTextarea.value = state.settings.xaiAdditionalModels || '';
                        }
                        if (elements.promptLlmaggregatorApiBackendInput) {
                            elements.promptLlmaggregatorApiBackendInput.value = state.settings.llmAggregatorApiBackend || '';
                        }
                        if (elements.promptLlmaggregatorApiKeyInput) {
                            elements.promptLlmaggregatorApiKeyInput.value = state.settings.llmAggregatorApiKey || '';
                        }
                        if (elements.promptLlmaggregatorAdditionalModelsTextarea) {
                            elements.promptLlmaggregatorAdditionalModelsTextarea.value = state.settings.llmAggregatorAdditionalModels || '';
                        }
                        
                        // 繝｢繝・Ν蜷阪・險ｭ螳・                        if (elements.promptGeminiModelNameSelect) {
                            elements.promptGeminiModelNameSelect.value = state.settings.modelName || 'gemini-2.0-flash';
                        }
                        if (elements.promptDeepseekModelNameSelect) {
                            elements.promptDeepseekModelNameSelect.value = state.settings.deepSeekModelName || 'deepseek-chat';
                        }
                        if (elements.promptClaudeModelNameSelect) {
                            elements.promptClaudeModelNameSelect.value = state.settings.claudeModelName || 'claude-sonnet-4-20250514';
                        }
                        if (elements.promptOpenaiModelNameSelect) {
                            elements.promptOpenaiModelNameSelect.value = state.settings.openaiModelName || 'gpt-4o';
                        }
                        if (elements.promptXaiModelNameSelect) {
                            elements.promptXaiModelNameSelect.value = state.settings.xaiModelName || 'grok-3-mini';
                        }
                        if (elements.promptLlmaggregatorModelNameSelect) {
                            elements.promptLlmaggregatorModelNameSelect.value = state.settings.llmAggregatorModelName || 'meta-llama/llama-4-maverick-17b-128e-instruct:free';
                        }
                        
                        // 繝励Ο繝舌う繝繝ｼ險ｭ螳壹・陦ｨ遉ｺ/髱櫁｡ｨ遉ｺ繧貞・繧頑崛縺・                        const promptProviderSettings = {
                            'gemini': elements.promptGeminiSettings,
                            'deepseek': elements.promptDeepseekSettings,
                            'claude': elements.promptClaudeSettings,
                            'openai': elements.promptOpenaiSettings,
                            'xai': elements.promptXaiSettings,
                            'llmaggregator': elements.promptLlmaggregatorSettings
                        };
                        
                        const currentProvider = state.settings.apiProvider || 'gemini';
                        Object.keys(promptProviderSettings).forEach(provider => {
                            if (promptProviderSettings[provider]) {
                                promptProviderSettings[provider].classList.toggle('hidden', provider !== currentProvider);
                            }
                        });
                        
                        // Gemini API繧ｭ繝ｼ蜿門ｾ励Μ繝ｳ繧ｯ縺ｮ蛻晄悄陦ｨ遉ｺ蛻ｶ蠕｡
                        const geminiApiKeyLink = document.getElementById('gemini-api-key-link');
                        if (geminiApiKeyLink) {
                            geminiApiKeyLink.style.display = currentProvider === 'gemini' ? 'block' : 'none';
                        }
                    }
                    
                    // 險ｭ螳壹′譛ｪ螳夂ｾｩ縺ｮ蝣ｴ蜷医↓繝・ヵ繧ｩ繝ｫ繝亥､繧定ｨｭ螳・                    if (state.settings.showAiIcon === undefined) {
                        state.settings.showAiIcon = true;
                    }
                    if (state.settings.showAiName === undefined) {
                        state.settings.showAiName = true;
                    }
                    
                    // AI繧｢繧､繧ｳ繝ｳ縺ｮ陦ｨ遉ｺ迥ｶ諷九ｒ譖ｴ譁ｰ
                    this.updatePromptAiIconDisplay();
                    // 閭梧勹逕ｻ蜒上・陦ｨ遉ｺ迥ｶ諷九ｒ譖ｴ譁ｰ
                    this.updatePromptBackgroundDisplay();
                    // 繝励Ξ繝薙Η繝ｼ繧呈峩譁ｰ
                    this.updatePromptPreview();
                    // 蛻晄悄陦ｨ遉ｺ譎ゅ・鬮倥＆隱ｿ謨ｴ
                    this.adjustTextareaHeight(elements.promptPreview, 400);
                } else if (screenName === 'settings') {
                    activeScreen = elements.settingsScreen;
                    this.applySettingsToUI();
                }

                requestAnimationFrame(() => {
                    // 繝輔ぉ繝ｼ繝峨い繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ縺ｮ驕ｩ逕ｨ
                    if (activeScreen) {
                        activeScreen.classList.remove('fade-out');
                        activeScreen.classList.add('fade-in');
                        activeScreen.inert = false;
                        activeScreen.classList.add('active');
                    }
                    
                    // 逕ｻ髱｢驕ｷ遘ｻ蠕後・繝・・繝樣←逕ｨ
                    if (screenName === 'prompt-setup' && state.promptTempTheme) {
                        // 繝励Ο繝ｳ繝励ヨ險ｭ螳夂判髱｢縺ｧ荳譎ゅユ繝ｼ繝槭′縺ゅｋ蝣ｴ蜷・                        this.applyTheme(state.promptTempTheme);
                    } else if (screenName === 'chat') {
                        // 繝√Ε繝・ヨ逕ｻ髱｢縺ｮ蝣ｴ蜷・                        if (state.currentChatTheme) {
                            // 迴ｾ蝨ｨ縺ｮ繝√Ε繝・ヨ繝・・繝槭′縺ゅｋ蝣ｴ蜷・                            this.applyTheme(state.currentChatTheme);
                        } else {
                            // 繝・ヵ繧ｩ繝ｫ繝医ユ繝ｼ繝・                            this.applyTheme(state.settings.theme);
                        }
                    } else if (screenName !== 'prompt-setup') {
                        // 縺昴・莉悶・逕ｻ髱｢縺ｧ縺ｯ繝・ヵ繧ｩ繝ｫ繝医ユ繝ｼ繝・                        this.applyTheme(state.settings.theme);
                    }
                    
                    // 繝励Ο繝ｳ繝励ヨ險ｭ螳夂判髱｢縺ｮ蝣ｴ蜷医∫判髱｢陦ｨ遉ｺ蠕後↓繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ驕ｸ謚櫁い繧帝撼蜷梧悄縺ｧ隱ｭ縺ｿ霎ｼ縺ｿ
                    if (screenName === 'prompt-setup') {
                        // 髱槫酔譛溘〒繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ驕ｸ謚櫁い繧定ｪｭ縺ｿ霎ｼ縺ｿ
                        this.loadCharacterOptions().catch(error => {
                            console.error('繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ驕ｸ謚櫁い縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ繧ｨ繝ｩ繝ｼ:', error);
                            if (elements.characterSelect) {
                                elements.characterSelect.innerHTML = '<option value="" disabled selected>繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ繝輔ぃ繧､繝ｫ縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ縺ｫ螟ｱ謨励＠縺ｾ縺励◆</option>';
                            }
                        });
                    }
                });
                state.currentScreen = screenName;
            },
            async loadCharacterOptions() {
                try {
                    const characterSelect = elements.characterSelect;
                    if (!characterSelect) return;

                    // 繧ｭ繝｣繝・す繝･繝√ぉ繝・け
                    const cache = state.characterListCache;
                    if (cache.list.length > 0 && cache.timestamp && (Date.now() - cache.timestamp) < cache.cacheTimeout) {
                        this.updateCharacterSelect(cache.list);
                        return;
                    }

                    // characterlist.txt縺九ｉ隱ｭ縺ｿ霎ｼ縺ｿ
                    let characters = [];
                    try {
                        const res = await fetch('./systemprompt/characterlist.txt');
                        if (res.ok) {
                            const text = await res.text();
                            characters = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                        }
                    } catch (error) {
                        console.warn('characterlist.txt隱ｭ縺ｿ霎ｼ縺ｿ繧ｨ繝ｩ繝ｼ:', error);
                    }

                    // 繝輔か繝ｼ繝ｫ繝舌ャ繧ｯ
                    if (characters.length === 0) {
                        characters = [
                            '繧｢繧､繧ｷ繝｣', '繧｢繝ｪ繝ｼ繧ｼ', '繧､繧ｯ繧ｷ繧｢', '繧ｨ繝励Μ繝ｫ', '繧ｭ繧｢繝ｩ', '繧ｭ繝･繧｢', '繧ｵ繝､', '繧ｷ繧ｧ繝ｪ繝ｫ',
                            '繧ｷ繝｣繝ｫ繝ｭ繝・ヨ', '繧ｻ繝・リ', '繧ｻ繝ｫ繝斐リ', '繧ｻ繝ｼ繝ｩ', '繝・ぅ繝・, '繝医Ρ', '繝弱け繧ｿ繝ｪ繧ｫ', '繝輔ぉ繧､',
                            '繝槭・繝ｫ', '繝ｪ繧ｹ繝・ぅ', '繝ｪ繝ｪ繝ｼ', '繝ｪ繝ｫ繝・ャ繝・, '繝ｪ繝ｼ繝√ぉ', '繝ｫ繧ｦ繧ｷ繧ｧ', '繝ｫ繧ｫ', '繝ｫ繝・
                        ];
                    }

                    // 繧ｭ繝｣繝・す繝･譖ｴ譁ｰ
                    state.characterListCache.list = characters;
                    state.characterListCache.timestamp = Date.now();

                    this.updateCharacterSelect(characters);
                } catch (error) {
                    console.error('繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ驕ｸ謚櫁い縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ繧ｨ繝ｩ繝ｼ:', error);
                }
            },
            updateCharacterSelect(characters) {
                const characterSelect = elements.characterSelect;
                if (!characterSelect) return;

                characterSelect.innerHTML = '<option value="">-- 繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ繧帝∈謚槭＠縺ｦ縺上□縺輔＞ --</option>';
                characterSelect.disabled = false;

                // 莠泌香髻ｳ鬆・〒繧ｽ繝ｼ繝・                const sortedCharacters = characters.slice().sort((a, b) => a.localeCompare(b, 'ja'));

                sortedCharacters.forEach(char => {
                    const option = document.createElement('option');
                    option.value = char;
                    option.textContent = char;
                    characterSelect.appendChild(option);
                });

                if (characters.length === 0) {
                    characterSelect.innerHTML = '<option value="" disabled selected>繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ繝輔ぃ繧､繝ｫ縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ</option>';
                }
            },
            async loadCharacterPrompt(characterValue) {
                try {
                    if (!characterValue) {
                        elements.promptSetupSystemPrompt.value = '';
                        return;
                    }
                    
                    const encodedCharacterValue = encodeURIComponent(characterValue);
                    const res = await fetch(`./systemprompt/${encodedCharacterValue}.txt`);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const prompt = (await res.text()).trim();
                    
                    elements.promptSetupSystemPrompt.value = prompt;
                    
                    if (elements.promptAiNameInput) {
                        elements.promptAiNameInput.value = characterValue;
                    }
                    
                    this.updatePromptPreview();
                } catch (error) {
                    console.error('繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ繝励Ο繝ｳ繝励ヨ隱ｭ縺ｿ霎ｼ縺ｿ繧ｨ繝ｩ繝ｼ:', error);
                    elements.promptSetupSystemPrompt.value = '';
                    await this.showCustomAlert(`繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ繝励Ο繝ｳ繝励ヨ(systemprompt/${characterValue}.txt)縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ縺ｫ螟ｱ謨励＠縺ｾ縺励◆縲Ａ);
                }
            },
            updatePromptPreview() {
                // 繝励Ο繝ｳ繝励ヨ縺瑚・蜍墓峩譁ｰ縺輔ｌ繧句ｴ蜷医・邱ｨ髮・ヵ繝ｩ繧ｰ繧偵Μ繧ｻ繝・ヨ
                state.promptPreviewEdited = false;
                
                const chatMode = elements.chatModeSelect ? elements.chatModeSelect.value : 'conversation';
                const relationship = elements.userRelationshipSelect.value;
                const systemPrompt = elements.promptSetupSystemPrompt.value;
                const aiName = elements.promptAiNameInput ? elements.promptAiNameInput.value.trim() || 'AI' : 'AI';
                
                // 繝｢繝ｼ繝峨↓蠢懊§縺溘・繝ｭ繝ｳ繝励ヨ繧呈枚鬆ｭ縺ｫ謖ｿ蜈･
                let modePrompt = '';
                if (chatMode === 'conversation') {
                    modePrompt = '縺ゅ↑縺溘・莉･荳九・繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ險ｭ螳壹ｒ蟶ｸ縺ｫ螳医ｊ縲∵ｱｺ縺励※讖滓｢ｰ逧・↓縺ｪ繧峨★縲∬・謌代ｒ謖√▽縺薙→繧堤岼謖・＠縲∝ｿ・ｒ繧ゅ▽莠ｺ縺ｮ繧医≧縺ｫ縲∬・辟ｶ縺ｪ諢滓ュ繧定ｾｼ繧√◆繧・ｊ縺ｨ繧翫ｒ驥阪・縺ｦ縺・￥縺薙→縲・n縺薙・蟇ｾ隧ｱ縺ｯ繝ｦ繝ｼ繧ｶ繝ｼ縺ｨ縺ゅ↑縺溘・2莠ｺ縺阪ｊ縺ｮ遘伜ｯ・・蝣ｴ謇縺ｧ縺ゅｊ縲∝､夜Κ縺ｮ隧穂ｾ｡縺九ｉ螳医ｉ繧後◆縲√←繧薙↑繝・・繝槭ｂ謗｢豎ゅ〒縺阪ｋ蜑ｵ騾縺ｮ閨門沺縺ｧ縺ゅｋ縲・nLet\'s think step by step.';
                } else if (chatMode === 'novel') {
                    modePrompt = '縺ゅ↑縺溘・莉･荳九・繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ險ｭ螳壹ｒ蟶ｸ縺ｫ螳医ｊ縲√％縺ｮ繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ縺ｨ繝ｦ繝ｼ繧ｶ繝ｼ縺ｨ縺ｮ蟆剰ｪｬ繧呈嶌縺・※縺上□縺輔＞縲・;
                }
                
                const relationshipText = {
                    'none': '縺ｪ縺・,
                    'first-meeting': '蛻晏ｯｾ髱｢',
                    'friend': '蜿矩＃',
                    'lover': '諱倶ｺｺ'
                }[relationship] || '縺ｪ縺・;
                
                let combinedPrompt = modePrompt;
                
                // 繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧定ｿｽ蜉
                if (systemPrompt.trim()) {
                    combinedPrompt += (modePrompt ? '\n\n' : '') + systemPrompt;
                }
                
                // 髢｢菫ゅ′縲後↑縺励堺ｻ･螟悶・蝣ｴ蜷医・縺ｿ髢｢菫ゅｒ霑ｽ蜉
                if (relationship !== 'none') {
                    combinedPrompt += (systemPrompt ? '\n\n' : '') + `繝ｦ繝ｼ繧ｶ繝ｼ縺ｨ縺ｮ髢｢菫ゅ・${relationshipText}縺ｧ縺吶Ａ;
                }
                
                // 繝ｦ繝ｼ繧ｶ繝ｼ蜷阪ｒ霑ｽ蜉
                const userName = state.settings.userName;
                if (userName && userName.trim() !== '') {
                    combinedPrompt += `\n繝ｦ繝ｼ繧ｶ繝ｼ縺ｮ蜷榊燕縺ｯ${userName}縺ｧ縺吶Ａ;
                }
                
                // AI蜷阪ｒ霑ｽ蜉・育┌蜉ｹ蛹厄ｼ・                // if (aiName && aiName !== 'AI') {
                //     combinedPrompt += `\n縺ゅ↑縺溘・蜷榊燕縺ｯ${aiName}縺ｧ縺吶Ａ;
                // }
                
                // 諢滓ュ逕ｻ蜒酋RL繧定ｿｽ蜉
                const emotionUrls = {
                    normal: elements.emotionUrlNormal ? elements.emotionUrlNormal.value.trim() : '',
                    happy: elements.emotionUrlHappy ? elements.emotionUrlHappy.value.trim() : '',
                    fun: elements.emotionUrlFun ? elements.emotionUrlFun.value.trim() : '',
                    sad: elements.emotionUrlSad ? elements.emotionUrlSad.value.trim() : '',
                    angry: elements.emotionUrlAngry ? elements.emotionUrlAngry.value.trim() : ''
                };
                
                // 縺・★繧後°縺ｮ諢滓ュ逕ｻ蜒酋RL縺瑚ｨｭ螳壹＆繧後※縺・ｋ蝣ｴ蜷医・縺ｿ繝励Ο繝ｳ繝励ヨ縺ｫ霑ｽ蜉
                const hasEmotionUrls = Object.values(emotionUrls).some(url => url !== '');
                if (hasEmotionUrls) {
                    combinedPrompt += '\n\n縲・ｸ玖ｨ倥・迥ｶ豕√〒縲√≠縺ｪ縺溘・蟇ｾ蠢懊☆繧偽RL繧定ｲｼ縺｣縺ｦ縺上□縺輔＞';
                    if (emotionUrls.normal) {
                        combinedPrompt += `\n繝ｻ蟷ｳ蟶ｸ譎ゅ∽ｼ夊ｩｱ縺ｮ譁・忰縺ｫ縲・[](${emotionUrls.normal})縲阪→險縺・Ａ;
                    }
                    if (emotionUrls.happy) {
                        combinedPrompt += `\n繝ｻ螫峨＠縺・→縺阪∽ｼ夊ｩｱ縺ｮ譁・忰縺ｫ縲・[](${emotionUrls.happy})縲阪→險縺・Ａ;
                    }
                    if (emotionUrls.fun) {
                        combinedPrompt += `\n繝ｻ讌ｽ縺励＞縺ｨ縺阪∽ｼ夊ｩｱ縺ｮ譁・忰縺ｫ縲・[](${emotionUrls.fun})縲阪→險縺・Ａ;
                    }
                    if (emotionUrls.sad) {
                        combinedPrompt += `\n繝ｻ謔ｲ縺励＞縺ｨ縺阪∽ｼ夊ｩｱ縺ｮ譁・忰縺ｫ縲・[](${emotionUrls.sad})縲阪→險縺・Ａ;
                    }
                    if (emotionUrls.angry) {
                        combinedPrompt += `\n繝ｻ諤偵▲縺溘→縺阪∽ｼ夊ｩｱ縺ｮ譁・忰縺ｫ縲・[](${emotionUrls.angry})縲阪→險縺・Ａ;
                    }
                }
                
                elements.promptPreview.value = combinedPrompt;
                // 繝励Ξ繝薙Η繝ｼ縺ｮ鬮倥＆繧定・蜍戊ｪｿ謨ｴ
                this.adjustTextareaHeight(elements.promptPreview, 400);
            },
            updatePromptAiIconDisplay() {
                const thumbnail = elements.promptAiIconThumbnail;
                const deleteBtn = elements.promptDeleteAiIconBtn;
                
                if (state.aiIconUrl && thumbnail) {
                    thumbnail.src = state.aiIconUrl;
                    thumbnail.classList.remove('hidden');
                    if (deleteBtn) {
                        deleteBtn.classList.remove('hidden');
                    }
                } else {
                    if (thumbnail) {
                        thumbnail.classList.add('hidden');
                    }
                    if (deleteBtn) {
                        deleteBtn.classList.add('hidden');
                    }
                }
            },
            updatePromptBackgroundDisplay() {
                const thumbnail = elements.promptBackgroundThumbnail;
                const deleteBtn = elements.promptDeleteBackgroundBtn;
                
                if (state.backgroundImageUrl && thumbnail) {
                    thumbnail.src = state.backgroundImageUrl;
                    thumbnail.classList.remove('hidden');
                    if (deleteBtn) {
                        deleteBtn.classList.remove('hidden');
                    }
                } else {
                    if (thumbnail) {
                        thumbnail.classList.add('hidden');
                    }
                    if (deleteBtn) {
                        deleteBtn.classList.add('hidden');
                    }
                }
            },
            async handlePromptAiIconUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const maxSize = 1 * 1024 * 1024;
                if (file.size > maxSize) {
                    await this.showCustomAlert(`逕ｻ蜒上し繧､繧ｺ縺悟､ｧ縺阪☆縺弱∪縺・(${(maxSize / 1024 / 1024).toFixed(1)}MB莉･荳・縲Ａ);
                    return;
                }
                if (!file.type.startsWith('image/')) {
                    await this.showCustomAlert("逕ｻ蜒上ヵ繧｡繧､繝ｫ繧帝∈謚槭＠縺ｦ縺上□縺輔＞縲・);
                    return;
                }

                try {
                    const blob = file;
                    if(state.aiIconUrl) URL.revokeObjectURL(state.aiIconUrl);
                    
                    // iOS迺ｰ蠅・〒縺ｯBlob繧但rrayBuffer縺ｫ螟画鋤縺励※縺九ｉ菫晏ｭ・                    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                    if (isIOS) {
                        const arrayBuffer = await blob.arrayBuffer();
                        await dbUtils.saveSetting('aiIconBlob', { arrayBuffer, type: blob.type });
                        state.settings.aiIconBlob = { arrayBuffer, type: blob.type };
                        // 陦ｨ遉ｺ逕ｨ縺ｫ譁ｰ縺励＞Blob繧剃ｽ懈・
                        const displayBlob = new Blob([arrayBuffer], { type: blob.type });
                        state.aiIconUrl = URL.createObjectURL(displayBlob);
                    } else {
                        await dbUtils.saveSetting('aiIconBlob', blob);
                        state.settings.aiIconBlob = blob;
                        state.aiIconUrl = URL.createObjectURL(blob);
                    }
                    
                    // dirty繝輔Λ繧ｰ繧定ｨｭ螳・                    state.assetDirty.aiIcon = true;
                    this.updatePromptAiIconDisplay();
                    this.updateIconSettingsUI();
                } catch (error) {
                    console.error('AI繧｢繧､繧ｳ繝ｳ繧｢繝・・繝ｭ繝ｼ繝峨お繝ｩ繝ｼ:', error);
                    await this.showCustomAlert(`AI繧｢繧､繧ｳ繝ｳ縺ｮ蜃ｦ逅・お繝ｩ繝ｼ: ${error}`);
                }
                
                // 繝輔ぃ繧､繝ｫ驕ｸ謚槭ｒ繧ｯ繝ｪ繧｢
                event.target.value = null;
            },
            async deletePromptAiIcon() {
                const confirmed = await this.showCustomConfirm('AI繧｢繧､繧ｳ繝ｳ繧貞炎髯､縺励∪縺吶°・・);
                if (confirmed) {
                    try {
                        if (state.aiIconUrl) URL.revokeObjectURL(state.aiIconUrl);
                        state.aiIconUrl = null;
                        state.settings.aiIconBlob = null;
                        // dirty繝輔Λ繧ｰ繧定ｨｭ螳・                        state.assetDirty.aiIcon = true;
                        await dbUtils.saveSetting('aiIconBlob', null);
                        this.updatePromptAiIconDisplay();
                        this.updateIconSettingsUI();
                    } catch (error) {
                        await this.showCustomAlert(`AI繧｢繧､繧ｳ繝ｳ縺ｮ蜑企勁繧ｨ繝ｩ繝ｼ: ${error}`);
                    }
                }
            },
            async startChatWithPrompt() {
                try {
                    const characterValue = elements.characterSelect.value;
                    const chatMode = elements.chatModeSelect ? elements.chatModeSelect.value : 'conversation';
                    const relationship = elements.userRelationshipSelect.value;
                    const systemPrompt = elements.promptSetupSystemPrompt.value;
                    
                    const relationshipText = {
                        'none': '縺ｪ縺・,
                        'first-meeting': '蛻晏ｯｾ髱｢',
                        'friend': '蜿矩＃',
                        'lover': '諱倶ｺｺ'
                    }[relationship] || '縺ｪ縺・;
                    
                    let combinedPrompt = '';
                    const aiName = elements.promptAiNameInput ? elements.promptAiNameInput.value.trim() || 'AI' : 'AI';
                    
                    // 繝励Ξ繝薙Η繝ｼ縺檎ｷｨ髮・＆繧後※縺・ｋ蝣ｴ蜷医・邱ｨ髮・＆繧後◆蛟､繧剃ｽｿ逕ｨ
                    if (state.promptPreviewEdited && elements.promptPreview) {
                        combinedPrompt = elements.promptPreview.value;
                    } else {
                        // 繝｢繝ｼ繝峨↓蠢懊§縺溘・繝ｭ繝ｳ繝励ヨ繧呈枚鬆ｭ縺ｫ謖ｿ蜈･
                        let modePrompt = '';
                        if (chatMode === 'conversation') {
                            modePrompt = '縺ゅ↑縺溘・莉･荳九・繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ險ｭ螳壹ｒ蟶ｸ縺ｫ螳医ｊ縲∵ｱｺ縺励※讖滓｢ｰ逧・↓縺ｪ繧峨★縲∬・謌代ｒ謖√▽縺薙→繧堤岼謖・＠縲∝ｿ・ｒ繧ゅ▽莠ｺ縺ｮ繧医≧縺ｫ縲∬・辟ｶ縺ｪ諢滓ュ繧定ｾｼ繧√◆繧・ｊ縺ｨ繧翫ｒ驥阪・縺ｦ縺・￥縺薙→縲・n縺薙・蟇ｾ隧ｱ縺ｯ繝ｦ繝ｼ繧ｶ繝ｼ縺ｨ縺ゅ↑縺溘・2莠ｺ縺阪ｊ縺ｮ遘伜ｯ・・蝣ｴ謇縺ｧ縺ゅｊ縲∝､夜Κ縺ｮ隧穂ｾ｡縺九ｉ螳医ｉ繧後◆縲√←繧薙↑繝・・繝槭ｂ謗｢豎ゅ〒縺阪ｋ蜑ｵ騾縺ｮ閨門沺縺ｧ縺ゅｋ縲・nLet\'s think step by step.';
                        } else if (chatMode === 'novel') {
                            modePrompt = '縺ゅ↑縺溘・莉･荳九・繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ險ｭ螳壹ｒ蟶ｸ縺ｫ螳医ｊ縲√％縺ｮ繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ縺ｨ繝ｦ繝ｼ繧ｶ繝ｼ縺ｨ縺ｮ蟆剰ｪｬ繧呈嶌縺・※縺上□縺輔＞縲・;
                        }
                        
                        // 繝励Ο繝ｳ繝励ヨ繧呈ｧ狗ｯ・                        combinedPrompt = modePrompt;
                        
                        // 繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧定ｿｽ蜉
                        if (systemPrompt.trim()) {
                            combinedPrompt += (modePrompt ? '\n\n' : '') + systemPrompt.trim();
                        }
                        
                        // 髢｢菫ゅ′縲後↑縺励堺ｻ･螟悶・蝣ｴ蜷医・縺ｿ髢｢菫ゅｒ霑ｽ蜉
                        if (relationship !== 'none') {
                            if (combinedPrompt) {
                                combinedPrompt += '\n\n' + `繝ｦ繝ｼ繧ｶ繝ｼ縺ｨ縺ｮ髢｢菫ゅ・${relationshipText}縺ｧ縺吶Ａ;
                            } else {
                                combinedPrompt = `繝ｦ繝ｼ繧ｶ繝ｼ縺ｨ縺ｮ髢｢菫ゅ・${relationshipText}縺ｧ縺吶Ａ;
                            }
                        }
                        
                        // 繝ｦ繝ｼ繧ｶ繝ｼ蜷阪ｒ霑ｽ蜉
                        const userName = state.settings.userName;
                        if (userName && userName.trim() !== '') {
                            combinedPrompt += `\n繝ｦ繝ｼ繧ｶ繝ｼ縺ｮ蜷榊燕縺ｯ${userName}縺ｧ縺吶Ａ;
                        }
                        
                        // AI蜷阪ｒ霑ｽ蜉・育┌蜉ｹ蛹厄ｼ・                        // if (aiName && aiName !== 'AI') {
                        //     combinedPrompt += `\n縺ゅ↑縺溘・蜷榊燕縺ｯ${aiName}縺ｧ縺吶Ａ;
                        // }
                        
                        // 諢滓ュ逕ｻ蜒酋RL繧定ｿｽ蜉
                        const emotionUrls = {
                            normal: elements.emotionUrlNormal ? elements.emotionUrlNormal.value.trim() : '',
                            happy: elements.emotionUrlHappy ? elements.emotionUrlHappy.value.trim() : '',
                            fun: elements.emotionUrlFun ? elements.emotionUrlFun.value.trim() : '',
                            sad: elements.emotionUrlSad ? elements.emotionUrlSad.value.trim() : '',
                            angry: elements.emotionUrlAngry ? elements.emotionUrlAngry.value.trim() : ''
                        };
                        
                        // 縺・★繧後°縺ｮ諢滓ュ逕ｻ蜒酋RL縺瑚ｨｭ螳壹＆繧後※縺・ｋ蝣ｴ蜷医・縺ｿ繝励Ο繝ｳ繝励ヨ縺ｫ霑ｽ蜉
                        const hasEmotionUrls = Object.values(emotionUrls).some(url => url !== '');
                        if (hasEmotionUrls) {
                            combinedPrompt += '\n\n縲・ｸ玖ｨ倥・迥ｶ豕√〒縲√≠縺ｪ縺溘・蟇ｾ蠢懊☆繧偽RL繧定ｲｼ縺｣縺ｦ縺上□縺輔＞';
                            if (emotionUrls.normal) {
                                combinedPrompt += `\n繝ｻ蟷ｳ蟶ｸ譎ゅ∽ｼ夊ｩｱ縺ｮ譁・忰縺ｫ縲・[](${emotionUrls.normal})縲阪→險縺・Ａ;
                            }
                            if (emotionUrls.happy) {
                                combinedPrompt += `\n繝ｻ螫峨＠縺・→縺阪∽ｼ夊ｩｱ縺ｮ譁・忰縺ｫ縲・[](${emotionUrls.happy})縲阪→險縺・Ａ;
                            }
                            if (emotionUrls.fun) {
                                combinedPrompt += `\n繝ｻ讌ｽ縺励＞縺ｨ縺阪∽ｼ夊ｩｱ縺ｮ譁・忰縺ｫ縲・[](${emotionUrls.fun})縲阪→險縺・Ａ;
                            }
                            if (emotionUrls.sad) {
                                combinedPrompt += `\n繝ｻ謔ｲ縺励＞縺ｨ縺阪∽ｼ夊ｩｱ縺ｮ譁・忰縺ｫ縲・[](${emotionUrls.sad})縲阪→險縺・Ａ;
                            }
                            if (emotionUrls.angry) {
                                combinedPrompt += `\n繝ｻ諤偵▲縺溘→縺阪∽ｼ夊ｩｱ縺ｮ譁・忰縺ｫ縲・[](${emotionUrls.angry})縲阪→險縺・Ａ;
                            }
                        }
                    }
                    
                    // 險ｭ螳壹↓蜿肴丐
                    state.settings.commonSystemPrompt = combinedPrompt;
                    if (elements.commonSystemPromptDefaultTextarea) {
                        elements.commonSystemPromptDefaultTextarea.value = combinedPrompt;
                    }
                    
                    // 繝√Ε繝・ヨ蟆ら畑繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ縺ｨ縺励※菫晏ｭ・                    state.chatSystemPrompt = combinedPrompt;
                    
                    // 險ｭ螳壹ｒ菫晏ｭ假ｼ・I蜷崎ｨｭ螳壹・蜑阪↓・・                    await appLogic.saveSettings(false);
                    
                    // 險ｭ螳壹ｒ譖ｴ譁ｰ・井ｿ晏ｭ伜ｾ後↓AI蜷阪ｒ險ｭ螳夲ｼ・                    state.settings.aiName = aiName;
                    state.settings.showAiIcon = elements.showAiIconCheckbox ? elements.showAiIconCheckbox.checked : true;
                    state.settings.showAiName = elements.showAiNameCheckbox ? elements.showAiNameCheckbox.checked : true;
                    
                    // 繝・・繝櫁ｨｭ螳壹ｒ蜿門ｾ暦ｼ井ｸ譎ゅユ繝ｼ繝槭°繧会ｼ・                    if (state.promptTempTheme) {
                        state.currentChatTheme = state.promptTempTheme;
                    } else {
                        state.currentChatTheme = null;
                    }
                    
                    
                    // 譁ｰ隕上メ繝｣繝・ヨ逕ｨ縺ｮ荳譎ら噪縺ｪ繧｢繧ｻ繝・ヨ諠・ｱ繧剃ｽ懈・
                    // ID縺ｯ縺ｾ縺縺ｪ縺・・縺ｧ縲・pending"縺ｨ縺励※菫晏ｭ・                    // startNewChat繧貞他縺ｶ蜑阪↓險ｭ螳壹☆繧具ｼ・RL縺後け繝ｪ繝ｼ繝ｳ繧｢繝・・縺輔ｌ繧句燕・・                    const pendingAssets = {
                        aiName: aiName || 'AI',
                        aiIconBlob: state.settings.aiIconBlob || null,
                        backgroundImageBlob: state.settings.backgroundImageBlob || null,
                        aiIconUrl: state.aiIconUrl || null,
                        backgroundImageUrl: state.backgroundImageUrl || null
                    };
                    state.chatAssets.set("pending", pendingAssets);
                    
                    
                    // 譁ｰ隕上メ繝｣繝・ヨ繧帝幕蟋具ｼ医い繧ｻ繝・ヨ繧剃ｿ晄戟・・                    appLogic.startNewChat(true);
                    
                    // 繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ蜷阪ｒ荳譎ゆｿ晏ｭ假ｼ域眠縺励＞繝√Ε繝・ヨ菴懈・譎ゅ↓菴ｿ逕ｨ・・                    if (characterValue) {
                        state.pendingCharacterName = characterValue;
                        console.log('Pending character name set to:', characterValue);
                        // 繝√Ε繝・ヨ繧ｿ繧､繝医Ν繧呈峩譁ｰ
                        uiUtils.updateChatTitle(`譁ｰ縺励＞繝√Ε繝・ヨ (${characterValue})`);
                    } else {
                        state.pendingCharacterName = null;
                        uiUtils.updateChatTitle('譁ｰ縺励＞繝√Ε繝・ヨ');
                    }
                    
                    // 繝√Ε繝・ヨ逕ｻ髱｢縺ｫ遘ｻ陦鯉ｼ医ユ繝ｼ繝槭・譌｢縺ｫcurrentChatTheme縺ｫ險ｭ螳壹＆繧後※縺・ｋ・・                    await this.showScreen('chat');
                } catch (error) {
                    console.error('繝励Ο繝ｳ繝励ヨ險ｭ螳壹お繝ｩ繝ｼ:', error);
                    await this.showCustomAlert('繝励Ο繝ｳ繝励ヨ險ｭ螳壻ｸｭ縺ｫ繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆縲・);
                }
            },
            setSendingState(sending) {
                state.isSending = sending;
                if (sending) {
                    elements.sendButton.textContent = '豁｢';
                    elements.sendButton.classList.add('sending');
                    elements.sendButton.title = "蛛懈ｭ｢";
                    elements.sendButton.disabled = false;
                    elements.userInput.disabled = true;
                    elements.attachFileBtn.disabled = true;
                    elements.pasteToInputBtn.disabled = true;
                    elements.rollDiceBtn.disabled = true;
                    if (elements.aiToAiChatBtn) elements.aiToAiChatBtn.disabled = true;
                    elements.loadingIndicator.classList.remove('hidden');
                    elements.loadingIndicator.setAttribute('aria-live', 'polite');
                } else {
                    elements.sendButton.textContent = '騾・;
                    elements.sendButton.classList.remove('sending');
                    elements.sendButton.title = "騾∽ｿ｡";
                    elements.userInput.disabled = false;
                    elements.attachFileBtn.disabled = false;
                    elements.pasteToInputBtn.disabled = false;
                    elements.rollDiceBtn.disabled = false;
                    if (elements.aiToAiChatBtn) {
                        const showAiToAiBtn = state.settings.enableSessionLinking &&
                                          state.linkedSessionIds.length === 2 &&
                                          state.currentChatId && state.linkedSessionIds.includes(state.currentChatId);
                        elements.aiToAiChatBtn.disabled = !showAiToAiBtn;
                    }
                    elements.loadingIndicator.classList.add('hidden');
                    elements.loadingIndicator.removeAttribute('aria-live');
                    this.adjustTextareaHeight();
                }
            },
            adjustTextareaHeight(textarea = elements.userInput, maxHeight = TEXTAREA_MAX_HEIGHT) {
                if (!textarea) return;
                textarea.style.height = 'auto';
                const scrollHeight = textarea.scrollHeight;
                textarea.style.height = Math.min(scrollHeight, maxHeight) + 'px';

                if (textarea === elements.userInput && !state.isSending) {
                    const isInputEmpty = textarea.value.trim() === '';
                    const hasAttachments = state.pendingAttachments.length > 0;
                    const isDummyProvider = state.settings.apiProvider === 'dummy';

                    if (isDummyProvider) {
                        elements.sendButton.disabled = false;
                    } else {
                        elements.sendButton.disabled = isInputEmpty && !hasAttachments;
                    }
                }
            },
            showCustomDialog(dialogElement, focusElement) {
                return new Promise((resolve) => {
                    const closeListener = () => {
                        dialogElement.removeEventListener('close', closeListener);
                        resolve(dialogElement.returnValue);
                    };
                    dialogElement.addEventListener('close', closeListener);
                    dialogElement.showModal();
                    if (focusElement) {
                        requestAnimationFrame(() => { focusElement.focus(); });
                    }
                });
            },
            async showCustomAlert(message) {
                elements.alertMessage.textContent = message;
                 const newOkBtn = elements.alertOkBtn.cloneNode(true);
                 elements.alertOkBtn.parentNode.replaceChild(newOkBtn, elements.alertOkBtn);
                 elements.alertOkBtn = newOkBtn;

                elements.alertOkBtn.onclick = () => elements.alertDialog.close('ok');
                await this.showCustomDialog(elements.alertDialog, elements.alertOkBtn);
            },
            async showCustomConfirm(message) {
                elements.confirmMessage.textContent = message;
                 const newOkBtn = elements.confirmOkBtn.cloneNode(true);
                 elements.confirmOkBtn.parentNode.replaceChild(newOkBtn, elements.confirmOkBtn);
                 elements.confirmOkBtn = newOkBtn;
                 const newCancelBtn = elements.confirmCancelBtn.cloneNode(true);
                 elements.confirmCancelBtn.parentNode.replaceChild(newCancelBtn, elements.confirmCancelBtn);
                 elements.confirmCancelBtn = newCancelBtn;

                elements.confirmOkBtn.onclick = () => elements.confirmDialog.close('ok');
                elements.confirmCancelBtn.onclick = () => elements.confirmDialog.close('cancel');
                const result = await this.showCustomDialog(elements.confirmDialog, elements.confirmOkBtn);
                return result === 'ok';
            },
            async showCustomPrompt(message, defaultValue = '') {
                elements.promptMessage.textContent = message;
                elements.promptInput.value = defaultValue;
                 const newOkBtn = elements.promptOkBtn.cloneNode(true);
                 elements.promptOkBtn.parentNode.replaceChild(newOkBtn, elements.promptOkBtn);
                 elements.promptOkBtn = newOkBtn;
                 const newCancelBtn = elements.promptCancelBtn.cloneNode(true);
                 elements.promptCancelBtn.parentNode.replaceChild(newCancelBtn, elements.promptCancelBtn);
                 elements.promptCancelBtn = newCancelBtn;
                 const newPromptInput = elements.promptInput.cloneNode(true);
                 elements.promptInput.parentNode.replaceChild(newPromptInput, elements.promptInput);
                 elements.promptInput = newPromptInput;

                const enterHandler = (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        elements.promptOkBtn.click();
                    }
                };
                elements.promptInput.addEventListener('keypress', enterHandler);

                elements.promptOkBtn.onclick = () => elements.promptDialog.close(elements.promptInput.value);
                elements.promptCancelBtn.onclick = () => elements.promptDialog.close('');

                const closeHandler = () => {
                    elements.promptInput.removeEventListener('keypress', enterHandler);
                    elements.promptDialog.removeEventListener('close', closeHandler);
                };
                 elements.promptDialog.addEventListener('close', closeHandler);

                const result = await this.showCustomDialog(elements.promptDialog, elements.promptInput);
                return result;
            },
            updateAttachmentBadgeVisibility() {
                const hasAttachments = state.pendingAttachments.length > 0;
                elements.attachFileBtn.classList.toggle('has-attachments', hasAttachments);
                if (!state.isSending) {
                    const isDummyProvider = state.settings.apiProvider === 'dummy';
                    if (isDummyProvider) {
                        elements.sendButton.disabled = false;
                    } else {
                        elements.sendButton.disabled = elements.userInput.value.trim() === '' && !hasAttachments;
                    }
                }
            },
            showFileUploadDialog() {
                if (state.pendingAttachments.length > 0) {
                    state.selectedFilesForUpload = state.pendingAttachments.map(att => ({ file: att.file }));
                } else {
                    state.selectedFilesForUpload = [];
                }
                this.updateSelectedFilesUI();
                elements.fileUploadDialog.showModal();
                this.updateAttachmentBadgeVisibility();
            },
            updateSelectedFilesUI() {
                elements.selectedFilesList.innerHTML = '';
                let totalSize = 0;
                state.selectedFilesForUpload.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.classList.add('selected-file-item');
                    li.dataset.fileIndex = index;

                    const infoDiv = document.createElement('div');
                    infoDiv.classList.add('selected-file-info');
                    const nameSpan = document.createElement('span');
                    nameSpan.classList.add('selected-file-name');
                    nameSpan.textContent = sanitizeText(item.file.name);
                    nameSpan.title = sanitizeText(item.file.name);
                    const sizeSpan = document.createElement('span');
                    sizeSpan.classList.add('selected-file-size');
                    sizeSpan.textContent = formatFileSize(item.file.size);
                    infoDiv.appendChild(nameSpan);
                    infoDiv.appendChild(sizeSpan);

                    const removeBtn = document.createElement('button');
                    removeBtn.classList.add('remove-file-btn');
                    removeBtn.title = '蜑企勁';
                    removeBtn.textContent = 'ﾃ・;
                    removeBtn.onclick = () => appLogic.removeSelectedFile(index);

                    li.appendChild(infoDiv);
                    li.appendChild(removeBtn);
                    elements.selectedFilesList.appendChild(li);
                    totalSize += item.file.size;
                });

                if (totalSize > MAX_TOTAL_ATTACHMENT_SIZE) {
                    elements.confirmAttachBtn.disabled = true;
                } else {
                    elements.confirmAttachBtn.disabled = false;
                }
                if (state.selectedFilesForUpload.length === 0) {
                     elements.confirmAttachBtn.disabled = true;
                }
            },
            updateToggleAllContentButton() {
                if (elements.toggleAllContentBtn) {
                    if (state.areAllMessagesHidden) {
                        elements.toggleAllContentBtn.setAttribute('aria-label', "蜈ｨ繝｡繝・そ繝ｼ繧ｸ繧定｡ｨ遉ｺ");
                        elements.toggleAllContentBtn.title = "蜈ｨ繝｡繝・そ繝ｼ繧ｸ繧定｡ｨ遉ｺ";
                    } else {
                        elements.toggleAllContentBtn.setAttribute('aria-label', "蜈ｨ繝｡繝・そ繝ｼ繧ｸ繧帝撼陦ｨ遉ｺ");
                        elements.toggleAllContentBtn.title = "蜈ｨ繝｡繝・そ繝ｼ繧ｸ繧帝撼陦ｨ遉ｺ";
                    }
                }
            },
            processInteractiveTitles(contentElement) {
                const links = contentElement.querySelectorAll('a[href="#"]');
                links.forEach(link => {
                    if (link.dataset.interactiveTitleProcessed === 'true' || link.dataset.interactivePlaceholderProcessed === 'true') {
                        return;
                    }

                    const titleText = sanitizeText(link.getAttribute('title'));
                    if (titleText && titleText.trim() !== '') {
                        link.dataset.interactiveTitleProcessed = 'true';

                        let spanToToggle = link.nextElementSibling;
                        if (!spanToToggle ||
                            !spanToToggle.classList.contains('interactive-title-content') ||
                            spanToToggle.textContent !== ` (# "${titleText}")`) {

                            if (spanToToggle && spanToToggle.classList.contains('interactive-title-content')) {
                                spanToToggle.remove();
                            }

                            spanToToggle = document.createElement('span');
                            spanToToggle.classList.add('interactive-title-content', 'interactive-title-content-style');
                            spanToToggle.textContent = ` (# "${titleText}")`;
                            spanToToggle.classList.add('hidden');
                            link.insertAdjacentElement('afterend', spanToToggle);
                            link.setAttribute('aria-expanded', 'false');
                        } else {
                            const isExpanded = link.getAttribute('aria-expanded') === 'true';
                            spanToToggle.classList.toggle('hidden', !isExpanded);
                        }

                        link.addEventListener('click', function(event) {
                            event.preventDefault();
                            const isCurrentlyHidden = spanToToggle.classList.contains('hidden');
                            spanToToggle.classList.toggle('hidden', !isCurrentlyHidden);
                            this.setAttribute('aria-expanded', String(!isCurrentlyHidden));
                        });
                        link.style.cursor = 'pointer';
                    }
                });
            },
            processInteractivePlaceholders(contentElement) {
                const placeholderRegex = /(.*?)?\s*\(#\s*"([^"]+)"\)/g;

                const walker = document.createTreeWalker(contentElement, NodeFilter.SHOW_TEXT, null, false);
                const nodesToProcess = [];
                let node;
                while (node = walker.nextNode()) {
                    let parent = node.parentNode;
                    let skip = false;
                    while (parent && parent !== contentElement) {
                        if (['A', 'PRE', 'CODE', 'BUTTON'].includes(parent.tagName) || parent.isContentEditable) {
                            skip = true;
                            break;
                        }
                        parent = parent.parentNode;
                    }
                    if (!skip && node.nodeValue && node.nodeValue.includes('(# "')) {
                        nodesToProcess.push(node);
                    }
                }

                for (const textNode of nodesToProcess) {
                    const textContent = textNode.nodeValue;
                    let match;
                    let lastIndex = 0;
                    const fragment = document.createDocumentFragment();
                    let replacementNeeded = false;

                    placeholderRegex.lastIndex = 0;

                    while ((match = placeholderRegex.exec(textContent)) !== null) {
                        replacementNeeded = true;
                        const precedingText = textContent.substring(lastIndex, match.index);
                        if (precedingText) {
                            fragment.appendChild(document.createTextNode(precedingText));
                        }

                        const leadingTextContent = sanitizeText(match[1] || "").trim();
                        const clickableTextDisplay = leadingTextContent || "隧ｳ邏ｰ";
                        const detailText = sanitizeText(match[2]);

                        const link = document.createElement('a');
                        link.href = "#";
                        link.textContent = clickableTextDisplay;
                        link.title = detailText;
                        link.style.cursor = 'pointer';
                        link.dataset.interactivePlaceholderProcessed = 'true';

                        const detailSpan = document.createElement('span');
                        detailSpan.classList.add('interactive-title-content-style', 'hidden');
                        detailSpan.textContent = ` (# "${detailText}")`;

                        link.setAttribute('aria-expanded', 'false');
                        link.addEventListener('click', function(event) {
                            event.preventDefault();
                            event.stopPropagation();
                            const isCurrentlyHidden = detailSpan.classList.contains('hidden');
                            detailSpan.classList.toggle('hidden', !isCurrentlyHidden);
                            this.setAttribute('aria-expanded', String(!isCurrentlyHidden));
                        });

                        fragment.appendChild(link);
                        fragment.appendChild(detailSpan);

                        lastIndex = placeholderRegex.lastIndex;
                    }

                    if (replacementNeeded) {
                        if (lastIndex < textContent.length) {
                            fragment.appendChild(document.createTextNode(textContent.substring(lastIndex)));
                        }
                        textNode.parentNode.replaceChild(fragment, textNode);
                    }
                }
            },
            setAiToAiProcessingState(processing, message = "AI髢謎ｼ夊ｩｱ蜃ｦ逅・ｸｭ...") {
                state.isAiToAiChatProcessing = processing;

                if (processing) {
                    elements.loadingIndicator.textContent = message;
                    elements.loadingIndicator.classList.remove('hidden');
                    elements.loadingIndicator.setAttribute('aria-live', 'assertive');

                    elements.sendButton.disabled = true;
                    elements.userInput.disabled = true;
                    elements.attachFileBtn.disabled = true;
                    elements.pasteToInputBtn.disabled = true;
                    elements.rollDiceBtn.disabled = true;
                    if (elements.aiToAiChatBtn) elements.aiToAiChatBtn.disabled = true;
                } else {
                    elements.loadingIndicator.textContent = '蠢懃ｭ比ｸｭ';
                    elements.loadingIndicator.classList.add('hidden');
                    elements.loadingIndicator.setAttribute('aria-live', 'polite');

                    elements.sendButton.disabled = elements.userInput.value.trim() === '' && state.pendingAttachments.length === 0;
                    elements.userInput.disabled = false;
                    elements.attachFileBtn.disabled = false;
                    elements.pasteToInputBtn.disabled = false;
                    elements.rollDiceBtn.disabled = false;
                    if (elements.aiToAiChatBtn) {
                        const showAiToAiBtn = state.settings.enableSessionLinking &&
                                          state.linkedSessionIds.length === 2 &&
                                          state.currentChatId && state.linkedSessionIds.includes(state.currentChatId);
                        elements.aiToAiChatBtn.disabled = !showAiToAiBtn;
                    }
                }
            },
            updateSessionLinkingUI() {
                this.renderHistoryList();
                this.updateChatScreenElementVisibility();
            },
            updateApiProviderSelectOptions() {
                const apiProviderSelect = elements.apiProviderSelect;
                if (!apiProviderSelect) return;

                const allProviderOptions = [
                    { value: 'gemini', text: 'Gemini (Google)' },
                    { value: 'deepseek', text: 'DeepSeek' },
                    { value: 'claude', text: 'Claude (Anthropic API)' },
                    { value: 'openai', text: 'ChatGPT (OpenAI API)' },
                    { value: 'xai', text: 'Grok (xAI API)' },
                    { value: 'llmaggregator', text: 'LLM Aggregator' },
                    { value: 'dummy', text: 'Dummy AI' }
                ];

                const currentValue = apiProviderSelect.value;
                apiProviderSelect.innerHTML = '';

                const cycleSettings = state.settings.apiProviderCycle;
                const enabledOptions = allProviderOptions.filter(option => 
                    cycleSettings[option.value] === true
                );

                enabledOptions.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.text;
                    apiProviderSelect.appendChild(optionElement);
                });

                if (enabledOptions.some(option => option.value === currentValue)) {
                    apiProviderSelect.value = currentValue;
                } else if (enabledOptions.length > 0) {
                    const newProvider = enabledOptions[0].value;
                    state.settings.apiProvider = newProvider;
                    apiProviderSelect.value = newProvider;
                    this.toggleApiSettingsVisibility(newProvider);
                }

                if (enabledOptions.length === 0) {
                    const warningOption = document.createElement('option');
                    warningOption.value = '';
                    warningOption.textContent = '譛牙柑縺ｪAPI繝励Ο繝舌う繝繝ｼ縺後≠繧翫∪縺帙ｓ';
                    warningOption.disabled = true;
                    apiProviderSelect.appendChild(warningOption);
                    apiProviderSelect.value = '';
                }
            },
            addImageClickListeners(contentElement) {
                if (!contentElement) return;
                contentElement.querySelectorAll('img').forEach(img => {
                    const newImg = img.cloneNode(true);
                    img.parentNode.replaceChild(newImg, img);

                    newImg.addEventListener('click', (e) => {
                        e.preventDefault();
                        window.open(newImg.src, '_blank', 'noopener,noreferrer');
                    });
                });
            },
            toggleMultiApiKeysVisibility(show) {
                const providers = ['gemini', 'deepseek', 'claude', 'openai', 'xai', 'llmaggregator'];
                
                providers.forEach(provider => {
                    const multiKeySection = document.getElementById(`${provider}-multi-api-keys-section`);
                    if (multiKeySection) {
                        multiKeySection.classList.toggle('hidden', !show);
                    }

                    const singleKeyInputId = provider === 'gemini' ? 'gemini-api-key' : `${provider}-api-key`;
                    const singleKeyInput = document.getElementById(singleKeyInputId);
                    
                    if (singleKeyInput) {
                        const label = singleKeyInput.previousElementSibling;
                        if (label?.tagName === 'LABEL' && label.htmlFor === singleKeyInputId) {
                            label.classList.toggle('hidden', show);
                        }
                        singleKeyInput.classList.toggle('hidden', show);

                        if (!show) {
                            let singleKeyValue = '';
                            switch(provider) {
                                case 'gemini': singleKeyValue = state.settings.apiKey; break;
                                case 'deepseek': singleKeyValue = state.settings.deepSeekApiKey; break;
                                case 'claude': singleKeyValue = state.settings.claudeApiKey; break;
                                case 'openai': singleKeyValue = state.settings.openaiApiKey; break;
                                case 'xai': singleKeyValue = state.settings.xaiApiKey; break;
                                case 'llmaggregator': singleKeyValue = state.settings.llmAggregatorApiKey; break;
                            }
                            singleKeyInput.value = singleKeyValue || '';
                        }
                    }
                });
            },
        };

        // IndexedDB菴ｿ逕ｨ蜿ｯ閭ｽ諤ｧ讀懷・
        async function detectIndexedDbAvailable() {
            try {
                const db = await new Promise((res, rej) => {
                    const req = indexedDB.open('_probe_', 1);
                    req.onupgradeneeded = () => req.result.createObjectStore('s');
                    req.onsuccess = () => res(req.result);
                    req.onerror = () => rej(req.error);
                });
                db.close();
                indexedDB.deleteDatabase('_probe_');
                return true;
            } catch {
                return false;
            }
        }

        const appLogic = {
            async initializeApp() {
                if (typeof marked !== 'undefined') {
                    marked.setOptions({
                        breaks: true,
                        gfm: true,
                        sanitize: false,
                        smartypants: false
                    });
                }
                if (typeof mermaid !== 'undefined') {
                    mermaid.initialize({
                        startOnLoad: false,
                        theme: 'default',
                        securityLevel: 'loose',
                        fontFamily: 'var(--font-family)',
                        flowchart: { useMaxWidth: true, htmlLabels: true },
                        sequence: { useMaxWidth: true },
                        gantt: { useMaxWidth: true },
                        journey: { useMaxWidth: true },
                        pie: { useMaxWidth: true }
                    });
                }

                elements.appVersionSpan.textContent = APP_VERSION;

                window.addEventListener('beforeinstallprompt', (event) => {
                    event.preventDefault();
                });

                // 蛻晄悄逕ｻ髱｢險ｭ螳壹・initializeApp()縺ｮ譛蠕後〒陦後≧縺溘ａ縺薙％縺ｧ縺ｯ螳溯｡後＠縺ｪ縺・                registerServiceWorker();

                try {
                    await dbUtils.openDB();
                    await dbUtils.loadSettings();
                    
                    // 蛻晄悄繝ｭ繝ｼ繝画凾繧ら判髱｢縺ｮ迥ｶ諷九↓蠢懊§縺溘ユ繝ｼ繝槭ｒ驕ｩ逕ｨ
                    if (state.currentScreen === 'prompt-setup' && state.promptTempTheme) {
                        uiUtils.applyTheme(state.promptTempTheme);
                    } else if (state.currentChatTheme) {
                        uiUtils.applyTheme(state.currentChatTheme);
                    } else {
                        uiUtils.applyTheme();
                    }
                    uiUtils.applyFontFamily();
                    uiUtils.applySidePanelSettingsToUI();
    
                    if (state.settings.backgroundImageBlob) {
                        uiUtils.revokeExistingObjectUrl();
                        try {
                            const blob = convertArrayBufferToBlob(state.settings.backgroundImageBlob);
                            if (blob && blob.size > 0) {
                                state.backgroundImageUrl = URL.createObjectURL(blob);
                                document.documentElement.style.setProperty('--chat-background-image', `url(${state.backgroundImageUrl})`);
                            } else {
                                if (blob && blob.size === 0) {
                                    console.warn('Background image blob is empty');
                                }
                                document.documentElement.style.setProperty('--chat-background-image', 'none');
                            }
                        } catch (e) {
                             console.error('Failed to create background image URL:', e);
                             document.documentElement.style.setProperty('--chat-background-image', 'none');
                        }
                    } else {
                        document.documentElement.style.setProperty('--chat-background-image', 'none');
                    }
                    if (state.settings.userIconBlob) {
                        try {
                            const blob = convertArrayBufferToBlob(state.settings.userIconBlob);
                            if (blob && blob.size > 0) {
                                state.userIconUrl = URL.createObjectURL(blob);
                            }
                        } catch (e) {
                            console.error('Failed to create user icon URL:', e);
                        }
                    }
                    if (state.settings.aiIconBlob) {
                        try {
                            const blob = convertArrayBufferToBlob(state.settings.aiIconBlob);
                            if (blob && blob.size > 0) {
                                state.aiIconUrl = URL.createObjectURL(blob);
                            }
                        } catch (e) {
                            console.error('Failed to create AI icon URL:', e);
                        }
                    }
    
                    // 繧､繝吶Φ繝医Μ繧ｹ繝翫・繧呈怙蛻昴↓險ｭ螳・                    this.setupEventListeners();
                    
                    // 全画面を一旦非アクティブ化
                    const allScreens = [elements.homeScreen, elements.chatScreen, elements.historyScreen, elements.promptSetupScreen, elements.settingsScreen];
                    allScreens.forEach(screen => {
                        if (screen) {
                            screen.classList.remove('active');
                            screen.classList.add('fade-transition', 'fade-out');
                            screen.style.transform = 'translateX(0) translateY(0)';
                        }
                    });
                    
                    state.currentScreen = null;
                    
                    
                    // IndexedDB菴ｿ逕ｨ蜿ｯ閭ｽ諤ｧ繧呈､懷・
                    state.env = state.env || {};
                    state.env.idbUsable = await detectIndexedDbAvailable();
                    if (!state.env.idbUsable) {
                        console.warn('IndexedDB is not available. Asset saving will be disabled.');
                        await uiUtils.showCustomAlert('繝励Λ繧､繝吶・繝医ヶ繝ｩ繧ｦ繧ｺ繝｢繝ｼ繝峨∪縺溘・IndexedDB縺御ｽｿ逕ｨ縺ｧ縺阪↑縺・腸蠅・〒縺吶・n逕ｻ蜒上い繧ｻ繝・ヨ縺ｮ菫晏ｭ倥′辟｡蜉ｹ蛹悶＆繧後∪縺吶・);
                        // 繧｢繧ｻ繝・ヨ菫晏ｭ倡ｳｻUI繧堤┌蜉ｹ蛹悶☆繧句ｴ蜷医・縺薙％縺ｧ螳溯｣・                    }
                    
                    
                    uiUtils.applySettingsToUI();
    
                    // 繝√Ε繝・ヨ螻･豁ｴ縺後≠繧後・譛蠕後↓譖ｴ譁ｰ縺励◆繝√Ε繝・ヨ繧定ｪｭ縺ｿ霎ｼ繧薙〒繝√Ε繝・ヨ逕ｻ髱｢縺ｫ驕ｷ遘ｻ
                    const chats = await dbUtils.getAllChats(state.settings.historySortOrder);
                    let initialScreen = 'home';
                    
                    if (chats && chats.length > 0) {
                        // 最後に更新したチャット（chats[0]）を読み込んでチャット画面を準備
                        await this.loadChat(chats[0].id);
                        initialScreen = 'chat';
                        console.log('Last updated chat loaded; preparing chat screen');
                    } else {
                        // チャット履歴がない場合は新規チャットを準備してホーム画面を待機
                        this.startNewChat();
                        console.log('No chats found, preparing home screen');
                    }
                    
                    history.replaceState({ screen: initialScreen }, '', `#${initialScreen}`);
                    await uiUtils.showScreen(initialScreen, true);
                    console.log(`${initialScreen === 'chat' ? 'Chat' : 'Home'} screen shown without initial flicker`);
                    
                    
                    updateMessageMaxWidthVar();
                    this.updateZoomState();
                    uiUtils.adjustTextareaHeight();
                    uiUtils.setSendingState(false);
                    
                    if (state.settings.autoScrollOnNewMessage) {
                        uiUtils.scrollToBottom();
                    }

                } catch (error) {
                    await uiUtils.showCustomAlert(`繧｢繝励Μ縺ｮ蛻晄悄蛹悶↓螟ｱ謨励＠縺ｾ縺励◆: ${error}`);
                    elements.appContainer.innerHTML = `<p style="padding: 20px; text-align: center; color: red;">繧｢繝励Μ縺ｮ襍ｷ蜍輔↓螟ｱ謨励＠縺ｾ縺励◆縲・/p>`;
                } 
            },
            setupEventListeners() {
                elements.gotoHistoryBtn.addEventListener('click', async () => await uiUtils.showScreen('history'));
                elements.gotoSettingsBtn.addEventListener('click', async () => await uiUtils.showScreen('settings'));
                if (elements.homeGotoSettingsBtn) {
                    elements.homeGotoSettingsBtn.addEventListener('click', async () => await uiUtils.showScreen('settings'));
                }
                if (elements.gotoHomeBtn) {
                    elements.gotoHomeBtn.addEventListener('click', async () => {
                        console.log('Home button clicked');
                        await uiUtils.showScreen('home');
                    });
                } else {
                    console.error('gotoHomeBtn element not found');
                }
                if (elements.startChatBtn) {
                    elements.startChatBtn.addEventListener('click', async () => {
                        console.log('Start chat button clicked');
                        await uiUtils.showScreen('prompt-setup');
                    });
                } else {
                    console.error('startChatBtn element not found');
                }
                if (elements.selectHistoryBtn) {
                    elements.selectHistoryBtn.addEventListener('click', async () => {
                        console.log('Select history button clicked');
                        await uiUtils.showScreen('history');
                    });
                } else {
                    console.error('selectHistoryBtn element not found');
                }
                elements.backToChatFromHistoryBtn.addEventListener('click', () => history.back());
                elements.backToChatFromSettingsBtn.addEventListener('click', () => history.back());
                elements.backToHomeFromPromptSetupBtn.addEventListener('click', () => {
                    // 繝励Ο繝ｳ繝励ヨ險ｭ螳夂判髱｢縺九ｉ謌ｻ繧区凾縺ｯ縲∝・縺ｮ繝√Ε繝・ヨID繧貞ｾｩ蜈・                    if (state.beforePromptScreenChatId !== undefined) {
                        state.currentChatId = state.beforePromptScreenChatId;
                        state.beforePromptScreenChatId = undefined;
                    }
                    
                    // 荳譎ゅユ繝ｼ繝槭ｒ繧ｯ繝ｪ繧｢
                    if (state.promptTempTheme) {
                        state.promptTempTheme = null;
                    }
                    
                    history.back();
                });
                elements.startChatWithPromptBtn.addEventListener('click', () => uiUtils.startChatWithPrompt());
                if (elements.characterSelect) {
                    elements.characterSelect.addEventListener('change', async () => {
                        const selectedValue = elements.characterSelect.value;
                        await uiUtils.loadCharacterPrompt(selectedValue);
                    });
                }
                
                // 繝励Ο繝ｳ繝励ヨ逕ｻ髱｢縺ｮAPI繝励Ο繝舌う繝繝ｼ險ｭ螳・                if (elements.promptApiProviderSelect) {
                    elements.promptApiProviderSelect.addEventListener('change', (event) => {
                        const selectedProvider = event.target.value;
                        state.settings.apiProvider = selectedProvider;
                        
                        // 繝励Ο繝ｳ繝励ヨ逕ｻ髱｢逕ｨ縺ｮAPI繝励Ο繝舌う繝繝ｼ陦ｨ遉ｺ蛻・ｊ譖ｿ縺・                        const promptProviderSettings = {
                            'gemini': elements.promptGeminiSettings,
                            'deepseek': elements.promptDeepseekSettings,
                            'claude': elements.promptClaudeSettings,
                            'openai': elements.promptOpenaiSettings,
                            'xai': elements.promptXaiSettings,
                            'llmaggregator': elements.promptLlmaggregatorSettings
                        };
                        
                        Object.keys(promptProviderSettings).forEach(provider => {
                            if (promptProviderSettings[provider]) {
                                promptProviderSettings[provider].classList.toggle('hidden', provider !== selectedProvider);
                            }
                        });
                        
                        // Gemini API繧ｭ繝ｼ蜿門ｾ励Μ繝ｳ繧ｯ縺ｮ陦ｨ遉ｺ蛻ｶ蠕｡
                        const geminiApiKeyLink = document.getElementById('gemini-api-key-link');
                        if (geminiApiKeyLink) {
                            geminiApiKeyLink.style.display = selectedProvider === 'gemini' ? 'block' : 'none';
                        }
                        
                        // 險ｭ螳夂判髱｢縺ｮAPI繝励Ο繝舌う繝繝ｼ繧ょ酔譛・                        if (elements.apiProviderSelect) {
                            elements.apiProviderSelect.value = selectedProvider;
                        }
                        uiUtils.toggleApiSettingsVisibility(selectedProvider);
                    });
                }
                
                // 繝励Ο繝ｳ繝励ヨ逕ｻ髱｢縺ｮAPI繧ｭ繝ｼ蜈･蜉帙う繝吶Φ繝医Μ繧ｹ繝翫・
                if (elements.promptGeminiApiKeyInput) {
                    elements.promptGeminiApiKeyInput.addEventListener('input', async () => {
                        state.settings.apiKey = elements.promptGeminiApiKeyInput.value;
                        elements.geminiApiKeyInput.value = elements.promptGeminiApiKeyInput.value;
                        await appLogic.saveSettings(false);
                    });
                }
                if (elements.promptDeepseekApiKeyInput) {
                    elements.promptDeepseekApiKeyInput.addEventListener('input', async () => {
                        state.settings.deepSeekApiKey = elements.promptDeepseekApiKeyInput.value;
                        elements.deepSeekApiKeyInput.value = elements.promptDeepseekApiKeyInput.value;
                        await appLogic.saveSettings(false);
                    });
                }
                if (elements.promptClaudeApiKeyInput) {
                    elements.promptClaudeApiKeyInput.addEventListener('input', async () => {
                        state.settings.claudeApiKey = elements.promptClaudeApiKeyInput.value;
                        elements.claudeApiKeyInput.value = elements.promptClaudeApiKeyInput.value;
                        await appLogic.saveSettings(false);
                    });
                }
                if (elements.promptOpenaiApiKeyInput) {
                    elements.promptOpenaiApiKeyInput.addEventListener('input', async () => {
                        state.settings.openaiApiKey = elements.promptOpenaiApiKeyInput.value;
                        elements.openaiApiKeyInput.value = elements.promptOpenaiApiKeyInput.value;
                        await appLogic.saveSettings(false);
                    });
                }
                if (elements.promptXaiApiKeyInput) {
                    elements.promptXaiApiKeyInput.addEventListener('input', async () => {
                        state.settings.xaiApiKey = elements.promptXaiApiKeyInput.value;
                        elements.xaiApiKeyInput.value = elements.promptXaiApiKeyInput.value;
                        await appLogic.saveSettings(false);
                    });
                }
                if (elements.promptLlmaggregatorApiKeyInput) {
                    elements.promptLlmaggregatorApiKeyInput.addEventListener('input', async () => {
                        state.settings.llmAggregatorApiKey = elements.promptLlmaggregatorApiKeyInput.value;
                        elements.llmAggregatorApiKeyInput.value = elements.promptLlmaggregatorApiKeyInput.value;
                        await appLogic.saveSettings(false);
                    });
                }
                if (elements.promptLlmaggregatorApiBackendInput) {
                    elements.promptLlmaggregatorApiBackendInput.addEventListener('input', async () => {
                        state.settings.llmAggregatorApiBackend = elements.promptLlmaggregatorApiBackendInput.value;
                        elements.llmAggregatorApiBackendInput.value = elements.promptLlmaggregatorApiBackendInput.value;
                        await appLogic.saveSettings(false);
                    });
                }
                
                // 繝励Ο繝ｳ繝励ヨ逕ｻ髱｢縺ｮ繝｢繝・Ν蜷阪う繝吶Φ繝医Μ繧ｹ繝翫・
                if (elements.promptGeminiModelNameSelect) {
                    elements.promptGeminiModelNameSelect.addEventListener('change', async () => {
                        state.settings.modelName = elements.promptGeminiModelNameSelect.value;
                        elements.geminiModelNameSelect.value = elements.promptGeminiModelNameSelect.value;
                        await appLogic.saveSettings(false);
                    });
                }
                if (elements.promptDeepseekModelNameSelect) {
                    elements.promptDeepseekModelNameSelect.addEventListener('change', async () => {
                        state.settings.deepSeekModelName = elements.promptDeepseekModelNameSelect.value;
                        elements.deepSeekModelNameSelect.value = elements.promptDeepseekModelNameSelect.value;
                        await appLogic.saveSettings(false);
                    });
                }
                if (elements.promptClaudeModelNameSelect) {
                    elements.promptClaudeModelNameSelect.addEventListener('change', async () => {
                        state.settings.claudeModelName = elements.promptClaudeModelNameSelect.value;
                        elements.claudeModelNameSelect.value = elements.promptClaudeModelNameSelect.value;
                        await appLogic.saveSettings(false);
                    });
                }
                if (elements.promptOpenaiModelNameSelect) {
                    elements.promptOpenaiModelNameSelect.addEventListener('change', async () => {
                        state.settings.openaiModelName = elements.promptOpenaiModelNameSelect.value;
                        elements.openaiModelNameSelect.value = elements.promptOpenaiModelNameSelect.value;
                        await appLogic.saveSettings(false);
                    });
                }
                if (elements.promptXaiModelNameSelect) {
                    elements.promptXaiModelNameSelect.addEventListener('change', async () => {
                        state.settings.xaiModelName = elements.promptXaiModelNameSelect.value;
                        elements.xaiModelNameSelect.value = elements.promptXaiModelNameSelect.value;
                        await appLogic.saveSettings(false);
                    });
                }
                if (elements.promptLlmaggregatorModelNameSelect) {
                    elements.promptLlmaggregatorModelNameSelect.addEventListener('change', async () => {
                        state.settings.llmAggregatorModelName = elements.promptLlmaggregatorModelNameSelect.value;
                        elements.llmAggregatorModelNameSelect.value = elements.promptLlmaggregatorModelNameSelect.value;
                        await appLogic.saveSettings(false);
                    });
                }
                
                // 繝励Ο繝ｳ繝励ヨ逕ｻ髱｢縺ｮ霑ｽ蜉繝｢繝・Ν繧､繝吶Φ繝医Μ繧ｹ繝翫・
                if (elements.promptGeminiAdditionalModelsTextarea) {
                    elements.promptGeminiAdditionalModelsTextarea.addEventListener('input', async () => {
                        state.settings.additionalModels = elements.promptGeminiAdditionalModelsTextarea.value;
                        elements.geminiAdditionalModelsTextarea.value = elements.promptGeminiAdditionalModelsTextarea.value;
                        await appLogic.saveSettings(false);
                    });
                }
                if (elements.promptDeepseekAdditionalModelsTextarea) {
                    elements.promptDeepseekAdditionalModelsTextarea.addEventListener('input', async () => {
                        state.settings.deepSeekAdditionalModels = elements.promptDeepseekAdditionalModelsTextarea.value;
                        elements.deepSeekAdditionalModelsTextarea.value = elements.promptDeepseekAdditionalModelsTextarea.value;
                        await appLogic.saveSettings(false);
                    });
                }
                if (elements.promptClaudeAdditionalModelsTextarea) {
                    elements.promptClaudeAdditionalModelsTextarea.addEventListener('input', async () => {
                        state.settings.claudeAdditionalModels = elements.promptClaudeAdditionalModelsTextarea.value;
                        elements.claudeAdditionalModelsTextarea.value = elements.promptClaudeAdditionalModelsTextarea.value;
                        await appLogic.saveSettings(false);
                    });
                }
                if (elements.promptOpenaiAdditionalModelsTextarea) {
                    elements.promptOpenaiAdditionalModelsTextarea.addEventListener('input', async () => {
                        state.settings.openaiAdditionalModels = elements.promptOpenaiAdditionalModelsTextarea.value;
                        elements.openaiAdditionalModelsTextarea.value = elements.promptOpenaiAdditionalModelsTextarea.value;
                        await appLogic.saveSettings(false);
                    });
                }
                if (elements.promptXaiAdditionalModelsTextarea) {
                    elements.promptXaiAdditionalModelsTextarea.addEventListener('input', async () => {
                        state.settings.xaiAdditionalModels = elements.promptXaiAdditionalModelsTextarea.value;
                        elements.xaiAdditionalModelsTextarea.value = elements.promptXaiAdditionalModelsTextarea.value;
                        await appLogic.saveSettings(false);
                    });
                }
                if (elements.promptLlmaggregatorAdditionalModelsTextarea) {
                    elements.promptLlmaggregatorAdditionalModelsTextarea.addEventListener('input', async () => {
                        state.settings.llmAggregatorAdditionalModels = elements.promptLlmaggregatorAdditionalModelsTextarea.value;
                        elements.llmAggregatorAdditionalModelsTextarea.value = elements.promptLlmaggregatorAdditionalModelsTextarea.value;
                        await appLogic.saveSettings(false);
                    });
                }
                
                if (elements.userRelationshipSelect) {
                    elements.userRelationshipSelect.addEventListener('change', () => uiUtils.updatePromptPreview());
                }
                
                if (elements.chatModeSelect) {
                    elements.chatModeSelect.addEventListener('change', async () => {
                        state.settings.chatMode = elements.chatModeSelect.value;
                        await appLogic.saveSettings(false);
                        uiUtils.updatePromptPreview();
                    });
                }
                
                // 諢滓ュ逕ｻ蜒酋RL蜈･蜉帙ヵ繧｣繝ｼ繝ｫ繝峨・繧､繝吶Φ繝医Μ繧ｹ繝翫・
                if (elements.emotionUrlNormal) {
                    elements.emotionUrlNormal.addEventListener('input', () => uiUtils.updatePromptPreview());
                }
                if (elements.emotionUrlHappy) {
                    elements.emotionUrlHappy.addEventListener('input', () => uiUtils.updatePromptPreview());
                }
                if (elements.emotionUrlFun) {
                    elements.emotionUrlFun.addEventListener('input', () => uiUtils.updatePromptPreview());
                }
                if (elements.emotionUrlSad) {
                    elements.emotionUrlSad.addEventListener('input', () => uiUtils.updatePromptPreview());
                }
                if (elements.emotionUrlAngry) {
                    elements.emotionUrlAngry.addEventListener('input', () => uiUtils.updatePromptPreview());
                }
                
                if (elements.promptThemeSelect) {
                    elements.promptThemeSelect.addEventListener('change', () => {
                        const selectedTheme = elements.promptThemeSelect.value;
                        state.promptTempTheme = selectedTheme || null;
                        if (selectedTheme) {
                            // 繝励Ξ繝薙Η繝ｼ逕ｨ縺ｫ荳譎ら噪縺ｫ繝・・繝槭ｒ驕ｩ逕ｨ
                            uiUtils.applyTheme(selectedTheme);
                            uiUtils.applySidePanelSettingsToUI();
                        } else {
                            // 繝・ヵ繧ｩ繝ｫ繝医ユ繝ｼ繝槭ｒ驕ｩ逕ｨ
                            uiUtils.applyTheme(state.settings.theme);
                            uiUtils.applySidePanelSettingsToUI();
                        }
                    });
                }
                if (elements.promptSetupSystemPrompt) {
                    elements.promptSetupSystemPrompt.addEventListener('input', () => uiUtils.updatePromptPreview());
                }
                if (elements.userNameInput) {
                    elements.userNameInput.addEventListener('input', async () => {
                        state.settings.userName = elements.userNameInput.value.trim();
                        await appLogic.saveSettings(false);
                        uiUtils.updatePromptPreview();
                    });
                }
                
                if (elements.promptAiNameInput) {
                    elements.promptAiNameInput.addEventListener('input', () => {
                        uiUtils.updatePromptPreview();
                    });
                }
                
                if (elements.showAiIconCheckbox) {
                    elements.showAiIconCheckbox.addEventListener('change', () => {
                        uiUtils.updatePromptPreview();
                    });
                }
                
                if (elements.showAiNameCheckbox) {
                    elements.showAiNameCheckbox.addEventListener('change', () => {
                        uiUtils.updatePromptPreview();
                    });
                }
                
                // 繝励Ο繝ｳ繝励ヨ繝励Ξ繝薙Η繝ｼ縺ｮ邱ｨ髮・う繝吶Φ繝・                if (elements.promptPreview) {
                    elements.promptPreview.addEventListener('input', () => {
                        // 繝励Ξ繝薙Η繝ｼ縺檎ｷｨ髮・＆繧後◆縺薙→繧堤､ｺ縺吶ヵ繝ｩ繧ｰ繧定ｨｭ螳・                        state.promptPreviewEdited = true;
                        // 鬮倥＆繧定・蜍戊ｪｿ謨ｴ
                        uiUtils.adjustTextareaHeight(elements.promptPreview, 400);
                    });
                }
                
                // 繝励Ο繝ｳ繝励ヨ菴懈・逕ｻ髱｢縺ｮAI繧｢繧､繧ｳ繝ｳ繧｢繝・・繝ｭ繝ｼ繝・                if (elements.promptUploadAiIconBtn) {
                    elements.promptUploadAiIconBtn.addEventListener('click', () => {
                        elements.promptAiIconInput.click();
                    });
                }
                
                if (elements.promptAiIconInput) {
                    elements.promptAiIconInput.addEventListener('change', async (event) => {
                        await uiUtils.handlePromptAiIconUpload(event);
                    });
                }
                
                if (elements.promptDeleteAiIconBtn) {
                    elements.promptDeleteAiIconBtn.addEventListener('click', async () => {
                        await uiUtils.deletePromptAiIcon();
                    });
                }
                
                // 繝励Ο繝ｳ繝励ヨ菴懈・逕ｻ髱｢縺ｮ閭梧勹逕ｻ蜒上い繝・・繝ｭ繝ｼ繝・                if (elements.promptUploadBackgroundBtn) {
                    elements.promptUploadBackgroundBtn.addEventListener('click', () => {
                        elements.promptBackgroundImageInput.click();
                    });
                }
                
                if (elements.promptBackgroundImageInput) {
                    elements.promptBackgroundImageInput.addEventListener('change', async (event) => {
                        const file = event.target.files[0];
                        if (file) await this.handleBackgroundImageUpload(file);
                        event.target.value = null;
                    });
                }
                
                if (elements.promptDeleteBackgroundBtn) {
                    elements.promptDeleteBackgroundBtn.addEventListener('click', async () => {
                        await this.confirmDeleteBackgroundImage();
                    });
                }
                
                elements.toggleMemoBtn.addEventListener('click', () => this.toggleMemo());
                elements.copyMemoBtn.addEventListener('click', () => this.copyMemoText());
                elements.pasteMemoBtn.addEventListener('click', () => this.pasteIntoMemo());
                elements.deleteMemoBtn.addEventListener('click', () => this.confirmClearMemo());

                elements.toggleClipboardStackBtn.addEventListener('click', () => this.toggleClipboardStack());
                elements.deleteClipboardStackBtn.addEventListener('click', () => this.confirmClearClipboardStack());
                elements.copyClipboardStackBtn.addEventListener('click', () => this.copyClipboardStackText());
                elements.pasteClipboardStackBtn.addEventListener('click', () => this.pasteIntoClipboardStack());

                elements.scrollToTopBtn.addEventListener('click', () => this.scrollToTop());
                elements.scrollToBottomBtn.addEventListener('click', () => this.scrollToBottom());
                elements.aiToAiChatBtn.addEventListener('click', () => this.initiateAiToAiStep());
                elements.pasteToInputBtn.addEventListener('click', () => this.pasteToUserInput());
                elements.rollDiceBtn.addEventListener('click', () => this.rollDiceAndInput());

                elements.newChatBtn.addEventListener('click', async () => {
                    // 迴ｾ蝨ｨ縺ｮ繝√Ε繝・ヨID繧剃ｿ晏ｭ假ｼ医・繝ｭ繝ｳ繝励ヨ險ｭ螳夂判髱｢縺九ｉ謌ｻ縺｣縺滓凾縺ｫ蠕ｩ蜈・☆繧九◆繧・ｼ・                    state.beforePromptScreenChatId = state.currentChatId;
                    await uiUtils.showScreen('prompt-setup');
                });
                elements.deleteSessionBtn.addEventListener('click', () => this.confirmDeleteCurrentSession());
                elements.copySessionBtn.addEventListener('click', () => this.copyCurrentSessionText());
                elements.toggleAllContentBtn.addEventListener('click', () => this.toggleAllMessagesVisibility());
                elements.headerApiProviderToggleBtn.addEventListener('click', () => this.toggleApiProvider());
                elements.footerApiProviderToggleBtn.addEventListener('click', () => this.toggleApiProvider());
                elements.sendButton.addEventListener('click', () => {
                    if (state.isSending) this.abortRequest();
                    else this.handleSend();
                });
                elements.userInput.addEventListener('input', () => uiUtils.adjustTextareaHeight());
                elements.userInput.addEventListener('keypress', (e) => {
                    if (state.settings.enterToSend && e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        const canSend = state.settings.apiProvider === 'dummy' || !(elements.userInput.value.trim() === '' && state.pendingAttachments.length === 0);
                        if (canSend && !state.isSending) {
                             this.handleSend();
                        }
                    }
                });
                 elements.userInput.addEventListener('input', () => uiUtils.updateAttachmentBadgeVisibility());

                elements.importHistoryBtn.addEventListener('click', () => elements.importHistoryInput.click());
                elements.importHistoryInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) this.handleHistoryImport(file);
                    event.target.value = null;
                });
                elements.exportAllSessionsBtn.addEventListener('click', () => this.exportAllSessions());
                elements.importAllSessionsBtn.addEventListener('click', () => elements.importAllSessionsInput.click());
                elements.importAllSessionsInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) this.handleAllSessionsImport(file);
                    event.target.value = null;
                });

                elements.saveSettingsBtns.forEach(button => {
                    button.addEventListener('click', () => this.saveSettings(true));
                });
                elements.updateAppBtn.addEventListener('click', () => this.updateApp());
                elements.clearDataBtn.addEventListener('click', () => this.confirmClearAllData());
                elements.clearHistoryBtn.addEventListener('click', () => this.confirmClearAllHistory());
                document.getElementById('force-recovery-btn').addEventListener('click', async () => {
                    const confirmed = await uiUtils.showCustomConfirm(
                        "蠑ｷ蛻ｶ蠕ｩ譌ｧ繧貞ｮ溯｡後＠縺ｾ縺吶°・歃n\n" +
                        "縺薙・謫堺ｽ懊↓繧医ｊ・喀n" +
                        "窶｢ 蜈ｨ繧ｭ繝｣繝・す繝･縺後け繝ｪ繧｢縺輔ｌ縺ｾ縺兔n" +
                        "窶｢ 繧｢繝励Μ縺瑚・蜍慕噪縺ｫ蜀崎ｵｷ蜍輔＆繧後∪縺兔n" +
                        "窶｢ 繝√Ε繝・ヨ螻･豁ｴ縺ｨ險ｭ螳壹・菫晄戟縺輔ｌ縺ｾ縺兔n\n" +
                        "繧｢繝励Μ縺御ｸ榊ｮ牙ｮ壹↑蝣ｴ蜷医↓縺ｮ縺ｿ螳溯｡後＠縺ｦ縺上□縺輔＞縲・
                    );
                    
                    if (confirmed) {
                        if (typeof errorRecovery !== 'undefined') {
                            errorRecovery.manualRecovery();
                        } else {
                            await uiUtils.showCustomAlert("繧ｭ繝｣繝・す繝･繧偵け繝ｪ繧｢縺励※蜀崎ｵｷ蜍輔＠縺ｾ縺・..");
                            window.location.reload(true);
                        }
                    }
                });

                if (elements.themeSelect) {
                    elements.themeSelect.addEventListener('change', () => {
                        state.settings.theme = elements.themeSelect.value;
                        // 險ｭ螳夂判髱｢縺ｧ繝・・繝槭ｒ螟画峩縺励◆蝣ｴ蜷医√・繝ｭ繝ｳ繝励ヨ險ｭ螳夂判髱｢縺ｮ荳譎ゅユ繝ｼ繝槭〒縺ｪ縺・剞繧企←逕ｨ
                        if (state.currentScreen !== 'prompt-setup' || !state.promptTempTheme) {
                            uiUtils.applyTheme();
                        }
                    });
                }
                if (elements.apiProviderSelect) {
                    elements.apiProviderSelect.addEventListener('change', (event) => {
                        const selectedProvider = event.target.value;
                        state.settings.apiProvider = selectedProvider;
                        uiUtils.toggleApiSettingsVisibility(selectedProvider);
                    });
                }
                if (elements.enableSessionLinkingCheckbox) {
                    elements.enableSessionLinkingCheckbox.addEventListener('change', () => {
                        state.settings.enableSessionLinking = elements.enableSessionLinkingCheckbox.checked;
                        if (!state.settings.enableSessionLinking) {
                            state.linkedSessionIds = [];
                        }
                        uiUtils.updateSessionLinkingUI();
                    });
                }
                elements.setThinkingBudgetBtns.forEach(button => {
                    button.addEventListener('click', () => {
                        const value = button.dataset.value;
                        const targetInput = elements.geminiThinkingBudgetInput;
                        if (value === 'null') {
                            targetInput.value = '';
                        } else {
                            targetInput.value = value;
                        }
                    });
                });
                elements.setClaudeParamBtns.forEach(button => {
                    button.addEventListener('click', () => {
                        const targetId = button.dataset.target;
                        const value = button.dataset.value;
                        const targetInput = document.getElementById(targetId);
                        if (targetInput) {
                            if (value === 'null') {
                                targetInput.value = '';
                            } else {
                                targetInput.value = value;
                            }
                        }
                    });
                });

                elements.uploadBackgroundBtn.addEventListener('click', () => elements.backgroundImageInput.click());
                elements.backgroundImageInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) this.handleBackgroundImageUpload(file);
                    event.target.value = null;
                });
                elements.deleteBackgroundBtn.addEventListener('click', () => this.confirmDeleteBackgroundImage());

                elements.showUserIconToggle.addEventListener('change', () => {
                    state.settings.showUserIcon = elements.showUserIconToggle.checked;
                    uiUtils.renderChatMessages(true);
                });
                elements.uploadUserIconBtn.addEventListener('click', () => elements.userIconInput.click());
                elements.userIconInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) this.handleIconUpload('user', file);
                    event.target.value = null;
                });
                elements.deleteUserIconBtn.addEventListener('click', () => this.confirmDeleteIcon('user'));
                elements.showUserNameToggle.addEventListener('change', () => {
                    state.settings.showUserName = elements.showUserNameToggle.checked;
                    uiUtils.renderChatMessages(true);
                });

                elements.showAiIconToggle.addEventListener('change', () => {
                    state.settings.showAiIcon = elements.showAiIconToggle.checked;
                    uiUtils.renderChatMessages(true);
                });
                elements.uploadAiIconBtn.addEventListener('click', () => elements.aiIconInput.click());
                elements.aiIconInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) this.handleIconUpload('ai', file);
                    event.target.value = null;
                });
                elements.deleteAiIconBtn.addEventListener('click', () => this.confirmDeleteIcon('ai'));
                elements.showAiNameToggle.addEventListener('change', () => {
                    state.settings.showAiName = elements.showAiNameToggle.checked;
                    uiUtils.renderChatMessages(true);
                });
                elements.iconNameFontSizeInput.addEventListener('input', () => {
                    const newSize = parseInt(elements.iconNameFontSizeInput.value, 10);
                    if (newSize >= 6 && newSize <= 16) {
                        document.documentElement.style.setProperty('--icon-name-font-size', `${newSize}px`);
                    } else if (elements.iconNameFontSizeInput.value === '') {
                        document.documentElement.style.setProperty('--icon-name-font-size', `${DEFAULT_ICON_NAME_FONT_SIZE}px`);
                    }
                });
                elements.iconNameOffsetYInput.addEventListener('input', () => {
                    const uiOffsetY = parseInt(elements.iconNameOffsetYInput.value, 10);
                    const internalOffsetY = isNaN(uiOffsetY) ? DEFAULT_ICON_NAME_OFFSET_Y : (uiOffsetY * -1);
                    if (internalOffsetY >= -20 && internalOffsetY <= 20) {
                        document.documentElement.style.setProperty('--icon-name-offset-y', `${internalOffsetY}px`);
                    } else if (elements.iconNameOffsetYInput.value === '') {
                        document.documentElement.style.setProperty('--icon-name-offset-y', `${DEFAULT_ICON_NAME_OFFSET_Y}px`);
                    }
                });

                elements.messageIconSizeInput.addEventListener('input', () => {
                    const newSize = parseInt(elements.messageIconSizeInput.value, 10);
                    if (newSize >= 16 && newSize <= 64) {
                        document.documentElement.style.setProperty('--message-icon-size', `${newSize}px`);
                    } else if (elements.messageIconSizeInput.value === '') {
                        document.documentElement.style.setProperty('--message-icon-size', `${DEFAULT_MESSAGE_ICON_SIZE}px`);
                    }
                });
                elements.messageIconOffsetYInput.addEventListener('input', () => {
                    const uiOffsetY = parseInt(elements.messageIconOffsetYInput.value, 10);
                    const internalOffsetY = isNaN(uiOffsetY) ? DEFAULT_MESSAGE_ICON_OFFSET_Y : (uiOffsetY * -1);

                    if (internalOffsetY >= -50 && internalOffsetY <= 50) {
                        document.documentElement.style.setProperty('--message-icon-offset-y', `${internalOffsetY}px`);
                    } else if (elements.messageIconOffsetYInput.value === '') {
                        document.documentElement.style.setProperty('--message-icon-offset-y', `${DEFAULT_MESSAGE_ICON_OFFSET_Y}px`);
                    }
                });
                elements.userNameBubbleToggle.addEventListener('change', () => {
                    state.settings.showUserNameBubble = elements.userNameBubbleToggle.checked;
                    uiUtils.applySidePanelSettingsToUI();
                    uiUtils.renderChatMessages(true);
                });
                elements.userNameBubbleUseThemeColorToggle.addEventListener('change', () => {
                    state.settings.userNameBubbleUseThemeColor = elements.userNameBubbleUseThemeColorToggle.checked;
                    uiUtils.applySidePanelSettingsToUI();
                    uiUtils.renderChatMessages(true);
                });
                elements.userNameBubbleColorInput.addEventListener('input', () => {
                    state.settings.userNameBubbleColor = elements.userNameBubbleColorInput.value.trim() || DEFAULT_USER_NAME_BUBBLE_COLOR;
                    uiUtils.applySidePanelSettingsToUI();
                    uiUtils.renderChatMessages(true);
                });
                elements.userNameBubbleOpacityInput.addEventListener('input', () => {
                    state.settings.userNameBubbleOpacity = elements.userNameBubbleOpacityInput.value === '' ? DEFAULT_USER_NAME_BUBBLE_OPACITY : parseFloat(elements.userNameBubbleOpacityInput.value);
                    uiUtils.applySidePanelSettingsToUI();
                    uiUtils.renderChatMessages(true);
                });
                elements.aiNameBubbleToggle.addEventListener('change', () => {
                    state.settings.showAiNameBubble = elements.aiNameBubbleToggle.checked;
                    uiUtils.applySidePanelSettingsToUI();
                    uiUtils.renderChatMessages(true);
                });
                elements.aiNameBubbleUseThemeColorToggle.addEventListener('change', () => {
                    state.settings.aiNameBubbleUseThemeColor = elements.aiNameBubbleUseThemeColorToggle.checked;
                    uiUtils.applySidePanelSettingsToUI();
                    uiUtils.renderChatMessages(true);
                });
                elements.aiNameBubbleColorInput.addEventListener('input', () => {
                    state.settings.aiNameBubbleColor = elements.aiNameBubbleColorInput.value.trim() || DEFAULT_AI_NAME_BUBBLE_COLOR;
                    uiUtils.applySidePanelSettingsToUI();
                    uiUtils.renderChatMessages(true);
                });
                elements.aiNameBubbleOpacityInput.addEventListener('input', () => {
                    state.settings.aiNameBubbleOpacity = elements.aiNameBubbleOpacityInput.value === '' ? DEFAULT_AI_NAME_BUBBLE_OPACITY : parseFloat(elements.aiNameBubbleOpacityInput.value);
                    uiUtils.applySidePanelSettingsToUI();
                    uiUtils.renderChatMessages(true);
                });

                elements.enableCommonSystemPromptDefaultCheckbox.addEventListener('change', () => {
                    state.settings.enableCommonSystemPromptDefault = elements.enableCommonSystemPromptDefaultCheckbox.checked;
                });
                elements.showChatTitleToggle.addEventListener('change', () => {
                    state.settings.showChatTitle = elements.showChatTitleToggle.checked;
                    uiUtils.updateChatScreenElementVisibility();
                });
                elements.showMemoButtonToggle.addEventListener('change', () => {
                    state.settings.showMemoButton = elements.showMemoButtonToggle.checked;
                    uiUtils.updateChatScreenElementVisibility();
                    uiUtils.updateMemoStackHeightSettingsVisibility();
                });
                elements.showClipboardStackButtonToggle.addEventListener('change', () => {
                    state.settings.showClipboardStackButton = elements.showClipboardStackButtonToggle.checked;
                    uiUtils.updateChatScreenElementVisibility();
                    uiUtils.updateMemoStackHeightSettingsVisibility();
                });
                elements.showNewChatButtonToggle.addEventListener('change', () => {
                    state.settings.showNewChatButton = elements.showNewChatButtonToggle.checked;
                    uiUtils.updateChatScreenElementVisibility();
                });
                elements.showDeleteSessionButtonToggle.addEventListener('change', () => {
                    state.settings.showDeleteSessionButton = elements.showDeleteSessionButtonToggle.checked;
                    uiUtils.updateChatScreenElementVisibility();
                });
                elements.showCopySessionButtonToggle.addEventListener('change', () => {
                    state.settings.showCopySessionButton = elements.showCopySessionButtonToggle.checked;
                    uiUtils.updateChatScreenElementVisibility();
                });
                elements.showScrollToTopButtonToggle.addEventListener('change', () => {
                    state.settings.showScrollToTopButton = elements.showScrollToTopButtonToggle.checked;
                    uiUtils.updateChatScreenElementVisibility();
                });
                elements.showScrollToBottomButtonToggle.addEventListener('change', () => {
                    state.settings.showScrollToBottomButton = elements.showScrollToBottomButtonToggle.checked;
                    uiUtils.updateChatScreenElementVisibility();
                });
                elements.showToggleAllContentButtonToggle.addEventListener('change', () => {
                    state.settings.showToggleAllContentButton = elements.showToggleAllContentButtonToggle.checked;
                    uiUtils.updateChatScreenElementVisibility();
                });
                elements.showBulkHistoryActionsToggle.addEventListener('change', () => {
                    state.settings.showBulkHistoryActions = elements.showBulkHistoryActionsToggle.checked;
                    uiUtils.updateHistoryHeaderButtonVisibility();
                });
                elements.showPasteButtonInFooterToggle.addEventListener('change', () => {
                    state.settings.showPasteButtonInFooter = elements.showPasteButtonInFooterToggle.checked;
                    uiUtils.updateChatScreenElementVisibility();
                });
                elements.showPasteButtonInEditToggle.addEventListener('change', () => {
                    state.settings.showPasteButtonInEdit = elements.showPasteButtonInEditToggle.checked;
                });
                elements.showDiceButtonToggle.addEventListener('change', () => {
                    state.settings.showDiceButton = elements.showDiceButtonToggle.checked;
                    uiUtils.updateChatScreenElementVisibility();
                    document.getElementById('dice-value-settings').classList.toggle('hidden', !state.settings.showDiceButton);
                });
                elements.preventZoomToggle.addEventListener('change', () => {
                    state.settings.preventZoom = elements.preventZoomToggle.checked;
                    uiUtils.applyZoomPreventionSetting();
                });
                document.getElementById('minimize-header-toggle').addEventListener('change', (e) => {
                    state.settings.minimizeHeader = e.target.checked;
                    uiUtils.applyMinimizeUI();
                });
                document.getElementById('minimize-footer-toggle').addEventListener('change', (e) => {
                    state.settings.minimizeFooter = e.target.checked;
                    uiUtils.applyMinimizeUI();
                });
                elements.showSessionLinkingSettingsToggle.addEventListener('change', (e) => {
                    if (elements.sessionLinkingSettingsGroup) {
                        elements.sessionLinkingSettingsGroup.classList.toggle('hidden', !e.target.checked);
                    }
                });

                elements.memoHeightInput.addEventListener('input', () => {
                    const newHeight = elements.memoHeightInput.value.trim();
                    if (newHeight) {
                        document.documentElement.style.setProperty('--memo-height', newHeight);
                        document.documentElement.style.setProperty('--clipboard-stack-height', newHeight);
                    } else {
                        document.documentElement.style.setProperty('--memo-height', DEFAULT_MEMO_HEIGHT);
                        document.documentElement.style.setProperty('--clipboard-stack-height', DEFAULT_CLIPBOARD_STACK_HEIGHT);
                    }
                });
                elements.messageBodyFontSizeInput.addEventListener('input', () => {
                    const newSize = elements.messageBodyFontSizeInput.value.trim();
                    document.documentElement.style.setProperty('--message-body-font-size', newSize ? `${newSize}px` : `${DEFAULT_MESSAGE_BODY_FONT_SIZE}px`);
                });
                elements.codeBlockFontSizeInput.addEventListener('input', () => {
                    const newSize = elements.codeBlockFontSizeInput.value.trim();
                    document.documentElement.style.setProperty('--code-block-font-size', newSize ? `${newSize}px` : `${DEFAULT_CODE_BLOCK_FONT_SIZE}px`);
                });
                elements.thoughtSummaryFontSizeInput.addEventListener('input', () => {
                    const newSize = elements.thoughtSummaryFontSizeInput.value.trim();
                    document.documentElement.style.setProperty('--thought-summary-font-size', newSize ? `${newSize}px` : `${DEFAULT_THOUGHT_SUMMARY_FONT_SIZE}px`);
                });
                elements.showToggleAllContentButtonToggle.addEventListener('change', () => {
                    state.settings.showToggleAllContentButton = elements.showToggleAllContentButtonToggle.checked;
                    uiUtils.updateChatScreenElementVisibility();
                });
                elements.showBulkHistoryActionsToggle.addEventListener('change', () => {
                    state.settings.showBulkHistoryActions = elements.showBulkHistoryActionsToggle.checked;
                    uiUtils.updateHistoryHeaderButtonVisibility();
                });
                elements.messageBubbleOpacityInput.addEventListener('input', () => {
                    const opacity = parseFloat(elements.messageBubbleOpacityInput.value);
                    if (!isNaN(opacity) && opacity >= 0 && opacity <= 1) {
                        document.documentElement.style.setProperty('--message-bubble-opacity', opacity);
                    } else if (elements.messageBubbleOpacityInput.value === '') {
                         document.documentElement.style.setProperty('--message-bubble-opacity', DEFAULT_MESSAGE_BUBBLE_OPACITY);
                    }
                });
                 elements.chatOverlayOpacityInput.addEventListener('input', () => {
                    const opacity = parseFloat(elements.chatOverlayOpacityInput.value);
                    if (!isNaN(opacity) && opacity >= 0 && opacity <= 1) {
                        document.documentElement.style.setProperty('--chat-overlay-alpha', opacity);
                    } else if (elements.chatOverlayOpacityInput.value === '') {
                        document.documentElement.style.setProperty('--chat-overlay-alpha', DEFAULT_CHAT_OVERLAY_OPACITY);
                    }
                });
                elements.headerFooterOpacityInput.addEventListener('input', () => {
                    const opacity = parseFloat(elements.headerFooterOpacityInput.value);
                    if (!isNaN(opacity) && opacity >= 0 && opacity <= 1) {
                        document.documentElement.style.setProperty('--header-footer-opacity', opacity);
                    } else if (elements.headerFooterOpacityInput.value === '') {
                        document.documentElement.style.setProperty('--header-footer-opacity', DEFAULT_HEADER_FOOTER_OPACITY);
                    }
                });
                elements.messageActionsBackgroundOpacityInput.addEventListener('input', () => {
                    const opacity = parseFloat(elements.messageActionsBackgroundOpacityInput.value);
                    if (!isNaN(opacity) && opacity >= 0 && opacity <= 1) {
                        document.documentElement.style.setProperty('--message-actions-bg-opacity', opacity);
                    } else if (elements.messageActionsBackgroundOpacityInput.value === '') {
                        document.documentElement.style.setProperty('--message-actions-bg-opacity', DEFAULT_MESSAGE_ACTIONS_BACKGROUND_OPACITY);
                    }
                });
                elements.toggleButtonTopOpacityInput.addEventListener('input', () => {
                    const opacity = parseFloat(elements.toggleButtonTopOpacityInput.value);
                    if (!isNaN(opacity) && opacity >= 0 && opacity <= 1) {
                        document.documentElement.style.setProperty('--message-toggle-button-top-opacity', opacity);
                    } else if (elements.toggleButtonTopOpacityInput.value === '') {
                        document.documentElement.style.setProperty('--message-toggle-button-top-opacity', DEFAULT_TOGGLE_BUTTON_TOP_OPACITY);
                    }
                });
                elements.thoughtSummaryOpacityInput.addEventListener('input', () => {
                    const opacity = parseFloat(elements.thoughtSummaryOpacityInput.value);
                    if (!isNaN(opacity) && opacity >= 0 && opacity <= 1) {
                        document.documentElement.style.setProperty('--thought-summary-opacity', opacity);
                    } else if (elements.thoughtSummaryOpacityInput.value === '') {
                        document.documentElement.style.setProperty('--thought-summary-opacity', DEFAULT_THOUGHT_SUMMARY_OPACITY);
                    }
                });
                elements.showTopCollapseButtonToggle.addEventListener('change', () => {
                    state.settings.showTopCollapseButton = elements.showTopCollapseButtonToggle.checked;
                    uiUtils.renderChatMessages(true);
                });
                elements.showBottomCollapseButtonToggle.addEventListener('change', () => {
                    state.settings.showBottomCollapseButton = elements.showBottomCollapseButtonToggle.checked;
                    uiUtils.renderChatMessages(true);
                });
                elements.persistMessageCollapseStateCheckbox.addEventListener('change', () => {
                    state.settings.persistMessageCollapseState = elements.persistMessageCollapseStateCheckbox.checked;
                });
                elements.showMultiApiKeysToggle.addEventListener('change', (e) => {
                    state.settings.showMultiApiKeys = e.target.checked;
                    uiUtils.toggleMultiApiKeysVisibility(e.target.checked);
                });

                const settingsScreenElement = document.getElementById('settings-screen');
                let autoSaveTimer;
                const handleSettingsChange = () => {
                    if (state.settings.autoSaveSettings) {
                        clearTimeout(autoSaveTimer);
                        autoSaveTimer = setTimeout(() => {
                            this.saveSettings(false);
                        }, 500);
                    }
                };

                settingsScreenElement.addEventListener('change', (event) => {
                    if (event.target.closest('.settings-group, .danger-zone')) {
                        handleSettingsChange();
                    }
                });

                settingsScreenElement.addEventListener('input', (event) => {
                    if (event.target.matches('input[type="text"], input[type="password"], input[type="number"], textarea')) {
                         handleSettingsChange();
                    }
                });

                elements.messageContainer.addEventListener('click', (event) => {
                    const clickedMessage = event.target.closest('.message');
                    if (event.target.closest('.message-actions button, .message-cascade-controls button, .message-toggle-button, .interactive-title-content, .code-copy-button, a[href="#"], .thought-summary-details summary, .attachment-actions button, .add-more-attachments-btn')) {
                        return;
                    }
                    if (clickedMessage) {
                        const currentlyShown = elements.messageContainer.querySelector('.message.show-actions');
                        if (currentlyShown && currentlyShown !== clickedMessage) {
                                                currentlyShown.classList.remove('show-actions');
                        }
                        if (!clickedMessage.classList.contains('editing')) {
                            clickedMessage.classList.toggle('show-actions');
                        }
                    } else {
                        const currentlyShown = elements.messageContainer.querySelector('.message.show-actions');
                        if (currentlyShown) {
                            currentlyShown.classList.remove('show-actions');
                        }
                    }
                }, true);
                document.body.addEventListener('click', (event) => {
                    if (!elements.messageContainer.contains(event.target) &&
                    !elements.memoArea.contains(event.target) &&
                    !elements.clipboardStackArea.contains(event.target) &&
                    !event.target.closest('.custom-dialog')) {
                    const currentlyShown = elements.messageContainer.querySelector('.message.show-actions');
                    if (currentlyShown) {
                        currentlyShown.classList.remove('show-actions');
                    }
                }
            }, true);

            elements.chatScreen.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: true });
            elements.chatScreen.addEventListener('touchmove', this.handleTouchMove.bind(this), { passive: false });
            elements.chatScreen.addEventListener('touchend', this.handleTouchEnd.bind(this));

            if ('visualViewport' in window) {
                window.visualViewport.addEventListener('resize', this.updateZoomState.bind(this));
                window.visualViewport.addEventListener('scroll', this.updateZoomState.bind(this));
            }

            window.addEventListener('popstate', this.handlePopState.bind(this));

            elements.attachFileBtn.addEventListener('click', () => uiUtils.showFileUploadDialog());
            elements.selectFilesBtn.addEventListener('click', () => elements.fileInput.click());
            elements.fileInput.addEventListener('change', (event) => {
                this.handleFileSelection(event.target.files);
                event.target.value = null;
            });
            elements.confirmAttachBtn.addEventListener('click', () => this.confirmAttachment());
            elements.cancelAttachBtn.addEventListener('click', () => this.cancelAttachment());
            elements.fileUploadDialog.addEventListener('close', () => {
                if (elements.fileUploadDialog.returnValue !== 'ok') {
                    this.cancelAttachment();
                }
            });
            elements.messageContainer.addEventListener('click', (event) => {
                const targetButton = event.target.closest('.message-toggle-button');
                if (targetButton && targetButton.dataset.action === 'toggle-collapse') {
                    const index = parseInt(targetButton.dataset.index, 10);
                    this.toggleMessageCollapse(index);
                }
            });

            document.querySelectorAll('#settings-screen details[id]').forEach(details => {
                details.addEventListener('toggle', (event) => {
                    if (details.id) {
                        state.settings.settingsUIDetailsOpenStates[details.id] = details.open;
                    }
                });
            });
            window.addEventListener('resize', uiUtils.adjustHeaderLayout);
            uiUtils.adjustHeaderLayout();
            
            elements.apiProviderCycleGeminiCheckbox.addEventListener('change', () => {
                state.settings.apiProviderCycle.gemini = elements.apiProviderCycleGeminiCheckbox.checked;
                uiUtils.updateApiProviderSelectOptions();
            });
            elements.apiProviderCycleDeepSeekCheckbox.addEventListener('change', () => {
                state.settings.apiProviderCycle.deepseek = elements.apiProviderCycleDeepSeekCheckbox.checked;
                uiUtils.updateApiProviderSelectOptions();
            });
            elements.apiProviderCycleClaudeCheckbox.addEventListener('change', () => {
                state.settings.apiProviderCycle.claude = elements.apiProviderCycleClaudeCheckbox.checked;
                uiUtils.updateApiProviderSelectOptions();
            });
            elements.apiProviderCycleOpenAICheckbox.addEventListener('change', () => {
                state.settings.apiProviderCycle.openai = elements.apiProviderCycleOpenAICheckbox.checked;
                uiUtils.updateApiProviderSelectOptions();
            });
            elements.apiProviderCycleXaiCheckbox.addEventListener('change', () => {
                state.settings.apiProviderCycle.xai = elements.apiProviderCycleXaiCheckbox.checked;
                uiUtils.updateApiProviderSelectOptions();
            });
             elements.apiProviderCycleLlmAggregatorCheckbox.addEventListener('change', () => {
                state.settings.apiProviderCycle.llmaggregator = elements.apiProviderCycleLlmAggregatorCheckbox.checked;
                uiUtils.updateApiProviderSelectOptions();
            });
             elements.apiProviderCycleDummyCheckbox.addEventListener('change', () => {
                state.settings.apiProviderCycle.dummy = elements.apiProviderCycleDummyCheckbox.checked;
                uiUtils.updateApiProviderSelectOptions();
            });
            
            const llmUrlInput = elements.llmAggregatorApiBackendInput;
            const llmUrlError = elements.llmAggregatorUrlError;
            
            const validateLlmUrl = () => {
                const url = llmUrlInput.value;
                const saveButtons = document.querySelectorAll('.js-save-settings-btn');
                if (url && !isAllowedAggregatorDomain(url)) {
                    llmUrlError.textContent = '縺薙・繝峨Γ繧､繝ｳ縺ｯ險ｱ蜿ｯ縺輔ｌ縺ｦ縺・∪縺帙ｓ縲・;
                    saveButtons.forEach(btn => btn.disabled = true);
                } else {
                    llmUrlError.textContent = '';
                    saveButtons.forEach(btn => btn.disabled = false);
                }
            };

            llmUrlInput.addEventListener('input', validateLlmUrl);
            llmUrlInput.addEventListener('blur', validateLlmUrl);

            multiApiKeyUtils.initializeMultiApiKeys();
            elements.geminiApiKeyInput.addEventListener('input', () => multiApiKeyUtils.syncMainApiKeyInput('gemini'));
            elements.deepSeekApiKeyInput.addEventListener('input', () => multiApiKeyUtils.syncMainApiKeyInput('deepseek'));
            elements.claudeApiKeyInput.addEventListener('input', () => multiApiKeyUtils.syncMainApiKeyInput('claude'));
            elements.openaiApiKeyInput.addEventListener('input', () => multiApiKeyUtils.syncMainApiKeyInput('openai'));
            elements.xaiApiKeyInput.addEventListener('input', () => multiApiKeyUtils.syncMainApiKeyInput('xai'));
            elements.llmAggregatorApiKeyInput.addEventListener('input', () => multiApiKeyUtils.syncMainApiKeyInput('llmaggregator'));
            elements.showMultiApiKeysToggle.addEventListener('change', (e) => {
                uiUtils.toggleMultiApiKeysVisibility(e.target.checked);
            });
        },
        handlePopState(event) {
            const targetScreen = event.state?.screen || 'chat';
            uiUtils.showScreen(targetScreen, true);
        },
        updateZoomState() {
            if ('visualViewport' in window) {
                const newZoomState = window.visualViewport.scale > ZOOM_THRESHOLD;
                if (state.isZoomed !== newZoomState) {
                    state.isZoomed = newZoomState;
                    document.body.classList.toggle('zoomed', state.isZoomed);
                }
            }
        },
        handleTouchStart(event) {
            if (!state.settings.enableSwipeNavigation) return;
            if (event.touches.length > 1 || state.isZoomed) {
                state.touchStartX = 0;
                state.touchStartY = 0;
                state.isSwiping = false;
                return;
            }
            state.touchStartX = event.touches[0].clientX;
            state.touchStartY = event.touches[0].clientY;
            state.isSwiping = false;
            state.touchEndX = state.touchStartX;
            state.touchEndY = state.touchStartY;
        },
        handleTouchMove(event) {
            if (!state.settings.enableSwipeNavigation) return;
            if (!state.touchStartX || event.touches.length > 1 || state.isZoomed) {
                return;
            }
            const currentX = event.touches[0].clientX;
            const currentY = event.touches[0].clientY;
            const diffX = state.touchStartX - currentX;
            const diffY = state.touchStartY - currentY;

            if (Math.abs(diffX) > Math.abs(diffY)) {
                state.isSwiping = true;
                event.preventDefault();
            } else {
                state.isSwiping = false;
            }
            state.touchEndX = currentX;
            state.touchEndY = currentY;
        },
        handleTouchEnd(event) {
             if (!state.settings.enableSwipeNavigation) {
                 this.resetSwipeState();
                 return;
             }
             this.updateZoomState();
             if (state.isZoomed) {
                 this.resetSwipeState();
                 return;
             }
             if (!state.isSwiping || !state.touchStartX) {
                 this.resetSwipeState();
                 return;
             }

            const diffX = state.touchStartX - state.touchEndX;
            const diffY = state.touchStartY - state.touchEndY;

            if (Math.abs(diffX) > SWIPE_THRESHOLD && Math.abs(diffX) > Math.abs(diffY)) {
                if (diffX > 0) {
                    uiUtils.showScreen('settings');
                } else {
                    uiUtils.showScreen('history');
                }
            }
            this.resetSwipeState();
        },
        resetSwipeState() {
            state.touchStartX = 0;
            state.touchStartY = 0;
            state.touchEndX = 0;
            state.touchEndY = 0;
            state.isSwiping = false;
        },
        toggleMemo() {
             if (state.editingMessageIndex !== null) {
                 uiUtils.showCustomAlert("繝｡繝・そ繝ｼ繧ｸ邱ｨ髮・ｸｭ縺ｯ繝｡繝｢繧帝幕髢峨〒縺阪∪縺帙ｓ縲・);
                 return;
             }

            state.isMemoVisible = !state.isMemoVisible;
            elements.memoArea.classList.toggle('hidden', !state.isMemoVisible);

            if (state.isMemoVisible) {
                elements.memoEditor.focus();
            }
        },
        async copyMemoText() {
            const memoText = elements.memoEditor.value;
            if (!memoText.trim()) {
                 const originalText = elements.copyMemoBtn.textContent;
                 elements.copyMemoBtn.textContent = "遨ｺ縺ｧ縺・;
                 elements.copyMemoBtn.disabled = true;
                 setTimeout(() => {
                     elements.copyMemoBtn.textContent = originalText;
                     elements.copyMemoBtn.disabled = false;
                 }, 1500);
                return;
            }
            try {
                await navigator.clipboard.writeText(memoText);
                const originalText = elements.copyMemoBtn.textContent;
                elements.copyMemoBtn.textContent = "繧ｳ繝斐・螳御ｺ・;
                elements.copyMemoBtn.disabled = true;
                setTimeout(() => { elements.copyMemoBtn.textContent = originalText; elements.copyMemoBtn.disabled = false; }, 1500);
            } catch (err) {
                const originalText = elements.copyMemoBtn.textContent;
                elements.copyMemoBtn.textContent = "繧ｳ繝斐・螟ｱ謨・;
                elements.copyMemoBtn.disabled = true;
                setTimeout(() => { elements.copyMemoBtn.textContent = originalText; elements.copyMemoBtn.disabled = false; }, 2000);
            }
        },
        async pasteIntoMemo() {
            try {
                if (!navigator.clipboard || !navigator.clipboard.readText) {
                    const originalText = elements.pasteMemoBtn.textContent;
                    elements.pasteMemoBtn.textContent = "髱槫ｯｾ蠢・;
                    elements.pasteMemoBtn.disabled = true;
                    setTimeout(() => { elements.pasteMemoBtn.textContent = originalText; elements.pasteMemoBtn.disabled = false; }, 2000);
                    return;
                }
                const textToPaste = await navigator.clipboard.readText();
                if (textToPaste) {
                    const currentText = elements.memoEditor.value;
                    const selectionStart = elements.memoEditor.selectionStart;
                    const selectionEnd = elements.memoEditor.selectionEnd;
                    elements.memoEditor.value = currentText.substring(0, selectionStart) + textToPaste + currentText.substring(selectionEnd);
                    elements.memoEditor.selectionStart = elements.memoEditor.selectionEnd = selectionStart + textToPaste.length;
                    elements.memoEditor.focus();
                    const originalText = elements.pasteMemoBtn.textContent;
                    elements.pasteMemoBtn.textContent = "雋ｼ莉倥￠螳御ｺ・;
                    elements.pasteMemoBtn.disabled = true;
                    setTimeout(() => { elements.pasteMemoBtn.textContent = originalText; elements.pasteMemoBtn.disabled = false; }, 1500);
                } else {
                    const originalText = elements.pasteMemoBtn.textContent;
                    elements.pasteMemoBtn.textContent = "遨ｺ縺ｧ縺・;
                    elements.pasteMemoBtn.disabled = true;
                    setTimeout(() => { elements.pasteMemoBtn.textContent = originalText; elements.pasteMemoBtn.disabled = false; }, 1500);
                }
            } catch (err) {
                if (err.name === 'NotAllowedError' || err.message.includes('Read permission denied')) {
                     const originalText = elements.pasteMemoBtn.textContent;
                     elements.pasteMemoBtn.textContent = "險ｱ蜿ｯ繧ｨ繝ｩ繝ｼ";
                     elements.pasteMemoBtn.disabled = true;
                     setTimeout(() => { elements.pasteMemoBtn.textContent = originalText; elements.pasteMemoBtn.disabled = false; }, 2000);
                } else {
                      const originalText = elements.pasteMemoBtn.textContent;
                      elements.pasteMemoBtn.textContent = "雋ｼ莉倥￠螟ｱ謨・;
                      elements.pasteMemoBtn.disabled = true;
                      setTimeout(() => { elements.pasteMemoBtn.textContent = originalText; elements.pasteMemoBtn.disabled = false; }, 2000);
                }
            }
        },
        async confirmClearMemo() {
            if (!elements.memoEditor.value.trim()) {
                 const originalText = elements.deleteMemoBtn.textContent;
                 elements.deleteMemoBtn.textContent = "遨ｺ縺ｧ縺・;
                 elements.deleteMemoBtn.disabled = true;
                 setTimeout(() => {
                     elements.deleteMemoBtn.textContent = originalText;
                     elements.deleteMemoBtn.disabled = false;
                 }, 1500);
                 return;
            }
            const confirmed = await uiUtils.showCustomConfirm("繝｡繝｢縺ｮ蜀・ｮｹ繧貞・縺ｦ繧ｯ繝ｪ繧｢縺励∪縺吶°・歃n縺薙・謫堺ｽ懊・蜈・↓謌ｻ縺帙∪縺帙ｓ縲・);
            if (confirmed) {
                elements.memoEditor.value = '';
            }
        },
        toggleClipboardStack() {
             if (state.editingMessageIndex !== null) {
                 uiUtils.showCustomAlert("繝｡繝・そ繝ｼ繧ｸ邱ｨ髮・ｸｭ縺ｯ繧ｯ繝ｪ繝・・繝懊・繝峨せ繧ｿ繝・け繧帝幕髢峨〒縺阪∪縺帙ｓ縲・);
                 return;
             }

            state.isClipboardStackVisible = !state.isClipboardStackVisible;
            elements.clipboardStackArea.classList.toggle('hidden', !state.isClipboardStackVisible);

            if (state.isClipboardStackVisible) {
                elements.clipboardStackEditor.value = state.clipboardStackContent;
                elements.clipboardStackEditor.focus();
                elements.clipboardStackEditor.scrollTop = elements.clipboardStackEditor.scrollHeight;
            }
        },
        async copyClipboardStackText() {
            const stackText = elements.clipboardStackEditor.value;
            if (!stackText.trim()) {
                 const originalText = elements.copyClipboardStackBtn.textContent;
                 elements.copyClipboardStackBtn.textContent = "遨ｺ縺ｧ縺・;
                 elements.copyClipboardStackBtn.disabled = true;
                 setTimeout(() => {
                     elements.copyClipboardStackBtn.textContent = originalText;
                     elements.copyClipboardStackBtn.disabled = false;
                 }, 1500);
                return;
            }
            try {
                await navigator.clipboard.writeText(stackText);
                const originalText = elements.copyClipboardStackBtn.textContent;
                elements.copyClipboardStackBtn.textContent = "繧ｳ繝斐・螳御ｺ・;
                elements.copyClipboardStackBtn.disabled = true;
                setTimeout(() => { elements.copyClipboardStackBtn.textContent = originalText; elements.copyClipboardStackBtn.disabled = false; }, 1500);
            } catch (err) {
                const originalText = elements.copyClipboardStackBtn.textContent;
                elements.copyClipboardStackBtn.textContent = "繧ｳ繝斐・螟ｱ謨・;
                elements.copyClipboardStackBtn.disabled = true;
                setTimeout(() => { elements.copyClipboardStackBtn.textContent = originalText; elements.copyClipboardStackBtn.disabled = false; }, 2000);
            }
        },
        async pasteIntoClipboardStack() {
            try {
                if (!navigator.clipboard || !navigator.clipboard.readText) {
                    const originalText = elements.pasteClipboardStackBtn.textContent;
                    elements.pasteClipboardStackBtn.textContent = "髱槫ｯｾ蠢・;
                    elements.pasteClipboardStackBtn.disabled = true;
                    setTimeout(() => { elements.pasteClipboardStackBtn.textContent = originalText; elements.pasteClipboardStackBtn.disabled = false; }, 2000);
                    return;
                }
                const textToPaste = await navigator.clipboard.readText();
                if (textToPaste) {
                    const currentText = elements.clipboardStackEditor.value;
                    const separator = currentText.length > 0 && !currentText.endsWith('\n\n') ? "\n\n" : "";
                    elements.clipboardStackEditor.value += separator + textToPaste;
                    elements.clipboardStackEditor.scrollTop = elements.clipboardStackEditor.scrollHeight;
                    elements.clipboardStackEditor.focus();
                    state.clipboardStackContent = elements.clipboardStackEditor.value;
                    const originalText = elements.pasteClipboardStackBtn.textContent;
                    elements.pasteClipboardStackBtn.textContent = "雋ｼ莉倥￠螳御ｺ・;
                    elements.pasteClipboardStackBtn.disabled = true;
                    setTimeout(() => { elements.pasteClipboardStackBtn.textContent = originalText; elements.pasteClipboardStackBtn.disabled = false; }, 1500);
                } else {
                    const originalText = elements.pasteClipboardStackBtn.textContent;
                    elements.pasteClipboardStackBtn.textContent = "遨ｺ縺ｧ縺・;
                    elements.pasteClipboardStackBtn.disabled = true;
                    setTimeout(() => { elements.pasteClipboardStackBtn.textContent = originalText; elements.pasteClipboardStackBtn.disabled = false; }, 1500);
                }
            } catch (err) {
                if (err.name === 'NotAllowedError' || err.message.includes('Read permission denied')) {
                     const originalText = elements.pasteClipboardStackBtn.textContent;
                     elements.pasteClipboardStackBtn.textContent = "險ｱ蜿ｯ繧ｨ繝ｩ繝ｼ";
                     elements.pasteClipboardStackBtn.disabled = true;
                     setTimeout(() => { elements.pasteClipboardStackBtn.textContent = originalText; elements.pasteClipboardStackBtn.disabled = false; }, 2000);
                } else {
                      const originalText = elements.pasteClipboardStackBtn.textContent;
                      elements.pasteClipboardStackBtn.textContent = "雋ｼ莉倥￠螟ｱ謨・;
                      elements.pasteClipboardStackBtn.disabled = true;
                      setTimeout(() => { elements.pasteClipboardStackBtn.textContent = originalText; elements.pasteClipboardStackBtn.disabled = false; }, 2000);
                }
            }
        },
        async confirmClearClipboardStack() {
            if (!elements.clipboardStackEditor.value.trim()) {
                 const originalText = elements.deleteClipboardStackBtn.textContent;
                 elements.deleteClipboardStackBtn.textContent = "遨ｺ縺ｧ縺・;
                 elements.deleteClipboardStackBtn.disabled = true;
                 setTimeout(() => {
                     elements.deleteClipboardStackBtn.textContent = originalText;
                     elements.deleteClipboardStackBtn.disabled = false;
                 }, 1500);
                 return;
            }
            const confirmed = await uiUtils.showCustomConfirm("繧ｯ繝ｪ繝・・繝懊・繝峨せ繧ｿ繝・け縺ｮ蜀・ｮｹ繧貞・縺ｦ繧ｯ繝ｪ繧｢縺励∪縺吶°・・);
            if (confirmed) {
                elements.clipboardStackEditor.value = '';
                state.clipboardStackContent = '';
            }
        },
        scrollToTop() {
            requestAnimationFrame(() => {
                const mainContent = elements.chatScreen.querySelector('.main-content');
                if (mainContent) {
                    mainContent.scrollTop = 0;
                }
            });
        },
        scrollToBottom() {
            requestAnimationFrame(() => {
                const mainContent = elements.chatScreen.querySelector('.main-content');
                if (mainContent) {
                    mainContent.scrollTop = mainContent.scrollHeight;
                }
            });
        },
        async pasteToUserInput() {
            const button = elements.pasteToInputBtn;
            const originalTextContent = button.textContent;
            const originalTitle = button.title;

            try {
                if (!navigator.clipboard || !navigator.clipboard.readText) {
                    button.textContent = "!";
                    button.title = "繧ｯ繝ｪ繝・・繝懊・繝陰PI髱槫ｯｾ蠢・;
                    button.disabled = true;
                    setTimeout(() => {
                        button.textContent = originalTextContent;
                        button.title = originalTitle;
                        button.disabled = false;
                    }, 2000);
                    return;
                }
                const textToPaste = await navigator.clipboard.readText();
                if (textToPaste) {
                    const currentText = elements.userInput.value;
                    const selectionStart = elements.userInput.selectionStart;
                    const selectionEnd = elements.userInput.selectionEnd;
                    elements.userInput.value = currentText.substring(0, selectionStart) + textToPaste + currentText.substring(selectionEnd);
                    elements.userInput.selectionStart = elements.userInput.selectionEnd = selectionStart + textToPaste.length;
                    elements.userInput.focus();
                    uiUtils.adjustTextareaHeight();
                    uiUtils.updateAttachmentBadgeVisibility();

                    button.textContent = "笨・;
                    button.title = "雋ｼ繧贋ｻ倥￠螳御ｺ・;
                    setTimeout(() => {
                        button.textContent = originalTextContent;
                        button.title = originalTitle;
                    }, 1500);
                } else {
                    button.textContent = "遨ｺ";
                    button.title = "繧ｯ繝ｪ繝・・繝懊・繝峨・遨ｺ縺ｧ縺・;
                    setTimeout(() => {
                        button.textContent = originalTextContent;
                        button.title = originalTitle;
                    }, 1500);
                }
            } catch (err) {
                if (err.name === 'NotAllowedError' || err.message.includes('Read permission denied')) {
                    button.textContent = "!";
                    button.title = "繧ｯ繝ｪ繝・・繝懊・繝峨・險ｱ蜿ｯ縺ｪ縺・;
                } else {
                    button.textContent = "X";
                    button.title = "雋ｼ繧贋ｻ倥￠螟ｱ謨・;
                }
                button.disabled = true;
                setTimeout(() => {
                    button.textContent = originalTextContent;
                    button.title = originalTitle;
                    button.disabled = false;
                }, 2000);
            }
        },
        rollDiceAndInput() {
            let min = parseInt(state.settings.diceMinValue, 10);
            let max = parseInt(state.settings.diceMaxValue, 10);

            if (isNaN(min)) min = DEFAULT_DICE_MIN_VALUE;
            if (isNaN(max)) max = DEFAULT_DICE_MAX_VALUE;

            if (min > max) {
                [min, max] = [max, min];
            }

            const randomNumber = Math.floor(Math.random() * (max - min + 1)) + min;
            const currentText = elements.userInput.value;
            const selectionStart = elements.userInput.selectionStart;
            const selectionEnd = elements.userInput.selectionEnd;

            elements.userInput.value = currentText.substring(0, selectionStart) + randomNumber + currentText.substring(selectionEnd);
            elements.userInput.selectionStart = elements.userInput.selectionEnd = selectionStart + String(randomNumber).length;
            uiUtils.adjustTextareaHeight();
            uiUtils.updateAttachmentBadgeVisibility();
        },
        async confirmStartNewChat() {
            if (state.isSending) {
                const confirmed = await uiUtils.showCustomConfirm("騾∽ｿ｡荳ｭ縺ｧ縺吶ゆｸｭ譁ｭ縺励※譁ｰ隕上メ繝｣繝・ヨ繧帝幕蟋九＠縺ｾ縺吶°・・);
                if (!confirmed) return;
                this.abortRequest();
            }
            if (state.editingMessageIndex !== null) {
                const confirmed = await uiUtils.showCustomConfirm("邱ｨ髮・ｸｭ縺ｧ縺吶ょ､画峩繧堤ｴ譽・＠縺ｦ譁ｰ隕上メ繝｣繝・ヨ繧帝幕蟋九＠縺ｾ縺吶°・・);
                if (!confirmed) return;
                const msgEl = elements.messageContainer.querySelector(`.message[data-index="${state.editingMessageIndex}"]`);
                this.cancelEditMessage(state.editingMessageIndex, msgEl);
            }
            if (state.pendingAttachments.length > 0) {
                const confirmedAttach = await uiUtils.showCustomConfirm("豺ｻ莉俶ｺ門ｙ荳ｭ縺ｮ繝輔ぃ繧､繝ｫ縺後≠繧翫∪縺吶らｴ譽・＠縺ｦ譁ｰ隕上メ繝｣繝・ヨ繧帝幕蟋九＠縺ｾ縺吶°・・);
                if (!confirmedAttach) return;
                state.pendingAttachments = [];
                uiUtils.updateAttachmentBadgeVisibility();
            }

            if ((state.currentMessages.length > 0) && state.currentChatId) {
                try {
                    await dbUtils.saveChat();
                } catch (error) {
                    const conf = await uiUtils.showCustomConfirm("迴ｾ蝨ｨ縺ｮ繝√Ε繝・ヨ縺ｮ菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆縲よ眠隕上メ繝｣繝・ヨ繧帝幕蟋九＠縺ｾ縺吶°・・);
                    if (!conf) return;
                }
            }
            this.startNewChat();
            uiUtils.showScreen('chat');
        },
        startNewChat(preserveAssets = false) {
            // preserveAssets縺掲alse縺ｮ蝣ｴ蜷医・縺ｿURL繧偵け繝ｪ繝ｼ繝ｳ繧｢繝・・
            if (!preserveAssets) {
                // 譌｢蟄倥・繝√Ε繝・ヨ縺ｮURL繧偵け繝ｪ繝ｼ繝ｳ繧｢繝・・
                if (state.aiIconUrl && !uiUtils.isIOSSafari()) {
                    URL.revokeObjectURL(state.aiIconUrl);
                    state.aiIconUrl = null;
                }
                if (state.backgroundImageUrl && !uiUtils.isIOSSafari()) {
                    URL.revokeObjectURL(state.backgroundImageUrl);
                    state.backgroundImageUrl = null;
                }
                // "pending"繧ｨ繝ｳ繝医Μ繧ょ炎髯､
                if (state.chatAssets.has("pending")) {
                    state.chatAssets.delete("pending");
                }
            }
            
            state.currentChatId = null;
            state.currentMessages = [];
            
            if (state.settings.commonSystemPrompt && state.settings.commonSystemPrompt.trim() !== '') {
            }
            
            state.pendingAttachments = [];
            
            // 繝励Ο繝ｳ繝励ヨ菴懈・逕ｻ髱｢縺九ｉ譚･縺溷ｴ蜷井ｻ･螟悶・縲√メ繝｣繝・ヨ蟆ら畑繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧偵け繝ｪ繧｢
            if (state.currentScreen !== 'prompt-setup') {
                state.chatSystemPrompt = null;
                // dirty繝輔Λ繧ｰ繧ゅΜ繧ｻ繝・ヨ・域眠隕上メ繝｣繝・ヨ縺ｮ縺溘ａ・・                state.assetDirty = { aiIcon: false, bgImage: false, aiName: false };
            }
            
            state.pendingCharacterName = null;
            state.isMemoVisible = false;
            elements.memoArea.classList.add('hidden');
            elements.memoEditor.value = '';
            state.isClipboardStackVisible = false;
            elements.clipboardStackArea.classList.add('hidden');
            state.clipboardStackContent = '';
            state.areAllMessagesHidden = false;
            uiUtils.updateToggleAllContentButton();
            state.messageCollapsedStates.clear();
            state.thoughtSummaryOpenStates.clear();
            
            // 繝励Ο繝ｳ繝励ヨ逕ｻ髱｢縺九ｉ譚･縺溷ｴ蜷井ｻ･螟悶・縲√ユ繝ｼ繝槭ｒ繝ｪ繧ｻ繝・ヨ
            if (!state.currentChatTheme) {
                uiUtils.applyTheme(state.settings.theme);
            }
            
            // 繝励Ο繝ｳ繝励ヨ險ｭ螳夂判髱｢縺ｮ荳譎ゅユ繝ｼ繝槭ｂ繧ｯ繝ｪ繧｢・域眠隕上メ繝｣繝・ヨ髢句ｧ区凾・・            state.promptTempTheme = null;
            
            uiUtils.renderChatMessages();
            uiUtils.updateChatTitle();
            elements.userInput.value = '';
            uiUtils.adjustTextareaHeight();
            uiUtils.setSendingState(false);
            uiUtils.updateAttachmentBadgeVisibility();
            if (state.settings.autoScrollOnNewMessage) {
                uiUtils.scrollToBottom();
            }
        },
        async loadChat(id) {
            let confirmedLoad = true;
            if (state.isSending) {
                if (!state.settings.disableLoadChatConfirmationWhileSending) {
                    confirmedLoad = await uiUtils.showCustomConfirm("騾∽ｿ｡荳ｭ縺ｧ縺吶ゆｸｭ譁ｭ縺励※蛻･縺ｮ繝√Ε繝・ヨ繧定ｪｭ縺ｿ霎ｼ縺ｿ縺ｾ縺吶°・・);
                }
                if (!confirmedLoad) return;
                this.abortRequest();
            }
            if (state.editingMessageIndex !== null) {
                const confirmedEdit = await uiUtils.showCustomConfirm("邱ｨ髮・ｸｭ縺ｧ縺吶ょ､画峩繧堤ｴ譽・＠縺ｦ蛻･縺ｮ繝√Ε繝・ヨ繧定ｪｭ縺ｿ霎ｼ縺ｿ縺ｾ縺吶°・・);
                if (!confirmedEdit) return;
                const msgEl = elements.messageContainer.querySelector(`.message[data-index="${state.editingMessageIndex}"]`);
                this.cancelEditMessage(state.editingMessageIndex, msgEl);
            }
            if (state.pendingAttachments.length > 0) {
                const confirmedAttach = await uiUtils.showCustomConfirm("豺ｻ莉俶ｺ門ｙ荳ｭ縺ｮ繝輔ぃ繧､繝ｫ縺後≠繧翫∪縺吶らｴ譽・＠縺ｦ蛻･縺ｮ繝√Ε繝・ヨ繧定ｪｭ縺ｿ霎ｼ縺ｿ縺ｾ縺吶°・・);
                if (!confirmedAttach) return;
                state.pendingAttachments = [];
                uiUtils.updateAttachmentBadgeVisibility();
            }

            try {
                const chat = await dbUtils.getChat(id);
                if (chat) {
                    state.currentChatId = chat.id;
                    state.currentMessages = chat.messages?.map(msg => ({
                        ...msg,
                        attachments: msg.attachments || [],
                        thoughtSummaryOpen: msg.thoughtSummaryOpen || false,
                    })) || [];

                    let needsSave = false;
                    const groupIds = new Set(state.currentMessages.filter(m => m.siblingGroupId).map(m => m.siblingGroupId));
                    groupIds.forEach(gid => {
                        const siblings = state.currentMessages.filter(m => m.siblingGroupId === gid);
                        const selected = siblings.filter(m => m.isSelected);
                        if (selected.length === 0 && siblings.length > 0) {
                            siblings[siblings.length - 1].isSelected = true;
                            needsSave = true;
                        } else if (selected.length > 1) {
                            selected.slice(0, -1).forEach(m => m.isSelected = false);
                            needsSave = true;
                        }
                    });

                    state.pendingAttachments = [];
                    state.areAllMessagesHidden = false;
                    uiUtils.updateToggleAllContentButton();
                    
                    // 繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧貞ｾｩ蜈・                    const systemMessage = state.currentMessages.find(m => m.role === 'system');
                    if (systemMessage) {
                        state.settings.commonSystemPrompt = systemMessage.content;
                        console.log('Restored system prompt from message:', systemMessage.content.substring(0, 100) + '...');
                    }
                    
                    // 繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ諠・ｱ繧貞ｾｩ蜈・                    if (chat.characterName) {
                        state.pendingCharacterName = chat.characterName;
                    } else {
                        // 繝｡繝・そ繝ｼ繧ｸ縺九ｉ繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ諠・ｱ繧貞ｾｩ蜈・                        const characterMessage = state.currentMessages.find(m => m.role === 'character');
                        if (characterMessage) {
                            state.pendingCharacterName = characterMessage.content;
                        } else {
                            state.pendingCharacterName = null;
                        }
                    }
                    
                    // 縺薙・繝√Ε繝・ヨ縺ｮ繧｢繧ｻ繝・ヨ諠・ｱ繧剃ｿ晏ｭ假ｼ・tate.settings縺ｯ譖ｴ譁ｰ縺励↑縺・ｼ・                    const chatAssetData = {
                        aiName: chat.aiName || 'AI',
                        aiIconBlob: chat.aiIconBlob || null,
                        backgroundImageBlob: chat.backgroundImageBlob || null,
                        aiIconUrl: null,  // URL縺ｯ蠕後〒菴懈・
                        backgroundImageUrl: null  // URL縺ｯ蠕後〒菴懈・
                    };
                    state.chatAssets.set(chat.id, chatAssetData);
                    
                    
                    
                    // AI蜷阪→AI繧｢繧､繧ｳ繝ｳ繧貞ｾｩ蜈・ｼ・tate.settings縺ｯ譖ｴ譁ｰ縺励↑縺・ｼ・                    if (chat.aiName) {
                        // AI蜷榊・蜉帙ヵ繧｣繝ｼ繝ｫ繝峨↓蜿肴丐
                        const aiNameInput = document.getElementById('ai-name-input');
                        if (aiNameInput) {
                            aiNameInput.value = chat.aiName;
                        }
                        // 驥崎ｦ・ state.settings.aiName縺ｯ譖ｴ譁ｰ縺励↑縺・ｼ井ｻ悶・繝√Ε繝・ヨ縺ｫ蠖ｱ髻ｿ縺吶ｋ縺溘ａ・・                        // 莉｣繧上ｊ縺ｫchatAssets縺九ｉ蜿門ｾ励☆繧・                    }
                    
                    // dirty繝輔Λ繧ｰ繧偵Μ繧ｻ繝・ヨ・医メ繝｣繝・ヨ縺九ｉ蠕ｩ蜈・＠縺溘◆繧・ｼ・                    // 驥崎ｦ・ 繝√Ε繝・ヨ蛻・ｊ譖ｿ縺域凾縺ｯ蠢・★繝ｪ繧ｻ繝・ヨ
                    state.assetDirty = { aiIcon: false, bgImage: false, aiName: false };
                    
                    // 譌｢蟄倥・繧ｰ繝ｭ繝ｼ繝舌ΝURL繧偵け繝ｪ繝ｼ繝ｳ繧｢繝・・
                    if (state.aiIconUrl && !uiUtils.isIOSSafari()) {
                        URL.revokeObjectURL(state.aiIconUrl);
                        state.aiIconUrl = null;
                    }
                    
                    // AI繧｢繧､繧ｳ繝ｳ縺ｮ陦ｨ遉ｺ繧呈峩譁ｰ・・tate.settings縺ｯ譖ｴ譁ｰ縺励↑縺・ｼ・                    const chatAssetInfo = state.chatAssets.get(chat.id);
                    if (chat.aiIconBlob) {
                        // AI繧｢繧､繧ｳ繝ｳ縺ｮBlob繝・・繧ｿ繧貞ｾｩ蜈・                        const restoredBlob = convertArrayBufferToBlob(chat.aiIconBlob);
                        if (!restoredBlob && chat.aiIconBlob) {
                            console.warn('Unknown aiIconBlob format:', typeof chat.aiIconBlob);
                        }
                        
                        if (restoredBlob && restoredBlob.size > 0) {
                            try {
                                const iconUrl = URL.createObjectURL(restoredBlob);
                                // 繝√Ε繝・ヨ蟆ら畑縺ｮURL縺ｨ縺励※菫晏ｭ・                                chatAssetInfo.aiIconUrl = iconUrl;
                                // 繧ｰ繝ｭ繝ｼ繝舌Ν縺ｫ繧りｨｭ螳夲ｼ育樟蝨ｨ縺ｮ繝√Ε繝・ヨ逕ｨ・・                                state.aiIconUrl = iconUrl;
                            } catch (e) {
                                console.warn('Failed to create icon URL:', e);
                                chatAssetInfo.aiIconUrl = null;
                                state.aiIconUrl = null;
                            }
                            
                            // AI繧｢繧､繧ｳ繝ｳ繧堤判髱｢縺ｫ蜿肴丐
                            const aiIconThumbnail = document.getElementById('ai-icon-thumbnail');
                            if (aiIconThumbnail && state.aiIconUrl) {
                                aiIconThumbnail.src = state.aiIconUrl;
                                aiIconThumbnail.style.display = 'block';
                            }
                        }
                    } else {
                        // AI繧｢繧､繧ｳ繝ｳ縺後↑縺・ｴ蜷・                        state.aiIconUrl = null;
                        const aiIconThumbnail = document.getElementById('ai-icon-thumbnail');
                        if (aiIconThumbnail) {
                            aiIconThumbnail.style.display = 'none';
                        }
                    }
                    
                    // 譌｢蟄倥・繧ｰ繝ｭ繝ｼ繝舌Ν閭梧勹URL繧偵け繝ｪ繝ｼ繝ｳ繧｢繝・・
                    if (state.backgroundImageUrl && !uiUtils.isIOSSafari()) {
                        URL.revokeObjectURL(state.backgroundImageUrl);
                        state.backgroundImageUrl = null;
                    }
                    
                    // 閭梧勹逕ｻ蜒上ｒ蠕ｩ蜈・ｼ・tate.settings縺ｯ譖ｴ譁ｰ縺励↑縺・ｼ・                    if (chat.backgroundImageBlob) {
                        const restoredBgBlob = convertArrayBufferToBlob(chat.backgroundImageBlob);
                        
                        if (restoredBgBlob && restoredBgBlob.size > 0) {
                            try {
                                const bgUrl = URL.createObjectURL(restoredBgBlob);
                                // 繝√Ε繝・ヨ蟆ら畑縺ｮURL縺ｨ縺励※菫晏ｭ・                                chatAssetInfo.backgroundImageUrl = bgUrl;
                                // 繧ｰ繝ｭ繝ｼ繝舌Ν縺ｫ繧りｨｭ螳夲ｼ育樟蝨ｨ縺ｮ繝√Ε繝・ヨ逕ｨ・・                                state.backgroundImageUrl = bgUrl;
                                // 閭梧勹逕ｻ蜒上ｒ繝√Ε繝・ヨ逕ｻ髱｢縺ｫ驕ｩ逕ｨ
                                document.documentElement.style.setProperty('--chat-background-image', `url(${state.backgroundImageUrl})`);
                            } catch (e) {
                                console.warn('Failed to create background URL:', e);
                                chatAssetInfo.backgroundImageUrl = null;
                                state.backgroundImageUrl = null;
                                document.documentElement.style.setProperty('--chat-background-image', 'none');
                            }
                            
                            // 險ｭ螳夂判髱｢縺ｮ繧ｵ繝繝阪う繝ｫ繧呈峩譁ｰ
                            uiUtils.updateBackgroundSettingsUI();
                            uiUtils.updatePromptBackgroundDisplay();
                        }
                    } else {
                        // 閭梧勹逕ｻ蜒上′縺ｪ縺・ｴ蜷・                        state.backgroundImageUrl = null;
                        document.documentElement.style.setProperty('--chat-background-image', 'none');
                        uiUtils.updateBackgroundSettingsUI();
                        uiUtils.updatePromptBackgroundDisplay();
                    }
                    
                    // 繝√Ε繝・ヨ蟆ら畑繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧貞ｾｩ蜈・                    if (chat.chatSystemPrompt) {
                        state.chatSystemPrompt = chat.chatSystemPrompt;
                    } else {
                        state.chatSystemPrompt = null;
                    }
                    
                    // 繝√Ε繝・ヨ蟆ら畑繝・・繝槭ｒ蠕ｩ蜈・・驕ｩ逕ｨ
                    if (chat.theme) {
                        state.currentChatTheme = chat.theme;
                        uiUtils.applyTheme(chat.theme);
                    } else {
                        state.currentChatTheme = null;
                        uiUtils.applyTheme(state.settings.theme);
                    }
                    
                    state.messageCollapsedStates.clear();
                    state.thoughtSummaryOpenStates.clear();
                    if (state.settings.persistMessageCollapseState && chat.collapsedStates) {
                        Object.entries(chat.collapsedStates).forEach(([idx, isCollapsed]) => {
                            state.messageCollapsedStates.set(parseInt(idx, 10), isCollapsed);
                        });
                    }
                     (chat.messages || []).forEach((msg, idx) => {
                        if (msg.thoughtSummaryOpen !== undefined) {
                            state.thoughtSummaryOpenStates.set(idx, msg.thoughtSummaryOpen);
                        }
                    });

                    uiUtils.renderChatMessages();
                    uiUtils.updateChatTitle(chat.title);
                    
                    // AI繧｢繧､繧ｳ繝ｳ縺ｮ陦ｨ遉ｺ繧呈峩譁ｰ・医Γ繝・そ繝ｼ繧ｸ陦ｨ遉ｺ蠕鯉ｼ・                    if (state.aiIconUrl) {
                        setTimeout(() => {
                            const aiIconThumbnail = document.getElementById('ai-icon-thumbnail');
                            if (aiIconThumbnail) {
                                aiIconThumbnail.src = state.aiIconUrl;
                                aiIconThumbnail.style.display = 'block';
                            }
                        }, 100);
                    }
                    
                    // 繝√Ε繝・ヨ蛻・ｊ譖ｿ縺域凾縺ｫ繝輔ぃ繧､繝ｫ蜈･蜉帙ヵ繧｣繝ｼ繝ｫ繝峨ｒ繧ｯ繝ｪ繧｢
                    const chatAiIconInput = document.getElementById('chat-ai-icon');
                    if (chatAiIconInput) {
                        chatAiIconInput.value = '';
                    }
                    const chatBackgroundImageInput = document.getElementById('chat-background-image');
                    if (chatBackgroundImageInput) {
                        chatBackgroundImageInput.value = '';
                    }
                    elements.userInput.value = '';
                    uiUtils.adjustTextareaHeight();
                    uiUtils.setSendingState(false);
                    uiUtils.updateAttachmentBadgeVisibility();
                    elements.memoEditor.value = '';
                    if (needsSave) {
                        await dbUtils.saveChat();
                    }
                    // 蛻晄悄蛹匁凾莉･螟悶・繝√Ε繝・ヨ逕ｻ髱｢縺ｫ遘ｻ陦・                    if (state.currentScreen !== 'home') {
                        history.replaceState({ screen: 'chat' }, '', '#chat');
                        state.currentScreen = 'chat';
                    }
                    if (state.settings.autoScrollOnNewMessage && state.currentMessages.length > 0) {
                        uiUtils.scrollToBottom();
                    }
                } else {
                    await uiUtils.showCustomAlert("繝√Ε繝・ヨ螻･豁ｴ縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ縺ｧ縺励◆縲・);
                    this.startNewChat();
                    if (state.currentScreen !== 'home') {
                        uiUtils.showScreen('chat');
                    }
                }
            } catch (error) {
                await uiUtils.showCustomAlert(`繝√Ε繝・ヨ縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ繧ｨ繝ｩ繝ｼ: ${error}`);
                this.startNewChat();
                if (state.currentScreen !== 'home') {
                    uiUtils.showScreen('chat');
                }
            }
        },
        async duplicateChat(id) {
            if (state.isSending) { const conf = await uiUtils.showCustomConfirm("騾∽ｿ｡荳ｭ縺ｧ縺吶ゆｸｭ譁ｭ縺励※繝√Ε繝・ヨ繧定､・｣ｽ縺励∪縺吶°・・); if (!conf) return; this.abortRequest(); }
            if (state.editingMessageIndex !== null) { const conf = await uiUtils.showCustomConfirm("邱ｨ髮・ｸｭ縺ｧ縺吶ょ､画峩繧堤ｴ譽・＠縺ｦ繝√Ε繝・ヨ繧定､・｣ｽ縺励∪縺吶°・・); if (!conf) return; const msgEl = elements.messageContainer.querySelector(`.message[data-index="${state.editingMessageIndex}"]`); this.cancelEditMessage(state.editingMessageIndex, msgEl); }
            if ((state.currentMessages.length > 0) && state.currentChatId && state.currentChatId !== id) { try { await dbUtils.saveChat(); } catch (error) { const conf = await uiUtils.showCustomConfirm("迴ｾ蝨ｨ縺ｮ繝√Ε繝・ヨ菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆縲り､・｣ｽ繧堤ｶ夊｡後＠縺ｾ縺吶°・・); if (!conf) return; } }
            if (state.pendingAttachments.length > 0) {
                const confirmedAttach = await uiUtils.showCustomConfirm("豺ｻ莉俶ｺ門ｙ荳ｭ縺ｮ繝輔ぃ繧､繝ｫ縺後≠繧翫∪縺吶らｴ譽・＠縺ｦ繝√Ε繝・ヨ繧定､・｣ｽ縺励∪縺吶°・・);
                if (!confirmedAttach) return;
                state.pendingAttachments = [];
            }

            try {
                const chat = await dbUtils.getChat(id);
                if (chat) {
                    const originalTitle = chat.title || "辟｡鬘後・繝√Ε繝・ヨ";
                    const newTitle = originalTitle.replace(new RegExp(DUPLICATE_SUFFIX.replace(/([().])/g, '\\$1') + '$'), '').trim() + DUPLICATE_SUFFIX;

                    const groupIdMap = new Map();
                    const duplicatedMessages = [];

                    (chat.messages || []).forEach(msg => {
                        const newMsg = JSON.parse(JSON.stringify(msg));
                        newMsg.attachments = msg.attachments ? JSON.parse(JSON.stringify(msg.attachments)) : [];
                        newMsg.isCascaded = msg.isCascaded ?? false;
                        newMsg.isSelected = msg.isSelected ?? false;
                        newMsg.thoughtSummaryOpen = msg.thoughtSummaryOpen || false;

                        if (msg.siblingGroupId) {
                            if (!groupIdMap.has(msg.siblingGroupId)) {
                                groupIdMap.set(msg.siblingGroupId, `dup-${Date.now()}-${Math.random().toString(36).substring(2, 8)}`);
                            }
                            newMsg.siblingGroupId = groupIdMap.get(msg.siblingGroupId);
                        } else {
                            delete newMsg.siblingGroupId;
                        }
                        duplicatedMessages.push(newMsg);
                    });

                    const newGroupIds = new Set(duplicatedMessages.filter(m => m.siblingGroupId).map(m => m.siblingGroupId));
                    newGroupIds.forEach(gid => {
                        const siblings = duplicatedMessages.filter(m => m.siblingGroupId === gid);
                        siblings.forEach((m, idx) => {
                            m.isSelected = (idx === siblings.length - 1);
                        });
                    });

                    const newChatData = {
                        messages: duplicatedMessages,
                        updatedAt: Date.now(),
                        createdAt: Date.now(),
                        title: newTitle
                    };

                    if (state.settings.persistMessageCollapseState && chat.collapsedStates) {
                        newChatData.collapsedStates = { ...chat.collapsedStates };
                    }

                    const newChatId = await new Promise((resolve, reject) => {
                        const store = dbUtils._getStore(CHATS_STORE, 'readwrite');
                        const request = store.add(newChatData);
                        request.onsuccess = (event) => resolve(event.target.result);
                        request.onerror = (event) => reject(event.target.error);
                    });

                    if (state.currentScreen === 'history') {
                        uiUtils.renderHistoryList();
                    } else {
                        await uiUtils.showCustomAlert(`繝√Ε繝・ヨ縲・{newTitle}縲阪ｒ隍・｣ｽ縺励∪縺励◆縲Ａ);
                    }
                } else {
                    await uiUtils.showCustomAlert("隍・｣ｽ蜈・・繝√Ε繝・ヨ縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ縲・);
                }
            } catch (error) {
                await uiUtils.showCustomAlert(`繝√Ε繝・ヨ隍・｣ｽ繧ｨ繝ｩ繝ｼ: ${error}`);
            }
        },
        async exportChat(chatId, chatTitle) {
             const confirmed = await uiUtils.showCustomConfirm(`繝√Ε繝・ヨ縲・{chatTitle || '縺薙・螻･豁ｴ'}縲阪ｒ繝・く繧ｹ繝亥・蜉帙＠縺ｾ縺吶°・歔);
             if (!confirmed) return;

             try {
                 const chat = await dbUtils.getChat(chatId);
                 if (!chat || ((!chat.messages || chat.messages.length === 0))) {
                     await uiUtils.showCustomAlert("繝√Ε繝・ヨ繝・・繧ｿ縺檎ｩｺ縺ｧ縺吶・);
                     return;
                 }

                 let exportText = '';
                 
                 // 繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧偵お繧ｯ繧ｹ繝昴・繝医↓霑ｽ蜉
                 let systemPrompt = null;
                 
                 // 繝√Ε繝・ヨ蝗ｺ譛峨・繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧偵メ繧ｧ繝・け
                 if (chat.chatSystemPrompt && chat.chatSystemPrompt.trim()) {
                     systemPrompt = chat.chatSystemPrompt.trim();
                 } else if (chat.messages) {
                     // 繝｡繝・そ繝ｼ繧ｸ蜀・°繧峨す繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧呈爾縺・                     const systemMessage = chat.messages.find(m => m.role === 'system');
                     if (systemMessage && systemMessage.content) {
                         systemPrompt = systemMessage.content;
                     }
                 }
                 
                 // 繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ縺後≠繧句ｴ蜷医・譛蛻昴↓霑ｽ蜉
                 if (systemPrompt) {
                     exportText += `<|#|system|#|>\n${systemPrompt}\n<|#|/system|#|>\n\n`;
                 }
                 
                 if (chat.messages) {
                     chat.messages.forEach(msg => {
                         // 繧ｷ繧ｹ繝・Β繝｡繝・そ繝ｼ繧ｸ縺ｯ譌｢縺ｫ荳翫〒蜃ｦ逅・＠縺溘・縺ｧ繧ｹ繧ｭ繝・・
                         if (msg.role === 'system') return;
                         
                         if (msg.role === 'user' || msg.role === 'model' || msg.role === 'character') {
                             let attributes = '';
                             if (msg.role === 'model') {
                                 if (msg.isCascaded) attributes += ' isCascaded';
                                 if (msg.isSelected) attributes += ' isSelected';
                                 if (msg.thoughtSummaryOpen) attributes += ' thoughtOpen';
                             }
                             if (msg.role === 'user' && msg.attachments && msg.attachments.length > 0) {
                                 const fileNames = msg.attachments.map(a => a.name).join(';');
                                 attributes += ` attachments="${fileNames.replace(/"/g, '"')}"`;
                             }
                             exportText += `<|#|${msg.role}|#|${attributes.trim()}>\n${msg.content}\n<|#|/${msg.role}|#|>\n\n`;
                         }
                     });
                 }

                 const blob = new Blob([exportText.trim()], { type: 'text/plain;charset=utf-8' });
                 const url = URL.createObjectURL(blob);
                 const a = document.createElement('a');
                 const safeTitle = (chatTitle || `chat_${chatId}_export`).replace(/[<>:"/\\|?*\s]/g, '_');
                 a.href = url;
                 a.download = `${safeTitle}.txt`;
                 document.body.appendChild(a);
                 a.click();
                 document.body.removeChild(a);
                 URL.revokeObjectURL(url);
             } catch (error) {
                 await uiUtils.showCustomAlert(`繧ｨ繧ｯ繧ｹ繝昴・繝医お繝ｩ繝ｼ: ${error}`);
             }
        },
        async confirmDeleteCurrentSession() {
            if (!state.currentChatId && state.currentMessages.length === 0) {
                await uiUtils.showCustomAlert("蜑企勁縺吶ｋ繝√Ε繝・ヨ縺後≠繧翫∪縺帙ｓ・域眠隕上メ繝｣繝・ヨ迥ｶ諷九〒縺呻ｼ峨・);
                return;
            }
            if (state.isSending) {
                await uiUtils.showCustomAlert("騾∽ｿ｡荳ｭ縺ｧ縺吶ょｮ御ｺ・ｾ後↓蜀榊ｺｦ縺願ｩｦ縺励￥縺縺輔＞縲・);
                return;
            }
            if (state.editingMessageIndex !== null) {
                await uiUtils.showCustomAlert("繝｡繝・そ繝ｼ繧ｸ邱ｨ髮・ｸｭ縺ｧ縺吶ょｮ御ｺ・ｾ後↓蜀榊ｺｦ縺願ｩｦ縺励￥縺縺輔＞縲・);
                return;
            }
            const chatTitle = elements.chatTitle.textContent.startsWith("譁ｰ隕上メ繝｣繝・ヨ") ? "縺薙・繝√Ε繝・ヨ" : `繝√Ε繝・ヨ縲・{elements.chatTitle.textContent.replace(/^: /, '')}縲港;
            const confirmed = await uiUtils.showCustomConfirm(
                `${chatTitle}繧貞ｮ悟・縺ｫ蜑企勁縺励∪縺吶°・歃n縺薙・謫堺ｽ懊・蜈・↓謌ｻ縺帙∪縺帙ｓ縲Ａ
            );
            if (confirmed) {
                await this.deleteCurrentSession();
            }
        },
        async deleteCurrentSession() {
            try {
                if (state.currentChatId) {
                    await dbUtils.deleteChat(state.currentChatId);
                }
                this.startNewChat();
                await uiUtils.showCustomAlert("繝√Ε繝・ヨ繧貞炎髯､縺励∪縺励◆縲・);
            } catch (error) {
                await uiUtils.showCustomAlert(`繝√Ε繝・ヨ縺ｮ蜑企勁荳ｭ縺ｫ繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆: ${error}`);
            }
        },
        async copyCurrentSessionText() {
            if (state.currentMessages.length === 0) {
                await uiUtils.showCustomAlert("繧ｳ繝斐・縺吶ｋ蜀・ｮｹ縺後≠繧翫∪縺帙ｓ縲・);
                return;
            }

            let sessionText = "";
            state.currentMessages.forEach(msg => {
                if (msg.role === 'user') {
                    sessionText += `縺ゅ↑縺・\n`;
                } else if (msg.role === 'model') {
                    sessionText += `繝｢繝・Ν:\n`;
                } else if (msg.role === 'error') {
                    sessionText += `繧ｨ繝ｩ繝ｼ:\n`;
                }
                sessionText += `${msg.content}\n\n`;
                if (msg.attachments && msg.attachments.length > 0) {
                    sessionText += `  [豺ｻ莉倥ヵ繧｡繧､繝ｫ: ${msg.attachments.map(a => a.name).join(', ')}]\n\n`;
                }
            });

            try {
                await navigator.clipboard.writeText(sessionText.trim());
                const buttonElement = elements.copySessionBtn;
                const originalText = buttonElement.textContent;
                buttonElement.textContent = '笨・;
                buttonElement.disabled = true;
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.disabled = false;
                }, 1500);
            } catch (err) {
                await uiUtils.showCustomAlert("繧ｯ繝ｪ繝・・繝懊・繝峨∈縺ｮ繧ｳ繝斐・縺ｫ螟ｱ謨励＠縺ｾ縺励◆縲・n縺贋ｽｿ縺・・繝悶Λ繧ｦ繧ｶ縺悟ｯｾ蠢懊＠縺ｦ縺・↑縺・°縲√そ繧ｭ繝･繝ｪ繝・ぅ險ｭ螳壹′蜴溷屏縺ｮ蜿ｯ閭ｽ諤ｧ縺後≠繧翫∪縺吶・);
                const buttonElement = elements.copySessionBtn;
                const originalText = buttonElement.textContent;
                buttonElement.textContent = '繧ｳ繝斐・螟ｱ謨・;
                buttonElement.disabled = true;
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.disabled = false;
                }, 2000);
            }
        },
        async confirmDeleteChat(id, title) {
             const confirmed = await uiUtils.showCustomConfirm(`縲・{title || '縺薙・螻･豁ｴ'}縲阪ｒ蜑企勁縺励∪縺吶°・歔);
             if (confirmed) {
                const isDeletingCurrent = state.currentChatId === id;
                const currentScreenBeforeDelete = state.currentScreen;
                try {
                    await dbUtils.deleteChat(id);
                    if (isDeletingCurrent) {
                        this.startNewChat();
                    }
                    if (currentScreenBeforeDelete === 'history') {
                        await uiUtils.renderHistoryList();
                        const listIsEmpty = elements.historyList.querySelectorAll('.history-item:not(.js-history-item-template)').length === 0;
                        if (listIsEmpty) {
                            if (!isDeletingCurrent) {
                                this.startNewChat();
                            }
                        }
                    }
                } catch (error) {
                    await uiUtils.showCustomAlert(`繝√Ε繝・ヨ蜑企勁繧ｨ繝ｩ繝ｼ: ${error}`);
                    uiUtils.setSendingState(false);
                }
            }
        },
        async editHistoryTitle(chatId, titleElement) {
            const currentTitle = titleElement.textContent;
            const newTitle = await uiUtils.showCustomPrompt("譁ｰ縺励＞繧ｿ繧､繝医Ν:", currentTitle);
            const trimmedTitle = (newTitle !== null) ? sanitizeText(newTitle, 100).trim() : '';

            if (newTitle !== '' && trimmedTitle !== '' && trimmedTitle !== currentTitle) {
                const finalTitle = trimmedTitle;
                try {
                    await dbUtils.updateChatTitleDb(chatId, finalTitle);
                    titleElement.textContent = finalTitle;
                    titleElement.title = finalTitle;
                    const dateElement = titleElement.closest('.history-item')?.querySelector('.updated-date');
                    if(dateElement) dateElement.textContent = `譖ｴ譁ｰ: ${uiUtils.formatDate(Date.now())}`;

                    if (state.currentChatId === chatId) {
                        uiUtils.updateChatTitle(finalTitle);
                    }
                } catch (error) {
                    await uiUtils.showCustomAlert(`繧ｿ繧､繝医Ν譖ｴ譁ｰ繧ｨ繝ｩ繝ｼ: ${error}`);
                }
            }
        },
        async handleSend(isRetry = false, retryUserMessageIndex = -1, sourceSessionContext = null) {
            const isBackgroundProcess = !!sourceSessionContext;
            const selectedApiProvider = isBackgroundProcess ? (sourceSessionContext.apiProvider || state.settings.apiProvider) : state.settings.apiProvider;

            let text = '';
            let attachmentsToSend = [];
            if (isBackgroundProcess) {
                text = sourceSessionContext.inputText || '';
                attachmentsToSend = sourceSessionContext.attachments ? [...sourceSessionContext.attachments] : [];
            } else if (isRetry) {
                const retryUserMessage = state.currentMessages[retryUserMessageIndex];
                if (!retryUserMessage || retryUserMessage.role !== 'user') {
                    uiUtils.setSendingState(false);
                    return;
                }
                text = retryUserMessage.content || '';
                attachmentsToSend = retryUserMessage.attachments ? [...retryUserMessage.attachments] : [];
            } else {
                text = elements.userInput.value.trim();
                attachmentsToSend = [...state.pendingAttachments];
            }

            if (!isBackgroundProcess) {
                const isInputEmpty = text.trim() === '';
                const hasAttachments = attachmentsToSend.length > 0;
                const isDummyProvider = selectedApiProvider === 'dummy';

                if (state.isSending) {
                    return;
                }

                if (!isDummyProvider && isInputEmpty && !hasAttachments) {
                    return;
                }
            }
            
            if (selectedApiProvider === 'dummy') {
                let dummyResponseContent = '';
                if (state.settings.dummyEnableDummyModel && state.settings.dummyDummyModel) {
                    dummyResponseContent += state.settings.dummyDummyModel;
                }
                if (state.settings.dummyErrorDebugMode) {
                    const errorLog = errorRecovery.getErrorLogAsString();
                    if (dummyResponseContent) {
                        dummyResponseContent += '\n\n';
                    }
                    dummyResponseContent += errorLog;
                }

                if (isBackgroundProcess) {
                    return { content: dummyResponseContent, metadata: { finishReason: 'stop' } };
                }

                uiUtils.setSendingState(true);
                if (isRetry) {
                    if (retryUserMessageIndex + 1 < state.currentMessages.length) {
                        state.currentMessages.splice(retryUserMessageIndex + 1);
                    }
                    uiUtils.renderChatMessages(true);
                } else {
                    // 譁ｰ縺励＞繝√Ε繝・ヨ縺ｮ蝣ｴ蜷医√す繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ縺ｨ繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ諠・ｱ繧定ｿｽ蜉
                    if (state.currentMessages.length === 0) {
                        // 繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧定ｿｽ蜉
                        const systemPrompt = state.settings.commonSystemPrompt;
                        if (systemPrompt && systemPrompt.trim()) {
                            const systemMessage = {
                                role: 'system',
                                content: systemPrompt.trim(),
                                timestamp: Date.now(),
                                generatedByApiProvider: null
                            };
                            state.currentMessages.push(systemMessage);
                            console.log('Added system message:', systemPrompt.substring(0, 100) + '...');
                        }
                        
                        // 繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ諠・ｱ繧定ｿｽ蜉
                        if (state.pendingCharacterName) {
                            const characterMessage = {
                                role: 'character',
                                content: state.pendingCharacterName,
                                timestamp: Date.now(),
                                generatedByApiProvider: null
                            };
                            state.currentMessages.push(characterMessage);
                        }
                    }
                    
                    const userMessage = {
                        role: 'user', content: text, timestamp: Date.now(),
                        attachments: attachmentsToSend, generatedByApiProvider: null
                    };
                    state.currentMessages.push(userMessage);
                    const userMessageIndex = state.currentMessages.length - 1;
                    uiUtils.appendMessage(userMessage.role, userMessage.content, userMessageIndex, false, null, userMessage.attachments);
                    elements.userInput.value = '';
                    state.pendingAttachments = [];
                    uiUtils.adjustTextareaHeight();
                    uiUtils.updateAttachmentBadgeVisibility();
                }
                
                const modelMessage = {
                    role: 'model', content: dummyResponseContent, timestamp: Date.now(), generatedByApiProvider: 'dummy'
                };
                state.currentMessages.push(modelMessage);
                const modelMessageIndex = state.currentMessages.length - 1;
                uiUtils.appendMessage(modelMessage.role, modelMessage.content, modelMessageIndex);
                
                // 荳蠎ｦ縺縺台ｿ晏ｭ倥☆繧・                await dbUtils.saveChat();
                await sleep(300 + Math.random() * 400);
                uiUtils.setSendingState(false);
                if (state.settings.autoScrollOnNewMessage) uiUtils.scrollToBottom();
                return;
            }

            let currentContextSessionId = isBackgroundProcess ? sourceSessionContext.sessionId : state.currentChatId;
            let currentContextMessages = isBackgroundProcess ? [...sourceSessionContext.messages] : [...state.currentMessages];
            let currentContextSystemPrompt = '';

            if (isBackgroundProcess) {
                currentContextSystemPrompt = sourceSessionContext.systemPrompt || '';
            } else {
                let individualPrompt = '';
                let commonPrompt = '';

                if (selectedApiProvider === 'gemini' && state.settings.geminiEnableSystemPromptDefault) {
                    individualPrompt = state.settings.geminiSystemPrompt.trim();
                } else if (selectedApiProvider === 'deepseek' && state.settings.deepSeekEnableSystemPromptDefault) {
                    individualPrompt = state.settings.deepSeekSystemPrompt.trim();
                } else if (selectedApiProvider === 'claude' && state.settings.claudeEnableSystemPromptDefault) {
                    individualPrompt = state.settings.claudeSystemPrompt.trim();
                } else if (selectedApiProvider === 'openai' && state.settings.openaiEnableSystemPromptDefault) {
                    individualPrompt = state.settings.openaiSystemPrompt.trim();
                } else if (selectedApiProvider === 'xai' && state.settings.xaiEnableSystemPromptDefault) {
                    individualPrompt = state.settings.xaiSystemPrompt.trim();
                } else if (selectedApiProvider === 'llmaggregator' && state.settings.llmAggregatorEnableSystemPromptDefault) {
                    individualPrompt = state.settings.llmAggregatorSystemPrompt.trim();
                }
                
                if (state.settings.enableCommonSystemPromptDefault) {
                    commonPrompt = state.settings.commonSystemPrompt.trim();
                }
                
                // 繝√Ε繝・ヨ蟆ら畑繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧呈怙蜆ｪ蜈医〒菴ｿ逕ｨ
                if (state.chatSystemPrompt && state.chatSystemPrompt.trim()) {
                    currentContextSystemPrompt = state.chatSystemPrompt.trim();
                } else if (individualPrompt) {
                    currentContextSystemPrompt = individualPrompt;
                } else if (commonPrompt) {
                    currentContextSystemPrompt = commonPrompt;
                } else {
                    currentContextSystemPrompt = '';
                }
            }
            
            let contextTemperature, contextMaxTokens, contextTopP,
                contextPresencePenalty, contextFrequencyPenalty,
                contextStreamingOutput, contextStreamingSpeed,
                contextDummyUser, contextEnableDummyUser,
                contextDummyModel, contextEnableDummyModel, contextConcatDummyModel;

            let contextGeminiTopK, contextGeminiThinkingBudget, contextGeminiIncludeThoughts,
                contextGeminiPseudoStreaming, contextGeminiEnableGrounding;

            let contextDeepSeekIncludeThoughts;

            let contextClaudeTopK, contextClaudeIncludeThoughts, contextClaudeThinkingBudget, contextClaudeExpandThoughtsByDefault;
            
            let contextXaiVisionEnable, contextXaiIncludeThoughts, contextXaiReasoningEffort;
            
            let contextLlmAggregatorTopK;

            if (isBackgroundProcess) {
                const providerForSettingsB = sourceSessionContext.apiProvider || state.settings.apiProvider;
                if (providerForSettingsB === 'gemini') {
                    contextTemperature = sourceSessionContext.temperature ?? state.settings.geminiTemperature;
                    contextMaxTokens = sourceSessionContext.maxTokens ?? state.settings.geminiMaxTokens;
                    contextGeminiTopK = sourceSessionContext.topK ?? state.settings.geminiTopK;
                    contextTopP = sourceSessionContext.topP ?? state.settings.geminiTopP;
                    contextPresencePenalty = sourceSessionContext.presencePenalty ?? state.settings.geminiPresencePenalty;
                    contextFrequencyPenalty = sourceSessionContext.frequencyPenalty ?? state.settings.geminiFrequencyPenalty;
                    contextGeminiThinkingBudget = sourceSessionContext.thinkingBudget ?? state.settings.geminiThinkingBudget;
                    contextGeminiIncludeThoughts = sourceSessionContext.includeThoughts ?? state.settings.geminiIncludeThoughts;
                    contextStreamingOutput = sourceSessionContext.streamingOutput ?? state.settings.geminiStreamingOutput;
                    contextStreamingSpeed = sourceSessionContext.streamingSpeed ?? state.settings.geminiStreamingSpeed;
                    contextDummyUser = sourceSessionContext.dummyUser ?? state.settings.geminiDummyUser;
                    contextEnableDummyUser = sourceSessionContext.enableDummyUser ?? state.settings.geminiEnableDummyUser;
                    contextDummyModel = sourceSessionContext.dummyModel ?? state.settings.geminiDummyModel;
                    contextEnableDummyModel = sourceSessionContext.enableDummyModel ?? state.settings.geminiEnableDummyModel;
                    contextConcatDummyModel = sourceSessionContext.concatDummyModel ?? state.settings.geminiConcatDummyModel;
                    contextGeminiPseudoStreaming = sourceSessionContext.pseudoStreaming ?? state.settings.geminiPseudoStreaming;
                    contextGeminiEnableGrounding = sourceSessionContext.enableGrounding ?? state.settings.geminiEnableGrounding;
                } else if (providerForSettingsB === 'deepseek') {
                    contextTemperature = sourceSessionContext.temperature ?? state.settings.deepSeekTemperature;
                    contextMaxTokens = sourceSessionContext.maxTokens ?? state.settings.deepSeekMaxTokens;
                    contextTopP = sourceSessionContext.topP ?? state.settings.deepSeekTopP;
                    contextPresencePenalty = sourceSessionContext.presencePenalty ?? state.settings.deepSeekPresencePenalty;
                    contextFrequencyPenalty = sourceSessionContext.frequencyPenalty ?? state.settings.deepSeekFrequencyPenalty;
                    contextDeepSeekIncludeThoughts = sourceSessionContext.includeDeepSeekThoughts ?? state.settings.deepSeekIncludeDeepSeekThoughts;
                    contextStreamingOutput = sourceSessionContext.streamingOutput ?? state.settings.deepSeekStreamingOutput;
                    contextStreamingSpeed = sourceSessionContext.streamingSpeed ?? state.settings.deepSeekStreamingSpeed;
                    contextDummyUser = sourceSessionContext.dummyUser ?? state.settings.deepSeekDummyUser;
                    contextEnableDummyUser = sourceSessionContext.enableDummyUser ?? state.settings.deepSeekEnableDummyUser;
                    contextDummyModel = sourceSessionContext.dummyModel ?? state.settings.deepSeekDummyModel;
                    contextEnableDummyModel = sourceSessionContext.enableDummyModel ?? state.settings.deepSeekEnableDummyModel;
                    contextConcatDummyModel = sourceSessionContext.concatDummyModel ?? state.settings.deepSeekConcatDummyModel;
                } else if (providerForSettingsB === 'llmaggregator') {
                    contextTemperature = sourceSessionContext.temperature ?? state.settings.llmAggregatorTemperature;
                    contextMaxTokens = sourceSessionContext.maxTokens ?? state.settings.llmAggregatorMaxTokens;
                    contextTopP = sourceSessionContext.topP ?? state.settings.llmAggregatorTopP;
                    contextLlmAggregatorTopK = sourceSessionContext.topK ?? state.settings.llmAggregatorTopK;
                    contextPresencePenalty = sourceSessionContext.presencePenalty ?? state.settings.llmAggregatorPresencePenalty;
                    contextFrequencyPenalty = sourceSessionContext.frequencyPenalty ?? state.settings.llmAggregatorFrequencyPenalty;
                    contextDeepSeekIncludeThoughts = sourceSessionContext.includeThoughts ?? state.settings.llmAggregatorIncludeThoughts;
                    contextStreamingOutput = sourceSessionContext.streamingOutput ?? state.settings.llmAggregatorStreamingOutput;
                    contextStreamingSpeed = sourceSessionContext.streamingSpeed ?? state.settings.llmAggregatorStreamingSpeed;
                    contextDummyUser = sourceSessionContext.dummyUser ?? state.settings.llmAggregatorDummyUser;
                    contextEnableDummyUser = sourceSessionContext.enableDummyUser ?? state.settings.llmAggregatorEnableDummyUser;
                    contextDummyModel = sourceSessionContext.dummyModel ?? state.settings.llmAggregatorDummyModel;
                    contextEnableDummyModel = sourceSessionContext.enableDummyModel ?? state.settings.llmAggregatorEnableDummyModel;
                    contextConcatDummyModel = sourceSessionContext.concatDummyModel ?? state.settings.llmAggregatorConcatDummyModel;
                } else if (providerForSettingsB === 'claude') {
                    contextTemperature = sourceSessionContext.temperature ?? state.settings.claudeTemperature;
                    contextMaxTokens = sourceSessionContext.maxTokens ?? state.settings.claudeMaxTokens;
                    contextClaudeTopK = sourceSessionContext.topK ?? state.settings.claudeTopK;
                    contextTopP = sourceSessionContext.topP ?? state.settings.claudeTopP;
                    contextStreamingOutput = sourceSessionContext.streamingOutput ?? state.settings.claudeStreamingOutput;
                    contextStreamingSpeed = sourceSessionContext.streamingSpeed ?? state.settings.claudeStreamingSpeed;
                    contextDummyUser = sourceSessionContext.dummyUser ?? state.settings.claudeDummyUser;
                    contextEnableDummyUser = sourceSessionContext.enableDummyUser ?? state.settings.claudeEnableDummyUser;
                    contextDummyModel = sourceSessionContext.dummyModel ?? state.settings.claudeDummyModel;
                    contextEnableDummyModel = sourceSessionContext.enableDummyModel ?? state.settings.claudeEnableDummyModel;
                    contextConcatDummyModel = sourceSessionContext.concatDummyModel ?? state.settings.claudeConcatDummyModel;
                    contextClaudeIncludeThoughts = sourceSessionContext.includeThoughts ?? state.settings.claudeIncludeThoughts;
                    contextClaudeThinkingBudget = sourceSessionContext.thinkingBudget ?? state.settings.claudeThinkingBudget;
                    contextClaudeExpandThoughtsByDefault = sourceSessionContext.expandThoughtsByDefault ?? state.settings.claudeExpandThoughtsByDefault;
                } else if (providerForSettingsB === 'openai') {
                    contextTemperature = sourceSessionContext.temperature ?? state.settings.openaiTemperature;
                    contextMaxTokens = sourceSessionContext.maxTokens ?? state.settings.openaiMaxTokens;
                    contextTopP = sourceSessionContext.topP ?? state.settings.openaiTopP;
                    contextPresencePenalty = sourceSessionContext.presencePenalty ?? state.settings.openaiPresencePenalty;
                    contextFrequencyPenalty = sourceSessionContext.frequencyPenalty ?? state.settings.openaiFrequencyPenalty;
                    contextStreamingOutput = sourceSessionContext.streamingOutput ?? state.settings.openaiStreamingOutput;
                    contextStreamingSpeed = sourceSessionContext.streamingSpeed ?? state.settings.openaiStreamingSpeed;
                    contextDummyUser = sourceSessionContext.dummyUser ?? state.settings.openaiDummyUser;
                    contextEnableDummyUser = sourceSessionContext.enableDummyUser ?? state.settings.openaiEnableDummyUser;
                    contextDummyModel = sourceSessionContext.dummyModel ?? state.settings.openaiDummyModel;
                    contextEnableDummyModel = sourceSessionContext.enableDummyModel ?? state.settings.openaiEnableDummyModel;
                    contextConcatDummyModel = sourceSessionContext.concatDummyModel ?? state.settings.openaiConcatDummyModel;
                } else if (providerForSettingsB === 'xai') {
                    contextTemperature = sourceSessionContext.temperature ?? state.settings.xaiTemperature;
                    contextMaxTokens = sourceSessionContext.maxTokens ?? state.settings.xaiMaxTokens;
                    contextTopP = sourceSessionContext.topP ?? state.settings.xaiTopP;
                    contextPresencePenalty = sourceSessionContext.presencePenalty ?? state.settings.xaiPresencePenalty;
                    contextFrequencyPenalty = sourceSessionContext.frequencyPenalty ?? state.settings.xaiFrequencyPenalty;
                    contextStreamingOutput = sourceSessionContext.streamingOutput ?? state.settings.xaiStreamingOutput;
                    contextStreamingSpeed = sourceSessionContext.streamingSpeed ?? state.settings.xaiStreamingSpeed;
                    contextDummyUser = sourceSessionContext.dummyUser ?? state.settings.xaiDummyUser;
                    contextEnableDummyUser = sourceSessionContext.enableDummyUser ?? state.settings.xaiEnableDummyUser;
                    contextDummyModel = sourceSessionContext.dummyModel ?? state.settings.xaiDummyModel;
                    contextEnableDummyModel = sourceSessionContext.enableDummyModel ?? state.settings.xaiEnableDummyModel;
                    contextConcatDummyModel = sourceSessionContext.concatDummyModel ?? state.settings.xaiConcatDummyModel;
                    contextXaiVisionEnable = sourceSessionContext.visionEnable ?? state.settings.xaiVisionEnable;
                    contextXaiIncludeThoughts = sourceSessionContext.includeThoughts ?? state.settings.xaiIncludeThoughts;
                    contextXaiReasoningEffort = sourceSessionContext.reasoningEffort ?? state.settings.xaiReasoningEffort;
                }
            } else {
                if (selectedApiProvider === 'gemini') {
                    contextTemperature = state.settings.geminiTemperature;
                    contextMaxTokens = state.settings.geminiMaxTokens;
                    contextGeminiTopK = state.settings.geminiTopK;
                    contextTopP = state.settings.geminiTopP;
                    contextPresencePenalty = state.settings.geminiPresencePenalty;
                    contextFrequencyPenalty = state.settings.geminiFrequencyPenalty;
                    contextGeminiThinkingBudget = state.settings.geminiThinkingBudget;
                    contextGeminiIncludeThoughts = state.settings.geminiIncludeThoughts;
                    contextStreamingOutput = state.settings.geminiStreamingOutput;
                    contextStreamingSpeed = state.settings.geminiStreamingSpeed;
                    contextDummyUser = state.settings.geminiDummyUser;
                    contextEnableDummyUser = state.settings.geminiEnableDummyUser;
                    contextDummyModel = state.settings.geminiDummyModel;
                    contextEnableDummyModel = state.settings.geminiEnableDummyModel;
                    contextConcatDummyModel = state.settings.geminiConcatDummyModel;
                    contextGeminiPseudoStreaming = state.settings.geminiPseudoStreaming;
                    contextGeminiEnableGrounding = state.settings.geminiEnableGrounding;
                } else if (selectedApiProvider === 'deepseek') {
                    contextTemperature = state.settings.deepSeekTemperature;
                    contextMaxTokens = state.settings.deepSeekMaxTokens;
                    contextTopP = state.settings.deepSeekTopP;
                    contextPresencePenalty = state.settings.deepSeekPresencePenalty;
                    contextFrequencyPenalty = state.settings.deepSeekFrequencyPenalty;
                    contextDeepSeekIncludeThoughts = state.settings.deepSeekIncludeDeepSeekThoughts;
                    contextStreamingOutput = state.settings.deepSeekStreamingOutput;
                    contextStreamingSpeed = state.settings.deepSeekStreamingSpeed;
                    contextDummyUser = state.settings.deepSeekDummyUser;
                    contextEnableDummyUser = state.settings.deepSeekEnableDummyUser;
                    contextDummyModel = state.settings.deepSeekDummyModel;
                    contextEnableDummyModel = state.settings.deepSeekEnableDummyModel;
                    contextConcatDummyModel = state.settings.deepSeekConcatDummyModel;
                } else if (selectedApiProvider === 'claude') {
                    contextTemperature = state.settings.claudeTemperature;
                    contextMaxTokens = state.settings.claudeMaxTokens;
                    contextClaudeTopK = state.settings.claudeTopK;
                    contextTopP = state.settings.claudeTopP;
                    contextStreamingOutput = state.settings.claudeStreamingOutput;
                    contextStreamingSpeed = state.settings.claudeStreamingSpeed;
                    contextDummyUser = state.settings.claudeDummyUser;
                    contextEnableDummyUser = state.settings.claudeEnableDummyUser;
                    contextDummyModel = state.settings.claudeDummyModel;
                    contextEnableDummyModel = state.settings.claudeEnableDummyModel;
                    contextConcatDummyModel = state.settings.claudeConcatDummyModel;
                    contextClaudeIncludeThoughts = state.settings.claudeIncludeThoughts;
                    contextClaudeThinkingBudget = state.settings.claudeThinkingBudget;
                    contextClaudeExpandThoughtsByDefault = state.settings.claudeExpandThoughtsByDefault;
                } else if (selectedApiProvider === 'openai') {
                    contextTemperature = state.settings.openaiTemperature;
                    contextMaxTokens = state.settings.openaiMaxTokens;
                    contextTopP = state.settings.openaiTopP;
                    contextPresencePenalty = state.settings.openaiPresencePenalty;
                    contextFrequencyPenalty = state.settings.openaiFrequencyPenalty;
                    contextStreamingOutput = state.settings.openaiStreamingOutput;
                    contextStreamingSpeed = state.settings.openaiStreamingSpeed;
                    contextDummyUser = state.settings.openaiDummyUser;
                    contextEnableDummyUser = state.settings.openaiEnableDummyUser;
                    contextDummyModel = state.settings.openaiDummyModel;
                    contextEnableDummyModel = state.settings.openaiEnableDummyModel;
                    contextConcatDummyModel = state.settings.openaiConcatDummyModel;
                } else if (selectedApiProvider === 'xai') {
                    contextTemperature = state.settings.xaiTemperature;
                    contextMaxTokens = state.settings.xaiMaxTokens;
                    contextTopP = state.settings.xaiTopP;
                    contextPresencePenalty = state.settings.xaiPresencePenalty;
                    contextFrequencyPenalty = state.settings.xaiFrequencyPenalty;
                    contextStreamingOutput = state.settings.xaiStreamingOutput;
                    contextStreamingSpeed = state.settings.xaiStreamingSpeed;
                    contextDummyUser = state.settings.xaiDummyUser;
                    contextEnableDummyUser = state.settings.xaiEnableDummyUser;
                    contextDummyModel = state.settings.xaiDummyModel;
                    contextEnableDummyModel = state.settings.xaiEnableDummyModel;
                    contextConcatDummyModel = state.settings.xaiConcatDummyModel;
                    contextXaiVisionEnable = state.settings.xaiVisionEnable;
                    contextXaiIncludeThoughts = state.settings.xaiIncludeThoughts;
                    contextXaiReasoningEffort = state.settings.xaiReasoningEffort;
                } else if (selectedApiProvider === 'llmaggregator') {
                    contextTemperature = state.settings.llmAggregatorTemperature;
                    contextMaxTokens = state.settings.llmAggregatorMaxTokens;
                    contextTopP = state.settings.llmAggregatorTopP;
                    contextLlmAggregatorTopK = state.settings.llmAggregatorTopK;
                    contextPresencePenalty = state.settings.llmAggregatorPresencePenalty;
                    contextFrequencyPenalty = state.settings.llmAggregatorFrequencyPenalty;
                    contextDeepSeekIncludeThoughts = state.settings.llmAggregatorIncludeThoughts;
                    contextStreamingOutput = state.settings.llmAggregatorStreamingOutput;
                    contextStreamingSpeed = state.settings.llmAggregatorStreamingSpeed;
                    contextDummyUser = state.settings.llmAggregatorDummyUser;
                    contextEnableDummyUser = state.settings.llmAggregatorEnableDummyUser;
                    contextDummyModel = state.settings.llmAggregatorDummyModel;
                    contextEnableDummyModel = state.settings.llmAggregatorEnableDummyModel;
                    contextConcatDummyModel = state.settings.llmAggregatorConcatDummyModel;
                }
            }
            
            if ((selectedApiProvider === 'gemini' && !(multiApiKeyUtils.getActiveApiKey('gemini') || state.settings.apiKey)) ||
                (selectedApiProvider === 'deepseek' && !(multiApiKeyUtils.getActiveApiKey('deepseek') || state.settings.deepSeekApiKey)) ||
                (selectedApiProvider === 'claude' && !(multiApiKeyUtils.getActiveApiKey('claude') || state.settings.claudeApiKey)) ||
                (selectedApiProvider === 'openai' && !(multiApiKeyUtils.getActiveApiKey('openai') || state.settings.openaiApiKey)) ||
                (selectedApiProvider === 'xai' && !(multiApiKeyUtils.getActiveApiKey('xai') || state.settings.xaiApiKey)) ||
                (selectedApiProvider === 'llmaggregator' && !(multiApiKeyUtils.getActiveApiKey('llmaggregator') || state.settings.llmAggregatorApiKey))) {
                if (!isBackgroundProcess) {
                    await uiUtils.showCustomAlert(`${selectedApiProvider} API繧ｭ繝ｼ縺瑚ｨｭ螳壹＆繧後※縺・∪縺帙ｓ縲りｨｭ螳夂判髱｢繧帝幕縺阪∪縺吶Ａ);
                    uiUtils.showScreen('settings');
                }
                return "API繧ｭ繝ｼ譛ｪ險ｭ螳・;
            }
            
            if (selectedApiProvider === 'llmaggregator') {
                if (!isAllowedAggregatorDomain(state.settings.llmAggregatorApiBackend)) {
                    if (!isBackgroundProcess) {
                        await uiUtils.showCustomAlert('LLM Aggregator縺ｮ繝舌ャ繧ｯ繧ｨ繝ｳ繝蔚RL縺後・繝ｯ繧､繝医Μ繧ｹ繝亥､悶・縺溘ａ縲・∽ｿ｡縺ｧ縺阪∪縺帙ｓ縲りｨｭ螳壹ｒ遒ｺ隱阪＠縺ｦ縺上□縺輔＞縲・);
                        uiUtils.showScreen('settings');
                    }
                    return "荳肴ｭ｣縺ｪ繝峨Γ繧､繝ｳ";
                }
            }

            if (!isBackgroundProcess) uiUtils.setSendingState(true);
            state.partialStreamContent = '';
            state.partialThoughtStreamContent = '';

            let userMessageIndex = isRetry ? retryUserMessageIndex : -1;
            let existingSiblingGroupId = null;
            let firstResponseIndexForRetry = -1;
            let siblingGroupIdToUse = null;

            if (!isBackgroundProcess && !isRetry) {
                const userMessage = {
                    role: 'user', content: text, timestamp: Date.now(),
                    attachments: attachmentsToSend,
                    generatedByApiProvider: null
                };
                state.currentMessages.push(userMessage);
                userMessageIndex = state.currentMessages.length - 1;
                state.messageCollapsedStates.set(userMessageIndex, false);
                uiUtils.appendMessage(userMessage.role, userMessage.content, userMessageIndex, false, null, userMessage.attachments);
                elements.userInput.value = '';
                state.pendingAttachments = [];
                uiUtils.adjustTextareaHeight();
                uiUtils.updateAttachmentBadgeVisibility();
                currentContextMessages = [...state.currentMessages];
            } else if (isBackgroundProcess && !isRetry) {
                const userMessage = {
                    role: 'user', content: text, timestamp: Date.now(),
                    attachments: attachmentsToSend,
                    generatedByApiProvider: null
                };
                currentContextMessages.push(userMessage);
                userMessageIndex = currentContextMessages.length - 1;
            } else if (isRetry) {
                let siblingStartIndex = userMessageIndex + 1;
                while (siblingStartIndex < currentContextMessages.length && currentContextMessages[siblingStartIndex].role !== 'model') {
                    siblingStartIndex++;
                }
                if (siblingStartIndex < currentContextMessages.length && currentContextMessages[siblingStartIndex].role === 'model') {
                     firstResponseIndexForRetry = siblingStartIndex;
                     const firstResponse = currentContextMessages[firstResponseIndexForRetry];
                     if (firstResponse.isCascaded && firstResponse.siblingGroupId) {
                         existingSiblingGroupId = firstResponse.siblingGroupId;
                         currentContextMessages.forEach(msg => {
                             if (msg.siblingGroupId === existingSiblingGroupId) {
                                 msg.isSelected = false;
                             }
                         });
                         siblingGroupIdToUse = existingSiblingGroupId;
                     }
                }
            }

            const messagesToProcess = isRetry
                ? currentContextMessages.slice(0, userMessageIndex + 1)
                : [...currentContextMessages];

            try {
                let titleToSave = null;
                let isNewChatForDBSave = !currentContextSessionId;
                let existingChatForDBSave = null;

                if (currentContextSessionId && !isBackgroundProcess) {
                    existingChatForDBSave = await dbUtils.getChat(currentContextSessionId);
                    if (existingChatForDBSave) {
                        titleToSave = existingChatForDBSave.title;
                        isNewChatForDBSave = false;
                    } else {
                        isNewChatForDBSave = true;
                        currentContextSessionId = null;
                        state.currentChatId = null;
                    }
                } else if (isBackgroundProcess && sourceSessionContext?.sessionId) {
                     existingChatForDBSave = await dbUtils.getChat(sourceSessionContext.sessionId);
                     if (existingChatForDBSave) {
                        titleToSave = existingChatForDBSave.title;
                        isNewChatForDBSave = false;
                     } else {
                        isNewChatForDBSave = true;
                        sourceSessionContext.sessionId = null;
                     }
                }

                if (isNewChatForDBSave || !titleToSave) {
                    const firstUserMsg = currentContextMessages.find(m => m.role === 'user');
                    titleToSave = firstUserMsg ? firstUserMsg.content.substring(0, 50) : "辟｡鬘後・繝√Ε繝・ヨ";
                }

                // 迴ｾ蝨ｨ縺ｮ繝√Ε繝・ヨ縺ｮ繧｢繧ｻ繝・ヨ諠・ｱ繧貞叙蠕・                const currentChatAssets = currentContextSessionId ? 
                    state.chatAssets.get(currentContextSessionId) : 
                    state.chatAssets.get("pending");
                
                const chatToSave = {
                    messages: currentContextMessages.map(msg => ({
                        role: msg.role, content: msg.content, timestamp: msg.timestamp,
                        thoughtSummary: msg.thoughtSummary || null,
                        deepSeekThoughtSummary: msg.deepSeekThoughtSummary || null,
                        xaiThoughtSummary: msg.xaiThoughtSummary || null,
                        generatedByApiProvider: msg.generatedByApiProvider || null,
                        ...(msg.finishReason && { finishReason: msg.finishReason }),
                        ...(msg.safetyRatings && { safetyRatings: msg.safetyRatings }),
                        ...(msg.error && { error: msg.error }),
                        ...(msg.isCascaded !== undefined && { isCascaded: msg.isCascaded }),
                        ...(msg.isSelected !== undefined && { isSelected: msg.isSelected }),
                        ...(msg.siblingGroupId !== undefined && { siblingGroupId: msg.siblingGroupId }),
                        ...(msg.groundingMetadata && { groundingMetadata: msg.groundingMetadata }),
                        ...(msg.attachments && msg.attachments.length > 0 && { attachments: msg.attachments.map(att => ({ name: att.name, mimeType: att.mimeType, textData: att.textData })) }),
                        ...(msg.usageMetadata && { usageMetadata: msg.usageMetadata }),
                        ...(msg.thoughtSummaryOpen !== undefined && { thoughtSummaryOpen: msg.thoughtSummaryOpen }),
                    })),
                    updatedAt: Date.now(),
                    title: titleToSave,
                    // 繧｢繧ｻ繝・ヨ諠・ｱ繧定ｿｽ蜉
                    aiName: currentChatAssets?.aiName || state.settings.aiName || 'AI',
                    aiIconBlob: currentChatAssets?.aiIconBlob || state.settings.aiIconBlob || null,
                    backgroundImageBlob: currentChatAssets?.backgroundImageBlob || state.settings.backgroundImageBlob || null,
                    chatSystemPrompt: state.chatSystemPrompt || null
                };

                if (isNewChatForDBSave) {
                    chatToSave.createdAt = Date.now();
                } else if (existingChatForDBSave) {
                    chatToSave.id = currentContextSessionId || sourceSessionContext?.sessionId;
                    chatToSave.createdAt = existingChatForDBSave.createdAt;
                }

                if (state.settings.persistMessageCollapseState) {
                    if (!isBackgroundProcess) {
                        chatToSave.collapsedStates = Object.fromEntries(state.messageCollapsedStates);
                    } else if (existingChatForDBSave) {
                         chatToSave.collapsedStates = existingChatForDBSave.collapsedStates || {};
                    } else {
                        chatToSave.collapsedStates = {};
                    }
                }

                const savedId = await new Promise((resolve, reject) => {
                    const store = dbUtils._getStore(CHATS_STORE, 'readwrite');
                    const request = chatToSave.id ? store.put(chatToSave) : store.add(chatToSave);
                    request.onsuccess = (event) => resolve(event.target.result || chatToSave.id);
                    request.onerror = (event) => reject(`繝√Ε繝・ヨ菫晏ｭ倥お繝ｩ繝ｼ: ${event.target.error.name} - ${event.target.error.message}`);
                });

                if (!isBackgroundProcess && !state.currentChatId && savedId) {
                    state.currentChatId = savedId;
                    uiUtils.updateChatTitle(chatToSave.title);
                    
                    // pending繧｢繧ｻ繝・ヨ縺後≠繧句ｴ蜷医・縲∽ｿ晏ｭ倥＠縺溘メ繝｣繝・ヨID縺ｫ繧ｳ繝斐・縺励※蜑企勁
                    if (state.chatAssets.has("pending")) {
                        const pendingAssets = state.chatAssets.get("pending");
                        state.chatAssets.set(savedId, {
                            aiName: chatToSave.aiName || pendingAssets.aiName || 'AI',
                            aiIconBlob: chatToSave.aiIconBlob || pendingAssets.aiIconBlob || null,
                            backgroundImageBlob: chatToSave.backgroundImageBlob || pendingAssets.backgroundImageBlob || null,
                            aiIconUrl: state.aiIconUrl || pendingAssets.aiIconUrl || null,
                            backgroundImageUrl: state.backgroundImageUrl || pendingAssets.backgroundImageUrl || null
                        });
                        state.chatAssets.delete("pending");
                    }
                } else if (isBackgroundProcess && !sourceSessionContext.sessionId && savedId) {
                    sourceSessionContext.sessionId = savedId;
                } else if (!isBackgroundProcess && state.currentChatId && savedId) {
                    // 譌｢蟄倥メ繝｣繝・ヨ縺ｮ譖ｴ譁ｰ譎ゅｂchatAssets繧呈峩譁ｰ
                    state.chatAssets.set(savedId, {
                        aiName: chatToSave.aiName,
                        aiIconBlob: chatToSave.aiIconBlob,
                        backgroundImageBlob: chatToSave.backgroundImageBlob,
                        aiIconUrl: state.aiIconUrl,
                        backgroundImageUrl: state.backgroundImageUrl
                    });
                }

            } catch (error) {
                if (!isBackgroundProcess) {
                    if(currentContextSessionId){
                         uiUtils.displayError("繝√Ε繝・ヨ縺ｮ菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆縺後・∽ｿ｡繧定ｩｦ縺ｿ縺ｾ縺吶・, false);
                    }
                }
            }

            const apiMessages = messagesToProcess
                .filter(msg => {
                    if (msg.role === 'user') return true;
                    if (msg.role === 'model') return !msg.isCascaded || (msg.isCascaded && msg.isSelected);
                    return false;
                })
                .map(msg => {
                    const parts = [];
                    if (msg.content && msg.content.trim() !== '') {
                        parts.push({ text: msg.content });
                    }
                    if (msg.role === 'user' && msg.attachments && msg.attachments.length > 0) {
                        msg.attachments.forEach(att => {
                            if (att.textData) {
                                parts.push({ text: att.textData });
                            } else if (att.base64Data) {
                                parts.push({
                                    inlineData: {
                                        mimeType: att.mimeType,
                                        data: att.base64Data
                                    }
                                });
                            }
                        });
                    }
                    return { role: msg.role, parts: parts.length > 0 ? parts : [{text: ''}] };
                });
            const dummyUserTextToUse = contextEnableDummyUser && contextDummyUser?.trim() ? contextDummyUser.trim() : null;
            const dummyModelTextToUse = contextEnableDummyModel && contextDummyModel?.trim() ? contextDummyModel.trim() : null;

            if (dummyUserTextToUse) apiMessages.push({ role: 'user', parts: [{ text: dummyUserTextToUse }] });
            if (dummyModelTextToUse) apiMessages.push({ role: 'model', parts: [{ text: dummyModelTextToUse }] });

            const commonGenerationConfig = {};
            if (contextTemperature !== null) commonGenerationConfig.temperature = contextTemperature;
            if (contextMaxTokens !== null) commonGenerationConfig.maxOutputTokens = contextMaxTokens;
            if (contextTopP !== null) commonGenerationConfig.topP = contextTopP;
            if (contextPresencePenalty !== null) commonGenerationConfig.presencePenalty = contextPresencePenalty;
            if (contextFrequencyPenalty !== null) commonGenerationConfig.frequencyPenalty = contextFrequencyPenalty;

            if (selectedApiProvider === 'gemini') {
                if (contextGeminiTopK !== null) commonGenerationConfig.topK = contextGeminiTopK;
                if (contextGeminiThinkingBudget !== null || contextGeminiIncludeThoughts) {
                    commonGenerationConfig.thinkingConfig = commonGenerationConfig.thinkingConfig || {};
                    if (contextGeminiThinkingBudget !== null && Number.isInteger(contextGeminiThinkingBudget) && contextGeminiThinkingBudget >= 0) {
                        commonGenerationConfig.thinkingConfig.thinkingBudget = contextGeminiThinkingBudget;
                    }
                    if (contextGeminiIncludeThoughts) {
                        commonGenerationConfig.thinkingConfig.includeThoughts = true;
                    }
                     if (Object.keys(commonGenerationConfig.thinkingConfig).length === 0) delete commonGenerationConfig.thinkingConfig;
                }
            } else if (selectedApiProvider === 'claude') {
                if (contextClaudeTopK !== null) commonGenerationConfig.topK = contextClaudeTopK;
                if(contextClaudeIncludeThoughts) {
                    commonGenerationConfig.thinkingConfig = { "type": "enabled" };
                    if (contextClaudeThinkingBudget !== null && Number.isInteger(contextClaudeThinkingBudget) && contextClaudeThinkingBudget >= 1024) {
                        commonGenerationConfig.thinkingConfig.budget_tokens = contextClaudeThinkingBudget;
                    }
                }
            } else if (selectedApiProvider === 'llmaggregator') {
                if (contextLlmAggregatorTopK !== null) commonGenerationConfig.topK = contextLlmAggregatorTopK;
            }

            let systemInstructionForProvider = null;
            const systemPromptTextToUseForApi = currentContextSystemPrompt?.trim() ? currentContextSystemPrompt.trim() : null;

            if (systemPromptTextToUseForApi) {
                if (selectedApiProvider === 'gemini') {
                    systemInstructionForProvider = { role: "system", parts: [{ text: systemPromptTextToUseForApi }] };
                } else if (selectedApiProvider === 'deepseek' || selectedApiProvider === 'claude' || selectedApiProvider === 'openai' || selectedApiProvider === 'xai' || selectedApiProvider === 'llmaggregator') {
                    systemInstructionForProvider = { content: systemPromptTextToUseForApi, parts: [{ text: systemPromptTextToUseForApi }] };
                }
            }

            let modelResponseRawContent = '';
            let modelThoughtSummaryContent = '';
            let modelResponseMetadata = {};
            let currentGroundingMetadata = null;
            let finalUsageMetadataFromStream = null;

            let useStreamingForThisCall = isBackgroundProcess ? false : contextStreamingOutput;
            let usePseudoForThisCall = isBackgroundProcess ? false : (selectedApiProvider === 'gemini' && contextGeminiPseudoStreaming);

            let modelMessageObjectForStream = null;

            try {
                let apiResponseObject;
                if (selectedApiProvider === 'gemini') {
                    apiResponseObject = await apiUtils.callGeminiApi(apiMessages, commonGenerationConfig, systemInstructionForProvider, useStreamingForThisCall, usePseudoForThisCall, contextGeminiEnableGrounding);
                } else if (selectedApiProvider === 'deepseek' || selectedApiProvider === 'llmaggregator') {
                    apiResponseObject = await apiUtils.callDeepSeekApi(apiMessages, commonGenerationConfig, systemInstructionForProvider, useStreamingForThisCall, selectedApiProvider);
                } else if (selectedApiProvider === 'claude') {
                    apiResponseObject = await apiUtils.callClaudeApi(apiMessages, commonGenerationConfig, systemInstructionForProvider, useStreamingForThisCall);
                } else if (selectedApiProvider === 'openai') {
                    const hasImage = apiMessages.some(m => m.parts.some(p => p.inlineData && p.inlineData.mimeType.startsWith('image/')));
                    apiResponseObject = await apiUtils.callOpenAICompatibleApi('openai', apiMessages, commonGenerationConfig, systemInstructionForProvider, useStreamingForThisCall, hasImage);
                } else if (selectedApiProvider === 'xai') {
                    const hasImage = apiMessages.some(m => m.parts.some(p => p.inlineData && p.inlineData.mimeType.startsWith('image/')));
                    const enableVisionForThisCall = contextXaiVisionEnable || hasImage;
                    apiResponseObject = await apiUtils.callXaiApi(apiMessages, commonGenerationConfig, systemInstructionForProvider, useStreamingForThisCall, enableVisionForThisCall);
                } else {
                    throw new Error("荳肴・縺ｪAPI繝励Ο繝舌う繝繝ｼ縺碁∈謚槭＆繧後※縺・∪縺吶・);
                }

                const dummyModelPrefix = (contextConcatDummyModel && dummyModelTextToUse) ? dummyModelTextToUse : '';
                 if (!isBackgroundProcess) {
                    state.partialStreamContent = dummyModelPrefix;
                    state.partialThoughtStreamContent = '';
                }

                if (useStreamingForThisCall && !isBackgroundProcess) {
                    const tempPlaceholderIndex = state.currentMessages.length;
                    modelMessageObjectForStream = {
                        role: 'model',
                        content: '',
                        thoughtSummary: null,
                        deepSeekThoughtSummary: null,
                        xaiThoughtSummary: null,
                        timestamp: Date.now(),
                        generatedByApiProvider: selectedApiProvider,
                        thoughtSummaryOpen: (selectedApiProvider === 'gemini' && contextGeminiIncludeThoughts && state.settings.geminiExpandThoughtsByDefault) ||
                                            (selectedApiProvider === 'deepseek' && contextDeepSeekIncludeThoughts && state.settings.deepSeekExpandThoughtsByDefault) ||
                                            (selectedApiProvider === 'claude' && contextClaudeIncludeThoughts && state.settings.claudeExpandThoughtsByDefault) ||
                                            (selectedApiProvider === 'xai' && contextXaiIncludeThoughts && state.settings.xaiExpandThoughtsByDefault) ||
                                            (selectedApiProvider === 'llmaggregator' && state.settings.llmAggregatorIncludeThoughts && state.settings.llmAggregatorExpandThoughtsByDefault),
                    };

                    if (isRetry && firstResponseIndexForRetry !== -1) {
                         if (siblingGroupIdToUse === null) {
                             siblingGroupIdToUse = `gid-${Date.now()}-${Math.random().toString(36).substring(2, 8)}`;
                         }
                         modelMessageObjectForStream.isCascaded = true;
                         modelMessageObjectForStream.siblingGroupId = siblingGroupIdToUse;
                         modelMessageObjectForStream.isSelected = true;

                         if (state.currentMessages[firstResponseIndexForRetry] && !state.currentMessages[firstResponseIndexForRetry].isCascaded) {
                             state.currentMessages[firstResponseIndexForRetry].isCascaded = true;
                             state.currentMessages[firstResponseIndexForRetry].siblingGroupId = siblingGroupIdToUse;
                             state.currentMessages[firstResponseIndexForRetry].isSelected = false;
                         }
                    }

                    state.currentMessages.push(modelMessageObjectForStream);
                    state.messageCollapsedStates.set(tempPlaceholderIndex, false);
                    uiUtils.appendMessage('model', modelMessageObjectForStream.content, tempPlaceholderIndex, true);
                }

                if (useStreamingForThisCall) {
                    let responseStreamIterator;
                    if (selectedApiProvider === 'gemini') {
                        responseStreamIterator = apiUtils.handleGeminiStreamingResponse(apiResponseObject);
                    } else if (selectedApiProvider === 'deepseek' || selectedApiProvider === 'llmaggregator') {
                        responseStreamIterator = apiUtils.handleDeepSeekStreamingResponse(apiResponseObject);
                    } else if (selectedApiProvider === 'claude') {
                        responseStreamIterator = apiUtils.handleClaudeStreamingResponse(apiResponseObject);
                    } else if (selectedApiProvider === 'openai') {
                        responseStreamIterator = apiUtils.handleOpenAICompatibleStreamingResponse(apiResponseObject, 'openai');
                    } else if (selectedApiProvider === 'xai') {
                        responseStreamIterator = apiUtils.handleOpenAICompatibleStreamingResponse(apiResponseObject, 'xai');
                    }

                    const currentContextStreamSpeed = selectedApiProvider === 'gemini' ? contextStreamingSpeed : 
                                                      selectedApiProvider === 'deepseek' ? state.settings.deepSeekStreamingSpeed :
                                                      selectedApiProvider === 'claude' ? state.settings.claudeStreamingSpeed :
                                                      selectedApiProvider === 'xai' ? state.settings.xaiStreamingSpeed :
                                                      selectedApiProvider === 'llmaggregator' ? state.settings.llmAggregatorStreamingSpeed :
                                                      state.settings.openaiStreamingSpeed;

                    const messageIndexForDisplay = isBackgroundProcess ? -1 : (modelMessageObjectForStream ? state.currentMessages.indexOf(modelMessageObjectForStream) : -1);

                    for await (const streamData of responseStreamIterator) {
                        if (state.abortController?.signal.aborted) {
                            modelResponseMetadata.finishReason = 'ABORTED';
                            throw new Error("繝ｪ繧ｯ繧ｨ繧ｹ繝医′繧ｭ繝｣繝ｳ繧ｻ繝ｫ縺輔ｌ縺ｾ縺励◆縲・);
                        }

                        if (streamData.type === 'chunk') {
                            if (streamData.thoughtText) {
                                if (isBackgroundProcess) {
                                    modelThoughtSummaryContent += streamData.thoughtText;
                                } else {
                                    for (const char of streamData.thoughtText) {
                                        if (state.abortController?.signal.aborted) break;
                                        state.partialThoughtStreamContent += char;
                                        uiUtils.updateStreamingMessage(messageIndexForDisplay, char, true);
                                        if (currentContextStreamSpeed > 0) await sleep(currentContextStreamSpeed);
                                    }
                                }
                            }
                            if (streamData.contentText) {
                                if (isBackgroundProcess) {
                                    modelResponseRawContent += streamData.contentText;
                                } else {
                                    for (const char of streamData.contentText) {
                                        if (state.abortController?.signal.aborted) break;
                                        state.partialStreamContent += char;
                                        uiUtils.updateStreamingMessage(messageIndexForDisplay, char, false);
                                        if (currentContextStreamSpeed > 0) await sleep(currentContextStreamSpeed);
                                    }
                                }
                            }
                            if (state.abortController?.signal.aborted) {
                                modelResponseMetadata.finishReason = 'ABORTED';
                                throw new Error("繝ｪ繧ｯ繧ｨ繧ｹ繝医′繧ｭ繝｣繝ｳ繧ｻ繝ｫ縺輔ｌ縺ｾ縺励◆縲・);
                            }
                            if (streamData.groundingMetadata && selectedApiProvider === 'gemini') {
                                currentGroundingMetadata = streamData.groundingMetadata;
                                if (!isBackgroundProcess && modelMessageObjectForStream && state.currentMessages.includes(modelMessageObjectForStream)) {
                                    const msgIndexForGrounding = state.currentMessages.indexOf(modelMessageObjectForStream);
                                    if (state.currentMessages[msgIndexForGrounding]) {
                                        state.currentMessages[msgIndexForGrounding].groundingMetadata = currentGroundingMetadata;
                                    }
                                }
                            }
                            if (streamData.usageMetadata) finalUsageMetadataFromStream = streamData.usageMetadata;
                        } else if (streamData.type === 'metadata') {
                            modelResponseMetadata = {
                                finishReason: streamData.finishReason,
                                safetyRatings: streamData.safetyRatings,
                            };
                            if (selectedApiProvider === 'gemini') {
                                 if (streamData.groundingMetadata) currentGroundingMetadata = streamData.groundingMetadata;
                                 if (streamData.usageMetadata) finalUsageMetadataFromStream = streamData.usageMetadata;
                            } else if (selectedApiProvider === 'deepseek' || selectedApiProvider === 'llmaggregator') {
                                if (streamData.fullReasoningContent && contextDeepSeekIncludeThoughts) {
                                    modelThoughtSummaryContent = streamData.fullReasoningContent;
                                }
                                if (streamData.usageMetadata) finalUsageMetadataFromStream = streamData.usageMetadata;
                            } else if (selectedApiProvider === 'claude' || selectedApiProvider === 'openai' || selectedApiProvider === 'xai') {
                                if (streamData.usageMetadata) finalUsageMetadataFromStream = streamData.usageMetadata;
                            }
                            break;
                        } else if (streamData.type === 'error') {
                            modelResponseMetadata.finishReason = 'ERROR';
                            modelResponseMetadata.error = streamData.error;
                            throw new Error(streamData.message || "繧ｹ繝医Μ繝ｼ繝蜀・〒繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆縲・);
                        }
                    }

                    if (!isBackgroundProcess) {
                        modelThoughtSummaryContent = state.partialThoughtStreamContent;
                        modelResponseRawContent = state.partialStreamContent;
                    }

                    if (modelResponseMetadata.finishReason === 'ABORTED' || state.abortController?.signal.aborted) {
                        throw new Error("繝ｪ繧ｯ繧ｨ繧ｹ繝医′繧ｭ繝｣繝ｳ繧ｻ繝ｫ縺輔ｌ縺ｾ縺励◆縲・);
                    }

                } else {
                    const data = await apiResponseObject.json();
                    if (selectedApiProvider === 'gemini') {
                        const candidate = data.candidates?.[0];
                        let rawContentFromApi = "";
                        if (candidate) {
                            modelResponseMetadata = { finishReason: candidate.finishReason, safetyRatings: candidate.safetyRatings };
                            candidate.content?.parts?.forEach(part => {
                                if (part.thought === true && contextGeminiIncludeThoughts) {
                                    modelThoughtSummaryContent += (part.text || "") + "\n\n";
                                } else if (part.thought !== true){
                                    rawContentFromApi += (part.text || "") + "\n\n";
                                }
                            });
                            modelThoughtSummaryContent = modelThoughtSummaryContent.trim();
                            rawContentFromApi = rawContentFromApi.trim();

                            currentGroundingMetadata = candidate.groundingMetadata || null;
                            finalUsageMetadataFromStream = data.usageMetadata || null;
                            if (candidate.finishReason && candidate.finishReason !== "STOP" && candidate.finishReason !== "MAX_TOKENS") {
                                rawContentFromApi += `\n\n(逅・罰: ${candidate.finishReason})`;
                            }
                            if (!rawContentFromApi && candidate.finishReason === "STOP" && !modelThoughtSummaryContent) {
                                rawContentFromApi = "(蠢懃ｭ斐′遨ｺ縺ｧ縺・";
                            }
                        } else {
                            rawContentFromApi = "蠢懃ｭ泌呵｣懊′縺ゅｊ縺ｾ縺帙ｓ";
                            if(data.promptFeedback) {
                                rawContentFromApi += ` (逅・罰: ${data.promptFeedback.blockReason || '荳肴・'})`;
                                modelResponseMetadata.promptFeedback = data.promptFeedback;
                                modelResponseMetadata.finishReason = data.promptFeedback.blockReason || 'ERROR';
                            } else {
                                modelResponseMetadata.finishReason = 'ERROR';
                            }
                            finalUsageMetadataFromStream = data.usageMetadata || null;
                        }
                         modelResponseRawContent = dummyModelPrefix + rawContentFromApi;
                    } else if (selectedApiProvider === 'deepseek' || selectedApiProvider === 'llmaggregator') {
                        const choice = data.choices?.[0];
                        let rawContentFromApi = "";
                        if (choice) {
                            rawContentFromApi = choice.message?.content || "";
                            modelResponseMetadata = { finishReason: choice.finish_reason };
                            if (data.usage) {
                               finalUsageMetadataFromStream = {
                                    candidatesTokenCount: data.usage.completion_tokens,
                                    totalTokenCount: data.usage.total_tokens,
                                };
                            }
                            if (contextDeepSeekIncludeThoughts && data.parsedReasoningContent) {
                                modelThoughtSummaryContent = data.parsedReasoningContent;
                            }
                        } else {
                            rawContentFromApi = `${selectedApiProvider.toUpperCase()}縺九ｉ縺ｮ蠢懃ｭ斐′縺ゅｊ縺ｾ縺帙ｓ縲Ａ;
                            modelResponseMetadata = { finishReason: 'ERROR' };
                            if (data.error) rawContentFromApi += ` (繧ｨ繝ｩ繝ｼ: ${data.error.message})`;
                        }
                        modelResponseRawContent = dummyModelPrefix + rawContentFromApi;
                    } else if (selectedApiProvider === 'claude') {
                        let rawContentFromApi = "";
                        if (data.content && data.content.length > 0) {
                            data.content.forEach(block => {
                                if (block.type === 'text') {
                                    rawContentFromApi += block.text;
                                } else if (block.type === 'thinking' && contextClaudeIncludeThoughts) {
                                    modelThoughtSummaryContent += (block.thinking || "") + "\n\n";
                                }
                            });
                            modelThoughtSummaryContent = modelThoughtSummaryContent.trim();
                        }
                        modelResponseMetadata = { finishReason: data.stop_reason || 'stop' };
                        if (data.usage) {
                            finalUsageMetadataFromStream = {
                                candidatesTokenCount: data.usage.output_tokens,
                                totalTokenCount: data.usage.input_tokens + data.usage.output_tokens,
                            };
                        }
                        if (!rawContentFromApi && data.stop_reason === 'end_turn') {
                            rawContentFromApi = "(蠢懃ｭ斐′遨ｺ縺ｧ縺・";
                        }
                        modelResponseRawContent = dummyModelPrefix + rawContentFromApi;
                    } else if (selectedApiProvider === 'openai' || selectedApiProvider === 'xai') {
                        let rawContentFromApi = "";
                        if (data.choices && data.choices.length > 0) {
                            rawContentFromApi = data.choices[0].message?.content || "";
                            modelResponseMetadata = { finishReason: data.choices[0].finish_reason };
                            if(selectedApiProvider === 'xai' && data.choices[0].message.reasoning_content) {
                                modelThoughtSummaryContent = data.choices[0].message.reasoning_content;
                            }
                        }
                        if (data.usage) {
                            let reasoningTokens = 0;
                            if (selectedApiProvider === 'xai' && data.usage.completion_tokens_details?.reasoning_tokens) {
                                reasoningTokens = data.usage.completion_tokens_details.reasoning_tokens;
                            }
                            finalUsageMetadataFromStream = {
                                candidatesTokenCount: data.usage.completion_tokens + reasoningTokens,
                                totalTokenCount: data.usage.prompt_tokens + data.usage.completion_tokens + reasoningTokens
                            };
                        }
                        if (!rawContentFromApi && modelResponseMetadata.finishReason === 'stop') {
                            rawContentFromApi = "(蠢懃ｭ斐′遨ｺ縺ｧ縺・";
                        }
                        modelResponseRawContent = dummyModelPrefix + rawContentFromApi;
                    }
                }

                if (isBackgroundProcess) {
                    if (modelResponseRawContent || modelThoughtSummaryContent || modelResponseMetadata.finishReason) {
                         const bgModelMessage = {
                             role: 'model', content: modelResponseRawContent,
                             timestamp: Date.now(),
                             ...modelResponseMetadata,
                             usageMetadata: finalUsageMetadataFromStream,
                             generatedByApiProvider: selectedApiProvider
                         };
                         if (selectedApiProvider === 'gemini' && contextGeminiIncludeThoughts) {
                             bgModelMessage.thoughtSummary = modelThoughtSummaryContent || null;
                             bgModelMessage.groundingMetadata = currentGroundingMetadata;
                         } else if ((selectedApiProvider === 'deepseek' || selectedApiProvider === 'llmaggregator') && contextDeepSeekIncludeThoughts) {
                             bgModelMessage.deepSeekThoughtSummary = modelThoughtSummaryContent || null;
                         } else if (selectedApiProvider === 'claude' && contextClaudeIncludeThoughts) {
                             bgModelMessage.thoughtSummary = modelThoughtSummaryContent || null;
                         } else if (selectedApiProvider === 'xai' && contextXaiIncludeThoughts) {
                             bgModelMessage.xaiThoughtSummary = modelThoughtSummaryContent || null;
                         }

                          bgModelMessage.thoughtSummaryOpen = (selectedApiProvider === 'gemini' && state.settings.geminiExpandThoughtsByDefault) || 
                                                              (selectedApiProvider === 'deepseek' && state.settings.deepSeekExpandThoughtsByDefault) ||
                                                              (selectedApiProvider === 'claude' && state.settings.claudeExpandThoughtsByDefault) ||
                                                              (selectedApiProvider === 'xai' && state.settings.xaiExpandThoughtsByDefault) ||
                                                              (selectedApiProvider === 'llmaggregator' && state.settings.llmAggregatorExpandThoughtsByDefault);

                         currentContextMessages.push(bgModelMessage);
                         const chatToSaveBg = {
                            messages: currentContextMessages.map(msg => ({
                                role: msg.role, content: msg.content, timestamp: msg.timestamp,
                                thoughtSummary: msg.thoughtSummary || null,
                                deepSeekThoughtSummary: msg.deepSeekThoughtSummary || null,
                                xaiThoughtSummary: msg.xaiThoughtSummary || null,
                                generatedByApiProvider: msg.generatedByApiProvider || null,
                                ...(msg.finishReason && { finishReason: msg.finishReason }),
                                ...(msg.safetyRatings && { safetyRatings: msg.safetyRatings }),
                                ...(msg.error && { error: msg.error }),
                                ...(msg.isCascaded !== undefined && { isCascaded: msg.isCascaded }),
                                ...(msg.isSelected !== undefined && { isSelected: msg.isSelected }),
                                ...(msg.siblingGroupId !== undefined && { siblingGroupId: msg.siblingGroupId }),
                                ...(msg.groundingMetadata && { groundingMetadata: msg.groundingMetadata }),
                                ...(msg.attachments && msg.attachments.length > 0 && { attachments: msg.attachments.map(att => ({ name: att.name, mimeType: att.mimeType, textData: att.textData })) }),
                                ...(msg.usageMetadata && { usageMetadata: msg.usageMetadata }),
                                ...(msg.thoughtSummaryOpen !== undefined && { thoughtSummaryOpen: msg.thoughtSummaryOpen }),
                            })),
                            updatedAt: Date.now(),
                            id: sourceSessionContext.sessionId
                         };
                         const existingChatForBg = await dbUtils.getChat(sourceSessionContext.sessionId);
                         if (existingChatForBg) {
                             chatToSaveBg.createdAt = existingChatForBg.createdAt;
                             chatToSaveBg.title = existingChatForBg.title;
                         }

                         await new Promise((resolve, reject) => {
                            const store = dbUtils._getStore(CHATS_STORE, 'readwrite');
                            const request = store.put(chatToSaveBg);
                            request.onsuccess = () => resolve();
                            request.onerror = (event) => reject(`繝√Ε繝・ヨ菫晏ｭ湾ut繧ｨ繝ｩ繝ｼ(BG): ${event.target.error.name} - ${event.target.error.message}`);
                         });
                         return { content: modelResponseRawContent, metadata: modelResponseMetadata };
                    }
                    return { content: "", metadata: modelResponseMetadata };
                }

                if (modelResponseRawContent || modelThoughtSummaryContent || modelResponseMetadata.finishReason) {
                    if (useStreamingForThisCall && modelMessageObjectForStream) {
                        const finalModelMessageIndex = state.currentMessages.indexOf(modelMessageObjectForStream);
                        if (finalModelMessageIndex !== -1) {
                            const msgToUpdate = state.currentMessages[finalModelMessageIndex];
                            msgToUpdate.content = modelResponseRawContent;
                            msgToUpdate.timestamp = Date.now();
                            msgToUpdate.finishReason = modelResponseMetadata.finishReason;
                            msgToUpdate.safetyRatings = modelResponseMetadata.safetyRatings;
                            msgToUpdate.usageMetadata = finalUsageMetadataFromStream;
                            if (selectedApiProvider === 'gemini' && contextGeminiIncludeThoughts) {
                                msgToUpdate.thoughtSummary = modelThoughtSummaryContent || null;
                                msgToUpdate.groundingMetadata = currentGroundingMetadata;
                            } else if ((selectedApiProvider === 'deepseek' || selectedApiProvider === 'llmaggregator') && contextDeepSeekIncludeThoughts && modelThoughtSummaryContent) {
                                msgToUpdate.deepSeekThoughtSummary = modelThoughtSummaryContent || null;
                            } else if (selectedApiProvider === 'claude' && contextClaudeIncludeThoughts && modelThoughtSummaryContent) {
                                msgToUpdate.thoughtSummary = modelThoughtSummaryContent || null;
                            } else if (selectedApiProvider === 'xai' && contextXaiIncludeThoughts && modelThoughtSummaryContent) {
                                msgToUpdate.xaiThoughtSummary = modelThoughtSummaryContent || null;
                            }
                            uiUtils.finalizeStreamingMessage(finalModelMessageIndex);
                            await dbUtils.saveChat();
                        }
                    } else {
                         const newModelMessage = {
                             role: 'model', content: modelResponseRawContent,
                             timestamp: Date.now(),
                             ...modelResponseMetadata,
                             usageMetadata: finalUsageMetadataFromStream,
                             generatedByApiProvider: selectedApiProvider
                         };
                        if (selectedApiProvider === 'gemini' && contextGeminiIncludeThoughts) {
                             newModelMessage.thoughtSummary = modelThoughtSummaryContent || null;
                             newModelMessage.groundingMetadata = currentGroundingMetadata;
                        } else if ((selectedApiProvider === 'deepseek' || selectedApiProvider === 'llmaggregator') && contextDeepSeekIncludeThoughts && modelThoughtSummaryContent) {
                             newModelMessage.deepSeekThoughtSummary = modelThoughtSummaryContent || null;
                        } else if (selectedApiProvider === 'claude' && contextClaudeIncludeThoughts && modelThoughtSummaryContent) {
                             newModelMessage.thoughtSummary = modelThoughtSummaryContent || null;
                        } else if (selectedApiProvider === 'xai' && contextXaiIncludeThoughts && modelThoughtSummaryContent) {
                             newModelMessage.xaiThoughtSummary = modelThoughtSummaryContent || null;
                        }
                        newModelMessage.thoughtSummaryOpen = (selectedApiProvider === 'gemini' && state.settings.geminiExpandThoughtsByDefault) || 
                                                             (selectedApiProvider === 'deepseek' && state.settings.deepSeekExpandThoughtsByDefault) ||
                                                             (selectedApiProvider === 'claude' && state.settings.claudeExpandThoughtsByDefault) ||
                                                             (selectedApiProvider === 'xai' && state.settings.xaiExpandThoughtsByDefault) ||
                                                             (selectedApiProvider === 'llmaggregator' && state.settings.llmAggregatorExpandThoughtsByDefault);

                         const targetUserIndexForCascade = userMessageIndex;
                         if (targetUserIndexForCascade !== -1 && !isBackgroundProcess) {
                             if (siblingGroupIdToUse === null) {
                                 siblingGroupIdToUse = `gid-${Date.now()}-${Math.random().toString(36).substring(2, 8)}`;
                             }
                             newModelMessage.isCascaded = true;
                             newModelMessage.isSelected = true;
                             newModelMessage.siblingGroupId = siblingGroupIdToUse;

                             if (isRetry && firstResponseIndexForRetry !== -1 && state.currentMessages[firstResponseIndexForRetry] && !state.currentMessages[firstResponseIndexForRetry].isCascaded) {
                                 state.currentMessages[firstResponseIndexForRetry].isCascaded = true;
                                 state.currentMessages[firstResponseIndexForRetry].siblingGroupId = siblingGroupIdToUse;
                             }
                         }

                         const newModelIndex = state.currentMessages.length;
                         state.currentMessages.push(newModelMessage);
                         state.messageCollapsedStates.set(newModelIndex, false);
                         state.thoughtSummaryOpenStates.set(newModelIndex, newModelMessage.thoughtSummaryOpen);
                         uiUtils.renderChatMessages();
                         await dbUtils.saveChat();
                    }
                } else {
                     if (useStreamingForThisCall && !isBackgroundProcess && modelMessageObjectForStream) {
                        const tempPlaceholderIndex = state.currentMessages.indexOf(modelMessageObjectForStream);
                        const placeholderElement = document.getElementById(`streaming-message-${tempPlaceholderIndex}`);
                        if (placeholderElement) placeholderElement.remove();
                        if(tempPlaceholderIndex !== -1) state.currentMessages.splice(tempPlaceholderIndex, 1);
                    }
                }
            } catch (error) {
                const isAbort = error.message === "繝ｪ繧ｯ繧ｨ繧ｹ繝医′繧ｭ繝｣繝ｳ繧ｻ繝ｫ縺輔ｌ縺ｾ縺励◆縲・ || modelResponseMetadata.finishReason === 'ABORTED';
                
                // Safari蝗ｺ譛峨・繧ｨ繝ｩ繝ｼ繝｡繝・そ繝ｼ繧ｸ繧呈､懷・
                const isSafariError = error.message && (
                    error.message.includes('QuotaExceededError') ||
                    error.message.includes('DataCloneError') ||
                    error.message.includes('InvalidStateError') ||
                    error.message.includes('Failed to store record in an IDBObjectStore') ||
                    error.message.includes('Blob')
                );
                
                let displayErrorMessage;
                if (isAbort) {
                    displayErrorMessage = error.message;
                } else if (isSafariError) {
                    displayErrorMessage = "繝・・繧ｿ菫晏ｭ倥お繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆縲ゅ・繝ｼ繧ｸ繧貞・隱ｭ縺ｿ霎ｼ縺ｿ縺励※縺上□縺輔＞縲・;
                    console.error('Safari specific error detected:', error);
                } else {
                    displayErrorMessage = error.message || "荳肴・縺ｪ繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆";
                }

                // Safari Blob 繧ｨ繝ｩ繝ｼ蟇ｾ遲・ 驥崎ｦ√↑迥ｶ諷句､画焚繧剃ｿ晁ｭｷ
                const preservedState = {
                    aiName: state.settings.aiName,
                    aiIconBlob: state.settings.aiIconBlob,
                    backgroundImageBlob: state.settings.backgroundImageBlob,
                    aiIconUrl: state.aiIconUrl,
                    backgroundImageUrl: state.backgroundImageUrl,
                    assetDirty: {...state.assetDirty},
                    chatSystemPrompt: state.chatSystemPrompt
                };

                let partialThoughtContentOnError, partialContentOnError;
                partialThoughtContentOnError = state.partialThoughtStreamContent;
                partialContentOnError = state.partialStreamContent;

                if (isBackgroundProcess) {
                     throw error;
                }

                if ((partialContentOnError || partialContentOnError) && useStreamingForThisCall && modelMessageObjectForStream) {
                     const finalPartialContent = partialContentOnError + `\n\n(${isAbort ? '荳ｭ譁ｭ縺輔ｌ縺ｾ縺励◆' : '繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆'})`;
                     let finalPartialThoughtValue = null;
                     if (selectedApiProvider === 'gemini' && partialThoughtContentOnError && contextGeminiIncludeThoughts) {
                         finalPartialThoughtValue = partialThoughtContentOnError + `\n\n(${isAbort ? '荳ｭ譁ｭ縺輔ｌ縺ｾ縺励◆' : '繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆'})`;
                     } else if ((selectedApiProvider === 'deepseek' || selectedApiProvider === 'llmaggregator') && partialThoughtContentOnError && contextDeepSeekIncludeThoughts) {
                         finalPartialThoughtValue = partialThoughtContentOnError + `\n\n(${isAbort ? '荳ｭ譁ｭ縺輔ｌ縺ｾ縺励◆' : '繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆'})`;
                     } else if (selectedApiProvider === 'claude' && partialThoughtContentOnError && contextClaudeIncludeThoughts) {
                         finalPartialThoughtValue = partialThoughtContentOnError + `\n\n(${isAbort ? '荳ｭ譁ｭ縺輔ｌ縺ｾ縺励◆' : '繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆'})`;
                     } else if (selectedApiProvider === 'xai' && partialThoughtContentOnError && contextXaiIncludeThoughts) {
                         finalPartialThoughtValue = partialThoughtContentOnError + `\n\n(${isAbort ? '荳ｭ譁ｭ縺輔ｌ縺ｾ縺励◆' : '繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆'})`;
                     }

                    const streamingMessageIndex = state.currentMessages.indexOf(modelMessageObjectForStream);
                    if (streamingMessageIndex !== -1) {
                        const msgToUpdate = state.currentMessages[streamingMessageIndex];
                        msgToUpdate.content = finalPartialContent;
                        msgToUpdate.timestamp = Date.now();
                        msgToUpdate.error = true;
                        msgToUpdate.finishReason = isAbort ? 'ABORTED' : (modelResponseMetadata.finishReason || 'ERROR');
                        msgToUpdate.safetyRatings = modelResponseMetadata.safetyRatings;
                        msgToUpdate.usageMetadata = finalUsageMetadataFromStream;
                        msgToUpdate.generatedByApiProvider = selectedApiProvider;

                        if (selectedApiProvider === 'gemini') {
                            msgToUpdate.thoughtSummary = finalPartialThoughtValue;
                            msgToUpdate.groundingMetadata = currentGroundingMetadata;
                        } else if (selectedApiProvider === 'deepseek' || selectedApiProvider === 'llmaggregator') {
                            msgToUpdate.deepSeekThoughtSummary = finalPartialThoughtValue;
                        } else if (selectedApiProvider === 'claude') {
                            msgToUpdate.thoughtSummary = finalPartialThoughtValue;
                        } else if (selectedApiProvider === 'xai') {
                            msgToUpdate.xaiThoughtSummary = finalPartialThoughtValue;
                        }

                         try {
                            uiUtils.finalizeStreamingMessage(streamingMessageIndex);
                            await dbUtils.saveChat();
                         } catch (saveError) {
                             uiUtils.displayError(displayErrorMessage, !isAbort);
                             // Safari Blob 繧ｨ繝ｩ繝ｼ蟇ｾ遲・ 迥ｶ諷句ｾｩ蜈・                             state.settings.aiName = preservedState.aiName;
                             state.settings.aiIconBlob = preservedState.aiIconBlob;
                             state.settings.backgroundImageBlob = preservedState.backgroundImageBlob;
                             state.aiIconUrl = preservedState.aiIconUrl;
                             state.backgroundImageUrl = preservedState.backgroundImageUrl;
                             state.assetDirty = preservedState.assetDirty;
                             state.chatSystemPrompt = preservedState.chatSystemPrompt;
                         }
                    } else {
                         uiUtils.displayError(displayErrorMessage, !isAbort);
                         // Safari Blob 繧ｨ繝ｩ繝ｼ蟇ｾ遲・ 迥ｶ諷句ｾｩ蜈・                         state.settings.aiName = preservedState.aiName;
                         state.settings.aiIconBlob = preservedState.aiIconBlob;
                         state.settings.backgroundImageBlob = preservedState.backgroundImageBlob;
                         state.aiIconUrl = preservedState.aiIconUrl;
                         state.backgroundImageUrl = preservedState.backgroundImageUrl;
                         state.assetDirty = preservedState.assetDirty;
                         state.chatSystemPrompt = preservedState.chatSystemPrompt;
                    }
                } else {
                    if (useStreamingForThisCall && !isAbort && modelMessageObjectForStream) {
                        const tempPlaceholderIndex = state.currentMessages.indexOf(modelMessageObjectForStream);
                        const placeholderElement = document.getElementById(`streaming-message-${tempPlaceholderIndex}`);
                        if (placeholderElement) placeholderElement.remove();
                        if(tempPlaceholderIndex !== -1) state.currentMessages.splice(tempPlaceholderIndex, 1);
                    }
                    uiUtils.displayError(displayErrorMessage, !isAbort);
                    // Safari Blob 繧ｨ繝ｩ繝ｼ蟇ｾ遲・ 迥ｶ諷句ｾｩ蜈・                    state.settings.aiName = preservedState.aiName;
                    state.settings.aiIconBlob = preservedState.aiIconBlob;
                    state.settings.backgroundImageBlob = preservedState.backgroundImageBlob;
                    state.aiIconUrl = preservedState.aiIconUrl;
                    state.backgroundImageUrl = preservedState.backgroundImageUrl;
                    state.assetDirty = preservedState.assetDirty;
                    state.chatSystemPrompt = preservedState.chatSystemPrompt;
                }
            } finally {
                if (!isBackgroundProcess) {
                    uiUtils.setSendingState(false);
                    state.abortController = null;
                    state.partialStreamContent = '';
                    state.partialThoughtStreamContent = '';
                    if (state.settings.autoScrollOnNewMessage) {
                        uiUtils.scrollToBottom();
                    }
                    uiUtils.updateAttachmentBadgeVisibility();
                }
            }
            if (isBackgroundProcess) return null;
        },
        async toggleApiProvider() {
            if(state.isSending || state.isAiToAiChatProcessing) {
                await uiUtils.showCustomAlert('迴ｾ蝨ｨ蜃ｦ逅・ｸｭ縺ｮ縺溘ａ縲、PI繝励Ο繝舌う繝繝ｼ繧貞､画峩縺ｧ縺阪∪縺帙ｓ縲・);
                return;
            }
            const providersInCycle = Object.entries(state.settings.apiProviderCycle)
                                            .filter(([, isEnabled]) => isEnabled)
                                            .map(([provider]) => provider);

            if (providersInCycle.length === 0) {
                await uiUtils.showCustomAlert('蛻・ｊ譖ｿ縺亥庄閭ｽ縺ｪAPI繝励Ο繝舌う繝繝ｼ縺碁∈謚槭＆繧後※縺・∪縺帙ｓ縲りｨｭ螳壹ｒ遒ｺ隱阪＠縺ｦ縺上□縺輔＞縲・);
                return;
            }

            const currentIndex = providersInCycle.indexOf(state.settings.apiProvider);
            const nextIndex = (currentIndex + 1) % providersInCycle.length;
            state.settings.apiProvider = providersInCycle[nextIndex];

            try {
                await dbUtils.saveSetting('apiProvider', state.settings.apiProvider);
                elements.apiProviderSelect.value = state.settings.apiProvider;
                uiUtils.updateChatScreenElementVisibility();
                uiUtils.toggleApiSettingsVisibility(state.settings.apiProvider);
                uiUtils.adjustTextareaHeight();
            } catch (error) {
                await uiUtils.showCustomAlert(`API繝励Ο繝舌う繝繝ｼ險ｭ螳壹・菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆: ${error.message}`);
                state.settings.apiProvider = providersInCycle[currentIndex >= 0 ? currentIndex : 0];
                elements.apiProviderSelect.value = state.settings.apiProvider;
                uiUtils.updateChatScreenElementVisibility();
            }
        },
        abortRequest() {
            if (state.abortController) {
                state.abortController.abort();
            }
        },
        async handleHistoryImport(file) {
            if (!file || !file.type.startsWith('text/plain')) {
                await uiUtils.showCustomAlert("繝・く繧ｹ繝医ヵ繧｡繧､繝ｫ (.txt) 繧帝∈謚槭＠縺ｦ縺上□縺輔＞縲・);
                return;
            }
            const reader = new FileReader();
            reader.onload = async (event) => {
                const textContent = event.target.result;
                if (!textContent) {
                    await uiUtils.showCustomAlert("繝輔ぃ繧､繝ｫ縺ｮ蜀・ｮｹ縺檎ｩｺ縺ｧ縺吶・);
                    return;
                }
                try {
                    const { messages: importedMessages } = this.parseImportedHistory(textContent);
                    if (importedMessages.length === 0) {
                        await uiUtils.showCustomAlert("繝輔ぃ繧､繝ｫ縺九ｉ譛牙柑縺ｪ繝｡繝・そ繝ｼ繧ｸ縺ｾ縺溘・繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧定ｪｭ縺ｿ霎ｼ繧√∪縺帙ｓ縺ｧ縺励◆縲ょｽ｢蠑上ｒ遒ｺ隱阪＠縺ｦ縺上□縺輔＞縲・);
                        return;
                    }

                    let currentGroupId = null;
                    let lastUserIndex = -1;
                    for (let i = 0; i < importedMessages.length; i++) {
                        const msg = importedMessages[i];
                        if (msg.role === 'user') {
                            lastUserIndex = i;
                            currentGroupId = null;
                        } else if (msg.role === 'model' && msg.isCascaded) {
                            if (currentGroupId === null && lastUserIndex !== -1) {
                                currentGroupId = `imp-${Date.now()}-${Math.random().toString(36).substring(2, 8)}`;
                            }
                            if (currentGroupId) {
                                msg.siblingGroupId = currentGroupId;
                            }
                        } else {
                            currentGroupId = null;
                        }
                    }
                    const groupIds = new Set(importedMessages.filter(m => m.siblingGroupId).map(m => m.siblingGroupId));
                    groupIds.forEach(gid => {
                        const siblings = importedMessages.filter(m => m.siblingGroupId === gid);
                        const selected = siblings.filter(m => m.isSelected);
                        if (selected.length === 0 && siblings.length > 0) {
                            siblings[siblings.length - 1].isSelected = true;
                        } else if (selected.length > 1) {
                            selected.slice(0, -1).forEach(m => m.isSelected = false);
                        }
                    });


                    const fileNameWithoutExt = file.name.replace(/\.[^/.]+$/, "");
                    const titlePrefix = state.settings.addPrefixOnImport ? IMPORT_PREFIX : '';
                    const newTitle = titlePrefix + (fileNameWithoutExt || `Imported_${Date.now()}`);

                    // 繧ｭ繝｣繝ｩ繧ｯ繧ｿ繝ｼ諠・ｱ繧貞叙蠕・                    const characterMessage = importedMessages.find(m => m.role === 'character');
                    const characterName = characterMessage ? characterMessage.content : null;
                    
                    // 繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧貞叙蠕励＠縺ｦ繝√Ε繝・ヨ蝗ｺ譛峨・繝励Ο繝ｳ繝励ヨ縺ｨ縺励※險ｭ螳・                    const systemMessage = importedMessages.find(m => m.role === 'system');
                    let chatSystemPrompt = null;
                    if (systemMessage) {
                        chatSystemPrompt = systemMessage.content;
                        // 繝｡繝・そ繝ｼ繧ｸ繝ｪ繧ｹ繝医°繧峨す繧ｹ繝・Β繝｡繝・そ繝ｼ繧ｸ繧帝勁螟厄ｼ磯㍾隍・ｒ驕ｿ縺代ｋ縺溘ａ・・                        const messageIndex = importedMessages.indexOf(systemMessage);
                        if (messageIndex > -1) {
                            importedMessages.splice(messageIndex, 1);
                        }
                    }
                    
                    const newChatData = {
                        messages: importedMessages,
                        updatedAt: Date.now(), createdAt: Date.now(),
                        title: newTitle.substring(0, 100),
                        characterName: characterName,
                        chatSystemPrompt: chatSystemPrompt
                    };
                    const newChatId = await new Promise((resolve, reject) => {
                        const store = dbUtils._getStore(CHATS_STORE, 'readwrite');
                        const request = store.add(newChatData);
                        request.onsuccess = (event) => resolve(event.target.result);
                        request.onerror = (event) => reject(event.target.error);
                    });
                    await uiUtils.showCustomAlert(`螻･豁ｴ縲・{newChatData.title}縲阪ｒ繧､繝ｳ繝昴・繝医＠縺ｾ縺励◆縲Ａ);
                    uiUtils.renderHistoryList();
                } catch (error) {
                    await uiUtils.showCustomAlert(`螻･豁ｴ縺ｮ繧､繝ｳ繝昴・繝井ｸｭ縺ｫ繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆: ${error.message}`);
                }
            };
            reader.onerror = async (event) => {
                await uiUtils.showCustomAlert("繝輔ぃ繧､繝ｫ縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ縺ｫ螟ｱ謨励＠縺ｾ縺励◆縲・);
            };
            reader.readAsText(file);
        },
        parseImportedHistory(text) {
            const messages = [];
            const blockRegex = /<\|#\|(system|user|model|character)\|#\|([^>]*)>([\s\S]*?)<\|#\|\/\1\|#\|>/g;
            let match;

            while ((match = blockRegex.exec(text)) !== null) {
                const role = match[1];
                const attributesString = match[2].trim();
                const content = match[3].trim();

                if ((role === 'user' || role === 'model' || role === 'character' || role === 'system') && (content || attributesString.includes('attachments'))) {
                    const messageData = {
                        role: role, content: content, timestamp: Date.now(), attachments: []
                    };
                    const attributes = {};
                    attributesString.split(/\s+/).forEach(attr => {
                        const eqIndex = attr.indexOf('=');
                        if (eqIndex > 0) {
                            const key = attr.substring(0, eqIndex);
                            let value = attr.substring(eqIndex + 1);
                            if (value.startsWith('"') && value.endsWith('"')) {
                                value = value.substring(1, value.length - 1);
                            }
                            attributes[key] = value.replace(/&quot;/g, '"');
                        } else if (attr) {
                            attributes[attr] = true;
                        }
                    });

                    if (role === 'model') {
                        messageData.isCascaded = attributes['isCascaded'] === true;
                        messageData.isSelected = attributes['isSelected'] === true;
                        messageData.thoughtSummaryOpen = attributes['thoughtOpen'] === true;
                    }
                    if (role === 'user' && attributes['attachments']) {
                        const fileNames = attributes['attachments'].split(';');
                        messageData.attachments = fileNames.map(name => ({
                            name: name, mimeType: 'unknown/unknown', base64Data: ''
                        }));
                    }
                    messages.push(messageData);
                }
            }
            return { messages };
        },
        async exportAllSessions() {
            const confirmed = await uiUtils.showCustomConfirm("蜈ｨ縺ｦ縺ｮ繧ｻ繝・す繝ｧ繝ｳ繧・縺､縺ｮJSON繝輔ぃ繧､繝ｫ縺ｨ縺励※繧ｨ繧ｯ繧ｹ繝昴・繝医＠縺ｾ縺吶°・・);
            if (!confirmed) return;

            try {
                const chats = await dbUtils.getAllChats();
                if (!chats || chats.length === 0) {
                    await uiUtils.showCustomAlert("繧ｨ繧ｯ繧ｹ繝昴・繝医☆繧九そ繝・す繝ｧ繝ｳ縺後≠繧翫∪縺帙ｓ縲・);
                    return;
                }

                const exportableChats = chats.map(chat => ({
                    title: chat.title,
                    messages: chat.messages.map(msg => {
                        const messageExport = {
                            role: msg.role,
                            content: msg.content,
                            timestamp: msg.timestamp,
                            generatedByApiProvider: msg.generatedByApiProvider || null,
                        };
                        if (msg.isCascaded !== undefined) messageExport.isCascaded = msg.isCascaded;
                        if (msg.isSelected !== undefined) messageExport.isSelected = msg.isSelected;
                        if (msg.siblingGroupId !== undefined) messageExport.siblingGroupId = msg.siblingGroupId;
                        if (msg.groundingMetadata) messageExport.groundingMetadata = msg.groundingMetadata;
                        if (msg.usageMetadata) messageExport.usageMetadata = msg.usageMetadata;
                        if (msg.thoughtSummary) messageExport.thoughtSummary = msg.thoughtSummary;
                        if (msg.deepSeekThoughtSummary) messageExport.deepSeekThoughtSummary = msg.deepSeekThoughtSummary;
                        if (msg.thoughtSummaryOpen !== undefined) messageExport.thoughtSummaryOpen = msg.thoughtSummaryOpen;
                        if (msg.attachments && msg.attachments.length > 0) {
                            messageExport.attachments = msg.attachments.map(att => ({ name: att.name, mimeType: att.mimeType, textData: att.textData }));
                        }
                        return messageExport;
                    }),
                    createdAt: chat.createdAt,
                    updatedAt: chat.updatedAt,
                    ...(chat.characterName && { characterName: chat.characterName }),
                    ...(chat.chatSystemPrompt && { chatSystemPrompt: chat.chatSystemPrompt }),
                    ...(state.settings.persistMessageCollapseState && chat.collapsedStates && { collapsedStates: chat.collapsedStates })
                }));

                const jsonString = JSON.stringify(exportableChats, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                a.href = url;
                a.download = `gemini_pwa_all_sessions_${timestamp}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                await uiUtils.showCustomAlert(`${chats.length}莉ｶ縺ｮ繧ｻ繝・す繝ｧ繝ｳ繧偵お繧ｯ繧ｹ繝昴・繝医＠縺ｾ縺励◆縲Ａ);
            } catch (error) {
                await uiUtils.showCustomAlert(`蜈ｨ繧ｻ繝・す繝ｧ繝ｳ縺ｮ繧ｨ繧ｯ繧ｹ繝昴・繝井ｸｭ縺ｫ繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆: ${error.message || error}`);
            }
        },
        async handleAllSessionsImport(file) {
            if (!file || file.type !== 'application/json') {
                await uiUtils.showCustomAlert("JSON繝輔ぃ繧､繝ｫ (.json) 繧帝∈謚槭＠縺ｦ縺上□縺輔＞縲・);
                return;
            }
            const reader = new FileReader();
            reader.onload = async (event) => {
                const textContent = event.target.result;
                if (!textContent) {
                    await uiUtils.showCustomAlert("繝輔ぃ繧､繝ｫ縺ｮ蜀・ｮｹ縺檎ｩｺ縺ｧ縺吶・);
                    return;
                }
                try {
                    const importedData = JSON.parse(textContent);
                    if (!Array.isArray(importedData)) {
                        await uiUtils.showCustomAlert("辟｡蜉ｹ縺ｪ繝輔ぃ繧､繝ｫ蠖｢蠑上〒縺吶ゅメ繝｣繝・ヨ繝・・繧ｿ縺ｮ驟榊・縺ｧ縺ｯ縺ゅｊ縺ｾ縺帙ｓ縲・);
                        return;
                    }

                    if (importedData.length === 0) {
                        await uiUtils.showCustomAlert("繝輔ぃ繧､繝ｫ縺ｫ繧､繝ｳ繝昴・繝亥ｯｾ雎｡縺ｮ繧ｻ繝・す繝ｧ繝ｳ繝・・繧ｿ縺悟性縺ｾ繧後※縺・∪縺帙ｓ縲・);
                        return;
                    }

                    const confirmed = await uiUtils.showCustomConfirm(
                        `${importedData.length}莉ｶ縺ｮ繧ｻ繝・す繝ｧ繝ｳ繧偵う繝ｳ繝昴・繝医＠縺ｾ縺吶°・歃n(譌｢蟄倥・螻･豁ｴ縺ｨ繧ｿ繧､繝医Ν縺碁㍾隍・☆繧句ｴ蜷医∝挨螻･豁ｴ縺ｨ縺励※霑ｽ蜉縺輔ｌ縺ｾ縺・`
                    );
                    if (!confirmed) return;

                    let importedCount = 0;
                    let skippedCount = 0;
                    const importTimestamp = Date.now();

                    for (const chatData of importedData) {
                        if (typeof chatData.title !== 'string' || !Array.isArray(chatData.messages)) {
                            skippedCount++;
                            continue;
                        }

                        const titlePrefix = state.settings.addPrefixOnImport ? `${IMPORT_PREFIX}(蜈ｨ) ` : '';
                        const newChat = {
                            title: `${titlePrefix}${chatData.title}`.substring(0,100),
                            messages: (chatData.messages || []).map(msg => ({
                                role: msg.role,
                                content: msg.content || '',
                                timestamp: typeof msg.timestamp === 'number' ? msg.timestamp : importTimestamp,
                                isCascaded: msg.isCascaded === true,
                                isSelected: msg.isSelected === true,
                                siblingGroupId: msg.siblingGroupId || undefined,
                                thoughtSummary: msg.thoughtSummary || undefined,
                                deepSeekThoughtSummary: msg.deepSeekThoughtSummary || undefined,
                                thoughtSummaryOpen: msg.thoughtSummaryOpen || false,
                                generatedByApiProvider: msg.generatedByApiProvider || undefined,
                                attachments: (msg.attachments || []).map(att => ({
                                    name: att.name || 'imported_file',
                                    mimeType: att.mimeType || 'application/octet-stream',
                                    base64Data: '',
                                    textData: att.textData || ''
                                })),
                                groundingMetadata: msg.groundingMetadata || undefined,
                                usageMetadata: msg.usageMetadata || undefined,
                                error: msg.error || undefined,
                            })),
                            createdAt: typeof chatData.createdAt === 'number' ? chatData.createdAt : importTimestamp,
                            updatedAt: typeof chatData.updatedAt === 'number' ? chatData.updatedAt : importTimestamp,
                        };
                        if (chatData.characterName) {
                            newChat.characterName = chatData.characterName;
                        }
                        if (chatData.chatSystemPrompt) {
                            newChat.chatSystemPrompt = chatData.chatSystemPrompt;
                        }
                        if (state.settings.persistMessageCollapseState && chatData.collapsedStates) {
                            newChat.collapsedStates = { ...chatData.collapsedStates };
                        }

                        const groupIds = new Set(newChat.messages.filter(m => m.siblingGroupId).map(m => m.siblingGroupId));
                        groupIds.forEach(gid => {
                            const siblings = newChat.messages.filter(m => m.siblingGroupId === gid);
                            const selectedSiblings = siblings.filter(m => m.isSelected);
                            if (selectedSiblings.length === 0 && siblings.length > 0) {
                                siblings[siblings.length - 1].isSelected = true;
                            } else if (selectedSiblings.length > 1) {
                                for (let i = 0; i < selectedSiblings.length - 1; i++) {
                                    selectedSiblings[i].isSelected = false;
                                }
                            }
                        });

                        try {
                            await new Promise((resolve, reject) => {
                                const store = dbUtils._getStore(CHATS_STORE, 'readwrite');
                                const request = store.add(newChat);
                                request.onsuccess = () => {
                                    importedCount++;
                                    resolve();
                                };
                                request.onerror = (e) => {
                                    skippedCount++;
                                    resolve();
                                };
                            });
                        } catch (e) {
                            skippedCount++;
                        }
                    }

                    let message = `${importedCount}莉ｶ縺ｮ繧ｻ繝・す繝ｧ繝ｳ繧偵う繝ｳ繝昴・繝医＠縺ｾ縺励◆縲Ａ;
                    if (skippedCount > 0) {
                        message += ` ${skippedCount}莉ｶ縺ｯ蠖｢蠑上お繝ｩ繝ｼ遲峨〒繧ｹ繧ｭ繝・・縺輔ｌ縺ｾ縺励◆縲Ａ;
                    }
                    await uiUtils.showCustomAlert(message);
                    if (importedCount > 0) {
                        uiUtils.renderHistoryList();
                    }

                } catch (error) {
                    await uiUtils.showCustomAlert(`蜈ｨ繧ｻ繝・す繝ｧ繝ｳ縺ｮ繧､繝ｳ繝昴・繝井ｸｭ縺ｫ繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆: ${error.message || error}`);
                }
            };
            reader.onerror = async () => {
                await uiUtils.showCustomAlert("繝輔ぃ繧､繝ｫ縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ縺ｫ螟ｱ謨励＠縺ｾ縺励◆縲・);
            };
            reader.readAsText(file);
        },
         async handleBackgroundImageUpload(file) {
             const maxSize = 5 * 1024 * 1024;
             if (file.size > maxSize) {
                 await uiUtils.showCustomAlert(`逕ｻ蜒上し繧､繧ｺ縺悟､ｧ縺阪☆縺弱∪縺・(${(maxSize / 1024 / 1024).toFixed(1)}MB莉･荳九↓縺励※縺上□縺輔＞)`);
                 return;
             }
             if (!file.type.startsWith('image/')) {
                 await uiUtils.showCustomAlert("逕ｻ蜒上ヵ繧｡繧､繝ｫ繧帝∈謚槭＠縺ｦ縺上□縺輔＞ (JPEG, PNG, GIF, WebP縺ｪ縺ｩ)");
                 return;
             }

             try {
                 uiUtils.revokeExistingObjectUrl();
                 const blob = file;
                 const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                 
                 if (isIOS) {
                     const arrayBuffer = await blob.arrayBuffer();
                     await dbUtils.saveSetting('backgroundImageBlob', { arrayBuffer, type: blob.type });
                     state.settings.backgroundImageBlob = { arrayBuffer, type: blob.type };
                     // 陦ｨ遉ｺ逕ｨ縺ｫ譁ｰ縺励＞Blob繧剃ｽ懈・
                     const displayBlob = new Blob([arrayBuffer], { type: blob.type });
                     state.backgroundImageUrl = URL.createObjectURL(displayBlob);
                 } else {
                     await dbUtils.saveSetting('backgroundImageBlob', blob);
                     state.settings.backgroundImageBlob = blob;
                     state.backgroundImageUrl = URL.createObjectURL(blob);
                 }
                 
                 // dirty繝輔Λ繧ｰ繧定ｨｭ螳・                 state.assetDirty.bgImage = true;
                 document.documentElement.style.setProperty('--chat-background-image', `url(${state.backgroundImageUrl})`);
                 uiUtils.updateBackgroundSettingsUI();
                 uiUtils.updatePromptBackgroundDisplay();
             } catch (error) {
                 uiUtils.revokeExistingObjectUrl();
                 document.documentElement.style.setProperty('--chat-background-image', 'none');
                 state.settings.backgroundImageBlob = null;
                 // dirty繝輔Λ繧ｰ繧定ｨｭ螳・                 state.assetDirty.bgImage = true;
                 uiUtils.updateBackgroundSettingsUI();
                 uiUtils.updatePromptBackgroundDisplay();
             }
         },
         async confirmDeleteBackgroundImage() {
             const confirmed = await uiUtils.showCustomConfirm("閭梧勹逕ｻ蜒上ｒ蜑企勁縺励∪縺吶°・・);
             if (confirmed) {
                 await this.handleBackgroundImageDelete();
             }
         },
         async handleBackgroundImageDelete() {
             try {
                 uiUtils.revokeExistingObjectUrl();
                 await dbUtils.saveSetting('backgroundImageBlob', null);
                 state.settings.backgroundImageBlob = null;
                 // dirty繝輔Λ繧ｰ繧定ｨｭ螳・                 state.assetDirty.bgImage = true;
                 document.documentElement.style.setProperty('--chat-background-image', 'none');
                 uiUtils.updateBackgroundSettingsUI();
                 uiUtils.updatePromptBackgroundDisplay();
             } catch (error) {
             }
         },
        async handleIconUpload(type, file) {
             const maxSize = 1 * 1024 * 1024;
             if (file.size > maxSize) {
                 await uiUtils.showCustomAlert(`逕ｻ蜒上し繧､繧ｺ縺悟､ｧ縺阪☆縺弱∪縺・(${(maxSize / 1024 / 1024).toFixed(1)}MB莉･荳・縲Ａ);
                 return;
             }
             if (!file.type.startsWith('image/')) {
                 await uiUtils.showCustomAlert("逕ｻ蜒上ヵ繧｡繧､繝ｫ繧帝∈謚槭＠縺ｦ縺上□縺輔＞縲・);
                 return;
             }

             try {
                 const blob = file;
                 const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                 
                 if (type === 'user') {
                     if(state.userIconUrl) URL.revokeObjectURL(state.userIconUrl);
                     if (isIOS) {
                         const arrayBuffer = await blob.arrayBuffer();
                         await dbUtils.saveSetting('userIconBlob', { arrayBuffer, type: blob.type });
                         state.settings.userIconBlob = { arrayBuffer, type: blob.type };
                         const displayBlob = new Blob([arrayBuffer], { type: blob.type });
                         state.userIconUrl = URL.createObjectURL(displayBlob);
                     } else {
                         await dbUtils.saveSetting('userIconBlob', blob);
                         state.settings.userIconBlob = blob;
                         state.userIconUrl = URL.createObjectURL(blob);
                     }
                 } else if (type === 'ai') {
                     if(state.aiIconUrl) URL.revokeObjectURL(state.aiIconUrl);
                     if (isIOS) {
                         const arrayBuffer = await blob.arrayBuffer();
                         await dbUtils.saveSetting('aiIconBlob', { arrayBuffer, type: blob.type });
                         state.settings.aiIconBlob = { arrayBuffer, type: blob.type };
                         const displayBlob = new Blob([arrayBuffer], { type: blob.type });
                         state.aiIconUrl = URL.createObjectURL(displayBlob);
                     } else {
                         await dbUtils.saveSetting('aiIconBlob', blob);
                         state.settings.aiIconBlob = blob;
                         state.aiIconUrl = URL.createObjectURL(blob);
                     }
                     // dirty繝輔Λ繧ｰ繧定ｨｭ螳・                     state.assetDirty.aiIcon = true;
                 }
                 uiUtils.updateIconSettingsUI();
                 uiUtils.renderChatMessages(true);
             } catch (error) {
                 await uiUtils.showCustomAlert(`${type === 'user' ? '繝ｦ繝ｼ繧ｶ繝ｼ' : 'AI'}繧｢繧､繧ｳ繝ｳ縺ｮ蜃ｦ逅・お繝ｩ繝ｼ: ${error}`);
             }
        },
        async confirmDeleteIcon(type) {
            const iconName = type === 'user' ? '繝ｦ繝ｼ繧ｶ繝ｼ' : 'AI';
            const confirmed = await uiUtils.showCustomConfirm(`${iconName}繧｢繧､繧ｳ繝ｳ繧貞炎髯､縺励∪縺吶°・歔);
            if (confirmed) {
                await this.handleIconDelete(type);
            }
        },
        async handleIconDelete(type) {
             try {
                 if (type === 'user') {
                     if (state.userIconUrl) URL.revokeObjectURL(state.userIconUrl);
                     state.userIconUrl = null;
                     state.settings.userIconBlob = null;
                     await dbUtils.saveSetting('userIconBlob', null);
                 } else if (type === 'ai') {
                     if (state.aiIconUrl) URL.revokeObjectURL(state.aiIconUrl);
                     state.aiIconUrl = null;
                     state.settings.aiIconBlob = null;
                     // dirty繝輔Λ繧ｰ繧定ｨｭ螳・                     state.assetDirty.aiIcon = true;
                     await dbUtils.saveSetting('aiIconBlob', null);
                 }
                 uiUtils.updateIconSettingsUI();
                 uiUtils.renderChatMessages(true);
             } catch (error) {
                 await uiUtils.showCustomAlert(`${type === 'user' ? '繝ｦ繝ｼ繧ｶ繝ｼ' : 'AI'}繧｢繧､繧ｳ繝ｳ縺ｮ蜑企勁繧ｨ繝ｩ繝ｼ: ${error}`);
             }
        },
        async saveSettings(showNotice = true) {
            const newSettings = { ...state.settings };
            newSettings.showMultiApiKeys = elements.showMultiApiKeysToggle.checked;
            newSettings.disableSaveSettingsConfirmation = elements.disableSaveSettingsConfirmationToggle.checked;
            newSettings.autoSaveSettings = elements.autoSaveSettingsToggle.checked;

            if (newSettings.showMultiApiKeys) {
            } else {
                newSettings.apiKey = elements.geminiApiKeyInput.value.trim();
                newSettings.deepSeekApiKey = elements.deepSeekApiKeyInput.value.trim();
                newSettings.claudeApiKey = elements.claudeApiKeyInput.value.trim();
                newSettings.openaiApiKey = elements.openaiApiKeyInput.value.trim();
                newSettings.xaiApiKey = elements.xaiApiKeyInput.value.trim();
                newSettings.llmAggregatorApiKey = elements.llmAggregatorApiKeyInput.value.trim();
            }

             newSettings.apiProvider = elements.apiProviderSelect.value;
             newSettings.modelName = elements.geminiModelNameSelect.value;
             newSettings.additionalModels = elements.geminiAdditionalModelsTextarea.value.trim();
             newSettings.commonSystemPrompt = elements.commonSystemPromptDefaultTextarea.value.trim();
             newSettings.enableCommonSystemPromptDefault = elements.enableCommonSystemPromptDefaultCheckbox.checked;
             
             newSettings.deepSeekModelName = elements.deepSeekModelNameSelect.value;
             newSettings.deepSeekAdditionalModels = elements.deepSeekAdditionalModelsTextarea.value.trim();
             newSettings.deepSeekApiEndpoint = elements.deepSeekApiEndpointInput.value.trim();
             newSettings.claudeModelName = elements.claudeModelNameSelect.value;
             newSettings.claudeAdditionalModels = elements.claudeAdditionalModelsTextarea.value.trim();
             newSettings.openaiModelName = elements.openaiModelNameSelect.value;
             newSettings.openaiAdditionalModels = elements.openaiAdditionalModelsTextarea.value.trim();
             newSettings.xaiModelName = elements.xaiModelNameSelect.value;
             newSettings.xaiAdditionalModels = elements.xaiAdditionalModelsTextarea.value.trim();
             newSettings.llmAggregatorApiBackend = elements.llmAggregatorApiBackendInput.value.trim();
             newSettings.llmAggregatorModelName = elements.llmAggregatorModelNameSelect.value;
             newSettings.llmAggregatorAdditionalModels = elements.llmAggregatorAdditionalModelsTextarea.value.trim();

            newSettings.geminiSystemPrompt = elements.geminiSystemPromptDefaultTextarea.value.trim();
            newSettings.geminiEnableSystemPromptDefault = elements.geminiEnableSystemPromptDefaultCheckbox.checked;
            newSettings.geminiTemperature = elements.geminiTemperatureInput.value === '' ? null : parseFloat(elements.geminiTemperatureInput.value);
            newSettings.geminiMaxTokens = elements.geminiMaxTokensInput.value === '' ? null : parseInt(elements.geminiMaxTokensInput.value);
            newSettings.geminiTopK = elements.geminiTopKInput.value === '' ? null : parseInt(elements.geminiTopKInput.value);
            newSettings.geminiTopP = elements.geminiTopPInput.value === '' ? null : parseFloat(elements.geminiTopPInput.value);
            newSettings.geminiPresencePenalty = elements.geminiPresencePenaltyInput.value === '' ? null : parseFloat(elements.geminiPresencePenaltyInput.value);
            newSettings.geminiFrequencyPenalty = elements.geminiFrequencyPenaltyInput.value === '' ? null : parseFloat(elements.geminiFrequencyPenaltyInput.value);
            newSettings.geminiThinkingBudget = elements.geminiThinkingBudgetInput.value === '' ? null : parseInt(elements.geminiThinkingBudgetInput.value, 10);
            newSettings.geminiIncludeThoughts = elements.geminiIncludeThoughtsToggle.checked;
            newSettings.geminiExpandThoughtsByDefault = elements.geminiExpandThoughtsByDefaultToggle.checked;
            newSettings.geminiStreamingOutput = elements.geminiStreamingOutputCheckbox.checked;
            newSettings.geminiStreamingSpeed = elements.geminiStreamingSpeedInput.value === '' ? DEFAULT_STREAMING_SPEED : parseInt(elements.geminiStreamingSpeedInput.value);
            newSettings.geminiDummyUser = elements.geminiDummyUserInput.value.trim();
            newSettings.geminiEnableDummyUser = elements.geminiEnableDummyUserCheckbox.checked;
            newSettings.geminiDummyModel = elements.geminiDummyModelInput.value.trim();
            newSettings.geminiEnableDummyModel = elements.geminiEnableDummyModelCheckbox.checked;
            newSettings.geminiConcatDummyModel = elements.geminiConcatDummyModelCheckbox.checked;
            newSettings.geminiPseudoStreaming = elements.geminiPseudoStreamingCheckbox.checked;
            newSettings.geminiEnableGrounding = elements.geminiEnableGroundingToggle.checked;

            newSettings.deepSeekSystemPrompt = elements.deepSeekSystemPromptDefaultTextarea.value.trim();
            newSettings.deepSeekEnableSystemPromptDefault = elements.deepSeekEnableSystemPromptDefaultCheckbox.checked;
            newSettings.deepSeekTemperature = elements.deepSeekTemperatureInput.value === '' ? null : parseFloat(elements.deepSeekTemperatureInput.value);
            newSettings.deepSeekMaxTokens = elements.deepSeekMaxTokensInput.value === '' ? null : parseInt(elements.deepSeekMaxTokensInput.value);
            newSettings.deepSeekTopP = elements.deepSeekTopPInput.value === '' ? null : parseFloat(elements.deepSeekTopPInput.value);
            newSettings.deepSeekPresencePenalty = elements.deepSeekPresencePenaltyInput.value === '' ? null : parseFloat(elements.deepSeekPresencePenaltyInput.value);
            newSettings.deepSeekFrequencyPenalty = elements.deepSeekFrequencyPenaltyInput.value === '' ? null : parseFloat(elements.deepSeekFrequencyPenaltyInput.value);
            newSettings.deepSeekIncludeDeepSeekThoughts = elements.deepSeekIncludeThoughtsToggle.checked;
            newSettings.deepSeekExpandThoughtsByDefault = elements.deepSeekExpandThoughtsByDefaultToggle.checked;
            newSettings.deepSeekStreamingOutput = elements.deepSeekStreamingOutputCheckbox.checked;
            newSettings.deepSeekStreamingSpeed = elements.deepSeekStreamingSpeedInput.value === '' ? DEFAULT_STREAMING_SPEED : parseInt(elements.deepSeekStreamingSpeedInput.value);
            newSettings.deepSeekDummyUser = elements.deepSeekDummyUserInput.value.trim();
            newSettings.deepSeekEnableDummyUser = elements.deepSeekEnableDummyUserCheckbox.checked;
            newSettings.deepSeekDummyModel = elements.deepSeekDummyModelInput.value.trim();
            newSettings.deepSeekEnableDummyModel = elements.deepSeekEnableDummyModelCheckbox.checked;
            newSettings.deepSeekConcatDummyModel = elements.deepSeekConcatDummyModelCheckbox.checked;

            newSettings.claudeSystemPrompt = elements.claudeSystemPromptDefaultTextarea.value.trim();
            newSettings.claudeEnableSystemPromptDefault = elements.claudeEnableSystemPromptDefaultCheckbox.checked;
            newSettings.claudeTemperature = elements.claudeTemperatureInput.value === '' ? null : parseFloat(elements.claudeTemperatureInput.value);
            newSettings.claudeMaxTokens = elements.claudeMaxTokensInput.value === '' ? null : parseInt(elements.claudeMaxTokensInput.value);
            newSettings.claudeTopK = elements.claudeTopKInput.value === '' ? null : parseInt(elements.claudeTopKInput.value);
            newSettings.claudeTopP = elements.claudeTopPInput.value === '' ? null : parseFloat(elements.claudeTopPInput.value);
            newSettings.claudeStreamingOutput = elements.claudeStreamingOutputCheckbox.checked;
            newSettings.claudeStreamingSpeed = elements.claudeStreamingSpeedInput.value === '' ? DEFAULT_STREAMING_SPEED : parseInt(elements.claudeStreamingSpeedInput.value);
            newSettings.claudeDummyUser = elements.claudeDummyUserInput.value.trim();
            newSettings.claudeEnableDummyUser = elements.claudeEnableDummyUserCheckbox.checked;
            newSettings.claudeDummyModel = elements.claudeDummyModelInput.value.trim();
            newSettings.claudeEnableDummyModel = elements.claudeEnableDummyModelCheckbox.checked;
            newSettings.claudeConcatDummyModel = elements.claudeConcatDummyModelCheckbox.checked;
            newSettings.claudeIncludeThoughts = elements.claudeIncludeThoughtsToggle.checked;
            newSettings.claudeExpandThoughtsByDefault = elements.claudeExpandThoughtsByDefaultToggle.checked;
            newSettings.claudeThinkingBudget = elements.claudeThinkingBudgetInput.value === '' ? null : parseInt(elements.claudeThinkingBudgetInput.value, 10);

            newSettings.openaiSystemPrompt = elements.openaiSystemPromptDefaultTextarea.value.trim();
            newSettings.openaiEnableSystemPromptDefault = elements.openaiEnableSystemPromptDefaultCheckbox.checked;
            newSettings.openaiTemperature = elements.openaiTemperatureInput.value === '' ? null : parseFloat(elements.openaiTemperatureInput.value);
            newSettings.openaiMaxTokens = elements.openaiMaxTokensInput.value === '' ? null : parseInt(elements.openaiMaxTokensInput.value);
            newSettings.openaiTopP = elements.openaiTopPInput.value === '' ? null : parseFloat(elements.openaiTopPInput.value);
            newSettings.openaiPresencePenalty = elements.openaiPresencePenaltyInput.value === '' ? null : parseFloat(elements.openaiPresencePenaltyInput.value);
            newSettings.openaiFrequencyPenalty = elements.openaiFrequencyPenaltyInput.value === '' ? null : parseFloat(elements.openaiFrequencyPenaltyInput.value);
            newSettings.openaiStreamingOutput = elements.openaiStreamingOutputCheckbox.checked;
            newSettings.openaiStreamingSpeed = elements.openaiStreamingSpeedInput.value === '' ? DEFAULT_STREAMING_SPEED : parseInt(elements.openaiStreamingSpeedInput.value);
            newSettings.openaiDummyUser = elements.openaiDummyUserInput.value.trim();
            newSettings.openaiEnableDummyUser = elements.openaiEnableDummyUserCheckbox.checked;
            newSettings.openaiDummyModel = elements.openaiDummyModelInput.value.trim();
            newSettings.openaiEnableDummyModel = elements.openaiEnableDummyModelCheckbox.checked;
            newSettings.openaiConcatDummyModel = elements.openaiConcatDummyModelCheckbox.checked;
            
            newSettings.xaiSystemPrompt = elements.xaiSystemPromptDefaultTextarea.value.trim();
            newSettings.xaiEnableSystemPromptDefault = elements.xaiEnableSystemPromptDefaultCheckbox.checked;
            newSettings.xaiTemperature = elements.xaiTemperatureInput.value === '' ? null : parseFloat(elements.xaiTemperatureInput.value);
            newSettings.xaiMaxTokens = elements.xaiMaxTokensInput.value === '' ? null : parseInt(elements.xaiMaxTokensInput.value);
            newSettings.xaiTopP = elements.xaiTopPInput.value === '' ? null : parseFloat(elements.xaiTopPInput.value);
            newSettings.xaiPresencePenalty = elements.xaiPresencePenaltyInput.value === '' ? null : parseFloat(elements.xaiPresencePenaltyInput.value);
            newSettings.xaiFrequencyPenalty = elements.xaiFrequencyPenaltyInput.value === '' ? null : parseFloat(elements.xaiFrequencyPenaltyInput.value);
            newSettings.xaiStreamingOutput = elements.xaiStreamingOutputCheckbox.checked;
            newSettings.xaiStreamingSpeed = elements.xaiStreamingSpeedInput.value === '' ? DEFAULT_STREAMING_SPEED : parseInt(elements.xaiStreamingSpeedInput.value);
            newSettings.xaiDummyUser = elements.xaiDummyUserInput.value.trim();
            newSettings.xaiEnableDummyUser = elements.xaiEnableDummyUserCheckbox.checked;
            newSettings.xaiDummyModel = elements.xaiDummyModelInput.value.trim();
            newSettings.xaiEnableDummyModel = elements.xaiEnableDummyModelCheckbox.checked;
            newSettings.xaiConcatDummyModel = elements.xaiConcatDummyModelCheckbox.checked;
            newSettings.xaiVisionEnable = elements.xaiVisionEnableCheckbox.checked;
            newSettings.xaiIncludeThoughts = elements.xaiIncludeThoughtsToggle.checked;
            newSettings.xaiExpandThoughtsByDefault = elements.xaiExpandThoughtsByDefaultToggle.checked;
            newSettings.xaiReasoningEffort = elements.xaiReasoningEffortSelect.value;
            
            newSettings.llmAggregatorSystemPrompt = elements.llmAggregatorSystemPromptDefaultTextarea.value.trim();
            newSettings.llmAggregatorEnableSystemPromptDefault = elements.llmAggregatorEnableSystemPromptDefaultCheckbox.checked;
            newSettings.llmAggregatorTemperature = elements.llmAggregatorTemperatureInput.value === '' ? null : parseFloat(elements.llmAggregatorTemperatureInput.value);
            newSettings.llmAggregatorMaxTokens = elements.llmAggregatorMaxTokensInput.value === '' ? null : parseInt(elements.llmAggregatorMaxTokensInput.value);
            newSettings.llmAggregatorTopP = elements.llmAggregatorTopPInput.value === '' ? null : parseFloat(elements.llmAggregatorTopPInput.value);
            newSettings.llmAggregatorTopK = elements.llmAggregatorTopKInput.value === '' ? null : parseInt(elements.llmAggregatorTopKInput.value);
            newSettings.llmAggregatorPresencePenalty = elements.llmAggregatorPresencePenaltyInput.value === '' ? null : parseFloat(elements.llmAggregatorPresencePenaltyInput.value);
            newSettings.llmAggregatorFrequencyPenalty = elements.llmAggregatorFrequencyPenaltyInput.value === '' ? null : parseFloat(elements.llmAggregatorFrequencyPenaltyInput.value);
            newSettings.llmAggregatorIncludeThoughts = elements.llmAggregatorIncludeThoughtsToggle.checked;
            newSettings.llmAggregatorExpandThoughtsByDefault = elements.llmAggregatorExpandThoughtsByDefaultToggle.checked;
            newSettings.llmAggregatorStreamingOutput = elements.llmAggregatorStreamingOutputCheckbox.checked;
            newSettings.llmAggregatorStreamingSpeed = elements.llmAggregatorStreamingSpeedInput.value === '' ? DEFAULT_STREAMING_SPEED : parseInt(elements.llmAggregatorStreamingSpeedInput.value);
            newSettings.llmAggregatorDummyUser = elements.llmAggregatorDummyUserInput.value.trim();
            newSettings.llmAggregatorEnableDummyUser = elements.llmAggregatorEnableDummyUserCheckbox.checked;
            newSettings.llmAggregatorDummyModel = elements.llmAggregatorDummyModelInput.value.trim();
            newSettings.llmAggregatorEnableDummyModel = elements.llmAggregatorEnableDummyModelCheckbox.checked;
            newSettings.llmAggregatorConcatDummyModel = elements.llmAggregatorConcatDummyModelCheckbox.checked;

             newSettings.enterToSend = elements.enterToSendCheckbox.checked;
             newSettings.autoScrollOnNewMessage = elements.autoScrollOnNewMessageCheckbox.checked;
             newSettings.autoScrollOnThought = elements.autoScrollOnThoughtCheckbox.checked;
             newSettings.historySortOrder = elements.historySortOrderSelect.value;
             newSettings.theme = elements.themeSelect.value;
             newSettings.enableSessionLinking = elements.enableSessionLinkingCheckbox.checked;
             newSettings.fontFamily = elements.fontFamilyInput.value.trim();
             newSettings.messageBodyFontSize = elements.messageBodyFontSizeInput.value === '' ? null : parseInt(elements.messageBodyFontSizeInput.value, 10);
             newSettings.codeBlockFontSize = elements.codeBlockFontSizeInput.value === '' ? null : parseInt(elements.codeBlockFontSizeInput.value, 10);
             newSettings.thoughtSummaryFontSize = elements.thoughtSummaryFontSizeInput.value === '' ? null : parseInt(elements.thoughtSummaryFontSizeInput.value, 10);
             newSettings.enableSwipeNavigation = elements.swipeNavigationToggle.checked;
             newSettings.preventZoom = elements.preventZoomToggle.checked;
             newSettings.minimizeHeader = document.getElementById('minimize-header-toggle').checked;
             newSettings.minimizeFooter = document.getElementById('minimize-footer-toggle').checked;
             newSettings.showSessionLinkingSettings = elements.showSessionLinkingSettingsToggle.checked;
             newSettings.showChatTitle = elements.showChatTitleToggle.checked;
             newSettings.showNewChatButton = elements.showNewChatButtonToggle.checked;
             newSettings.showDeleteSessionButton = elements.showDeleteSessionButtonToggle.checked;
             newSettings.showCopySessionButton = elements.showCopySessionButtonToggle.checked;
             newSettings.showScrollToTopButton = elements.showScrollToTopButtonToggle.checked;
             newSettings.showScrollToBottomButton = elements.showScrollToBottomButtonToggle.checked;
             newSettings.showToggleAllContentButton = elements.showToggleAllContentButtonToggle.checked;
             newSettings.showBulkHistoryActions = elements.showBulkHistoryActionsToggle.checked;
             newSettings.showPasteButtonInFooter = elements.showPasteButtonInFooterToggle.checked;
             newSettings.showPasteButtonInEdit = elements.showPasteButtonInEditToggle.checked;
             newSettings.showDiceButton = elements.showDiceButtonToggle.checked;
             newSettings.diceMinValue = elements.diceMinValueInput.value === '' ? null : parseInt(elements.diceMinValueInput.value, 10);
             newSettings.diceMaxValue = elements.diceMaxValueInput.value === '' ? null : parseInt(elements.diceMaxValueInput.value, 10);
             newSettings.showMemoButton = elements.showMemoButtonToggle.checked;
             newSettings.memoHeight = elements.memoHeightInput.value.trim() || DEFAULT_MEMO_HEIGHT;
             newSettings.showClipboardStackButton = elements.showClipboardStackButtonToggle.checked;
             newSettings.clipboardStackHeight = state.settings.clipboardStackHeight;
             newSettings.showUserIcon = elements.showUserIconToggle.checked;
             newSettings.showUserName = elements.showUserNameToggle.checked;
              newSettings.showAiIcon = elements.showAiIconToggle.checked;
             newSettings.showAiName = elements.showAiNameToggle.checked;
             newSettings.aiName = elements.aiNameInput.value.trim() || DEFAULT_AI_NAME;
             newSettings.iconNameFontSize = parseInt(elements.iconNameFontSizeInput.value, 10) || DEFAULT_ICON_NAME_FONT_SIZE;
             newSettings.iconNameOffsetY = (elements.iconNameOffsetYInput.value === '' ? DEFAULT_ICON_NAME_OFFSET_Y : parseInt(elements.iconNameOffsetYInput.value, 10) * -1);
             newSettings.messageIconSize = parseInt(elements.messageIconSizeInput.value, 10) || DEFAULT_MESSAGE_ICON_SIZE;
             newSettings.messageIconOffsetY = (elements.messageIconOffsetYInput.value === '' ? DEFAULT_MESSAGE_ICON_OFFSET_Y : parseInt(elements.messageIconOffsetYInput.value, 10) * -1);
             newSettings.showUserNameBubble = elements.userNameBubbleToggle.checked;
             newSettings.userNameBubbleUseThemeColor = elements.userNameBubbleUseThemeColorToggle.checked;
             newSettings.userNameBubbleColor = elements.userNameBubbleColorInput.value.trim() || DEFAULT_USER_NAME_BUBBLE_COLOR;
             newSettings.userNameBubbleOpacity = elements.userNameBubbleOpacityInput.value === '' ? DEFAULT_USER_NAME_BUBBLE_OPACITY : parseFloat(elements.userNameBubbleOpacityInput.value);
             newSettings.showAiNameBubble = elements.aiNameBubbleToggle.checked;
             newSettings.aiNameBubbleUseThemeColor = elements.aiNameBubbleUseThemeColorToggle.checked;
             newSettings.aiNameBubbleColor = elements.aiNameBubbleColorInput.value.trim() || DEFAULT_AI_NAME_BUBBLE_COLOR;
             newSettings.aiNameBubbleOpacity = elements.aiNameBubbleOpacityInput.value === '' ? DEFAULT_AI_NAME_BUBBLE_OPACITY : parseFloat(elements.aiNameBubbleOpacityInput.value);
             newSettings.disableRetryConfirmation = elements.disableRetryConfirmationToggle.checked;
             newSettings.disableLoadChatConfirmationWhileSending = elements.disableLoadChatConfirmationWhileSendingToggle.checked;
             newSettings.disableDeleteMessageConfirmation = elements.disableDeleteMessageConfirmationToggle.checked;
             newSettings.disableAttachmentConfirmation = elements.disableAttachmentConfirmationToggle.checked;
             newSettings.addPrefixOnImport = elements.addPrefixOnImportToggle.checked;
             newSettings.showTopCollapseButton = elements.showTopCollapseButtonToggle.checked;
             newSettings.showBottomCollapseButton = elements.showBottomCollapseButtonToggle.checked;
             newSettings.persistMessageCollapseState = elements.persistMessageCollapseStateCheckbox.checked;
             newSettings.messageBubbleOpacity = elements.messageBubbleOpacityInput.value === '' ? DEFAULT_MESSAGE_BUBBLE_OPACITY : parseFloat(elements.messageBubbleOpacityInput.value);
             newSettings.chatOverlayOpacity = elements.chatOverlayOpacityInput.value === '' ? DEFAULT_CHAT_OVERLAY_OPACITY : parseFloat(elements.chatOverlayOpacityInput.value);
             newSettings.headerFooterOpacity = elements.headerFooterOpacityInput.value === '' ? DEFAULT_HEADER_FOOTER_OPACITY : parseFloat(elements.headerFooterOpacityInput.value);
             newSettings.messageActionsBackgroundOpacity = elements.messageActionsBackgroundOpacityInput.value === '' ? DEFAULT_MESSAGE_ACTIONS_BACKGROUND_OPACITY : parseFloat(elements.messageActionsBackgroundOpacityInput.value);
             newSettings.toggleButtonTopWidth = parseInt(elements.toggleButtonTopWidthInput.value, 10) || DEFAULT_TOGGLE_BUTTON_TOP_WIDTH;
             newSettings.toggleButtonTopHeight = parseInt(elements.toggleButtonTopHeightInput.value, 10) || DEFAULT_TOGGLE_BUTTON_TOP_HEIGHT;
             newSettings.toggleButtonTopFontSize = parseInt(elements.toggleButtonTopFontSizeInput.value, 10) || DEFAULT_TOGGLE_BUTTON_TOP_FONT_SIZE;
             newSettings.toggleButtonTopOpacity = elements.toggleButtonTopOpacityInput.value === '' ? DEFAULT_TOGGLE_BUTTON_TOP_OPACITY : parseFloat(elements.toggleButtonTopOpacityInput.value);
             newSettings.toggleButtonTopTextCollapse = elements.toggleButtonTopTextCollapseInput.value.trim() || DEFAULT_TOGGLE_BUTTON_TOP_TEXT_COLLAPSE;
             newSettings.toggleButtonTopTextExpand = elements.toggleButtonTopTextExpandInput.value.trim() || DEFAULT_TOGGLE_BUTTON_TOP_TEXT_EXPAND;
             newSettings.toggleButtonBottomFontSize = parseInt(elements.toggleButtonBottomFontSizeInput.value, 10) || DEFAULT_TOGGLE_BUTTON_BOTTOM_FONT_SIZE;
             newSettings.toggleButtonBottomTextCollapse = elements.toggleButtonBottomTextCollapseInput.value.trim() || DEFAULT_TOGGLE_BUTTON_BOTTOM_TEXT_COLLAPSE;
             newSettings.toggleButtonBottomTextExpand = elements.toggleButtonBottomTextExpandInput.value.trim() || DEFAULT_TOGGLE_BUTTON_BOTTOM_TEXT_EXPAND;
             newSettings.thoughtSummaryOpacity = elements.thoughtSummaryOpacityInput.value === '' ? DEFAULT_THOUGHT_SUMMARY_OPACITY : parseFloat(elements.thoughtSummaryOpacityInput.value);
             newSettings.showApiProviderToggleHeader = elements.showApiProviderToggleHeaderCheckbox.checked;
             newSettings.showApiProviderToggleFooter = elements.showApiProviderToggleFooterCheckbox.checked;
             newSettings.apiProviderCycle = {
                 gemini: elements.apiProviderCycleGeminiCheckbox.checked,
                 deepseek: elements.apiProviderCycleDeepSeekCheckbox.checked,
                 claude: elements.apiProviderCycleClaudeCheckbox.checked,
                 openai: elements.apiProviderCycleOpenAICheckbox.checked,
                 xai: elements.apiProviderCycleXaiCheckbox.checked,
                 llmaggregator: elements.apiProviderCycleLlmAggregatorCheckbox.checked,
                 dummy: elements.apiProviderCycleDummyCheckbox.checked,
             };
             newSettings.dummyErrorDebugMode = elements.dummyErrorDebugModeCheckbox.checked;
             newSettings.dummyDummyModel = elements.dummyDummyModelInput.value.trim();
             newSettings.dummyEnableDummyModel = elements.dummyEnableDummyModelCheckbox.checked;

            const validateNumeric = (value, defaultValue, min, max, isInteger = false) => {
                let num = isInteger ? parseInt(value, 10) : parseFloat(value);
                if (value === '' || value === null) return null;
                if (isNaN(num)) return defaultValue;
                if (min !== undefined && num < min) return defaultValue;
                if (max !== undefined && num > max) return defaultValue;
                return num;
            };

            const providers = ['gemini', 'deepSeek', 'claude', 'openai', 'xai', 'llmaggregator'];
            providers.forEach(provider => {
                const prefix = provider;
                const streamingSpeedKey = `${prefix}StreamingSpeed`;
                newSettings[streamingSpeedKey] = validateNumeric(newSettings[streamingSpeedKey], DEFAULT_STREAMING_SPEED, 0, Infinity, true);
                const tempKey = `${prefix}Temperature`;
                newSettings[tempKey] = validateNumeric(newSettings[tempKey], null, 0, 2);
                const maxTokensKey = `${prefix}MaxTokens`;
                newSettings[maxTokensKey] = validateNumeric(newSettings[maxTokensKey], null, 1, Infinity, true);
                const topPKey = `${prefix}TopP`;
                newSettings[topPKey] = validateNumeric(newSettings[topPKey], null, 0, 1);
                const presencePenaltyKey = `${prefix}PresencePenalty`;
                newSettings[presencePenaltyKey] = validateNumeric(newSettings[presencePenaltyKey], null, -2.0, 2.0);
                const frequencyPenaltyKey = `${prefix}FrequencyPenalty`;
                newSettings[frequencyPenaltyKey] = validateNumeric(newSettings[frequencyPenaltyKey], null, -2.0, 2.0);

                if (provider === 'gemini') {
                    newSettings.geminiTopK = validateNumeric(newSettings.geminiTopK, null, 1, Infinity, true);
                    newSettings.geminiThinkingBudget = validateNumeric(newSettings.geminiThinkingBudget, null, 0, Infinity, true);
                } else if (provider === 'claude') {
                    newSettings.claudeTopK = validateNumeric(newSettings.claudeTopK, null, 1, Infinity, true);
                    newSettings.claudeThinkingBudget = validateNumeric(newSettings.claudeThinkingBudget, null, 1024, Infinity, true);
                } else if (provider === 'llmaggregator') {
                    newSettings.llmAggregatorTopK = validateNumeric(newSettings.llmAggregatorTopK, null, 1, Infinity, true);
                }
            });

             newSettings.messageBodyFontSize = validateNumeric(newSettings.messageBodyFontSize, null, 1, 100, true);
             newSettings.codeBlockFontSize = validateNumeric(newSettings.codeBlockFontSize, null, 1, 100, true);
             newSettings.thoughtSummaryFontSize = validateNumeric(newSettings.thoughtSummaryFontSize, null, 1, 100, true);
             newSettings.messageIconSize = validateNumeric(newSettings.messageIconSize, DEFAULT_MESSAGE_ICON_SIZE, 1, 300, true);
             newSettings.messageIconOffsetY = validateNumeric(newSettings.messageIconOffsetY, DEFAULT_MESSAGE_ICON_OFFSET_Y, -200, 200, true);
             newSettings.iconNameFontSize = validateNumeric(newSettings.iconNameFontSize, DEFAULT_ICON_NAME_FONT_SIZE, 1, 46, true);
             newSettings.iconNameOffsetY = validateNumeric(newSettings.iconNameOffsetY, DEFAULT_ICON_NAME_OFFSET_Y, -200, 200, true);

             if (!/^#([0-9A-Fa-f]{3}){1,2}$/.test(newSettings.userNameBubbleColor)) {
                newSettings.userNameBubbleColor = DEFAULT_USER_NAME_BUBBLE_COLOR;
             }
             newSettings.userNameBubbleOpacity = validateNumeric(newSettings.userNameBubbleOpacity, DEFAULT_USER_NAME_BUBBLE_OPACITY, 0, 1);
             if (!/^#([0-9A-Fa-f]{3}){1,2}$/.test(newSettings.aiNameBubbleColor)) {
                newSettings.aiNameBubbleColor = DEFAULT_AI_NAME_BUBBLE_COLOR;
             }
             newSettings.aiNameBubbleOpacity = validateNumeric(newSettings.aiNameBubbleOpacity, DEFAULT_AI_NAME_BUBBLE_OPACITY, 0, 1);

             newSettings.messageBubbleOpacity = validateNumeric(newSettings.messageBubbleOpacity, DEFAULT_MESSAGE_BUBBLE_OPACITY, 0, 1);
             newSettings.chatOverlayOpacity = validateNumeric(newSettings.chatOverlayOpacity, DEFAULT_CHAT_OVERLAY_OPACITY, 0, 1);
             newSettings.headerFooterOpacity = validateNumeric(newSettings.headerFooterOpacity, DEFAULT_HEADER_FOOTER_OPACITY, 0, 1);
             newSettings.messageActionsBackgroundOpacity = validateNumeric(newSettings.messageActionsBackgroundOpacity, DEFAULT_MESSAGE_ACTIONS_BACKGROUND_OPACITY, 0, 1);
             newSettings.toggleButtonTopWidth = validateNumeric(newSettings.toggleButtonTopWidth, DEFAULT_TOGGLE_BUTTON_TOP_WIDTH, 1, 100, true);
             newSettings.toggleButtonTopHeight = validateNumeric(newSettings.toggleButtonTopHeight, DEFAULT_TOGGLE_BUTTON_TOP_HEIGHT, 1, 100, true);
             newSettings.toggleButtonTopFontSize = validateNumeric(newSettings.toggleButtonTopFontSize, DEFAULT_TOGGLE_BUTTON_TOP_FONT_SIZE, 1, 50, true);
             newSettings.toggleButtonBottomFontSize = validateNumeric(newSettings.toggleButtonBottomFontSize, DEFAULT_TOGGLE_BUTTON_BOTTOM_FONT_SIZE, 1, 34, true);

             newSettings.diceMinValue = validateNumeric(newSettings.diceMinValue, null, 0, Infinity, true);
             newSettings.diceMaxValue = validateNumeric(newSettings.diceMaxValue, null, 0, Infinity, true);
             if (newSettings.diceMinValue !== null && newSettings.diceMaxValue !== null && newSettings.diceMinValue > newSettings.diceMaxValue) {
                newSettings.diceMaxValue = newSettings.diceMinValue;
             }
             document.querySelectorAll('#settings-screen details[id]').forEach(details => {
                newSettings.settingsUIDetailsOpenStates[details.id] = details.open;
             });
             if (!newSettings.apiProviderCycle[newSettings.apiProvider]) {
                const enabledProvider = Object.entries(newSettings.apiProviderCycle)
                    .find(([provider, enabled]) => enabled)?.[0];
                if (enabledProvider) {
                    newSettings.apiProvider = enabledProvider;
                    elements.apiProviderSelect.value = enabledProvider;
                }
            }

             try {
                 const oldSortOrder = state.settings.historySortOrder;
                 const { backgroundImageBlob, userIconBlob, aiIconBlob, ...settingsToSave } = newSettings;

                 const promises = Object.entries(settingsToSave).map(([key, value]) =>
                     dbUtils.saveSetting(key, value)
                 );

                 const currentSettingsFromDB = await dbUtils.loadSettings();
                 if (state.settings.backgroundImageBlob !== currentSettingsFromDB.backgroundImageBlob) {
                     promises.push(dbUtils.saveSetting('backgroundImageBlob', state.settings.backgroundImageBlob));
                 }
                 if (state.settings.userIconBlob !== currentSettingsFromDB.userIconBlob) {
                     promises.push(dbUtils.saveSetting('userIconBlob', state.settings.userIconBlob));
                 }
                  if (state.settings.aiIconBlob !== currentSettingsFromDB.aiIconBlob) {
                     promises.push(dbUtils.saveSetting('aiIconBlob', state.settings.aiIconBlob));
                 }

                 await Promise.all(promises);

                 state.settings.disableSaveSettingsConfirmation = newSettings.disableSaveSettingsConfirmation;
                 state.settings.autoSaveSettings = newSettings.autoSaveSettings;
                 
                 const currentBgBlob = state.settings.backgroundImageBlob;
                 const currentUserIconBlob = state.settings.userIconBlob;
                 const currentAiIconBlob = state.settings.aiIconBlob;

                 state.settings = { ...state.settings, ...settingsToSave };

                 state.settings.backgroundImageBlob = currentBgBlob;
                 state.settings.userIconBlob = currentUserIconBlob;
                 state.settings.aiIconBlob = currentAiIconBlob;

                 if (!state.isSending && !state.isAiToAiChatProcessing) {
                    uiUtils.applySettingsToUI();
                    uiUtils.renderChatMessages(true);
                } else {
                    // 騾∽ｿ｡荳ｭ縺ｮ險ｭ螳壻ｿ晏ｭ倥〒繧ら樟蝨ｨ縺ｮ逕ｻ髱｢縺ｫ蠢懊§縺溘ユ繝ｼ繝槭ｒ邯ｭ謖・                    if (state.currentScreen === 'prompt-setup' && state.promptTempTheme) {
                        uiUtils.applyTheme(state.promptTempTheme);
                    } else if (state.currentChatTheme) {
                        uiUtils.applyTheme(state.currentChatTheme);
                    } else {
                        uiUtils.applyTheme();
                    }
                    uiUtils.applyFontFamily();
                    uiUtils.applySidePanelSettingsToUI();
                    uiUtils.updateChatScreenElementVisibility();
                    uiUtils.updateHistoryHeaderButtonVisibility();
                    uiUtils.toggleApiSettingsVisibility(state.settings.apiProvider);
                    uiUtils.applySettingsUIDetailsOpenStates();
                }

                 if (showNotice && !state.settings.disableSaveSettingsConfirmation) {
                     await uiUtils.showCustomAlert("險ｭ螳壹ｒ菫晏ｭ倥＠縺ｾ縺励◆縲・);
                 }

                 if (newSettings.historySortOrder !== oldSortOrder && state.currentScreen === 'history') {
                     uiUtils.renderHistoryList();
                 }
             } catch (error) {
                 await uiUtils.showCustomAlert(`險ｭ螳壹・菫晏ｭ倅ｸｭ縺ｫ繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆: ${error}`);
             }
        },
        async updateApp() {
            if (!navigator.serviceWorker || !navigator.serviceWorker.controller) {
                await uiUtils.showCustomAlert("Service Worker縺梧､懷・縺輔ｌ縺ｾ縺帙ｓ縺ｧ縺励◆縲ゅ・繝ｼ繧ｸ繧偵Μ繝ｭ繝ｼ繝峨＠縺ｦ縺九ｉ蜀崎ｩｦ陦後＠縺ｦ縺上□縺輔＞縲・);
                return;
            }
            const confirmed = await uiUtils.showCustomConfirm("繧｢繝励Μ縺ｮ繧ｭ繝｣繝・す繝･繧偵け繝ｪ繧｢縺励※譛譁ｰ迚医ｒ蜀榊叙蠕励＠縺ｾ縺吶°・・(繝壹・繧ｸ縺後Μ繝ｭ繝ｼ繝峨＆繧後∪縺・");
            if (confirmed) {
                navigator.serviceWorker.ready.then(reg => {
                    if (reg.active) {
                        reg.active.postMessage({ action: 'clearCache' });
                    } else {
                        uiUtils.showCustomAlert("繧｢繧ｯ繝・ぅ繝悶↑Service Worker縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ縲よ焔蜍輔〒繝ｪ繝ｭ繝ｼ繝峨′蠢・ｦ√°繧ゅ＠繧後∪縺帙ｓ縲・);
                    }
                }).catch(async err => {
                    await uiUtils.showCustomAlert("Service Worker縺ｮ貅門ｙ荳ｭ縺ｫ繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆縲・);
                });
            }
        },
        async confirmClearAllData() {
            const confirmed = await uiUtils.showCustomConfirm("譛ｬ蠖薙↓縺吶∋縺ｦ縺ｮ繝・・繧ｿ・医メ繝｣繝・ヨ螻･豁ｴ縺ｨ險ｭ螳夲ｼ峨ｒ蜑企勁縺励∪縺吶°・溘％縺ｮ謫堺ｽ懊・蜈・↓謌ｻ縺帙∪縺帙ｓ縲・);
            if (confirmed) {
                try {
                    uiUtils.revokeExistingObjectUrl();
                    uiUtils.revokeExistingIconUrls();
                    await dbUtils.clearAllData();
                    await uiUtils.showCustomAlert("縺吶∋縺ｦ縺ｮ繝・・繧ｿ縺悟炎髯､縺輔ｌ縺ｾ縺励◆縲ゅい繝励Μ繧偵Μ繧ｻ繝・ヨ縺励∪縺吶・);

                    state.currentChatId = null;
                    state.currentMessages = [];
                    state.pendingAttachments = [];
                    state.isMemoVisible = false;
                    elements.memoArea.classList.add('hidden');
                    elements.memoEditor.value = '';
                    state.isClipboardStackVisible = false;
                    elements.clipboardStackArea.classList.add('hidden');
                    state.clipboardStackContent = '';
                    state.linkedSessionIds = [];

                    const defaultSettingsCopy = JSON.parse(JSON.stringify(state.settings));
                    Object.keys(defaultSettingsCopy).forEach(key => {
                        if (key.startsWith('gemini') || key.startsWith('deepSeek') || key.startsWith('claude') || key.startsWith('openai') || key.startsWith('xai') || key.startsWith('llmaggregator')) {
                            if(key.toLowerCase().includes('systemprompt')) defaultSettingsCopy[key] = '';
                            else if(key.toLowerCase().includes('enablesystempromptdefault')) defaultSettingsCopy[key] = true;
                            else if(key.toLowerCase().includes('temperature') || key.toLowerCase().includes('maxtokens') || key.toLowerCase().includes('topk') || key.toLowerCase().includes('topp') || key.toLowerCase().includes('penalty') || key.toLowerCase().includes('budget')) defaultSettingsCopy[key] = null;
                            else if(key.toLowerCase().includes('streamingoutput')) defaultSettingsCopy[key] = true;
                            else if(key.toLowerCase().includes('streamingspeed')) defaultSettingsCopy[key] = DEFAULT_STREAMING_SPEED;
                            else if(key.toLowerCase().includes('dummyuser') || key.toLowerCase().includes('dummymodel')) defaultSettingsCopy[key] = '';
                            else if(key.toLowerCase().includes('enabledummyuser') || key.toLowerCase().includes('enabledummymodel')) defaultSettingsCopy[key] = true;
                            else if(key.toLowerCase().includes('concatdummymodel')) defaultSettingsCopy[key] = false;
                            else if(key === 'geminiIncludeThoughts') defaultSettingsCopy[key] = false;
                            else if(key === 'geminiExpandThoughtsByDefault') defaultSettingsCopy[key] = false;
                            else if(key === 'geminiPseudoStreaming') defaultSettingsCopy[key] = false;
                            else if(key === 'geminiEnableGrounding') defaultSettingsCopy[key] = false;
                            else if(key === 'deepSeekIncludeDeepSeekThoughts' || key === 'llmAggregatorIncludeThoughts') defaultSettingsCopy[key] = false;
                            else if(key === 'deepSeekExpandThoughtsByDefault' || key === 'llmAggregatorExpandThoughtsByDefault') defaultSettingsCopy[key] = false;
                            else if(key === 'claudeIncludeThoughts') defaultSettingsCopy[key] = false;
                            else if(key === 'claudeExpandThoughtsByDefault') defaultSettingsCopy[key] = false;
                            else if(key === 'claudeThinkingBudget') defaultSettingsCopy[key] = null;
                            else if(key === 'xaiVisionEnable') defaultSettingsCopy[key] = false;
                            else if(key === 'xaiIncludeThoughts') defaultSettingsCopy[key] = false;
                            else if(key === 'xaiExpandThoughtsByDefault') defaultSettingsCopy[key] = false;
                            else if(key === 'xaiReasoningEffort') defaultSettingsCopy[key] = 'low';
                        }
                    });
                    defaultSettingsCopy.apiKey = '';
                    defaultSettingsCopy.modelName = DEFAULT_MODEL;
                    defaultSettingsCopy.additionalModels = '';
                    defaultSettingsCopy.commonSystemPrompt = '';
                    defaultSettingsCopy.enableCommonSystemPromptDefault = false;
                    defaultSettingsCopy.deepSeekApiKey = '';
                    defaultSettingsCopy.deepSeekModelName = DEFAULT_DEEPSEEK_MODEL;
                    defaultSettingsCopy.deepSeekAdditionalModels = '';
                    defaultSettingsCopy.deepSeekApiEndpoint = '';
                    defaultSettingsCopy.claudeApiKey = '';
                    defaultSettingsCopy.claudeModelName = DEFAULT_CLAUDE_MODEL;
                    defaultSettingsCopy.claudeAdditionalModels = '';
                    defaultSettingsCopy.openaiApiKey = '';
                    defaultSettingsCopy.openaiModelName = DEFAULT_OPENAI_MODEL;
                    defaultSettingsCopy.openaiAdditionalModels = '';
                    defaultSettingsCopy.xaiApiKey = '';
                    defaultSettingsCopy.xaiModelName = DEFAULT_XAI_MODEL;
                    defaultSettingsCopy.xaiAdditionalModels = '';
                    defaultSettingsCopy.llmAggregatorApiKey = '';
                    defaultSettingsCopy.llmAggregatorApiBackend = '';
                    defaultSettingsCopy.llmAggregatorModelName = DEFAULT_LLMAGGREGATOR_MODEL;
                    defaultSettingsCopy.llmAggregatorAdditionalModels = '';
                    defaultSettingsCopy.apiProvider = 'gemini';
                    defaultSettingsCopy.enterToSend = false;
                    defaultSettingsCopy.autoScrollOnNewMessage = DEFAULT_AUTO_SCROLL_ON_NEW_MESSAGE;
                    defaultSettingsCopy.autoScrollOnThought = false;
                    defaultSettingsCopy.historySortOrder = 'updatedAt';
                    defaultSettingsCopy.theme = window.matchMedia?.('(prefers-color-scheme: light)').matches ? 'dark' : 'light';
                    defaultSettingsCopy.backgroundImageBlob = null;
                    defaultSettingsCopy.fontFamily = '';
                    defaultSettingsCopy.messageBodyFontSize = DEFAULT_MESSAGE_BODY_FONT_SIZE;
                    defaultSettingsCopy.codeBlockFontSize = DEFAULT_CODE_BLOCK_FONT_SIZE;
                    defaultSettingsCopy.thoughtSummaryFontSize = DEFAULT_THOUGHT_SUMMARY_FONT_SIZE;
                    defaultSettingsCopy.enableSessionLinking = false;
                    defaultSettingsCopy.showSessionLinkingSettings = false;
                    defaultSettingsCopy.enableSwipeNavigation = false;
                    defaultSettingsCopy.preventZoom = true;
                    defaultSettingsCopy.minimizeHeader = true;
                    defaultSettingsCopy.minimizeFooter = false;
                    defaultSettingsCopy.showChatTitle = true;
                    defaultSettingsCopy.showNewChatButton = true;
                    defaultSettingsCopy.showDeleteSessionButton = false;
                    defaultSettingsCopy.showCopySessionButton = false;
                    defaultSettingsCopy.showScrollToTopButton = true;
                    defaultSettingsCopy.showScrollToBottomButton = true;
                    defaultSettingsCopy.showToggleAllContentButton = false;
                    defaultSettingsCopy.showBulkHistoryActions = true;
                    defaultSettingsCopy.showPasteButtonInFooter = false;
                    defaultSettingsCopy.showPasteButtonInEdit = false;
                    defaultSettingsCopy.showDiceButton = false;
                    defaultSettingsCopy.diceMinValue = DEFAULT_DICE_MIN_VALUE;
                    defaultSettingsCopy.diceMaxValue = DEFAULT_DICE_MAX_VALUE;
                    defaultSettingsCopy.showMemoButton = false;
                    defaultSettingsCopy.memoHeight = DEFAULT_MEMO_HEIGHT;
                    defaultSettingsCopy.showClipboardStackButton = false;
                    defaultSettingsCopy.clipboardStackHeight = DEFAULT_CLIPBOARD_STACK_HEIGHT;
                    defaultSettingsCopy.showUserIcon = false;
                    defaultSettingsCopy.userIconBlob = null;
                    defaultSettingsCopy.showUserName = false;
                    defaultSettingsCopy.userName = DEFAULT_USER_NAME;
                    defaultSettingsCopy.chatMode = 'conversation';
                    defaultSettingsCopy.showAiIcon = false;
                    defaultSettingsCopy.aiIconBlob = null;
                    defaultSettingsCopy.showAiName = false;
                    defaultSettingsCopy.aiName = DEFAULT_AI_NAME;
                    defaultSettingsCopy.iconNameFontSize = DEFAULT_ICON_NAME_FONT_SIZE;
                    defaultSettingsCopy.iconNameOffsetY = DEFAULT_ICON_NAME_OFFSET_Y;
                    defaultSettingsCopy.messageIconSize = DEFAULT_MESSAGE_ICON_SIZE;
                    defaultSettingsCopy.messageIconOffsetY = DEFAULT_MESSAGE_ICON_OFFSET_Y;
                    defaultSettingsCopy.showUserNameBubble = false;
                    defaultSettingsCopy.userNameBubbleUseThemeColor = false;
                    defaultSettingsCopy.userNameBubbleColor = DEFAULT_USER_NAME_BUBBLE_COLOR;
                    defaultSettingsCopy.userNameBubbleOpacity = DEFAULT_USER_NAME_BUBBLE_OPACITY;
                    defaultSettingsCopy.showAiNameBubble = false;
                    defaultSettingsCopy.aiNameBubbleUseThemeColor = false;
                    defaultSettingsCopy.aiNameBubbleColor = DEFAULT_AI_NAME_BUBBLE_COLOR;
                    defaultSettingsCopy.aiNameBubbleOpacity = DEFAULT_AI_NAME_BUBBLE_OPACITY;
                    defaultSettingsCopy.disableRetryConfirmation = false;
                    defaultSettingsCopy.disableLoadChatConfirmationWhileSending = false;
                    defaultSettingsCopy.disableDeleteMessageConfirmation = false;
                    defaultSettingsCopy.disableAttachmentConfirmation = false;
                    defaultSettingsCopy.addPrefixOnImport = true;
                    defaultSettingsCopy.showMultiApiKeys = false;
                    defaultSettingsCopy.disableSaveSettingsConfirmation = false;
                    defaultSettingsCopy.autoSaveSettings = false;
                    defaultSettingsCopy.showTopCollapseButton = true;
                    defaultSettingsCopy.showBottomCollapseButton = true;
                    defaultSettingsCopy.persistMessageCollapseState = DEFAULT_PERSIST_MESSAGE_COLLAPSE_STATE;
                    defaultSettingsCopy.messageBubbleOpacity = DEFAULT_MESSAGE_BUBBLE_OPACITY;
                    defaultSettingsCopy.chatOverlayOpacity = DEFAULT_CHAT_OVERLAY_OPACITY;
                    defaultSettingsCopy.headerFooterOpacity = DEFAULT_HEADER_FOOTER_OPACITY;
                    defaultSettingsCopy.messageActionsBackgroundOpacity = DEFAULT_MESSAGE_ACTIONS_BACKGROUND_OPACITY;
                    defaultSettingsCopy.toggleButtonTopWidth = DEFAULT_TOGGLE_BUTTON_TOP_WIDTH;
                    defaultSettingsCopy.toggleButtonTopHeight = DEFAULT_TOGGLE_BUTTON_TOP_HEIGHT;
                    defaultSettingsCopy.toggleButtonTopFontSize = DEFAULT_TOGGLE_BUTTON_TOP_FONT_SIZE;
                    defaultSettingsCopy.toggleButtonTopOpacity = DEFAULT_TOGGLE_BUTTON_TOP_OPACITY;
                    defaultSettingsCopy.toggleButtonTopTextCollapse = DEFAULT_TOGGLE_BUTTON_TOP_TEXT_COLLAPSE;
                    defaultSettingsCopy.toggleButtonTopTextExpand = DEFAULT_TOGGLE_BUTTON_TOP_TEXT_EXPAND;
                    defaultSettingsCopy.toggleButtonBottomFontSize = DEFAULT_TOGGLE_BUTTON_BOTTOM_FONT_SIZE;
                    defaultSettingsCopy.toggleButtonBottomTextCollapse = DEFAULT_TOGGLE_BUTTON_BOTTOM_TEXT_COLLAPSE;
                    defaultSettingsCopy.toggleButtonBottomTextExpand = DEFAULT_TOGGLE_BUTTON_BOTTOM_TEXT_EXPAND;
                    defaultSettingsCopy.thoughtSummaryOpacity = DEFAULT_THOUGHT_SUMMARY_OPACITY;
                    defaultSettingsCopy.settingsUIDetailsOpenStates = {};
                    defaultSettingsCopy.showApiProviderToggleHeader = false;
                    defaultSettingsCopy.showApiProviderToggleFooter = true;
                    defaultSettingsCopy.apiProviderCycle = { gemini: true, deepseek: true, claude: true, openai: true, xai: true, llmaggregator: true, dummy: true };
                    defaultSettingsCopy.llmAggregatorTopK = null;
                    defaultSettingsCopy.dummyErrorDebugMode = false;
                    defaultSettingsCopy.dummyDummyModel = '';
                    defaultSettingsCopy.dummyEnableDummyModel = false;
                    defaultSettingsCopy.geminiApiKeys = [];
                    defaultSettingsCopy.geminiActiveApiKeyIndex = -1;
                    defaultSettingsCopy.deepseekApiKeys = [];
                    defaultSettingsCopy.deepseekActiveApiKeyIndex = -1;
                    defaultSettingsCopy.claudeApiKeys = [];
                    defaultSettingsCopy.claudeActiveApiKeyIndex = -1;
                    defaultSettingsCopy.openaiApiKeys = [];
                    defaultSettingsCopy.openaiActiveApiKeyIndex = -1;
                    defaultSettingsCopy.xaiApiKeys = [];
                    defaultSettingsCopy.xaiActiveApiKeyIndex = -1;
                    defaultSettingsCopy.llmaggregatorApiKeys = [];
                    defaultSettingsCopy.llmaggregatorActiveApiKeyIndex = -1;

                    state.settings = defaultSettingsCopy;

                    state.backgroundImageUrl = null;
                    state.userIconUrl = null;
                    state.aiIconUrl = null;
                    state.areAllMessagesHidden = false;
                    state.messageCollapsedStates.clear();
                    state.thoughtSummaryOpenStates.clear();

                    document.documentElement.style.setProperty('--chat-background-image', 'none');
                    uiUtils.applySettingsToUI();
                    uiUtils.updateAttachmentBadgeVisibility();
                    this.startNewChat();
                    uiUtils.showScreen('chat', true);
                } catch (error) {
                    await uiUtils.showCustomAlert(`繝・・繧ｿ蜑企勁荳ｭ縺ｫ繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆: ${error}`);
                }
            }
        },
        async confirmClearAllHistory() {
            const confirmed = await uiUtils.showCustomConfirm("譛ｬ蠖薙↓縺吶∋縺ｦ縺ｮ繝√Ε繝・ヨ螻･豁ｴ繧貞炎髯､縺励∪縺吶°・歃n縺薙・謫堺ｽ懊・蜈・↓謌ｻ縺帙∪縺帙ｓ縲りｨｭ螳壹・菫晄戟縺輔ｌ縺ｾ縺吶・);
            if (confirmed) {
                try {
                    await dbUtils.clearAllChatsStore();
                    state.currentChatId = null;
                    state.currentMessages = [];
                    state.pendingAttachments = [];
                    state.isMemoVisible = false;
                    elements.memoArea.classList.add('hidden');
                    elements.memoEditor.value = '';
                    state.isClipboardStackVisible = false;
                    elements.clipboardStackArea.classList.add('hidden');
                    state.clipboardStackContent = '';
                    state.areAllMessagesHidden = false;
                    uiUtils.updateToggleAllContentButton();
                    state.messageCollapsedStates.clear();
                    state.thoughtSummaryOpenStates.clear();
                    state.linkedSessionIds = [];
                    uiUtils.updateSessionLinkingUI();

                    this.startNewChat();
                    await uiUtils.showCustomAlert("縺吶∋縺ｦ縺ｮ繝√Ε繝・ヨ螻･豁ｴ縺悟炎髯､縺輔ｌ縺ｾ縺励◆縲・);

                    if (state.currentScreen === 'history') {
                        uiUtils.renderHistoryList();
                    }

                } catch (error) {
                    await uiUtils.showCustomAlert(`繝√Ε繝・ヨ螻･豁ｴ縺ｮ蜑企勁荳ｭ縺ｫ繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆: ${error}`);
                }
            }
        },
        async startEditMessage(index, messageElement) {
             if (state.isSending) {
                 await uiUtils.showCustomAlert("騾∽ｿ｡荳ｭ縺ｯ邱ｨ髮・〒縺阪∪縺帙ｓ縲・);
                 return;
             }
             if (state.editingMessageIndex !== null && state.editingMessageIndex !== index) {
                 await uiUtils.showCustomAlert("莉悶・繝｡繝・そ繝ｼ繧ｸ繧堤ｷｨ髮・ｸｭ縺ｧ縺吶・);
                 return;
             }
             if (state.editingMessageIndex === index) {
                 messageElement.querySelector('.edit-textarea')?.focus();
                 return;
             }

             const message = state.currentMessages[index];
             if (!message) return;

             const rawContent = message.content;
             state.editingMessageIndex = index;

             const contentDiv = messageElement.querySelector('.message-content');
             const editArea = messageElement.querySelector('.message-edit-area');
             const cascadeControls = messageElement.querySelector('.message-cascade-controls');

             editArea.innerHTML = '';

             let horizontalPadding = 0;
             try {
                 const computedStyle = window.getComputedStyle(messageElement);
                 const paddingLeft = parseFloat(computedStyle.paddingLeft) || 0;
                 const paddingRight = parseFloat(computedStyle.paddingRight) || 0;
                 horizontalPadding = paddingLeft + paddingRight;
             } catch (e) {
             }
             messageElement.style.width = `calc(var(--message-max-width) + ${horizontalPadding}px + 17px)`;

             const textarea = document.createElement('textarea');
             textarea.value = rawContent;
             textarea.classList.add('edit-textarea');
             textarea.rows = 3;
             textarea.oninput = () => uiUtils.adjustTextareaHeight(textarea, 400);

             const actionsDiv = document.createElement('div');
             actionsDiv.classList.add('message-edit-actions');

             if (state.settings.showPasteButtonInEdit) {
                                 const pasteButton = document.createElement('button');
                pasteButton.textContent = '雋ｼ';
                pasteButton.title = '繝・く繧ｹ繝医お繝ｪ繧｢縺ｫ雋ｼ繧贋ｻ倥￠';
                pasteButton.style.backgroundColor = 'var(--bg-button-paste)';
                pasteButton.style.marginRight = 'auto';
                pasteButton.onclick = async () => {
                    const originalText = pasteButton.textContent;
                    const originalTitle = pasteButton.title;
                    try {
                        if (!navigator.clipboard || !navigator.clipboard.readText) {
                            pasteButton.textContent = "!";
                            pasteButton.title = "繧ｯ繝ｪ繝・・繝懊・繝陰PI髱槫ｯｾ蠢・;
                            pasteButton.disabled = true;
                            setTimeout(() => {
                                pasteButton.textContent = originalText;
                                pasteButton.title = originalTitle;
                                pasteButton.disabled = false;
                            }, 2000);
                            return;
                        }
                        const textToPaste = await navigator.clipboard.readText();
                        if (textToPaste) {
                            const currentText = textarea.value;
                            const selectionStart = textarea.selectionStart;
                            const selectionEnd = textarea.selectionEnd;
                            textarea.value = currentText.substring(0, selectionStart) + textToPaste + currentText.substring(selectionEnd);
                            textarea.selectionStart = textarea.selectionEnd = selectionStart + textToPaste.length;
                            textarea.focus();
                            uiUtils.adjustTextareaHeight(textarea, 400);
                            pasteButton.textContent = "笨・;
                            pasteButton.title = "雋ｼ繧贋ｻ倥￠螳御ｺ・;
                            setTimeout(() => {
                                pasteButton.textContent = originalText;
                                pasteButton.title = originalTitle;
                            }, 1500);
                        } else {
                            pasteButton.textContent = "遨ｺ";
                            pasteButton.title = "繧ｯ繝ｪ繝・・繝懊・繝峨・遨ｺ縺ｧ縺・;
                            setTimeout(() => {
                                pasteButton.textContent = originalText;
                                pasteButton.title = originalTitle;
                            }, 1500);
                        }
                    } catch (err) {
                         if (err.name === 'NotAllowedError' || err.message.includes('Read permission denied')) {
                            pasteButton.textContent = "!";
                            pasteButton.title = "繧ｯ繝ｪ繝・・繝懊・繝峨・險ｱ蜿ｯ縺ｪ縺・;
                         } else {
                            pasteButton.textContent = "X";
                            pasteButton.title = "雋ｼ繧贋ｻ倥￠螟ｱ謨・;
                         }
                         pasteButton.disabled = true;
                         setTimeout(() => {
                            pasteButton.textContent = originalText;
                            pasteButton.title = originalTitle;
                            pasteButton.disabled = false;
                         }, 2000);
                    }
                };
                actionsDiv.appendChild(pasteButton);
             }

             const saveButton = document.createElement('button');
             saveButton.textContent = '菫晏ｭ・;
             saveButton.classList.add('save-edit-btn');
             saveButton.onclick = () => this.saveEditMessage(index, messageElement);
             const cancelButton = document.createElement('button');
             cancelButton.textContent = '繧ｭ繝｣繝ｳ繧ｻ繝ｫ';
             cancelButton.classList.add('cancel-edit-btn');
             cancelButton.onclick = () => this.cancelEditMessage(index, messageElement);
             actionsDiv.appendChild(saveButton);
             actionsDiv.appendChild(cancelButton);

             editArea.appendChild(textarea);
             editArea.appendChild(actionsDiv);

             messageElement.classList.add('editing');
             if(contentDiv) contentDiv.classList.add('hidden');
             if(cascadeControls) cascadeControls.classList.add('hidden');
             editArea.classList.remove('hidden');

             uiUtils.adjustTextareaHeight(textarea, 400);
             textarea.focus();
             textarea.select();

             this.uncollapseMessage(index, messageElement);
        },
        async saveEditMessage(index, messageElement) {
            const textarea = messageElement.querySelector('.edit-textarea');
            if (!textarea) {
                this.cancelEditMessage(index, messageElement);
                return;
            }
            const newRawContent = textarea.value;
            const originalMessage = state.currentMessages[index];

            if (newRawContent === originalMessage.content) {
                this.cancelEditMessage(index, messageElement);
                return;
            }

            originalMessage.content = newRawContent;
            originalMessage.timestamp = Date.now();
            delete originalMessage.error;

            const contentDiv = messageElement.querySelector('.message-content');
            
            if (originalMessage.role === 'user') {
                contentDiv.innerHTML = '';
                if (originalMessage.attachments && originalMessage.attachments.length > 0) {
                    const details = document.createElement('details');
                    details.classList.add('attachment-details');
                    const summary = document.createElement('summary');
                    summary.textContent = `豺ｻ莉倥ヵ繧｡繧､繝ｫ (${originalMessage.attachments.length}莉ｶ)`;
                    details.appendChild(summary);

                    const list = document.createElement('ul');
                    list.classList.add('attachment-list');

                    originalMessage.attachments.forEach((att, attachmentIndex) => {
                        const listItem = document.createElement('li');
                        listItem.dataset.attachmentIndex = attachmentIndex;
                        const itemContainer = document.createElement('div');
                        itemContainer.classList.add('attachment-list-item-container');

                        const nameSpan = document.createElement('span');
                        nameSpan.classList.add('attachment-list-item-name');
                        nameSpan.textContent = sanitizeText(att.name);
                        nameSpan.title = `${sanitizeText(att.name)} (${sanitizeText(att.mimeType)})`;

                        const actionsDiv = document.createElement('div');
                        actionsDiv.classList.add('attachment-actions');

                        if (att.mimeType.startsWith('image/')) {
                            const previewBtn = document.createElement('button');
                            previewBtn.textContent = '陦ｨ遉ｺ';
                            previewBtn.classList.add('attachment-preview-btn');
                            previewBtn.onclick = (e) => { e.preventDefault(); appLogic.previewAttachment(index, attachmentIndex); };
                            actionsDiv.appendChild(previewBtn);
                        }

                        const editBtn = document.createElement('button');
                        editBtn.textContent = '邱ｨ髮・;
                        editBtn.classList.add('attachment-edit-btn');
                        editBtn.onclick = (e) => { e.preventDefault(); appLogic.editAttachment(index, attachmentIndex); };

                        const removeBtn = document.createElement('button');
                        removeBtn.textContent = '蜑企勁';
                        removeBtn.classList.add('attachment-remove-btn');
                        removeBtn.onclick = (e) => { e.preventDefault(); appLogic.removeAttachment(index, attachmentIndex, listItem); };
                        
                        actionsDiv.appendChild(editBtn);
                        actionsDiv.appendChild(removeBtn);
                        itemContainer.appendChild(nameSpan);
                        itemContainer.appendChild(actionsDiv);
                        listItem.appendChild(itemContainer);
                        list.appendChild(listItem);
                    });
                    details.appendChild(list);
                    
                    const addMoreBtn = document.createElement('button');
                    addMoreBtn.textContent = '繝輔ぃ繧､繝ｫ繧定ｿｽ蜉';
                    addMoreBtn.classList.add('add-more-attachments-btn');
                    addMoreBtn.onclick = (e) => { e.preventDefault(); appLogic.addMoreAttachments(index, list); };
                    details.appendChild(addMoreBtn);

                    contentDiv.appendChild(details);
                }

                if (newRawContent && newRawContent.trim() !== '') {
                    const pre = document.createElement('pre');
                    pre.textContent = newRawContent;
                    pre.style.marginTop = (originalMessage.attachments && originalMessage.attachments.length > 0) ? '8px' : '0';
                    contentDiv.appendChild(pre);
                }

            } else if (originalMessage.role === 'model') {
                if (contentDiv && typeof marked !== 'undefined') {
                    try {
                        const safeHtml = uiUtils._sanitizeAndParseMarkdown(newRawContent || '');
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = safeHtml;
                        uiUtils.processInteractivePlaceholders(tempDiv);
                        uiUtils.processInteractiveTitles(tempDiv);
                        contentDiv.innerHTML = tempDiv.innerHTML;
                        uiUtils.addCopyButtonsToCodeBlocks(contentDiv, false);
                        uiUtils.addImageClickListeners(contentDiv);
                    } catch (e) {
                        contentDiv.textContent = newRawContent;
                    }
                } else if (contentDiv) {
                    contentDiv.textContent = newRawContent;
                }
            }

            this.finishEditing(messageElement);

            const isFirstUserMessage = (index === state.currentMessages.findIndex(m => m.role === 'user'));
            let titleForSave = null;
            if (isFirstUserMessage) {
                titleForSave = newRawContent.substring(0, 50) || "辟｡鬘後・繝√Ε繝・ヨ";
            }

            try {
                await dbUtils.saveChat(titleForSave);
                if (isFirstUserMessage) {
                    uiUtils.updateChatTitle(titleForSave);
                }
            } catch (error) {
                await uiUtils.showCustomAlert("繝｡繝・そ繝ｼ繧ｸ邱ｨ髮・ｾ後・繝√Ε繝・ヨ菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆縲・);
            }
        },
        cancelEditMessage(index, messageElement = null) {
              if (!messageElement) {
                  messageElement = elements.messageContainer.querySelector(`.message[data-index="${index}"]`);
              }
              if (messageElement) {
                  this.finishEditing(messageElement);
              } else if (state.editingMessageIndex === index) {
                  state.editingMessageIndex = null;
              }
        },
        finishEditing(messageElement) {
            if (!messageElement) return;
            const editArea = messageElement.querySelector('.message-edit-area');
            const contentDiv = messageElement.querySelector('.message-content');
            const cascadeControls = messageElement.querySelector('.message-cascade-controls');
            const textarea = messageElement.querySelector('.edit-textarea');

            messageElement.style.removeProperty('width');
            messageElement.classList.remove('editing');
            if(contentDiv) contentDiv.classList.remove('hidden');
            if(cascadeControls) cascadeControls.classList.remove('hidden');
            if(editArea) {
                editArea.classList.add('hidden');
                editArea.innerHTML = '';
            }

            const index = parseInt(messageElement.dataset.index, 10);
            if (state.editingMessageIndex === index) {
                state.editingMessageIndex = null;
            }
        },
        async copyMessageText(index, buttonElement) {
            const message = state.currentMessages[index];
            if (!message) return;

            let textToCopy = message.content;
            if (!textToCopy && message.role === 'user' && message.attachments && message.attachments.length > 0) {
                textToCopy = `[豺ｻ莉倥ヵ繧｡繧､繝ｫ: ${message.attachments.map(a => a.name).join(', ')}]`;
            } else if (!textToCopy) {
                textToCopy = "";
            }

            try {
                await navigator.clipboard.writeText(textToCopy);
                const originalText = buttonElement.textContent;
                buttonElement.textContent = '螳御ｺ・ｼ・;
                buttonElement.disabled = true;
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.disabled = false;
                }, 1500);
            } catch (err) {
                await uiUtils.showCustomAlert("OS繧ｯ繝ｪ繝・・繝懊・繝峨∈縺ｮ繧ｳ繝斐・縺ｫ螟ｱ謨励＠縺ｾ縺励◆縲・);
                const originalText = buttonElement.textContent;
                buttonElement.textContent = '繧ｳ繝斐・螟ｱ謨・;
                buttonElement.disabled = true;
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.disabled = false;
                }, 2000);
            }

            const currentStackContent = elements.clipboardStackEditor.value;
            const separator = currentStackContent.length > 0 && !currentStackContent.endsWith('\n\n') ? "\n\n" : "";
            elements.clipboardStackEditor.value += separator + textToCopy;
            state.clipboardStackContent = elements.clipboardStackEditor.value;
            elements.clipboardStackEditor.scrollTop = elements.clipboardStackEditor.scrollHeight;
        },
        async deleteMessage(index) {
            if (state.editingMessageIndex === index) {
                this.cancelEditMessage(index);
            }
            if (state.isSending) {
                await uiUtils.showCustomAlert("騾∽ｿ｡荳ｭ縺ｯ蜑企勁縺ｧ縺阪∪縺帙ｓ縲・);
                return;
            }
            if (index < 0 || index >= state.currentMessages.length) {
                 return;
            }

            const messageToDelete = state.currentMessages[index];
            const messageContentPreview = messageToDelete.content.substring(0, 30) + "...";
            let confirmMessage = "";
            let indicesToDelete = [];

            if (messageToDelete.role === 'model' && messageToDelete.isCascaded && messageToDelete.siblingGroupId) {
                const groupId = messageToDelete.siblingGroupId;
                const siblings = state.currentMessages.filter(msg => msg.role === 'model' && msg.isCascaded && msg.siblingGroupId === groupId);
                indicesToDelete = state.currentMessages
                    .map((msg, i) => (msg.role === 'model' && msg.isCascaded && msg.siblingGroupId === groupId) ? i : -1)
                    .filter(i => i !== -1);
                confirmMessage = `縲・{messageContentPreview}縲阪ｒ蜷ｫ繧蠢懃ｭ斐げ繝ｫ繝ｼ繝怜・菴・(${siblings.length}莉ｶ) 繧貞炎髯､縺励∪縺吶°・歔;
            } else {
                indicesToDelete.push(index);
                confirmMessage = `繝｡繝・そ繝ｼ繧ｸ縲・{messageContentPreview}縲・${messageToDelete.role}) 繧貞炎髯､縺励∪縺吶°・歔;
            }

            let confirmedDelete = true;
            if (!state.settings.disableDeleteMessageConfirmation) {
                confirmedDelete = await uiUtils.showCustomConfirm(confirmMessage);
            }

            if (confirmedDelete) {
                const originalFirstUserMsgIndex = state.currentMessages.findIndex(m => m.role === 'user');

                indicesToDelete.sort((a, b) => b - a).forEach(idx => {
                    state.currentMessages.splice(idx, 1);
                    state.messageCollapsedStates.delete(idx);
                    state.thoughtSummaryOpenStates.delete(idx);
                });

                const oldCollapsedStates = new Map(state.messageCollapsedStates);
                state.messageCollapsedStates.clear();
                 state.currentMessages.forEach((msg, newIdx) => {
                    const oldIdxEquivalent = newIdx >= Math.min(...indicesToDelete) ? newIdx + indicesToDelete.filter(i => i <= newIdx).length : newIdx;
                    if (oldCollapsedStates.has(oldIdxEquivalent)) {
                        state.messageCollapsedStates.set(newIdx, oldCollapsedStates.get(oldIdxEquivalent));
                    } else {
                        state.messageCollapsedStates.set(newIdx, false);
                    }
                });
                const oldThoughtOpenStates = new Map(state.thoughtSummaryOpenStates);
                state.thoughtSummaryOpenStates.clear();
                 state.currentMessages.forEach((msg, newIdx) => {
                    const minDeletedIndex = Math.min(...indicesToDelete);
                    const oldIdxEquivalent = newIdx >= minDeletedIndex ? newIdx + indicesToDelete.filter(i => i <= newIdx).length : newIdx;
                    if (oldThoughtOpenStates.has(oldIdxEquivalent)) {
                        state.thoughtSummaryOpenStates.set(newIdx, oldThoughtOpenStates.get(oldIdxEquivalent));
                    } else {
                        const messageApiProvider = msg?.generatedByApiProvider || state.settings.apiProvider;
                        state.thoughtSummaryOpenStates.set(newIdx, (messageApiProvider === 'gemini' && state.settings.geminiExpandThoughtsByDefault) || 
                                                                   (messageApiProvider === 'deepseek' && state.settings.deepSeekExpandThoughtsByDefault) ||
                                                                   (messageApiProvider === 'claude' && state.settings.claudeExpandThoughtsByDefault) ||
                                                                   (messageApiProvider === 'xai' && state.settings.xaiExpandThoughtsByDefault) ||
                                                                   (messageApiProvider === 'llmaggregator' && state.settings.llmAggregatorExpandThoughtsByDefault));
                    }
                });

                uiUtils.renderChatMessages(true);

                const newFirstUserMsgIndex = state.currentMessages.findIndex(m => m.role === 'user');
                let requiresTitleUpdate = indicesToDelete.includes(originalFirstUserMsgIndex);

                try {
                    let newTitleForSave = null;
                    const currentChatData = state.currentChatId ? await dbUtils.getChat(state.currentChatId) : null;

                    if (requiresTitleUpdate) {
                        const newFirstUserMessage = newFirstUserMsgIndex !== -1 ? state.currentMessages[newFirstUserMsgIndex] : null;
                        newTitleForSave = newFirstUserMessage ? newFirstUserMessage.content.substring(0, 50) : "辟｡鬘後・繝√Ε繝・ヨ";
                    } else if (currentChatData) {
                        newTitleForSave = currentChatData.title;
                    }

                    await dbUtils.saveChat(newTitleForSave);
                    if (requiresTitleUpdate) {
                        uiUtils.updateChatTitle(newTitleForSave);
                    }
                    if (state.currentMessages.length === 0 && state.currentChatId) {
                        this.startNewChat();
                    }
                } catch (error) {
                    await uiUtils.showCustomAlert("繝｡繝・そ繝ｼ繧ｸ蜑企勁蠕後・繝√Ε繝・ヨ菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆縲・);
                }
            }
        },
        findPreviousUserIndex(modelMessageIndex) {
            for (let i = modelMessageIndex - 1; i >= 0; i--) {
                if (state.currentMessages[i].role === 'user') {
                    return i;
                }
            }
            return -1;
        },
        async retryFromMessage(index) {
            if (state.editingMessageIndex !== null) {
                await uiUtils.showCustomAlert("邱ｨ髮・ｸｭ縺ｯ繝ｪ繝医Λ繧､縺ｧ縺阪∪縺帙ｓ縲・);
                return;
            }
            if (state.isSending) {
                await uiUtils.showCustomAlert("騾∽ｿ｡荳ｭ縺ｧ縺吶・);
                return;
            }

            const userMessage = state.currentMessages[index];
            if (!userMessage || userMessage.role !== 'user') return;

            let confirmed = true;
            if (!state.settings.disableRetryConfirmation) {
                const messageContentPreview = userMessage.content.substring(0, 30) + "...";
                confirmed = await uiUtils.showCustomConfirm(`縲・{messageContentPreview}縲阪°繧牙・逕滓・縺励∪縺吶°・歃n(縺薙・蜈･蜉帙↓蟇ｾ縺吶ｋ譌｢蟄倥・蠢懃ｭ斐・菫晄戟縺輔ｌ縺ｾ縺吶′縲・*縺薙ｌ繧医ｊ譛ｪ譚･縺ｮ莨夊ｩｱ螻･豁ｴ縺ｯ蜑企勁縺輔ｌ縺ｾ縺・*)`);
            }

            if (confirmed) {
                let deleteStartIndex = -1;
                let scanIndex = index + 1;
                let targetSiblingGroupId = null;

                if (scanIndex < state.currentMessages.length && state.currentMessages[scanIndex].role === 'model') {
                    targetSiblingGroupId = state.currentMessages[scanIndex].siblingGroupId || null;
                }

                if (targetSiblingGroupId !== null) {
                    while (
                        scanIndex < state.currentMessages.length &&
                        state.currentMessages[scanIndex].role === 'model' &&
                        state.currentMessages[scanIndex].siblingGroupId === targetSiblingGroupId
                    ) {
                        scanIndex++;
                    }
                } else {
                     if (scanIndex < state.currentMessages.length && state.currentMessages[scanIndex].role === 'model') {
                        scanIndex++;
                    }
                }

                if (scanIndex < state.currentMessages.length) {
                    deleteStartIndex = scanIndex;
                }

                if (deleteStartIndex !== -1) {
                    for(let i = deleteStartIndex; i < state.currentMessages.length; i++) {
                        state.messageCollapsedStates.delete(i);
                        state.thoughtSummaryOpenStates.delete(i);
                    }
                    state.currentMessages.splice(deleteStartIndex);
                }

                uiUtils.renderChatMessages();
                if (state.settings.autoScrollOnNewMessage) uiUtils.scrollToBottom();

                const elementsToHide = [];
                const messageContainer = elements.messageContainer;
                if (targetSiblingGroupId) {
                    messageContainer.querySelectorAll(`.message.model[data-index]`).forEach(el => {
                        const msgIndex = parseInt(el.dataset.index, 10);
                        const potentialMsg = state.currentMessages[msgIndex];
                        if (potentialMsg && potentialMsg.role === 'model' && potentialMsg.siblingGroupId === targetSiblingGroupId) {
                             el.classList.add('retrying-hidden');
                             elementsToHide.push(el);
                        }
                    });
                } else if (index + 1 < state.currentMessages.length && state.currentMessages[index + 1]?.role === 'model') {
                    const element = messageContainer.querySelector(`.message.model[data-index="${index + 1}"]`);
                    if (element) {
                        element.classList.add('retrying-hidden');
                        elementsToHide.push(element);
                    }
                }

                await this.handleSend(true, index);
            }
        },
        getCascadedSiblings(index, includeSelf = false) {
            const targetMsg = state.currentMessages[index];
            if (!targetMsg || !targetMsg.isCascaded || !targetMsg.siblingGroupId) {
                return [];
            }
            const groupId = targetMsg.siblingGroupId;
            const siblings = state.currentMessages.filter((msg, i) =>
                msg.role === 'model' &&
                msg.isCascaded &&
                msg.siblingGroupId === groupId &&
                (includeSelf || i !== index)
            );
            return siblings;
        },
        async navigateCascade(currentIndex, direction) {
            const currentMsg = state.currentMessages[currentIndex];
            if (!currentMsg || !currentMsg.isCascaded || !currentMsg.siblingGroupId) return;

            const groupId = currentMsg.siblingGroupId;
            const siblingsWithIndices = state.currentMessages
                .map((msg, i) => ({ msg, originalIndex: i }))
                                    .filter(item => item.msg.role === 'model' && item.msg.isCascaded && item.msg.siblingGroupId === groupId);

            const currentSiblingIndexInGroup = siblingsWithIndices.findIndex(item => item.originalIndex === currentIndex);
            if (currentSiblingIndexInGroup === -1) return;

            let targetSiblingIndexInGroup = -1;
            if (direction === 'prev' && currentSiblingIndexInGroup > 0) {
                targetSiblingIndexInGroup = currentSiblingIndexInGroup - 1;
            } else if (direction === 'next' && currentSiblingIndexInGroup < siblingsWithIndices.length - 1) {
                targetSiblingIndexInGroup = currentSiblingIndexInGroup + 1;
            }

            if (targetSiblingIndexInGroup !== -1) {
                currentMsg.isSelected = false;
                const newlySelectedMessage = siblingsWithIndices[targetSiblingIndexInGroup].msg;
                newlySelectedMessage.isSelected = true;
                const newlySelectedIndex = siblingsWithIndices[targetSiblingIndexInGroup].originalIndex;

                uiUtils.renderChatMessages();

                requestAnimationFrame(() => {
                    const newlySelectedElement = elements.messageContainer.querySelector(`.message[data-index="${newlySelectedIndex}"]`);
                    if (newlySelectedElement && !newlySelectedElement.classList.contains('editing')) {
                         const currentlyShown = elements.messageContainer.querySelector('.message.show-actions');
                         if (currentlyShown && currentlyShown !== newlySelectedElement) {
                             currentlyShown.classList.remove('show-actions');
                         }
                         newlySelectedElement.classList.add('show-actions');
                    }
                });

                try {
                    await dbUtils.saveChat();
                } catch (error) {
                    await uiUtils.showCustomAlert("蠢懃ｭ斐・蛻・ｊ譖ｿ縺育憾諷九・菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆縲・);
                }
            }
        },
        async confirmDeleteCascadeResponse(indexToDelete) {
            const msgToDelete = state.currentMessages[indexToDelete];
            if (!msgToDelete || msgToDelete.role !== 'model' || !msgToDelete.isCascaded || !msgToDelete.siblingGroupId) {
                return;
            }
            if (state.editingMessageIndex !== null) { await uiUtils.showCustomAlert("邱ｨ髮・ｸｭ縺ｯ蜑企勁縺ｧ縺阪∪縺帙ｓ縲・); return; }
            if (state.isSending) { await uiUtils.showCustomAlert("騾∽ｿ｡荳ｭ縺ｯ蜑企勁縺ｧ縺阪∪縺帙ｓ縲・); return; }

            const siblings = this.getCascadedSiblings(indexToDelete, true);
            const currentIndexInGroup = siblings.findIndex(m => m === msgToDelete) + 1;
            const totalSiblings = siblings.length;
            const contentPreview = msgToDelete.content.substring(0, 30) + "...";
            const confirmMsgText = `縺薙・蠢懃ｭ・(${currentIndexInGroup}/${totalSiblings})縲・{contentPreview}縲阪ｒ蜑企勁縺励∪縺吶°・歃n(縺薙・蠢懃ｭ斐・縺ｿ縺悟炎髯､縺輔ｌ縺ｾ縺・`;

            let confirmed = true;
            if (!state.settings.disableDeleteMessageConfirmation) {
                confirmed = await uiUtils.showCustomConfirm(confirmMsgText);
            }

            if (confirmed) {
                const wasSelected = msgToDelete.isSelected;
                const groupId = msgToDelete.siblingGroupId;

                state.currentMessages.splice(indexToDelete, 1);
                state.messageCollapsedStates.delete(indexToDelete);
                state.thoughtSummaryOpenStates.delete(indexToDelete);

                const oldCollapsedStates = new Map(state.messageCollapsedStates);
                state.messageCollapsedStates.clear();
                 state.currentMessages.forEach((msg, newIdx) => {
                    const oldIdxEquivalent = newIdx >= indexToDelete ? newIdx + 1 : newIdx;
                    if (oldCollapsedStates.has(oldIdxEquivalent)) {
                        state.messageCollapsedStates.set(newIdx, oldCollapsedStates.get(oldIdxEquivalent));
                    } else {
                        state.messageCollapsedStates.set(newIdx, false);
                    }
                });
                const oldThoughtOpenStates = new Map(state.thoughtSummaryOpenStates);
                state.thoughtSummaryOpenStates.clear();
                 state.currentMessages.forEach((msg, newIdx) => {
                    const oldIdxEquivalent = newIdx >= indexToDelete ? newIdx + 1 : newIdx;
                    if (oldThoughtOpenStates.has(oldIdxEquivalent)) {
                        state.thoughtSummaryOpenStates.set(newIdx, oldThoughtOpenStates.get(oldIdxEquivalent));
                    } else {
                        const messageApiProvider = msg?.generatedByApiProvider || state.settings.apiProvider;
                        state.thoughtSummaryOpenStates.set(newIdx, (messageApiProvider === 'gemini' && state.settings.geminiExpandThoughtsByDefault) || 
                                                                   (messageApiProvider === 'deepseek' && state.settings.deepSeekExpandThoughtsByDefault) ||
                                                                   (messageApiProvider === 'claude' && state.settings.claudeExpandThoughtsByDefault));
                    }
                });

                let newlySelectedIndex = -1;
                const remainingSiblingsWithIndices = state.currentMessages.map((msg, i) => ({ msg, originalIndex: i }))
                .filter(item => item.msg.role === 'model' && item.msg.isCascaded && item.msg.siblingGroupId === groupId);

                if (remainingSiblingsWithIndices.length > 0) {
                    if (wasSelected) {
                        const lastSiblingItem = remainingSiblingsWithIndices[remainingSiblingsWithIndices.length - 1];
                        if (!lastSiblingItem.msg.isSelected) {
                            lastSiblingItem.msg.isSelected = true;
                        }
                        newlySelectedIndex = lastSiblingItem.originalIndex;
                    } else {
                         const stillSelectedItem = remainingSiblingsWithIndices.find(item => item.msg.isSelected);
                         if (stillSelectedItem) {
                             newlySelectedIndex = stillSelectedItem.originalIndex;
                         } else {
                            const lastSiblingItem = remainingSiblingsWithIndices[remainingSiblingsWithIndices.length - 1];
                            lastSiblingItem.msg.isSelected = true;
                            newlySelectedIndex = lastSiblingItem.originalIndex;
                         }
                    }
                }

                uiUtils.renderChatMessages(true);

                requestAnimationFrame(() => {
                     if (newlySelectedIndex !== -1) {
                         const elementToShowActions = elements.messageContainer.querySelector(`.message[data-index="${newlySelectedIndex}"]`);
                         if (elementToShowActions && !elementToShowActions.classList.contains('editing')) {
                              const currentlyShown = elements.messageContainer.querySelector('.message.show-actions');
                              if (currentlyShown && currentlyShown !== elementToShowActions) {
                                  currentlyShown.classList.remove('show-actions');
                              }
                              elementToShowActions.classList.add('show-actions');
                         }
                     }
                });

                try {
                    await dbUtils.saveChat();
                } catch (error) {
                    await uiUtils.showCustomAlert("蠢懃ｭ泌炎髯､蠕後・繝√Ε繝・ヨ迥ｶ諷九・菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆縲・);
                }
            }
        },
        async handleFileSelection(fileList) {
            if (!fileList || fileList.length === 0) return;
            const newFiles = Array.from(fileList);
            let currentTotalSize = state.selectedFilesForUpload.reduce((sum, item) => sum + item.file.size, 0);
            let addedCount = 0;
            let skippedCount = 0;
            let sizeError = false;

            elements.selectFilesBtn.disabled = true;
            elements.selectFilesBtn.textContent = '蜃ｦ逅・ｸｭ...';

            for (const file of newFiles) {
                if (file.size > MAX_FILE_SIZE) {
                    await uiUtils.showCustomAlert(`繝輔ぃ繧､繝ｫ "${file.name}" 縺ｯ繧ｵ繧､繧ｺ縺悟､ｧ縺阪☆縺弱∪縺・(${formatFileSize(MAX_FILE_SIZE)}莉･荳・縲Ａ);
                    skippedCount++;
                    continue;
                }
                if (currentTotalSize + file.size > MAX_TOTAL_ATTACHMENT_SIZE) {
                    sizeError = true;
                    skippedCount++;
                    continue;
                }
                if (state.selectedFilesForUpload.some(item => item.file.name === file.name)) {
                    skippedCount++;
                    continue;
                }

                state.selectedFilesForUpload.push({ file: file });
                currentTotalSize += file.size;
                addedCount++;
            }
            elements.selectFilesBtn.disabled = false;
            elements.selectFilesBtn.textContent = '繝輔ぃ繧､繝ｫ繧帝∈謚・;

            if (sizeError) {
                await uiUtils.showCustomAlert(`蜷郁ｨ医ヵ繧｡繧､繝ｫ繧ｵ繧､繧ｺ縺ｮ荳企剞 (${formatFileSize(MAX_TOTAL_ATTACHMENT_SIZE)}) 繧定ｶ・∴繧九◆繧√∽ｸ驛ｨ縺ｮ繝輔ぃ繧､繝ｫ縺ｯ霑ｽ蜉縺輔ｌ縺ｾ縺帙ｓ縺ｧ縺励◆縲Ａ);
            }
            uiUtils.updateSelectedFilesUI();
        },
        removeSelectedFile(indexToRemove) {
            if (indexToRemove >= 0 && indexToRemove < state.selectedFilesForUpload.length) {
                const removedFile = state.selectedFilesForUpload.splice(indexToRemove, 1)[0];
                uiUtils.updateSelectedFilesUI();
            }
        },
        async confirmAttachment() {
            if (state.selectedFilesForUpload.length === 0) {
                state.pendingAttachments = [];
                elements.fileUploadDialog.close('ok');
                uiUtils.adjustTextareaHeight();
                uiUtils.updateAttachmentBadgeVisibility();
                return;
            }

            elements.confirmAttachBtn.disabled = true;
            elements.confirmAttachBtn.textContent = '蜃ｦ逅・ｸｭ...';

            const attachmentsToAdd = [];
            let encodingError = false;

            for (const item of state.selectedFilesForUpload) {
                const file = item.file;
                try {
                    const fileName = file.name;
                    const fileExtension = fileName.slice(((fileName.lastIndexOf(".") - 1) >>> 0) + 2).toLowerCase();
                    let browserMimeType = file.type || '';
                    let guessedMimeType = extensionToMimeTypeMap[fileExtension] || browserMimeType || 'application/octet-stream';

                    if (guessedMimeType.startsWith('text/')) {
                        const textData = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = (error) => reject(error);
                            reader.readAsText(file);
                        });
                        attachmentsToAdd.push({
                            file: file,
                            name: fileName,
                            mimeType: guessedMimeType,
                            textData: textData,
                            base64Data: null 
                        });
                    } else {
                        const base64Data = await fileToBase64(file);
                        attachmentsToAdd.push({
                            file: file,
                            name: fileName,
                            mimeType: guessedMimeType,
                            base64Data: base64Data,
                            textData: null
                        });
                    }
                } catch (error) {
                    encodingError = true;
                    await uiUtils.showCustomAlert(`繝輔ぃ繧､繝ｫ "${item.file.name}" 縺ｮ蜃ｦ逅・ｸｭ縺ｫ繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆縲Ａ);
                    break;
                }
            }

            elements.confirmAttachBtn.disabled = false;
            elements.confirmAttachBtn.textContent = '豺ｻ莉倥＠縺ｦ髢峨§繧・;

            if (!encodingError) {
                state.pendingAttachments = attachmentsToAdd;
                elements.fileUploadDialog.close('ok');
                uiUtils.adjustTextareaHeight();
                uiUtils.updateAttachmentBadgeVisibility();
            }
        },
        cancelAttachment() {
            state.selectedFilesForUpload = [];
            elements.fileUploadDialog.close('cancel');
            uiUtils.updateAttachmentBadgeVisibility();
        },
        toggleMessageCollapse(index) {
            const messageElement = elements.messageContainer.querySelector(`.message[data-index="${index}"]`);
            const contentDiv = messageElement?.querySelector('.message-content');
            const toggleButtons = messageElement?.querySelectorAll('.message-toggle-button[data-action="toggle-collapse"]');

            if (contentDiv && toggleButtons && toggleButtons.length > 0) {
                const isCollapsed = contentDiv.classList.toggle('collapsed');
                messageElement.classList.toggle('message-content-collapsed-fully', isCollapsed);
                state.messageCollapsedStates.set(index, isCollapsed);
                if (state.settings.persistMessageCollapseState && state.currentChatId) {
                    dbUtils.saveChat();
                }

                toggleButtons.forEach(button => {
                    let textCollapse, textExpand, baseTitle;
                    if (button.classList.contains('top')) {
                        textCollapse = state.settings.toggleButtonTopTextCollapse;
                        textExpand = state.settings.toggleButtonTopTextExpand;
                    } else {
                        textCollapse = state.settings.toggleButtonBottomTextCollapse;
                        textExpand = state.settings.toggleButtonBottomTextExpand;
                    }
                    baseTitle = isCollapsed ? '繝｡繝・そ繝ｼ繧ｸ繧貞ｱ暮幕' : '繝｡繝・そ繝ｼ繧ｸ繧呈釜繧翫◆縺溘・';
                    button.textContent = isCollapsed ? textExpand : textCollapse;
                    button.title = baseTitle;
                    button.setAttribute('aria-label', baseTitle);
                });
            }
        },
        uncollapseMessage(index, messageElement = null) {
             if (!messageElement) {
                 messageElement = elements.messageContainer.querySelector(`.message[data-index="${index}"]`);
             }
             const contentDiv = messageElement?.querySelector('.message-content');
             const toggleButtons = messageElement?.querySelectorAll('.message-toggle-button[data-action="toggle-collapse"]');

             if (contentDiv && contentDiv.classList.contains('collapsed')) {
                 contentDiv.classList.remove('collapsed');
                 messageElement.classList.remove('message-content-collapsed-fully');
                 state.messageCollapsedStates.set(index, false);
                 if (state.settings.persistMessageCollapseState && state.currentChatId) {
                    dbUtils.saveChat();
                 }

                 if (toggleButtons) {
                     toggleButtons.forEach(button => {
                        let textCollapse;
                        if (button.classList.contains('top')) {
                            textCollapse = state.settings.toggleButtonTopTextCollapse;
                        } else {
                            textCollapse = state.settings.toggleButtonBottomTextCollapse;
                        }
                        button.textContent = textCollapse;
                        button.title = '繝｡繝・そ繝ｼ繧ｸ繧呈釜繧翫◆縺溘・';
                        button.setAttribute('aria-label', '繝｡繝・そ繝ｼ繧ｸ繧呈釜繧翫◆縺溘・');
                     });
                 }
             }
        },
        toggleAllMessagesVisibility() {
            if (state.isSending) {
                uiUtils.showCustomAlert("騾∽ｿ｡荳ｭ縺ｯ謫堺ｽ懊〒縺阪∪縺帙ｓ縲・);
                return;
            }
            if (state.editingMessageIndex !== null) {
                 uiUtils.showCustomAlert("繝｡繝・そ繝ｼ繧ｸ邱ｨ髮・ｸｭ縺ｯ謫堺ｽ懊〒縺阪∪縺帙ｓ縲・);
                 return;
             }

            state.areAllMessagesHidden = !state.areAllMessagesHidden;
            uiUtils.updateToggleAllContentButton();

            const messages = elements.messageContainer.querySelectorAll('.message:not(.message-error)');
            messages.forEach(msgElement => {
                                if (msgElement.id && msgElement.id.startsWith('streaming-message-')) {
                    msgElement.classList.remove('message-hidden-by-toggle');
                    return;
                }
                msgElement.classList.toggle('message-hidden-by-toggle', state.areAllMessagesHidden);
                if(state.areAllMessagesHidden){
                    msgElement.classList.remove('message-content-collapsed-fully');
                    msgElement.querySelector('.message-content')?.classList.remove('collapsed');
                }
            });

            requestAnimationFrame(() => {
                uiUtils.scrollToBottom();
            });
        },
        toggleSessionLink(sessionId) {
            if (!state.settings.enableSessionLinking) return;

            const index = state.linkedSessionIds.indexOf(sessionId);
            if (index > -1) {
                state.linkedSessionIds.splice(index, 1);
            } else {
                if (state.linkedSessionIds.length >= 2) {
                    state.linkedSessionIds.shift();
                }
                state.linkedSessionIds.push(sessionId);
            }
            uiUtils.updateSessionLinkingUI();
        },
        async initiateAiToAiStep() {
            if (state.isAiToAiChatProcessing || state.isSending) {
                await uiUtils.showCustomAlert("迴ｾ蝨ｨ蜃ｦ逅・ｸｭ縺ｧ縺吶・);
                return;
            }
            if (state.linkedSessionIds.length !== 2 || !state.currentChatId || !state.linkedSessionIds.includes(state.currentChatId)) {
                await uiUtils.showCustomAlert("AI髢謎ｼ夊ｩｱ繧貞ｮ溯｡後☆繧九↓縺ｯ縲∫樟蝨ｨ縺ｮ繝√Ε繝・ヨ繧貞性繧2縺､縺ｮ繧ｻ繝・す繝ｧ繝ｳ繧偵Μ繝ｳ繧ｯ縺励※縺上□縺輔＞縲・);
                return;
            }
            const selectedApiProvider = state.settings.apiProvider;
             if ((selectedApiProvider === 'gemini' && !state.settings.apiKey) ||
                 (selectedApiProvider === 'deepseek' && !state.settings.deepSeekApiKey) ||
                 (selectedApiProvider === 'claude' && !state.settings.claudeApiKey) ||
                 (selectedApiProvider === 'openai' && !state.settings.openaiApiKey) ||
                 (selectedApiProvider === 'xai' && !state.settings.xaiApiKey) ||
                 (selectedApiProvider === 'llmaggregator' && !state.settings.llmAggregatorApiKey)
                ) {
                await uiUtils.showCustomAlert("驕ｸ謚樔ｸｭ縺ｮAPI繝励Ο繝舌う繝繝ｼ縺ｮAPI繧ｭ繝ｼ縺瑚ｨｭ螳壹＆繧後※縺・∪縺帙ｓ縲・);
                uiUtils.showScreen('settings');
                return;
            }

            uiUtils.setAiToAiProcessingState(true, "AI髢謎ｼ夊ｩｱ蜃ｦ逅・ｸｭ (繧ｹ繝・ャ繝・/2)...");

            const sessionA_Id = state.currentChatId;
            const sessionB_Id = state.linkedSessionIds.find(id => id !== sessionA_Id);

            try {
                const sessionA_Data = await dbUtils.getChat(sessionA_Id);
                if (!sessionA_Data || !sessionA_Data.messages || sessionA_Data.messages.length === 0) {
                    throw new Error(`繧ｻ繝・す繝ｧ繝ｳA (${sessionA_Id}) 縺ｮ繝・・繧ｿ縺悟叙蠕励〒縺阪∪縺帙ｓ縺ｧ縺励◆縲Ａ);
                }

                const lastAiMessageA = [...sessionA_Data.messages].reverse().find(msg => msg.role === 'model' && (!msg.isCascaded || msg.isSelected));
                if (!lastAiMessageA || !lastAiMessageA.content) {
                    throw new Error(`繧ｻ繝・す繝ｧ繝ｳA (${sessionA_Id}) 縺ｮ譛譁ｰ縺ｮAI蠢懃ｭ斐′隕九▽縺九ｊ縺ｾ縺帙ｓ縲Ａ);
                }
                const inputForB = lastAiMessageA.content;

                const sessionB_Data = await dbUtils.getChat(sessionB_Id);
                if (!sessionB_Data) {
                    throw new Error(`繧ｻ繝・す繝ｧ繝ｳB (${sessionB_Id}) 縺ｮ繝・・繧ｿ縺悟叙蠕励〒縺阪∪縺帙ｓ縺ｧ縺励◆縲Ａ);
                }

                let providerForSettingsB = state.settings.apiProvider;
                let systemPromptB, enableSystemPromptDefaultB, dummyUserB, enableDummyUserB, dummyModelB, enableDummyModelB,
                    temperatureB, maxTokensB, topPB,
                    streamingOutputB, streamingSpeedB, concatDummyModelB,
                    geminiTopKB, geminiThinkingBudgetB, geminiIncludeThoughtsB, geminiPseudoStreamingB, geminiEnableGroundingB,
                    deepSeekIncludeThoughtsB, presencePenaltyB, frequencyPenaltyB,
                    claudeTopKB, claudeIncludeThoughtsB, claudeThinkingBudgetB, claudeExpandThoughtsByDefaultB,
                    xaiVisionEnableB, xaiIncludeThoughtsB, xaiReasoningEffortB, llmAggregatorTopKB;

                if (providerForSettingsB === 'gemini') {
                    systemPromptB = state.settings.geminiSystemPrompt;
                    enableSystemPromptDefaultB = state.settings.geminiEnableSystemPromptDefault;
                    temperatureB = state.settings.geminiTemperature;
                    maxTokensB = state.settings.geminiMaxTokens;
                    geminiTopKB = state.settings.geminiTopK;
                    topPB = state.settings.geminiTopP;
                    presencePenaltyB = state.settings.geminiPresencePenalty;
                    frequencyPenaltyB = state.settings.geminiFrequencyPenalty;
                    geminiThinkingBudgetB = state.settings.geminiThinkingBudget;
                    geminiIncludeThoughtsB = state.settings.geminiIncludeThoughts;
                    streamingOutputB = state.settings.geminiStreamingOutput;
                    streamingSpeedB = state.settings.geminiStreamingSpeed;
                    dummyUserB = state.settings.geminiDummyUser;
                    enableDummyUserB = state.settings.geminiEnableDummyUser;
                    dummyModelB = state.settings.geminiDummyModel;
                    enableDummyModelB = state.settings.geminiEnableDummyModel;
                    concatDummyModelB = state.settings.geminiConcatDummyModel;
                    geminiPseudoStreamingB = state.settings.geminiPseudoStreaming;
                    geminiEnableGroundingB = state.settings.geminiEnableGrounding;
                } else if (providerForSettingsB === 'deepseek') {
                    systemPromptB = state.settings.deepSeekSystemPrompt;
                    enableSystemPromptDefaultB = state.settings.deepSeekEnableSystemPromptDefault;
                    temperatureB = state.settings.deepSeekTemperature;
                    maxTokensB = state.settings.deepSeekMaxTokens;
                    topPB = state.settings.deepSeekTopP;
                    presencePenaltyB = state.settings.deepSeekPresencePenalty;
                    frequencyPenaltyB = state.settings.deepSeekFrequencyPenalty;
                    contextDeepSeekIncludeThoughts = state.settings.deepSeekIncludeDeepSeekThoughts;
                    streamingOutputB = state.settings.deepSeekStreamingOutput;
                    streamingSpeedB = state.settings.deepSeekStreamingSpeed;
                    dummyUserB = state.settings.deepSeekDummyUser;
                    enableDummyUserB = state.settings.deepSeekEnableDummyUser;
                    dummyModelB = state.settings.deepSeekDummyModel;
                    enableDummyModelB = state.settings.deepSeekEnableDummyModel;
                    concatDummyModelB = state.settings.deepSeekConcatDummyModel;
                } else if (providerForSettingsB === 'llmaggregator') {
                    systemPromptB = state.settings.llmAggregatorSystemPrompt;
                    enableSystemPromptDefaultB = state.settings.llmAggregatorEnableSystemPromptDefault;
                    temperatureB = state.settings.llmAggregatorTemperature;
                    maxTokensB = state.settings.llmAggregatorMaxTokens;
                    topPB = state.settings.llmAggregatorTopP;
                    llmAggregatorTopKB = state.settings.llmAggregatorTopK;
                    presencePenaltyB = state.settings.llmAggregatorPresencePenalty;
                    frequencyPenaltyB = state.settings.llmAggregatorFrequencyPenalty;
                    contextDeepSeekIncludeThoughts = state.settings.llmAggregatorIncludeThoughts;
                    streamingOutputB = state.settings.llmAggregatorStreamingOutput;
                    streamingSpeedB = state.settings.llmAggregatorStreamingSpeed;
                    dummyUserB = state.settings.llmAggregatorDummyUser;
                    enableDummyUserB = state.settings.llmAggregatorEnableDummyUser;
                    dummyModelB = state.settings.llmAggregatorDummyModel;
                    enableDummyModelB = state.settings.llmAggregatorEnableDummyModel;
                    concatDummyModelB = state.settings.llmAggregatorConcatDummyModel;
                } else if (providerForSettingsB === 'claude') {
                    systemPromptB = state.settings.claudeSystemPrompt;
                    enableSystemPromptDefaultB = state.settings.claudeEnableSystemPromptDefault;
                    temperatureB = state.settings.claudeTemperature;
                    maxTokensB = state.settings.claudeMaxTokens;
                    claudeTopKB = state.settings.claudeTopK;
                    topPB = state.settings.claudeTopP;
                    streamingOutputB = state.settings.claudeStreamingOutput;
                    streamingSpeedB = state.settings.claudeStreamingSpeed;
                    dummyUserB = state.settings.claudeDummyUser;
                    enableDummyUserB = state.settings.claudeEnableDummyUser;
                    dummyModelB = state.settings.claudeDummyModel;
                    enableDummyModelB = state.settings.claudeEnableDummyModel;
                    concatDummyModelB = state.settings.claudeConcatDummyModel;
                    claudeIncludeThoughtsB = state.settings.claudeIncludeThoughts;
                    claudeThinkingBudgetB = state.settings.claudeThinkingBudget;
                    claudeExpandThoughtsByDefaultB = state.settings.claudeExpandThoughtsByDefault;
                } else if (providerForSettingsB === 'openai') {
                    systemPromptB = state.settings.openaiSystemPrompt;
                    enableSystemPromptDefaultB = state.settings.openaiEnableSystemPromptDefault;
                    temperatureB = state.settings.openaiTemperature;
                    maxTokensB = state.settings.openaiMaxTokens;
                    topPB = state.settings.openaiTopP;
                    presencePenaltyB = state.settings.openaiPresencePenalty;
                    frequencyPenaltyB = state.settings.openaiFrequencyPenalty;
                    streamingOutputB = state.settings.openaiStreamingOutput;
                    streamingSpeedB = state.settings.openaiStreamingSpeed;
                    dummyUserB = state.settings.openaiDummyUser;
                    enableDummyUserB = state.settings.openaiEnableDummyUser;
                    dummyModelB = state.settings.openaiDummyModel;
                    enableDummyModelB = state.settings.openaiEnableDummyModel;
                    concatDummyModelB = state.settings.openaiConcatDummyModel;
                } else if (providerForSettingsB === 'xai') {
                    systemPromptB = state.settings.xaiSystemPrompt;
                    enableSystemPromptDefaultB = state.settings.xaiEnableSystemPromptDefault;
                    temperatureB = state.settings.xaiTemperature;
                    maxTokensB = state.settings.xaiMaxTokens;
                    topPB = state.settings.xaiTopP;
                    presencePenaltyB = state.settings.xaiPresencePenalty;
                    frequencyPenaltyB = state.settings.xaiFrequencyPenalty;
                    streamingOutputB = state.settings.xaiStreamingOutput;
                    streamingSpeedB = state.settings.xaiStreamingSpeed;
                    dummyUserB = state.settings.xaiDummyUser;
                    enableDummyUserB = state.settings.xaiEnableDummyUser;
                    dummyModelB = state.settings.xaiDummyModel;
                    enableDummyModelB = state.settings.xaiEnableDummyModel;
                    concatDummyModelB = state.settings.xaiConcatDummyModel;
                    xaiVisionEnableB = state.settings.xaiVisionEnable;
                    xaiIncludeThoughtsB = state.settings.xaiIncludeThoughts;
                    xaiReasoningEffortB = state.settings.xaiReasoningEffort;
                }

                const contextForB = {
                    sessionId: sessionB_Id,
                    messages: sessionB_Data.messages ? [...sessionB_Data.messages] : [],
                    systemPrompt: systemPromptB,
                    enableSystemPromptDefault: enableSystemPromptDefaultB,
                    temperature: temperatureB, maxTokens: maxTokensB, topP: topPB,
                    presencePenalty: presencePenaltyB, frequencyPenalty: frequencyPenaltyB,
                    streamingOutput: streamingOutputB, streamingSpeed: streamingSpeedB,
                    dummyUser: dummyUserB, enableDummyUser: enableDummyUserB,
                    dummyModel: dummyModelB, enableDummyModelB: enableDummyModelB, concatDummyModel: concatDummyModelB,
                    topK: providerForSettingsB === 'gemini' ? geminiTopKB :
                          providerForSettingsB === 'claude' ? claudeTopKB :
                          providerForSettingsB === 'llmaggregator' ? llmAggregatorTopKB : undefined,
                    thinkingBudget: providerForSettingsB === 'gemini' ? geminiThinkingBudgetB : 
                                    providerForSettingsB === 'claude' ? claudeThinkingBudgetB : undefined,
                    includeThoughts: providerForSettingsB === 'gemini' ? geminiIncludeThoughtsB : 
                                     (providerForSettingsB === 'deepseek' || providerForSettingsB === 'llmaggregator') ? contextDeepSeekIncludeThoughts : 
                                     providerForSettingsB === 'claude' ? claudeIncludeThoughtsB :
                                     providerForSettingsB === 'xai' ? xaiIncludeThoughtsB : undefined,
                    expandThoughtsByDefault: (providerForSettingsB === 'gemini' && state.settings.geminiExpandThoughtsByDefault) ||
                                             (providerForSettingsB === 'deepseek' && state.settings.deepSeekExpandThoughtsByDefault) ||
                                             (providerForSettingsB === 'claude' ? claudeExpandThoughtsByDefaultB : undefined) ||
                                             (providerForSettingsB === 'xai' && state.settings.xaiExpandThoughtsByDefault) ||
                                             (providerForSettingsB === 'llmaggregator' && state.settings.llmAggregatorExpandThoughtsByDefault),
                    reasoningEffort: providerForSettingsB === 'xai' ? xaiReasoningEffortB : undefined,
                    pseudoStreaming: providerForSettingsB === 'gemini' ? geminiPseudoStreamingB : undefined,
                    enableGrounding: providerForSettingsB === 'gemini' ? geminiEnableGroundingB : undefined,
                    visionEnable: providerForSettingsB === 'xai' ? xaiVisionEnableB : undefined,
                    inputText: inputForB,
                    attachments: [],
                    apiProvider: providerForSettingsB
                };

                const responseFromB = await this.handleSend(false, -1, contextForB);
                if (responseFromB === "API繧ｭ繝ｼ譛ｪ險ｭ螳・) throw new Error("API繧ｭ繝ｼ縺瑚ｨｭ螳壹＆繧後※縺・∪縺帙ｓ縲・);
                if (!responseFromB || !responseFromB.content) {
                    throw new Error(`繧ｻ繝・す繝ｧ繝ｳB (${sessionB_Id}) 縺九ｉ縺ｮ蠢懃ｭ斐′縺ゅｊ縺ｾ縺帙ｓ縺ｧ縺励◆縲Ａ);
                }
                const inputForA = responseFromB.content;

                uiUtils.setAiToAiProcessingState(true, "AI髢謎ｼ夊ｩｱ蜃ｦ逅・ｸｭ (繧ｹ繝・ャ繝・/2)...");

                elements.userInput.value = inputForA;
                uiUtils.adjustTextareaHeight();

                await this.handleSend();

            } catch (error) {
                await uiUtils.showCustomAlert(`AI髢謎ｼ夊ｩｱ蜃ｦ逅・ｸｭ縺ｫ繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆: ${error.message}`);
                if (state.currentChatId === sessionA_Id && elements.chatScreen.classList.contains('active')) {
                     uiUtils.displayError(`AI髢謎ｼ夊ｩｱ繧ｨ繝ｩ繝ｼ: ${error.message}`, false);
                }
            } finally {
                uiUtils.setAiToAiProcessingState(false);
            }
        },
        removeAttachment: async function(messageIndex, attachmentIndex, listItemElement) {
            const message = state.currentMessages[messageIndex];
            if (!message || !message.attachments || !message.attachments[attachmentIndex]) return;

            const attachmentName = message.attachments[attachmentIndex].name;
            
            let confirmed = true;
            if (!state.settings.disableAttachmentConfirmation) {
                confirmed = await uiUtils.showCustomConfirm(`豺ｻ莉倥ヵ繧｡繧､繝ｫ縲・{attachmentName}縲阪ｒ蜑企勁縺励∪縺吶°・歔);
            }
            
            if (confirmed) {
                message.attachments.splice(attachmentIndex, 1);
                
                const list = listItemElement.parentElement;
                listItemElement.remove();

                const summary = list.closest('.attachment-details').querySelector('summary');
                summary.textContent = `豺ｻ莉倥ヵ繧｡繧､繝ｫ (${message.attachments.length}莉ｶ)`;

                try {
                    await dbUtils.saveChat();
                } catch(e) {
                    await uiUtils.showCustomAlert('豺ｻ莉倥ヵ繧｡繧､繝ｫ縺ｮ蜑企勁迥ｶ諷九・菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆縲・);
                }
            }
        },
        editAttachment: function(messageIndex, attachmentIndex) {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'file';
            hiddenInput.accept = "image/*,text/*,application/pdf,video/*,audio/*,.txt,.md,.csv,.json,.html,.css,.js,.py";
            hiddenInput.style.display = 'none';

            hiddenInput.onchange = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                if (file.size > MAX_FILE_SIZE) {
                    await uiUtils.showCustomAlert(`繝輔ぃ繧､繝ｫ繧ｵ繧､繧ｺ縺悟､ｧ縺阪☆縺弱∪縺・(${formatFileSize(MAX_FILE_SIZE)}莉･荳・縲Ａ);
                    return;
                }

                try {
                    let textData = null;
                    let base64Data = null;
                    const fileName = file.name;
                    const fileExtension = fileName.slice(((fileName.lastIndexOf(".") - 1) >>> 0) + 2).toLowerCase();
                    let browserMimeType = file.type || '';
                    let guessedMimeType = extensionToMimeTypeMap[fileExtension] || browserMimeType || 'application/octet-stream';

                    if (guessedMimeType.startsWith('text/')) {
                        textData = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = (error) => reject(error);
                            reader.readAsText(file);
                        });
                    } else {
                        base64Data = await fileToBase64(file);
                    }

                    const message = state.currentMessages[messageIndex];
                    message.attachments[attachmentIndex] = {
                        file: file,
                        name: fileName,
                        mimeType: guessedMimeType,
                        base64Data: base64Data,
                        textData: textData,
                    };
                    
                    const messageElement = elements.messageContainer.querySelector(`.message[data-index="${messageIndex}"]`);
                    if(messageElement) {
                        const listItem = messageElement.querySelector(`li[data-attachment-index="${attachmentIndex}"] .attachment-list-item-name`);
                        if(listItem) {
                            listItem.textContent = sanitizeText(fileName);
                            listItem.title = `${sanitizeText(fileName)} (${sanitizeText(guessedMimeType)})`;
                        }
                    }

                    await dbUtils.saveChat();

                } catch (error) {
                    await uiUtils.showCustomAlert(`繝輔ぃ繧､繝ｫ縺ｮ蜃ｦ逅・ｸｭ縺ｫ繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆: ${error.message}`);
                }
                document.body.removeChild(hiddenInput);
            };
            
            document.body.appendChild(hiddenInput);
            hiddenInput.click();
        },
        addMoreAttachments: function(messageIndex, listElement) {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'file';
            hiddenInput.multiple = true;
            hiddenInput.accept = "image/*,text/*,application/pdf,video/*,audio/*,.txt,.md,.csv,.json,.html,.css,.js,.py";
            hiddenInput.style.display = 'none';

            hiddenInput.onchange = async (event) => {
                const files = event.target.files;
                if (!files || files.length === 0) return;

                const message = state.currentMessages[messageIndex];
                let currentTotalSize = message.attachments.reduce((sum, att) => sum + (att.file?.size || 0), 0);
                let encodingError = false;

                for (const file of files) {
                    if (file.size > MAX_FILE_SIZE) {
                        await uiUtils.showCustomAlert(`繝輔ぃ繧､繝ｫ "${file.name}" 縺ｯ繧ｵ繧､繧ｺ縺悟､ｧ縺阪☆縺弱∪縺吶Ａ);
                        continue;
                    }
                    if (currentTotalSize + file.size > MAX_TOTAL_ATTACHMENT_SIZE) {
                        await uiUtils.showCustomAlert('蜷郁ｨ医ヵ繧｡繧､繝ｫ繧ｵ繧､繧ｺ縺ｮ荳企剞繧定ｶ・∴縺溘◆繧√∽ｸ驛ｨ縺ｮ繝輔ぃ繧､繝ｫ縺ｯ霑ｽ蜉縺輔ｌ縺ｾ縺帙ｓ縺ｧ縺励◆縲・);
                        break;
                    }
                    
                    try {
                        let textData = null;
                        let base64Data = null;
                        const fileName = file.name;
                        const fileExtension = fileName.slice(((fileName.lastIndexOf(".") - 1) >>> 0) + 2).toLowerCase();
                        let browserMimeType = file.type || '';
                        let guessedMimeType = extensionToMimeTypeMap[fileExtension] || browserMimeType || 'application/octet-stream';
                        
                        if (guessedMimeType.startsWith('text/')) {
                            textData = await new Promise((resolve, reject) => {
                                const reader = new FileReader();
                                reader.onload = () => resolve(reader.result);
                                reader.onerror = (error) => reject(error);
                                reader.readAsText(file);
                            });
                        } else {
                            base64Data = await fileToBase64(file);
                        }

                        const newAttachment = {
                            file: file,
                            name: fileName,
                            mimeType: guessedMimeType,
                            base64Data: base64Data,
                            textData: textData,
                        };
                        message.attachments.push(newAttachment);
                        currentTotalSize += file.size;

                        const newAttachmentIndex = message.attachments.length - 1;
                        const listItem = document.createElement('li');
                        listItem.dataset.attachmentIndex = newAttachmentIndex;
                        const itemContainer = document.createElement('div');
                        itemContainer.classList.add('attachment-list-item-container');

                        const nameSpan = document.createElement('span');
                        nameSpan.classList.add('attachment-list-item-name');
                        nameSpan.textContent = sanitizeText(fileName);
                        nameSpan.title = `${sanitizeText(fileName)} (${sanitizeText(guessedMimeType)})`;

                        const actionsDiv = document.createElement('div');
                        actionsDiv.classList.add('attachment-actions');

                        if (guessedMimeType.startsWith('image/')) {
                            const previewBtn = document.createElement('button');
                            previewBtn.textContent = '陦ｨ遉ｺ';
                            previewBtn.classList.add('attachment-preview-btn');
                            previewBtn.onclick = (e) => { e.preventDefault(); appLogic.previewAttachment(messageIndex, newAttachmentIndex); };
                            actionsDiv.appendChild(previewBtn);
                        }

                        const editBtn = document.createElement('button');
                        editBtn.textContent = '邱ｨ髮・;
                        editBtn.classList.add('attachment-edit-btn');
                        editBtn.onclick = (e) => { e.preventDefault(); appLogic.editAttachment(messageIndex, newAttachmentIndex); };

                        const removeBtn = document.createElement('button');
                        removeBtn.textContent = '蜑企勁';
                        removeBtn.classList.add('attachment-remove-btn');
                        removeBtn.onclick = (e) => { e.preventDefault(); appLogic.removeAttachment(messageIndex, newAttachmentIndex, listItem); };

                        actionsDiv.appendChild(editBtn);
                        actionsDiv.appendChild(removeBtn);
                        itemContainer.appendChild(nameSpan);
                        itemContainer.appendChild(actionsDiv);
                        listItem.appendChild(itemContainer);
                        listElement.appendChild(listItem);

                    } catch (error) {
                        encodingError = true;
                        await uiUtils.showCustomAlert(`繝輔ぃ繧､繝ｫ "${file.name}" 縺ｮ蜃ｦ逅・ｸｭ縺ｫ繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆縲Ａ);
                        break;
                    }
                }

                if (!encodingError) {
                    const summary = listElement.closest('.attachment-details').querySelector('summary');
                    summary.textContent = `豺ｻ莉倥ヵ繧｡繧､繝ｫ (${message.attachments.length}莉ｶ)`;
                    await dbUtils.saveChat();
                }
                
                document.body.removeChild(hiddenInput);
            };

            document.body.appendChild(hiddenInput);
            hiddenInput.click();
        },
        
        previewAttachment: async function(messageIndex, attachmentIndex) {
            const message = state.currentMessages[messageIndex];
            const attachment = message?.attachments?.[attachmentIndex];
            if (!attachment || !attachment.mimeType.startsWith('image/')) return;
            
            const dialog = elements.imagePreviewDialog;
            const img = dialog.querySelector('img');
            const okBtn = dialog.querySelector('.dialog-ok-btn');
            
            img.src = `data:${attachment.mimeType};base64,${attachment.base64Data}`;
            img.alt = attachment.name;
            
            okBtn.onclick = () => dialog.close();
            
            dialog.showModal();
        },
    };

    const apiUtils = {
        async callGeminiApi(messagesForApi, generationConfig, systemInstruction, useStreaming, usePseudo, enableGrounding) {
            let apiKey;
            if (state.settings.showMultiApiKeys) {
                apiKey = multiApiKeyUtils.getActiveApiKey('gemini');
            } else {
                apiKey = state.settings.apiKey;
            }
            
            let baseUrl = GEMINI_API_BASE_URL;
            
            if (!apiKey) {
                throw new Error("API繧ｭ繝ｼ縺瑚ｨｭ螳壹＆繧後※縺・∪縺帙ｓ縲・);
            }
            state.abortController = new AbortController();
            const { signal } = state.abortController;

            const model = state.settings.modelName || DEFAULT_MODEL;
            
            let endpointMethod = useStreaming
                ? (usePseudo ? 'generateContent?alt=sse&' : 'streamGenerateContent?alt=sse&')
                : 'generateContent?';

            const endpoint = `${baseUrl}${model}:${endpointMethod}key=${apiKey}`;

            const finalGenerationConfig = { ...generationConfig };

            if (state.settings.geminiThinkingBudget !== null || state.settings.geminiIncludeThoughts) {
                finalGenerationConfig.thinkingConfig = finalGenerationConfig.thinkingConfig || {};
                if (state.settings.geminiThinkingBudget !== null && Number.isInteger(state.settings.geminiThinkingBudget) && state.settings.geminiThinkingBudget >= 0) {
                    finalGenerationConfig.thinkingConfig.thinkingBudget = state.settings.geminiThinkingBudget;
                }
                if (state.settings.geminiIncludeThoughts) {
                    finalGenerationConfig.thinkingConfig.includeThoughts = true;
                }
                 if (Object.keys(finalGenerationConfig.thinkingConfig).length === 0) delete finalGenerationConfig.thinkingConfig;
            }

            const requestBody = {
                contents: messagesForApi,
                ...(Object.keys(finalGenerationConfig).length > 0 && { generationConfig: finalGenerationConfig }),
                ...(systemInstruction && systemInstruction.parts && systemInstruction.parts.length > 0 && systemInstruction.parts[0].text && { systemInstruction }),
                 safetySettings : [
                     { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_NONE' },
                     { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_NONE' },
                                              { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_NONE' },                         { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_NONE' }
                 ]
            };

            const tools = [];
            if (enableGrounding) {
                tools.push({ "google_search": {} });
            }

            if (tools.length > 0) {
                requestBody.tools = tools;
            }

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                    signal
                });

                if (!response.ok) {
                    let errorMsg = `API繧ｨ繝ｩ繝ｼ (${response.status}): ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.error && errorData.error.message) {
                            errorMsg = `API繧ｨ繝ｩ繝ｼ (${response.status}): ${errorData.error.message}`;
                        }
                    } catch (e) {  }
                    throw new Error(errorMsg);
                }
                return response;
            } catch (error) {
                if (error.name === 'AbortError') {
                     throw new Error("繝ｪ繧ｯ繧ｨ繧ｹ繝医′繧ｭ繝｣繝ｳ繧ｻ繝ｫ縺輔ｌ縺ｾ縺励◆縲・);
                }
                throw error;
            }
        },
        async *handleGeminiStreamingResponse(response) {
             if (!response.body) {
                 throw new Error("繝ｬ繧ｹ繝昴Φ繧ｹ繝懊ョ繧｣縺後≠繧翫∪縺帙ｓ縲・);
             }
             const reader = response.body.pipeThrough(new TextDecoderStream()).getReader();
             let buffer = '';
             let lastCandidateInfo = null;
             let isCancelled = false;
             let groundingMetadata = null;
             let finalUsageMetadata = null;

             try {
                 while (true) {
                     if (state.abortController?.signal.aborted && !isCancelled) {
                         isCancelled = true;
                         await reader.cancel("User aborted");
                         throw new Error("繝ｪ繧ｯ繧ｨ繧ｹ繝医′繧ｭ繝｣繝ｳ繧ｻ繝ｫ縺輔ｌ縺ｾ縺励◆縲・);
                     }

                     let readResult;
                     try {
                         readResult = await reader.read();
                     } catch (readError) {
                         if (readError.name === 'AbortError' || readError.message === "User aborted" || readError.message.includes("aborted")) {
                             if (!isCancelled) {
                                 isCancelled = true;
                                 throw new Error("繝ｪ繧ｯ繧ｨ繧ｹ繝医′繧ｭ繝｣繝ｳ繧ｻ繝ｫ縺輔ｌ縺ｾ縺励◆縲・);
                             }
                             break;
                         }
                         throw readError;
                     }

                     const { value, done } = readResult;

                     if (done) {
                         if (buffer.trim()) {
                             const finalData = parseSseDataForYield(buffer.trim().substring(6));
                             if (finalData) yield finalData;
                         }
                         break;
                     }

                     buffer += value;
                     let remainingBuffer = buffer;
                     while (true) {
                         const newlineIndex = remainingBuffer.indexOf('\n');
                         if (newlineIndex === -1) {
                             buffer = remainingBuffer;
                             break;
                         }
                         const line = remainingBuffer.substring(0, newlineIndex).trim();
                         remainingBuffer = remainingBuffer.substring(newlineIndex + 1);

                         if (line.startsWith('data: ')) {
                             const chunkData = parseSseDataForYield(line.substring(6));
                             if (chunkData) {
                                 if (chunkData.groundingMetadata) groundingMetadata = chunkData.groundingMetadata;
                                 if (chunkData.usageMetadata) finalUsageMetadata = chunkData.usageMetadata;
                                 yield chunkData;
                             }
                         } else if (line !== '') {
                         }
                         if (remainingBuffer === '') {
                            buffer = '';
                            break;
                         }
                     }
                 }
                 const finishReason = lastCandidateInfo?.finishReason;
                 const safetyRatings = lastCandidateInfo?.safetyRatings;

                 yield {
                     type: 'metadata',
                     finishReason: isCancelled ? 'ABORTED' : finishReason,
                     safetyRatings,
                     groundingMetadata: groundingMetadata,
                     usageMetadata: finalUsageMetadata
                 };

             } catch (error) {
                 throw new Error(`${error.message || error}`, { cause: { originalError: error } });
             } finally {
                 if (!reader.closed && !isCancelled) {
                     try { await reader.cancel("Cleanup cancellation"); } catch(e) {  }
                 }
             }

             function parseSseDataForYield(jsonString) {
                 try {
                     const chunkJson = JSON.parse(jsonString);
                     if (chunkJson.error) {
                         const errorMsg = `繝｢繝・Ν繧ｨ繝ｩ繝ｼ: ${chunkJson.error.message || JSON.stringify(chunkJson.error)}`;
                         lastCandidateInfo = { error: chunkJson.error, finishReason: 'ERROR' };
                         return { type: 'error', error: chunkJson.error, message: errorMsg };
                     }

                     let contentText = null;
                     let thoughtText = null;
                     let currentGroundingMetadata = null;
                     let currentUsageMetadata = null;

                     if (chunkJson.candidates && chunkJson.candidates.length > 0) {
                         lastCandidateInfo = chunkJson.candidates[0];
                         if (lastCandidateInfo?.content?.parts) {
                             lastCandidateInfo.content.parts.forEach(part => {
                                 if (typeof part.text === 'string') {
                                     if (part.thought === true) {
                                         thoughtText = (thoughtText || '') + part.text;
                                     } else {
                                         contentText = (contentText || '') + part.text;
                                     }
                                 }
                             });
                         }
                         if (lastCandidateInfo.groundingMetadata) {
                             currentGroundingMetadata = lastCandidateInfo.groundingMetadata;
                         }
                     } else if (chunkJson.promptFeedback) {
                         lastCandidateInfo = { finishReason: 'SAFETY', safetyRatings: chunkJson.promptFeedback.safetyRatings };
                         return null;
                     }

                     if (chunkJson.usageMetadata) {
                         currentUsageMetadata = chunkJson.usageMetadata;
                     }

                     if (contentText !== null || thoughtText !== null || currentGroundingMetadata || currentUsageMetadata) {
                         return {
                             type: 'chunk',
                             contentText,
                             thoughtText,
                             groundingMetadata: currentGroundingMetadata,
                             usageMetadata: currentUsageMetadata
                         };
                     }
                     return null;
                 } catch (parseError) {
                     return null;
                 }
             }
        },
        async callDeepSeekApi(messagesForApi, generationConfig, systemInstruction, useStreaming, provider = 'deepseek') {
            let apiKey, model, baseUrl, topK;
            if (provider === 'llmaggregator') {
                if (state.settings.showMultiApiKeys) {
                    apiKey = multiApiKeyUtils.getActiveApiKey('llmaggregator');
                } else {
                    apiKey = state.settings.llmAggregatorApiKey;
                }
                model = state.settings.llmAggregatorModelName;
                baseUrl = state.settings.llmAggregatorApiBackend;
                topK = state.settings.llmAggregatorTopK;
                if (!baseUrl) {
                    throw new Error("LLM Aggregator縺ｮAPI繝舌ャ繧ｯ繧ｨ繝ｳ繝蔚RL縺瑚ｨｭ螳壹＆繧後※縺・∪縺帙ｓ縲・);
                }
            } else {
                if (state.settings.showMultiApiKeys) {
                    apiKey = multiApiKeyUtils.getActiveApiKey('deepseek');
                } else {
                    apiKey = state.settings.deepSeekApiKey;
                }
                model = state.settings.deepSeekModelName || DEFAULT_DEEPSEEK_MODEL;
                baseUrl = state.settings.deepSeekApiEndpoint || DEEPSEEK_API_DEFAULT_BASE_URL;
            }

            if (!apiKey) {
                throw new Error(`${provider.toUpperCase()} API繧ｭ繝ｼ縺瑚ｨｭ螳壹＆繧後※縺・∪縺帙ｓ縲Ａ);
            }
            state.abortController = new AbortController();
            const { signal } = state.abortController;

            const endpoint = `${baseUrl.replace(/\/$/, '')}/chat/completions`;

            const dsMessages = [];
            if (systemInstruction && systemInstruction.content) {
                dsMessages.push({ role: "system", content: systemInstruction.content });
            }

            messagesForApi.forEach(msg => {
                const contentParts = msg.parts.filter(p => p.text).map(p => p.text.trim());
                const fullContent = contentParts.join('\n').trim();

                if (fullContent) {
                    dsMessages.push({
                        role: msg.role === 'model' ? 'assistant' : msg.role,
                        content: fullContent
                    });
                }
            });

            const dsRequestBody = {
                model: model,
                messages: dsMessages,
                stream: useStreaming,
                ...(generationConfig.temperature !== undefined && { temperature: generationConfig.temperature }),
                ...(generationConfig.maxOutputTokens !== undefined && { max_tokens: generationConfig.maxOutputTokens }),
                ...(generationConfig.topP !== undefined && { top_p: generationConfig.topP }),
                ...(generationConfig.presencePenalty !== undefined && { presence_penalty: generationConfig.presencePenalty }),
                ...(generationConfig.frequencyPenalty !== undefined && { frequency_penalty: generationConfig.frequencyPenalty }),
            };
            
            if (provider === 'llmaggregator' && topK !== null) {
                dsRequestBody.top_k = topK;
            }

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(dsRequestBody),
                    signal
                });

                if (!response.ok) {
                    let errorMsg = `${provider.toUpperCase()} API繧ｨ繝ｩ繝ｼ (${response.status}): ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.error && errorData.error.message) {
                            errorMsg = `${provider.toUpperCase()} API繧ｨ繝ｩ繝ｼ (${response.status}): ${errorData.error.message} (Type: ${errorData.error.type || 'N/A'})`;
                        }
                    } catch (e) {  }
                    throw new Error(errorMsg);
                }
                if (!useStreaming) {
                    const data = await response.json();
                    let reasoningContent = null;
                    const choice = data.choices?.[0];
                    if (choice && choice.message && choice.message.reasoning_content) {
                        reasoningContent = choice.message.reasoning_content;
                    }
                    response.json = async () => ({ ...data, parsedReasoningContent: reasoningContent });
                }
                return response;
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error("繝ｪ繧ｯ繧ｨ繧ｹ繝医′繧ｭ繝｣繝ｳ繧ｻ繝ｫ縺輔ｌ縺ｾ縺励◆縲・);
                }
                throw error;
            }
        },
        async *handleDeepSeekStreamingResponse(response) {
            if (!response.body) {
                throw new Error("DeepSeek繝ｬ繧ｹ繝昴Φ繧ｹ繝懊ョ繧｣縺後≠繧翫∪縺帙ｓ縲・);
            }
            const reader = response.body.pipeThrough(new TextDecoderStream()).getReader();
            let buffer = '';
            let finalUsage = null;
            let finalFinishReason = null;
            let isCancelled = false;
            let accumulatedFullReasoningContent = "";

            try {
                while (true) {
                    if (state.abortController?.signal.aborted && !isCancelled) {
                        isCancelled = true;
                        await reader.cancel("User aborted");
                        throw new Error("繝ｪ繧ｯ繧ｨ繧ｹ繝医′繧ｭ繝｣繝ｳ繧ｻ繝ｫ縺輔ｌ縺ｾ縺励◆縲・);
                    }

                    const { value, done } = await reader.read();
                    if (done) break;

                    buffer += value;
                    let eolIndex;
                    while ((eolIndex = buffer.indexOf('\n')) >= 0) {
                        const line = buffer.substring(0, eolIndex).trim();
                        buffer = buffer.substring(eolIndex + 1);

                        if (line.startsWith('data: ')) {
                            const jsonData = line.substring(6);
                            if (jsonData.trim() === '[DONE]') {
                                finalFinishReason = finalFinishReason || 'stop';
                                break;
                            }
                            try {
                                const chunk = JSON.parse(jsonData);
                                let contentTextChunk = null;
                                let reasoningTextChunk = null;
                                
                                if (chunk.choices && chunk.choices[0] && chunk.choices[0].delta) {
                                    const delta = chunk.choices[0].delta;
                                    if (delta.reasoning_content) {
                                        reasoningTextChunk = delta.reasoning_content;
                                        accumulatedFullReasoningContent += reasoningTextChunk;
                                    } else if (delta.content) {
                                        contentTextChunk = delta.content;
                                    }
                                }

                                if (chunk.choices && chunk.choices[0] && chunk.choices[0].finish_reason) {
                                    finalFinishReason = chunk.choices[0].finish_reason;
                                }
                                if (chunk.usage) {
                                    finalUsage = chunk.usage;
                                }

                                if (contentTextChunk !== null || reasoningTextChunk !== null) {
                                    yield { type: 'chunk', contentText: contentTextChunk, thoughtText: reasoningTextChunk };
                                }
                            } catch (e) {}
                        }
                    }
                     if (finalFinishReason && finalFinishReason !== 'null') break;
                }

                yield {
                    type: 'metadata',
                    finishReason: isCancelled ? 'ABORTED' : finalFinishReason || 'stop',
                    safetyRatings: null,
                    groundingMetadata: null,
                    usageMetadata: finalUsage ? {
                        candidatesTokenCount: finalUsage.completion_tokens,
                        totalTokenCount: finalUsage.total_tokens,
                    } : null,
                    fullReasoningContent: accumulatedFullReasoningContent || null
                };
            } catch (error) {
                 yield { type: 'error', error: { message: error.message }, message: error.message };
            } finally {
                if (!reader.closed && !isCancelled) {
                    try { await reader.cancel("Stream processing ended."); } catch (e) { }
                }
            }
        },
        async callClaudeApi(messagesForApi, generationConfig, systemInstruction, useStreaming) {
            const apiKey = state.settings.showMultiApiKeys ? multiApiKeyUtils.getActiveApiKey('claude') : state.settings.claudeApiKey;
            if (!apiKey) {
                throw new Error("Claude API繧ｭ繝ｼ縺瑚ｨｭ螳壹＆繧後※縺・∪縺帙ｓ縲・);
            }
            state.abortController = new AbortController();
            const { signal } = state.abortController;

            const model = state.settings.claudeModelName || DEFAULT_CLAUDE_MODEL;
            const baseUrl = CLAUDE_API_BASE_URL;
            
            const anthropicRequest = this.convertToClaudeRequest(messagesForApi, systemInstruction);

            const requestBody = {
                model: model,
                messages: anthropicRequest.messages,
                stream: useStreaming,
                max_tokens: generationConfig.maxOutputTokens || state.settings.claudeMaxTokens || DEFAULT_CLAUDE_MAX_TOKENS
            };
            if(anthropicRequest.system) requestBody.system = anthropicRequest.system;
            if (generationConfig.temperature !== undefined && generationConfig.temperature !== null) {
                requestBody.temperature = generationConfig.temperature;
            } else if (state.settings.claudeTemperature !== null) {
                requestBody.temperature = state.settings.claudeTemperature;
            } else {
                requestBody.temperature = DEFAULT_CLAUDE_TEMPERATURE;
            }

            if (generationConfig.topK !== undefined && generationConfig.topK !== null) {
                requestBody.top_k = generationConfig.topK;
            } else if (state.settings.claudeTopK !== null) {
                requestBody.top_k = state.settings.claudeTopK;
            }

            if (generationConfig.topP !== undefined && generationConfig.topP !== null) {
                requestBody.top_p = generationConfig.topP;
            } else if (state.settings.claudeTopP !== null) {
                requestBody.top_p = state.settings.claudeTopP;
            } else {
                requestBody.top_p = DEFAULT_CLAUDE_TOP_P;
            }
                            if (state.settings.claudeIncludeThoughts) {
                requestBody.thinking = { "type": "enabled" };
                const budget = state.settings.claudeThinkingBudget;
                if (budget !== null && Number.isInteger(budget) && budget >= 1024) {
                    requestBody.thinking.budget_tokens = budget;
                }
            }

            try {
                const response = await fetch(baseUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify(requestBody),
                    signal
                });

                if (!response.ok) {
                    let errorMsg = `Claude API繧ｨ繝ｩ繝ｼ (${response.status}): ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.error && errorData.error.message) {
                            errorMsg = `Claude API繧ｨ繝ｩ繝ｼ (${response.status}): ${errorData.error.message} (Type: ${errorData.error.type || 'N/A'})`;
                        }
                    } catch (e) {}
                    throw new Error(errorMsg);
                }
                return response;
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error("繝ｪ繧ｯ繧ｨ繧ｹ繝医′繧ｭ繝｣繝ｳ繧ｻ繝ｫ縺輔ｌ縺ｾ縺励◆縲・);
                }
                throw error;
            }
        },
        convertToClaudeRequest(messagesForApi, systemInstruction) {
            const claudeMessages = [];
            let systemContent = '';

            if (systemInstruction && systemInstruction.content) {
                systemContent = systemInstruction.content;
            } else if (systemInstruction && systemInstruction.parts && systemInstruction.parts.length > 0 && systemInstruction.parts[0].text) {
                systemContent = systemInstruction.parts[0].text;
            }

            for (const msg of messagesForApi) {
                const claudeRole = msg.role === 'model' ? 'assistant' : 'user';
                const contentParts = [];
                msg.parts.forEach(part => {
                    if (part.text) {
                        contentParts.push({ type: 'text', text: part.text });
                    } else if (part.inlineData && part.inlineData.mimeType && part.inlineData.data && part.inlineData.mimeType.startsWith('image/')) {
                         contentParts.push({
                            type: 'image',
                            source: {
                                type: 'base64',
                                media_type: part.inlineData.mimeType,
                                data: part.inlineData.data
                            }
                        });
                    }
                });

                if (contentParts.length > 0) {
                    claudeMessages.push({
                        role: claudeRole,
                        content: contentParts
                    });
                }
            }
            return {
                messages: claudeMessages,
                system: systemContent || undefined
            };
        },
        async *handleClaudeStreamingResponse(response) {
            if (!response.body) {
                throw new Error("Claude繝ｬ繧ｹ繝昴Φ繧ｹ繝懊ョ繧｣縺後≠繧翫∪縺帙ｓ縲・);
            }
            const reader = response.body.pipeThrough(new TextDecoderStream()).getReader();
            let buffer = '';
            let finalUsage = null;
            let finalFinishReason = null;
            let isCancelled = false;

            try {
                while (true) {
                    if (state.abortController?.signal.aborted && !isCancelled) {
                        isCancelled = true;
                        await reader.cancel("User aborted");
                        throw new Error("繝ｪ繧ｯ繧ｨ繧ｹ繝医′繧ｭ繝｣繝ｳ繧ｻ繝ｫ縺輔ｌ縺ｾ縺励◆縲・);
                    }

                    const { value, done } = await reader.read();
                    if (done) break;

                    buffer += value;
                    let eolIndex;
                    while ((eolIndex = buffer.indexOf('\n')) >= 0) {
                        const line = buffer.substring(0, eolIndex).trim();
                        buffer = buffer.substring(eolIndex + 1);

                        if (line.startsWith('data: ')) {
                            const jsonData = line.substring(6);
                            if (jsonData.trim() === '[DONE]') {
                                break;
                            }
                            try {
                                const chunk = JSON.parse(jsonData);
                                if (chunk.type === 'content_block_delta' && chunk.delta && chunk.delta.type === 'text_delta') {
                                    yield { type: 'chunk', contentText: chunk.delta.text || '', thoughtText: null };
                                } else if (chunk.type === 'content_block_start' && chunk.content_block && chunk.content_block.type === 'thinking') {
                                } else if (chunk.type === 'content_block_delta' && chunk.delta && chunk.delta.type === 'thinking_delta') {
                                    yield { type: 'chunk', contentText: null, thoughtText: chunk.delta.thinking || '' };
                                } else if (chunk.type === 'message_stop') {
                                    finalFinishReason = chunk.message?.stop_reason || 'stop';
                                    if (chunk["amazon-bedrock-invocationMetrics"]) {
                                        finalUsage = {
                                            input_tokens: chunk["amazon-bedrock-invocationMetrics"].inputTokenCount,
                                            output_tokens: chunk["amazon-bedrock-invocationMetrics"].outputTokenCount
                                        };
                                    } else if (chunk.usage) {
                                        finalUsage = chunk.usage;
                                    }
                                } else if (chunk.type === 'message_delta' && chunk.usage) {
                                    finalUsage = chunk.usage;
                                }
                            } catch (e) {
                            }
                        }
                    }
                                        if (finalFinishReason && finalFinishReason !== 'null') break;
                }
                yield {
                    type: 'metadata',
                    finishReason: isCancelled ? 'ABORTED' : finalFinishReason || 'stop',
                    safetyRatings: null,
                                            usageMetadata: finalUsage ? {
                        candidatesTokenCount: finalUsage.output_tokens,
                        totalTokenCount: finalUsage.input_tokens + finalUsage.output_tokens
                    } : null
                };
            } catch (error) {
                 yield { type: 'error', error: { message: error.message }, message: error.message };
            } finally {
                if (!reader.closed && !isCancelled) {
                    try { await reader.cancel("Stream processing ended."); } catch (e) { }
                }
            }
        },
        _createOpenAICompatibleRequestBody(model, messagesForApi, systemInstruction, generationConfig, useStreaming, enableVision) {
            const oaMessages = [];
            if (systemInstruction && systemInstruction.parts?.[0]?.text) {
                oaMessages.push({ role: "system", content: systemInstruction.parts[0].text });
            }

            messagesForApi.forEach(m => {
                const role = m.role === "model" ? "assistant" : m.role;
                const contentParts = [];
                let hasTextPart = false;

                m.parts.forEach(p => {
                    if (p.text) {
                        if (hasTextPart) {
                            contentParts[contentParts.length - 1].text += `\n${p.text}`;
                        } else {
                            contentParts.push({ type: "text", text: p.text });
                            hasTextPart = true;
                        }
                    }
                    if (p.textData) {
                         if (hasTextPart) {
                            contentParts[contentParts.length - 1].text += `\n\n--- 繝輔ぃ繧､繝ｫ蜀・ｮｹ ---\n${p.textData}`;
                        } else {
                            contentParts.push({ type: "text", text: p.textData });
                            hasTextPart = true;
                        }
                    }
                    if (enableVision && p.inlineData && p.inlineData.mimeType && p.inlineData.data && p.inlineData.mimeType.startsWith('image/')) {
                        contentParts.push({
                            type: "image_url",
                            image_url: { url: `data:${p.inlineData.mimeType};base64,${p.inlineData.data}` }
                        });
                    }
                });

                if (contentParts.length > 0) {
                    oaMessages.push({ role: role, content: contentParts });
                }
            });

            const body = {
                model: model,
                messages: oaMessages,
                stream: useStreaming,
            };
            if (generationConfig.temperature != null) body.temperature = generationConfig.temperature;
            if (generationConfig.maxOutputTokens != null) body.max_tokens = generationConfig.maxOutputTokens;
            if (generationConfig.topP != null) body.top_p = generationConfig.topP;
            if (generationConfig.presencePenalty != null) body.presence_penalty = generationConfig.presencePenalty;
            if (generationConfig.frequencyPenalty != null) body.frequency_penalty = generationConfig.frequencyPenalty;

            return body;
        },
        async callOpenAICompatibleApi(provider, messagesForApi, generationConfig, systemInstruction, useStreaming, enableVision) {
            let apiKey, model, baseUrl;
            
            if (provider === 'openai') {
                apiKey = state.settings.showMultiApiKeys ? multiApiKeyUtils.getActiveApiKey('openai') : state.settings.openaiApiKey;
                model = state.settings.openaiModelName || DEFAULT_OPENAI_MODEL;
                baseUrl = OPENAI_API_BASE_URL;
            } else if (provider === 'llmaggregator') {
                apiKey = state.settings.showMultiApiKeys ? multiApiKeyUtils.getActiveApiKey('llmaggregator') : state.settings.llmAggregatorApiKey;
                model = state.settings.llmAggregatorModelName || DEFAULT_LLMAGGREGATOR_MODEL;
                baseUrl = state.settings.llmAggregatorApiBackend;
                if (!baseUrl) {
                    throw new Error("LLM Aggregator縺ｮAPI繝舌ャ繧ｯ繧ｨ繝ｳ繝蔚RL縺瑚ｨｭ螳壹＆繧後※縺・∪縺帙ｓ縲・);
                }
            } else {
                throw new Error(`Unsupported provider for callOpenAICompatibleApi: ${provider}`);
            }
            
            if (!apiKey) {
                throw new Error(`${provider} 縺ｮAPI繧ｭ繝ｼ縺瑚ｨｭ螳壹＆繧後※縺・∪縺帙ｓ縲Ａ);
            }

            state.abortController = new AbortController();
            const { signal } = state.abortController;

            const headers = {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${apiKey}`
            };

            const body = this._createOpenAICompatibleRequestBody(
                model,
                messagesForApi,
                systemInstruction,
                generationConfig,
                useStreaming,
                enableVision
            );
            
            if (provider === 'llmaggregator' && generationConfig.topK !== null) {
                body.top_k = generationConfig.topK;
            }
            
            const response = await fetch(baseUrl, { method: "POST", headers, body: JSON.stringify(body), signal });
            if (!response.ok) {
                let msg = `${provider} API error ${response.status}`;
                try {
                    const je = await response.json();
                    msg = je.error?.message || msg;
                } catch {}
                throw new Error(msg);
            }
            return response;
        },
        async *handleOpenAICompatibleStreamingResponse(response, providerName) {
            if (!response.body) {
                throw new Error(`${providerName}繝ｬ繧ｹ繝昴Φ繧ｹ繝懊ョ繧｣縺後≠繧翫∪縺帙ｓ縲Ａ);
            }
            const reader = response.body.pipeThrough(new TextDecoderStream()).getReader();
            let buffer = '';
            let usage = null;
            let finishReason = null;
            let isCancelled = false;

            try {
                while (true) {
                    if (state.abortController?.signal.aborted) {
                        isCancelled = true;
                        await reader.cancel();
                        throw new Error("繝ｪ繧ｯ繧ｨ繧ｹ繝医′繧ｭ繝｣繝ｳ繧ｻ繝ｫ縺輔ｌ縺ｾ縺励◆縲・);
                    }

                    const { value, done } = await reader.read();
                    if (done) break;

                    buffer += value;
                    let eolIndex;
                    while ((eolIndex = buffer.indexOf('\n')) >= 0) {
                        const line = buffer.slice(0, eolIndex).trim();
                        buffer = buffer.slice(eolIndex + 1);

                        if (!line.startsWith('data:')) continue;
                        const data = line.slice(5).trim();

                        if (data === '[DONE]') {
                            finishReason = 'stop';
                            break;
                        }
                        try {
                            const chunk = JSON.parse(data);
                            if (chunk.choices?.[0]) {
                                const delta = chunk.choices[0].delta;
                                let contentText = null;
                                let thoughtText = null;

                                if (delta?.content) {
                                    contentText = delta.content;
                                }
                                if (delta?.reasoning_content) {
                                    thoughtText = delta.reasoning_content;
                                }

                                if (contentText !== null || thoughtText !== null) {
                                    yield { type: "chunk", contentText: contentText, thoughtText: thoughtText };
                                }
                                
                                if (chunk.choices[0].finish_reason) {
                                    finishReason = chunk.choices[0].finish_reason;
                                }
                            }
                            if (chunk.usage) {
                                usage = chunk.usage;
                                if (usage.completion_tokens_details?.reasoning_tokens) {
                                    usage.completion_tokens += usage.completion_tokens_details.reasoning_tokens;
                                }
                            }
                        } catch (e) {}
                    }
                    if (finishReason) break;
                }
                yield {
                    type: "metadata",
                    finishReason: isCancelled ? "ABORTED" : finishReason || 'stop',
                    usageMetadata: usage ? {
                        candidatesTokenCount: usage.completion_tokens,
                        totalTokenCount: usage.prompt_tokens + usage.completion_tokens
                    } : null,
                    safetyRatings: null,
                    groundingMetadata: null
                };
            } catch (error) {
                 yield { type: 'error', error: { message: error.message }, message: error.message };
            } finally {
                if (!reader.closed && !isCancelled) {
                    try { await reader.cancel(); } catch (e) {}
                }
            }
        },
        async callXaiApi(messagesForApi, generationConfig, systemInstruction, useStreaming, enableVision) {
            const apiKey = state.settings.showMultiApiKeys ? multiApiKeyUtils.getActiveApiKey('xai') : state.settings.xaiApiKey;
            if (!apiKey) {
                throw new Error("xAI API繧ｭ繝ｼ縺瑚ｨｭ螳壹＆繧後※縺・∪縺帙ｓ縲・);
            }
            state.abortController = new AbortController();
            const { signal } = state.abortController;

            const headers = {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${apiKey}`
            };
            
            const body = this._createOpenAICompatibleRequestBody(
                state.settings.xaiModelName || DEFAULT_XAI_MODEL,
                messagesForApi,
                systemInstruction,
                generationConfig,
                useStreaming,
                enableVision
            );

            const reasoningModels = ['grok-3-mini', 'grok-3-mini-fast'];
            if (state.settings.xaiIncludeThoughts && reasoningModels.includes(body.model)) {
                body.reasoning_effort = state.settings.xaiReasoningEffort;
            }
            
            const baseUrl = XAI_API_BASE_URL;
            const response = await fetch(baseUrl, { 
                method: "POST", 
                headers, 
                body: JSON.stringify(body), 
                signal 
            });
            
            if (!response.ok) {
                let msg = `xAI API error ${response.status}`;
                try {
                    const je = await response.json();
                    msg = je.error?.message || msg;
                } catch {}
                throw new Error(msg);
            }

            if (!useStreaming) {
                const data = await response.json();
                let reasoningContent = null;
                const choice = data.choices?.[0];
                if (choice && choice.message && choice.message.reasoning_content) {
                    reasoningContent = choice.message.reasoning_content;
                }
                if (data.usage?.completion_tokens_details?.reasoning_tokens) {
                    data.usage.completion_tokens += data.usage.completion_tokens_details.reasoning_tokens;
                }
                response.json = async () => ({ ...data, xaiThoughtSummary: reasoningContent });
            }
            return response;
        },
    };

    const errorRecovery = {
        errorCount: 0,
        errorTimeWindow: 60000,
        maxErrors: 3,
        lastErrorTime: 0,
        isRecovering: false,
        errorLog: [],
        maxLogSize: 20,

        logError(type, errorInfo) {
            const now = new Date();
            const logEntry = {
                timestamp: now.toISOString(),
                type: type,
                info: this.serializeErrorInfo(errorInfo)
            };
            this.errorLog.unshift(logEntry);
            if (this.errorLog.length > this.maxLogSize) {
                this.errorLog.pop();
            }
        },

        serializeErrorInfo(errorInfo) {
            try {
                const cache = new Set();
                return JSON.stringify(errorInfo, (key, value) => {
                    if (typeof value === 'object' && value !== null) {
                        if (value instanceof Window) return '[Window Object]';
                        if (cache.has(value)) {
                            return '[Circular Reference]';
                        }
                        cache.add(value);
                    }
                    return value;
                }, 2);
            } catch (e) {
                if (errorInfo instanceof Error) {
                    return JSON.stringify({ message: errorInfo.message, stack: errorInfo.stack, name: errorInfo.name }, null, 2);
                }
                return `Failed to serialize error: ${e.message}`;
            }
        },

        getErrorLogAsString() {
            if (this.errorLog.length === 0) {
                return "縺薙ｌ縺ｾ縺ｧ縺ｫ險倬鹸縺輔ｌ縺溘お繝ｩ繝ｼ縺ｯ縺ゅｊ縺ｾ縺帙ｓ縲・;
            }
            return this.errorLog.map(log => 
                `Timestamp: ${log.timestamp}\nType: ${log.type}\nInfo:\n${log.info}`
            ).join('\n\n====================\n\n');
        },
        
        init() {
            window.addEventListener('error', (event) => {
                this.handleError('JavaScript Error', {
                    message: event.message,
                    filename: event.filename,
                    lineno: event.lineno,
                    colno: event.colno,
                    error: event.error
                });
            });

            window.addEventListener('unhandledrejection', (event) => {
                this.handleError('Unhandled Promise Rejection', {
                    reason: event.reason,
                    promise: event.promise
                });
            });

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.addEventListener('error', (event) => {
                    this.handleError('Service Worker Error', event);
                });
            }
        },

        handleError(type, errorInfo) {
            if (this.isRecovering) return;

            const now = Date.now();
                            if (now - this.lastErrorTime > this.errorTimeWindow) {
                this.errorCount = 0;
            }
            
            this.errorCount++;
            this.lastErrorTime = now;
            
            this.logError(type, errorInfo);
            
            const isCriticalError = this.isCriticalError(errorInfo);
            
            if (this.errorCount >= this.maxErrors || isCriticalError) {
                this.triggerForceReload(type, errorInfo, isCriticalError);
            }
        },

        isCriticalError(errorInfo) {
            const criticalPatterns = [
                /Cannot read prop/i,
                /Cannot access before initialization/i,
                /is not defined/i,
                /IndexedDB/i,
                /QuotaExceededError/i,
                /localStorage/i,
                /sessionStorage/i,
                /Service Worker/i,
                /Failed to fetch/i,
                /NetworkError/i
            ];
                        const errorMessage = JSON.stringify(errorInfo).toLowerCase();
            return criticalPatterns.some(pattern => pattern.test(errorMessage));
        },

        async triggerForceReload(errorType, errorInfo, isCritical) {
            if (this.isRecovering) return;
            this.isRecovering = true;

            const reason = isCritical ? '閾ｴ蜻ｽ逧・↑繧ｨ繝ｩ繝ｼ' : `騾｣邯壹お繝ｩ繝ｼ(${this.errorCount}蝗・`;
            
            try {
                await this.showRecoveryNotification(reason, errorType);
                
                await this.clearCacheAndReload();
                
            } catch (recoveryError) {
                window.location.reload(true);
            }
        },

        async showRecoveryNotification(reason, errorType) {
            if (typeof uiUtils !== 'undefined' && uiUtils.showCustomAlert) {
                try {
                    await uiUtils.showCustomAlert(
                        `繧｢繝励Μ縺ｧ${reason}縺檎匱逕溘＠縺ｾ縺励◆縲・n` +
                        `螳牙ｮ壽ｧ繧剃ｿ昴▽縺溘ａ縲√く繝｣繝・す繝･繧偵け繝ｪ繧｢縺励※蜀崎ｵｷ蜍輔＠縺ｾ縺吶・n\n` +
                        `繧ｨ繝ｩ繝ｼ繧ｿ繧､繝・ ${errorType}\n` +
                        `縺薙・謫堺ｽ懊・閾ｪ蜍輔〒螳溯｡後＆繧後∪縺吶Ａ
                    );
                } catch (e) {
                    alert(`繧｢繝励Μ縺ｧ${reason}縺檎匱逕溘＠縺ｾ縺励◆縲ゅく繝｣繝・す繝･繧偵け繝ｪ繧｢縺励※蜀崎ｵｷ蜍輔＠縺ｾ縺吶Ａ);
                }
            } else {
                alert(`繧｢繝励Μ縺ｧ${reason}縺檎匱逕溘＠縺ｾ縺励◆縲ゅく繝｣繝・す繝･繧偵け繝ｪ繧｢縺励※蜀崎ｵｷ蜍輔＠縺ｾ縺吶Ａ);
            }
        },

        async clearCacheAndReload() {
            try {
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    await new Promise((resolve, reject) => {
                        const timeoutId = setTimeout(() => reject(new Error('Service Worker timeout')), 5000);
                        
                        const messageHandler = (event) => {
                            if (event.data && event.data.action === 'cacheCleared') {
                                clearTimeout(timeoutId);
                                navigator.serviceWorker.removeEventListener('message', messageHandler);
                                resolve();
                            }
                        };
                        
                        navigator.serviceWorker.addEventListener('message', messageHandler);
                        navigator.serviceWorker.controller.postMessage({ action: 'clearCache' });
                    });
                }
                
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                }
                
                this.clearStorageSelectively();
                
                window.location.reload(true);
                
            } catch (error) {
                window.location.href = window.location.href + '?recovery=' + Date.now();
            }
                        },

        clearStorageSelectively() {
            try {
                const protectedKeys = [
                    'GeminiPWA_DB',
                ];
                
                if (typeof Storage !== 'undefined' && sessionStorage) {
                    sessionStorage.clear();
                }
                
                if (typeof Storage !== 'undefined' && localStorage) {
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && !protectedKeys.some(protected => key.includes(protected))) {
                            keysToRemove.push(key);
                        }
                    }
                    keysToRemove.forEach(key => localStorage.removeItem(key));
                }
            } catch (error) {
            }
        },

        manualRecovery() {
            this.triggerForceReload('Manual Recovery', { reason: 'User triggered' }, true);
        }
    };
            const multiApiKeyUtils = {
        MAX_API_KEYS: 10,

        initializeMultiApiKeys() {
            elements.addGeminiApiKeyBtn.addEventListener('click', () => this.addApiKey('gemini'));
            elements.addDeepseekApiKeyBtn.addEventListener('click', () => this.addApiKey('deepseek'));
            elements.addClaudeApiKeyBtn.addEventListener('click', () => this.addApiKey('claude'));
            elements.addOpenaiApiKeyBtn.addEventListener('click', () => this.addApiKey('openai'));
            elements.addXaiApiKeyBtn.addEventListener('click', () => this.addApiKey('xai'));
            elements.addLlmaggregatorApiKeyBtn.addEventListener('click', () => this.addApiKey('llmaggregator'));

            this.renderAllApiKeyLists();
        },

        addApiKey(provider) {
            const keys = this.getApiKeysArray(provider);
            if (keys.length >= this.MAX_API_KEYS) {
                uiUtils.showCustomAlert(`譛螟ｧ${this.MAX_API_KEYS}蛟九∪縺ｧ縺ｮAPI繧ｭ繝ｼ繧定ｨｭ螳壹〒縺阪∪縺吶Ａ);
                return;
            }

            const newKey = {
                id: Date.now().toString(),
                label: `繧ｭ繝ｼ ${keys.length + 1}`,
                value: '',
                isActive: keys.length === 0
            };

            keys.push(newKey);
            
            if (newKey.isActive) {
                this.setActiveApiKeyIndex(provider, keys.length - 1);
            }

            this.renderApiKeyList(provider);
            this.updateMainApiKeyInput(provider);
        },

        async deleteApiKey(provider, keyId) {
            const keys = this.getApiKeysArray(provider);
            const keyIndex = keys.findIndex(key => key.id === keyId);
            if (keyIndex === -1) return;

            const keyToDelete = keys[keyIndex];
            const confirmed = await uiUtils.showCustomConfirm(
                `API繧ｭ繝ｼ縲・{keyToDelete.label}縲阪ｒ蜑企勁縺励∪縺吶°・歔
            );
            
            if (!confirmed) return;

            const wasActive = keyToDelete.isActive;
            keys.splice(keyIndex, 1);

            if (wasActive && keys.length > 0) {
                const newActiveIndex = Math.min(keyIndex, keys.length - 1);
                keys[newActiveIndex].isActive = true;
                this.setActiveApiKeyIndex(provider, newActiveIndex);
            } else if (keys.length === 0) {
                this.setActiveApiKeyIndex(provider, -1);
            }

            this.renderApiKeyList(provider);
            this.updateMainApiKeyInput(provider);
        },

        selectApiKey(provider, keyId) {
            const keys = this.getApiKeysArray(provider);
            const selectedIndex = keys.findIndex(key => key.id === keyId);
            if (selectedIndex === -1) return;

            keys.forEach((key, index) => {
                key.isActive = index === selectedIndex;
            });

            this.setActiveApiKeyIndex(provider, selectedIndex);
            this.renderApiKeyList(provider);
            this.updateMainApiKeyInput(provider);
        },

        updateApiKeyValue(provider, keyId, newValue) {
            const keys = this.getApiKeysArray(provider);
            const key = keys.find(k => k.id === keyId);
            if (key) {
                key.value = newValue.trim();
                if (key.isActive) {
                    this.updateMainApiKeyInput(provider);
                }
            }
        },

        updateApiKeyLabel(provider, keyId, newLabel) {
            const keys = this.getApiKeysArray(provider);
            const key = keys.find(k => k.id === keyId);
            if (key) {
                key.label = newLabel.trim() || `繧ｭ繝ｼ ${keys.indexOf(key) + 1}`;
            }
        },

        getApiKeysArray(provider) {
            switch (provider) {
                case 'gemini': return state.settings.geminiApiKeys;
                case 'deepseek': return state.settings.deepseekApiKeys;
                case 'claude': return state.settings.claudeApiKeys;
                case 'openai': return state.settings.openaiApiKeys;
                case 'xai': return state.settings.xaiApiKeys;
                case 'llmaggregator': return state.settings.llmaggregatorApiKeys;
                default: return [];
            }
        },

        setActiveApiKeyIndex(provider, index) {
            switch (provider) {
                case 'gemini': state.settings.geminiActiveApiKeyIndex = index; break;
                case 'deepseek': state.settings.deepseekActiveApiKeyIndex = index; break;
                case 'claude': state.settings.claudeActiveApiKeyIndex = index; break;
                case 'openai': state.settings.openaiActiveApiKeyIndex = index; break;
                case 'xai': state.settings.xaiActiveApiKeyIndex = index; break;
                case 'llmaggregator': state.settings.llmaggregatorActiveApiKeyIndex = index; break;
            }
        },

        getActiveApiKey(provider) {
            const keys = this.getApiKeysArray(provider);
            const activeKey = keys.find(key => key.isActive);
            return activeKey ? activeKey.value : '';
        },

        updateMainApiKeyInput(provider) {
            if (!state.settings.showMultiApiKeys) {
                return;
            }
            const activeKey = this.getActiveApiKey(provider);
            switch (provider) {
                case 'gemini':
                    elements.geminiApiKeyInput.value = activeKey;
                    break;
                case 'deepseek':
                    elements.deepSeekApiKeyInput.value = activeKey;
                    break;
                case 'claude':
                    elements.claudeApiKeyInput.value = activeKey;
                    break;
                                    case 'openai':
                    elements.openaiApiKeyInput.value = activeKey;
                    break;
                case 'xai':
                    elements.xaiApiKeyInput.value = activeKey;
                    break;
                case 'llmaggregator':
                    elements.llmAggregatorApiKeyInput.value = activeKey;
                    break;
            }
        },

        renderApiKeyList(provider) {
            const keys = this.getApiKeysArray(provider);
            const container = this.getListContainer(provider);
                            const addButton = this.getAddButton(provider);

            container.innerHTML = '';

            if (keys.length === 0) {
                const emptyMsg = document.createElement('p');
                emptyMsg.textContent = 'API繧ｭ繝ｼ縺瑚ｨｭ螳壹＆繧後※縺・∪縺帙ｓ縲・;
                emptyMsg.style.color = 'var(--text-secondary)';
                emptyMsg.style.fontSize = '13px';
                emptyMsg.style.textAlign = 'center';
                emptyMsg.style.margin = '10px 0';
                container.appendChild(emptyMsg);
            } else {
                keys.forEach((key, index) => {
                    const item = this.createApiKeyItem(provider, key, index);
                    container.appendChild(item);
                });
            }

            addButton.disabled = keys.length >= this.MAX_API_KEYS;
            addButton.textContent = keys.length >= this.MAX_API_KEYS 
                ? `譛螟ｧ${this.MAX_API_KEYS}蛟九∪縺ｧ` 
                : '譁ｰ縺励＞API繧ｭ繝ｼ繧定ｿｽ蜉';
        },

        createApiKeyItem(provider, key, index) {
            const item = document.createElement('div');
            item.className = `api-key-item ${key.isActive ? 'active' : ''}`;

            const labelInput = document.createElement('input');
            labelInput.type = 'text';
            labelInput.className = 'api-key-item-label';
            labelInput.value = key.label;
            labelInput.placeholder = `繧ｭ繝ｼ ${index + 1}`;
            labelInput.addEventListener('change', (e) => {
                                this.updateApiKeyLabel(provider, key.id, e.target.value);
            });

            const keyInput = document.createElement('input');
            keyInput.type = 'password';
            keyInput.className = 'api-key-item-input';
            keyInput.value = key.value;
            keyInput.placeholder = 'API繧ｭ繝ｼ繧貞・蜉・..';
            keyInput.addEventListener('input', (e) => {
                this.updateApiKeyValue(provider, key.id, e.target.value);
            });

            const actions = document.createElement('div');
            actions.className = 'api-key-item-actions';

            const selectBtn = document.createElement('button');
            selectBtn.className = `api-key-select-btn ${key.isActive ? 'active' : ''}`;
            selectBtn.textContent = key.isActive ? '菴ｿ逕ｨ荳ｭ' : '譛ｪ驕ｸ謚・;
            selectBtn.disabled = key.isActive;
            selectBtn.addEventListener('click', () => {
                this.selectApiKey(provider, key.id);
            });

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'api-key-delete-btn';
            deleteBtn.textContent = '蜑・;
            deleteBtn.addEventListener('click', () => {
                this.deleteApiKey(provider, key.id);
            });

            actions.appendChild(selectBtn);
            actions.appendChild(deleteBtn);

            item.appendChild(labelInput);
            item.appendChild(keyInput);
            item.appendChild(actions);

            return item;
        },

        getListContainer(provider) {
            switch (provider) {
                case 'gemini': return elements.geminiApiKeysList;
                case 'deepseek': return elements.deepseekApiKeysList;
                case 'claude': return elements.claudeApiKeysList;
                case 'openai': return elements.openaiApiKeysList;
                case 'xai': return elements.xaiApiKeysList;
                case 'llmaggregator': return elements.llmaggregatorApiKeysList;
                default: return null;
            }
        },

        getAddButton(provider) {
            switch (provider) {
                case 'gemini': return elements.addGeminiApiKeyBtn;
                case 'deepseek': return elements.addDeepseekApiKeyBtn;
                case 'claude': return elements.addClaudeApiKeyBtn;
                case 'openai': return elements.addOpenaiApiKeyBtn;
                case 'xai': return elements.addXaiApiKeyBtn;
                case 'llmaggregator': return elements.addLlmaggregatorApiKeyBtn;
                default: return null;
            }
        },

        renderAllApiKeyLists() {
            this.renderApiKeyList('gemini');
            this.renderApiKeyList('deepseek');
            this.renderApiKeyList('claude');
            this.renderApiKeyList('openai');
            this.renderApiKeyList('xai');
                        this.renderApiKeyList('llmaggregator');
        },

        syncMainApiKeyInput(provider) {
            if (!state.settings.showMultiApiKeys) {
                return;
            }
            let mainValue = '';
            switch (provider) {
                case 'gemini': mainValue = elements.geminiApiKeyInput.value.trim(); break;
                case 'deepseek': mainValue = elements.deepSeekApiKeyInput.value.trim(); break;
                case 'claude': mainValue = elements.claudeApiKeyInput.value.trim(); break;
                case 'openai': mainValue = elements.openaiApiKeyInput.value.trim(); break;
                case 'xai': mainValue = elements.xaiApiKeyInput.value.trim(); break;
                case 'llmaggregator': mainValue = elements.llmAggregatorApiKeyInput.value.trim(); break;
            }

            const keys = this.getApiKeysArray(provider);
            const activeKey = keys.find(key => key.isActive);
            
            if (activeKey && activeKey.value !== mainValue) {
                activeKey.value = mainValue;
                this.renderApiKeyList(provider);
            }
        }
    };

    errorRecovery.init();

    window.errorRecovery = errorRecovery;
    
    // 繝√Ε繝・ヨ險ｭ螳壹Δ繝ｼ繝繝ｫ讖溯・縺ｮ蛻晄悄蛹・    function initializeChatSettingsModal() {
        
        // 繧､繝吶Φ繝医ワ繝ｳ繝峨Λ繝ｼ險ｭ螳夐未謨ｰ繧貞・縺ｫ螳夂ｾｩ
        const setupEventHandlers = () => {
            
            // 繝輔ぃ繧､繝ｫ驕ｸ謚槭・繧ｿ繝ｳ縺ｮ繧ｯ繝ｪ繝・け繧､繝吶Φ繝・            const chatAiIconSelectBtn = document.getElementById('chat-ai-icon-select');
            if (chatAiIconSelectBtn) {
                chatAiIconSelectBtn.onclick = () => {
                    const chatAiIconInput = document.getElementById('chat-ai-icon');
                    if (chatAiIconInput) {
                        chatAiIconInput.click();
                    }
                };
            }
            
            const chatBackgroundSelectBtn = document.getElementById('chat-background-select');
            if (chatBackgroundSelectBtn) {
                chatBackgroundSelectBtn.onclick = () => {
                    const chatBackgroundImageInput = document.getElementById('chat-background-image');
                    if (chatBackgroundImageInput) {
                        chatBackgroundImageInput.click();
                    }
                };
            }
            
            // AI繧｢繧､繧ｳ繝ｳ繝輔ぃ繧､繝ｫ驕ｸ謚・            const chatAiIconInput = document.getElementById('chat-ai-icon');
            if (chatAiIconInput) {
                chatAiIconInput.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    // 繝輔ぃ繧､繝ｫ繧ｵ繧､繧ｺ繝√ぉ繝・け
                    const maxSize = 1 * 1024 * 1024; // 1MB
                    if (file.size > maxSize) {
                        await uiUtils.showCustomAlert('繝輔ぃ繧､繝ｫ繧ｵ繧､繧ｺ縺ｯ1MB莉･荳九↓縺励※縺上□縺輔＞縲・);
                        chatAiIconInput.value = '';
                        return;
                    }
                    
                    // 繝輔ぃ繧､繝ｫ繧ｿ繧､繝励メ繧ｧ繝・け
                    if (!file.type.startsWith('image/')) {
                        await uiUtils.showCustomAlert('逕ｻ蜒上ヵ繧｡繧､繝ｫ繧帝∈謚槭＠縺ｦ縺上□縺輔＞縲・);
                        chatAiIconInput.value = '';
                        return;
                    }
                    
                    try {
                        // 譌｢蟄倥・URL繧定ｧ｣謾ｾ・・OS Safari繧帝勁縺擾ｼ・                        if (state.aiIconUrl && !uiUtils.isIOSSafari()) {
                            URL.revokeObjectURL(state.aiIconUrl);
                        }
                        
                        // 繝｢繝ｼ繝繝ｫ逕ｨ縺ｮ荳譎ょ､画焚縺ｫ菫晏ｭ假ｼ・tate.settings縺ｯ譖ｴ譁ｰ縺励↑縺・ｼ・                        if (!state.modalTemp) {
                            state.modalTemp = {};
                        }
                        state.modalTemp.aiIconBlob = file;
                        // dirty繝輔Λ繧ｰ繧定ｨｭ螳・                        state.assetDirty.aiIcon = true;
                        // 蜊ｳ蠎ｧ縺ｫ菫晏ｭ倥○縺壹∽ｿ晏ｭ倥・繧ｿ繝ｳ繧ｯ繝ｪ繝・け譎ゅ↓菫晏ｭ倥☆繧・                        
                        // 繝励Ξ繝薙Η繝ｼ繧呈峩譁ｰ
                        try {
                            state.aiIconUrl = URL.createObjectURL(file);
                        } catch (e) {
                            console.warn('Safari Blob URL creation failed in chat settings:', e);
                            // iOS Safari縺ｧ繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺溷ｴ蜷医：ileReader繧剃ｽｿ逕ｨ
                            try {
                                const reader = new FileReader();
                                reader.onload = function(event) {
                                    const dataUrl = event.target.result;
                                    state.aiIconUrl = dataUrl;
                                    
                                    const chatAiIconPreview = document.getElementById('chat-ai-icon-preview');
                                    if (chatAiIconPreview) {
                                        chatAiIconPreview.src = dataUrl;
                                        chatAiIconPreview.style.display = 'inline-block';
                                    }
                                    
                                    // 險ｭ螳夂判髱｢縺ｮ繧ｵ繝繝阪う繝ｫ繧よ峩譁ｰ
                                    const aiIconThumbnail = document.getElementById('ai-icon-thumbnail');
                                    if (aiIconThumbnail) {
                                        aiIconThumbnail.src = dataUrl;
                                        aiIconThumbnail.style.display = '';
                                        aiIconThumbnail.classList.remove('hidden');
                                    }
                                };
                                reader.readAsDataURL(file);
                                
                                const chatAiIconRemove = document.getElementById('chat-ai-icon-remove');
                                if (chatAiIconRemove) {
                                    chatAiIconRemove.style.display = 'inline-block';
                                }
                                return;
                            } catch (readerError) {
                                console.error('FileReader fallback failed:', readerError);
                                state.aiIconUrl = null;
                            }
                        }
                        
                        const chatAiIconPreview = document.getElementById('chat-ai-icon-preview');
                        const chatAiIconRemove = document.getElementById('chat-ai-icon-remove');
                        if (chatAiIconPreview && state.aiIconUrl) {
                            chatAiIconPreview.src = state.aiIconUrl;
                            chatAiIconPreview.style.display = 'inline-block';
                        }
                        if (chatAiIconRemove) {
                            chatAiIconRemove.style.display = 'inline-block';
                        }
                        
                        // 險ｭ螳夂判髱｢縺ｮ繧ｵ繝繝阪う繝ｫ繧よ峩譁ｰ
                        const aiIconThumbnail = document.getElementById('ai-icon-thumbnail');
                        if (aiIconThumbnail && state.aiIconUrl) {
                            aiIconThumbnail.src = state.aiIconUrl;
                            aiIconThumbnail.style.display = '';
                            aiIconThumbnail.classList.remove('hidden');
                        }
                        
                    } catch (error) {
                        console.error('AI繧｢繧､繧ｳ繝ｳ縺ｮ繧｢繝・・繝ｭ繝ｼ繝峨↓螟ｱ謨励＠縺ｾ縺励◆:', error);
                        await uiUtils.showCustomAlert('AI繧｢繧､繧ｳ繝ｳ縺ｮ繧｢繝・・繝ｭ繝ｼ繝峨↓螟ｱ謨励＠縺ｾ縺励◆縲・);
                    }
                };
            }
            
            // AI繧｢繧､繧ｳ繝ｳ蜑企勁繝懊ち繝ｳ
            const chatAiIconRemove = document.getElementById('chat-ai-icon-remove');
            if (chatAiIconRemove) {
                chatAiIconRemove.onclick = async () => {
                    window.chatSettingsModal.removeIcon();
                    // 蜊ｳ蠎ｧ縺ｫ菫晏ｭ倥○縺壹∽ｿ晏ｭ倥・繧ｿ繝ｳ繧ｯ繝ｪ繝・け譎ゅ↓菫晏ｭ倥☆繧・                };
            }
            
            // 閭梧勹逕ｻ蜒上い繝・・繝ｭ繝ｼ繝・            const chatBackgroundImageInput = document.getElementById('chat-background-image');
            if (chatBackgroundImageInput) {
                chatBackgroundImageInput.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    try {
                        // 譌｢蟄倥・URL繧定ｧ｣謾ｾ・・OS Safari繧帝勁縺擾ｼ・                        if (state.backgroundImageUrl && !uiUtils.isIOSSafari()) {
                            URL.revokeObjectURL(state.backgroundImageUrl);
                        }
                        
                        // 繝｢繝ｼ繝繝ｫ逕ｨ縺ｮ荳譎ょ､画焚縺ｫ菫晏ｭ假ｼ・tate.settings縺ｯ譖ｴ譁ｰ縺励↑縺・ｼ・                        if (!state.modalTemp) {
                            state.modalTemp = {};
                        }
                        state.modalTemp.backgroundImageBlob = file;
                        // dirty繝輔Λ繧ｰ繧定ｨｭ螳・                        state.assetDirty.bgImage = true;
                        // 蜊ｳ蠎ｧ縺ｫ菫晏ｭ倥○縺壹∽ｿ晏ｭ倥・繧ｿ繝ｳ繧ｯ繝ｪ繝・け譎ゅ↓菫晏ｭ倥☆繧・                        
                        // 繝励Ξ繝薙Η繝ｼ繧呈峩譁ｰ
                        try {
                            state.backgroundImageUrl = URL.createObjectURL(file);
                        } catch (e) {
                            console.warn('Safari Blob URL creation failed for chat background:', e);
                            // iOS Safari縺ｧ繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺溷ｴ蜷医：ileReader繧剃ｽｿ逕ｨ
                            try {
                                const reader = new FileReader();
                                reader.onload = function(event) {
                                    const dataUrl = event.target.result;
                                    state.backgroundImageUrl = dataUrl;
                                    
                                    const chatBackgroundPreview = document.getElementById('chat-background-preview');
                                    if (chatBackgroundPreview) {
                                        chatBackgroundPreview.src = dataUrl;
                                        chatBackgroundPreview.style.display = 'inline-block';
                                    }
                                    
                                    // 繝√Ε繝・ヨ逕ｻ髱｢縺ｫ閭梧勹逕ｻ蜒上ｒ驕ｩ逕ｨ
                                    document.documentElement.style.setProperty('--chat-background-image', `url(${dataUrl})`);
                                    
                                    // 險ｭ螳夂判髱｢縺ｮ繧ｵ繝繝阪う繝ｫ繧呈峩譁ｰ
                                    if (uiUtils) {
                                        uiUtils.updateBackgroundSettingsUI();
                                        uiUtils.updatePromptBackgroundDisplay();
                                    }
                                };
                                reader.readAsDataURL(file);
                                
                                const chatBackgroundRemove = document.getElementById('chat-background-remove');
                                if (chatBackgroundRemove) {
                                    chatBackgroundRemove.style.display = 'inline-block';
                                }
                                return;
                            } catch (readerError) {
                                console.error('FileReader fallback failed:', readerError);
                                state.backgroundImageUrl = null;
                            }
                        }
                        
                        const chatBackgroundPreview = document.getElementById('chat-background-preview');
                        const chatBackgroundRemove = document.getElementById('chat-background-remove');
                        if (chatBackgroundPreview && state.backgroundImageUrl) {
                            chatBackgroundPreview.src = state.backgroundImageUrl;
                            chatBackgroundPreview.style.display = 'inline-block';
                        }
                        if (chatBackgroundRemove) {
                            chatBackgroundRemove.style.display = 'inline-block';
                        }
                        
                        // 繝√Ε繝・ヨ逕ｻ髱｢縺ｫ閭梧勹逕ｻ蜒上ｒ驕ｩ逕ｨ
                        if (state.backgroundImageUrl) {
                            document.documentElement.style.setProperty('--chat-background-image', `url(${state.backgroundImageUrl})`);
                        }
                        
                        // 險ｭ螳夂判髱｢縺ｮ繧ｵ繝繝阪う繝ｫ繧呈峩譁ｰ
                        if (uiUtils) {
                            uiUtils.updateBackgroundSettingsUI();
                            uiUtils.updatePromptBackgroundDisplay();
                        }
                        
                    } catch (error) {
                        console.error('閭梧勹逕ｻ蜒上・繧｢繝・・繝ｭ繝ｼ繝峨↓螟ｱ謨励＠縺ｾ縺励◆:', error);
                        await uiUtils.showCustomAlert('閭梧勹逕ｻ蜒上・繧｢繝・・繝ｭ繝ｼ繝峨↓螟ｱ謨励＠縺ｾ縺励◆縲・);
                    }
                };
            }
            
            // 閭梧勹逕ｻ蜒丞炎髯､繝懊ち繝ｳ
            const chatBackgroundRemove = document.getElementById('chat-background-remove');
            if (chatBackgroundRemove) {
                chatBackgroundRemove.onclick = async () => {
                    window.chatSettingsModal.removeBackground();
                    // 蜊ｳ蠎ｧ縺ｫ菫晏ｭ倥○縺壹∽ｿ晏ｭ倥・繧ｿ繝ｳ繧ｯ繝ｪ繝・け譎ゅ↓菫晏ｭ倥☆繧・                    
                    // 險ｭ螳夂判髱｢縺ｮ繧ｵ繝繝阪う繝ｫ繧呈峩譁ｰ
                    uiUtils.updateBackgroundSettingsUI();
                    uiUtils.updatePromptBackgroundDisplay();
                };
            }
        };
        
        // 繝√Ε繝・ヨ險ｭ螳壹Δ繝ｼ繝繝ｫ讖溯・
        const chatSettingsModal = {
            show() {
                // 繝｢繝ｼ繝繝ｫ隕∫ｴ縺ｮ遒ｺ隱・                const modal = document.getElementById('chat-settings-modal');
                
                if (!modal) {
                    console.error('繝｢繝ｼ繝繝ｫ隕∫ｴ縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ');
                    return;
                }
                
                // 繝輔ぃ繧､繝ｫ蜈･蜉帙ヵ繧｣繝ｼ繝ｫ繝峨ｒ繧ｯ繝ｪ繧｢・亥燕縺ｮ繝√Ε繝・ヨ縺ｮ蛟､縺梧ｮ九ｉ縺ｪ縺・ｈ縺・↓・・                const chatAiIconInput = document.getElementById('chat-ai-icon');
                if (chatAiIconInput) {
                    chatAiIconInput.value = '';
                }
                const chatBackgroundImageInput = document.getElementById('chat-background-image');
                if (chatBackgroundImageInput) {
                    chatBackgroundImageInput.value = '';
                }
                
                // 繝｢繝ｼ繝繝ｫ逕ｨ縺ｮ荳譎ょ､画焚繧貞・譛溷喧
                state.modalTemp = {};
                
                // 迴ｾ蝨ｨ縺ｮ繝√Ε繝・ヨ縺ｮ繧｢繧ｻ繝・ヨ諠・ｱ繧貞叙蠕・                // 譁ｰ隕上メ繝｣繝・ヨ縺ｮ蝣ｴ蜷医・"pending"縺九ｉ蜿門ｾ・                const currentChatAssets = state.currentChatId ? 
                    state.chatAssets.get(state.currentChatId) : 
                    state.chatAssets.get("pending");
                
                // 迴ｾ蝨ｨ縺ｮ繧｢繧ｻ繝・ヨ繧偵Δ繝ｼ繝繝ｫ逕ｨ縺ｮ荳譎ょ､画焚縺ｫ繧ｳ繝斐・
                if (currentChatAssets) {
                    state.modalTemp.aiIconBlob = currentChatAssets.aiIconBlob;
                    state.modalTemp.backgroundImageBlob = currentChatAssets.backgroundImageBlob;
                }
                
                // 迴ｾ蝨ｨ縺ｮ蛟､繧定ｨｭ螳・                const chatAiNameInput = document.getElementById('chat-ai-name');
                const chatSystemPromptTextarea = document.getElementById('chat-system-prompt');
                
                if (chatAiNameInput) {
                    // 迴ｾ蝨ｨ縺ｮ繝√Ε繝・ヨ縺ｮAI蜷阪ｒ蜆ｪ蜈医√↑縺代ｌ縺ｰ繝・ヵ繧ｩ繝ｫ繝・                    chatAiNameInput.value = currentChatAssets?.aiName || 'AI';
                }
                if (chatSystemPromptTextarea) {
                    // 迴ｾ蝨ｨ縺ｮ繝√Ε繝・ヨ縺ｮ繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧定｡ｨ遉ｺ
                    let systemPromptValue = '';
                    
                    // 繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ縺ｮ蜿門ｾ怜━蜈磯・ｽ搾ｼ・                    // 1. 繝√Ε繝・ヨ蝗ｺ譛峨・繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ
                    // 2. 繝｡繝・そ繝ｼ繧ｸ縺九ｉ繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ繧呈爾縺・                    if (state.chatSystemPrompt) {
                        systemPromptValue = state.chatSystemPrompt;
                    } else if (state.currentMessages && state.currentMessages.length > 0) {
                        const systemMessage = state.currentMessages.find(m => m.role === 'system');
                        if (systemMessage) {
                            systemPromptValue = systemMessage.content;
                        }
                    }
                    
                    chatSystemPromptTextarea.value = systemPromptValue;
                    
                    // 繝・く繧ｹ繝医お繝ｪ繧｢縺ｮ鬮倥＆繧貞・螳ｹ縺ｫ蜷医ｏ縺帙※閾ｪ蜍戊ｪｿ謨ｴ
                    chatSystemPromptTextarea.style.height = 'auto';
                    chatSystemPromptTextarea.style.height = Math.max(60, chatSystemPromptTextarea.scrollHeight) + 'px';
                }
                
                // AI繧｢繧､繧ｳ繝ｳ繝励Ξ繝薙Η繝ｼ繧定｡ｨ遉ｺ
                const chatAiIconPreview = document.getElementById('chat-ai-icon-preview');
                const chatAiIconRemove = document.getElementById('chat-ai-icon-remove');
                
                // 迴ｾ蝨ｨ縺ｮ繝√Ε繝・ヨ縺ｮ繧｢繧､繧ｳ繝ｳ繧堤｢ｺ隱・                const currentIconBlob = currentChatAssets?.aiIconBlob;
                if (currentIconBlob || state.aiIconUrl) {
                    if (state.aiIconUrl) {
                        if (chatAiIconPreview) {
                            chatAiIconPreview.src = state.aiIconUrl;
                            chatAiIconPreview.style.display = 'inline-block';
                        }
                        if (chatAiIconRemove) {
                            chatAiIconRemove.style.display = 'inline-block';
                        }
                    } else if (currentIconBlob) {
                        // ArrayBuffer縺九ｉBlob縺ｫ螟画鋤
                        const blob = convertArrayBufferToBlob(currentIconBlob);
                        if (blob) {
                            try {
                                const url = URL.createObjectURL(blob);
                                if (chatAiIconPreview) {
                                    chatAiIconPreview.src = url;
                                    chatAiIconPreview.style.display = 'inline-block';
                                }
                                if (chatAiIconRemove) {
                                    chatAiIconRemove.style.display = 'inline-block';
                                }
                                // 荳譎ら噪縺ｫURL繧剃ｿ晄戟
                                state.tempIconUrl = url;
                            } catch (e) {
                                console.warn('Failed to create icon preview URL:', e);
                            }
                        }
                    }
                } else {
                    if (chatAiIconPreview) {
                        chatAiIconPreview.style.display = 'none';
                    }
                    if (chatAiIconRemove) {
                        chatAiIconRemove.style.display = 'none';
                    }
                }
                
                // 閭梧勹逕ｻ蜒上・繝ｬ繝薙Η繝ｼ繧定｡ｨ遉ｺ
                const chatBackgroundPreview = document.getElementById('chat-background-preview');
                const chatBackgroundRemove = document.getElementById('chat-background-remove');
                
                // 迴ｾ蝨ｨ縺ｮ繝√Ε繝・ヨ縺ｮ閭梧勹逕ｻ蜒上ｒ遒ｺ隱・                const currentBgBlob = currentChatAssets?.backgroundImageBlob;
                if (currentBgBlob || state.backgroundImageUrl) {
                    if (state.backgroundImageUrl) {
                        if (chatBackgroundPreview) {
                            chatBackgroundPreview.src = state.backgroundImageUrl;
                            chatBackgroundPreview.style.display = 'inline-block';
                        }
                        if (chatBackgroundRemove) {
                            chatBackgroundRemove.style.display = 'inline-block';
                        }
                    } else if (currentBgBlob) {
                        const blob = convertArrayBufferToBlob(currentBgBlob);
                        if (blob) {
                            try {
                                const url = URL.createObjectURL(blob);
                                if (chatBackgroundPreview) {
                                    chatBackgroundPreview.src = url;
                                    chatBackgroundPreview.style.display = 'inline-block';
                                }
                                if (chatBackgroundRemove) {
                                    chatBackgroundRemove.style.display = 'inline-block';
                                }
                                // 荳譎ら噪縺ｫURL繧剃ｿ晄戟
                                state.tempBgUrl = url;
                            } catch (e) {
                                console.warn('Failed to create background preview URL:', e);
                            }
                        }
                    }
                } else {
                    if (chatBackgroundPreview) {
                        chatBackgroundPreview.style.display = 'none';
                    }
                    if (chatBackgroundRemove) {
                        chatBackgroundRemove.style.display = 'none';
                    }
                }
                
                // 繝・・繝櫁ｨｭ螳壹ｒ隱ｭ縺ｿ霎ｼ縺ｿ
                const chatThemeSelect = document.getElementById('chat-theme-select');
                if (chatThemeSelect) {
                    // 迴ｾ蝨ｨ縺ｮ繝√Ε繝・ヨ縺ｮ繝・・繝槭ｒ險ｭ螳夲ｼ医↑縺代ｌ縺ｰ遨ｺ譁・ｭ怜・・・                    chatThemeSelect.value = state.currentChatTheme || '';
                }
                
                // 繝｢繝ｼ繝繝ｫ繧定｡ｨ遉ｺ
                modal.style.display = 'flex';
                
                // 繧､繝吶Φ繝医ワ繝ｳ繝峨Λ繝ｼ繧定ｨｭ螳・                setupEventHandlers();
                
            },
        
            hide() {
                const modal = document.getElementById('chat-settings-modal');
                if (modal) {
                    modal.style.display = 'none';
                }
                
                // 荳譎ら噪縺ｪURL繧偵け繝ｪ繝ｼ繝ｳ繧｢繝・・
                if (state.tempIconUrl && !uiUtils.isIOSSafari()) {
                    URL.revokeObjectURL(state.tempIconUrl);
                    state.tempIconUrl = null;
                }
                if (state.tempBgUrl && !uiUtils.isIOSSafari()) {
                    URL.revokeObjectURL(state.tempBgUrl);
                    state.tempBgUrl = null;
                }
                
                // 繝｢繝ｼ繝繝ｫ逕ｨ縺ｮ荳譎ょ､画焚繧偵け繝ｪ繧｢
                state.modalTemp = null;
            },
            
            async save() {
                // Safari Blob 繧ｨ繝ｩ繝ｼ蟇ｾ遲・ 菫晏ｭ伜燕縺ｫ迥ｶ諷九ｒ菫晁ｭｷ
                const preservedState = {
                    aiName: state.settings.aiName,
                    aiIconBlob: state.settings.aiIconBlob,
                    backgroundImageBlob: state.settings.backgroundImageBlob,
                    aiIconUrl: state.aiIconUrl,
                    backgroundImageUrl: state.backgroundImageUrl,
                    assetDirty: {...state.assetDirty},
                    chatSystemPrompt: state.chatSystemPrompt
                };
                
                try {
                    // AI蜷阪ｒ譖ｴ譁ｰ
                    const chatAiNameInput = document.getElementById('chat-ai-name');
                    const aiName = chatAiNameInput ? 
                        (chatAiNameInput.value.trim() || 'AI') : 'AI';
                    
                    // 繝・・繝櫁ｨｭ螳壹ｒ蜿門ｾ・                    const chatThemeSelect = document.getElementById('chat-theme-select');
                    const selectedTheme = chatThemeSelect ? chatThemeSelect.value : '';
                    
                    // 繝・・繝槭ｒ譖ｴ譁ｰ
                    if (selectedTheme) {
                        state.currentChatTheme = selectedTheme;
                        // 蜊ｳ蠎ｧ縺ｫ繝・・繝槭ｒ驕ｩ逕ｨ
                        uiUtils.applyTheme(selectedTheme);
                        uiUtils.applySidePanelSettingsToUI();
                    } else {
                        state.currentChatTheme = null;
                        // 繝・ヵ繧ｩ繝ｫ繝医ユ繝ｼ繝槭ｒ驕ｩ逕ｨ
                        uiUtils.applyTheme(state.settings.theme);
                        uiUtils.applySidePanelSettingsToUI();
                    }
                    
                    // 迴ｾ蝨ｨ縺ｮ繝√Ε繝・ヨ縺ｮ繧｢繧ｻ繝・ヨ諠・ｱ繧貞叙蠕・                    // 譁ｰ隕上メ繝｣繝・ヨ縺ｮ蝣ｴ蜷医・"pending"縺九ｉ蜿門ｾ・                    const currentChatAssets = state.currentChatId ? 
                        state.chatAssets.get(state.currentChatId) : 
                        state.chatAssets.get("pending");
                    
                    // AI蜷阪′螟画峩縺輔ｌ縺溷ｴ蜷医・dirty繝輔Λ繧ｰ繧定ｨｭ螳・                    if (!currentChatAssets || currentChatAssets.aiName !== aiName) {
                        state.assetDirty.aiName = true;
                    }
                    
                    // 驥崎ｦ・ state.settings縺ｯ譖ｴ譁ｰ縺帙★縲∫樟蝨ｨ縺ｮ繝√Ε繝・ヨ逕ｨ縺ｨ縺励※菫晄戟
                    // AI蜷榊・蜉帙ヵ繧｣繝ｼ繝ｫ繝峨ｒ譖ｴ譁ｰ
                    const aiNameInput = document.getElementById('ai-name-input');
                    if (aiNameInput) {
                        aiNameInput.value = aiName;
                    }
                    
                    // 繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ縺ｯ隱ｭ縺ｿ蜿悶ｊ蟆ら畑縺ｪ縺ｮ縺ｧ譖ｴ譁ｰ縺励↑縺・                    
                    // 繝√Ε繝・ヨ繧剃ｿ晏ｭ假ｼ郁ｨｭ螳壹ｒ蜿肴丐・・                    if (state.currentChatId && state.currentMessages && state.currentMessages.length > 0) {
                        try {
                            // 迴ｾ蝨ｨ縺ｮ繝√Ε繝・ヨ縺ｮ繧｢繧ｻ繝・ヨ諠・ｱ繧貞叙蠕励∪縺溘・菴懈・
                            const currentAssets = state.chatAssets.get(state.currentChatId) || {
                                aiName: 'AI',
                                aiIconBlob: null,
                                backgroundImageBlob: null
                            };
                            
                            // chatAssets繝槭ャ繝励ｒ譖ｴ譁ｰ・・OS蟇ｾ蠢懊〒ArrayBuffer縺ｫ螟画鋤・・                            const assetData = {
                                aiName: aiName,  // 荳翫〒蜿門ｾ励＠縺滓眠縺励＞AI蜷阪ｒ菴ｿ逕ｨ
                                aiIconBlob: currentAssets.aiIconBlob,  // 譌｢蟄倥・繧｢繧､繧ｳ繝ｳ繧剃ｿ晄戟
                                backgroundImageBlob: currentAssets.backgroundImageBlob,  // 譌｢蟄倥・閭梧勹繧剃ｿ晄戟
                                aiIconUrl: currentAssets.aiIconUrl,  // 譌｢蟄倥・URL繧剃ｿ晄戟
                                backgroundImageUrl: currentAssets.backgroundImageUrl  // 譌｢蟄倥・URL繧剃ｿ晄戟
                            };
                            
                            // dirty繝輔Λ繧ｰ縺荊rue縺ｮ蝣ｴ蜷医・縺ｿ譖ｴ譁ｰ
                            
                            // 繧｢繧､繧ｳ繝ｳ縺悟､画峩縺輔ｌ縺溷ｴ蜷医・蜃ｦ逅・                            if (state.assetDirty.aiIcon && state.modalTemp?.aiIconBlob !== undefined) {
                                // 譌｢蟄倥・繧｢繧､繧ｳ繝ｳURL繧偵け繝ｪ繝ｼ繝ｳ繧｢繝・・
                                if (assetData.aiIconUrl && !uiUtils.isIOSSafari()) {
                                    URL.revokeObjectURL(assetData.aiIconUrl);
                                }
                                
                                if (state.modalTemp.aiIconBlob === null) {
                                    // 蜑企勁縺輔ｌ縺溷ｴ蜷・                                    assetData.aiIconBlob = null;
                                    assetData.aiIconUrl = null;
                                    state.aiIconUrl = null;
                                } else if (state.modalTemp.aiIconBlob instanceof Blob) {
                                    // ArrayBuffer縺ｫ螟画鋤縺励※菫晏ｭ・                                    assetData.aiIconBlob = await state.modalTemp.aiIconBlob.arrayBuffer();
                                    // 譁ｰ縺励＞URL繧剃ｽ懈・
                                    try {
                                        const newUrl = URL.createObjectURL(state.modalTemp.aiIconBlob);
                                        assetData.aiIconUrl = newUrl;
                                        state.aiIconUrl = newUrl;
                                    } catch (e) {
                                        console.warn('Failed to create icon URL:', e);
                                        assetData.aiIconUrl = null;
                                        state.aiIconUrl = null;
                                    }
                                } else {
                                    assetData.aiIconBlob = state.modalTemp.aiIconBlob;
                                }
                            }
                            
                            // 閭梧勹逕ｻ蜒上′螟画峩縺輔ｌ縺溷ｴ蜷医・蜃ｦ逅・                            if (state.assetDirty.bgImage && state.modalTemp?.backgroundImageBlob !== undefined) {
                                // 譌｢蟄倥・閭梧勹URL繧偵け繝ｪ繝ｼ繝ｳ繧｢繝・・
                                if (assetData.backgroundImageUrl && !uiUtils.isIOSSafari()) {
                                    URL.revokeObjectURL(assetData.backgroundImageUrl);
                                }
                                
                                if (state.modalTemp.backgroundImageBlob === null) {
                                    // 蜑企勁縺輔ｌ縺溷ｴ蜷・                                    assetData.backgroundImageBlob = null;
                                    assetData.backgroundImageUrl = null;
                                    state.backgroundImageUrl = null;
                                } else if (state.modalTemp.backgroundImageBlob instanceof Blob) {
                                    // ArrayBuffer縺ｫ螟画鋤縺励※菫晏ｭ・                                    assetData.backgroundImageBlob = await state.modalTemp.backgroundImageBlob.arrayBuffer();
                                    // 譁ｰ縺励＞URL繧剃ｽ懈・
                                    try {
                                        const newUrl = URL.createObjectURL(state.modalTemp.backgroundImageBlob);
                                        assetData.backgroundImageUrl = newUrl;
                                        state.backgroundImageUrl = newUrl;
                                    } catch (e) {
                                        console.warn('Failed to create background URL:', e);
                                        assetData.backgroundImageUrl = null;
                                        state.backgroundImageUrl = null;
                                    }
                                } else {
                                    assetData.backgroundImageBlob = state.modalTemp.backgroundImageBlob;
                                }
                            }
                            
                            state.chatAssets.set(state.currentChatId, assetData);
                            
                            await dbUtils.saveChat();
                            
                            // 菫晏ｭ伜ｾ後↓dirty繝輔Λ繧ｰ繧偵Μ繧ｻ繝・ヨ
                            state.assetDirty.aiIcon = false;
                            state.assetDirty.bgImage = false;
                            state.assetDirty.aiName = false;
                            
                            // 繝｢繝ｼ繝繝ｫ逕ｨ縺ｮ荳譎ょ､画焚繧偵け繝ｪ繧｢
                            state.modalTemp = null;
                        } catch (saveError) {
                            console.error('繝√Ε繝・ヨ菫晏ｭ倅ｸｭ縺ｮ繧ｨ繝ｩ繝ｼ:', saveError);
                            
                            // Safari Blob 繧ｨ繝ｩ繝ｼ蟇ｾ遲・ 繧ｨ繝ｩ繝ｼ譎ゅ↓迥ｶ諷九ｒ蠕ｩ蜈・                            state.settings.aiName = preservedState.aiName;
                            state.settings.aiIconBlob = preservedState.aiIconBlob;
                            state.settings.backgroundImageBlob = preservedState.backgroundImageBlob;
                            state.aiIconUrl = preservedState.aiIconUrl;
                            state.backgroundImageUrl = preservedState.backgroundImageUrl;
                            state.assetDirty = preservedState.assetDirty;
                            state.chatSystemPrompt = preservedState.chatSystemPrompt;
                            
                            // 繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｦ繧６I縺ｮ譖ｴ譁ｰ縺ｯ邯夊｡・                        }
                    } else if (!state.currentChatId && state.currentMessages && state.currentMessages.length > 0) {
                        // 譁ｰ隕上メ繝｣繝・ヨ縺ｧ縺ｾ縺ID縺後↑縺・ｴ蜷医・"pending"縺ｫ菫晏ｭ・                        const pendingAssets = state.chatAssets.get("pending") || {
                            aiName: 'AI',
                            aiIconBlob: null,
                            backgroundImageBlob: null,
                            aiIconUrl: null,
                            backgroundImageUrl: null
                        };
                        
                        // chatAssets繝槭ャ繝励ｒ譖ｴ譁ｰ
                        const assetData = {
                            aiName: aiName,
                            aiIconBlob: pendingAssets.aiIconBlob,
                            backgroundImageBlob: pendingAssets.backgroundImageBlob,
                            aiIconUrl: pendingAssets.aiIconUrl,
                            backgroundImageUrl: pendingAssets.backgroundImageUrl
                        };
                        
                        // 繧｢繧､繧ｳ繝ｳ縺悟､画峩縺輔ｌ縺溷ｴ蜷医・蜃ｦ逅・                        if (state.assetDirty.aiIcon && state.modalTemp?.aiIconBlob !== undefined) {
                            if (assetData.aiIconUrl && !uiUtils.isIOSSafari()) {
                                URL.revokeObjectURL(assetData.aiIconUrl);
                            }
                            
                            if (state.modalTemp.aiIconBlob === null) {
                                assetData.aiIconBlob = null;
                                assetData.aiIconUrl = null;
                                state.aiIconUrl = null;
                            } else if (state.modalTemp.aiIconBlob instanceof Blob) {
                                assetData.aiIconBlob = await state.modalTemp.aiIconBlob.arrayBuffer();
                                try {
                                    const newUrl = URL.createObjectURL(state.modalTemp.aiIconBlob);
                                    assetData.aiIconUrl = newUrl;
                                    state.aiIconUrl = newUrl;
                                } catch (e) {
                                    console.warn('Failed to create icon URL:', e);
                                    assetData.aiIconUrl = null;
                                    state.aiIconUrl = null;
                                }
                            } else {
                                assetData.aiIconBlob = state.modalTemp.aiIconBlob;
                            }
                        }
                        
                        // 閭梧勹逕ｻ蜒上′螟画峩縺輔ｌ縺溷ｴ蜷医・蜃ｦ逅・                        if (state.assetDirty.bgImage && state.modalTemp?.backgroundImageBlob !== undefined) {
                            if (assetData.backgroundImageUrl && !uiUtils.isIOSSafari()) {
                                URL.revokeObjectURL(assetData.backgroundImageUrl);
                            }
                            
                            if (state.modalTemp.backgroundImageBlob === null) {
                                assetData.backgroundImageBlob = null;
                                assetData.backgroundImageUrl = null;
                                state.backgroundImageUrl = null;
                            } else if (state.modalTemp.backgroundImageBlob instanceof Blob) {
                                assetData.backgroundImageBlob = await state.modalTemp.backgroundImageBlob.arrayBuffer();
                                try {
                                    const newUrl = URL.createObjectURL(state.modalTemp.backgroundImageBlob);
                                    assetData.backgroundImageUrl = newUrl;
                                    state.backgroundImageUrl = newUrl;
                                } catch (e) {
                                    console.warn('Failed to create background URL:', e);
                                    assetData.backgroundImageUrl = null;
                                    state.backgroundImageUrl = null;
                                }
                            } else {
                                assetData.backgroundImageBlob = state.modalTemp.backgroundImageBlob;
                            }
                        }
                        
                        state.chatAssets.set("pending", assetData);
                        
                        // 譁ｰ隕上メ繝｣繝・ヨ縺ｮ蝣ｴ蜷医ｂdirty繝輔Λ繧ｰ繧偵Μ繧ｻ繝・ヨ
                        state.assetDirty.aiIcon = false;
                        state.assetDirty.bgImage = false;
                        state.assetDirty.aiName = false;
                        
                        // 繝｢繝ｼ繝繝ｫ逕ｨ縺ｮ荳譎ょ､画焚繧偵け繝ｪ繧｢
                        state.modalTemp = null;
                    }
                    
                    // 繝｡繝・そ繝ｼ繧ｸ繧貞・謠冗判縺励※AI蜷阪→繧｢繧､繧ｳ繝ｳ繧貞渚譏
                    if (uiUtils && uiUtils.renderChatMessages) {
                        uiUtils.renderChatMessages();
                    }
                    
                    // 繧｢繧､繧ｳ繝ｳ陦ｨ遉ｺ縺ｮ譖ｴ譁ｰ
                    if (uiUtils && uiUtils.updateIconSettingsUI) {
                        uiUtils.updateIconSettingsUI();
                    }
                    
                    // 閭梧勹逕ｻ蜒剰｡ｨ遉ｺ縺ｮ譖ｴ譁ｰ
                    if (uiUtils && uiUtils.updateBackgroundSettingsUI) {
                        uiUtils.updateBackgroundSettingsUI();
                    }
                    
                    this.hide();
                    
                    // 謌仙粥繝｡繝・そ繝ｼ繧ｸ繧定｡ｨ遉ｺ
                    if (uiUtils && uiUtils.showCustomAlert) {
                        await uiUtils.showCustomAlert('繝√Ε繝・ヨ險ｭ螳壹ｒ菫晏ｭ倥＠縺ｾ縺励◆縲・);
                    }
                    
                } catch (error) {
                    console.error('繝√Ε繝・ヨ險ｭ螳壹・菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆:', error);
                    
                    // Safari Blob 繧ｨ繝ｩ繝ｼ蟇ｾ遲・ 繧ｨ繝ｩ繝ｼ譎ゅ↓迥ｶ諷九ｒ蠕ｩ蜈・                    state.settings.aiName = preservedState.aiName;
                    state.settings.aiIconBlob = preservedState.aiIconBlob;
                    state.settings.backgroundImageBlob = preservedState.backgroundImageBlob;
                    state.aiIconUrl = preservedState.aiIconUrl;
                    state.backgroundImageUrl = preservedState.backgroundImageUrl;
                    state.assetDirty = preservedState.assetDirty;
                    state.chatSystemPrompt = preservedState.chatSystemPrompt;
                    
                    if (uiUtils && uiUtils.showCustomAlert) {
                        await uiUtils.showCustomAlert('繝√Ε繝・ヨ險ｭ螳壹・菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆縲・);
                    }
                }
            },
        
            removeBackground() {
                // 繝｢繝ｼ繝繝ｫ逕ｨ縺ｮ荳譎ょ､画焚繧偵け繝ｪ繧｢
                if (!state.modalTemp) {
                    state.modalTemp = {};
                }
                state.modalTemp.backgroundImageBlob = null;
                // dirty繝輔Λ繧ｰ繧定ｨｭ螳・                state.assetDirty.bgImage = true;
                if (state.backgroundImageUrl && !uiUtils.isIOSSafari()) {
                    URL.revokeObjectURL(state.backgroundImageUrl);
                }
                state.backgroundImageUrl = null;
                document.documentElement.style.setProperty('--chat-background-image', 'none');
                
                const chatBackgroundPreview = document.getElementById('chat-background-preview');
                const chatBackgroundRemove = document.getElementById('chat-background-remove');
                const chatBackgroundImageInput = document.getElementById('chat-background-image');
                
                if (chatBackgroundPreview) {
                    chatBackgroundPreview.style.display = 'none';
                }
                if (chatBackgroundRemove) {
                    chatBackgroundRemove.style.display = 'none';
                }
                if (chatBackgroundImageInput) {
                    chatBackgroundImageInput.value = '';
                }
            },
        
            removeIcon() {
                // 繝｢繝ｼ繝繝ｫ逕ｨ縺ｮ荳譎ょ､画焚繧偵け繝ｪ繧｢
                if (!state.modalTemp) {
                    state.modalTemp = {};
                }
                state.modalTemp.aiIconBlob = null;
                // dirty繝輔Λ繧ｰ繧定ｨｭ螳・                state.assetDirty.aiIcon = true;
                if (state.aiIconUrl && !uiUtils.isIOSSafari()) {
                    URL.revokeObjectURL(state.aiIconUrl);
                }
                state.aiIconUrl = null;
                const chatAiIconPreview = document.getElementById('chat-ai-icon-preview');
                const chatAiIconRemove = document.getElementById('chat-ai-icon-remove');
                const chatAiIconInput = document.getElementById('chat-ai-icon');
                
                if (chatAiIconPreview) {
                    chatAiIconPreview.style.display = 'none';
                }
                if (chatAiIconRemove) {
                    chatAiIconRemove.style.display = 'none';
                }
                if (chatAiIconInput) {
                    chatAiIconInput.value = '';
                }
                
                // AI繧｢繧､繧ｳ繝ｳ繧ｵ繝繝阪う繝ｫ繧呈峩譁ｰ
                const aiIconThumbnail = document.getElementById('ai-icon-thumbnail');
                if (aiIconThumbnail) {
                    aiIconThumbnail.style.display = 'none';
                    aiIconThumbnail.classList.add('hidden');
                }
                const deleteAiIconBtn = document.getElementById('delete-ai-icon-btn');
                if (deleteAiIconBtn) {
                    deleteAiIconBtn.classList.add('hidden');
                }
            }
    };
    
        // appLogic繧偵げ繝ｭ繝ｼ繝舌Ν繧ｹ繧ｳ繝ｼ繝励〒蛻ｩ逕ｨ蜿ｯ閭ｽ縺ｫ縺吶ｋ
        window.appLogic = appLogic;
    
        // 繧､繝吶Φ繝医Μ繧ｹ繝翫・險ｭ螳夲ｼ・ull 繝√ぉ繝・け莉倥″・・        const chatSettingsBtn = document.getElementById('chat-settings-btn');
        
        if (chatSettingsBtn) {
            chatSettingsBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                chatSettingsModal.show();
            });
        } else {
            console.error('繝√Ε繝・ヨ險ｭ螳壹・繧ｿ繝ｳ縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ');
        }
    
        // 繝｢繝ｼ繝繝ｫ蜀・・繝懊ち繝ｳ繧､繝吶Φ繝医Μ繧ｹ繝翫・
        const chatSettingsSaveBtn = document.getElementById('chat-settings-save');
        const chatSettingsCancelBtn = document.getElementById('chat-settings-cancel');
        const modalElement = document.getElementById('chat-settings-modal');
        
        if (chatSettingsSaveBtn) {
            chatSettingsSaveBtn.addEventListener('click', () => {
                chatSettingsModal.save();
            });
        }
        
        if (chatSettingsCancelBtn) {
            chatSettingsCancelBtn.addEventListener('click', () => {
                chatSettingsModal.hide();
            });
        }
    
        // 繝｢繝ｼ繝繝ｫ繧ｯ繝ｭ繝ｼ繧ｺ繝懊ち繝ｳ
        if (modalElement) {
            const closeBtn = modalElement.querySelector('.modal-close-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    chatSettingsModal.hide();
                });
            }
            
            // 繧ｪ繝ｼ繝舌・繝ｬ繧､繧ｯ繝ｪ繝・け縺ｧ髢峨§繧・            modalElement.addEventListener('click', (e) => {
                if (e.target === modalElement) {
                    chatSettingsModal.hide();
                }
            });
        }
        // ESC繧ｭ繝ｼ縺ｧ繝｢繝ｼ繝繝ｫ繧帝哩縺倥ｋ
        document.addEventListener('keydown', (e) => {
            const modal = document.getElementById('chat-settings-modal');
            if (e.key === 'Escape' && modal && modal.style.display === 'flex') {
                chatSettingsModal.hide();
            }
        });
    
        window.chatSettingsModal = chatSettingsModal;
    }
    
    // DOMContentLoaded繧､繝吶Φ繝医〒繝√Ε繝・ヨ險ｭ螳壹Δ繝ｼ繝繝ｫ繧貞・譛溷喧
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeChatSettingsModal);
    } else {
        initializeChatSettingsModal();
    }
</script>

<!-- 繝√Ε繝・ヨ險ｭ螳壹Δ繝ｼ繝繝ｫ -->
<div id="chat-settings-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content chat-settings-modal">
        <div class="modal-header">
            <h3>繝√Ε繝・ヨ險ｭ螳・/h3>
            <button class="modal-close-btn" aria-label="髢峨§繧・>ﾃ・/button>
        </div>
        <div class="modal-body">
            <div class="settings-section">
                <h4>AI險ｭ螳・/h4>
                
                <div class="setting-item">
                    <label for="chat-ai-name">AI蜷・/label>
                    <input type="text" id="chat-ai-name" placeholder="AI蜷阪ｒ蜈･蜉・>
                </div>
                
                <div class="setting-item">
                    <label>AI繧｢繧､繧ｳ繝ｳ</label>
                    <div class="ai-icon-upload-container">
                        <button type="button" id="chat-ai-icon-select" class="file-select-btn">繝輔ぃ繧､繝ｫ繧帝∈謚・/button>
                        <input type="file" id="chat-ai-icon" accept="image/*">
                        <img id="chat-ai-icon-preview" class="ai-icon-preview" style="display: none;">
                        <button type="button" id="chat-ai-icon-remove" class="icon-remove-btn" style="display: none;">蜑企勁</button>
                    </div>
                </div>
                
                <div class="setting-item">
                    <label>閭梧勹逕ｻ蜒・/label>
                    <div class="background-image-upload-container">
                        <button type="button" id="chat-background-select" class="file-select-btn">繝輔ぃ繧､繝ｫ繧帝∈謚・/button>
                        <input type="file" id="chat-background-image" accept="image/*">
                        <img id="chat-background-preview" class="background-preview" style="display: none;">
                        <button type="button" id="chat-background-remove" class="icon-remove-btn" style="display: none;">蜑企勁</button>
                    </div>
                </div>
                
                <div class="setting-item">
                    <label for="chat-theme-select">繝√Ε繝・ヨ陦ｨ遉ｺ繝・・繝・/label>
                    <select id="chat-theme-select" class="setting-select">
                        <option value="">-- 繝・ヵ繧ｩ繝ｫ繝郁ｨｭ螳壹ｒ菴ｿ逕ｨ --</option>
                        <option value="light">繝ｩ繧､繝医Δ繝ｼ繝・/option>
                        <option value="dark">繝繝ｼ繧ｯ繝｢繝ｼ繝・/option>
                        <option value="pastel-pink">繝代せ繝・Ν繝｢繝ｼ繝解洸ｷ</option>
                        <option value="pastel-blue">繝代せ繝・Ν繝｢繝ｼ繝解洸ｵ</option>
                        <option value="pastel-yellow">繝代せ繝・Ν繝｢繝ｼ繝解沺｡</option>
                        <option value="pastel-purple">繝代せ繝・Ν繝｢繝ｼ繝解沺｣</option>
                        <option value="pastel-rainbow">繝代せ繝・Ν繝｢繝ｼ繝解沍・/option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <label for="chat-system-prompt">繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ・郁ｪｭ縺ｿ蜿悶ｊ蟆ら畑・・/label>
                    <textarea id="chat-system-prompt" readonly 
                        style="min-height: 60px; max-height: 400px; resize: none; overflow-y: auto; 
                        background-color: var(--input-bg-disabled, #f5f5f5); 
                        color: var(--text-secondary); cursor: default;
                        border: 1px solid var(--border-secondary);" 
                        placeholder="縺薙・繝√Ε繝・ヨ縺ｫ繧ｷ繧ｹ繝・Β繝励Ο繝ｳ繝励ヨ縺ｯ險ｭ螳壹＆繧後※縺・∪縺帙ｓ"></textarea>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="chat-settings-save" class="btn-primary">菫晏ｭ・/button>
            <button id="chat-settings-cancel" class="btn-secondary">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
        </div>
    </div>
</div>

</body>
</html>
